<div class="sheet-mainBg">
  <!-- FDP -->
  <!-- INPUT HIDDEN Version FdP -->
  <input type="hidden" name="attr_VERFDP" value="2.6" />
  <input type="hidden" name="attr_VERSION" value="2.6" />
  <!-- INPUT HIDDEN Univers (COF, CG, COC) -->
  <input type="hidden" name="attr_UNIVERS" value="COC" />
  <!-- INPUT HIDDEN Type de jet -->
  <input type="hidden" name="attr_JETNORMAL" value="1d@{ETATDE}" />
  <input type="hidden" name="attr_JETSUP" value="2d@{ETATDE}kh1" />
  <input type="hidden" name="attr_JETSUPHERO" value="{2d@{ETATDE}kh1, 0d20+10}kh1" />
  <input type="hidden" name="attr_JETRISQUE" value="1d12" />
  <input type="hidden" name="attr_JETINF" value="2d@{ETATDE}kl1" />
  <input type="hidden" name="attr_JDEX" value="1d@{ETATDE}" />
  <input type="hidden" name="attr_JDEXSUP" value="2d@{ETATDE}kh1" />
  <input type="hidden" name="attr_JDEXSUPHERO" value="{2d@{ETATDE}kh1, 0d20+10}kh1" />
  <input type="hidden" name="attr_JDEXRISQUE" value="1d12" />
  <!-- INPUT HIDDEN Buffs -->
  <input type="hidden" name="attr_FOR_BUFF" value="0" />
  <input type="hidden" name="attr_DEX_BUFF" value="0" />
  <input type="hidden" name="attr_CON_BUFF" value="0" />
  <input type="hidden" name="attr_INT_BUFF" value="0" />
  <input type="hidden" name="attr_PER_BUFF" value="0" />
  <input type="hidden" name="attr_CHA_BUFF" value="0" />
  <input type="hidden" name="attr_ATKCAC_BUFF" value="0" />
  <input type="hidden" name="attr_ATKTIR_BUFF" value="0" />
  <input type="hidden" name="attr_ATKMAG_BUFF" value="0" />
  <input type="hidden" name="attr_ATKMEN_BUFF" value="0" />
  <input type="hidden" name="attr_PSYINFLU_BUFF" value="0" />
  <input type="hidden" name="attr_PSYINTUI_BUFF" value="0" />
  <input type="hidden" name="attr_INIT_BUFF" value="0" />
  <input type="hidden" name="attr_DEF_BUFF" value="0" />
  <input type="hidden" name="attr_DEP_BUFF" value="0" />
  <input type="hidden" name="attr_PV_BUFF" value="0" />
  <!-- INPUT HIDDEN Précédent état préjudiciable -->
  <input type="hidden" name="attr_CONDITION" value="" />
  <input type="hidden" name="attr_PCONDITION" value="" />
  <!-- INPUT HIDDEN Précédent nombre de PV -->
  <input type="hidden" name="attr_LAST_PV" value="" />
  <!-- INPUT HIDDEN PV par niveau -->
  <input type="hidden" name="attr_PV_NIVEAU" value="" />
  <!-- INPUT HIDDEN Choix carac jets capacités -->
  <input type="hidden" name="attr_QRYMOD" value="?{Carac. ?|Force,@{FOR}|Dextérité,@{DEX}|Constitution,@{CON}|Intelligence,@{INT}|Perception,@{PER}|Charisme,@{CHA}}" />
  <input type="hidden" name="attr_QRYMODT" value="?{Carac. ?|Force,@{FOR_TEST}|Dextérité,@{DEX_TEST}|Constitution,@{CON_TEST}|Intelligence,@{INT_TEST}|Perception,@{PER_TEST}|Charisme,@{CHA_TEST}}" />
  <!-- INPUT HIDDEN Rangs Voies -->
  <input type="hidden" name="attr_RANG_VOIE1" value="0" />
  <input type="hidden" name="attr_RANG_VOIE2" value="0" />
  <input type="hidden" name="attr_RANG_VOIE3" value="0" />
  <input type="hidden" name="attr_RANG_VOIE4" value="0" />
  <input type="hidden" name="attr_RANG_VOIE5" value="0" />
  <input type="hidden" name="attr_RANG_VOIE6" value="0" />
  <input type="hidden" name="attr_RANG_VOIE7" value="0" />
  <input type="hidden" name="attr_RANG_VOIE8" value="0" />
  <input type="hidden" name="attr_RANG_VOIE9" value="0" />
  <!-- INPUT HIDDEN Caractéristiques -->
  <input type="hidden" name="attr_CARACS" value="" />
  <!-- INPUT HIDDEN Mods de circonstance attaques -->
  <input type="hidden" name="attr_MODS_ATC" value="" />
  <input type="hidden" name="attr_MODS_ATD" value="" />
  <input type="hidden" name="attr_MODS_MEN" value="" />
  <input type="hidden" name="attr_MODS_MAG" value="" />
  <!-- Fin INPUT HIDDEN -->
  <div class="sheet-container">
    <!-- Identité -->
    <div style="vertical-align: middle; text-align: center;">
      <img style="width:70%; height:90%" title="Version 2.6 - 17/04/2019" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_logo.png" />
    </div>
    <div style="width:250px;">
      <table>
        <tr>
          <td class="sheet-textfatleft">Nom</td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_character_name" title="@{character_name}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Profil</td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_PROFIL" title="@{PROFIL}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Famille</td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_FAMILLE" title="@{FAMILLE}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Niveau</td>
          <td style="text-align:left;">
            <input class="sheet-nobox" name="attr_NIVEAU" title="@{NIVEAU}" type="number" value="1" min="0" />
          </td>
          <td class="sheet-textfatleft">Type</td>
          <td class="sheet-boxinput">
            <select class="sheet-pjstatus" name="attr_type_personnage" size="1" title="@{type_personnage}">
              <option value="pj" selected>PJ</option>
              <option value="pnj">PNJ</option>
              <option value="vehicule">Véhicule</option>
            </select>
          </td>
        </tr>
      </table>
    </div>
    <div style="width:130px;">
      <table>
        <tr>
          <td class="sheet-textfatleft">Sexe</td>
          <td>
            <input class="sheet-nobox" name="attr_SEXE" title="@{SEXE}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Âge</td>
          <td>
            <input class="sheet-nobox" name="attr_AGE" title="@{AGE}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Taille</td>
          <td>
            <input class="sheet-nobox" name="attr_TAILLE" title="@{TAILLE}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Poids</td>
          <td>
            <input class="sheet-nobox" name="attr_POIDS" title="@{POIDS}" type="text" />
          </td>
        </tr>
      </table>
    </div>
  </div>
  <!-- FIN Identité -->
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp1" value="pj" checked="checked"><span title="Personnage"></span>
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp2" value="vehicule"><span title="Véhicule"></span>
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp3" value="pnj"><span title="PNJ"></span>
  <div class="sheet-tab-content sheet-fp1">
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab1" value="caracs" checked="checked"><span title="Caractéristiques"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab2" value="voies"><span title="Capacités"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab3" value="equip"><span title="Équipement"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab4" value="config"><span title="Configuration"></span>
    <img class="sheet-imghr-up" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    <div class="sheet-tab-content sheet-tab1">
      <div>
        <!-- Caracs + combat + PV + défense -->
        <table>
          <tr>
            <td style="width:250px;">
              <!-- Caracs -->
              <table class="sheet-tabsep">
                <tr>
                  <td class="sheet-textfat">CARAC.</td>
                  <td></td>
                  <td class="sheet-textbase">Valeur</td>
                  <td class="sheet-textfat">Mod.</td>
                  <td class="sheet-textbase">Bonus</td>
                  <td class="sheet-textfat">Test</td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_for" title="%{jet_for} Jet de Force" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Force}} {{subtags=Test}} {{carac=[[@{FOR_SUP}[Dé] + [[@{FOR_TEST}]][Bonus] ]] }}"> FOR</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_FOR_SUP" title="@{FOR_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_FORCE" title="@{FORCE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR" title="@{FOR}" value="floor((@{FORCE}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR_BONUS" value="@{FOR_BUFF}" title="@{FOR_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR_TEST" title="@{FOR_TEST}" value="@{FOR}+@{FOR_BONUS}" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_dex" title="%{jet_dex} Jet de Dextérité" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Dextérité}} {{subtags=Test}} {{carac=[[@{DEX_SUP}[Dé] + [[@{DEX_TEST}]][Bonus] ]]}}"> DEX</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_DEX_SUP" title="@{DEX_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JDEX}" selected>N Normale</option>
                      <option value="@{JDEXSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JDEXSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_DEXTERITE" title="@{DEXTERITE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX" title="@{DEX}" value="floor((@{DEXTERITE}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX_BONUS" value="@{DEX_BUFF}" title="@{DEX_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX_TEST" title="@{DEX_TEST}" value="@{DEX}+@{DEX_BONUS}-(@{DEFARMUREON}*@{DEFARMUREMALUS})" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_con" title="%{jet_con} Jet de Constitution" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Constitution}} {{subtags=Test}} {{carac=[[@{CON_SUP}[Dé] + [[@{CON_TEST}]][Bonus] ]]}}"> CON</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_CON_SUP" title="@{CON_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_CONSTITUTION" title="@{CONSTITUTION}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON" title="@{CON}" value="floor((@{CONSTITUTION}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON_BONUS" value="@{CON_BUFF}" title="@{CON_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON_TEST" title="@{CON_TEST}" value="@{CON}+@{CON_BONUS}" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_int" title="%{jet_int} Jet d'Intelligence" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Intelligence}} {{subtags=Test}} {{carac=[[@{INT_SUP}[Dé] + [[@{INT_TEST}]][Bonus] ]]}}"> INT</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_INT_SUP" title="@{INT_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_INTELLIGENCE" title="@{INTELLIGENCE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT" title="@{INT}" value="floor((@{INTELLIGENCE}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT_BONUS" value="@{INT_BUFF}" title="@{INT_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT_TEST" title="@{INT_TEST}" value="@{INT}+@{INT_BONUS}" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_per" title="%{jet_per} Jet de Perception" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Perception}} {{subtags=Test}} {{carac=[[@{PER_SUP}[Dé] + [[@{PER_TEST}]][Bonus] ]]}}"> PER</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_PER_SUP" title="@{PER_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_PERCEPTION" title="@{PERCEPTION}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER" title="@{PER}" value="floor((@{PERCEPTION}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER_BONUS" value="@{PER_BUFF}" title="@{PER_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER_TEST" title="@{PER_TEST}" value="@{PER}+@{PER_BONUS}" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button class="sheet-boxtitre" type="roll" name="roll_jet_cha" title="%{jet_cha} Jet de Charisme" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Charisme}} {{subtags=Test}} {{carac=[[@{CHA_SUP}[Dé] + [[@{CHA_TEST}]][Bonus] ]]}}"> CHA</button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_CHA_SUP" title="@{CHA_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_CHARISME" title="@{CHARISME}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA" title="@{CHA}" value="floor((@{CHARISME}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA_BONUS" value="@{CHA_BUFF}" title="@{CHA_BONUS} Bonus au Test" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA_TEST" title="@{CHA_TEST}" value="@{CHA}+@{CHA_BONUS}" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-textfat" colspan="6">ÉTATS PRÉJUDICIABLES</td>
                </tr>
                <tr>
                  <td class="sheet-boxinputlight" colspan="6">
                    &nbsp;
                    <input type="radio" name="attr_ETATDE" value="20" title="@{ETATDE} Jet d'un d20 pour tous les tests" checked>&nbsp;Normal</input>
                    &nbsp;
                    <input type="radio" name="attr_ETATDE" value="12" title="@{ETATDE} Jet d'un d12 pour tous les tests">&nbsp;Affaibli</input>
                    &nbsp;
                    <input type="checkbox" name="attr_POISSE" title="@{POISSE} Moins bon de deux d20 pour tous les tests" value="1" />&nbsp;Poisse
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxinputlight" colspan="6"> <!--
                    Autres conditions :&nbsp;
                    <select class="sheet-carac" style="min-width: 100px;" name="attr_CONDITION" title="@{CONDITION}">
                      <option value="" selected>(aucune)</option>
                      <option value="A">Aveuglé</option>
                      <option value="F">Effrayé</option>
                      <option value="E">Etourdi</option>
                      <option value="I">Immobilisé</option>
                      <option value="P">Paniqué</option>
                      <option value="L">Ralenti</option>
                      <option value="R">Renversé</option>
                      <option value="S">Surpris</option>
                    </select> -->
                    <button type="action" class="sheet-iconbtn" name="act_cond_aveugle" title="Aveuglé">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_aveugle.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_effraye" title="Effrayé">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_effraye.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_etourdi" title="Etourdi">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_etourdi.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_immobilise" title="Immobilisé">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_immobilise.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_panique" title="Paniqué">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_panique.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_ralenti" title="Ralenti">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_ralenti.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_renverse" title="Renversé">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_renverse.png" />
                    </button>
                    <button type="action" class="sheet-iconbtn" name="act_cond_surpris" title="Surpris">
                      <img class="sheet-iconimg" src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_surpris.png" />
                    </button>
                    <br /><span name="attr_conditions" value=""></span>
                  </td>
                </tr>
              </table>
            </td>
            <!-- FIN Caracs -->
            <td style="width:100%;">
              <!-- Combat + PV + défense -->
              <table>
                <tr>
                  <td>
                    <!-- Combat -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat">COMBAT</td>
                        <td class="sheet-textbase">Base</td>
                        <td class="sheet-textbase">Mod.</td>
                        <td class="sheet-textbase">Div.</td>
                        <td class="sheet-textfat">Total</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_jet_cac" title="%{jet_cac} Jet d'attaque au contact" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Au Contact}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKCAC}]][Bonus] ]]}}"> AU CONTACT</button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKCAC_BASE" value="0" title="@{ATKCAC_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKCAC_CARAC" title="@{ATKCAC_CARAC}" size="1">
                            <option value="@{FOR}" selected>FOR</option>
                            <option value="@{DEX}">DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}">INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}">CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKCAC_DIV" title="@{ATKCAC_DIV} Bonus divers" value="@{ATKCAC_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKCAC" title="@{ATKCAC}" value="@{ATKCAC_BASE}+@{ATKCAC_CARAC}+@{ATKCAC_DIV}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_jet_tir" title="%{jet_tir} Jet d'attaque à distance" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=&Agrave; Distance}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKTIR}]][Bonus] ]]}}"> &Agrave; DISTANCE</button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKTIR_BASE" value="0" title="@{ATKTIR_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKTIR_CARAC" title="@{ATKTIR_CARAC}" size="1">
                            <option value="@{FOR}">FOR</option>
                            <option value="@{DEX}" selected>DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}">INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}">CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKTIR_DIV" title="@{ATKTIR_DIV} Bonus divers" value="@{ATKTIR_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKTIR" title="@{ATKTIR}" value="@{ATKTIR_BASE}+@{ATKTIR_CARAC}+@{ATKTIR_DIV}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_jet_men" title="%{jet_men} Jet d'attaque mentale" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Mental}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKMEN}]][Bonus] ]]}}"> MENTAL</button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKMEN_BASE" value="0" title="@{ATKMEN_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKMEN_CARAC" title="@{ATKMEN_CARAC}" size="1">
                            <option value="@{FOR}">FOR</option>
                            <option value="@{DEX}">DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}" selected>INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}">CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKMEN_DIV" title="@{ATKMEN_DIV} Bonus divers" value="@{ATKMEN_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKMEN" title="@{ATKMEN}" value="@{ATKMEN_BASE}+@{ATKMEN_CARAC}+@{ATKMEN_DIV}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_jet_mag" title="%{jet_mag} Jet d'attaque magique" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Magique}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKMAG}]][Bonus] ]]}}"> MAGIQUE</button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKMAG_BASE" value="0" title="@{ATKMAG_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKMAG_CARAC" title="@{ATKMAG_CARAC}" size="1">
                            <option value="@{FOR}">FOR</option>
                            <option value="@{DEX}">DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}">INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}" selected>CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKMAG_DIV" title="@{ATKMAG_DIV} Bonus divers" value="@{ATKMAG_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKMAG" title="@{ATKMAG}" value="@{ATKMAG_BASE}+@{ATKMAG_CARAC}+@{ATKMAG_DIV}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_jet_init" title="%{jet_init} Initiative" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Initiative}} {{subtags=Combat}} {{carac=[[@{INIT_JET} &{tracker}]]}}"> INITIATIVE</button>
                        </td>
                        <td class="sheet-boxtitre">
                          <button class="sheet-boxtitre" type="roll" name="roll_next_init" title="%{next_init} Actions multiples si jet d'Init > 20, 30, etc..." value="@{togm}&{template:co1} {{perso=@{selected|character_name}}} {{subtags=Initiative}} {{name=Action suivante}} {{desc=(A)ction / (M)ouvement à Init-[[10 &{tracker:-}]]}}"> Suite</button>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_INIT_CARAC" title="@{INIT_CARAC}" value="@{DEXTERITE}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_INIT_DIV" title="@{INIT_DIV} Bonus divers" value="@{INIT_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_INIT" title="@{INIT}" value="@{INIT_CARAC}+@{INIT_DIV}-(@{DEFARMUREON}*@{DEFARMUREMALUS})" disabled />
                        </td>
                      </tr>
                    </table>
                  </td>
                  <!-- FIN Combat -->
                  <td>
                    <!-- PV -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat">VITALITÉ</td>
                        <td class="sheet-textfat">&nbsp;</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre"> <!--
                          <button class="sheet-boxtitre" type="roll" name="JET_DV" title="Jet de Dé de Vie" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Dé de Vie}} {{subtags=Vitalité}} {{DV=[[ 1d@{DV}[Dé de Vie] + [[@{CON}]][CON] ]]}}"> DV</button> -->
                          <button class="sheet-boxtitre" type="action" name="act_dv" title="Progression d'un niveau"> DV</button>
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_DV" size="1" title="@{DV} Dé de Vie">
                            <option value="0" selected>-</option>
                            <option value="4">d4</option>
                            <option value="6">d6</option>
                            <option value="8">d8</option>
                            <option value="10">d10</option>
                            <option value="12">d12</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">PV</td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_PV_max" title="@{PV|max} Points de Vie maximum" value="0" />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxinput" colspan="2">
                          <span class="textbase">PV restants</span>&nbsp;
                          <input type="number" name="attr_PV" title="@{PV} Points de Vie restants" value="0" />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxinput" colspan="2">
                          <span class="textbase">DM temp.</span>&nbsp;
                          <input type="number" name="attr_DMTEMP" title="@{DMTEMP} Dommages Temporaires" value="0" />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxinput" colspan="2">
                          <input type="checkbox" name="attr_BLESSURE" title="@{BLESSURE}" value="1" />
                          <span class="textbase">Blessure Grave</span>&nbsp;
                          <input type="number" name="attr_SEUILBG" title="@{SEUILBG} Seuil de blessure grave" value="0" />
                        </td>
                      </tr>
                    </table>
                  </td>
                  <!-- FIN PV -->
                </tr>
                <tr>
                  <td colspan="2">
                    <!-- Défense -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat">DÉFENSE</td>
                        <td class="sheet-textbase">&nbsp;</td>
                        <td class="sheet-textbase">
                          Armure
                          <input type="checkbox" name="attr_DEFARMUREON" value="1" checked title="@{DEFARMUREON} Armure portée" />
                        </td>
                        <td class="sheet-textbase">DEX</td>
                        <td class="sheet-textbase">Div.</td>
                        <td class="sheet-textbase">Action défensive</td>
                        <td class="sheet-textfat">Total</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">DEF</td>
                        <td class="sheet-boxinputlight">10+</td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_DEFARMURE" title="@{DEFARMURE} Armure" value="0" />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEFCAR" value="@{DEX}" title="@{DEFCAR} Modificateur de Dextérité" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEFDIV" title="@{DEFDIV} Bonus divers" value="@{DEF_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" style="width: 80px" name="attr_DEFACT" size="1" title="@{DEFACT} Actions défensives">
                            <option value="0" selected>-</option>
                            <option value="2">Simple</option>
                            <option value="4">Totale (L)</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEF" value="10+(@{DEFARMURE}*@{DEFARMUREON})+@{DEFCAR}+@{DEFDIV}+@{DEFACT}" title="@{DEF}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-textfat" colspan="2" style="text-align: right;">Malus</td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_DEFARMUREMALUS" title="@{DEFARMUREMALUS} Malus aux Tests de DEX et à l'Init. quand l'armure est portée." value="0" />
                        </td>
                        <td class="sheet-textbase" colspan="3">&nbsp;</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre" title="Réduction(s) des DM">RD</td>
                        <td class="sheet-boxinput" colspan="6">
                          <textarea name="attr_RDS" title="@{RDS} Réduction(s) des DM" placeholder="Réduction(s) des DM"></textarea>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
            <!-- FIN Combat + PV + défense -->
          </tr>
        </table>
      </div>
      <!-- FIN Caracs + combat + PV + défense  -->
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div>
        <!-- Armes -->
        <table class="sheet-tabsep" title="repeating_armes">
          <tr>
            <td class="sheet-textfatleft" style="width:150px;">ARMES / ATTAQUES</td>
            <td class="sheet-textbase" style="width:150px;">ATTAQUE</td>
            <td class="sheet-textbase" style="width:20px;">CRIT.</td>
            <td class="sheet-textbase" style="width:205px;">DM</td>
            <td class="sheet-textbase" style="width:40px;">PORTÉE</td>
            <td class="sheet-textbase">SPÉCIAL</td>
          </tr>
        </table>
        <fieldset class="repeating_armes">
          <div class="attack">
            <input class="options-flag" name="attr_armeoptflag" type="checkbox" title="Montrer/cacher les options"><span>y</span>
            <div>
              <table class="sheet-tabsep">
                <tr>
                  <td>
                    <button type="roll" class="sheet-neutre" name="roll_jet" title="%{repeating_armes_$N_jet}" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{subtags=Attaque}} {{name=@{armenom}}} {{portee=@{armeportees}}} {{desc=@{armejetn} @{armelim}}} {{@{armeatt}[[@{armejetd}cs>@{armecrit}cf<@{armeinct}[Dé] + [[@{armeatk}]][Attaque] + [[@{armeatkdiv}]][Bonus] + (@{armebuff}) ]]}} {{@{armedmg}[[[[@{armedmnbde}d@{armedmde}@{armedmrel}@{armedmvrel}]][Dé DM] + ([[@{armedmcar}]])[Mod.DM] + (@{armedmdiv})[Bonus DM] + (@{armebuffdm}) ]]}} {{dmtype=@{armedmtype}}} {{degats2=@{armedmg2}}} {{dm2type=@{armedm2_desc}}} {{special=@{armespec}}}" />
                    <!-- original : "@{togm}&{template:co1} {{perso=@{character_name}}} {{subtags=Attaque}} {{name=@{armenom}  @{armelim}}} {{portee=@{armeportees}}} {{desc=@{armejetn}}} {{@{armeatt}[[@{armejetd}cs>@{armecrit}cf<@{armeinct}[Dé] + [[@{armeatk}]][Attaque] + [[@{armeatkdiv}]][Bonus] + ([[@{visee_att}]])[Tir visé] + ([[@{distance}]])[Portée] ]]}} {{@{armedmg}[[[[@{armedmnbde}d@{armedmde}@{armedmrel}@{armedmvrel}]][Dé DM] + ([[@{armedmcar}]])[Mod.DM] + (@{armedmdiv})[Bonus DM] + ([[@{visee_dm}]])[Tir visé] ]]}} {{dmtype=@{armedmtype}}} {{degats2=@{armedmg2}}} {{dm2type=@{armedm2_desc}}} {{special=@{armespec}}}" -->
                  </td>
                  <td class="sheet-boxinputleft" style="min-width:125px;">
                    <input type="text" name="attr_armenom" title="@armenom}" style="width: 125px; font-weight: bold;" placeholder="Arme/attaque" />
                  </td>
                  <td class="sheet-boxinputleft" style="min-width: 135px;">
                    <input type="checkbox" name="attr_armeatt" title="@{armeatt} Faire un jet d'attaque pour toucher" value="attaque=" checked="checked" />
                    <select class="sheet-carac" style="width: 87px;" name="attr_armeatk" title="@{armeatk}" size="1">
                      <option value="@{ATKCAC}" selected>CONTACT</option>
                      <option value="@{ATKTIR}">DISTANCE</option>
                      <option value="@{ATKMEN}">MENTAL</option>
                      <option value="@{ATKMAG}">MAGIE</option>
                    </select>+
                    <input type="number" style="width: 32px;" name="attr_armeatkdiv" value="0" title="@{armeatkdiv} Bonus d'attaque divers" />
                    <input type="hidden" name="attr_armebuff" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="text-align: right;">
                    <input type="number" name="attr_armecrit" style="width:32px;" min="2" max="20" value="20" title="@{armecrit} Seuil de Critique (par défaut 20)" />
                  </td>
                  <td class="sheet-boxinputleft">
                    <input type="checkbox" name="attr_armedmg" title="@{armedmg} Faire un jet de dommages" value="degats=" checked="checked" />
                    <input type="number" style="width:32px;" name="attr_armedmnbde" value="1" title="@{armedmnbde} Nombre de dés de dommage" />
                    <select class="sheet-carac" style="width:47px;" name="attr_armedmde" size="1" title="@{armedmde} Dé de dommage">
                      <optgroup label="Normal">
                        <option value="3">d3</option>
                        <option value="4">d4</option>
                        <option value="6" selected>d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                      </optgroup>
                      <optgroup label="Sans limite">
                        <option value="3!">d3</option>
                        <option value="4!">d4</option>
                        <option value="6!" selected>d6</option>
                        <option value="8!">d8</option>
                        <option value="10!">d10</option>
                        <option value="12!">d12</option>
                      </optgroup>
                    </select>+
                    <select class="sheet-carac" style="width:52px;" name="attr_armedmcar" size="1" title="@{armedmcar} Modificateur aux dommages">
                      <option value="0" selected>-</option>
                      <optgroup label="Mod. de Base">
                        <option value="@{FOR}">FOR</option>
                        <option value="@{DEX}">DEX</option>
                        <option value="@{CON}">CON</option>
                        <option value="@{INT}">INT</option>
                        <option value="@{PER}">PER</option>
                        <option value="@{CHA}">CHA</option>
                      </optgroup>
                      <optgroup label="Mod. de Test">
                        <option value="@{FOR_TEST}">FOR</option>
                        <option value="@{DEX_TEST}">DEX</option>
                        <option value="@{CON_TEST}">CON</option>
                        <option value="@{INT_TEST}">INT</option>
                        <option value="@{PER_TEST}">PER</option>
                        <option value="@{CHA_TEST}">CHA</option>
                      </optgroup>
                    </select>+
                    <input type="number" style="width:32px;" name="attr_armedmdiv" value="0" title="@{armedmdiv} Bonus de dommage divers" />
                    <input type="hidden" name="attr_armebuffdm" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="min-width:50px;">
                    <input type="text" name="attr_armeportee" placeholder="Portée" title="@{armeportee}" />
                    <input type="hidden" name="attr_armeportees" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 100%;">
                    <textarea name="attr_armespec" placeholder="Notes, capacités spéciales, effet ..." title="@{armespec}"></textarea>
                  </td>
                </tr>
              </table>
            </div>
            <div class="options">
              <table class="sheet-tabsep">
                <tr>
                  <td style="width: 18px;">&nbsp;</td>
                  <td class="sheet-boxinputleft" style="width: 275px;">
                    <input type="checkbox" name="attr_arme_al" style="width: 12px;" title="@{armelim} Action limitée (L)" value="1" />
                    <input type="hidden" name="attr_armelim" value="" />
                    <input type="text" name="attr_armejetn" class="sheet-carac" style="width: 230px; font-weight: bold;" placeholder="Nom de l'attaque" title="@{armejetn}" />
                    <select name="attr_armejetd" class="sheet-carac" style="width: 30px;" title="@{armejetd} Jet d'attaque : Normal, 'Risque' = avec d12, 'Expert' = meilleur de deux d20">
                      <option value="@{JETNORMAL}" selected>N - Normal</option>
                      <option value="@{JETRISQUE}">R - Risque (d12)</option>
                      <option value="@{JETSUP}">E - Expert (max 2 d20)</option>
                    </select>
                  </td>
                  <td class="sheet-boxinputleft" style="width: 32px;">
                    <input type="number" class="sheet-carac" style="width: 32px;" name="attr_armeinct" min="1" max="19" value="1" title="@{armeinct} Seuil d'incident de tir (par défaut 1)" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 215px;">
                    <input type="text" class="sheet-carac" style="width: 115px;" name="attr_armedmtype" title="@{armedmtype}" placeholder="Type DM">
                    <select class="sheet-carac" style="width: 40px;" name="attr_armedmrel" title="@{armedmrel} Relance dés de DM = (r)eroll -- 1 seule fois = (r)eroll (o)nce">
                      <option value="" selected>-x- Pas de relance DM</option>
                      <option value="r">-r- Relance DM (r)</option>
                      <option value="ro">-o- Relance DM 1 seule fois (ro)</option>
                    </select>
                    <input type="text" class="sheet-carac" style="width: 45px;" name="attr_armedmvrel" title="@{armedmvrel} Seuil de relance (relance les 1 si non indiqué)" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 240px;" colspan="2">
                    <input type="text" class="sheet-carac" style="width: 50px;" name="attr_armedm2_de" placeholder="1d6" title="@{armedm2_de}" />
                    <input type="text" class="sheet-carac" style="width: 190px;" name="attr_armedm2_desc" placeholder="Type de dommage supp." title="@{armedm2_desc}" />
                    <input type="hidden" name="attr_armedmg2" value="" />
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </fieldset>
        <table>
          <tr>
            <td>&nbsp;</td>
          </tr>
          <tr>
            <td>
              <textarea class="sheet-boxinputleft" style="height: 5em;" name="attr_mods_atk" title="Modificateurs de circonstances" placeholder="Ex: ATD -5 Portée double; DM ATD +[PER] Visée" value=""></textarea>
            </td>
          </tr>
          <tr>
            <td style="text-align: left;"><span name="attr_INFOMSG"></span></td>
          </tr> <!--
          <tr>
            <td class="sheet-textbase" style="width: 30%;">Bonus visée (L) :&nbsp;
              <input type="checkbox" name="attr_visee_att" title="@{visee_att} Bonus de PER à l'attaque" value="@{PER}" />&nbsp;Attaque&nbsp;
              <input type="checkbox" name="attr_visee_dm" title="@{visee_dm} Bonus de PER aux DM" value="@{PER}" />&nbsp;DM&nbsp;
            </td>
            <td class="sheet-textbase" style="width: 20%;">Distance :&nbsp;
              <select class="sheet-carac" style="width: 75px;" name="attr_distance" title="@{distance}" size="1">
                <option value="+3">Proche</option>
                <option value="0" selected>Normale</option>
                <option value="-5">Double</option>
                <option value="-10">Triple</option>
              </select>
            </td>
            <td>&nbsp;</td>
          </tr> -->
        </table>
      </div>
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    </div>
    <div class="sheet-tab-content sheet-tab2">
      <div>
        <!-- Voies -->
        <table>
          <tr>
            <td class="sheet-textfatleft" colspan="5">CAPACITÉS DU PERSONNAGE</td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
            <td class="sheet-boxtitresmall">Voie 1</td>
            <td class="sheet-boxtitresmall">Voie 2</td>
            <td class="sheet-boxtitresmall">Voie 3</td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">R</td>
            <td class="sheet-boxinputleft">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie1nom" title="voie1nom" placeholder="Nom de la Voie n°1" />
            </td>
            <td class="sheet-boxinput">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie2nom" placeholder="Nom de la Voie n°2" />
            </td>
            <td class="sheet-boxinput">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie3nom" placeholder="Nom de la Voie n°3" />
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">1</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie1-1" title="voie1-1"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie2-1"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie3-1"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">2</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie1-2" title="voie1-2"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie2-2"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie3-2"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">3</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie1-3" title="voie1-3"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie2-3"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie3-3"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">4</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie1-4" title="voie1-4"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie2-4"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie3-4"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">5</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie1-5" title="voie1-5"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie2-5"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie3-5"></textarea>
            </td>
          </tr>
        </table>
        <table>
          <tr>
            <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
            <td class="sheet-boxtitresmall">Voie 4</td>
            <td class="sheet-boxtitresmall">Voie 5</td>
            <td class="sheet-boxtitresmall">Voie 6</td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">R</td>
            <td class="sheet-boxinputleft">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie4nom" placeholder="Nom de la Voie n°4" />
            </td>
            <td class="sheet-boxinput">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie5nom" placeholder="Nom de la Voie n°5" />
            </td>
            <td class="sheet-boxinput">
              <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie6nom" placeholder="Nom de la Voie n°6" />
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">1</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie4-1"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie5-1"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie6-1"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">2</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie4-2"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie5-2"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie6-2"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">3</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie4-3"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie5-3"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie6-3"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">4</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie4-4"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie5-4"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie6-4"></textarea>
            </td>
          </tr>
          <tr>
            <td class="sheet-boxtitresmall">5</td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie4-5"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie5-5"></textarea>
            </td>
            <td class="sheet-boxvoie">
              <textarea name="attr_voie6-5"></textarea>
            </td>
          </tr>
        </table>
        <div>
          <input type="checkbox" class="sheet-block-switch" name="attr_voies789"><span>Plus de voies</span>
          <div class="sheet-block-hidden"></div>
          <div class="sheet-block-show">
            <table>
              <tr>
                <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
                <td class="sheet-boxtitresmall">Voie 7</td>
                <td class="sheet-boxtitresmall">Voie 8</td>
                <td class="sheet-boxtitresmall">Voie 9</td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">R</td>
                <td class="sheet-boxinputleft">
                  <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie7nom" placeholder="Nom de la Voie n°7" />
                </td>
                <td class="sheet-boxinput">
                  <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie8nom" placeholder="Nom de la Voie n°8" />
                </td>
                <td class="sheet-boxinput">
                  <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie9nom" placeholder="Nom de la Voie n°9" />
                </td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">1</td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie7-1"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie8-1"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie9-1"></textarea>
                </td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">2</td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie7-2"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie8-2"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie9-2"></textarea>
                </td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">3</td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie7-3"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie8-3"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie9-3"></textarea>
                </td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">4</td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie7-4"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie8-4"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie9-4"></textarea>
                </td>
              </tr>
              <tr>
                <td class="sheet-boxtitresmall">5</td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie7-5"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie8-5"></textarea>
                </td>
                <td class="sheet-boxvoie">
                  <textarea name="attr_voie9-5"></textarea>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <table class="sheet-tabsep" title="repeating_jetcapas">
          <tr>
            <td class="sheet-textfatleft" style="min-width:245px;">Jets de Capacités</td>
            <td class="sheet-textbase" style="width:100%;">&nbsp;</td>
          </tr>
        </table>
        <fieldset class="repeating_jetcapas">
          <table class="sheet-tabsep">
            <tr>
              <td>
                <button type="roll" class="sheet-neutre" name="roll_jet" title="%{repeating_jet_capas_$N_jet}" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{subtags=Capacité}} {{name=@{jetcapanom} @{jetcapalim}}} {{carac=[[@{jetcapanbde}d@{jetcapade}@{jetcapatypjet} + [[@{jetcapacarac}]] + @{jetcapadiv}]] }} {{jet=@{jetcapatitre}}} {{desc=@{jetcapavoie}}} {{text=@{jetcapadesc}}}" />
              </td>
              <td class="sheet-boxinputleft" style="min-width:200px;">
                <input type="text" name="attr_jetcapanom" title="@{jetcapanom}" style="font-weight: bold;" placeholder="Nom du Jet de capacité" />
              </td>
              <td class="sheet-boxinputleft">
                <input type="checkbox" name="attr_jetcapa_al" style="width: 12px;" title="@{jetcapalim} Action limitée (L)" value="1" />
                <input type="hidden" name="attr_jetcapalim" value="" />
                <input type="number" style="width:32px;" name="attr_jetcapanbde" value="1" title="@{jetcapanbde} Nombre de dés" />
                <select class="sheet-carac" style="width:50px;" name="attr_jetcapade" size="1" title="@{jetcapade} Dé">
                  <option value="4">d4</option>
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                  <option value="12">d12</option>
                  <option value="@{ETATDE}" selected>d20 (ou d12 si Affaibli)</option>
                </select>
                (
                <select class="sheet-carac" style="width:30px;" name="attr_jetcapatypjet" size="1" title="@{jetcapatypjet} Option du jet : normal, meilleur dé, moins bon dé, sans limite">
                  <option value="">N - Normal / additionner tous les dés</option>
                  <option value="kh1">S - Garder le meilleur dé</option>
                  <option value="kl1">I - Garder le moins bon dé</option>
                  <option value="!">E - Explosif (jet ouvert / sans limite)</option>
                </select>) +
                <select class="sheet-carac" style="width:60px;" name="attr_jetcapacarac" size="1" title="@{jetcapacarac} Modificateur du jet">
                  <option value="0" selected>-</option>
                  <option value="@{NIVEAU}">NIV</option>
                  <optgroup label="Mod. de Base">
                    <option value="@{FOR}">FOR</option>
                    <option value="@{DEX}">DEX</option>
                    <option value="@{CON}">CON</option>
                    <option value="@{INT}">INT</option>
                    <option value="@{PER}">PER</option>
                    <option value="@{CHA}">CHA</option>
                    <option value="@{QRYMOD}">Choix</option>
                  </optgroup>
                  <optgroup label="Mod. de Test">
                    <option value="@{FOR_TEST}">FOR</option>
                    <option value="@{DEX_TEST}">DEX</option>
                    <option value="@{CON_TEST}">CON</option>
                    <option value="@{INT_TEST}">INT</option>
                    <option value="@{PER_TEST}">PER</option>
                    <option value="@{CHA_TEST}">CHA</option>
                    <option value="@{QRYMODT}">Choix</option>
                  </optgroup>
                  <optgroup label="Attaques">
                    <option value="@{ATKCAC}">ATC</option>
                    <option value="@{ATKTIR}">ATD</option>
                    <option value="@{ATKMEN}">MEN</option>
                    <option value="@{ATKMAG}">MAG</option>
                  </optgroup>
                </select>+
                <input type="number" style="width:32px;" name="attr_jetcapadiv" value="0" title="@{jetcapadiv} Bonus divers" />
              </td>
              <td class="sheet-boxinputleft" style="width: 25%;">
                <input type="text" name="attr_jetcapatitre" style="width:100%;" placeholder="Compétence (CARAC)" title="@{jetcapatitre}" />
              </td>
              <td class="sheet-boxinputleft" style="width: 25%;">
                <input type="text" name="attr_jetcapavoie" style="width:100%;" placeholder="Voie, rang" title="@{jetcapavoie}" />
              </td>
            </tr>
            <tr>
              <td>&nbsp;</td>
              <td class="sheet-boxinputleft" colspan="4">
                <textarea name="attr_jetcapadesc" placeholder="Description" title="@{jetcapadesc}"></textarea>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
      <!-- FIN Voies -->
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div>
        <span class="sheet-textfatleft">Traits</span>
        <fieldset class="repeating_traits">
          <table class="sheet-tabsep">
            <tr>
              <td style="width: 15px;">
                <button type="roll" name="roll_trait" class="sheet-output" title="%{repeating_traits_$N_trait}" value='/w "@{character_name}" &{template:co1} {{perso=@{character_name}}} {{name=@{traitnom}}} {{subtags=@{traittype}}} {{text=@{traitdesc}}}'>w</button>
              </td>
              <td class="sheet-boxinputleft" style="width: 200px;">
                <input type="text" style="font-weight: bold;" name="attr_traitnom" placeholder="Nom du trait" title="@{traitnom}" />
              </td>
              <td class="sheet-boxinputleft" style="width: 150px;">
                <input type="text" name="attr_traittype" placeholder="Origine/Type de trait" title="@{traittype}" />
              </td>
              <td class="sheet-boxinputleft">
                <textarea name="attr_traitdesc" placeholder="Description" title="@{traitdesc}"></textarea>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    </div>
    <div class="sheet-tab-content sheet-tab3">
      <div>
        <!-- Equipement et règles optionnelles -->
        <div class="sheet-2colrow">
          <div class="sheet-col" title="repeating_equipement">
            <div class="sheet-textfatleft">&Eacute;QUIPEMENT</div>
            <div class="sheet-boxtitre">Consommables</div>
            <div class="sheet-boxinputleft">
              <span class="textbase">Argent&nbsp;:</span>&nbsp;
              <input type="text" style="width:230px;" name="attr_BOURSE" title="@{BOURSE}" placeholder="Rien ? C'est la pauvreté !" />
              <input type="number" name="attr_encombrement" title="@{encombrement} Encombrement total" value="@{total_enc}" disabled></span>
              / <input type="number" name="attr_seuil_enc" title="@{seuil_enc} Seuil d'encombrement (FOR)" value="0" />
            </div>
            <fieldset class="repeating_equipement">
              <div class="sheet-boxvoie">
                <input type="text" style="width: 280px;" name="attr_equip-desc" title="@{equip-desc}" /> &nbsp;
                <input type="number" name="attr_equip-enc" style="width: 30px;" value="0" title="@{equip-enc} Encombrement" />
                <span class="sheet-textbase">Qté</span>
                <input type="number" name="attr_equip-qte" style="width: 35px;" value="1" title="@{equip-qte}" />
              </div>
            </fieldset>
          </div>
          <div class="sheet-col">
            <div class="sheet-textfatleft">R&Egrave;GLES OPTIONNELLES</div>
            <table class="sheet-tabsep">
              <tr>
                <td class="sheet-boxtitre">
                  <button type="roll" class="sheet-boxtitre" title="%{jet_pc} Utilisation d'un PC" name="roll_jet_pc" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=@{PC_DESC}}} {{subtags=Bonus}} {{desc=@{character_name} utilise un @{PC_DESC} et obtient un bonus de @{PC_BONUS}}}" /> PC
                </td>
                <td class="sheet-boxtitre">
                  <button type="roll" class="sheet-boxtitre" title="%{jet_pr} Jet de Récupération" name="roll_jet_pr" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=Récupération}} {{subtags=Vitalité}} {{DV=[[1d@{DV}[Dé de Vie] +[[@{CON}]][CON] +@{NIVEAU}[Niveau] ]]}}" /> PR</td>
                <td class="sheet-boxtitre">PM</td>
              </tr>
              <tr>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PC_max" value="0" title="@{PC|max} Points de Chance MAX" />
                </td>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PR_max" value="0" title="@{PR|max} Points de Recup. MAX" />
                </td>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PM_max" value="0" title="@{PM|max} Points de Mana MAX" />
                </td>
              </tr>
              <tr>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PC" value="0" title="@{PC} Points de Chance courants" />
                </td>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PR" value="0" title="@{PR} Points de Recup. courants" />
                </td>
                <td class="sheet-boxinput">
                  <input type="number" name="attr_PM" value="0" title="@{PM} Points de Mana courants" />
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div class="sheet-2colrow">
          <div class="sheet-col" title="repeating_materiel">
            <div class="sheet-boxtitre">Divers</div>
            <fieldset class="repeating_materiel">
              <div class="sheet-boxvoie">
                <input type="text" name="attr_mat-desc" title="@{mat-desc}" />
              </div>
            </fieldset>
          </div>
          <div class="sheet-col" title="repeating_ressources">
            <div class="sheet-boxtitre">Autres ressources</div>
            <fieldset class="repeating_ressources">
              <div class="sheet-boxvoie">
                <input type="text" style="width: 290px;" name="attr_res-desc" title="@{res-desc}" /> &nbsp;
                <span class="sheet-textbase">Valeur :</span>
                <input type="number" name="attr_res-nbr" value="1" title="@{res-val}" />
              </div>
            </fieldset>
          </div>
        </div>
        <div class="sheet-row">
          <div class="sheet-col" style="width: 100%;">
            <table class="sheet-tabsep">
              <tr>
                <td class="sheet-boxtitre">Notes</td>
              </tr>
              <tr>
                <td class="sheet-boxinputleft">
                  <textarea name="attr_notes" style="height:10em;" title="@{notes}"></textarea>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      </div>
      <!-- FIN Equipement et règles optionnelles -->
    </div>
    <div class="sheet-tab-content sheet-tab4">
      <div class="sheet-row">
        <!-- Config -->
        <table class="sheet-tabsep">
          <tr>
            <td style="width: 15%;">
              <span class="textbase">Jets</span>&nbsp;
              <select class="sheet-carac" style="width: 80px;" name="attr_togm" title="@{togm}" size="1">
                <option value="" selected>Normaux</option>
                <option value="/w gm ">Cachés</option>
              </select>
            </td>
            <td>
              <span class="textbase">Initiative</span>&nbsp;
              <select class="sheet-carac" style="width: 90px;" name="attr_INIT_JET" title="@{INIT_JET}" size="1">
                <option value="@{INIT}" selected>Normale</option>
                <option value="[[@{INIT}]]+1d6!">Variable</option>
                <option value="{[[@{INIT}]]+1d6!, ([[@{INIT}]]*2)+0d6}kl1">Cyberpunk</option>
              </select>
            </td>
            <td>
              <span class="textbase">Bonus PC :</span>&nbsp;
              <input type="text" style="width: 80px;" name="attr_PC_BONUS" title="@{PC_BONUS}" /> &nbsp;(
              <input type="text" style="width: 150px;" name="attr_PC_DESC" title="@{PC_DESC}" />)
            </td>
            <td>
              <button type="action" class="sheet-iconbtn" name="act_reset" title="Re-calculer attributs (rangs, encombrement)">r</button>
            </td>
          </tr>
          <tr>
            <td>
              <span class="textbase">Encombrement</span>&nbsp;
              <input type="checkbox" name="attr_use_encombrement" title="@{use_encombrement} Gérer l'encombrement" value="1" />
            </td>
            <td>
              <span class="textbase">Progression PV :</span>&nbsp;
              <select class="sheet-carac" style="width: 90px;" name="attr_prog_pv" title="@{prog_pv}" size="1">
                <option value="0" selected>Jet DV</option>
                <option value="1">Moyenne</option>
              </select>
            </td>
          </tr>
        </table>
      </div>
      <!-- FIN Config -->
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div class="sheet-row">
        <!-- BUFFS -->
        <div class="sheet-textfatleft">BUFFS</div>
        <table class="sheet-tabsep">
          <tr>
            <td style="width: 5%;">FOR:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_FOR_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_FOR_BUFFS" value="@{FOR_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">DEX:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_DEX_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_DEX_BUFFS" value="@{DEX_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">CON:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_CON_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_CON_BUFFS" value="@{CON_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">INT:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_INT_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_INT_BUFFS" value="@{INT_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">PER:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_PER_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_PER_BUFFS" value="@{PER_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">CHA:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_CHA_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_CHA_BUFFS" value="@{CHA_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">ATC:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_ATKCAC_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_ATKCAC_BUFFS" value="@{ATKCAC_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">ATD:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_ATKTIR_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_ATKTIR_BUFFS" value="@{ATKTIR_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">MAG:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_ATKMAG_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_ATKMAG_BUFFS" value="@{ATKMAG_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">MEN:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_ATKMEN_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_ATKMEN_BUFFS" value="@{ATKMEN_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">INIT:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_INIT_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_INIT_BUFFS" value="@{INIT_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">DEF:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_DEF_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_DEF_BUFFS" value="@{DEF_BUFF}" disabled />
            </td>
          </tr>
          <tr>
            <td style="width: 5%;">PV:</td>
            <td style="width: 90%;">
              <input class="sheet-buff" type="text" name="attr_PV_BUFF_LIST" placeholder="<Type> : <Valeur>; <Type> <Valeur>..." />
            </td>
            <td style="width: 5%;">
              <input class="sheet-buff" type="number" name="attr_PV_BUFFS" value="@{PV_BUFF}" disabled />
            </td>
          </tr>
        </table>
      </div>
      <!-- FIN BUFFS -->
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div>
        <input type="checkbox" class="sheet-block-switch" name="attr_menacex"><span>Menace-X</span>
        <div class="sheet-block-hidden"></div>
        <div class="sheet-block-show">
          <table class="sheet-tabsep">
            <tr>
              <td class="sheet-boxtitre">
                <button class="sheet-boxtitre" type="roll" name="roll_jet_psi" title="%{jet_psi} Jet d'attaque PSI" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=PSI}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKPSI}]][Bonus] ]]}}"> Attaque PSI</button>
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_ATKPSI_BASE" value="0" title="@{ATKPSI_BASE}" />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_ATKPSI_CARAC" value="@{INT}" title="@{ATKPSI_CARAC} Mod. d'INT" disabled />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_ATKPSI_DIV" value="0" title="@{ATKPSI_DIV}" />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_ATKPSI" value="@{ATKPSI_BASE}+@{ATKPSI_CARAC}+@{ATKPSI_DIV}" title="@{ATKPSI}" disabled />
              </td>
              <td class="sheet-boxtitre">DEF PSI</td>
              <td class="sheet-boxinput">10+</td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_DEFPSI_CARAC" value="@{CHA}" title="@{DEFPSI_CARAC} Mod. de CHA" disabled />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_DEFPSI_ATK" value="@{ATKPSI}" title="@{DEFPSI_ATK}" disabled />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_DEFPSI_DIV" value="0" title="@{DEFPSI_DIV}" />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_DEFPSI" value="10+@{DEFPSI_CARAC}+@{DEFPSI_ATK}+@{DEFPSI_DIV}" title="@{DEFPSI}" disabled />
              </td>
              </td>
            </tr>
          </table>
          <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </div>
      </div>
    </div>
  </div>
  <div class="sheet-tab-content sheet-fp2">
    <div>
      <!-- Véhicule -->
      <table class="sheet-tabsep">
        <tr>
          <td class="sheet-textbase" colspan="2">Type :
            <input type="text" class="sheet-nobox" style="width: 75%;" name="attr_VEHICULE" title="@{VEHICULE}" />
          </td>
          <td class="sheet-textbase" colspan="3">Description :
            <input type="text" class="sheet-nobox" style="width: 75%;" name="attr_VEHICULE_DESC" title="@{VEHICULE_DESC}" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textbase" colspan="2">Pilote :
            <input type="text" class="sheet-nobox" style="width: 75%;" name="attr_PILOTE" title="@{PILOTE} Nom du pilote" />
          </td>
          <td colspan="3">&nbsp;</td>
        </tr>
        <tr>
          <td class="sheet-boxtitre" style="width: 15%;">FOR</td>
          <td class="sheet-boxtitre" style="width: 15%;">AGI</td>
          <td class="sheet-boxtitre" style="width: 25%;">PV</td>
          <td class="sheet-boxtitre" style="width: 35%;">DEF</td>
          <td class="sheet-boxtitre" style="width: 10%;">Blindage (RD)</td>
        </tr>
        <tr>
          <td class="sheet-boxinput">
            <input type="number" name="attr_FOV" value="0" title="@{FOV} Force du véhicule" />
          </td>
          <td class="sheet-boxinput">
            <input type="number" name="attr_AGI" value="0" title="@{AGI} Agilité du véhicule" />
          </td>
          <td class="sheet-boxinput">
            <input type="number" name="attr_PVV" value="0" title="@{PVV} Points de Vie courants" /> &nbsp;/&nbsp;
            <input type="number" name="attr_PVV_max" value="0" title="@{PVV|max} Points de Vie MAX" />
          </td>
          <td class="sheet-boxinput">&nbsp;Base :&nbsp;
            <input type="number" name="attr_DEFV_BASE" value="0" title="@{DEFV_BASE} DEF de base" /> + DEX :
            <input type="number" name="attr_DEFV_DEX" value="0" title="@{DEFV_DEX} DEX du pilote" /> =
            <input type="number" name="attr_DEFV" value="@{DEFV_BASE}+@{DEFV_DEX}" title="@{DEFV} DEF du véhicule" disabled />
          </td>
          <td class="sheet-boxinput">
            <input type="number" name="attr_RDV" value="0" title="@{RDV} Blindage" />
          </td>
        </tr>
      </table>
      <div class="sheet-row">
        <span class="textfatleft">Jets du véhicule</span>
      </div>
      <fieldset class="repeating_jetv">
        <table class="sheet-tabsep">
          <tr>
            <td>
              <button type="roll" class="sheet-neutre" name="roll_jetv" title="%{repeating_jetv_$N_jet_v} Jet de véhicule" value="@{togm}&{template:co1} {{perso=@{character_name}}} {{name=@{jetvnom}}} {{subtags=@{VEHICULE}}} {{carac=[[@{jetvnbde}d@{jetvde}@{jetvtypjet} + [[@{jetvcaracp}]][Bonus] + [[@{jetvcarac}]][Véhicule] + @{jetvdiv}[Divers] ]]}} {{desc=@{jetvdesc}}}" />
            </td>
            <td class="sheet-boxinputleft" style="min-width:200px;">
              <input type="text" name="attr_jetvnom" title="@{jetvnom}" style="font-weight: bold;" placeholder="Nom du Jet de véhicule" />
            </td>
            <td class="sheet-boxinputleft">
              <input type="number" style="width:32px;" name="attr_jetvnbde" value="1" title="@{jetvnbde} Nombre de dés" />
              <select class="sheet-carac" style="width:50px;" name="attr_jetvde" size="1" title="@{jetvde} Dé">
                <option value="4">d4</option>
                <option value="6">d6</option>
                <option value="8">d8</option>
                <option value="10">d10</option>
                <option value="12">d12</option>
                <option value="@{ETATDE}" selected>d20 (ou d12 si Affaibli)</option>
              </select>
              (
              <select class="sheet-carac" style="width:30px;" name="attr_jetvtypjet" size="1" title="@{jetvtypjet} Option du jet : normal, meilleur dé, moins bon dé, sans limite">
                <option value="">N - Normal / additionner tous les dés</option>
                <option value="kh1">S - Garder le dé Supérieur / le plus haut score</option>
                <option value="kl1">I - Garder le dé Inférieur / le plus bas score</option>
                <option value="!">E - Explosif (jet ouvert / sans limite)</option>
              </select>
              ) +
              <select class="sheet-carac" style="width:50px;" name="attr_jetvcaracpil" size="1" title="@{jetvcaracp} Mod. du personnage">
                <option value="0" selected>-</option>
                <optgroup label="Mod. de Base">
                  <option value="@{FOR}">FOR</option>
                  <option value="@{DEX}">DEX</option>
                  <option value="@{CON}">CON</option>
                  <option value="@{INT}">INT</option>
                  <option value="@{PER}">PER</option>
                  <option value="@{CHA}">CHA</option>
                </optgroup>
                <optgroup label="Mod. de Test">
                  <option value="@{FOR_TEST}">FOR</option>
                  <option value="@{DEX_TEST}">DEX</option>
                  <option value="@{CON_TEST}">CON</option>
                  <option value="@{INT_TEST}">INT</option>
                  <option value="@{PER_TEST}">PER</option>
                  <option value="@{CHA_TEST}">CHA</option>
                </optgroup>
                <optgroup label="Attaques">
                  <option value="@{ATKCAC}">ATC</option>
                  <option value="@{ATKTIR}">ATD</option>
                  <option value="@{ATKMEN}">MEN</option>
                  <option value="@{ATKMAG}">MAG</option>
                </optgroup>
              </select>
              +
              <select class="sheet-carac" style="width:50px;" name="attr_jetvcarac" size="1" title="@{jetvcarac} Mod. du véhicule">
                <option value="0" selected>-</option>
                <option value="@{FOV}">FOR</option>
                <option value="@{AGI}">AGI</option>
              </select>
              +
              <input type="number" style="width:32px;" name="attr_jetvdiv" value="0" title="@{jetvdiv} Bonus divers" />
              <input type="hidden" name="attr_jetvcaracp" value="" />
            </td>
            <td class="sheet-boxinputleft" style="width:100%;">
              <textarea name="attr_jetvdesc" placeholder="Description" title="@{jetvdesc}"></textarea>
            </td>
          </tr>
        </table>
      </fieldset>
      <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    </div>
    <!-- FIN Véhicule -->
  </div>
  <div class="sheet-tab-content sheet-fp3">
    <input type="radio" name="attr_tab_pnj" class="sheet-tab sheet-tab1" value="caracs" checked="checked"><span title="Caractéristiques"></span>
    <input type="radio" name="attr_tab_pnj" class="sheet-tab sheet-tab2" value="config"><span title="Configuration"></span>
    <img class="sheet-imghr-up" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    <div class="sheet-tab-content sheet-tab1">
      <div>
        <div class="sheet-2colrow">
          <div class="sheet-col">
            <div class="sheet-row">
              <span class="textfatleft">Attributs</span>
            </div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_for" title="%{pnj_for} Jet de Force" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Force}} {{subtags=Test}} {{carac=[[@{pnj_jetfor}cs20cf1[Dé] + [[@{pnj_for}]][FOR] ]] }}"> FOR</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_for" type="number" title="@{pnj_for}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetfor" title="@{pnj_jetfor}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_dex" title="%{pnj_dex} Jet de Dextérité" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Dextérité}} {{subtags=Test}} {{carac=[[@{pnj_jetdex}cs20cf1[Dé] + [[@{pnj_dex}]][DEX] ]] }}"> DEX</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_dex" type="number" title="@{pnj_dex}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetdex" title="@{pnj_jetdex}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_con" title="%{pnj_con} Jet de Constitution" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Constitution}} {{subtags=Test}} {{carac=[[@{pnj_jetcon}cs20cf1[Dé] + [[@{pnj_con}]][CON] ]] }}"> CON</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_con" type="number" title="@{pnj_con}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetcon" title="@{pnj_jetcon}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="sheet-row">&nbsp;</div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="jet_pnj_int" title="%{pnj_int} Jet d'Intelligence" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Intelligence}} {{subtags=Test}} {{carac=[[@{pnj_jetint}cs20cf1[Dé] + [[@{pnj_int}]][INT] ]] }}"> INT</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_int" type="number" title="@{pnj_int}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetint" title="@{pnj_jetint}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="jet_pnj_per" title="%{pnj_per} Jet de Perception" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Perception}} {{subtags=Test}} {{carac=[[@{pnj_jetper}cs20cf1[Dé] + [[@{pnj_per}]][PER] ]] }}"> PER</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_per" type="number" title="@{pnj_per}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetper" title="@{pnj_jetper}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="jet_pnj_cha" title="%{pnj_cha} Jet de Charisme" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Charisme}} {{subtags=Test}} {{carac=[[@{pnj_jetcha}cs20cf1[Dé] + [[@{pnj_cha}]][CHA] ]] }}"> CHA</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_cha" type="number" title="@{pnj_cha}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetcha" title="@{pnj_jetcha}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="sheet-row">&nbsp;</div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_init" title="%{pnj_init} Jet d'Initiative" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{name=Initiative}} {{subtags=Combat}} {{carac=[[@{pnj_init}[Init.] + @{pnj_init_var}[Dé(s)] &{tracker}]]}}"> Init.</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_init" type="number" title="@{pnj_init}" />
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">DEF / RD</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_def" type="number" title="@{pnj_def}" /> /
                  <input class="sheet-carac" name="attr_pnj_rd" type="number" title="@{pnj_rd}" />
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">PV</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_pv" type="number" title="@{pnj_pv} PV courants" /> /
                  <input class="sheet-carac" name="attr_pnj_pv_max" type="number" title="@{pnj_pv|max} PV MAX" />
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-row">
              <span class="textfatleft">Divers</span>
            </div>
            <div class="sheet-row">
              <textarea name="attr_pnj_divers" style="border: 1px solid; height: 15em;" title="@{pnj_divers}"></textarea>
            </div>
          </div>
        </div>
        <div class="sheet-row">&nbsp;</div>
        <img class="sheet-imghr-up" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <div class="sheet-row">
          <div class="sheet-row">
            <table>
              <tr>
                <td class="textfatleft" style="width: 250px;" title="repeating_pnjatk">Attaques</td>
                <td class="textbase" style="width: 55px;">Toucher</td>
                <td class="textbase" style="width: 55px;">Crit.</td>
                <td class="textbase" style="width: 150px;">DM</td>
                <td class="textbase" style="width: 50px;">Portée</td>
                <td class="textbase">Spécial</td>
              </tr>
            </table>
          </div>
          <fieldset class="repeating_pnjatk">
            <table class="sheet-tabsep">
              <tr>
                <td style="width: 30px;">
                  <button type="roll" class="sheet-neutre" style="width: 25px;" name="roll_jet" title="%{repeating_pnjatk_$N_jet} Jet d'attaque PNJ" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{subtags=Attaque}} {{name=@{atknom}}} {{portee=@{atkportee}}} {{@{atkatt}[[@{atkjet}cf1cs>@{atkcrit}[Dé] + [[@{atkbonus}]][Attaque] ]]}} {{@{atkdmg}[[@{atkdmnbde}d@{atkdmde}[Dé DM] + [[@{atkdmbonus}]][Mod.DM] ]]}} {{special=@{atkspec}}}" />
                </td>
                <td class="sheet-boxinputleft" style="width: 250px;">
                  <input type="checkbox" name="attr_atkatt" title="@{atkatt} Faire un jet d'attaque pour toucher" value="attaque=" checked="checked" />
                  <input type="text" class="sheet-carac" style="width: 180px;" name="attr_atknom" title="@{atknom} Nom de l'arme / attaque" />
                  <select class="sheet-carac" style="width: 30px;" name="attr_atkjet" title="@{atkjet} Jet d'attaque normal (d20) ou expert (meilleur de deux d20)">
                    <option value="1d20" selected>N Normal</option>
                    <option value="2d20kh1">E Expert</option>
                  </select>
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkbonus" title="@{atkbonus} Bonus d'attaque" value="0" />
                </td>
                <td class="sheet-boxinputleft" style="width: 35px;">
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkcrit" title="@{atkcrit} Seuil de critique" value="20" />
                </td>
                <td class="sheet-boxinputleft" style="width: 130px;">
                  <input type="checkbox" name="attr_atkdmg" title="@{atkdmg} Faire un jet de dommages" value="degats=" checked="checked" />
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkdmnbde" title="@{atkdmnbde} Nombre de dés de DM" value="0" />
                  <select class="sheet-carac" style="width: 45px;" name="attr_atkdmde" title="@{atkdmde} Dé de DM">
                    <optgroup label="Normaux">
                      <option value="3">d3</option>
                      <option value="4">d4</option>
                      <option value="6">d6</option>
                      <option value="8">d8</option>
                      <option value="10">d10</option>
                      <option value="12">d12</option>
                    </optgroup>
                    <optgroup label="Sans limite">
                      <option value="3!">d3</option>
                      <option value="4!">d4</option>
                      <option value="6!" selected>d6</option>
                      <option value="8!">d8</option>
                      <option value="10!">d10</option>
                      <option value="12!">d12</option>
                    </optgroup>
                  </select>
                  +
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkdmbonus" title="@{atkdmbonus} Bonus aux DM" value="0" />
                </td>
                <td class="sheet-boxinputleft" style="width: 35px;">
                  <input type="text" class="sheet-carac" style="width: 35px;" name="attr_atkportee" title="@{atkportee} Portée" value="" />
                </td>
                <td class="sheet-boxinputleft">
                  <textarea class="sheet-carac" name="attr_atkspec" title="@{atkspec} Autres effets"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
        </div>
        <div class="sheet-row">&nbsp;</div>
        <img class="sheet-imghr-up" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <div class="sheet-row">
          <div class="sheet-row">
            <span class="textfatleft">Capacités</span>
          </div>
          <fieldset class="repeating_pnjcapas">
            <table class="sheet-tabsep">
              <tr>
                <td style="width: 30px;">
                  <button type="roll" class="sheet-neutre" style="width: 25px;" name="roll_jet" title="%{repeating_pnjcapas_$N_jet} Jet de capacité PNJ" value="@{pnj_togm}&{template:co1} {{perso=@{character_name}}} {{subtags=Capacité}} {{name=@{capanom}}} {{text=@{capadesc}}}" />
                </td>
                <td class="sheet-boxinputleft" style="width: 200px;">
                  <input type="text" class="sheet-carac" style="width: 200px;" name="attr_capanom" title="@{capanom} Nom de la capacité" />
                </td>
                <td class="sheet-boxinputleft">
                  <textarea class="sheet-carac" name="attr_capadesc" title="@{capadesc} Description de la capacité"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
        </div>
        <div class="sheet-row">&nbsp;</div>
        <img class="sheet-imghr-up" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <div class="sheet-row">
          <input type="checkbox" class="sheet-block-switch"><span>Importer statblock</span>
          <div class="sheet-block-hidden"></div>
          <div class="sheet-block-show">
            <div class="sheet-2colrow">
              <div class="sheet-col">
                <textarea class="sheet-boxinputleft" name="attr_statblock" style="height: 10em;" placeholder="Coller ici un statblock copié depuis le PDF"></textarea>
              </div>
              <div class="sheet-col">
                <textarea name="attr_sbresult" style="border: 1px solid; height: 5em;"></textarea>
              </div>
            </div>
          </div>
        </div>
      </diV>
    </div>
    <div class="sheet-tab-content sheet-tab2">
      <div class="sheet-3colrow">
        <div class="sheet-col">
          <span class="textbase">Jets</span>&nbsp;
          <select class="sheet-carac" style="width: 75px;" name="attr_pnj_togm" title="@{pnj_togm}" size="1">
            <option value="" selected>Normaux</option>
            <option value="/w gm ">Cachés</option>
          </select>
        </div>
        <div class="sheet-col">
          <span class="textbase">Initiative variable</span>&nbsp;
          <input type="checkbox" name="attr_pnj_init_var" title="@{pnj_init_var}" value="[[1d6!]]" />
        </div>
        <div class="sheet-col"></div>
      </div>
    </div>
  </div>
</div>
<!-- FIN FDP -->
<!-- TEMPLATES -->
<rolltemplate class="sheet-rolltemplate-co1">
  <div class="sheet-roundtable">
    <table>
      <tr>
        <th colspan="2" style="text-align: center;">{{perso}}</th>
      </tr>
      <tr>
        <td class="subheader">{{subtags}}</td>
        <th>{{name}}</th>
      </tr>
      {{#portee}}
      <tr>
        <td style="font-size: smaller; text-align: center;" colspan="2">Portée : {{portee}}</td>
      </tr>
      {{/portee}}
      <tr>
        <td colspan="2">
          <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </td>
      </tr>
      {{#desc}}
      <tr>
        <td colspan="2" style="white-space:normal;">
          <div class="desc">{{desc}}</div>
        </td>
      </tr>
      {{/desc}} 
      {{#DV}}
      <tr>
        <td class="tcat">PV gagnés</td>
        <td>{{DV}}</td>
      </tr>
      {{/DV}} 
      {{#carac}}
      <tr>
        {{#jet}}
          <td class="tcat">{{jet}} </td>
        {{/jet}} 
        {{^jet}}
          <td class="tcat">Jet </td>
        {{/jet}}
        <td>{{carac}}</td>
      </tr>
      {{/carac}} 
      {{#test}}
      <tr>
        <td colspan="2" style="display: none;">{{test}}</td>
      </tr>
        {{#rollWasCrit() test}}
        <tr>
          <td colspan="2" style="color:green;">
            <div class="desc"><b>{{test_crit}}</b></div>
          </td>
        </tr>
        {{/rollWasCrit() test}} 
        {{#rollWasFumble() test}}
        <tr>
          <td colspan="2" style="color:red;">
            <div class="desc"><b>{{test_fumble}}</b></div>
          </td>
        </tr>
        {{/rollWasFumble() test}} 
      {{/test}} 
      {{#attaque}} 
        {{#rollWasCrit() attaque}}
        <tr>
          <td colspan="2" style="color:green;"><b>Critique !</b></td>
        </tr>
        {{/rollWasCrit() attaque}} 
        {{#rollWasFumble() attaque}}
        <tr>
          <td colspan="2" style="color:red;"><b>Fumble !</b></td>
        </tr>
        {{/rollWasFumble() attaque}}
        <tr>
          <td class="tcat">Jet </td>
          <td>{{attaque}} contre DEF</td>
        </tr>
        {{#degats}}
        <tr>
          <td class="tcat">Dégâts </td>
          <td>
            {{degats}} {{#rollWasCrit() attaque}}
            <span style="color:green;font-weight:bold;"> + {{degats}}</span> {{/rollWasCrit() attaque}} {{dmtype}}
          </td>
        </tr>
          {{#degats2}}
          <tr>
            <td style="text-align: right;">+</td>
            <td><span style="color: steelblue;">{{degats2}} {{dm2type}}</span></td>
          </tr>
          {{/degats2}} 
        {{/degats}} 
      {{/attaque}} 
      {{^attaque}} 
        {{#degats}}
        <tr>
          <td class="tcat">Dégâts </td>
          <td>{{degats}} {{dmtype}}</td>
        </tr>
          {{#degats2}}
          <tr>
            <td style="text-align: right;">+</td>
            <td><span style="color: steelblue;">{{degats2}} {{dm2type}}</span></td>
          </tr>
          {{/degats2}} 
        {{/degats}} 
      {{/attaque}} 
      {{#special}}
      <tr>
        <td colspan="2" style="white-space:normal;">
          <div class="desc">{{special}}</div>
        </td>
      </tr>
      {{/special}} 
      {{#text}}
      <tr>
        <td colspan="2" style="white-space:normal; margin: 1px;">
          <div class="text">{{text}}</div>
        </td>
      </tr>
      {{/text}}
      <tr>
        <td colspan="2">
          <img class="sheet-imghr" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </td>
      </tr>
    </table>
  </div>
</rolltemplate>
<!-- FIN TEMPLATES -->
<!-- **** SCRIPTS / SHEET WORKERS -->
<script type="text/worker">

  function consoleLog(l, m) {
    m = m || '';
    if (m !== '') m = ' : ' + m;
    console.log('** CO sheetworker' + m + ' <<<');
    console.log(l);
    console.log('** CO sheetworker' + m + ' >>>');
  }
  
  function getRandom(max) {
    let min = 1;
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min +1)) + min;
  }

  function addTrait(npcObj, traitObj) {
    if (traitObj['nom'] !== '' && traitObj['desc'] !== '') {
      if (!npcObj['Capas']) npcObj['Capas'] = [];
      npcObj['Capas'].push(`${traitObj['nom']}~${traitObj['desc']}`);
      traitObj['nom'] = '';
      traitObj['desc'] = '';
    }
  }
  
  function importStatblock(text) {
    text = text.replace(/\r/g, '');
    text = text.replace(/ \(DM/g, ' DM');
    text = text.replace(/ \(RD/g, ' RD');
    text = text.replace(/\, /g, ' ');
    text = text.replace(/\n[ ]*\+/g,'+');
    var npc = {};
    var rows = text.split(/\n/);
    var capacites = false;
    var capacite = { 'nom': '', 'desc': '' };
    console.log('** CO sheetworker : parsing text <<<');
    for (var row = 0; row < rows.length; row++) {
      console.log(rows[row]);
      if (row === 0 && rows[row].toUpperCase().indexOf('NC') === -1) {
        npc['character_name'] = rows[row].trim(); // assume first line is name
        continue;
      }
      if (!capacites && rows[row].toUpperCase().indexOf('DM') !== -1) { // this is an attack line
        rows[row] = rows[row].replace(/\)$/g, ''); // handle CG statblocks
        if (!npc['Atks']) npc['Atks'] = [];
        npc['Atks'].push(rows[row]);
        continue;
      }
      if (capacites) { // start parsing traits
        let s = rows[row].indexOf(':');
        if (s !== -1) {
          addTrait(npc, capacite); 
          capacite['nom'] = rows[row].substring(0, s - 1).trim();
          if (capacite['nom'].indexOf(' RD') !== -1) capacite['nom'] = capacite['nom'].replace(' RD', ' (RD');
          capacite['desc'] = rows[row].substring(s + 1).trim();
        } else {
          capacite['desc'] += ' ' + rows[row].trim();
        }
        continue;
      }
      if (rows[row].trim().startsWith('---')) {
        addTrait(npc, capacite);
        capacites = !capacites;
        continue;
      }
      rows[row] = rows[row].replace(/ \(/g, '('); // strip space before '(
      rows[row] = rows[row].replace(/très /g, 'très~'); // handle 'très petite' size
      rows[row] = rows[row].replace(/créature /g, 'PROFIL créature~'); // handle 'créature' mention
      var items = rows[row].split(' ');
      for (var item = 0; item < items.length; item++) {
        if (item % 2 === 0) {
          var k = items[item].toUpperCase().replace(/\./g, '');
          var v = items[item + 1];
          if (v) {
            v.replace(/~/g, ' ');
            if (v.charAt(v.length - 1) === ')' && v.charAt(0) !== '(') v = v.substring(0, v.length - 1);
          } else {
            v = '';
          }
          npc[k] = v;
        }
      }
    }
    if (capacites) addTrait(npc, capacite);
    console.log('** CO sheetworker : parsing text >>>');
    return npc;
  }

  function processBaseAttributes(universe, pnjObj) {
    var result = '';
    var pnj_sagorper = '';
    var pnj_jetsagorper = '';
    if (universe === 'COF') { // COF uses SAG (Wisdom)
      pnj_sagper = 'pnj_sag';
      pnj_jetsagper = 'pnj_jetsag';
      if (!pnjObj.hasOwnProperty('SAG') && pnjObj.hasOwnProperty('PER')) {
        // in case a CG/COC statblock is pasted to COF
        sagOrPer = pnjObj.PER;
        result = 'Attention : PER trouvé à la place de SAG';
      } else {
        sagOrPer = pnjObj.SAG;
      }
    }
    if (universe === 'COC' || universe === 'CG') { // CG & COC uses PER (Perception)
      pnj_sagper = 'pnj_per';
      pnj_jetsagper = 'pnj_jetper';
      if (!pnjObj.hasOwnProperty('PER') && pnjObj.hasOwnProperty('SAG')) {
        // in case a COF statblock is pasted to CG/COC
        sagOrPer = pnjObj.SAG;
        result = 'Attention : SAG trouvé à la place de PER';
      } else {
        sagOrPer = pnjObj.PER;
      }
    }
    var jnor = '1d20';
    var jsup = '2d20kh1';
    var pnjAttrs = {};
    if (pnjObj.hasOwnProperty('character_name')) pnjAttrs['character_name'] = pnjObj.character_name;
    delete pnjObj['character_name'];
    pnjAttrs['NIVEAU'] = parseInt(pnjObj.NC) || 0;
    delete pnjObj['NC'];
    pnjAttrs['TAILLE'] = pnjObj.TAILLE || '';
    delete pnjObj['TAILLE'];
    if (pnjObj.hasOwnProperty('PROFIL')) pnjAttrs['PROFIL'] = pnjObj.PROFIL;
    delete pnjObj['PROFIL'];
    pnjAttrs['pnj_for'] = parseInt(pnjObj['FOR'].replace('*', ''));
    pnjAttrs['pnj_jetfor'] = pnjObj['FOR'].charAt(pnjObj['FOR'].length - 1) == '*' ? jsup : jnor;
    delete pnjObj['FOR'];
    pnjAttrs['pnj_dex'] = parseInt(pnjObj['DEX'].replace('*', ''));
    pnjAttrs['pnj_jetdex'] = pnjObj['DEX'].charAt(pnjObj['DEX'].length - 1) == '*' ? jsup : jnor;
    delete pnjObj['DEX'];
    pnjAttrs['pnj_con'] = parseInt(pnjObj['CON'].replace('*', ''));
    pnjAttrs['pnj_jetcon'] = pnjObj['CON'].charAt(pnjObj['CON'].length - 1) == '*' ? jsup : jnor;
    delete pnjObj['CON'];
    pnjAttrs['pnj_int'] = parseInt(pnjObj['INT'].replace('*', ''));
    pnjAttrs['pnj_jetint'] = pnjObj['INT'].charAt(pnjObj['INT'].length - 1) == '*' ? jsup : jnor;
    delete pnjObj['INT'];
    pnjAttrs[pnj_sagper] = parseInt(sagOrPer.replace('*', ''));
    pnjAttrs[pnj_jetsagper] = sagOrPer.charAt(sagOrPer.length - 1) == '*' ? jsup : jnor;
    delete pnjObj['SAG'];
    delete pnjObj['PER'];
    pnjAttrs['pnj_cha'] = parseInt(pnjObj['CHA'].replace('*', ''));
    pnjAttrs['pnj_jetcha'] = pnjObj['CHA'].charAt(pnjObj['CHA'].length - 1) == '*' ? jsup : jnor;
    delete pnjObj['CHA'];
    pnjAttrs['pnj_init'] = parseInt(pnjObj.INIT);
    delete pnjObj['INIT'];
    pnjAttrs['pnj_def'] = parseInt(pnjObj.DEF);
    delete pnjObj['DEF'];
    pnjAttrs['pnj_pv'] = parseInt(pnjObj.PV);
    pnjAttrs['pnj_pv_max'] = parseInt(pnjObj.PV);
    delete pnjObj['PV'];
    consoleLog(pnjAttrs, 'setting attributes');
    pnjAttrs['statblock'] = '';
    setAttrs(pnjAttrs);

    return result;
  }

  function processAttacks(universe, pnjObj) {
    var result = '';
    for (var atk = 0; atk < pnjObj.Atks.length; atk++) {
      var atkItems = pnjObj.Atks[atk].split(' ');
      consoleLog(atkItems, 'attacks found');
      if (atkItems[atkItems.length - 1] === 'DM') atkItems.push('-');
      var atkAtt = 'attaque=';
      var atkNom = '';
      var atkBonus = -1;
      var atkDM = '';
      var atkSpec = '';
      var parsed = '';
      for (var item = 0; item < atkItems.length; item++) {
        if (atkItems[item] === 'DM' && atkNom === '') {
          atkNom = parsed;
          parsed = 'DM';
          continue;
        }
        if (atkItems[item].charAt(0) === '+' && atkItems[item] !== '+' && atkNom === '') {
          atkBonus = parseInt(atkItems[item].replace('+', '')) || 0;
          atkNom = parsed;
          parsed = '';
          continue;
        }
        if (parsed.endsWith('DM')) {
          atkDM = atkItems[item];
          atkSpec = parsed.replace('DM', '');
          parsed = '';
          continue;
        }
        parsed += parsed != '' ? ' ' : '';
        parsed += atkItems[item];
      }
      consoleLog(atkNom + ' ' + atkBonus + ' ' + atkDM + ' ' + atkSpec);
      if (atkBonus === -1) atkAtt = ''; // No attack bonus found, damage only
      var atkDmg = 'degats=';
      var atkNbDe = 0;
      var atkDe = '';
      var atkBonusDM = 0;
      if (atkDM !== '') {
        atkDM = atkDM.replace('d', '|');
        atkDM = atkDM.replace('+', '|+');
        atkDM = atkDM.replace('-', '|-');
        var dm = atkDM.split('|');
        atkNbDe = parseInt(dm[0]) || 0;
        if (atkNbDe === 0) atkDmg = ''; // No damage dice, attack only
        atkDe = dm[1];
        if (universe === 'COC') atkDe += '!';
        atkBonusDM = parseInt(dm[2]) || 0;
      }
      if (atkNom !== '' && atkNbDe >= 0 && atkDe !== '') {
        newRowID = generateRowID();
        var atkRow = {};
        atkRow[`repeating_pnjatk_${newRowID}_atkatt`] = atkAtt;
        atkRow[`repeating_pnjatk_${newRowID}_atknom`] = atkNom;
        atkRow[`repeating_pnjatk_${newRowID}_atkjet`] = '1d20';
        atkRow[`repeating_pnjatk_${newRowID}_atkbonus`] = atkBonus;
        atkRow[`repeating_pnjatk_${newRowID}_atkcrit`] = '20';
        atkRow[`repeating_pnjatk_${newRowID}_atkdmg`] = atkDmg;
        atkRow[`repeating_pnjatk_${newRowID}_atkdmnbde`] = atkNbDe;
        atkRow[`repeating_pnjatk_${newRowID}_atkdmde`] = atkDe;
        atkRow[`repeating_pnjatk_${newRowID}_atkdmbonus`] = atkBonusDM;
        atkSpec += parsed;
        atkSpec = atkSpec.replace(/\d+d\d+/g, '[[$&]]'); // search for <numbers>d<numbers> and replace with in-line roll
        if (atkSpec !== '') atkRow[`repeating_pnjatk_${newRowID}_atkspec`] = atkSpec;
        consoleLog(atkRow, 'adding attack');
        setAttrs(atkRow);
      } else {
        result += (result.length > 0 ? '\n' : '') + 'Err: impossible d\'analyser le contenu de "' + pnjObj.Atks[atk] + '"';
      }
    }

    return result;
  }
  
  function processTraits(universe, pnjObj) {
    let result = '';

    for (let capa of pnjObj['Capas']) {
      let capacite = capa.split('~')
      if (capacite.length == 2) {
        let name = capacite[0] || '';
        let desc = capacite[1] || '';
        if (name !== '' && desc !== '') {
          newRowID = generateRowID();
          let capaRow = {};
          capaRow[`repeating_pnjcapas_${newRowID}_capanom`] = name;
          desc = desc.replace(/\d+d\d+[+-]*\d*/g, '{{$&}}'); // search for <numbers>d<numbers>+/-<number> 
          desc = desc.replace(/\[\d+d\d+[+-]*\d*\]/g, '{$&}'); // search for [<numbers>d<numbers>+/-<number>]
          desc = desc.replace(/\[{{/g, '[[');
          desc = desc.replace(/}}\]/g, ']]');
          desc = desc.replace(/{{/g, '[[');
          desc = desc.replace(/}}/g, ']]');
          capaRow[`repeating_pnjcapas_${newRowID}_capadesc`] = desc;
          consoleLog(capaRow, 'adding trait');
          setAttrs(capaRow);
        }
      } else {
        result += (result.length > 0 ? '\n' : '') + 'Err: impossible d\'analyser le contenu de "' + capacite + '"';
      }
    }
    
    return result;
  };

  function buildCaracs() {
    getAttrs([
      'FORCE', 'DEXTERITE', 'CONSTITUTION', 'INTELLIGENCE', 'PERCEPTION', 'CHARISME', 'NIVEAU',
      'RANG_VOIE1', 'RANG_VOIE2', 'RANG_VOIE3', 'RANG_VOIE4', 'RANG_VOIE5', 'RANG_VOIE6', 'RANG_VOIE7', 'RANG_VOIE8', 'RANG_VOIE9',
      'voie1nom', 'voie2nom', 'voie3nom', 'voie4nom', 'voie5nom', 'voie6nom', 'voie7nom', 'voie8nom', 'voie9nom',
      'DEFARMUREON'
    ], function(values) {
      let caracs = {
        FOR: 0,
        DEX: 0,
        CON: 0,
        INT: 0,
        PER: 0,
        CHA: 0
      };
      for (let car in values) {
        let vcar = values[car];
        if (vcar && !isNaN(vcar)) vcar = parseInt(vcar) || 0;
        let mod = car.substring(0, 3);
        if (caracs.hasOwnProperty(mod)) caracs[mod] = Math.floor((vcar - 10) / 2);
        if (car.startsWith('RANG_')) {
          if (!caracs.hasOwnProperty('rangs')) caracs.rangs = [0, 0, 0, 0, 0, 0, 0, 0, 0];
          let voie = parseInt(car.substring(car.length - 1)) || 0;
          if (voie > 0) {
            caracs[car] = vcar;
            caracs.rangs[voie - 1] = vcar;
          }
        } else if (car.startsWith('voie') && car.endsWith('nom')) {
          if (!caracs.hasOwnProperty('voies')) caracs.voies = ['', '', '', '', '', '', '', '', ''];
          let voie = parseInt(car.substring(4, 5)) || 0;
          if (voie > 0 && vcar) caracs.voies[voie - 1] = vcar.toUpperCase();
        } else {
          caracs[car] = vcar;
        }
      }
      setAttrs({
        CARACS: JSON.stringify(caracs)
      });
    });
  }

  on('sheet:opened', function() {
    // **** Gestion transition de version
    getAttrs(['VERSION'], function(values) {
      var verfdp = parseFloat(values.VERSION) || 0;
      if (verfdp < 2.0) { // version 1.x > 2.0
        getAttrs(['UNIVERS', 'FOR_BONUS', 'DEX_BONUS', 'CON_BONUS', 'INT_BONUS', 'PER_BONUS', 'CHA_BONUS', 'ATKCAC_DIV', 'ATKTIR_DIV', 'ATKMAG_DIV', 'ATKMEN_DIV', 'PSYINTUI_DIV', 'PSYINFLU_DIV', 'INIT_DIV', 'DEFDIV', 'DEPDIV'], function(values) {
          var for_bonus_desc = '',
            for_bonus = parseInt(values.FOR_BONUS) || 0;
          if (for_bonus !== 0) for_bonus_desc = 'Bonus FOR';
          var dex_bonus_desc = '',
            dex_bonus = parseInt(values.DEX_BONUS) || 0;
          if (dex_bonus !== 0) dex_bonus_desc = 'Bonus DEX';
          var con_bonus_desc = '',
            con_bonus = parseInt(values.CON_BONUS) || 0;
          if (con_bonus !== 0) con_bonus_desc = 'Bonus CON';
          var int_bonus_desc = '',
            int_bonus = parseInt(values.INT_BONUS) || 0;
          if (int_bonus !== 0) int_bonus_desc = 'Bonus INT';
          var per_bonus_desc = '',
            per_bonus = parseInt(values.PER_BONUS) || 0;
          if (per_bonus !== 0) per_bonus_desc = 'Bonus PER';
          var cha_bonus_desc = '',
            cha_bonus = parseInt(values.CHA_BONUS) || 0;
          if (cha_bonus !== 0) cha_bonus_desc = 'Bonus CHA';
          var atkcac_bonus_desc = '',
            atkcac_div = parseInt(values.ATKCAC_DIV) || 0;
          if (atkcac_div !== 0) atkcac_bonus_desc = 'Bonus ATC';
          var atktir_bonus_desc = '',
            atktir_div = parseInt(values.ATKTIR_DIV) || 0;
          if (atktir_div !== 0) atktir_bonus_desc = 'Bonus ATD';
          var atkmag_bonus_desc = '',
            atkmag_div = parseInt(values.ATKMAG_DIV) || 0;
          if (atkmag_div !== 0) atkmag_bonus_desc = 'Bonus MAG';
          var atkmen_bonus_desc = '',
            atkmen_div = parseInt(values.ATKMEN_DIV) || 0;
          if (atkmen_div !== 0) atkmen_bonus_desc = 'Bonus MEN';
          var psyinflu_bonus_desc = '',
            psyinflu_div = parseInt(values.ATKPSYINFLU_DIV) || 0;
          if (psyinflu_div !== 0) psyinflu_bonus_desc = 'Bonus Psy Inf.';
          var psyintui_bonus_desc = '',
            psyintui_div = parseInt(values.ATKPSYINTUI_DIV) || 0;
          if (psyintui_div !== 0) psyintui_bonus_desc = 'Bonus Psy Int.';
          var init_bonus_desc = '',
            init_div = parseInt(values.INIT_DIV) || 0;
          if (init_div !== 0) init_bonus_desc = 'Bonus Init.';
          var def_bonus_desc = '',
            defdiv = parseInt(values.DEFDIV) || 0;
          if (defdiv !== 0) def_bonus_desc = 'Bonus DEF';
          var dep_bonus_desc = '',
            depdiv = parseInt(values.DEPDIV) || 0;
          if (depdiv !== 0) dep_bonus_desc = 'Bonus DEP';
          setAttrs({
            FOR_BUFF1_DESC: for_bonus_desc,
            FOR_BUFF1: for_bonus,
            FOR_BUFF: for_bonus,
            DEX_BUFF1_DESC: dex_bonus_desc,
            DEX_BUFF1: dex_bonus,
            DEX_BUFF: dex_bonus,
            CON_BUFF1_DESC: con_bonus_desc,
            CON_BUFF1: con_bonus,
            CON_BUFF: con_bonus,
            INT_BUFF1_DESC: int_bonus_desc,
            INT_BUFF1: int_bonus,
            INT_BUFF: int_bonus,
            SAG_BUFF1_DESC: sag_bonus_desc,
            SAG_BUFF1: sag_bonus,
            SAG_BUFF: sag_bonus,
            PER_BUFF1_DESC: per_bonus_desc,
            PER_BUFF1: per_bonus,
            PER_BUFF: per_bonus,
            CHA_BUFF1_DESC: cha_bonus_desc,
            CHA_BUFF1: cha_bonus,
            CHA_BUFF: cha_bonus,
            ATKCAC_BUFF1_DESC: atkcac_bonus_desc,
            ATKCAC_BUFF1: atkcac_div,
            ATKCAC_BUFF: atkcac_div,
            ATKTIR_BUFF1_DESC: atktir_bonus_desc,
            ATKTIR_BUFF1: atktir_div,
            ATKTIR_BUFF: atktir_div,
            ATKMAG_BUFF1_DESC: atkmag_bonus_desc,
            ATKMAG_BUFF1: atkmag_div,
            ATKMAG_BUFF: atkmag_div,
            ATKMEN_BUFF1_DESC: atkmen_bonus_desc,
            ATKMEN_BUFF1: atkmen_div,
            ATKMEN_BUFF: atkmen_div,
            PSYINFLU_BUFF1_DESC: psyinflu_bonus_desc,
            PSYINFLU_BUFF1: psyinflu_div,
            PSYINFLU_BUFF: psyinflu_div,
            PSYINTUI_BUFF1_DESC: psyintui_bonus_desc,
            PSYINTUI_BUFF1: psyintui_div,
            PSYINTUI_BUFF: psyintui_div,
            INIT_BUFF1_DESC: init_bonus_desc,
            INIT_BUFF1: init_div,
            INIT_BUFF: init_div,
            DEF_BUFF1_DESC: def_bonus_desc,
            DEF_BUFF1: defdiv,
            DEF_BUFF: defdiv,
            DEP_BUFF1_DESC: dep_bonus_desc,
            DEP_BUFF1: depdiv,
            DEP_BUFF: depdiv,
            VERSION: '2.0'
          });
        });
      }
      if (verfdp < 2.5) { // version 2.x > 2.5
        const attrList = ['FOR', 'DEX', 'CON', 'INT', 'PER', 'CHA', 'ATKCAC', 'ATKTIR', 'ATKMAG', 'ATKMEN', 'INIT', 'DEF'];
        for (let a = 0; a < attrList.length; a++) {
          let attr = attrList[a];
          let attrDesc = [];
          let attrVals = [];
          for (let b = 1; b < 6; b++) {
            attrDesc.push(`${attr}_BUFF${b}_DESC`);
            attrVals.push(`${attr}_BUFF${b}`);
          }
          getAttrs([attr, ...attrDesc, ...attrVals], function(values) {
            let attr = Object.keys(values)[0];
            let buffList = [];
            for (let b = 1; b < 6; b++) {
              let desc = values[`${attr}_BUFF${b}_DESC`] || '';
              let buff = values[`${attr}_BUFF${b}`] || 0;
              if (desc !== '') buffList.push(`${desc} : ${buff}`);
            }
            let buffAttr = {};
            buffAttr[`${attr}_BUFF_LIST`] = buffList.join(';');
            setAttrs(buffAttr);
          });
        }
        setAttrs({
          VERSION: '2.5'
        });
      }
    });
    // Activer Buffs PSY
    getAttrs(["UNIVERS", 'type_personnage'], function(values) {
      if (values.type_personnage === 'pj') {
        if (values.UNIVERS === 'CG') {
          setAttrs({
            voir_psy: '1'
          });
        }
      }
    });
    // MAJ Version, LAST_PV, messsage
    getAttrs(['VERFDP', 'PV'], function(values) {
      setAttrs({
        VERSION: values.VERFDP,
        LAST_PV: values.PV,
        INFOMSG: ' '
      });
    });
    // PC (one time only)
    getAttrs(['PC_DESC'], function(value) {
      var pc_desc = (value.PC_DESC) ? '' : 'Points de Chance';
      if (pc_desc != '') {
        setAttrs({ 
          PC_DESC: pc_desc
        });
      }
    });
    // seuil_enc (if needed)
    getAttrs(['seuil_enc', 'FORCE'], function(values) {
      let seuil_enc = parseInt(values.seuil_enc) || 0;
      if (seuil_enc === 0) {
        setAttrs({
          seuil_enc: parseInt(values.FORCE) || 0
        });
      }
    });
    // encombrement (refresh)
    encumbrance();
    // CARACS
    buildCaracs();
  });

  
  function buffValue(v, caracs) {
    v = v.trim();
    let bv = 0;
    let bm = 1;
    if (v.startsWith('-')) bm = -1;
    if (v.indexOf('2[') !== -1) {
      v = v.replace('2[','[');
      bm *= 2;
    }
    v = v.replace(/[\+\-\[\]]/g, '');
    if (isNaN(v)) {
      // c'est une référence d'attribut
      if (v.length === 5 && v.toUpperCase().startsWith('VOIE')) {
        // c'est un rang dans une voie identifiée par son no
        let rv = parseInt(v.substring(4).trim()) || 0;
        if (rv > 0) bv = caracs.rangs[rv - 1];
      } else if (v.toUpperCase().startsWith('RANG ')) {
        // c'est un rang dans une voie identifiée par son nom
        let vname = v.substring(4).trim().toUpperCase();
        let vfound = -1;
        for (let vn = 0; vn < caracs.voies.length; vn++) {
          if (caracs.voies[vn] === vname) {
            vfound = vn;
            break;
          }
        }
        if (vfound > -1) bv = caracs.rangs[vfound];
      } else {
        if (caracs.hasOwnProperty(v)) {
          // c'est un mod. de carac
          bv = caracs[v];
        } else {
          // c'est une expression numérique
          for (let attr of Object.keys(caracs)) {
            let re = new RegExp(`${attr}`,'g');
            v = v.replace(re, 'caracs[\'$&\']');
          }
          bv = eval(v);
        }
      }
    } else { // c'est une valeur fixe
      bv = v;
    }
    return parseInt(bv) * bm || 0;
  }

  function parseBuff(buffAttr) {
    getAttrs([`${buffAttr}_BUFF_LIST`, 'CARACS'], function(v) {
      let buffAttr = Object.keys(v)[0];
      let buffList = v[buffAttr];
      let caracs = JSON.parse(v.CARACS);
      let buffSum = 0;
      if (buffList && buffList !== '') {
        let buffs = buffList.split(';');
        for (let b = 0; b < buffs.length; b++) {
          let buff = buffs[b];
          if (buff && buff !== '') {
            let delim = (buff.indexOf(':') !== -1) ? ':' : ' ';
            let buffv = buff.split(delim);
            let buffName = '';
            let buffVal = 0;
            if (delim === ' ') {
              buffVal = buffValue(buffv[buffv.length - 1], caracs);
              buffv.pop();
              buffName = buffv.join(' ').trim();
            } else {
              buffName = buffv[0].trim();
              buffVal = buffValue(buffv[1], caracs);
            }
            if (!buffName.startsWith('-')) buffSum += buffVal;
          }
        }
      }
      let attr = {};
      attr[buffAttr.replace('_LIST', '')] = buffSum;
      setAttrs(attr);
    });
  }

  function updateBuffs(e) {
    const caracs = ['FOR', 'DEX', 'CON', 'INT', 'PER', 'CHA'];
    let ref = e.sourceAttribute;
    let mod = ref.substring(0, 3);
    if (caracs.includes(mod.toUpperCase())) ref = mod;
    const attrs = [...caracs, 'ATKCAC', 'ATKTIR', 'ATKMAG', 'ATKMEN', 'INIT', 'DEF', 'PV'];
    for (let a = 0; a < attrs.length; a++) {
      attrs[a] = `${attrs[a]}_BUFF_LIST`;
    }
    attrs.unshift(ref);
    getAttrs(attrs, function(values) {
      let props = Object.keys(values);
      for (let p = 1; p < props.length; p++) {
        let ref = props[0];
        if (props[p].startsWith(ref)) continue;
        if (values[props[p]].toLowerCase().indexOf(ref) !== -1) {
          parseBuff(props[p].replace('_BUFF_LIST', ''));
        }
      }
    });
  };

  function changeCaracs() {
    let changedCaracs = '';
    const caracs = ['FORCE', 'DEXTERITE', 'CONSTITUTION', 'INTELLIGENCE', 'PERCEPTION', 'CHARISME', 'NIVEAU', 'DEFARMUREON'];
    for (let c = 0; c < caracs.length; c++) {
      changedCaracs += `change:${caracs[c].toLowerCase()} `;
    }
    return changedCaracs;
  }

  on(changeCaracs(), function(eventInfo) {
    // on reconstruit d'abord l'attribut caché CARACS...
    buildCaracs();
    // ... puis on met à jour les buffs qui contiennent une référence à la caractéristique modifiée
    updateBuffs(eventInfo);
  });

/*
  const caracs = ['FORCE', 'DEXTERITE', 'CONSTITUTION', 'INTELLIGENCE', 'PERCEPTION', 'CHARISME', 'NIVEAU', 'DEFARMUREON'];

  on(`change:${caracs.join(' change:').toLowerCase()}`,(eventInfo) => {
    // on reconstruit d'abord l'attribut caché CARACS...
    buildCaracs();
    // ... puis on met à jour les buffs qui contiennent une référence à la caractéristique modifiée
    updateBuffs(eventInfo);
  });
*/
  on('change:for_buff_list', function() {
    parseBuff('FOR');
  });

  on('change:dex_buff_list', function() {
    parseBuff('DEX');
  });

  on('change:con_buff_list', function() {
    parseBuff('CON');
  });

  on('change:int_buff_list', function() {
    parseBuff('INT');
  });

  on('change:per_buff_list', function() {
    parseBuff('PER');
  });

  on('change:cha_buff_list', function() {
    parseBuff('CHA');
  });

  on('change:atkcac_buff_list', function() {
    parseBuff('ATKCAC');
  });

  on('change:atktir_buff_list', function() {
    parseBuff('ATKTIR');
  });

  on('change:atkmag_buff_list', function() {
    parseBuff('ATKMAG');
  });

  on('change:atkmen_buff_list', function() {
    parseBuff('ATKMEN');
  });

  on('change:init_buff_list', function() {
    parseBuff('INIT');
  });

  on('change:def_buff_list', function() {
    parseBuff('DEF');
  });

  on('change:pv_buff_list', function() {
    parseBuff('PV');
  });
  
  on('change:blessure', function() {
    getAttrs(['BLESSURE'], function(values) {
      var etatde = (values.BLESSURE === '1') ? '12' : '20';
      setAttrs({
        ETATDE: etatde
      });
    });
  });

  on('change:poisse', function() {
    getAttrs(['POISSE'], function(values) {
      var jetn = (values.POISSE === '1') ? '2d@{ETATDE}kl1' : '1d@{ETATDE}';
      var jets = (values.POISSE === '1') ? '1d@{ETATDE}' : '2d@{ETATDE}kh1';
      var jetsh = (values.POISSE === '1') ? '2d@{ETATDE}kh1' : '{2d@{ETATDE}kh1, 0d20+10}kh1';
      var jetr = (values.POISSE === '1') ? '2d12kl1' : '1d12';
      setAttrs({
        JETNORMAL: jetn,
        JETSUP: jets,
        JETSUPHERO: jetsh,
        JETRISQUE: jetr,
        JDEX: jetn,
        JDEXSUP: jets,
        JDEXSUPHERO: jetsh,
        JDEXRISQUE: jetr
      });
    });
  });

  on('change:pv', function() {
    getAttrs(['PV', 'PV_max', 'LAST_PV', 'SEUILBG', 'BLESSURE'], function(values) {
      var seuilbg = parseInt(values.SEUILBG) || 0;
      var max_pv = parseInt(values.PV_max) || 0;
      var last_pv = parseInt(values.LAST_PV) || max_pv;
      var curr_pv = parseInt(values.PV) || 0;
      var blessure = values.BLESSURE;
      if (seuilbg > 0) {
        if (last_pv - curr_pv >= seuilbg || curr_pv === 0) blessure = '1';
      }
      setAttrs({
        LAST_PV: values.PV,
        BLESSURE: blessure
      });
    });
  });

  on('change:statblock', function(eventInfo) {
    if (!eventInfo.newValue || eventInfo.newValue === '') return;
    getAttrs(['UNIVERS', 'statblock'], function(values) {
      var messages = '';
      pnjObj = importStatblock(values.statblock);
      if (pnjObj) {
        consoleLog(pnjObj, 'NPC object');
        messages = processBaseAttributes(values.UNIVERS, pnjObj);
        if (pnjObj.hasOwnProperty('Atks')) {
          result = processAttacks(values.UNIVERS, pnjObj);
          if (result != '' && messages != '') result = '\n' + result;
          messages += result;
          delete pnjObj['Atks'];
        }
        if (pnjObj.hasOwnProperty('Capas')) {
          result = processTraits(values.UNIVERS, pnjObj);
          if (result != '' && messages != '') result = '\n' + result;
          messages += result;
          delete pnjObj['Capas'];
        }
        // Other attributes go to DIVERS field
        var divers = '';
        var otherAttrs = Object.keys(pnjObj);
        consoleLog(otherAttrs, 'additional data');
        if (otherAttrs.length > 0) {
          for (var other = 0; other < otherAttrs.length; other++) {
            var k = otherAttrs[other];
            divers += k + ' ' + pnjObj[k] + '\n';
          }
        }
        setAttrs({
          pnj_divers: divers,
          sbresult: messages
        });
      }
    });
  });

  const npcAtkAttribs = [
    'atkatt', 
    'atknom', 
    'atkjet', 
    'atkbonus', 
    'atkcrit', 
    'atkdmg', 
    'atkdmnbde', 
    'atkdmde', 
    'atkdmbonus', 
    'atkportee', 
    'atkspec'
  ]
  
  function convertToPC() {
    getAttrs([
      'pnj_for', 'pnj_dex', 'pnj_con', 'pnj_int', 'pnj_per', 'pnj_cha', 
      'pnj_jetfor', 'pnj_jetdex', 'pnj_jetcon', 'pnj_jetint', 'pnj_jetper', 'pnj_jetcha', 
      'pnj_init', 'pnj_def', 'pnj_pv', 'pnj_pv_max'
      ], function(values) {
      let attrs = {};
      for (let attr of ['FORCE', 'DEXTERITE', 'CONSTITUTION', 'INTELLIGENCE', 'PERCEPTION', 'CHARISME']) {
        let attrv = parseInt(values[`pnj_${attr.substring(0,3).toLowerCase()}`]) || 0;
        attrs[attr] = 10 + (2 * attrv);
        if (attr === 'DEXTERITE') {
          let init = parseInt(values.pnj_init) || 0;
          if (init === attrv + 1) {
            attrs[attr]++;
          } else {
            attrs['INIT_BUFF'] = init - attrs[attr];
          }
          let defb = 10 + attrv;
          let def = parseInt(values.pnj_def) || 0;
          if (def !== defb) attrs['DEF_BUFF'] = def - defb;
          attrs['DEX_SUP'] = (values['pnj_jetdex'] === '2d20kh1') ? '@{JDEXSUP}' : '@{JDEX}';
        } else {
          attrs[`${attr.substring(0,3)}_SUP`] = (values[`pnj_jet${attr.substring(0,3).toLowerCase()}`] === '2d20kh1') ? '@{JETSUP}' : '@{JETNORMAL}';
        }
      }
      attrs['PV'] = parseInt(values.pnj_pv) || 0;
      attrs['PV_max'] = parseInt(values.pnj_pv_max) || 0;
      getSectionIDs('repeating_armes', function(ids) {
        for (let id of ids) {
          removeRepeatingRow(`repeating_armes_${id}`);
        }
      });
      getSectionIDs('repeating_pnjatk', function(ids) {
        for (let id of ids) {
          getAttrs([...npcAtkAttribs.map(attr => `repeating_pnjatk_${id}_${attr}`), 'pnj_for', 'pnj_dex', 'pnj_cha'], function(values) {
            consoleLog(values);
            let v = {};
            for (let attr of npcAtkAttribs) {
              v[attr] = values[`repeating_pnjatk_${id}_${attr}`] || '';
            }
            newRowID = generateRowID();
            let atkRow = {};
            atkRow[`repeating_armes_${newRowID}_armeatt`] = v['atkatt'];
            atkRow[`repeating_armes_${newRowID}_armenom`] = v['atknom'];
            let magic = v['atknom'].toLowerCase().includes('attaque magique');
            let tohit = parseInt(v['atkbonus']) || 0;
            let atk = 0;
            let bdm = 0;
            if (v['atkportee'] && v['atkportee'] !== '') {
              atk = magic ? values.pnj_cha || 0 : values.pnj_dex || 0;
              atkRow[`repeating_armes_${newRowID}_armeatk`] = magic ? '@{ATKMAG}' : '@{ATKTIR}';
            } else {
              atk = magic ? values.pnj_cha || 0 : values.pnj_for || 0;
              bdm = magic ? 0 : atk;
              atkRow[`repeating_armes_${newRowID}_armeatk`] = magic ? '@{ATKMAG}' : '@{ATKCAC}';
              atkRow[`repeating_armes_${newRowID}_armedmcar`] = magic ? '' : '@{FOR}';
            }
            if (tohit !== atk) atkRow[`repeating_armes_${newRowID}_armeatkdiv`] = tohit - atk;
            atkRow[`repeating_armes_${newRowID}_armejetd`] = v['atkjet'];
            atkRow[`repeating_armes_${newRowID}_armecrit`] = v['atkcrit'];
            atkRow[`repeating_armes_${newRowID}_armedmg`] = v['atkdmg'];
            atkRow[`repeating_armes_${newRowID}_armedmnbde`] = v['atkdmnbde'];
            atkRow[`repeating_armes_${newRowID}_armedmde`] = v['atkdmde'];
            let dmdiv = parseInt(v['atkdmbonus']) || 0;
            if (dmdiv !== bdm) atkRow[`repeating_armes_${newRowID}_armedmdiv`] = dmdiv - bdm;
            atkRow[`repeating_armes_${newRowID}_armeportee`] = v['atkportee'];
            atkRow[`repeating_armes_${newRowID}_armespec`] = v['atkspec'];
            setAttrs(atkRow);
          });
        }
      });
      setAttrs(attrs);
    });
  }
  
  on('change:type_personnage', function(eventInfo) {
    if (eventInfo.previousValue === 'pnj' && eventInfo.newValue === 'pj') convertToPC();
    // if (eventInfo.previousValue === 'pj' && eventInfo.newValue === 'pnj') convertToNPC();
    getAttrs(['type_personnage'], function(values) {
      setAttrs({
        type_fiche: values.type_personnage
      });
    });
  });

  function changeRanks(voie) {
    return `change:voie${voie}nom change:voie${voie}-1 change:voie${voie}-2 change:voie${voie}-3 change:voie${voie}-4 change:voie${voie}-5`;
  }

  function attrRanks(voie) {
    let attrs = [];
    for (let r = 1; r < 6; r++) {
      attrs.push(`voie${voie}-${r}`);
    }
    return attrs;
  }

  function setRank(voie) {
    getAttrs(attrRanks(voie), function(v) {
      let vr = 0;
      for (let r = 1; r < 6; r++) {
        let attr = v[`voie${voie}-${r}`];
        if (attr && attr !== '') vr = r;
      }
      let rank = {};
      rank[`RANG_VOIE${voie}`] = vr;
      setAttrs(rank);
      buildCaracs();
    });
  }

  on(changeRanks('1'), function() {
    setRank('1');
  });

  on(changeRanks('2'), function() {
    setRank('2');
  });

  on(changeRanks('3'), function() {
    setRank('3');
  });

  on(changeRanks('4'), function() {
    setRank('4');
  });

  on(changeRanks('5'), function() {
    setRank('5');
  });

  on(changeRanks('6'), function() {
    setRank('6');
  });

  on(changeRanks('7'), function() {
    setRank('7');
  });

  on(changeRanks('8'), function() {
    setRank('8');
  });

  on(changeRanks('9'), function() {
    setRank('9');
  });

  on('change:repeating_armes:armedm2_de change:repeating_armes:armedm2_desc', function(eventInfo) {
    getAttrs(['repeating_armes_armedm2_de', 'repeating_armes_armedm2_desc'], function(values) {
      let dm2_de = values.repeating_armes_armedm2_de || '';
      let dm2_desc = values.repeating_armes_armedm2_desc || '';
      let dmg2 = '';
      if (dm2_desc !== '') dm2_desc = `[${dm2_desc}] `;
      if (dm2_de !== '') dmg2 = `[[${dm2_de}${dm2_desc}]]`;
      setAttrs({
        repeating_armes_armedmg2: dmg2
      });
    });
  });

  on('change:repeating_armes:armeportee', function() {
    getAttrs(['repeating_armes_armeportee'], function(value) {
      let um = '';
      if (value.repeating_armes_armeportee.indexOf(' m') !== -1) {
        um = ' m';
      } else if (value.repeating_armes_armeportee.indexOf('m') !== -1) {
        um = 'm';
      }
      let portee = value.repeating_armes_armeportee;
      if (um !== '') portee = portee.replace(um,'');
      let portees = parseInt(portee) || 0;
      if (portees !== 0) {
        setAttrs({ 
          repeating_armes_armeportees: `${portees}m | ${portees*2}m (-5) | ${portees*3}m (-10)` 
        });
      }
    });
  });

  function actionLimitee(v) {
    return (parseInt(v[Object.keys(v)[0]]) || 0) === 1 ? '(L)' : '';
  }

  on('change:repeating_armes:arme_al', function() {
    getAttrs(['repeating_armes_arme_al'], function(value) {
      setAttrs({
        repeating_armes_armelim: actionLimitee(value)
      });
    });
  });

  on('change:repeating_jetcapas:jetcapa_al', function() {
    getAttrs(['repeating_jetcapas_jetcapa_al'], function(value) {
      setAttrs({
        repeating_jetcapas_jetcapalim: actionLimitee(value)
      });
    });
  });

  function pilotStat(pilote, carac) {
    let pilote_carac = '0';
    if (carac !== '0') {
      if (pilote !== '') pilote += '|';
      pilote_carac = carac.replace('@{', `@{${pilote}`);
    }
    return pilote_carac;
  }

  on('change:pilote', function() {
    getAttrs(['PILOTE'], function(value) {
      var pilote = value.PILOTE.trim() || '';
      if (pilote === '') return;
      getSectionIDs('repeating_jetv', function(ids) {
        for (let id = 0; id < ids.length; id++) {
          getAttrs([`repeating_jetv_${ids[id]}_jetvcaracpil`, `repeating_jetv_${ids[id]}_jetvcaracp`], function(values) {
            let attr = values[Object.keys(values)[0]];
            let pilote_carac = pilotStat(pilote, attr);
            let rattr = {};
            rattr[Object.keys(values)[1]] = pilote_carac;
            setAttrs(rattr);
          });
        }
      });
    });
  });

  on('change:repeating_jetv:jetvcaracpil', function() {
    getAttrs(['PILOTE', 'repeating_jetv_jetvcaracpil'], function(values) {
      let pilote = values.PILOTE || '';
      let carac = values.repeating_jetv_jetvcaracpil || '';
      let pilote_carac = pilotStat(pilote, carac);
      setAttrs({
        repeating_jetv_jetvcaracp: pilote_carac
      });
    });
  });

  function encumbrance() {
    getSectionIDs('repeating_equipement', function(ids) {
      const encombrement = {
        total: 0,
        zeros: 0
      }
      for (let id = 0; id < ids.length; id++) {
        getAttrs([`repeating_equipement_${ids[id]}_equip-qte`, `repeating_equipement_${ids[id]}_equip-enc`], function(values) {
          let qte = parseInt(values[Object.keys(values)[0]]) || 0;
          let enc = parseInt(values[Object.keys(values)[1]]) || 0;
          if (enc === 0) {
            encombrement.zeros += qte;
            if (encombrement.zeros >= 3) {
              encombrement.total += Math.floor(encombrement.zeros / 3);
              encombrement.zeros %= 3;
            }
          } else {
            encombrement.total += qte*enc;
          }
          setAttrs({
            total_enc: encombrement.total
          });
        });
      }
    });
  }
  
  on('change:repeating_equipement:equip-qte change:repeating_equipement:equip-enc', function() {
    encumbrance();
  });

  on('change:total_enc', function() {
    getAttrs(['use_encombrement', 'total_enc', 'seuil_enc'], function(values) {
      let use_encombrement = values.use_encombrement === 1 ? true : false;
      if (!use_encombrement) return;
      let seuil_enc = parseInt(values.seuil_enc) || 0;
      let encombrement = parseInt(values.total_enc) || 0;
      if (seuil_enc > 0 && encombrement > 0) {
        let cond = {};
        if (encombrement > seuil_enc * 3) {
          cond.CONDITION = 'I'; // Immobilisé 
        } else if (encombrement > seuil_enc * 2) {
          cond.CONDITION = 'L'; // Ralenti
          cond.ETATDE = '12'; // +Affaibli
        } else if (encombrement > seuil_enc) {
          cond.CONDITION = '';
          cond.JDEX = '1d12';
          cond.JDEXSUP = '2d12kh1';
          cond.JDEXSUPHERO = '{2d12kh1, 0d12+10}kh1';
          cond.JDEXRISQUE = '2d12kl1';
          cond.ETATDE = '20';
        } else {
          cond.CONDITION = '';
          cond.JDEX = '1d@{ETATDE}';
          cond.JDEXSUP = '2d@{ETATDE}kh1';
          cond.JDEXSUPHERO = '{2d@{ETATDE}kh1, 0d20+10}kh1';
          cond.JDEXRISQUE = '1d12';
          cond.ETATDE = '20';
        }
        if (cond !== null) setAttrs(cond);
      }
    });
  });
  
  on('clicked:reset', function() {
    for (let v=1; v <= 9; v++) {
      setRank(v.toString());
    }
    buildCaracs();
    encumbrance();
  });
  
  on('change:mods_atk', function() {
    let infomsg = 'Syntaxe non reconnue, corrigez SVP...';
    setAttrs({ INFOMSG: infomsg });
    getAttrs(['mods_atk', 'CARACS'], function(values) {
      const aliases = {
        'attaque': 'att',
        'attaques': 'att',
        'cac': 'atc',
        'contact': 'atc',
        'cad': 'atd',
        'distance': 'atd',
        'magie': 'mag',
        'mental': 'men',
        'mentale': 'men',
        'tir': 'atd'
      };
      const modifiers = {
        atc: '',
        atcdm: '',
        atd: '',
        atddm: '',
        mag: '',
        magdm: '',
        men: '',
        mendm: ''
      };
      let result = ' ';
      if (values.mods_atk !== '') {
        let caracs = JSON.parse(values.CARACS);
        let mods = values.mods_atk.replace('\n', ';').split(';');
        for (let mod of mods) {
          if (mod.trim() === '') continue;
          let modv = mod.trim().split(' ');
          let mod_attr = modv.shift().toLowerCase();
          let to_dm = false;
          if (mod_attr === 'dm') {
            to_dm = true;
            mod_attr = modv.shift().toLowerCase();
            if (Object.keys(aliases).includes(mod_attr)) {
              if (aliases[mod_attr] === 'att') mod_attr = 'dm';
              if (aliases[mod_attr] === 'atc') mod_attr = 'atcdm';
              if (aliases[mod_attr] === 'atd') mod_attr = 'atddm';
              if (aliases[mod_attr] === 'mag') mod_attr = 'magdm';
              if (aliases[mod_attr] === 'men') mod_attr = 'mendm';
            } else {
              if (mod_attr === 'att') mod_attr = 'dm';
              if (mod_attr === 'atc') mod_attr = 'atcdm';
              if (mod_attr === 'atd') mod_attr = 'atddm';
              if (mod_attr === 'mag') mod_attr = 'magdm';
              if (mod_attr === 'men') mod_attr = 'mendm';
            }
          }
          let mod_sgn = '+';
          let mod_val = modv.shift();
          if (mod_val.startsWith('+') || mod_val.startsWith('-')) {
            mod_sgn = mod_val.substring(0,1);
            mod_val = mod_val.substring(1);
          }
          if (to_dm && mod_val.search(/\d+[dD]\d+/) !== -1) {
            mod_val = `[[${mod_val}]]`;
          } else {
            mod_val = buffValue(mod_val, caracs);
            if (mod_val === 0) continue;
          }
          let mod_desc = ` ${mod_sgn}${mod_val}[${modv.join(' ').trim()}]`;
          switch (mod_attr) {
            case 'atc':
            case 'atcdm':
            case 'atd':
            case 'atddm':
            case 'mag':
            case 'magdm':
            case 'men':
            case 'mendm':
              modifiers[mod_attr] += mod_desc;
              break;
            case 'att':
              for (let attr of ['atc', 'atd', 'mag', 'men']) {
                modifiers[attr] += mod_desc;
              }
              break;
            case 'dm':
              for (let attr of ['atcdm', 'atddm', 'magdm', 'mendm']) {
                modifiers[attr] += mod_desc;
              }
              break;
            default:
              if (Object.keys(aliases).includes(mod_attr)) {
                modifiers[aliases[mod_attr]] += mod_desc;
                result = ' ';
              } else {
                result = infomsg;
              }
              break;
          }
        }
      }
      getSectionIDs('repeating_armes', function(ids) {
        for (const id of ids) {
          getAttrs([`repeating_armes_${id}_armeatk`, `repeating_armes_${id}_armeportee`], function(values) {
            let type = values[Object.keys(values)[0]] || '';
            let portee = values[Object.keys(values)[1]] || '';
            let attr = {};
            if (type === '@{ATKCAC}' || (type === '@{ATKTIR}' && portee === '')) {
              attr[`repeating_armes_${id}_armebuff`] = modifiers.atc.trim();
              attr[`repeating_armes_${id}_armebuffdm`] = modifiers.atcdm.trim();
            } else if (type === '@{ATKTIR}') {
              attr[`repeating_armes_${id}_armebuff`] = modifiers.atd.trim();
              attr[`repeating_armes_${id}_armebuffdm`] = modifiers.atddm.trim();
            } else if (type === '@{ATKMAG}') {
              attr[`repeating_armes_${id}_armebuff`] = modifiers.mag.trim();
              attr[`repeating_armes_${id}_armebuffdm`] = modifiers.magdm.trim();
            } else if (type === '@{ATKMEN}') {
              attr[`repeating_armes_${id}_armebuff`] = modifiers.men.trim();
              attr[`repeating_armes_${id}_armebuffdm`] = modifiers.mendm.trim();
            }
            if (attr !== null) setAttrs(attr);
          });
        }
      });
      consoleLog(`[${result}]`);
      setAttrs({ INFOMSG: result });
    });
  });

  const conditions = {
    'aveugle': 'A',
    'effraye': 'F',
    'etourdi': 'E',
    'immobilise': 'I',
    'panique': 'P',
    'ralenti': 'L',
    'renverse': 'R',
    'surpris': 'S'
  }

  const conditions_data = {
    '': {
      'atc': 0,
      'atd': 0,
      'def': 0,
      'init': 0,
      'title': ''
    },
    'A': {
      'atc': 5,
      'atd': 10,
      'def': 5,
      'init': 5,
      'title': 'Aveuglé'
    },
    'E': {
      'atc': 0,
      'atd': 0,
      'def': 5,
      'init': 0,
      'title': 'Etourdi'
    },
    'F': {
      'atc': 5,
      'atd': 5,
      'def': 0,
      'init': 0,
      'title': 'Effrayé'
    },
    'I': {
      'atc': 0,
      'atd': 0,
      'def': 0,
      'init': 0,
      'title': 'Immobilisé'
    },
    'P': {
      'atc': 0,
      'atd': 0,
      'def': 2,
      'init': 0,
      'title': 'Paniqué'
    },
    'L': {
      'atc': 0,
      'atd': 0,
      'def': 0,
      'init': 0,
      'title': 'Ralenti'
    },
    'R': {
      'atc': 5,
      'atd': 5,
      'def': 5,
      'init': 0,
      'title': 'Renversé'
    },
    'S': {
      'atc': 0,
      'atd': 0,
      'def': 5,
      'init': 0,
      'title': 'Surpris'
    }
  }
  
  function applyConditions(buffs, conditionAttr, s) {
    if (conditionAttr === '') return;
    for (let cond of conditionAttr) {
      buffs.atc += s * conditions_data[cond].atc;
      buffs.atd += s * conditions_data[cond].atd;
      buffs.def += s * conditions_data[cond].def;
      buffs.init += s * conditions_data[cond].init;
    }
  }
  
  function clickedConditions() {
    let clickedConditions = '';
    for (let condition of Object.keys(conditions)) {
      clickedConditions += `clicked:cond_${condition} `;
    }
    return clickedConditions;
  }
  
  on(clickedConditions(), function(eventInfo) {
    var clickedCondition = conditions[eventInfo.triggerName.replace('clicked:cond_','')];
    getAttrs(['PCONDITION', 'CONDITION', 'ATKCAC_BUFF', 'ATKTIR_BUFF', 'INIT_BUFF', 'DEF_BUFF', 'ETATDE'], function(values) {
      let buffs = {
        'atc': parseInt(values.ATKCAC_BUFF) || 0,
        'atd': parseInt(values.ATKTIR_BUFF) || 0,
        'def': parseInt(values.DEF_BUFF) || 0,
        'init': parseInt(values.INIT_BUFF) || 0
      };
      // debuffs prior condition
      let pcondition = values.PCONDITION || '';
      applyConditions(buffs, pcondition, +1);
      // change condition
      let condition = values.CONDITION || '';
      if (condition.includes(clickedCondition)) {
        condition = condition.replace(clickedCondition,'');
      } else {
        condition += clickedCondition;
      }
      // buff new condition
      applyConditions(buffs, condition, -1);
      // check prior condition for die roll
      let etatde = values.ETATDE;
      if (pcondition !== '' && (pcondition.includes(conditions.immobilise) || pcondition.includes(conditions.panique))) etatde = '20';
      // check condition for die roll
      if (condition !== '' && (condition.includes(conditions.immobilise) || condition.includes(conditions.panique))) etatde = '12';
      //
      let displayConditions = '';
      if (condition !== '') {
        for (cond of Object.keys(conditions)) {
          if (condition.includes(conditions[cond])) {
            displayConditions += (displayConditions === '' ? '' : ', ') + conditions_data[conditions[cond]].title;
          }
        }
      }
      if (displayConditions === '') displayConditions = ' ';
      setAttrs({
        ATKCAC_BUFF: buffs.atc,
        ATKTIR_BUFF: buffs.atd,
        DEF_BUFF: buffs.def,
        INIT_BUFF: buffs.init,
        ETATDE: etatde,
        CONDITION: condition,
        PCONDITION: condition,
        conditions: displayConditions
      });
    });
  });
  
  function hitPoints(attr) {
    getAttrs(['NIVEAU', 'DV', 'CONSTITUTION', 'PV_NIVEAU', 'PV_BUFF', 'prog_pv'], function(values) {
      let niveau = parseInt(values.NIVEAU) || 0;
      if (niveau === 0) return;
      let dv = parseInt(values.DV) || 0;
      if (dv === 0) return;
      let constitution = parseInt(values.CONSTITUTION) || 0;
      let modcon = 0;
      if (constitution > 0) modcon = Math.floor((constitution - 10) / 2);
      let pv_niveau = values.PV_NIVEAU || '';
      let pv = [];
      if (attr === 'niveau' || attr === 'constitution' || attr === 'pv_buff') {
        if (pv_niveau !== '') pv = JSON.parse(pv_niveau);
      }
      let average = (parseInt(values.prog_pv) || 0 === 1) ? 1 + (dv / 2) : 0;
      let pv_buff = parseInt(values.PV_BUFF) || 0;
      let pv_max = 0;
      for (let n = 1; n <= niveau; n++) {
        let pvie = 0;
        if (n === 1) {
          pvie = dv + modcon; // niveau 1 : Max. DV + Mod. CON
        } else {
          if (n > 10) { // niveaux > 10 : 1 ou 2 PV selon DV
            if (dv >= 10) pvie = 2;
            else pvie = 1;
          } else { // niveaux <= 10
            if (n % 2 === 0) { // niveau pair
              if (n > pv.length) { // nouveau niveau
                if (average !== 0) {
                  pvie = average; // ... soit moyenne du DV + 1
                } else {
                  pvie = getRandom(dv); // ... soit tirage de DV
                }
                if (modcon < 0) pvie += modcon; // ... + Mod. CON si négative
                if (pvie < 0) pvie = 0; // ... mais on ne perd pas de PV
              } else { // niveau existant
                pvie = pv[n - 1];
              }
            } else { // niveau impair
              if (modcon > 0) pvie = modcon; // Mod. CON si positif
            }
          }
        }
        if (n > pv.length) pv.push(pvie);
        else pv[n - 1] = pvie;
        pv_max += pvie;
      }
      pv_max += pv_buff;
      setAttrs({
        PV_NIVEAU: JSON.stringify(pv),
        PV_max: pv_max,
        PV: pv_max
      });
    });
  }
  
  on('change:niveau change:dv change:constitution change:pv_buff change:prog_pv', function(eventInfo) {
    hitPoints(eventInfo.sourceAttribute);
  });
  
  on('clicked:dv', function() {
    getAttrs(['NIVEAU'], function(value) {
      let niveau = parseInt(value.NIVEAU) || 0;
      if (niveau > 0 && niveau <= 20) {
        setAttrs({
          NIVEAU: niveau + 1
        });
      }
    });
  });

</script>
<!-- FIN SCRIPTS / SHEET WORKERS -->
