<div class="sheet-mainBg">
  <!-- FDP -->
  <!-- INPUT HIDDEN Version FdP -->
  <input type="hidden" name="attr_VERFDP" value="3.19.0" />
  <input type="hidden" name="attr_VERSION" value="3.19.0" />
  <!-- INPUT HIDDEN Univers (COF, CG, COC) -->
  <input type="hidden" name="attr_UNIVERS" value="COC" />
  <input type="hidden" name="attr_coc_setting_bitume" value="0" />
  <input type="hidden" name="attr_coc_setting_shadowrun" value="0" />
  <input type="hidden" name="attr_token_url" value="" />
  <input type="hidden" name="attr_token_dsp" value="" />
  <!-- INPUT HIDDEN Libellés -->
  <input type="hidden" name="attr_lib_profil" value="Profil" />
  <input type="hidden" name="attr_lib_famille" value="Famille" />
  <input type="hidden" name="attr_lib_origine" value="Origine" />
  <!-- INPUT HIDDEN Type de jet -->
  <input type="hidden" name="attr_JETNORMAL" value="1d@{ETATDE}" />
  <input type="hidden" name="attr_JETSUP" value="2d@{ETATDE}kh1" />
  <input type="hidden" name="attr_JETSUPHERO" value="{2d@{ETATDE}kh1, 0d20+10}kh1" />
  <input type="hidden" name="attr_JETRISQUE" value="1d12" />
  <input type="hidden" name="attr_JETINF" value="2d@{ETATDE}kl1" />
  <input type="hidden" name="attr_JDEX" value="1d@{ETATDE}" />
  <input type="hidden" name="attr_JDEXSUP" value="2d@{ETATDE}kh1" />
  <input type="hidden" name="attr_JDEXSUPHERO" value="{2d@{ETATDE}kh1, 0d20+10}kh1" />
  <input type="hidden" name="attr_JDEXRISQUE" value="1d12" />
  <!-- INPUT HIDDEN Buffs -->
  <input type="hidden" name="attr_FOR_BUFF" value="0" />
  <input type="hidden" name="attr_DEX_BUFF" value="0" />
  <input type="hidden" name="attr_CON_BUFF" value="0" />
  <input type="hidden" name="attr_INT_BUFF" value="0" />
  <input type="hidden" name="attr_PER_BUFF" value="0" />
  <input type="hidden" name="attr_CHA_BUFF" value="0" />
  <input type="hidden" name="attr_ATKCAC_BUFF" value="0" />
  <input type="hidden" name="attr_ATKTIR_BUFF" value="0" />
  <input type="hidden" name="attr_ATKMEN_BUFF" value="0" />
  <input type="hidden" name="attr_ATKPIL_BUFF" value="0" />
  <input type="hidden" name="attr_ATKMAG_BUFF" value="0" />
  <input type="hidden" name="attr_PSYINFLU_BUFF" value="0" />
  <input type="hidden" name="attr_PSYINTUI_BUFF" value="0" />
  <input type="hidden" name="attr_INIT_BUFF" value="0" />
  <input type="hidden" name="attr_DEF_BUFF" value="0" />
  <input type="hidden" name="attr_DEP_BUFF" value="0" />
  <input type="hidden" name="attr_PV_BUFF" value="0" />
  <!-- INPUT HIDDEN Précédent état préjudiciable -->
  <input type="hidden" name="attr_CONDITION" value="" />
  <input type="hidden" name="attr_PCONDITION" value="" />
  <!-- INPUT HIDDEN Précédent nombre de PV -->
  <input type="hidden" name="attr_LAST_PV" value="" />
  <!-- INPUT HIDDEN PV par niveau -->
  <input type="hidden" name="attr_PV_NIVEAU" value="" />
  <!-- INPUT HIDDEN Choix carac jets capacités -->
  <input type="hidden" name="attr_QRYMOD"
    value="?{Carac. ?|Force,@{FOR}|Dextérité,@{DEX}|Constitution,@{CON}|Intelligence,@{INT}|Perception,@{PER}|Charisme,@{CHA}}" />
  <input type="hidden" name="attr_QRYMODT"
    value="?{Carac. ?|Force,@{FOR_TEST}|Dextérité,@{DEX_TEST}|Constitution,@{CON_TEST}|Intelligence,@{INT_TEST}|Perception,@{PER_TEST}|Charisme,@{CHA_TEST}}" />
  <!-- INPUT HIDDEN Rangs Voies -->
  <input type="hidden" name="attr_RANG_VOIE1" value="0" />
  <input type="hidden" name="attr_RANG_VOIE2" value="0" />
  <input type="hidden" name="attr_RANG_VOIE3" value="0" />
  <input type="hidden" name="attr_RANG_VOIE4" value="0" />
  <input type="hidden" name="attr_RANG_VOIE5" value="0" />
  <input type="hidden" name="attr_RANG_VOIE6" value="0" />
  <input type="hidden" name="attr_RANG_VOIE7" value="0" />
  <input type="hidden" name="attr_RANG_VOIE8" value="0" />
  <input type="hidden" name="attr_RANG_VOIE9" value="0" />
  <!-- INPUT HIDDEN Caractéristiques -->
  <input type="hidden" name="attr_CARACS" value="" />
  <!-- INPUT HIDDEN PC -->
  <input type="hidden" name="attr_PC_DESC_SNGL" value="Point de Chance" />
  <input type="hidden" name="attr_PC_DESC_PLUR" value="Points de Chance" />
  <input type="hidden" name="attr_PC_DESC_ABRV" value="PC" />
  <!-- INPUT HIDDEN cptN -->
  <input type="hidden" name="attr_cpt1_desc_sngl" value="" />
  <input type="hidden" name="attr_cpt1_desc_plur" value="" />
  <input type="hidden" name="attr_cpt1_desc_abrv" value="" />
  <input type="hidden" name="attr_cpt2_desc_sngl" value="" />
  <input type="hidden" name="attr_cpt2_desc_plur" value="" />
  <input type="hidden" name="attr_cpt2_desc_abrv" value="" />
  <input type="hidden" name="attr_cpt3_desc_sngl" value="" />
  <input type="hidden" name="attr_cpt3_desc_plur" value="" />
  <input type="hidden" name="attr_cpt3_desc_abrv" value="" />
  <!-- INPUT HIDDEN PM -->
  <input type="hidden" name="attr_pm_desc" value="Magie" />
  <input type="hidden" name="attr_pm_abrv" value="PM" />
  <!-- INPUT HIDDEN Liste des equipements avec dé d'usure -->
  <input type="hidden" name="attr_QRYUD" value="" />
  <!-- Fin INPUT HIDDEN -->
  <div class="sheet-container">
    <!-- Identité -->
    <input type="checkbox" class="sheet-block-switch" style="display: none;" name="attr_coc_setting_bitume" value="1">
    <div class="sheet-block-hidden">
      <div style="vertical-align: middle; text-align: center;">
        <img style="width:70%; height:90%" title="Version 3.19.0 - 24/08/2024"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_logo.png" />
        <img width="90px" height="90px" name="attr_character_token" />
      </div>
    </div>
    <div class="sheet-block-show">
      <div style="vertical-align: middle; text-align: center;">
        <img style="width:70%; height:90%" title="Version 3.19.0 - 24/08/2024"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_bitume.jpg" />
        <img width="90px" height="90px" name="attr_character_token" />
      </div>
    </div>
    <div style="width:270px;">
      <table>
        <tr>
          <td class="sheet-textfatleft">Nom</td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_character_name" title="@{character_name}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft"><span name="attr_lib_profil"></span></td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_PROFIL" title="@{PROFIL}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft"><span name="attr_lib_famille"></span></td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_FAMILLE" title="@{FAMILLE}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft"><span name="attr_lib_origine"></span></td>
          <td colspan="3">
            <input class="sheet-nobox" name="attr_origine" title="@{origine}" type="text" />
          </td>
        </tr>
        <tr>
          <td class="sheet-textfatleft">Niveau</td>
          <td style="text-align:left;">
            <input class="sheet-nobox" name="attr_NIVEAU" title="@{NIVEAU}" type="number" value="1" min="0" />
          </td>
          <td class="sheet-textfatleft">Type</td>
          <td class="sheet-boxinput">
            <select class="sheet-pjstatus" name="attr_type_personnage" size="1" title="@{type_personnage}">
              <option value="pj" selected>PJ</option>
              <option value="pnj">PNJ</option>
              <option value="vehicule">Véhicule</option>
            </select>
          </td>
        </tr>
      </table>
    </div>
    <div style="width:130px; margin-left: 5px;">
      <input type="checkbox" class="sheet-optional-block-switch" name="attr_physical_traits" value="1" ><span></span>
      <div class="sheet-optional-block">
        <table>
          <tr>
            <td class="sheet-textfatleft">Sexe</td>
            <td>
              <input class="sheet-nobox" name="attr_SEXE" title="@{SEXE}" type="text" />
            </td>
          </tr>
          <tr>
            <td class="sheet-textfatleft">Âge</td>
            <td>
              <input class="sheet-nobox" name="attr_AGE" title="@{AGE}" type="text" />
            </td>
          </tr>
          <tr>
            <td class="sheet-textfatleft">Taille</td>
            <td>
              <input class="sheet-nobox" name="attr_TAILLE" title="@{TAILLE}" type="text" />
            </td>
          </tr>
          <tr>
            <td class="sheet-textfatleft">Poids</td>
            <td>
              <input class="sheet-nobox" name="attr_POIDS" title="@{POIDS}" type="text" />
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  <!-- FIN Identité -->
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp1" value="pj" checked="checked"><span
    title="Personnage"></span>
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp2" value="vehicule"><span
    title="Véhicule"></span>
  <input type="radio" name="attr_type_fiche" class="sheet-hidden-tab sheet-fp3" value="pnj"><span title="PNJ"></span>
  <div class="sheet-tab-content sheet-fp1">
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab1" value="caracs" checked="checked"><span
      title="Caractéristiques"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab2" value="voies"><span title="Capacités"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab3" value="equip"><span title="Équipement"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab4" value="config"><span title="Configuration"></span>
    <input type="radio" name="attr_tab" class="sheet-tab sheet-tab5" value="version"><span title="Version"></span>
    <img class="sheet-imghr-up"
      src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    <div class="sheet-tab-content sheet-tab1">
      <div>
        <!-- Caracs + combat + PV + défense -->
        <table>
          <tr>
            <td style="width:250px;">
              <!-- Caracs -->
              <table class="sheet-tabsep">
                <tr>
                  <td class="sheet-textfat">CARAC.</td>
                  <td></td>
                  <td class="sheet-textbase">Valeur</td>
                  <td class="sheet-textfat">Mod.</td>
                  <td class="sheet-textbase">Bonus</td>
                  <td class="sheet-textfat">Test</td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_for" 
                      title="%{jet_for} Jet de Force"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Force}} {{subtags=Test}} {{carac=[[@{FOR_SUP}[Dé] + [[@{FOR_TEST}]][Bonus] ]] }}"
                      >
                      FOR
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_FOR_SUP"
                      title="@{FOR_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_FORCE" title="@{FORCE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR" title="@{FOR}" value="floor((@{FORCE}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR_BONUS" value="@{FOR_BUFF}" title="@{FOR_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_FOR_TEST" title="@{FOR_TEST}" value="@{FOR}+@{FOR_BONUS}"
                      disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_dex" 
                      title="%{jet_dex} Jet de Dextérité"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Dextérité}} {{subtags=Test}} {{carac=[[@{DEX_SUP}[Dé] + [[@{DEX_TEST}]][Bonus] ]]}}"
                      >
                      DEX
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_DEX_SUP"
                      title="@{DEX_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JDEX}" selected>N Normale</option>
                      <option value="@{JDEXSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JDEXSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_DEXTERITE" title="@{DEXTERITE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX" title="@{DEX}" value="floor((@{DEXTERITE}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX_BONUS" value="@{DEX_BUFF}" title="@{DEX_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_DEX_TEST" title="@{DEX_TEST}"
                      value="@{DEX}+@{DEX_BONUS}-(@{DEFARMUREON}*@{DEFARMUREMALUS})" disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_con"
                      title="%{jet_con} Jet de Constitution"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Constitution}} {{subtags=Test}} {{carac=[[@{CON_SUP}[Dé] + [[@{CON_TEST}]][Bonus] ]]}}"
                      >
                      CON
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_CON_SUP"
                      title="@{CON_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_CONSTITUTION" title="@{CONSTITUTION}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON" title="@{CON}" value="floor((@{CONSTITUTION}-10)/2)"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON_BONUS" value="@{CON_BUFF}" title="@{CON_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CON_TEST" title="@{CON_TEST}" value="@{CON}+@{CON_BONUS}"
                      disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_int" 
                      title="%{jet_int} Jet d'Intelligence"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Intelligence}} {{subtags=Test}} {{carac=[[@{INT_SUP}[Dé] + [[@{INT_TEST}]][Bonus] ]]}}"
                      >
                      INT
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_INT_SUP"
                      title="@{INT_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_INTELLIGENCE" title="@{INTELLIGENCE}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT" title="@{INT}" value="floor((@{INTELLIGENCE}-10)/2)"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT_BONUS" value="@{INT_BUFF}" title="@{INT_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_INT_TEST" title="@{INT_TEST}" value="@{INT}+@{INT_BONUS}"
                      disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_per" 
                      title="%{jet_per} Jet de Perception"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Perception}} {{subtags=Test}} {{carac=[[@{PER_SUP}[Dé] + [[@{PER_TEST}]][Bonus] ]]}}"
                      >
                      PER
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_PER_SUP"
                      title="@{PER_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_PERCEPTION" title="@{PERCEPTION}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER" title="@{PER}" value="floor((@{PERCEPTION}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER_BONUS" value="@{PER_BUFF}" title="@{PER_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_PER_TEST" title="@{PER_TEST}" value="@{PER}+@{PER_BONUS}"
                      disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button 
                      class="sheet-boxtitre" 
                      type="roll" 
                      name="roll_jet_cha" 
                      title="%{jet_cha} Jet de Charisme"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Charisme}} {{subtags=Test}} {{carac=[[@{CHA_SUP}[Dé] + [[@{CHA_TEST}]][Bonus] ]]}}"
                      >
                      CHA
                    </button>
                  </td>
                  <td class="sheet-boxinputlight">
                    <select class="sheet-selectmin" name="attr_CHA_SUP"
                      title="@{CHA_SUP} Caractéristique Normale ou Supérieure/Héroïque (règle p.138)">
                      <option value="@{JETNORMAL}" selected>N Normale</option>
                      <option value="@{JETSUP}">S Supérieure OU Héroïque</option>
                      <option value="@{JETSUPHERO}">H Supérieure ET Héroïque</option>
                    </select>
                  </td>
                  <td class="sheet-boxinput">
                    <input type="number" name="attr_CHARISME" title="@{CHARISME}" value="10" min="0" />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA" title="@{CHA}" value="floor((@{CHARISME}-10)/2)" disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA_BONUS" value="@{CHA_BUFF}" title="@{CHA_BONUS} Bonus au Test"
                      disabled />
                  </td>
                  <td class="sheet-boxinputlight">
                    <input type="number" name="attr_CHA_TEST" title="@{CHA_TEST}" value="@{CHA}+@{CHA_BONUS}"
                      disabled />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-textfat" colspan="6">ÉTATS PRÉJUDICIABLES</td>
                </tr>
                <tr>
                  <td class="sheet-boxinputlight" colspan="6">
                    &nbsp;
                    <input type="radio" name="attr_ETATDE" value="20" title="@{ETATDE} Jet d'un d20 pour tous les tests"
                      checked>&nbsp;Normal</input>
                    &nbsp;
                    <input type="radio" name="attr_ETATDE" value="12"
                      title="@{ETATDE} Jet d'un d12 pour tous les tests">&nbsp;Affaibli</input>
                    &nbsp;
                    <input type="checkbox" name="attr_POISSE"
                      title="@{POISSE} Moins bon de deux d20 pour tous les tests" value="1" />&nbsp;Poisse
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxinputlight" colspan="6">
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_aveugle" title="Aveuglé">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_aveugle.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_effraye" title="Effrayé">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_effraye.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_etourdi" title="Etourdi">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_etourdi.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_immobilise"
                      title="Immobilisé">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_immobilise.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_panique" title="Paniqué">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_panique.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_ralenti" title="Ralenti">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_ralenti.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_renverse" title="Renversé">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_renverse.png" />
                    </button>
                    <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_surpris" title="Surpris">
                      <img class="sheet-iconimg"
                        src="https://raw.githubusercontent.com/stephaned68/ChroniquesContemporaines/master/cond_surpris.png" />
                    </button>
                    <br />
                    <span name="attr_conditions" value=""></span>
                  </td>
                </tr>
              </table>
              <div>
                <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_cpt1" value="1"><span></span>
                <div class="sheet-optional-block">
                  <table class="sheet-tabsep">
                    <tr>
                      <td class="sheet-boxtitre" style="width: 65px;">
                        <span name="attr_cpt1_desc_abrv"></span>
                      </td>
                      <td class="sheet-boxinput">
                        <input type="number" name="attr_cpt1" value="0" title="@{cpt1} Autre compteur" />
                        <span name="attr_cpt1_desc_plur"></span>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
              <div>
                <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_cpt2" value="1"><span></span>
                <div class="sheet-optional-block">
                  <table class="sheet-tabsep">
                    <tr>
                      <td class="sheet-boxtitre" style="width: 65px;">
                        <span name="attr_cpt2_desc_abrv"></span>
                      </td>
                      <td class="sheet-boxinput">
                        <input type="number" name="attr_cpt2" value="0" title="@{cpt2} Autre compteur" />
                        <span name="attr_cpt2_desc_plur"></span>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
              <div>
                <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_cpt3" value="1"><span></span>
                <div class="sheet-optional-block">
                  <table class="sheet-tabsep">
                    <tr>
                      <td class="sheet-boxtitre" style="width: 65px;">
                        <span name="attr_cpt3_desc_abrv"></span>
                      </td>
                      <td class="sheet-boxinput">
                        <input type="number" name="attr_cpt3" value="0" title="@{cpt3} Autre compteur" />
                        <span name="attr_cpt3_desc_plur"></span>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </td>
            <!-- FIN Caracs -->
            <td style="width:100%;">
              <!-- Combat + PV + défense -->
              <table>
                <tr>
                  <td>
                    <!-- Combat -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat">COMBAT</td>
                        <td class="sheet-textbase">Base</td>
                        <td class="sheet-textbase">Mod.</td>
                        <td class="sheet-textbase">Div.</td>
                        <td class="sheet-textfat">Total</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre" style="width: 116px;">
                          <button 
                            class="sheet-boxtitre" 
                            type="roll" 
                            name="roll_jet_init" 
                            title="%{jet_init} Initiative"
                            value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Initiative}} {{subtags=Combat}} {{carac=[[@{INIT_JET} &{tracker}]]}}"
                            >
                            INITIATIVE
                          </button>
                        </td>
                        <td class="sheet-boxtitre">
                          <button 
                            class="sheet-boxtitre" 
                            type="roll" 
                            name="roll_next_init"
                            title="%{next_init} Actions multiples si jet d'Init > 20, 30, etc..."
                            value="@{togm}&{template:co1} @{token_dsp} {{perso=@{selected|character_name}}} {{subtags=Initiative}} {{name=Action suivante}} {{desc=(A)ction / (M)ouvement à Init-[[10 &{tracker:-}]]}}"
                            >
                            Suite
                          </button>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_INIT_CARAC" title="@{INIT_CARAC}" value="@{DEXTERITE}"
                            disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_INIT_DIV" title="@{INIT_DIV} Bonus divers"
                            value="@{INIT_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight" style="width: 48px;">
                          <input type="number" name="attr_INIT" value="0" hidden />
                          <span name="attr_INIT" title="@{INIT}"></span>
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre" style="width: 116px;">
                          <button 
                            class="sheet-boxtitre" 
                            type="roll" 
                            name="roll_jet_cac"
                            title="%{jet_cac} Jet d'attaque au contact"
                            value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Au Contact}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKCAC}]][Bonus] ]]}}"
                            >
                            AU CONTACT
                          </button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKCAC_BASE" value="0" title="@{ATKCAC_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKCAC_CARAC" title="@{ATKCAC_CARAC}" size="1">
                            <option value="@{FOR}" selected>FOR</option>
                            <option value="@{DEX}">DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}">INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}">CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKCAC_DIV" title="@{ATKCAC_DIV} Bonus divers"
                            value="@{ATKCAC_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKCAC" title="@{ATKCAC}"
                            value="@{ATKCAC_BASE}+@{ATKCAC_CARAC}+@{ATKCAC_DIV}" disabled />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre" style="width: 116px;" style="width: 116px;">
                          <button 
                            class="sheet-boxtitre" 
                            type="roll" 
                            name="roll_jet_tir"
                            title="%{jet_tir} Jet d'attaque à distance"
                            value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=&Agrave; Distance}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKTIR}]][Bonus] ]]}}"
                            >
                            &Agrave; DISTANCE
                          </button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_ATKTIR_BASE" value="0" title="@{ATKTIR_BASE} Score de base" />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_ATKTIR_CARAC" title="@{ATKTIR_CARAC}" size="1">
                            <option value="@{FOR}">FOR</option>
                            <option value="@{DEX}" selected>DEX</option>
                            <option value="@{CON}">CON</option>
                            <option value="@{INT}">INT</option>
                            <option value="@{PER}">PER</option>
                            <option value="@{CHA}">CHA</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKTIR_DIV" title="@{ATKTIR_DIV} Bonus divers"
                            value="@{ATKTIR_BUFF}" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_ATKTIR" title="@{ATKTIR}"
                            value="@{ATKTIR_BASE}+@{ATKTIR_CARAC}+@{ATKTIR_DIV}" disabled />
                        </td>
                      </tr>
                    </table>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_atkmen" value="1"><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 116px;">
                              <button 
                                class="sheet-boxtitre" 
                                type="roll" 
                                name="roll_jet_men"
                                title="%{jet_men} Jet d'attaque mentale"
                                value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Mental}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKMEN}]][Bonus] ]]}}"
                                >
                                MENTAL
                              </button>
                            </td>
                            <td class="sheet-boxinput" style="width: 67px;">
                              <input type="number" name="attr_ATKMEN_BASE" value="0"
                                title="@{ATKMEN_BASE} Score de base" />
                            </td>
                            <td class="sheet-boxinput">
                              <select class="sheet-carac" name="attr_ATKMEN_CARAC" title="@{ATKMEN_CARAC}" size="1">
                                <option value="@{FOR}">FOR</option>
                                <option value="@{DEX}">DEX</option>
                                <option value="@{CON}">CON</option>
                                <option value="@{INT}" selected>INT</option>
                                <option value="@{PER}">PER</option>
                                <option value="@{CHA}">CHA</option>
                              </select>
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKMEN_DIV" title="@{ATKMEN_DIV} Bonus divers"
                                value="@{ATKMEN_BUFF}" disabled />
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKMEN" title="@{ATKMEN}"
                                value="@{ATKMEN_BASE}+@{ATKMEN_CARAC}+@{ATKMEN_DIV}" disabled />
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_atkpsi" value="1"><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 116px;">
                              <button 
                                class="sheet-boxtitre" 
                                type="roll" 
                                name="roll_jet_psi"
                                title="%{jet_psi} Jet d'attaque PSI"
                                value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=PSI}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKPSI}]][Bonus] ]]}}"
                                >
                                PSI
                              </button>
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_ATKPSI_BASE" value="0" title="@{ATKPSI_BASE}" />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_ATKPSI_CARAC" value="@{INT}"
                                title="@{ATKPSI_CARAC} Mod. d'INT" disabled />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_ATKPSI_DIV" value="0" title="@{ATKPSI_DIV}" />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_ATKPSI"
                                value="@{ATKPSI_BASE}+@{ATKPSI_CARAC}+@{ATKPSI_DIV}" title="@{ATKPSI}" disabled />
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_atkpil" value="1"><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 116px;">
                              <button 
                                class="sheet-boxtitre" 
                                type="roll" 
                                name="roll_jet_pil"
                                title="%{jet_pil} Jet de PILotage"
                                value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Pilotage}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKPIL}]][Bonus] ]]}}"
                                >
                                PILOTAGE
                              </button>
                            </td>
                            <td class="sheet-boxinput" style="width: 67px;">
                              <input type="number" name="attr_ATKPIL_BASE" value="0"
                                title="@{ATKPIL_BASE} Score de base" />
                            </td>
                            <td class="sheet-boxinput">
                              <select class="sheet-carac" name="attr_ATKPIL_CARAC" title="@{ATKPIL_CARAC}" size="1">
                                <option value="@{FOR}">FOR</option>
                                <option value="@{DEX}">DEX</option>
                                <option value="@{CON}">CON</option>
                                <option value="@{INT}">INT</option>
                                <option value="@{PER}" selected>PER</option>
                                <option value="@{CHA}">CHA</option>
                              </select>
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKPIL_DIV" title="@{ATKPIL_DIV} Bonus divers"
                                value="@{ATKPIL_BUFF}" disabled />
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKPIL" title="@{ATKPIL}"
                                value="@{ATKPIL_BASE}+@{ATKPIL_CARAC}+@{ATKPIL_DIV}" disabled />
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_atkmag" value="1" ><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 116px;">
                              <button 
                                class="sheet-boxtitre" 
                                type="roll" 
                                name="roll_jet_mag"
                                title="%{jet_mag} Jet d'attaque magique"
                                value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Magique}} {{subtags=Attaque}} {{attaque=[[@{JETNORMAL}cs20cf1[Dé] + [[@{ATKMAG}]][Bonus] ]]}}"
                                >
                                MAGIQUE
                              </button>
                            </td>
                            <td class="sheet-boxinput" style="width: 67px;">
                              <input type="number" name="attr_ATKMAG_BASE" value="0"
                                title="@{ATKMAG_BASE} Score de base" />
                            </td>
                            <td class="sheet-boxinput">
                              <select class="sheet-carac" name="attr_ATKMAG_CARAC" title="@{ATKMAG_CARAC}" size="1">
                                <option value="@{FOR}">FOR</option>
                                <option value="@{DEX}">DEX</option>
                                <option value="@{CON}">CON</option>
                                <option value="@{INT}">INT</option>
                                <option value="@{PER}">PER</option>
                                <option value="@{CHA}" selected>CHA</option>
                              </select>
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKMAG_DIV" title="@{ATKMAG_DIV} Bonus divers"
                                value="@{ATKMAG_BUFF}" disabled />
                            </td>
                            <td class="sheet-boxinputlight">
                              <input type="number" name="attr_ATKMAG" title="@{ATKMAG}"
                                value="@{ATKMAG_BASE}+@{ATKMAG_CARAC}+@{ATKMAG_DIV}" disabled />
                            </td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </td>
                  <!-- FIN Combat -->
                  <td>
                    <!-- PV -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat" colspan="2">VITALITÉ</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button
                            class="sheet-boxtitre"
                            type="roll"
                            name="roll_hitdie"
                            title="Lancement dé de vie"
                            value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Dé de Vie}} {{subtags=}} {{DV=[[ [[1d@{DV}]][DV] ]] + [[[[{[[@{CON}]], 0}kl1]][CON si négative] ]] }}"
                            >
                            DV
                          </button>
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" name="attr_DV" size="1" title="@{DV} Dé de Vie">
                            <option value="0" selected>-</option>
                            <option value="4">d4</option>
                            <option value="6">d6</option>
                            <option value="8">d8</option>
                            <option value="10">d10</option>
                            <option value="12">d12</option>
                          </select>
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre">
                          <button type="action" class="sheet-iconbtn sheet-flatbtn" name="act_hploss-btn">
                            <span class="sheet-iconbtn">e</span>
                          </button>
                          PV
                          <button type="action" class="sheet-iconbtn sheet-flatbtn" name="act_hpheal-btn">
                            <span class="sheet-iconbtn">k</span>
                          </button>
                        </td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_PV" title="@{PV} Points de Vie restants" value="0" />
                          &nbsp;/&nbsp;
                          <input type="number" name="attr_PV_max" title="@{PV|max} Points de Vie maximum" value="0" />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxinput" colspan="2">
                          <span class="sheet-textbase">DM temporaires</span>&nbsp;
                          <input type="number" name="attr_DMTEMP" title="@{DMTEMP} Dommages Temporaires" value="0" />
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-boxinput" colspan="2">
                          <input type="checkbox" name="attr_BLESSURE" title="@{BLESSURE}" value="1" />
                          <span class="sheet-textbase">Blessure Grave</span>&nbsp;
                          <input type="number" name="attr_SEUILBG" title="@{SEUILBG} Seuil de blessure grave"
                            value="0" />
                        </td>
                      </tr>
                    </table>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_pr" value="1" ><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 65px;">
                              <button 
                                type="roll" 
                                class="sheet-boxtitre" 
                                title="%{jet_pr} Jet de Récupération"
                                name="roll_jet_pr"
                                value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Récupération}} {{subtags=Vitalité}} {{DV=[[1d@{DV}[Dé de Vie] +[[@{CON}]][CON] +@{NIVEAU}[Niveau] ]]}}"
                                >
                                PR
                              </button>
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_PR" value="0"
                                title="@{PR} Points de Récupération courants" />
                              &nbsp;/&nbsp;
                              <input type="number" name="attr_PR_max" value="0"
                                title="@{PR|max} Points de Récupération MAX" />
                            </td>
                          </tr>
                        </table>
                      </div>
                      <div>
                        <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_pc" value="1"
                          checked><span></span>
                        <div class="sheet-optional-block">
                          <table class="sheet-tabsep">
                            <tr>
                              <td class="sheet-textfatleft" colspan="2"><span name="attr_PC_DESC_PLUR"></span></td>
                            </tr>
                            <tr>
                              <td class="sheet-boxtitre" style="width: 65px;">
                                <button 
                                  type="roll" 
                                  class="sheet-boxtitre" 
                                  title="%{jet_pc} Utilisation d'un PC"
                                  name="roll_jet_pc"
                                  value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=@{PC_DESC_PLUR}}} {{subtags=Bonus}} {{desc=@{character_name} utilise un @{PC_DESC_SNGL} et obtient un bonus de @{PC_BONUS}}}"
                                  >
                                  <span name="attr_PC_DESC_ABRV"></span>
                                </button>
                              </td>
                              <td class="sheet-boxinput">
                                <input type="number" name="attr_PC" value="0" title="@{PC} Points de Chance courants" />
                                &nbsp;/&nbsp;
                                <input type="number" name="attr_PC_max" value="0"
                                  title="@{PC|max} Points de Chance MAX" />
                              </td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div>
                        <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_pm" value="1"><span></span>
                        <div class="sheet-optional-block">
                          <table class="sheet-tabsep">
                            <tr>
                              <td class="sheet-textfatleft" colspan="2"><span name="attr_pm_desc"></span></td>
                            </tr>
                            <tr>
                              <td class="sheet-boxtitre" style="width: 65px;"><span name="attr_pm_abrv"></span></td>
                              <td class="sheet-boxinput">
                                <input type="number" name="attr_PM" value="0" title="@{PM} Points de Mana ou d'Energie PSI courants" />
                                &nbsp;/&nbsp;
                                <input type="number" name="attr_PM_max" value="0"
                                  title="@{PM|max} Points de Mana ou d'Energie PSI MAX" />
                              </td>
                            </tr>
                          </table>
                        </div>
                      </div>
                  </td>
                  <!-- FIN PV -->
                </tr>
                <tr>
                  <td colspan="2">
                    <!-- Défense -->
                    <table class="sheet-tabsep">
                      <tr>
                        <td class="sheet-textfat">DÉFENSE</td>
                        <td class="sheet-textbase">&nbsp;</td>
                        <td class="sheet-textbase">
                          Armure
                          <input type="checkbox" name="attr_DEFARMUREON" value="1" checked
                            title="@{DEFARMUREON} Armure portée" />
                        </td>
                        <td class="sheet-textbase">DEX</td>
                        <td class="sheet-textbase">Div.</td>
                        <td class="sheet-textbase">Action défensive</td>
                        <td class="sheet-textfat">Total</td>
                      </tr>
                      <tr>
                        <td class="sheet-boxtitre" style="width: 70px;">DEF</td>
                        <td class="sheet-boxinputlight">10+</td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_DEFARMURE" title="@{DEFARMURE} Armure" value="0" />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEFCAR" value="@{DEX}"
                            title="@{DEFCAR} Modificateur de Dextérité" disabled />
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEFDIV" title="@{DEFDIV} Bonus divers" value="@{DEF_BUFF}"
                            disabled />
                        </td>
                        <td class="sheet-boxinput">
                          <select class="sheet-carac" style="width: 80px" name="attr_DEFACT" size="1"
                            title="@{DEFACT} Actions défensives">
                            <option value="0" selected>-</option>
                            <option value="2">Simple</option>
                            <option value="4">Totale (L)</option>
                          </select>
                        </td>
                        <td class="sheet-boxinputlight">
                          <input type="number" name="attr_DEF" value="10" hidden />
                          <span name="attr_DEF" title="@{DEF} Défense"></span>
                        </td>
                      </tr>
                      <tr>
                        <td class="sheet-textfat" colspan="2" style="text-align: right;">Malus</td>
                        <td class="sheet-boxinput">
                          <input type="number" name="attr_DEFARMUREMALUS"
                            title="@{DEFARMUREMALUS} Malus aux Tests de DEX et à l'Init. quand l'armure est portée."
                            value="0" />
                        </td>
                        <td class="sheet-textbase" colspan="3">&nbsp;</td>
                      </tr>
                    </table>
                    <div>
                      <input type="checkbox" class="sheet-optional-block-switch" name="attr_option_defpsi"
                        value="1"><span></span>
                      <div class="sheet-optional-block">
                        <table class="sheet-tabsep">
                          <tr>
                            <td class="sheet-boxtitre" style="width: 70px;">PSI</td>
                            <td class="sheet-boxinput">10+</td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_DEFPSI_CARAC" value="@{CHA}"
                                title="@{DEFPSI_CARAC} Mod. de CHA" disabled />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_DEFPSI_ATK" value="@{ATKPSI_BASE}" title="@{DEFPSI_ATK}"
                                disabled />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_DEFPSI_DIV" value="0" title="@{DEFPSI_DIV}" />
                            </td>
                            <td class="sheet-boxinput">
                              <input type="number" name="attr_DEFPSI"
                                value="10+@{DEFPSI_CARAC}+@{DEFPSI_ATK}+@{DEFPSI_DIV}" title="@{DEFPSI}" disabled />
                            </td>
                          </tr>
                        </table>
                      </div>
                      <table class="sheet-tabsep">
                        <tr>
                          <td class="sheet-boxtitre" style="width: 70px;" title="Réduction(s) des DM">RD</td>
                          <td class="sheet-boxinput" colspan="6">
                            <textarea name="attr_RDS" title="@{RDS} Réduction(s) des DM"
                              placeholder="Réduction(s) des DM"></textarea>
                          </td>
                        </tr>
                      </table>
                    </div>
                  </td>
                </tr>
              </table>
            </td>
            <!-- FIN Combat + PV + défense -->
          </tr>
        </table>
      </div>
      <!-- FIN Caracs + combat + PV + défense  -->
      <img class="sheet-imghr"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div>
        <!-- Armes -->
        <table class="sheet-tabsep" title="repeating_armes">
          <tr>
            <td class="sheet-textfatleft" style="width:150px;">ARMES / ATTAQUES</td>
            <td class="sheet-textbase" style="width:150px;">ATTAQUE</td>
            <td class="sheet-textbase" style="width:20px;">CRIT.</td>
            <td class="sheet-textbase" style="width:215px;">DM</td>
            <td class="sheet-textbase" style="width:40px;">PORTÉE</td>
            <td class="sheet-textbase">SPÉCIAL</td>
          </tr>
        </table>
        <fieldset class="repeating_armes">
          <div class="sheet-options-block">
            <input class="sheet-options-flag" name="attr_armeoptflag" type="checkbox"
              title="Montrer/cacher les options"><span>y</span>
            <div>
              <table class="sheet-tabsep">
                <tr>
                  <td>
                    <button 
                      type="roll" 
                      class="sheet-neutre" 
                      name="roll_pjatk" 
                      title="%{repeating_armes_$N_pjatk}"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{subtags=Attaque}} {{name=@{armenom}}} {{portee=@{armeportees}}} {{desc=@{armejetn} @{armelim} @{tir_special}}} {{@{armeatt}[[@{armejetd}cs>@{armecrit}cf<@{armeinct}[Dé] + [[@{armeatk}]][Attaque] + [[@{armeatkdiv}]][Bonus] + (@{distance}) + (@{couvert}) + (@{visibilite}) + (@{armebuff}) ]]}} {{@{armedmg}[[[[@{armedmnbde}d@{armedmde}@{armedmrel}@{armedmvrel}]][Dé DM] + ([[@{armedmcar}]])[Mod.DM] + (@{armedmdiv})[Bonus DM] + (@{armebuffdm}) ]]}} {{dmtype=@{armedmtype}}} {{degats2=@{armedmg2}}} {{dm2type=@{armedm2_desc}}} {{special=@{armespec}}}" 
                    />
                  </td>
                  <td class="sheet-boxinputleft" style="min-width:125px;">
                    <input type="text" name="attr_armenom" title="@{armenom}" style="width: 125px; font-weight: bold;"
                      placeholder="Arme/attaque" />
                  </td>
                  <td class="sheet-boxinputleft" style="min-width: 135px;">
                    <input type="checkbox" name="attr_armeatt" title="@{armeatt} Faire un jet d'attaque pour toucher"
                      value="attaque=" checked="checked" />
                    <select class="sheet-carac" style="width: 87px;" name="attr_armeatk" title="@{armeatk}" size="1">
                      <option value="@{ATKCAC}" selected>CONTACT</option>
                      <option value="@{ATKTIR}">DISTANCE</option>
                      <option value="@{ATKMEN}">MENTAL</option>
                      <option value="@{ATKMAG}">MAGIE</option>
                    </select>+
                    <input type="number" style="width: 32px;" name="attr_armeatkdiv" value="0"
                      title="@{armeatkdiv} Bonus d'attaque divers" />
                    <input type="hidden" name="attr_armebuff" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="text-align: right;">
                    <input type="number" name="attr_armecrit" style="width:32px;" min="2" max="20" value="20"
                      title="@{armecrit} Seuil de Critique (par défaut 20)" />
                  </td>
                  <td class="sheet-boxinputleft">
                    <input type="checkbox" name="attr_armedmg" title="@{armedmg} Faire un jet de dommages"
                      value="degats=" checked="checked" />
                    <input type="number" style="width:32px;" name="attr_armedmnbde" value="1"
                      title="@{armedmnbde} Nombre de dés de dommage" />
                    <select class="sheet-carac" style="width:47px;" name="attr_armedmde" size="1"
                      title="@{armedmde} Dé de dommage">
                      <optgroup label="Normal">
                        <option disabled class="sheet-optgroup">&nbsp;Normal</option>
                        <option value="3">d3</option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                      </optgroup>
                      <optgroup label="Sans limite">
                        <option disabled class="sheet-optgroup">&nbsp;Sans limite</option>
                        <option value="3!">d3+</option>
                        <option value="4!">d4+</option>
                        <option value="6!" selected>d6+</option>
                        <option value="8!">d8+</option>
                        <option value="10!">d10+</option>
                        <option value="12!">d12+</option>
                      </optgroup>
                    </select>+
                    <select class="sheet-carac" style="width:52px;" name="attr_armedmcar" size="1"
                      title="@{armedmcar} Modificateur aux dommages">
                      <option value="0" selected>-</option>
                      <optgroup label="Mod. de base">
                        <option disabled class="sheet-optgroup">&nbsp;Mod. de base</option>
                        <option value="@{FOR}">FOR</option>
                        <option value="@{DEX}">DEX</option>
                        <option value="@{CON}">CON</option>
                        <option value="@{INT}">INT</option>
                        <option value="@{PER}">PER</option>
                        <option value="@{CHA}">CHA</option>
                      </optgroup>
                      <optgroup label="Mod. de test">
                        <option disabled class="sheet-optgroup">&nbsp;Mod. de test</option>
                        <option value="@{FOR_TEST}">FOR(t)</option>
                        <option value="@{DEX_TEST}">DEX(t)</option>
                        <option value="@{CON_TEST}">CON(t)</option>
                        <option value="@{INT_TEST}">INT(t)</option>
                        <option value="@{PER_TEST}">PER(t)</option>
                        <option value="@{CHA_TEST}">CHA(t)</option>
                      </optgroup>                      
                    </select>+
                    <input type="number" style="width:32px;" name="attr_armedmdiv" value="0"
                      title="@{armedmdiv} Bonus de dommage divers" />
                    <input type="hidden" name="attr_armebuffdm" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="min-width:50px;">
                    <input type="text" name="attr_armeportee" placeholder="Portée" title="@{armeportee}" />
                    <input type="hidden" name="attr_armeportees" value="" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 100%;">
                    <textarea name="attr_armespec" placeholder="Notes, capacités spéciales, effet ..."
                      title="@{armespec}"></textarea>
                  </td>
                </tr>
              </table>
            </div>
            <div class="sheet-options">
              <table class="sheet-tabsep">
                <tr>
                  <td style="width: 18px;">&nbsp;</td>
                  <td class="sheet-boxinputleft" style="width: 275px;">
                    <input type="checkbox" name="attr_arme_al" style="width: 12px;"
                      title="@{armelim} Action limitée (L)" value="1" />
                    <input type="hidden" name="attr_armelim" value="" />
                    <input type="text" name="attr_armejetn" class="sheet-carac" style="width: 230px; font-weight: bold;"
                      placeholder="Nom de l'attaque" title="@{armejetn}" />
                    <select name="attr_armejetd" class="sheet-carac" style="width: 30px;"
                      title="@{armejetd} Type de jet"
                    >
                      <option value="@{JETNORMAL}" selected>N - Normal</option>
                      <option value="@{JETRISQUE}">R - Risque (d12)</option>
                      <option value="@{JETINF}">H - Handicap (min 2 d20)</option>
                      <option value="@{JETSUP}">E - Expert (max 2 d20)</option>
                    </select>
                  </td>
                  <td class="sheet-boxinputleft" style="width: 32px;">
                    <input type="number" class="sheet-carac" style="width: 32px;" name="attr_armeinct" min="1" max="19"
                      value="1" title="@{armeinct} Seuil d'incident de tir (par défaut 1)" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 215px;">
                    <input type="text" class="sheet-carac" style="width: 115px;" name="attr_armedmtype"
                      title="@{armedmtype}" placeholder="Type DM">
                    <select class="sheet-carac" style="width: 40px;" name="attr_armedmrel"
                      title="@{armedmrel} Relance dés de DM = (r)eroll -- 1 seule fois = (r)eroll (o)nce">
                      <option value="" selected>-x- Pas de relance DM</option>
                      <option value="r">-r- Relance DM (r)</option>
                      <option value="ro">-o- Relance DM 1 seule fois (ro)</option>
                    </select>
                    <input type="text" class="sheet-carac" style="width: 45px;" name="attr_armedmvrel"
                      title="@{armedmvrel} Seuil de relance (relance les 1 si non indiqué)" />
                  </td>
                  <td class="sheet-boxinputleft" style="width: 240px;" colspan="2">
                    <input type="text" class="sheet-carac" style="width: 50px;" name="attr_armedm2_de" placeholder="1d6"
                      title="@{armedm2_de}" />
                    <input type="text" class="sheet-carac" style="width: 190px;" name="attr_armedm2_desc"
                      placeholder="Type de dommage supp." title="@{armedm2_desc}" />
                    <input type="hidden" name="attr_armedmg2" value="" />
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </fieldset>
      </div>
      <img class="sheet-imghr"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div>
        <table>
          <tr>
            <td class="sheet-textfat">Modificateurs d'Attaque</td>
            <td class="sheet-textfat">Modificateurs de Dommages</td>
          </tr>
          <tr>
            <td>
              <input type="hidden" name="attr_tir_special" value="" />
              <select style="width: 130px;" name="attr_distance" title="@{distance} Mod. de portée"
                value="0[Portée normale]">
                <optgroup label="Portée">
                  <option disabled class="sheet-optgroup">&nbsp;Portée</option>
                  <option value="+3[Portée courte]">Courte (+3)</option>
                  <option value="0[Portée normale]" selected>Normale</option>
                  <option value="-5[Portée double]">Double (-5)</option>
                  <option value="-10[Portée triple]">Triple (-10)</option>
                </optgroup>
              </select>
              <select style="width: 130px;" name="attr_couvert" title="@{couvert} Mod. de couverture"
                value="0[Aucun couvert]">
                <optgroup label="Couvert">
                  <option disabled class="sheet-optgroup">&nbsp;Couvert</option>
                  <option value="0[Aucun couvert]" selected>Aucun</option>
                  <option value="-2[Couvert partiel]">Partiel (-2)</option>
                  <option value="-5[Couvert important]">Important (-5)</option>
                </optgroup>
              </select>
              <select style="width: 130px;" name="attr_visibilite" title="@{visibilite} Mod. visibilité cible"
                value="0[Cible visible]">
                <optgroup label="Cible">
                  <option disabled class="sheet-optgroup">&nbsp;Cible</option>
                  <option value="0[Cible visible]" selected>Visible</option>
                  <option value="-2[Cible au CaC]">Cible au CaC (-2)</option>
                  <option value="-5[Cible masquée par allié]">Masquée par allié (-5)</option>
                </optgroup>
              </select>
            </td>
            <td>&nbsp;</td>
          </tr>
          <tr>
            <td style="width: 50%;">
              <fieldset class="repeating_modatk">
                <table class="sheet-tabsep">
                  <tr>
                    <td style="width: 20px;">
                      <input type="checkbox" name="attr_modatkon" value="1" />
                    </td>
                    <td class="sheet-boxinputleft">
                      <input type="text" class="sheet-carac" name="attr_modatknom" placeholder="Nom" />
                    </td>
                    <td class="sheet-boxinputleft">
                      <input type="text" class="sheet-carac" name="attr_modatkval" placeholder="Valeur" />
                    </td>
                  </tr>
                </table>
              </fieldset>
            </td>
            <td style="width: 50%;">
              <fieldset class="repeating_moddm">
                <table class="sheet-tabsep">
                  <tr>
                    <td style="width: 20px;">
                      <input type="checkbox" name="attr_moddmon" value="1" />
                    </td>
                    <td class="sheet-boxinputleft">
                      <input type="text" class="sheet-carac" name="attr_moddmnom" placeholder="Nom" />
                    </td>
                    <td class="sheet-boxinputleft">
                      <input type="text" class="sheet-carac" name="attr_moddmval" placeholder="Valeur" />
                    </td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
        </table>
      </div>
      <img class="sheet-imghr"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    </div>
    <div class="sheet-tab-content sheet-tab2">
      <div>
        <input class="sheet-block-switch" name="attr_setup_abilities" type="checkbox">
        <div class="sheet-block-hidden">
          <table>
            <tr>
              <td class="sheet-textfatleft" colspan="5">
                CAPACITÉS DU PERSONNAGE
                <button 
                  type="action" 
                  class="sheet-flatbtn sheet-iconbtn" 
                  name="act_resetuses-btn" 
                  title="Recharger les capacités avec fréquence d'utilisation"
                ><span class="sheet-iconbtn">t</span>
                </button>
                <span class="sheet-setup-abilities sheet-textbase">Edition&nbsp;<input type="checkbox" name="attr_setup_abilities"
                  title="Editer les capacités"></span>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
              <td class="sheet-boxtitresmall">Voie 1</td>
              <td class="sheet-boxtitresmall">Voie 2</td>
              <td class="sheet-boxtitresmall">Voie 3</td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">R</td>
              <td class="sheet-boxinputleft">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie1nom"
                  title="@{voie1nom}" placeholder="Nom de la Voie n°1" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie2nom"
                  title="@{voie2nom}" placeholder="Nom de la Voie n°2" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie3nom"
                  title="@{voie3nom}" placeholder="Nom de la Voie n°3" />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">1</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v1r1" title="@{v1r1} Possédée" value="1" />
                    <span name="attr_voie1-t1" class="sheet-boxability" title="@{voie1-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v1r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie1-1" class="sheet-boxability" title="@{voie1-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v1r1_use">
                  / <span name="attr_v1r1_use_max"></span> par <span name="attr_v1r1_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v2r1" title="@{v2r1} Possédée" value="1" />
                    <span name="attr_voie2-t1" class="sheet-boxability" title="@{voie2-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v2r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie2-1" class="sheet-boxability" title="@{voie2-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v2r1_use">
                  / <span name="attr_v2r1_use_max"></span> par <span name="attr_v2r1_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v3r1" title="@{v3r1} Possédée" value="1" />
                    <span name="attr_voie3-t1" class="sheet-boxability" title="@{voie3-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v3r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie3-1" class="sheet-boxability" title="@{voie3-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v3r1_use">
                  / <span name="attr_v3r1_use_max"></span> par <span name="attr_v3r1_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">2</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v1r2" title="@{v1r2} Possédée" value="1" />
                    <span name="attr_voie1-t2" class="sheet-boxability" title="@{voie1-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v1r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie1-2" class="sheet-boxability" title="@{voie1-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v1r2_use">
                  / <span name="attr_v1r2_use_max"></span> par <span name="attr_v1r2_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v2r2" title="@{v2r2} Possédée" value="1" />
                    <span name="attr_voie2-t2" class="sheet-boxability" title="@{voie2-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v2r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie2-2" class="sheet-boxability" title="@{voie2-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v2r2_use">
                  / <span name="attr_v2r2_use_max"></span> par <span name="attr_v2r2_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v3r2" title="@{v3r2} Possédée" value="1" />
                    <span name="attr_voie3-t2" class="sheet-boxability" title="@{voie3-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v3r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie3-2" class="sheet-boxability" title="@{voie3-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v3r2_use">
                  / <span name="attr_v3r2_use_max"></span> par <span name="attr_v3r2_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">3</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v1r3" title="@{v1r3} Possédée" value="1" />
                    <span name="attr_voie1-t3" class="sheet-boxability" title="@{voie1-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v1r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie1-3" class="sheet-boxability" title="@{voie1-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v1r3_use">
                  / <span name="attr_v1r3_use_max"></span> par <span name="attr_v1r3_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v2r3" title="@{v2r3} Possédée" value="1" />
                    <span name="attr_voie2-t3" class="sheet-boxability" title="@{voie2-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v2r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie2-3" class="sheet-boxability" title="@{voie2-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v2r3_use">
                  / <span name="attr_v2r3_use_max"></span> par <span name="attr_v2r3_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v3r3" title="@{v3r3} Possédée" value="1" />
                    <span name="attr_voie3-t3" class="sheet-boxability" title="@{voie3-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v3r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie3-3" class="sheet-boxability" title="@{voie3-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v3r3_use">
                  / <span name="attr_v3r3_use_max"></span> par <span name="attr_v3r3_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">4</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v1r4" title="@{v1r4} Possédée" value="1" />
                    <span name="attr_voie1-t4" class="sheet-boxability" title="@{voie1-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v1r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie1-4" class="sheet-boxability" title="@{voie1-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v1r4_use">
                  / <span name="attr_v1r4_use_max"></span> par <span name="attr_v1r4_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v2r4" title="@{v2r4} Possédée" value="1" />
                    <span name="attr_voie2-t4" class="sheet-boxability" title="@{voie2-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v2r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie2-4" class="sheet-boxability" title="@{voie2-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v2r4_use">
                  / <span name="attr_v2r4_use_max"></span> par <span name="attr_v2r4_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v3r4" title="@{v3r4} Possédée" value="1" />
                    <span name="attr_voie3-t4" class="sheet-boxability" title="@{voie3-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v3r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie3-4" class="sheet-boxability" title="@{voie3-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v3r4_use">
                  / <span name="attr_v3r4_use_max"></span> par <span name="attr_v3r4_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">5</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v1r5" title="@{v1r5} Possédée" value="1" />
                    <span name="attr_voie1-t5" class="sheet-boxability" title="@{voie1-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v1r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie1-5" class="sheet-boxability" title="@{voie1-5}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v1r5_use">
                  / <span name="attr_v1r5_use_max"></span> par <span name="attr_v1r5_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v2r5" title="@{v2r5} Possédée" value="1" />
                    <span name="attr_voie2-t5" class="sheet-boxability" title="@{voie2-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v2r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie2-5" class="sheet-boxability" title="@{voie2-5}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v2r5_use">
                  / <span name="attr_v2r5_use_max"></span> par <span name="attr_v2r5_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v3r5" title="@{v3r5} Possédée" value="1" />
                    <span name="attr_voie3-t5" class="sheet-boxability" title="@{voie3-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v3r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie3-5" class="sheet-boxability" title="@{voie3-5}"></span>
                </details>
              </td>
            </tr>
          </table>
          <table>
            <tr>
              <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
              <td class="sheet-boxtitresmall">Voie 4</td>
              <td class="sheet-boxtitresmall">Voie 5</td>
              <td class="sheet-boxtitresmall">Voie 6</td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">R</td>
              <td class="sheet-boxinputleft">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie4nom"
                  title="@{voie4nom}" placeholder="Nom de la Voie n°4" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie5nom"
                  title="@{voie5nom}" placeholder="Nom de la Voie n°5" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie6nom"
                  title="@{voie6nom}" placeholder="Nom de la Voie n°6" />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">1</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v4r1" title="@{v4r1} Possédée" value="1" />
                    <span name="attr_voie4-t1" class="sheet-boxability" title="@{voie4-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v4r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie4-1" class="sheet-boxability" title="@{voie4-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v4r1_use">
                  / <span name="attr_v4r1_use_max"></span> par <span name="attr_v4r1_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v5r1" title="@{v5r1} Possédée" value="1" />
                    <span name="attr_voie5-t1" class="sheet-boxability" title="@{voie5-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v5r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie5-1" class="sheet-boxability" title="@{voie5-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v5r1_use">
                  / <span name="attr_v5r1_use_max"></span> par <span name="attr_v5r1_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v6r1" title="@{v6r1} Possédée" value="1" />
                    <span name="attr_voie6-t1" class="sheet-boxability" title="@{voie6-t1}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v6r1-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie6-1" class="sheet-boxability" title="@{voie6-1}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v6r1_use">
                  / <span name="attr_v6r1_use_max"></span> par <span name="attr_v6r1_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">2</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v4r2" title="@{v4r2} Possédée" value="1" />
                    <span name="attr_voie4-t2" class="sheet-boxability" title="@{voie4-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v4r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie4-2" class="sheet-boxability" title="@{voie4-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v4r2_use">
                  / <span name="attr_v4r2_use_max"></span> par <span name="attr_v4r2_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v5r2" title="@{v5r2} Possédée" value="1" />
                    <span name="attr_voie5-t2" class="sheet-boxability" title="@{voie5-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v5r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie5-2" class="sheet-boxability" title="@{voie5-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v5r2_use">
                  / <span name="attr_v5r2_use_max"></span> par <span name="attr_v5r2_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v6r2" title="@{v6r2} Possédée" value="1" />
                    <span name="attr_voie6-t2" class="sheet-boxability" title="@{voie6-t2}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v6r2-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie6-2" class="sheet-boxability" title="@{voie6-2}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v6r2_use">
                  / <span name="attr_v6r2_use_max"></span> par <span name="attr_v6r2_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">3</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v4r3" title="@{v4r3} Possédée" value="1" />
                    <span name="attr_voie4-t3" class="sheet-boxability" title="@{voie4-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v4r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie4-3" class="sheet-boxability" title="@{voie4-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v4r3_use">
                  / <span name="attr_v4r3_use_max"></span> par <span name="attr_v4r3_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v5r3" title="@{v5r3} Possédée" value="1" />
                    <span name="attr_voie5-t3" class="sheet-boxability" title="@{voie5-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v5r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie5-3" class="sheet-boxability" title="@{voie5-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v5r3_use">
                  / <span name="attr_v5r3_use_max"></span> par <span name="attr_v5r3_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v6r3" title="@{v6r3} Possédée" value="1" />
                    <span name="attr_voie6-t3" class="sheet-boxability" title="@{voie6-t3}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v6r3-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie6-3" class="sheet-boxability" title="@{voie6-3}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v6r3_use">
                  / <span name="attr_v6r3_use_max"></span> par <span name="attr_v6r3_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">4</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v4r4" title="@{v4r4} Possédée" value="1" />
                    <span name="attr_voie4-t4" class="sheet-boxability" title="@{voie4-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v4r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie4-4" class="sheet-boxability" title="@{voie4-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v4r4_use">
                  / <span name="attr_v4r4_use_max"></span> par <span name="attr_v4r4_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v5r4" title="@{v5r4} Possédée" value="1" />
                    <span name="attr_voie5-t4" class="sheet-boxability" title="@{voie5-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v5r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie5-4" class="sheet-boxability" title="@{voie5-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v5r4_use">
                  / <span name="attr_v5r4_use_max"></span> par <span name="attr_v5r4_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v6r4" title="@{v6r4} Possédée" value="1" />
                    <span name="attr_voie6-t4" class="sheet-boxability" title="@{voie6-t4}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v6r4-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie6-4" class="sheet-boxability" title="@{voie6-4}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v6r4_use">
                  / <span name="attr_v6r4_use_max"></span> par <span name="attr_v6r4_freq"></span>
                </details>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">5</td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v4r5" title="@{v4r5} Possédée" value="1" />
                    <span name="attr_voie4-t5" class="sheet-boxability" title="@{voie4-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v4r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie4-5" class="sheet-boxability" title="@{voie4-5}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v4r5_use">
                  / <span name="attr_v4r5_use_max"></span> par <span name="attr_v4r5_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v5r5" title="@{v5r5} Possédée" value="1" />
                    <span name="attr_voie5-t5" class="sheet-boxability" title="@{voie5-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v5r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie5-5" class="sheet-boxability" title="@{voie5-5}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v5r5_use">
                  / <span name="attr_v5r5_use_max"></span> par <span name="attr_v5r5_freq"></span>
                </details>
              </td>
              <td class="sheet-boxvoie sheet-boxtext">
                <details>
                  <summary>
                    <input type="checkbox" name="attr_v6r5" title="@{v6r5} Possédée" value="1" />
                    <span name="attr_voie6-t5" class="sheet-boxability" title="@{voie6-t5}"></span>
                    <span class="sheet-align-right">
                      <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v6r5-btn" title="">
                        <span class="sheet-iconbtn">w</span>
                      </button>
                    </span>
                  </summary>
                  <span name="attr_voie6-5" class="sheet-boxability" title="@{voie6-5}"></span>
                  <br><input type="number" style="width: 3rem" name="attr_v6r5_use">
                  / <span name="attr_v6r5_use_max"></span> par <span name="attr_v6r5_freq"></span>
                </details>
              </td>
            </tr>
          </table>
          <div>
            <input type="checkbox" class="sheet-block-switch" name="attr_voies789"><span>Plus de voies</span>
            <div class="sheet-block-hidden"></div>
            <div class="sheet-block-show">
              <table>
                <tr>
                  <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
                  <td class="sheet-boxtitresmall">Voie 7</td>
                  <td class="sheet-boxtitresmall">Voie 8</td>
                  <td class="sheet-boxtitresmall">Voie 9</td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">R</td>
                  <td class="sheet-boxinputleft">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie7nom"
                      title="@{voie7nom}" placeholder="Nom de la Voie n°7" />
                  </td>
                  <td class="sheet-boxinput">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie8nom"
                      title="@{voie8nom}" placeholder="Nom de la Voie n°8" />
                  </td>
                  <td class="sheet-boxinput">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie9nom"
                      title="@{voie9nom}" placeholder="Nom de la Voie n°9" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">1</td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v7r1" title="@{v7r1} Possédée" value="1" />
                        <span name="attr_voie7-t1" class="sheet-boxability" title="@{voie7-t1}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v7r1-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie7-1" class="sheet-boxability" title="@{voie7-1}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v7r1_use">
                      / <span name="attr_v7r1_use_max"></span> par <span name="attr_v7r1_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v8r1" title="@{v8r1} Possédée" value="1" />
                        <span name="attr_voie8-t1" class="sheet-boxability" title="@{voie8-t1"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v8r1-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie8-1" class="sheet-boxability" title="@{voie8-1}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v8r1_use">
                      / <span name="attr_v8r1_use_max"></span> par <span name="attr_v8r1_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v9r1" title="@{v9r1} Possédée" value="1" />
                        <span name="attr_voie9-t1" class="sheet-boxability" title="@{voie9-t1}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v9r1-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie9-1" class="sheet-boxability" title="@{voie9-1}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v9r1_use">
                      / <span name="attr_v9r1_use_max"></span> par <span name="attr_v9r1_freq"></span>
                    </details>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">2</td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v7r2" title="@{v7r2} Possédée" value="1" />
                        <span name="attr_voie7-t2" class="sheet-boxability" title="@{voie7-t2}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v7r2-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie7-2" class="sheet-boxability" title="@{voie7-2}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v7r2_use">
                      / <span name="attr_v7r2_use_max"></span> par <span name="attr_v7r2_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v8r2" title="@{v8r2} Possédée" value="1" />
                        <span name="attr_voie8-t2" class="sheet-boxability" title="@{voie8-t2}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v8r2-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie8-2" class="sheet-boxability" title="@{voie8-2}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v8r2_use">
                      / <span name="attr_v8r2_use_max"></span> par <span name="attr_v8r2_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v9r2" title="@{v9r2} Possédée" value="1" />
                        <span name="attr_voie9-t2" class="sheet-boxability" title="@{voie9-t2}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v9r2-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie9-2" class="sheet-boxability" title="@{voie9-2}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v9r2_use">
                      / <span name="attr_v9r2_use_max"></span> par <span name="attr_v9r2_freq"></span>
                    </details>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">3</td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v7r3" title="@{v7r3} Possédée" value="1" />
                        <span name="attr_voie7-t3" class="sheet-boxability" title="@{voie7-t3}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v7r3-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie7-3" class="sheet-boxability" title="@{voie7-3}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v7r3_use">
                      / <span name="attr_v7r3_use_max"></span> par <span name="attr_v7r3_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v8r3" title="@{v8r3} Possédée" value="1" />
                        <span name="attr_voie8-t3" class="sheet-boxability" title="@{voie8-t3}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v8r3-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie8-3" class="sheet-boxability" title="@{voie8-3}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v8r3_use">
                      / <span name="attr_v8r3_use_max"></span> par <span name="attr_v8r3_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v9r3" title="@{v9r3} Possédée" value="1" />
                        <span name="attr_voie9-t3" class="sheet-boxability" title="@{voie9-t3}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v9r3-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie9-3" class="sheet-boxability" title="@{voie9-3}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v9r3_use">
                      / <span name="attr_v9r3_use_max"></span> par <span name="attr_v9r3_freq"></span>
                    </details>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">4</td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v7r4" title="@{v7r4} Possédée" value="1" />
                        <span name="attr_voie7-t4" class="sheet-boxability" title="@{voie7-t4}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v7r4-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie7-4" class="sheet-boxability" title="@{voie7-4}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v7r4_use">
                      / <span name="attr_v7r4_use_max"></span> par <span name="attr_v7r4_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v8r4" title="@{v8r4} Possédée" value="1" />
                        <span name="attr_voie8-t4" class="sheet-boxability" title="@{voie8-t4}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v8r4-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie8-4" class="sheet-boxability" title="@{voie8-4}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v8r4_use">
                      / <span name="attr_v8r4_use_max"></span> par <span name="attr_v8r4_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v9r4" title="@{v9r4} Possédée" value="1" />
                        <span name="attr_voie9-t4" class="sheet-boxability" title="@{voie9-t4}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v9r4-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie9-4" class="sheet-boxability" title="@{voie9-4}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v9r4_use">
                      / <span name="attr_v9r4_use_max"></span> par <span name="attr_v9r4_freq"></span>
                    </details>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">5</td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v7r5" title="@{v7r5} Possédée" value="1" />
                        <span name="attr_voie7-t5" class="sheet-boxability" title="@{voie7-t5}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v7r5-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie7-5" class="sheet-boxability" title="@{voie7-5}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v7r5_use">
                      / <span name="attr_v7r5_use_max"></span> par <span name="attr_v7r5_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v8r5" title="@{v8r5} Possédée" value="1" />
                        <span name="attr_voie8-t5" class="sheet-boxability" title="@{voie8-t5}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v8r5-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie8-5" class="sheet-boxability" title="@{voie8-5}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v8r5_use">
                      / <span name="attr_v8r5_use_max"></span> par <span name="attr_v8r5_freq"></span>
                    </details>
                  </td>
                  <td class="sheet-boxvoie sheet-boxtext">
                    <details>
                      <summary>
                        <input type="checkbox" name="attr_v9r5" title="@{v9r5} Possédée" value="1" />
                        <span name="attr_voie9-t5" class="sheet-boxability" title="@{voie9-t5}"></span>
                        <span class="sheet-align-right">
                          <button type="action" class="sheet-flatbtn sheet-iconbtn" name="act_v9r5-btn" title="">
                            <span class="sheet-iconbtn">w</span>
                          </button>
                        </span>
                      </summary>
                      <span name="attr_voie9-5" class="sheet-boxability" title="@{voie9-5}"></span>
                      <br><input type="number" style="width: 3rem" name="attr_v9r5_use">
                      / <span name="attr_v9r5_use_max"></span> par <span name="attr_v9r5_freq"></span>
                    </details>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div class="sheet-block-show">
          <table>
            <tr>
              <td class="sheet-textfatleft" colspan="5">
                CAPACITÉS DU PERSONNAGE
                <span class="sheet-setup-abilities">Affichage&nbsp;<input type="checkbox" name="attr_setup_abilities"
                  title="Editer les capacités"></span>
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
              <td class="sheet-boxtitresmall">Voie 1</td>
              <td class="sheet-boxtitresmall">Voie 2</td>
              <td class="sheet-boxtitresmall">Voie 3</td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">R</td>
              <td class="sheet-boxinputleft">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie1nom"
                  title="@{voie1nom}" placeholder="Nom de la Voie n°1" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie2nom"
                  title="@{voie2nom}" placeholder="Nom de la Voie n°2" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie3nom"
                  title="@{voie3nom}" placeholder="Nom de la Voie n°3" />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">1</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v1r1" title="@{v1r1} Possédée" value="1" />
                <input type="text" name="attr_voie1-t1" class="sheet-boxability" title="@{voie1-t1}" />
                <br><textarea name="attr_voie1-1" class="sheet-boxability" title="@{voie1-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v1r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v1r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v2r1" title="@{v2r1} Possédée" value="1" />
                <input type="text" name="attr_voie2-t1" class="sheet-boxability" title="@{voie2-t1}" />
                <br><textarea name="attr_voie2-1" class="sheet-boxability" title="@{voie2-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v2r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v2r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v3r1" title="@{v3r1} Possédée" value="1" />
                <input type="text" name="attr_voie3-t1" class="sheet-boxability" title="@{voie3-t1}" />
                <br><textarea name="attr_voie3-1" class="sheet-boxability" title="@{voie3-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v3r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v3r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">2</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v1r2" title="@{v1r2} Possédée" value="1" />
                <input type="text" name="attr_voie1-t2" class="sheet-boxability" title="@{voie1-t2}" />
                <br><textarea name="attr_voie1-2" class="sheet-boxability" title="@{voie1-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v1r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v1r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v2r2" title="@{v2r2} Possédée" value="1" />
                <input type="text" name="attr_voie2-t2" class="sheet-boxability" title="@{voie2-t2}" />
                <br><textarea name="attr_voie2-2" class="sheet-boxability" title="@{voie2-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v2r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v2r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v3r2" title="@{v3r2} Possédée" value="1" />
                <input type="text" name="attr_voie3-t2" class="sheet-boxability" title="@{voie3-t2}" />
                <br><textarea name="attr_voie3-2" class="sheet-boxability" title="@{voie3-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v3r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v3r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">3</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v1r3" title="@{v1r3} Possédée" value="1" />
                <input type="text" name="attr_voie1-t3" class="sheet-boxability" title="@{voie1-t3}" />
                <br><textarea name="attr_voie1-3" class="sheet-boxability" title="@{voie1-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v1r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v1r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v2r3" title="@{v2r3} Possédée" value="1" />
                <input type="text" name="attr_voie2-t3" class="sheet-boxability" title="@{voie2-t3}" />
                <br><textarea name="attr_voie2-3" class="sheet-boxability" title="@{voie2-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v2r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v2r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v3r3" title="@{v3r3} Possédée" value="1" />
                <input type="text" name="attr_voie3-t3" class="sheet-boxability" title="@{voie3-t3}" />
                <br><textarea name="attr_voie3-3" class="sheet-boxability" title="@{voie3-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v3r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v3r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">4</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v1r4" title="@{v1r4} Possédée" value="1" />
                <input type="text" name="attr_voie1-t4" class="sheet-boxability" title="@{voie1-t4}" />
                <br><textarea name="attr_voie1-4" class="sheet-boxability" title="@{voie1-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v1r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v1r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v2r4" title="@{v2r4} Possédée" value="1" />
                <input type="text" name="attr_voie2-t4" class="sheet-boxability" title="@{voie2-t4}" />
                <br><textarea name="attr_voie2-4" class="sheet-boxability" title="@{voie2-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v2r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v2r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v3r4" title="@{v3r4} Possédée" value="1" />
                <input type="text" name="attr_voie3-t4" class="sheet-boxability" title="@{voie3-t4}" />
                <br><textarea name="attr_voie3-4" class="sheet-boxability" title="@{voie3-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v3r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v3r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">5</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v1r5" title="@{v1r5} Possédée" value="1" />
                <input type="text" name="attr_voie1-t5" class="sheet-boxability" title="@{voie1-t5}" />
                <br><textarea name="attr_voie1-5" class="sheet-boxability" title="@{voie1-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v1r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v1r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v2r5" title="@{v2r5} Possédée" value="1" />
                <input type="text" name="attr_voie2-t5" class="sheet-boxability" title="@{voie2-t5}" />
                <br><textarea name="attr_voie2-5" class="sheet-boxability" title="@{voie2-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v2r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v2r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v3r5" title="@{v3r5} Possédée" value="1" />
                <input type="text" name="attr_voie3-t5" class="sheet-boxability" title="@{voie3-t5}" />
                <br><textarea name="attr_voie3-5" class="sheet-boxability" title="@{voie3-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v3r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v3r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
          </table>
          <table>
            <tr>
              <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
              <td class="sheet-boxtitresmall">Voie 4</td>
              <td class="sheet-boxtitresmall">Voie 5</td>
              <td class="sheet-boxtitresmall">Voie 6</td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">R</td>
              <td class="sheet-boxinputleft">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie4nom"
                  title="@{voie4nom}" placeholder="Nom de la Voie n°4" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie5nom"
                  title="@{voie5nom}" placeholder="Nom de la Voie n°5" />
              </td>
              <td class="sheet-boxinput">
                <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie6nom"
                  title="@{voie6nom}" placeholder="Nom de la Voie n°6" />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">1</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v4r1" title="@{v4r1} Possédée" value="1" />
                <input type="text" name="attr_voie4-t1" class="sheet-boxability" title="@{voie4-t1}" />
                <br><textarea name="attr_voie4-1" class="sheet-boxability" title="@{voie4-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v4r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v4r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v5r1" title="@{v5r1} Possédée" value="1" />
                <input type="text" name="attr_voie5-t1" class="sheet-boxability" title="@{voie5-t1}" />
                <br><textarea name="attr_voie5-1" class="sheet-boxability" title="@{voie5-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v5r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v5r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v6r1" title="@{v6r1} Possédée" value="1" />
                <input type="text" name="attr_voie6-t1" class="sheet-boxability" title="@{voie6-t1}" />
                <br><textarea name="attr_voie6-1" class="sheet-boxability" title="@{voie6-1}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v6r1_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v6r1_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">2</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v4r2" title="@{v4r2} Possédée" value="1" />
                <input type="text" name="attr_voie4-t2" class="sheet-boxability" title="@{voi41-t2}" />
                <br><textarea name="attr_voie4-2" class="sheet-boxability" title="@{voie4-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v4r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v4r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v5r2" title="@{v5r2} Possédée" value="1" />
                <input type="text" name="attr_voie5-t2" class="sheet-boxability" title="@{voie5-t2}" />
                <br><textarea name="attr_voie5-2" class="sheet-boxability" title="@{voie5-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v5r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v5r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v6r2" title="@{v6r2} Possédée" value="1" />
                <input type="text" name="attr_voie6-t2" class="sheet-boxability" title="@{voie6-t2}" />
                <br><textarea name="attr_voie6-2" class="sheet-boxability" title="@{voie6-2}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v6r2_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v6r2_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">3</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v4r3" title="@{v4r3} Possédée" value="1" />
                <input type="text" name="attr_voie4-t3" class="sheet-boxability" title="@{voie4-t3}" />
                <br><textarea name="attr_voie4-3" class="sheet-boxability" title="@{voie4-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v4r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v4r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v5r3" title="@{v5r3} Possédée" value="1" />
                <input type="text" name="attr_voie5-t3" class="sheet-boxability" title="@{voie5-t3}" />
                <br><textarea name="attr_voie5-3" class="sheet-boxability" title="@{voie5-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v5r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v5r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v6r3" title="@{v6r3} Possédée" value="1" />
                <input type="text" name="attr_voie6-t3" class="sheet-boxability" title="@{voie6-t3}" />
                <br><textarea name="attr_voie6-3" class="sheet-boxability" title="@{voie6-3}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v6r3_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v6r3_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">4</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v4r4" title="@{v4r4} Possédée" value="1" />
                <input type="text" name="attr_voie4-t4" class="sheet-boxability" title="@{voie4-t4}" />
                <br><textarea name="attr_voie4-4" class="sheet-boxability" title="@{voie4-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v4r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v4r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v5r4" title="@{v5r4} Possédée" value="1" />
                <input type="text" name="attr_voie5-t4" class="sheet-boxability" title="@{voie5-t4}" />
                <br><textarea name="attr_voie5-4" class="sheet-boxability" title="@{voie5-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v5r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v5r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v6r4" title="@{v6r4} Possédée" value="1" />
                <input type="text" name="attr_voie6-t4" class="sheet-boxability" title="@{voie6-t4}" />
                <br><textarea name="attr_voie6-4" class="sheet-boxability" title="@{voie6-4}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v6r4_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v6r4_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitresmall">5</td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v4r5" title="@{v4r5} Possédée" value="1" />
                <input type="text" name="attr_voie4-t5" class="sheet-boxability" title="@{voie4-t5}" />
                <br><textarea name="attr_voie4-5" class="sheet-boxability" title="@{voie4-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v4r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v4r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v5r5" title="@{v5r5} Possédée" value="1" />
                <input type="text" name="attr_voie5-t5" class="sheet-boxability" title="@{voie5-t5}" />
                <br><textarea name="attr_voie5-5" class="sheet-boxability" title="@{voie5-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v5r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v5r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
              <td class="sheet-boxvoie">
                <input type="checkbox" name="attr_v6r5" title="@{v6r5} Possédée" value="1" />
                <input type="text" name="attr_voie6-t5" class="sheet-boxability" title="@{voie6-t5}" />
                <br><textarea name="attr_voie6-5" class="sheet-boxability" title="@{voie6-5}"></textarea>
                <br>
                <input 
                  type="number" 
                  name="attr_v6r5_use_max" 
                  class="sheet-boxability"
                  style="width: 3rem;" 
                  value=""  
                />
                <input 
                  type="text" 
                  name="attr_v6r5_freq" 
                  style="width: 10rem;" 
                  value=""
                />
              </td>
            </tr>
          </table>
          <div>
            <input type="checkbox" class="sheet-block-switch" name="attr_voies789"><span>Plus de voies</span>
            <div class="sheet-block-hidden"></div>
            <div class="sheet-block-show">
              <table>
                <tr>
                  <td class="sheet-boxtitresmall" style="width: 20px;">&nbsp;</td>
                  <td class="sheet-boxtitresmall">Voie 7</td>
                  <td class="sheet-boxtitresmall">Voie 8</td>
                  <td class="sheet-boxtitresmall">Voie 9</td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">R</td>
                  <td class="sheet-boxinputleft">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie7nom"
                      title="@{voie7nom}" placeholder="Nom de la Voie n°7" />
                  </td>
                  <td class="sheet-boxinput">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie8nom"
                      title="@{voie8nom}" placeholder="Nom de la Voie n°8" />
                  </td>
                  <td class="sheet-boxinput">
                    <input type="text" style="font-weight: bold;text-align: center;" name="attr_voie9nom"
                      title="@{voie9nom}" placeholder="Nom de la Voie n°9" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">1</td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v7r1" title="@{v7r1} Possédée" value="1" />
                    <input type="text" name="attr_voie7-t1" class="sheet-boxability" title="@{voie7-t1}" />
                    <br><textarea name="attr_voie7-1" class="sheet-boxability" title="@{voie7-1}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v7r1_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v7r1_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v8r1" title="@{v8r1} Possédée" value="1" />
                    <input type="text" name="attr_voie8-t1" class="sheet-boxability" title="@{voie8-t1}" />
                    <br><textarea name="attr_voie8-1" class="sheet-boxability" title="@{voie8-1"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v8r1_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v8r1_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v9r1" title="@{v9r1} Possédée" value="1" />
                    <input type="text" name="attr_voie9-t1" class="sheet-boxability" title="@{voie9-t1}" />
                    <br><textarea name="attr_voie9-1" class="sheet-boxability" title="@{voie9-1}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v9r1_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v9r1_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">2</td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v7r2" title="@{v7r2} Possédée" value="1" />
                    <input type="text" name="attr_voie7-t2" class="sheet-boxability" title="@{voie7-t2}" />
                    <br><textarea name="attr_voie7-2" class="sheet-boxability" title="@{voie7-2}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v7r2_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v7r2_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v8r2" title="@{v8r2} Possédée" value="1" />
                    <input type="text" name="attr_voie8-t2" class="sheet-boxability" title="@{voie8-t2}" />
                    <br><textarea name="attr_voie8-2" class="sheet-boxability" title="@{voie8-2}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v8r2_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v8r2_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v9r2" title="@{v9r2} Possédée" value="1" />
                    <input type="text" name="attr_voie9-t2" class="sheet-boxability" title="@{voie9-t2}" />
                    <br><textarea name="attr_voie9-2" class="sheet-boxability" title="@{voie9-2}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v9r2_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v9r2_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">3</td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v7r3" title="@{v7r3} Possédée" value="1" />
                    <input type="text" name="attr_voie7-t3" class="sheet-boxability" title="@{voie7-t3}" />
                    <br><textarea name="attr_voie7-3" class="sheet-boxability" title="@{voie7-3}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v7r3_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v7r3_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v8r3" title="@{v8r3} Possédée" value="1" />
                    <input type="text" name="attr_voie8-t3" class="sheet-boxability" title="@{voie8-t3}" />
                    <br><textarea name="attr_voie8-3" class="sheet-boxability" title="@{voie8-3}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v8r3_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v8r3_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v9r3" title="@{v9r3} Possédée" value="1" />
                    <input type="text" name="attr_voie9-t3" class="sheet-boxability" title="@{voie9-t3}" />
                    <br><textarea name="attr_voie9-3" class="sheet-boxability" title="@{voie9-3}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v9r3_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v9r3_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">4</td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v7r4" title="@{v7r4} Possédée" value="1" />
                    <input type="text" name="attr_voie7-t4" class="sheet-boxability" title="@{voie7-t4}" />
                    <br><textarea name="attr_voie7-4" class="sheet-boxability" title="@{voie7-4}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v7r4_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v7r4_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v8r4" title="@{v8r4} Possédée" value="1" />
                    <input type="text" name="attr_voie8-t4" class="sheet-boxability" title="@{voie8-t4}" />
                    <br><textarea name="attr_voie8-4" class="sheet-boxability" title="@{voie8-4}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v8r4_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v8r4_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v9r4" title="@{v9r4} Possédée" value="1" />
                    <input type="text" name="attr_voie9-t4" class="sheet-boxability" title="@{voie9-t4}" />
                    <br><textarea name="attr_voie9-4" class="sheet-boxability" title="@{voie9-4}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v9r4_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v9r4_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitresmall">5</td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v7r5" title="@{v7r5} Possédée" value="1" />
                    <input type="text" name="attr_voie7-t5" class="sheet-boxability" title="@{voie7-t5}" />
                    <br><textarea name="attr_voie7-5" class="sheet-boxability" title="@{voie7-5}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v7r5_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v7r5_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v8r5" title="@{v8r5} Possédée" value="1" />
                    <input type="text" name="attr_voie8-t5" class="sheet-boxability" title="@{voie8-t5}" />
                    <br><textarea name="attr_voie8-5" class="sheet-boxability" title="@{voie8-5}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v8r5_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v8r5_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                  <td class="sheet-boxvoie">
                    <input type="checkbox" name="attr_v9r5" title="@{v9r5} Possédée" value="1" />
                    <input type="text" name="attr_voie9-t5" class="sheet-boxability" title="@{voie9-t5}" />
                    <br><textarea name="attr_voie9-5" class="sheet-boxability" title="@{voie9-5}"></textarea>
                    <br>
                    <input 
                      type="number" 
                      name="attr_v9r5_use_max" 
                      class="sheet-boxability"
                      style="width: 3rem;" 
                      value=""  
                    />
                    <input 
                      type="text" 
                      name="attr_v9r5_freq" 
                      style="width: 10rem;" 
                      value=""
                    />
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <!-- Voies -->
      </div>
      <!-- FIN Voies -->
      <button type="action" class="sheet-subtab" name="act_subtab2_skills">Jets de Capacités</button>
      <button type="action" class="sheet-subtab" name="act_subtab2_traits">Traits</button>
      <button type="action" class="sheet-subtab" name="act_subtab2_buffs">Buffs</button>
      <img class="sheet-imghr"
      src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <input type="hidden" name="attr_subtab2" class="sheet-toggle-subtab2" value="skills">
      <div class="sheet-subtab2-skills">
        <span class="sheet-textfatleft">Jets de capacités</span>
        <fieldset class="repeating_jetcapas">
          <table class="sheet-tabsep">
            <tr>
              <td>
                <button type="roll" class="sheet-neutre" name="roll_pjcapa" title="%{repeating_jetcapas_$N_pjcapa}"
                  value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{subtags=Capacité}} {{name=@{jetcapanom} @{jetcapalim}}} {{carac=[[@{jetcapanbde}d@{jetcapade}@{jetcapatypjet}[Jet] + [[@{jetcapacarac}]][Bonus Carac] + [[(@{jetcapacoeff}*@{jetcaparang})]][Bonus rang] + @{jetcapadiv}[Bonus divers] ]] }} {{jet=@{jetcapatitre}}} {{desc=@{jetcapaskill}}} {{text=@{jetcapadesc}}}" 
                />
              </td>
              <td class="sheet-boxinputleft" style="min-width:200px;">
                <input type="text" name="attr_jetcapanom" title="@{jetcapanom}" style="font-weight: bold;"
                  placeholder="Nom du Jet de capacité" />
              </td>
              <td class="sheet-boxinputleft">
                <input type="checkbox" name="attr_jetcapa_al" style="width: 12px;"
                  title="@{jetcapalim} Action limitée (L)" value="1" />
                <input type="hidden" name="attr_jetcapalim" value="" />
                <input type="number" style="width:32px;" name="attr_jetcapanbde" value="1"
                  title="@{jetcapanbde} Nombre de dés" />
                <select class="sheet-carac" style="width:50px;" name="attr_jetcapade" size="1" title="@{jetcapade} Dé">
                  <option value="@{ETATDE}" selected>d20 (d12 si Affaibli)</option>
                  <optgroup label="Jet standard">
                    <option disabled class="sheet-optgroup">&nbsp;Jet standard</option>
                    <option value="4">d4</option>
                    <option value="6">d6</option>
                    <option value="8">d8</option>
                    <option value="10">d10</option>
                    <option value="12">d12</option>
                  </optgroup>
                  <optgroup label="Jet explosif">
                    <option disabled class="sheet-optgroup">&nbsp;Jet explosif</option>
                    <option value="4!">d4+</option>
                    <option value="6!">d6+</option>
                    <option value="8!">d8+</option>
                    <option value="10!">d10+</option>
                    <option value="12!">d12+</option>
                  </optgroup>
                </select>&nbsp;(
                <select class="sheet-carac" style="width:30px;" name="attr_jetcapatypjet" size="1"
                  title="@{jetcapatypjet} Type de jet : normal, meilleur dé, moins bon dé">
                  <option value="">N - Normal / Addition</option>
                  <option value="kh1">S - Garder le meilleur dé</option>
                  <option value="kl1">I - Garder le moins bon dé</option>
                </select>)&nbsp;+
                <select class="sheet-carac" style="width:60px;" name="attr_jetcapacarac" size="1"
                  title="@{jetcapacarac} Modificateur du jet">
                  <option value="0" selected>-</option>
                  <option value="@{NIVEAU}">NIV</option>
                  <optgroup label="Mod. de Base">
                    <option disabled class="sheet-optgroup">&nbsp;Mod. de base</option>
                    <option value="@{FOR}">FOR</option>
                    <option value="@{DEX}">DEX</option>
                    <option value="@{CON}">CON</option>
                    <option value="@{INT}">INT</option>
                    <option value="@{PER}">PER</option>
                    <option value="@{CHA}">CHA</option>
                    <option value="@{QRYMOD}">Choix base</option>
                  </optgroup>
                  <optgroup label="Mod. de Test">
                    <option disabled class="sheet-optgroup">&nbsp;Mod. de test</option>
                    <option value="@{FOR_TEST}">FOR(t)</option>
                    <option value="@{DEX_TEST}">DEX(t)</option>
                    <option value="@{CON_TEST}">CON(t)</option>
                    <option value="@{INT_TEST}">INT(t)</option>
                    <option value="@{PER_TEST}">PER(t)</option>
                    <option value="@{CHA_TEST}">CHA(t)</option>
                    <option value="@{QRYMODT}">Choix test</option>
                  </optgroup>
                  <optgroup label="Attaques">
                    <option disabled class="sheet-optgroup">&nbsp;Attaques</option>
                    <option value="@{ATKCAC}">ATC</option>
                    <option value="@{ATKTIR}">ATD</option>
                    <option value="@{ATKMEN}">MEN</option>
                    <option value="@{ATKMAG}">MAG</option>
                    <option value="@{ATKPIL}">PIL</option>
                  </optgroup>
                </select>+&nbsp;(
                <select class="sheet-carac" style="width:40px;" name="attr_jetcapacoeff" size="1"
                  title="@{jetcapacoeff} Bonus par rang">
                  <option value="0">-</option>
                  <option value="1">+1</option>
                  <option value="2">+2</option>
                </select>&nbsp;x&nbsp;
                <select class="sheet-carac" style="width:60px;" name="attr_jetcaparang" size="1"
                  title="@{jetcaparang} Rang dans la voie">
                  <option value="0" selected>-</option>
                  <option value="@{RANG_VOIE1}">Voie 1</option>
                  <option value="@{RANG_VOIE2}">Voie 2</option>
                  <option value="@{RANG_VOIE3}">Voie 3</option>
                  <option value="@{RANG_VOIE4}">Voie 4</option>
                  <option value="@{RANG_VOIE5}">Voie 5</option>
                  <option value="@{RANG_VOIE6}">Voie 6</option>
                  <option value="@{RANG_VOIE7}">Voie 7</option>
                  <option value="@{RANG_VOIE8}">Voie 8</option>
                  <option value="@{RANG_VOIE9}">Voie 9</option>
                </select>)&nbsp;+
                <input type="hidden" name="attr_jetcapaskill" value="" />
                <input type="number" style="width:32px;" name="attr_jetcapadiv" value="0"
                  title="@{jetcapadiv} Bonus divers" />
              </td>
              <td class="sheet-boxinputleft" style="width: 25%;">
                &nbsp;Voie :&nbsp;
                <select class="sheet-selectmin" name="attr_jetcapavoieno" title="@{jetcapavoieno}">
                  <option value="">-</option>
                  <option value="v1">1</option>
                  <option value="v2">2</option>
                  <option value="v3">3</option>
                  <option value="v4">4</option>
                  <option value="v5">5</option>
                  <option value="v6">6</option>
                  <option value="v7">7</option>
                  <option value="v8">8</option>
                  <option value="v9">9</option>
                </select>
                &nbsp;Rang :&nbsp;
                <select class="sheet-selectmin" name="attr_jetcapavoierang" title="@{jetcapavoierang}">
                  <option value="">-</option>
                  <option value="r1">1</option>
                  <option value="r2">2</option>
                  <option value="r3">3</option>
                  <option value="r4">4</option>
                  <option value="r5">5</option>
                </select>
                <input type="hidden" name="attr_jetcapavr" value="" />
              </td>
            </tr>
            <tr>
              <td>&nbsp;</td>
              <td class="sheet-boxinputleft" style="width: 25%;">
                <input type="text" name="attr_jetcapatitre" style="width:100%;" placeholder="Compétence (CARAC)"
                  title="@{jetcapatitre}" />
              </td>
              <td class="sheet-boxinputleft" colspan="3">
                <textarea name="attr_jetcapadesc" placeholder="Description" title="@{jetcapadesc}"></textarea>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
      <div class="sheet-subtab2-traits">
        <span class="sheet-textfatleft">Traits</span>
        <fieldset class="repeating_traits">
          <table class="sheet-tabsep">
            <tr>
              <td style="width: 15px;">
                <button type="roll" name="roll_pjtrait" class="sheet-output" title="%{repeating_traits_$N_pjtrait}"
                  value='@{togm} &{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=@{traitnom}}} {{subtags=@{traittype}}} {{text=@{traitdesc}}}'>
                  <span class="sheet-iconbtn">w</span>
                </button>
              </td>
              <td class="sheet-boxinputleft" style="width: 200px;">
                <input type="text" style="font-weight: bold;" name="attr_traitnom" placeholder="Nom du trait"
                  title="@{traitnom}" />
              </td>
              <td class="sheet-boxinputleft" style="width: 150px;">
                <input type="text" name="attr_traittype" placeholder="Origine/Type de trait" title="@{traittype}" />
              </td>
              <td class="sheet-boxinputleft">
                <textarea name="attr_traitdesc" placeholder="Description" title="@{traitdesc}"></textarea>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
      <div class="sheet-subtab2-buffs">
        <!-- BUFFS -->
        <div class="sheet-textfatleft">BUFFS
          <button 
            type="action"
            name="act_helpbuff-btn"
            class="sheet-iconbtn sheet-flatbtn"
            title="Aide BUFFS attributs"
          ><span class="sheet-iconbtn">i</span>
          </button>
        </div>
        <fieldset class="repeating_buffs">
          <table class="sheet-tabsep">
            <tr>
              <td class="sheet-boxinputleft" style="width: 250px;">
                <input type="checkbox" name="attr_buffon" title="@{buffon}" value="1" />
                <input type="text" style="font-weight: bold; width: 240px;" name="attr_buffnom"
                  placeholder="Nom du buff" title="@{buffnom}" />
              </td>
              <td class="sheet-boxinputleft">
                <input type="text" name="attr_buffmods" placeholder="Attribut : Valeur; Attribut : Valeur; ..."
                  title="@{buffmods}" />
              </td>
            </tr>
          </table>
        </fieldset>
        <details>
          <summary>Détail par attribut</summary>
          <table class="sheet-tabsep">
            <tr>
              <td style="width: 5%;">FOR:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_FOR_BUFF_LIST" />
                <span name="attr_FOR_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_FOR_BUFFS" value="@{FOR_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">DEX:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_DEX_BUFF_LIST" />
                <span name="attr_DEX_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_DEX_BUFFS" value="@{DEX_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">CON:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_CON_BUFF_LIST" />
                <span name=attr_CON_BUFF_LIST></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_CON_BUFFS" value="@{CON_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">INT:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_INT_BUFF_LIST" />
                <span name=attr_INT_BUFF_LIST></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_INT_BUFFS" value="@{INT_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">PER:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_PER_BUFF_LIST" />
                <span name="attr_PER_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_PER_BUFFS" value="@{PER_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">CHA:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_CHA_BUFF_LIST" />
                <span name="attr_CHA_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_CHA_BUFFS" value="@{CHA_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">ATC:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_ATKCAC_BUFF_LIST" />
                <span name="attr_ATKCAC_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_ATKCAC_BUFFS" value="@{ATKCAC_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">ATD:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_ATKTIR_BUFF_LIST" />
                <span name="attr_ATKTIR_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_ATKTIR_BUFFS" value="@{ATKTIR_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">MEN:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_ATKMEN_BUFF_LIST" />
                <span name="attr_ATKMEN_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_ATKMEN_BUFFS" value="@{ATKMEN_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">PIL:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_ATKPIL_BUFF_LIST" />
                <span name="attr_ATKPIL_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_ATKPIL_BUFFS" value="@{ATKPIL_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">MAG:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_ATKMAG_BUFF_LIST" />
                <span name="attr_ATKMAG_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_ATKMAG_BUFFS" value="@{ATKMAG_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">INIT:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_INIT_BUFF_LIST" />
                <span name="attr_INIT_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_INIT_BUFFS" value="@{INIT_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">DEF:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_DEF_BUFF_LIST" />
                <span name="attr_DEF_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_DEF_BUFFS" value="@{DEF_BUFF}" disabled />
              </td>
            </tr>
            <tr>
              <td style="width: 5%;">PV:</td>
              <td style="width: 90%; text-align: left;">
                <input class="sheet-buff" type="hidden" name="attr_PV_BUFF_LIST" />
                <span name="attr_PV_BUFF_LIST"></span>
              </td>
              <td style="width: 5%;">
                <input class="sheet-buff" type="number" name="attr_PV_BUFFS" value="@{PV_BUFF}" disabled />
              </td>
            </tr>
          </table>
        </details>
        <!-- FIN BUFFS -->
      </div>
    </div>
    <div class="sheet-tab-content sheet-tab3">
      <div>
        <!-- Equipement et ressources -->
        <div class="sheet-2colrow">
          <div class="sheet-col" title="repeating_equipement">
            <div class="sheet-boxtitre">Equipement
              <button 
                type="action"
                name="act_helpgear-btn"
                class="sheet-iconbtn sheet-flatbtn"
                style="color: white;"
                title="Aide équipement" 
              >
                <span class="sheet-iconbtn">i</span>
              </button>
            </div>
            <div class="sheet-boxinputleft">
              <span class="sheet-textbase">&nbsp;Argent :</span>
              <input type="text" style="width:180px;" name="attr_BOURSE" title="@{BOURSE}"
                placeholder="Rien ? C'est la pauvreté !" />
              Enc. Total :&nbsp;
              <input type="hidden" name="attr_total_enc" value="0" />
              <span name="attr_total_enc" title="@{total_enc} Encombrement total"></span>
              / <input type="number" name="attr_seuil_enc" title="@{seuil_enc} Seuil d'encombrement (FOR)" value="0" />
            </div>
            <fieldset class="repeating_equipement">
              <div class="sheet-boxvoie">
                <details>
                  <summary>
                    <input type="text" style="width: 230px;" name="attr_equip-desc" placeholder="Nom de l'équipement"
                      title="@{equip-desc}" />
                    <span class="sheet-textbase">Enc.</span>
                    <input type="number" name="attr_equip-enc" style="width: 30px;" value="0"
                      title="@{equip-enc} Encombrement" />
                    <span class="sheet-textbase">Nbre</span>
                    <input type="number" name="attr_equip-qte" style="width: 35px;" value="1"
                      title="@{equip-qte} Quantité portée/possédée" />
                    <input type="checkbox" name="attr_equip-on" value="1" title="@{equip-on} Equipement porté" />
                  </summary>
                  <textarea name="attr_equip-detail" title="@{equip-detail} Description détaillée"></textarea>
                  <br>
                  <input type="text" class="sheet-carac" style="width: 70%;" name="attr_equip-props"
                    title="@{equip-props} Propriétés de l'équipement" placeholder="Propriétés (DEF, DM, etc...)" />
                  <input type="checkbox" class="sheet-carac" name="attr_equip-atk" value="1"
                    title="@{equip-atk} Lié à une ligne d'attaque" />
                  A une attaque
                  <input type="hidden" name="attr_equip-atkid" value="" />
                </details>
              </div>
            </fieldset>
            <br>
            <div>
              <input type="checkbox" class="sheet-optional-block-switch" name="attr_coc_setting_bitume"
                value="1"><span></span>
              <div class="sheet-optional-block">
                <div class="sheet-boxtitre" style="margin: 5px 5px 5px 0; width: 100px;">
                  <button type="roll" class="sheet-boxtitre" name="roll_ud"
                    value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[@{QRYUD}cf<3]] }}">Usure
                    (Ud)</button>
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-col" title="repeating_ressources">
            <div class="sheet-boxtitre">Autres ressources</div>
            <fieldset class="repeating_ressources">
              <div class="sheet-boxvoie">
                <input type="text" style="width: 280px;" name="attr_res-desc" title="@{res-desc}" /> &nbsp;
                <span class="sheet-textbase">Valeur :</span>
                <input type="number" name="attr_res-nbr" value="1" title="@{res-val}" />
              </div>
            </fieldset>
          </div>
        </div>
        <div class="sheet-row">
          <div class="sheet-col" style="width: 100%;">
            <table class="sheet-tabsep">
              <tr>
                <td class="sheet-boxtitre">Notes</td>
              </tr>
              <tr>
                <td class="sheet-boxinputleft">
                  <textarea name="attr_notes" style="height:10em;" title="@{notes}"></textarea>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <img class="sheet-imghr"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      </div>
      <!-- FIN Equipement et ressources -->
    </div>
    <div class="sheet-tab-content sheet-tab4">
      <span class="sheet-align-right">
        <input type="checkbox" name="attr_debug_mode" value="1" title="Mode Debug">
        <button
          type="action"
          class="sheet-flatbtn sheet-iconbtn"
          name="act_resetattrib-btn"
          title="Re-calculer attributs (rangs, encombrement)"
        >
          <span class="sheet-iconbtn">x</span>
        </button>
      </span>
      <div class="sheet-2colrow">
        <!-- Config -->
        <div class="sheet-col">
          <div>
            <span class="sheet-textfatleft">PARAMETRES</span>
          </div>
          <ul>
            <li class="sheet-li">Jets :
              <select class="sheet-carac" style="width: 130px;" name="attr_togm" title="@{togm}" size="1">
                <option value="" selected>Publics</option>
                <option value="/w gm ">Chuchotés au MJ</option>
              </select>&nbsp;
              <select class="sheet-carac" style="width: 130px;" name="attr_token_dsp" title="@{token_dsp}" size="1">
                <option value="" selected>Sans token</option>
                <option value=" {{token=[x](@{token_url}) }} ">Avec token</option>
              </select>
            </li>
            <li class="sheet-li">Setting :
              <select class="sheet-carac" style="width: 140px;" name="attr_coc_setting" size="1">
                <option value="" selected>Choisir...</option>
                <option value="cthulhu">Cthulhu/Epouvante</option>
                <option value="pulp">Pulp</option>
                <option value="postapo">Post-Apocalypse</option>
                <option value="surhumain">Surhumains</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="shadowrun">Cyber+Fantasy</option>
                <option value="menacex">Menace-X</option>
                <option value="bitume">Bitume</option>
                <option value="monstres">Monstres</option>
              </select>
            </li>
            <li class="sheet-li">Type de surhumain :
              <select class="sheet-carac" style="width: 140px;" name="attr_coc_surh" size="1">
                <option value="" selected>Choisir...</option>
                <option value="ange">Ange</option>
                <option value="demon">Démon</option>
                <option value="garou">Loup-garou</option>
                <option value="vampire">Vampire</option>
                <optgroup label="Être féérique">
                  <option disabled class="sheet-optgroup">&nbsp;Être féérique</option>
                  <option value="fee-dragon">Dragon</option>
                  <option value="fee-dryade">Dryade</option>
                  <option value="fee-dwergar">Dwergar</option>
                  <option value="fee-gobelin">Gobelin</option>
                  <option value="fee-lutin">Lutin</option>
                  <option value="fee-ogre">Ogre</option>
                </optgroup>
                <optgroup label="Mutant">
                  <option disabled class="sheet-optgroup">&nbsp;Mutant</option>
                  <option value="mutant-endo">Endo-actif</option>
                  <option value="mutant-exo">Exo-actif</option>
                  <option value="mutant-psycho">Psycho-actif</option>
                </optgroup>
              </select>
            </li>
            <li class="sheet-li">Initiative :
              <select class="sheet-carac" style="width: 90px;" name="attr_INIT_JET" title="@{INIT_JET}" size="1">
                <option value="@{INIT}" selected>Normale</option>
                <option value="[[@{INIT}]]+1d6!">Variable</option>
                <option value="{[[@{INIT}]]+1d6!, ([[@{INIT}]]*2)+0d6}kl1">Cyberpunk</option>
              </select>
            </li>
            <li class="sheet-li">Attaques :
              <ul>
                <li>MENtale :
                  <input type="checkbox" name="attr_option_atkmen" value="1" title="@{option_atkmen}" />
                </li>
                <li>PSI (Menace-X) :
                  <input type="checkbox" name="attr_option_atkpsi" value="1" title="@{option_atkpsi}" />
                </li>
                <li>PILotage (Bitume) :
                  <input type="checkbox" name="attr_option_atkpil" value="1" title="@{option_atkpil}" />
                </li>
              </ul>
            </li>
            <li class="sheet-li">Défense PSI (Menace-X) :
              <input type="checkbox" name="attr_option_defpsi" value="1" title="@{option_defpsi}" />
            </li>
            <li>Magie :
              <ul>
                <li>Attaque magique :
                  <input type="checkbox" name="attr_option_atkmag" value="1" title="@{option_atkmag}" />
                </li>
                <li>Points de Mana :
                  <input type="checkbox" name="attr_option_pm" value="1" title="@{option_pm}" />
                </li>
              </ul>
            </li>
            <li class="sheet-li">Points de Récupération :
              <input type="checkbox" name="attr_option_pr" value="1" title="@{option_pr}" checked />
            </li>
            <li class="sheet-li">Gérer l'encombrement :
              <input type="checkbox" name="attr_use_encombrement" title="@{use_encombrement} Gérer l'encombrement"
                value="1" />
            </li> <!--
            <li>Attributs hors-fiche pour les capacités :
              <ul title="@{hors_fiche}" style="list-style-type: none; margin: 0;">
                <li><input type="radio" class="sheet-carac" name="attr_hors_fiche" value="none" selected />
                  &nbsp;Ne pas créer d'attributs hors-fiche
                </li>
                <li><input type="radio" class="sheet-carac" name="attr_hors_fiche" value="direct" />
                  &nbsp;Créer un attribut par capacité, préfixé par
                  <input type="text" class="sheet-carac" style="width: 60px;" name="attr_hors_fiche_pfx" value="cap" />
                </li>
                <li><input type="radio" class="sheet-carac" name="attr_hors_fiche" value="serial" />
                  &nbsp;Créer un attribut sérialisé unique ('capacites')
                </li>
              </ul>
            </li> -->
          </ul>
        </div>
        <div class="sheet-col">
          <div>
            <span class="sheet-textfatleft">COMPTEURS</span>
          </div>
          <ul>
            <li class="sheet-li">Points de Chance :
              <input type="checkbox" name="attr_option_pc" value="1" title="@{option_pc}" checked />
              <ul>
                <li title="Points de Choc, de Cash, de Style, etc...">Intitulé :<br>
                  <input type="text" name="attr_PC_DESC_PLUR" style="width: 120px;" title="@{PC_DESC_PLUR}"
                    placeholder="Pluriel" />
                    <input type="text" name="attr_PC_DESC_SNGL" style="width: 120px;" title="@{PC_DESC_SNGL}"
                    placeholder="Singulier" />
                    <input type="text" name="attr_PC_DESC_ABRV" style="width: 40px;" title="@{PC_DESC_ABRV}"
                    placeholder="Abréviation" />
                </li>
                <li>Valeur de bonus :<br>
                  <input type="text" style="width: 280px;" name="attr_PC_BONUS" title="@{PC_BONUS}" />
                </li>
              </ul>
            </li>
            <li class="sheet-li">Compteur no 1 :
              <input type="checkbox" name="attr_option_cpt1" value="1" title="@{option_cpt1}" />
              <ul>
                <li title="Points de Folie, de Tension, de Pulsion, etc...">Intitulé :<br>
                  <input type="text" style="width: 120px;" name="attr_cpt1_desc_plur" title="@{cpt1_desc_plur}"
                    placeholder="Pluriel" />
                  <input type="text" style="width: 120px;" name="attr_cpt1_desc_sngl" title="@{cpt1_desc_sngl}"
                    placeholder="Singulier" />
                  <input type="text" style="width: 40px;" name="attr_cpt1_desc_abrv" title="@{cpt1_desc_abrv}"
                    placeholder="Abréviation" />
                </li>
              </ul>
            </li>
            <li class="sheet-li">Compteur no 2 :
              <input type="checkbox" name="attr_option_cpt2" value="1" title="@{option_cpt2}" />
              <ul>
                <li title="Points de Folie, de Tension, de Pulsion, etc...">Intitulé :<br>
                  <input type="text" style="width: 120px;" name="attr_cpt2_desc_plur" title="@{cpt2_desc_plur}"
                    placeholder="Pluriel" />
                  <input type="text" style="width: 120px;" name="attr_cpt2_desc_sngl" title="@{cpt2_desc_sngl}"
                    placeholder="Singulier" />
                  <input type="text" style="width: 40px;" name="attr_cpt2_desc_abrv" title="@{cpt2_desc_abrv}"
                    placeholder="Abréviation" />
                </li>
              </ul>
            </li>
            <li class="sheet-li">Compteur no 3 :
              <input type="checkbox" name="attr_option_cpt3" value="1" title="@{option_cpt3}" />
              <ul>
                <li title="Points de Folie, de Tension, de Pulsion, etc...">Intitulé :<br>
                  <input type="text" style="width: 120px;" name="attr_cpt3_desc_plur" title="@{cpt3_desc_plur}"
                    placeholder="Pluriel" />
                  <input type="text" style="width: 120px;" name="attr_cpt3_desc_sngl" title="@{cpt3_desc_sngl}"
                    placeholder="Singulier" />
                  <input type="text" style="width: 40px;" name="attr_cpt3_desc_abrv" title="@{cpt3_desc_abrv}"
                    placeholder="Abréviation" />
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <!-- FIN Config -->
      <img class="sheet-imghr"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      <div class="sheet-row">
        <details>
          <summary>Importer profil</summary>
          <div class="sheet-2colrow">
            <div class="sheet-col">
              <textarea
              class="sheet-boxinputleft sheet-statblock"
              name="attr_json_profile"
            ></textarea>
            </div>
            <div class="sheet-col">
              <button 
                type="roll" 
                name="roll_exportcomob" 
                class="sheet-flatbtn sheet-iconbtn" 
                title="Exporter le profil"
                value="[Export Chroniques Mobiles](https://comob-data.rpgapps.net)">
                <span class="sheet-iconbtn">c</span>&nbsp;Export Chroniques Mobiles
              </button>
              <br>
              Composez votre profil avec l'application Export Chroniques Mobiles et insérez le code JSON dans le champ ci-contre
              <br>
              <button
                type="action"
                name="act_importprofile-btn"
                class="sheet-flatbtn sheet-iconbtn"
                title="Importer le profil"
              >
                <span class="sheet-iconbtn">W</span>&nbsp;Importer
              </button>
              <input type="checkbox" name="attr_reset_gears" value="1">
              <span>Réinitialiser les listes armes & équipement</span>
            </div>
          </div>
        </details>
      </div>
    </div>
    <div class="sheet-tab-content sheet-tab5">
      <div class="sheet-2colrow">
        <!-- Notes de Version -->
        <div class="sheet-col">
          <div>
            <span class="sheet-textfatleft">NOTES DE VERSION</span> (v<span name="attr_VERSION"></span>)
          </div>
          <div class="sheet-scroll-400">
            <ul class="sheet-release-notes">
              <li>
                <details>
                  <summary>
                    <strong>Version 3.19.0</strong> (2024.08.24)
                  </summary>
                  <ul>
                    <em>Fiche de personnage</em>
                    <li>
                      Gestion des capacités avec nombre d'utilisations limitées
                      <ul>
                        <li>Configuration dans l'onglet Capacités</li>
                        <li>Décompte d'utilisation, message d'alerte, bouton de rechargement</li>
                        <li>Configuration auto à l'import d'un profil</li>
                      </ul>
                    </li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.18.0</strong> (2024.06.24)
                  </summary>
                  <ul>
                    <li>Compatibilité "CSE" Roll20</li>
                    <li>Modifications cosmétiques capacités & équipement</li>
                    <li>Correction valeurs par défaut des lignes d'attaque</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.17.0</strong> (2024.05.01)
                  </summary>
                  <ul>
                    <em>Fiche de personnage</em>
                    <li>
                      Ajout de 3 sous-onglets à l'onglet Capacités pour le désencombrer
                      <ul>
                        <li>Jets de capacités</li>
                        <li>Traits</li>
                        <li>Buffs</li>
                      </ul>
                    </li>
                  </ul>
                </details>
              </li>
              <details>
                <summary>
                  <strong>Version 3.16.1</strong> (2023.10.22)
                </summary>
                <li>
                  <ul>
                    <em>Fiche de PNJ</em>
                    <li>Correction des noms des boutons de jets de Caractéristiques</li>
                  </ul>
                </li>
              </details>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.16.0</strong> (2023.09.17)
                  </summary>
                  <ul>
                    <em>Fiche de personnage - Import de profil JSON</em>
                    <li>Ajout armes & équipement</li>
                    <li>Ajout scores d'attaques, bonus d'INIT, DV</li>
                    <li>Calcul PV et PC au niveau 1</li>
                    <li>Correction bug création attaque via propriétés équipements (prise en compte ATD:xxx)</li>
                    <li>Ajout messages d'aide sur les BUFFs et les propriétés d'équipements</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.15.0</strong> (2023.04.30)
                  </summary>
                  <ul>
                    <em>Fiche de personnage</em>
                    <li>Suppression du calcul automatique des PV par niveau</li>
                    <li>Nouvelle onglet "Version"</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.14.0</strong> (2023.02.11)
                  </summary>
                  <ul>
                    <li>Ajout compteurs 2 & 3 (avec création/maj attribut cptr_xxx où xxx = abréviation)</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.13.0</strong> (2022.10.16)
                  </summary>
                  <ul>
                    <li>Ajout d'une section notes de version sur l'onglet configuration</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.12.0</strong> (2022.04.10)
                  </summary>
                  <ul>
                    <li>Modification cosmétique des groupes d'options dans les listes déroulantes</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.11.0</strong> (2022.01.16)
                  </summary>
                  <ul>
                    <li>Possibilité de choisir le mod de test (mod carac + buff/debuff) dans les bonus aux DM des attaques</li>
                    <li>Possibilité d'afficher le token du personnage dans les jets de dés de la fiche</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.10.1</strong> (2021.12.18)
                  </summary>
                  <ul>
                    <em>Correction de bugs</em>
                    <li>Dysfonctionnement des boutons d'états préjudiciables</li>
                    <li>Libellé du modificateur d'attaque persistant malgré annulation</li>
                    <li>Meilleur support des modificateurs de DM sous forme de jets de dés</li>
                    <li>Affichage incorrect en cas de sélection du ssetting 'Surhumains'</li>
                    <li>Affichage de la version de la fiche sur l'onglet Configuratopn</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.10.0</strong> (2021.11.12)
                  </summary>
                  <ul>
                    <li>Ajout du token par défaut sur la fiche de personnage</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.9.2</strong> (2021.04.27)                    
                  </summary>
                  <ul>
                    <li>Correction d'un bug sur le titre de la capacité de rang 2 de la voie n°4</li>
                    <li>Correction du calcul du rang dans une voie : la case doit être cochée et soit le titre soit le texte de la capacité doit être renseigné</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.9.2</strong> (2021.04.25)
                  </summary>
                  <ul>
                    <li>Correction d'un bug sur le titre de la capacité de rang 3 de la voie n°3 dupliquée dans la voie n°8</li>
                  </ul>
                </details>
              </li>
              <li>
                <details>
                  <summary>
                    <strong>Version 3.9.0</strong> (2021.03.30)
                  </summary>
                  <ul>
                    <li>Ajout d'un champ titre pour chaque capacité (attributs @{voieN-tR} où N = no de voie et R = rang)
                      <ul>
                        <li>Migration d'une version antérieure : la première ligne de la capacité est utilisée comme titre</li>
                        <li>Prise en compte dans les autres fonctions (liaison d'un jet de capacité à une voie+rang, import de données de profil JSON)</li>
                      </ul>
                    </li>
                    <li>Correction d'un bug après suppression du seul modificateur d'attaque ou de DM de la liste (le modificateur n'est plus pris en compte dans les jets d'attaque)</li>
                  </ul>
                </details>
              </li>
            </ul>
          </div>
        </div>
        <div class="sheet-col">
          <div>
            <span class="sheet-textfatleft">LOG</span>
          </div>
          <textarea 
            class="sheet-statblock" 
            readonly="true" 
            name="attr_logvers"
            title="Compte-rendu des migrations pour les mises à jour majeures de la fiche"
          ></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="sheet-tab-content sheet-fp2">
    <div>
      <input type="checkbox" class="sheet-block-switch" style="display: none;" name="attr_coc_setting_bitume" value="1">
      <div class="sheet-block-hidden">
        <div>
          <!-- Véhicule -->
          <table class="sheet-tabsep">
            <tr>
              <td class="sheet-textbase" colspan="3">Description :
                <input type="text" class="sheet-nobox" style="width: 75%;" name="attr_VEHICULE_DESC"
                  title="@{VEHICULE_DESC} Description du véhicule" />
              </td>
              <td class="sheet-textbase" colspan="2">Pilote :
                <input type="text" class="sheet-nobox" style="width: 75%;" name="attr_PILOTE"
                  title="@{PILOTE} Nom du pilote" />
              </td>
            </tr>
            <tr>
              <td class="sheet-boxtitre" style="width: 15%;">FOR</td>
              <td class="sheet-boxtitre" style="width: 15%;">AGI</td>
              <td class="sheet-boxtitre" style="width: 25%;">PV</td>
              <td class="sheet-boxtitre" style="width: 35%;">DEF</td>
              <td class="sheet-boxtitre" style="width: 10%;">Blindage (RD)</td>
            </tr>
            <tr>
              <td class="sheet-boxinput">
                <input type="number" name="attr_FOV" value="0" title="@{FOV} Force du véhicule" />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_AGI" value="0" title="@{AGI} Agilité du véhicule" />
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_PVV" value="0" title="@{PVV} Points de Vie courants" /> &nbsp;/&nbsp;
                <input type="number" name="attr_PVV_max" value="0" title="@{PVV|max} Points de Vie MAX" />
              </td>
              <td class="sheet-boxinput">&nbsp;Base :&nbsp;
                <input type="number" name="attr_DEFV_BASE" value="0" title="@{DEFV_BASE} DEF de base" /> + DEX :
                <input type="number" name="attr_DEFV_DEX" value="0" title="@{DEFV_DEX} DEX du pilote" /> =
                <input type="hidden" name="attr_DEFV" value=""/>
                <span name="attr_DEFV" title="@{DEFV} DEF du véhicule"></span>
              </td>
              <td class="sheet-boxinput">
                <input type="number" name="attr_RDV" value="0" title="@{RDV} Blindage" />
              </td>
            </tr>
          </table>
          <br>
          <div class="sheet-2colrow">
            <div class="sheet-col">
              <div class="sheet-row sheet-boxtitre">Equipement</div>
              <div class="sheet-row">
                <textarea class="sheet-boxinputleft" style="height: 6vh;" name="attr_vehicule_eqp" title="@{vehicule_eqp} Equipement du véhicule"></textarea>
              </div>
            </div>
            <div class="sheet-col">
              <div class="sheet-row sheet-boxtitre">Notes</div>
              <div class="sheet-row">
                <textarea class="sheet-boxinputleft" style="height: 6vh;" name="attr_vehicule_notes" title="@{vehicule_notes}"></textarea>
              </div>
            </div>
          </div>
          <br>
          <div class="sheet-row">
            <span class="sheet-textfatleft">Jets du véhicule</span>&nbsp;
          </div>
          <fieldset class="repeating_jetv">
            <table class="sheet-tabsep">
              <tr>
                <td>
                  <button type="roll" class="sheet-neutre" name="roll_vehicule"
                    title="%{repeating_jetv_$N_vehicule} Jet de véhicule"
                    value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=@{jetvnom}}} {{subtags=@{VEHICULE_DESC}}} {{carac=[[@{jetvnbde}d@{jetvde}@{jetvtypjet} + [[@{jetvcaracp}]][Bonus] + [[@{jetvcarac}]][Véhicule] + @{jetvdiv}[Divers] ]]}} {{desc=@{jetvdesc}}}" 
                  />
                </td>
                <td class="sheet-boxinputleft" style="min-width:200px;">
                  <input type="text" name="attr_jetvnom" title="@{jetvnom}" style="font-weight: bold;"
                    placeholder="Nom du Jet de véhicule" />
                </td>
                <td class="sheet-boxinputleft">
                  <input type="number" style="width:32px;" name="attr_jetvnbde" value="1"
                    title="@{jetvnbde} Nombre de dés" />
                  <select class="sheet-carac" style="width:50px;" name="attr_jetvde" size="1" title="@{jetvde} Dé">
                    <option value="@{ETATDE}" selected>d20 (d12 si Affaibli)</option>
                    <optgroup label="Jet normal">
                      <option disabled class="sheet-optgroup">&nbsp;Jet standard</option>
                      <option value="4">d4</option>
                      <option value="6">d6</option>
                      <option value="8">d8</option>
                      <option value="10">d10</option>
                      <option value="12">d12</option>
                    </optgroup>
                    <optgroup label="Jet explosif">
                      <option disabled class="sheet-optgroup">&nbsp;Jet explosif</option>
                      <option value="4!">d4+</option>
                      <option value="6!">d6+</option>
                      <option value="8!">d8+</option>
                      <option value="10!">d10+</option>
                      <option value="12!">d12+</option>
                    </optgroup>
                  </select>
                  (
                  <select class="sheet-carac" style="width:30px;" name="attr_jetvtypjet" size="1"
                    title="@{jetvtypjet} Type de jet : normal, meilleur dé, moins bon dé">
                    <option value="">N - Normal / Addition</option>
                    <option value="kh1">S - Garder le meilleur dé</option>
                    <option value="kl1">I - Garder le moins bon dé</option>
                  </select>
                  ) +
                  <select class="sheet-carac" style="width:65px;" name="attr_jetvcaracpil" size="1"
                    title="@{jetvcaracp} Mod. du personnage">
                    <option value="0" selected>-</option>
                    <optgroup label="Mod. de Base">
                      <option disabled class="sheet-optgroup">&nbsp;Mod. de base</option>
                      <option value="@{FOR}">FOR</option>
                      <option value="@{DEX}">DEX</option>
                      <option value="@{CON}">CON</option>
                      <option value="@{INT}">INT</option>
                      <option value="@{PER}">PER</option>
                      <option value="@{CHA}">CHA</option>
                    </optgroup>
                    <optgroup label="Mod. de Test">
                      <option disabled class="sheet-optgroup">&nbsp;Mod. de test</option>
                      <option value="@{FOR_TEST}">FOR(t)</option>
                      <option value="@{DEX_TEST}">DEX(t)</option>
                      <option value="@{CON_TEST}">CON(t)</option>
                      <option value="@{INT_TEST}">INT(t)</option>
                      <option value="@{PER_TEST}">PER(t)</option>
                      <option value="@{CHA_TEST}">CHA(t)</option>
                    </optgroup>
                    <optgroup label="Attaques">
                      <option disabled class="sheet-optgroup">&nbsp;Attaques</option>
                      <option value="@{ATKCAC}">ATC</option>
                      <option value="@{ATKTIR}">ATD</option>
                      <option value="@{ATKMEN}">MEN</option>
                      <option value="@{ATKMAG}">MAG</option>
                    </optgroup>
                  </select>
                  +
                  <select class="sheet-carac" style="width:50px;" name="attr_jetvcarac" size="1"
                    title="@{jetvcarac} Mod. du véhicule">
                    <option value="0" selected>-</option>
                    <option value="@{FOV}">FOR</option>
                    <option value="@{AGI}">AGI</option>
                  </select>
                  +
                  <input type="number" style="width:32px;" name="attr_jetvdiv" value="0"
                    title="@{jetvdiv} Bonus divers" />
                  <input type="hidden" name="attr_jetvcaracp" value="0" />
                </td>
                <td class="sheet-boxinputleft" style="width:100%;">
                  <textarea name="attr_jetvdesc" placeholder="Description" title="@{jetvdesc}"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
          <img class="sheet-imghr"
            src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </div>
      </div>
      <div class="sheet-block-show">
        <div>
          <!-- Véhicule Bitume -->
          <div class="sheet-2colrow">
            <div class="sheet-col">
              <table class="sheet-tabsep">
                <tr>
                  <td class="sheet-textfatleft" colspan="4">Description :<br>
                    <textarea type="text" class="sheet-nobox" style="border: 1px solid; height: 6em;"
                      name="attr_VEHICULE_DESC" title="@{VEHICULE_DESC}">
                    </textarea>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-textfatleft" colspan="4">Pilote :
                    <input type="text" class="sheet-nobox" name="attr_PILOTE" title="@{PILOTE} Nom du pilote" />
                  </td>
                  <td colspan="3">&nbsp;</td>
                </tr>
              </table>
              <br>
              <span class="sheet-textfatleft">Modifications :</span>
              <input type="hidden" name="attr_vbemp_total" value="0" />
              <fieldset class="repeating_vbmods">
                <div class="sheet-boxvoie">
                  <details>
                    <summary>
                      <input type="text" style="width: 250px;" name="attr_vbmod-desc" placeholder="Modification"
                        title="@{vbmod-desc}" />
                      <span class="sheet-textbase">Emp.</span>
                      <input type="number" name="attr_vbmod-emp" style="width: 30px;" value="1"
                        title="@{vbmod-emp} Emplacements" />
                      <span class="sheet-textbase">Coût</span>
                      <input type="number" name="attr_vbmod-res" style="width: 30px;" value="0"
                        title="@{vbmod-res} Coût (R)" />
                    </summary>
                    <textarea name="attr_vbmod-effet" placeholder="Effet de la modification"
                      title="@{vbmod-effet} Effet"></textarea>
                    <br>
                    <input type="text" style="width: 95%;" name="attr_vbmod-buffs" placeholder="Ex : RAP : +1" value=""
                      title="@{vbmod-buffs}" />
                    <input type="checkbox" name="attr_vbmod-on" value="1" title="@{vbmod-on} Active ?" />
                  </details>
                </div>
              </fieldset>
            </div>
            <div class="sheet-col">
              <table class="sheet-tabsep">
                <tr>
                  <td></td>
                  <td class="sheet-text">Base</td>
                  <td class="sheet-text">Divers</td>
                  <td class="sheet-textfat">Total</td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre" style="width: 25%;" title="Rapidité">RAP</td>
                  <td class="sheet-boxinput" style="width: 25%;"><input type="number" name="attr_vbrap_base"
                      value="0" /></td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbrap_div" value="0" />
                    <span name="attr_vbrap_div"></span>
                  </td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbrap" value="0" />
                    <span name="attr_vbrap"></span>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre" style="width: 25%;" title="Maniabilité">MAN</td>
                  <td class="sheet-boxinput" style="width: 25%;"><input type="number" name="attr_vbman_base"
                      value="0" /></td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbman_div" value="0" />
                    <span name="attr_vbman_div"></span>
                  </td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbman" value="0" />
                    <span name="attr_vbman"></span>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre" style="width: 25%;" title="Impact">IMP</td>
                  <td class="sheet-boxinput" style="width: 25%;"><input type="number" name="attr_vbimp_base"
                      value="0" /></td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbimp_div" value="0" />
                    <span name="attr_vbimp_div"></span>
                  </td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbimp" value="0" />
                    <span name="attr_vbimp"></span>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre" style="width: 25%;" title="Emplacements">EMP</td>
                  <td class="sheet-boxinput" style="width: 25%;"><input type="number" name="attr_vbemp_base"
                      value="0" /></td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbemp_div" value="0" />
                    <span name="attr_vbemp_div"></span>
                  </td>
                  <td class="sheet-boxinputlight" style="width: 25%;">
                    <input type="hidden" name="attr_vbemp" value="0" />
                    <span name="attr_vbemp"></span>
                  </td>
                </tr>
              </table>
              <table class="sheet-tabsep">
                <tr>
                  <td class="sheet-boxtitre" style="width: 25%;" title="Défense">DEF</td>
                  <td class="sheet-boxinputlight" style="width: 10%;">10+</td>
                  <td class="sheet-boxinputlight" style="width: 15%;"><span name="attr_vbimp"></span></td>
                  <td class="sheet-boxinputlight" style="width: 15%;"><span name="attr_vbman"></span></td>
                  <td class="sheet-boxinput" style="width: 20%;"><input type="number" name="attr_vbdef_div" value="0" />
                  </td>
                  <td class="sheet-boxinputlight" style="width: 15%;">
                    <input type="hidden" name="attr_vbdef" value="0" />
                    <span name="attr_vbdef"></span>
                  </td>
                </tr>
              </table>
              <br>
              <table class="sheet-tabsep">
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-nod20 sheet-boxtitre" name="roll_vbud"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d@{vbud}cf<3]] }}">&nbsp;UD&nbsp;</button>
                  </td>
                  <td class="sheet-textfatleft">Dés d'Usure</td>
                  <td>
                    <select class="sheet-selectmin" style="width: 30px;" name="attr_vbudmax">
                      <option value="12">d12</option>
                      <option value="10">d10</option>
                      <option value="8">d8</option>
                      <option value="6">d6</option>
                      <option value="4">d4</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-roll-d12 sheet-boxtitre" name="roll_vbud12"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d12cf<3]] }}">
                      Ud12</button>
                  </td>
                  <td class="sheet-textfatleft">
                    <input type="checkbox" name="attr_vbud12_1" value="1">
                    <input type="checkbox" name="attr_vbud12_2" value="1">
                    <input type="checkbox" name="attr_vbud12_3" value="1">
                    <input type="checkbox" name="attr_vbud12_4" value="1">|
                    <input type="checkbox" name="attr_vbud12_5" value="1">
                    <input type="checkbox" name="attr_vbud12_6" value="1">
                    <input type="checkbox" name="attr_vbud12_7" value="1">
                    <input type="checkbox" name="attr_vbud12_8" value="1">|
                    <input type="checkbox" name="attr_vbud12_9" value="1">
                    <input type="checkbox" name="attr_vbud12_10" value="1">
                    <input type="checkbox" name="attr_vbud12_11" value="1">
                    <input type="checkbox" name="attr_vbud12_12" value="1">
                  </td>
                  <td>
                    <input type="radio" name="attr_vbud" value="12" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-roll-d10 sheet-boxtitre" name="roll_vbud10"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d10cf<3]] }}">
                      Ud10</button>
                  </td>
                  <td class="sheet-textfatleft">
                    <input type="checkbox" name="attr_vbud10_1 value=" 1">
                    <input type="checkbox" name="attr_vbud10_2 value=" 1">
                    <input type="checkbox" name="attr_vbud10_3 value=" 1">
                    <input type="checkbox" name="attr_vbud10_4 value=" 1">|
                    <input type="checkbox" name="attr_vbud10_5 value=" 1">
                    <input type="checkbox" name="attr_vbud10_6 value=" 1">
                    <input type="checkbox" name="attr_vbud10_7 value=" 1">
                    <input type="checkbox" name="attr_vbud10_8 value=" 1">|
                    <input type="checkbox" name="attr_vbud10_9 value=" 1">
                    <input type="checkbox" name="attr_vbud10_10 value=" 1">
                  </td>
                  <td>
                    <input type="radio" name="attr_vbud" value="10" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-roll-d8 sheet-boxtitre" name="roll_vbud8"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d8cf<3]] }}">
                      Ud8</button>
                  </td>
                  <td class="sheet-textfatleft">
                    <input type="checkbox" name="attr_vbud8_1" value="1">
                    <input type="checkbox" name="attr_vbud8_2" value="1">
                    <input type="checkbox" name="attr_vbud8_3" value="1">
                    <input type="checkbox" name="attr_vbud8_4" value="1">|
                    <input type="checkbox" name="attr_vbud8_5" value="1">
                    <input type="checkbox" name="attr_vbud8_6" value="1">
                    <input type="checkbox" name="attr_vbud8_7" value="1">
                    <input type="checkbox" name="attr_vbud8_8" value="1">
                  </td>
                  <td>
                    <input type="radio" name="attr_vbud" value="8" selected />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-roll-d6 sheet-boxtitre" name="roll_vbud6"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d6cf<3]] }}">
                      Ud6</button>
                  </td>
                  <td class="sheet-textfatleft">
                    <input type="checkbox" name="attr_vbud6_1" value="1">
                    <input type="checkbox" name="attr_vbud6_2" value="1">
                    <input type="checkbox" name="attr_vbud6_3" value="1">
                    <input type="checkbox" name="attr_vbud6_4" value="1">|
                    <input type="checkbox" name="attr_vbud6_5" value="1">
                    <input type="checkbox" name="attr_vbud6_6" value="1">
                  </td>
                  <td>
                    <input type="radio" name="attr_vbud" value="6" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">
                    <button type="roll" class="sheet-roll-d4 sheet-boxtitre" name="roll_vbud4"
                      value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Usure}} {{subtags=Test}} {{carac=[[d4cf<3]] }}">
                      Ud4</button>
                  </td>
                  <td class="sheet-textfatleft">
                    <input type="checkbox" name="attr_vbud4_1" value="1">
                    <input type="checkbox" name="attr_vbud4_2" value="1">
                    <input type="checkbox" name="attr_vbud4_3" value="1">
                    <input type="checkbox" name="attr_vbud4_4" value="1">
                  </td>
                  <td>
                    <input type="radio" name="attr_vbud" value="4" />
                  </td>
                </tr>
                <tr>
                  <td class="sheet-boxtitre">Ud0</td>
                  <td></td>
                  <td>
                    <input type="radio" name="attr_vbud" value="0" />
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <img class="sheet-imghr"
            src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
          <div class="sheet-row">
            <span class="sheet-textfatleft">Jets du véhicule</span>
          </div>
          <fieldset class="repeating_jetv">
            <table class="sheet-tabsep">
              <tr>
                <td>
                  <button type="roll" class="sheet-neutre" name="roll_vehicule"
                    title="%{repeating_jetv_$N_vehicule} Jet de véhicule"
                    value="@{togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=@{jetvnom}}} {{subtags=@{VEHICULE}}} {{carac=[[@{jetvnbde}d@{jetvde}@{jetvtypjet} + [[@{jetvcaracp}]][Bonus] + [[@{jetvcarac}]][Véhicule] + @{jetvdiv}[Divers] ]]}} {{desc=@{jetvdesc}}}" />
                </td>
                <td class="sheet-boxinputleft" style="min-width:180px;">
                  <input type="text" name="attr_jetvnom" title="@{jetvnom}" style="font-weight: bold;"
                    placeholder="Nom du Jet de véhicule" />
                </td>
                <td class="sheet-boxinputleft">
                  <input type="number" style="width:32px;" name="attr_jetvnbde" value="1"
                    title="@{jetvnbde} Nombre de dés" />
                  <select class="sheet-carac" style="width:50px;" name="attr_jetvde" size="1" title="@{jetvde} Dé">
                    <option value="@{ETATDE}" selected>d20 (d12 si Affaibli)</option>
                    <optgroup label="Jet standard">
                      <option disabled class="sheet-optgroup">&nbsp;Jet standard</option>
                      <option value="4">d4</option>
                      <option value="6">d6</option>
                      <option value="8">d8</option>
                      <option value="10">d10</option>
                      <option value="12">d12</option>
                    </optgroup>
                    <optgroup label="Jet explosif">
                      <option disabled class="sheet-optgroup">&nbsp;Jet explosif</option>
                      <option value="4!">d4</option>
                      <option value="6!">d6</option>
                      <option value="8!">d8</option>
                      <option value="10!">d10</option>
                      <option value="12!">d12</option>
                    </optgroup>
                  </select>
                  (
                  <select class="sheet-carac" style="width:30px;" name="attr_jetvtypjet" size="1"
                    title="@{jetvtypjet} Type de jet : normal, meilleur dé, moins bon dé">
                    <option value="">N - Normal / Addition</option>
                    <option value="kh1">S - Garder le meilleur dé</option>
                    <option value="kl1">I - Garder le moins bon dé</option>
                  </select>
                  ) +
                  <select class="sheet-carac" style="width:70px;" name="attr_jetvcaracpil" size="1"
                    title="@{jetvcaracp} Mod. du personnage">
                    <option value="0" selected>-</option>
                    <optgroup label="Mod. de Base">
                      <option disabled class="sheet-optgroup">&nbsp;Mod. de base</option>
                      <option value="@{FOR}">FOR</option>
                      <option value="@{DEX}">DEX</option>
                      <option value="@{CON}">CON</option>
                      <option value="@{INT}">INT</option>
                      <option value="@{PER}">PER</option>
                      <option value="@{CHA}">CHA</option>
                    </optgroup>
                    <optgroup label="Mod. de Test">
                      <option disabled class="sheet-optgroup">&nbsp;Mod. de test</option>
                      <option value="@{FOR_TEST}">FOR(t)</option>
                      <option value="@{DEX_TEST}">DEX(t)</option>
                      <option value="@{CON_TEST}">CON(t)</option>
                      <option value="@{INT_TEST}">INT(t)</option>
                      <option value="@{PER_TEST}">PER(t)</option>
                      <option value="@{CHA_TEST}">CHA(t)</option>
                    </optgroup>
                    <optgroup label="Attaques">
                      <option disabled class="sheet-optgroup">&nbsp;Attaques</option>
                      <option value="@{ATKCAC}">ATC</option>
                      <option value="@{ATKTIR}">ATD</option>
                      <option value="@{ATKPIL}">PIL</option>
                    </optgroup>
                  </select>
                  +
                  <select class="sheet-carac" style="width:50px;" name="attr_jetvcarac" size="1"
                    title="@{jetvcarac} Mod. du véhicule">
                    <option value="0" selected>-</option>
                    <option value="@{vbrap}">RAP</option>
                    <option value="@{vbman}">MAN</option>
                    <option value="@{vbimp}">IMP</option>
                  </select>
                  +
                  <input type="number" style="width:32px;" name="attr_jetvdiv" value="0"
                    title="@{jetvdiv} Bonus divers" />
                  <input type="hidden" name="attr_jetvcaracp" value="" />
                </td>
                <td class="sheet-boxinputleft" style="width:100%;">
                  <textarea name="attr_jetvdesc" placeholder="Description" title="@{jetvdesc}"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
        </div>
        <img class="sheet-imghr"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
      </div>
      <details>
        <summary class="sheet-textfatleft">PARAMETRES</summary>
        <ul>
          <li>Jets :
            <select class="sheet-carac" style="width: 130px;" name="attr_togm" title="@{togm}" size="1">
              <option value="" selected>Publics</option>
              <option value="/w gm ">Chuchotés au MJ</option>
            </select>&nbsp;
              <select class="sheet-carac" style="width: 130px;" name="attr_token_dsp" title="@{token_dsp}" size="1">
                <option value="" selected>Sans token</option>
                <option value=" {{token=[x](@{token_url}) }} ">Avec token</option>
              </select>
          </li>
          <li>Type des jets de véhicule :
            <select class="sheet-carac" style="width: 90px;" name="attr_vehicle_type" size="1" title="@{vehicle_type} Type des jets de véhicule">
              <option value="">Choisir</option>
              <option value="sol">Terrestre</option>
              <option value="mer">Maritime</option>
              <option value="air">Aérien</option>
            </select>
            &nbsp;
            <button 
              type="action" 
              name="act_vehiclerolls-btn" 
              class="sheet-flatbtn sheet-iconbtn" 
              title="Ajouter les jets de véhicule de base"
            ><span class="sheet-iconbtn">W</span>Ajout
            </button>
          </li>
          <li>Bitume :
            <input type="checkbox" name="attr_coc_setting_bitume" value="1">
          </li>
        </ul>
      </details>
    </div>
    <!-- FIN Véhicule -->
  </div>
  <div class="sheet-tab-content sheet-fp3">
    <input type="radio" name="attr_tab_pnj" class="sheet-tab sheet-tab1" value="caracs" checked="checked"><span
      title="Caractéristiques"></span>
    <input type="radio" name="attr_tab_pnj" class="sheet-tab sheet-tab2" value="config"><span
      title="Configuration"></span>
    <img class="sheet-imghr-up"
      src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    <div class="sheet-tab-content sheet-tab1">
      <div>
        <div class="sheet-2colrow">
          <div class="sheet-col">
            <div class="sheet-row">
              <span class="sheet-textfatleft">Attributs</span>
            </div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_for" title="%{pnj_for} Jet de Force"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Force}} {{subtags=Test}} {{carac=[[@{pnj_jetfor}cs20cf1[Dé] + [[@{pnj_for}]][FOR] ]] }}">
                    FOR</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_for" type="number" title="@{pnj_for}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetfor"
                    title="@{pnj_jetfor}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_dex" title="%{pnj_dex} Jet de Dextérité"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Dextérité}} {{subtags=Test}} {{carac=[[@{pnj_jetdex}cs20cf1[Dé] + [[@{pnj_dex}]][DEX] ]] }}">
                    DEX</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_dex" type="number" title="@{pnj_dex}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetdex"
                    title="@{pnj_jetdex}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_con" title="%{pnj_con} Jet de Constitution"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Constitution}} {{subtags=Test}} {{carac=[[@{pnj_jetcon}cs20cf1[Dé] + [[@{pnj_con}]][CON] ]] }}">
                    CON</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_con" type="number" title="@{pnj_con}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetcon"
                    title="@{pnj_jetcon}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="sheet-row">&nbsp;</div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_int" title="%{pnj_int} Jet d'Intelligence"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Intelligence}} {{subtags=Test}} {{carac=[[@{pnj_jetint}cs20cf1[Dé] + [[@{pnj_int}]][INT] ]] }}">
                    INT</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_int" type="number" title="@{pnj_int}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetint"
                    title="@{pnj_jetint}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_per" title="%{pnj_per} Jet de Perception"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Perception}} {{subtags=Test}} {{carac=[[@{pnj_jetper}cs20cf1[Dé] + [[@{pnj_per}]][PER] ]] }}">
                    PER</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_per" type="number" title="@{pnj_per}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetper"
                    title="@{pnj_jetper}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_cha" title="%{pnj_cha} Jet de Charisme"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Charisme}} {{subtags=Test}} {{carac=[[@{pnj_jetcha}cs20cf1[Dé] + [[@{pnj_cha}]][CHA] ]] }}">
                    CHA</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_cha" type="number" title="@{pnj_cha}" />
                  <select class="sheet-carac" style="width: 30px;" size="1" name="attr_pnj_jetcha"
                    title="@{pnj_jetcha}">
                    <option value="1d20" selected>N - Normale</option>
                    <option value="2d20kh1">S - Supérieure</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="sheet-row">&nbsp;</div>
            <div class="sheet-3colrow">
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">
                  <button class="sheet-boxtitre" type="roll" name="roll_pnj_init" title="%{pnj_init} Jet d'Initiative"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{name=Initiative}} {{subtags=Combat}} {{carac=[[@{pnj_init}[Init.] + @{pnj_init_var}[Dé(s)] &{tracker}]]}}">
                    Init.</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_init" type="number" title="@{pnj_init}" />
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">DEF / RD</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_def" type="number" title="@{pnj_def}" /> /
                  <input class="sheet-carac" name="attr_pnj_rd" type="number" title="@{pnj_rd}" />
                </div>
              </div>
              <div class="sheet-col" style="width: 27%;">
                <div class="sheet-boxtitre">PV</div>
                <div class="sheet-boxinput">
                  <input class="sheet-carac" name="attr_pnj_pv" type="number" title="@{pnj_pv} PV courants" /> /
                  <input class="sheet-carac" name="attr_pnj_pv_max" type="number" title="@{pnj_pv|max} PV MAX" />
                </div>
              </div>
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-row">
              <span class="sheet-textfatleft">Divers</span>
            </div>
            <div class="sheet-row">
              <textarea name="attr_pnj_divers" style="border: 1px solid; height: 15em;"
                title="@{pnj_divers}"></textarea>
            </div>
          </div>
        </div>
        <div class="sheet-row">&nbsp;</div>
        <img class="sheet-imghr-up"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <div class="sheet-row">
          <div class="sheet-row">
            <table>
              <tr>
                <td class="sheet-textfatleft" style="width: 250px;" title="repeating_pnjatk">Attaques</td>
                <td class="sheet-textbase" style="width: 55px;">Toucher</td>
                <td class="sheet-textbase" style="width: 55px;">Crit.</td>
                <td class="sheet-textbase" style="width: 150px;">DM</td>
                <td class="sheet-textbase" style="width: 50px;">Portée</td>
                <td class="sheet-textbase">Spécial</td>
              </tr>
            </table>
          </div>
          <fieldset class="repeating_pnjatk">
            <table class="sheet-tabsep">
              <tr>
                <td style="width: 30px;">
                  <button type="roll" class="sheet-neutre" style="width: 25px;" name="roll_pnjatk"
                    title="%{repeating_pnjatk_$N_pnjatk} Jet d'attaque PNJ"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{subtags=Attaque}} {{name=@{atknom}}} {{portee=@{atkportee}}} {{@{atkatt}[[@{atkjet}cf1cs>@{atkcrit}[Dé] + [[@{atkbonus}]][Attaque] ]]}} {{@{atkdmg}[[@{atkdmnbde}d@{atkdmde}[Dé DM] + [[@{atkdmbonus}]][Mod.DM] ]]}} {{special=@{atkspec}}}" />
                </td>
                <td class="sheet-boxinputleft" style="width: 250px;">
                  <input type="checkbox" name="attr_atkatt" title="@{atkatt} Faire un jet d'attaque pour toucher"
                    value="attaque=" checked="checked" />
                  <input type="text" class="sheet-carac" style="width: 180px;" name="attr_atknom"
                    title="@{atknom} Nom de l'arme / attaque" />
                  <select class="sheet-carac" style="width: 30px;" name="attr_atkjet"
                    title="@{atkjet} Jet Normal ou Expert (meilleur de deux d20)">
                    <option value="1d20" selected>N Normal</option>
                    <option value="2d20kh1">E Expert</option>
                  </select>
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkbonus"
                    title="@{atkbonus} Bonus d'attaque" value="0" />
                </td>
                <td class="sheet-boxinputleft" style="width: 35px;">
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkcrit"
                    title="@{atkcrit} Seuil de critique" value="20" />
                </td>
                <td class="sheet-boxinputleft" style="width: 130px;">
                  <input type="checkbox" name="attr_atkdmg" title="@{atkdmg} Faire un jet de dommages" value="degats="
                    checked="checked" />
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkdmnbde"
                    title="@{atkdmnbde} Nombre de dés de DM" value="0" />
                  <select class="sheet-carac" style="width: 45px;" name="attr_atkdmde" title="@{atkdmde} Dé de DM">
                    <optgroup label="Standard">
                      <option disabled class="sheet-optgroup">&nbsp;Standard</option>
                      <option value="3">d3</option>
                      <option value="4">d4</option>
                      <option value="6">d6</option>
                      <option value="8">d8</option>
                      <option value="10">d10</option>
                      <option value="12">d12</option>
                    </optgroup>
                    <optgroup label="Sans limite">
                      <option disabled class="sheet-optgroup">&nbsp;Sans limite</option>
                      <option value="3!">d3+</option>
                      <option value="4!">d4+</option>
                      <option value="6!" selected>d6+</option>
                      <option value="8!">d8+</option>
                      <option value="10!">d10+</option>
                      <option value="12!">d12+</option>
                    </optgroup>
                  </select>
                  +
                  <input type="number" class="sheet-carac" style="width: 35px;" name="attr_atkdmbonus"
                    title="@{atkdmbonus} Bonus aux DM" value="0" />
                </td>
                <td class="sheet-boxinputleft" style="width: 35px;">
                  <input type="text" class="sheet-carac" style="width: 35px;" name="attr_atkportee"
                    title="@{atkportee} Portée" value="" />
                </td>
                <td class="sheet-boxinputleft">
                  <textarea class="sheet-carac" name="attr_atkspec" title="@{atkspec} Autres effets"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
        </div>
        <div class="sheet-row">&nbsp;</div>
        <img class="sheet-imghr-up"
          src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        <div class="sheet-row">
          <div class="sheet-row">
            <span class="sheet-textfatleft">Capacités</span>
          </div>
          <fieldset class="repeating_pnjcapas">
            <table class="sheet-tabsep">
              <tr>
                <td style="width: 30px;">
                  <button type="roll" class="sheet-neutre" style="width: 25px;" name="roll_pnjcapa"
                    title="%{repeating_pnjcapas_$N_pnjcapa} Jet de capacité PNJ"
                    value="@{pnj_togm}&{template:co1} @{token_dsp} {{perso=@{character_name}}} {{subtags=Capacité}} {{name=@{capanom}}} {{text=@{capadesc}}}" />
                </td>
                <td class="sheet-boxinputleft" style="width: 200px;">
                  <input type="text" class="sheet-carac" style="width: 200px;" name="attr_capanom"
                    title="@{capanom} Nom de la capacité" />
                </td>
                <td class="sheet-boxinputleft">
                  <textarea class="sheet-carac" name="attr_capadesc"
                    title="@{capadesc} Description de la capacité"></textarea>
                </td>
              </tr>
            </table>
          </fieldset>
        </div>        
      </diV>
    </div>
  </div>
  <div class="sheet-tab-content sheet-tab2">
    <ul>
      <li>Jets
        <select class="sheet-carac" style="width: 130px;" name="attr_pnj_togm" title="@{pnj_togm}" size="1">
          <option value="" selected>Publics</option>
          <option value="/w gm ">Murmurés au MJ</option>
        </select>
      </li>
      <li>Initiative variable
        <input type="checkbox" name="attr_pnj_init_var" title="@{pnj_init_var}" value="[[1d6!]]" />
      </li>
      <li>Bitume
        <input type="checkbox" name="attr_coc_setting_bitume" value="1">
      </li>
    </ul>
    <img class="sheet-imghr-up"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
    <div class="sheet-row">
      <details>
        <summary>Importer statblock</summary>
        <div class="sheet-2colrow">
          <div class="sheet-col">
            <textarea class="sheet-boxinputleft sheet-statblock" name="attr_statblock" style="height: 10em;"
              placeholder="Coller ici un statblock copié depuis le PDF"></textarea>
          </div>
          <div class="sheet-col">
            <span>La liste des attaques et la liste des capacités doivent être séparées par une ligne vide</span>
            <br>
            <button 
              type="action" 
              name="act_statblockimport-btn" 
              class="sheet-flatbtn sheet-iconbtn"
              title="Importer le stat-block"
              >
              <span class="sheet-iconbtn">W</span>Import
            </button>
            <textarea class="sheet-boxinputleft sheet-sbresult" name="attr_sbresult"></textarea>
          </div>
        </div>
      </details>
    </div>
  </div>
</div>
<!-- FIN FDP -->
<!-- TEMPLATES -->
<rolltemplate class="sheet-rolltemplate-co1">
  <div class="sheet-roundtable">
    <table>
      {{^token}}
        <tr>
          <th colspan="2" style="text-align: center;">{{perso}}</th>
        </tr>
      {{/token}}
      {{#token}}
        <tr>
          <th style="height:50px; width:50px;">{{token}}</th>
          <th style="text-align: center;">{{perso}}</th>
        </tr>
      {{/token}}
      <tr>
        <td class="sheet-subheader">{{subtags}}</td>
        <th>{{name}}</th>
      </tr>
      {{#portee}}
      <tr>
        <td style="font-size: smaller; text-align: center;" colspan="2">Portée : {{portee}}</td>
      </tr>
      {{/portee}}
      <tr>
        <td colspan="2">
          <img class="sheet-imghr"
            src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </td>
      </tr>
    </table>
    <table>
      {{#desc}}
      <tr>
        <td colspan="2" style="white-space:normal;">
          <div class="sheet-desc">{{desc}}</div>
        </td>
      </tr>
      {{/desc}}
      {{#DV}}
      <tr>
        <td class="sheet-tcat">PV gagnés</td>
        <td>{{DV}}</td>
      </tr>
      {{/DV}}
      {{#carac}}
      <tr>
        {{#jet}}
        <td class="sheet-tcat">{{jet}} </td>
        {{/jet}}
        {{^jet}}
        <td class="sheet-tcat">Jet </td>
        {{/jet}}
        <td>{{carac}}</td>
      </tr>
      {{/carac}}
      {{#test}}
      <tr>
        <td colspan="2" style="display: none;">{{test}}</td>
      </tr>
      {{#rollWasCrit() test}}
      <tr>
        <td colspan="2" style="color:green;">
          <div class="sheet-desc"><b>{{test_crit}}</b></div>
        </td>
      </tr>
      {{/rollWasCrit() test}}
      {{#rollWasFumble() test}}
      <tr>
        <td colspan="2" style="color:red;">
          <div class="sheet-desc"><b>{{test_fumble}}</b></div>
        </td>
      </tr>
      {{/rollWasFumble() test}}
      {{/test}}
      {{#attaque}}
      {{#rollWasCrit() attaque}}
      <tr>
        <td colspan="2" style="color:green;"><b>Critique !</b></td>
      </tr>
      {{/rollWasCrit() attaque}}
      {{#rollWasFumble() attaque}}
      <tr>
        <td colspan="2" style="color:red;"><b>Fumble !</b></td>
      </tr>
      {{/rollWasFumble() attaque}}
      <tr>
        <td class="sheet-tcat">Jet </td>
        <td>{{attaque}} contre DEF</td>
      </tr>
      {{#degats}}
      <tr>
        <td class="sheet-tcat">Dégâts </td>
        <td>
          {{degats}} {{#rollWasCrit() attaque}}
          <span style="color:green;font-weight:bold;"> + {{degats}}</span> {{/rollWasCrit() attaque}} {{dmtype}}
        </td>
      </tr>
      {{#degats2}}
      <tr>
        <td style="text-align: right;">+</td>
        <td><span style="color: steelblue;">{{degats2}} {{dm2type}}</span></td>
      </tr>
      {{/degats2}}
      {{/degats}}
      {{/attaque}}
      {{^attaque}}
      {{#degats}}
      <tr>
        <td class="sheet-tcat">Dégâts </td>
        <td>{{degats}} {{dmtype}}</td>
      </tr>
      {{#degats2}}
      <tr>
        <td style="text-align: right;">+</td>
        <td><span style="color: steelblue;">{{degats2}} {{dm2type}}</span></td>
      </tr>
      {{/degats2}}
      {{/degats}}
      {{/attaque}}
      {{#special}}
      <tr>
        <td colspan="2" style="white-space:normal;">
          <div class="sheet-desc">{{special}}</div>
        </td>
      </tr>
      {{/special}}
      {{#text}}
      <tr>
        <td colspan="2" style="white-space:normal; margin: 1px;">
          <div class="sheet-text">{{text}}</div>
        </td>
      </tr>
      {{/text}}
      {{#alert}}
      <tr>
        <td colspan="2" style="white-space: normal; margin: 1px">
          <span style="color: red; font-weight: bold">{{alert}}</span>
        </td>
      </tr>
      {{/alert}}
      <tr>
        <td colspan="2">
          <img class="sheet-imghr"
            src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesContemporain/coc_hr.jpg" />
        </td>
      </tr>
    </table>
  </div>
</rolltemplate>
<!-- FIN TEMPLATES -->
<!-- **** SCRIPTS / SHEET WORKERS -->
<script type="text/worker">

/**
* constants
*/
const SHEET_PC = "pj";
const SHEET_NPC = "pnj";
const SHEET_VEHICLE = "vehicule";

/**
 * settings global object
 */
 const wkrSettings = {
  debugMode: false,
};

/**
 * Convert to integer
 * @param {string} value value to cast
 * @param {int} onError default value on error
 * @returns integer value
 */
function int(value, onError = 0) {
  return parseInt(value) || onError;
}

/**
 * Convert to float
 * @param {string} value value to cast
 * @param {float} onError default value on error
 * @returns float value
 */
function float(value, onError = 0) {
  return parseFloat(value) || onError;
}


/**
* Capitalize string
* @param {string} str string to capitalize
* @returns capitalized string
*/
function capitalize(str) {
  if (str && str !== "")
    return str.charAt(0).toUpperCase() + str.substring(1);
}

/**
 * Get string or empty value
 * @param {string} value value to cast
 * @param {string} onError default value on null/undefined
 * @returns string value
 */
function stringOrDefault(value, onError = "") {
  return value || onError;
}

/**
 * Log to JS console with color & style
 * @param {any} data data to log
 * @param {string} title title of logged data
 * @param {string} color color name for log line
 * @param {string} style CSS style for log line
 * @param {string} headerStyle CSS style for log title
 */
function clog(
  data,
  title = "",
  color = { text:"green", back:"" },
  style = "font-size:12px; font-weight:normal;",
  headerStyle = "font-size:13px; font-weight:bold;"
) {

  title = stringOrDefault(title, "");
  if (title !== "") title = ` Sheet-Worker : ${title} `;
  const titleStyle = `color:${color.text}; background-color:${color.back}; ${headerStyle} text-decoration:underline;`;
  const textStyle = `color:${color.text}; background-color:${color.back}; ${style}`;

  if (title) {
    if (typeof data === "object") {
      const output = `%c${title}`;
      console.log(output, titleStyle, data);
    } else {
      const output = `%c${title} %c${data}`;
      console.log(output, titleStyle, textStyle);
    }
  } else {
    if (typeof data === "object") {
      console.log(data);
    } else {
      const output = `%c${data}`;
      console.log(output, textStyle);
    }
  }
}

/**
* Returns true if a 'debug' attribute exists with a truethy value
* @param {object} v List of values returned by getAttrs()
*/
function isDebug(v) {
  const debug = stringOrDefault(v.debug);
  if (["false", "0", "n", ""].includes(debug.toLowerCase())) return false;
  else return true;
}

/**
* Generate a random number between 1 and max
* @param {integer} max Upper bound of range
* @returns {integer} Generated random number
*/
function getRandom(max) {
  const min = 1;
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/**
* Compute caracteristic modifier
* @param {integer} value Characteristic value
* @returns modifier
*/
function getMod(value) {
  value = int(value);
  return Math.floor((value - 10) / 2);
}

/**
* Parse a chunk of data into name & value
* @param {string} data Chunk of data to parse
* @param {string} delim Delimiter (defaults to ':')
* @returns an object with name and value properties
*/
function parseNameValue(data, delim) {
  delim = stringOrDefault(delim, ':');
  let parsed = {};
  if (data.indexOf(delim) !== -1) {
    const parts = data.split(delim);
    let name = stringOrDefault(parts[0]).trim();
    let value = '';
    if (parts.length > 1) {
      value = stringOrDefault(parts[1]).trim();
    }
    parsed = {
      name: name,
      value: value,
    };
  }
  return parsed;
}

/**
 * Return a sequence of numbers as an array
 * @param {number} count - Length of the sequence
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {array}
 */
 function seq(count, base = 1) {
  return [ ...Array(count).keys() ].map(i => i += base);
}

/**
 * Return a sequence of names
 * @param {number} count - Length of the sequence
 * @param {string} name - Name template (with | placeholder to insert the sequence)
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {array}
 */
 function nameSeq(count, name, base = 1) {
  const [ prepend, append ] = name.split("|");
  return seq(count, base).map(s => `${prepend || ""}${s}${append || ""}`)
}

/**
 * Return a list of event as array or as string
 * @param {string} eventName - Name of the event
 * @param {array} attributeList - List of attributes
 * @param {string} joinChar - Character to use for joining the items
 * @returns {array|string}
 */
function eventList(eventName, attributeList, joinChar = "") {
  const result = attributeList.map(a => `${eventName}:${ a.toLowerCase() }`)
  return joinChar !== "" ? result.join(joinChar) : result;
}

/**
* Remove all rows for a repeating section
* @param {string} sectionName Repeating section to clear
*/
function removeRepeating(sectionName) {
  getSectionIDs(sectionName, function (ids) {
    rowIds.forEach(rowId => {
      removeRepeatingRow(`repeating_${sectionName}_${rowId}`);
    });
  });
}

/** @typedef sendChatMsgOptions
 * @property {string} title - Title of the message
 * @property {string} template - Name of roll template
 * @property {string} whisper - Target for whispered message
 */

/**
 * Send a message to chat
 * @param {string} msg - Message to send
 * @param {sendChatMsgOptions} options - Options for the message
 */
 function sendChatMsg(msg, options = {}) {
  let { title = "", template = "default", whisper = "" } = options;
  if (whisper !== "") whisper = "/w " + whisper+" ";
  let chatMsg;
  if (Array.isArray(msg)) {
    chatMsg = msg.map(t => `{{${t} }}`).join(" ");
  } else {
    chatMsg = "{{" + msg + "}}";
  }
  const chatCmd = `${whisper}&{template:${template}} ${title ? (template === "default" ? `{{name=${title} }}` : `{{${title} }}`) : "" } ${chatMsg}`;
  startRoll(chatCmd, roll => {
      finishRoll(roll.rollId);
  });
}

/**
 * Return co1 rolltemplate
 * @param {object} props - List of {{ }} sections as object properties
 * @returns {string[]}
 */
function coRollTemplate(props) {
  return [
    "perso=@{character_name}",
    ...Object.entries(props).map(e => {
      let [ prop, value ] = e;
      prop = prop === "leftsub" ? "subtags" : prop;
      prop = prop === "rightsub" ? "name" : prop;
      return `${prop}=${value} `;
    })
  ];
}

/**
 * Send a single value roll query to chat and process response
 * @param {string} prompt - Input box label
 * @param {object} callback - Callback function to process input
 */
function askValue(prompt, callback) {
  const askValue = `!{{ask=[[?{${prompt}}]]}}`;
  startRoll(askValue, question => {
    const query = question.results.ask.result;
      if(query && callback) {
          callback(query);
      }
  });
}

/**
 * Send a drop-down roll query to chat and process response
 * @param {string|array} askParams - Parameters of the roll query 
 * @param {object} callback - Callback function to process input
 */
function ask(askParams, callback) {
  if (!Array.isArray(askParams)) {
    askParams = [ askParams, "Non", "Oui" ];
  }
  const [ prompt, ...choices ] = askParams;
  const choice = choices.map((ch, ix) => `${ch},${ix}`).join("|");
  const ask = `!{{ask=[[?{${prompt}|${choice}}]]}}`;
  startRoll(ask, question => {
      const query = question.results.ask.result;
      if(query && callback) {
          callback(query, choices);
      }
      //finishRoll(question.rollId);
  });
};

/**
* Add a trait/ability or extra to an NPC object
* @param {object} npcObj
* @param {object} traitObj
*/
function addTrait(npcObj, traitObj) {
  if (traitObj.nom !== '' && traitObj.desc !== '') {
    npcObj.Capas.push(`${traitObj.nom}~${traitObj.desc}`);
  } else if (traitObj.desc !== '') {
    npcObj.Extras.push(traitObj.desc.trim());
  }
  traitObj.nom = '';
  traitObj.desc = '';
}

/**
* Import an NPC statblock text
* @param {string} text Statblock to parse
* @returns {object} NPC object
*/
function importStatblock(text) {
  text = text.replace(/\r/g, '');
  text = text.replace(/\n[ ]*\+/g, '+');
  let npc = {
    NC: 0,
    PROFIL: '',
    TAILLE: '',
    FOR: '',
    DEX: '',
    CON: '',
    INT: '',
    PER: '',
    SAG: '',
    CHA: '',
    INIT: 0,
    PV: 0,
    RD: 0,
    DEF: 0,
    ATC: '',
    ATD: '',
    PIL: '',
    Atks: [],
    Capas: [],
    Extras: [],
  };
  let rows = text.split(/\n/);
  let capacites = false;
  let capacite = { nom: '', desc: '' };
  clog('<<<BEGIN>>>', 'NPC STATBLOCK IMPORT');
  rows.forEach(function (row, rownr) {
    let dataRow = row.trim();
    clog({ rownr, dataRow }, 'statblock import -> parse row');
    if (rownr === 0 && dataRow.toUpperCase().indexOf('NC') === -1) {
      // assume first line is name
      npc.character_name = dataRow;
      return;
    }
    // reading attacks list
    if (!capacites) {
      const atkRow = dataRow.toUpperCase();
      if (atkRow.indexOf('ATTAQUE') === 0 || atkRow.indexOf('DM') !== -1) {
        // this is an attack line, handle CG statblocks
        dataRow = dataRow.replace(/ \(DM/g, ' DM');
        dataRow = dataRow.replace(/\)$/g, '');
        npc.Atks.push(dataRow);
        return;
      }
    }
    // reading paths & ranks
    if (dataRow.toUpperCase().startsWith('VOIE ')) {
      if (capacites) addTrait(npc, capacite);
      npc.Extras.push(dataRow);
      return;
    }
    if (capacites) {
      // reading abilities list
      const s = dataRow.indexOf(':');
      if (s !== -1) {
        addTrait(npc, capacite);
        const [ name, desc ] = dataRow.split(':').map(item => item.trim());
        capacite.nom = name;
        if (capacite.nom.indexOf(' RD') !== -1) {
          capacite.nom = capacite.nom.replace(' RD', ' (RD');
        }
        capacite.desc = desc;
      } else {
        capacite.desc += ' ' + dataRow.trim();
      }
      return;
    }
    // start of abilities list
    if (dataRow.trim() === '') {
      addTrait(npc, capacite);
      capacites = !capacites;
      return;
    }
    // reading statistics
    dataRow = dataRow.replace(/\, /g, ' ');
    dataRow = dataRow.replace(/ \(\+/g, ' +');
    dataRow = dataRow.replace(/ \(RD/g, ' RD ');
    dataRow = dataRow.replace(/ RD  /g, ' RD ');
    dataRow = dataRow.replace(/\) /g, ' ');
    dataRow = dataRow.replace(/très /g, 'très~'); // handle 'très petite' size
    dataRow = dataRow.replace(/créature /g, 'PROFIL créature~'); // handle 'créature' mention
    const items = dataRow.split(' ');
    clog(items, 'statblock import -> parsing attributes');
    for (let item = 0; item < items.length; item++) {
      if (item % 2 === 0) {
        const k = items[item].toUpperCase().replace(/\./g, '');
        if (Object.keys(npc).indexOf(k) === -1) {
          items.splice(item, 1);
          item--;
          continue;
        }
        let v = items[item + 1];
        if (v.trim() !== '') {
          v = v.replace(/~/g, ' ');
          npc[k] = v;
          if (k === 'SAG') delete npc.PER;
          if (k === 'PER') delete npc.SAG;
        }
      }
    }
  });
  if (capacites) addTrait(npc, capacite);
  clog('<<<END>>>', 'NPC STATBLOCK IMPORT');

  return npc;
}

/**
* Process base attributes from parsed NPC object
* @param {string} universe
* @param {object} pnjObj NPC object
* @returns {string} Result messsage
*/
function processBaseAttributes(universe, pnjObj) {
  var result = '';
  var pnj_sagper = '';
  var pnj_jetsagper = '';
  if (universe === 'COF') {
    // COF uses SAG (Wisdom)
    pnj_sagper = 'pnj_sag';
    pnj_jetsagper = 'pnj_jetsag';
    if (!pnjObj.hasOwnProperty('SAG') && pnjObj.hasOwnProperty('PER')) {
      // in case a CG/COC statblock is pasted to COF
      sagOrPer = pnjObj.PER;
      result = 'Attention : PER trouvé à la place de SAG';
    } else {
      sagOrPer = pnjObj.SAG;
    }
  }
  if (universe === 'COC' || universe === 'CG') {
    // CG & COC uses PER (Perception)
    pnj_sagper = 'pnj_per';
    pnj_jetsagper = 'pnj_jetper';
    if (!pnjObj.hasOwnProperty('PER') && pnjObj.hasOwnProperty('SAG')) {
      // in case a COF statblock is pasted to CG/COC
      sagOrPer = pnjObj.SAG;
      result = 'Attention : SAG trouvé à la place de PER';
    } else {
      sagOrPer = pnjObj.PER;
    }
  }
  var jnor = '1d20';
  var jsup = '2d20kh1';
  var pnjAttrs = {};
  if (pnjObj.hasOwnProperty('character_name')) {
    pnjAttrs.character_name = pnjObj.character_name;
    delete pnjObj.character_name;
  }
  pnjAttrs.NIVEAU = int(pnjObj.NC);
  delete pnjObj.NC;
  pnjAttrs.TAILLE = stringOrDefault(pnjObj.TAILLE);
  delete pnjObj.TAILLE;
  if (pnjObj.PROFIL !== '') {
    pnjAttrs.PROFIL = pnjObj.PROFIL;
  }
  delete pnjObj.PROFIL;
  pnjAttrs.pnj_for = int(pnjObj.FOR.replace('*', ''));
  pnjAttrs.pnj_jetfor =
    pnjObj.FOR.charAt(pnjObj.FOR.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.FOR;
  pnjAttrs.pnj_dex = int(pnjObj.DEX.replace('*', ''));
  pnjAttrs.pnj_jetdex =
    pnjObj.DEX.charAt(pnjObj.DEX.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.DEX;
  pnjAttrs.pnj_con = int(pnjObj.CON.replace('*', ''));
  pnjAttrs.pnj_jetcon =
    pnjObj.CON.charAt(pnjObj.CON.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.CON;
  pnjAttrs.pnj_int = int(pnjObj.INT.replace('*', ''));
  pnjAttrs.pnj_jetint =
    pnjObj.INT.charAt(pnjObj.INT.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.INT;
  pnjAttrs[pnj_sagper] = int(sagOrPer.replace('*', ''));
  pnjAttrs[pnj_jetsagper] =
    sagOrPer.charAt(sagOrPer.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.SAG;
  delete pnjObj.PER;
  pnjAttrs.pnj_cha = int(pnjObj.CHA.replace('*', ''));
  pnjAttrs.pnj_jetcha =
    pnjObj.CHA.charAt(pnjObj.CHA.length - 1) == '*' ? jsup : jnor;
  delete pnjObj.CHA;
  pnjAttrs.pnj_init = int(pnjObj.INIT);
  delete pnjObj.INIT;
  pnjAttrs.pnj_def = int(pnjObj.DEF);
  delete pnjObj.DEF;
  if (universe === 'COG') {
    pnjAttrs.pnj_dep = int(pnjObj.DEP);
  }
  delete pnjObj.DEP;
  pnjAttrs.pnj_pv = int(pnjObj.PV);
  pnjAttrs.pnj_pv_max = int(pnjObj.PV);
  delete pnjObj.PV;
  pnjAttrs.pnj_rd = int(pnjObj.RD);
  delete pnjObj.RD;
  clog(pnjAttrs, 'statblock import -> setting attributes');
  pnjAttrs.statblock = '';
  setAttrs(pnjAttrs);

  return result;
}

/**
* Process attacks from parsed NPC object
* @param {string} universe
* @param {object} pnjObj NPC object
* @returns {string} Result message
*/
function processAttacks(universe, pnjObj) {
  removeRepeating('pnjatk');
  let result = '';

  for (const atk of pnjObj.Atks) {
    const atkItems = atk.split(' ');
    clog(atkItems, 'NPC statblock parser -> attacks found');
    if (atkItems[atkItems.length - 1] === 'DM') {
      atkItems.push('-');
    }
    let atkAtt = 'attaque=';
    let atkNom = '';
    let atkBonus = -1;
    let atkPortee = '';
    let atkDM = '';
    let atkSpec = '';
    let parsed = '';
    for (let atkItem of atkItems) {
      if (atkItem === 'DM' && atkNom === '') {
        atkNom = parsed;
        parsed = 'DM';
        continue;
      }
      if (atkItem.charAt(0) === '+' && atkItem !== '+' && atkNom === '') {
        atkBonus = int(atkItem.replace('+', ''));
        atkNom = parsed;
        parsed = '';
        continue;
      }
      if (parsed.endsWith('DM')) {
        atkDM = atkItem;
        atkSpec = parsed.replace('DM', '');
        parsed = '';
        continue;
      }
      if (atkItem.charAt(0) === '(' && atkItem.endsWith('m)')) {
        atkPortee = atkItem.substring(1, atkItem.length - 1);
        continue;
      }
      parsed += parsed != '' ? ' ' : '';
      parsed += atkItem;
    }
    clog(atkNom + ' ' + atkBonus + ' ' + atkDM + ' ' + atkSpec, 'NPC statblock parser -> attack');
    if (atkBonus === -1) {
      if (atkNom.endsWith(' /') && pnjObj.hasOwnProperty('ATD')) {
        atkBonus = int(pnjObj.ATD.replace('+', ''));
        atkNom = atkNom.replace(' /', '');
      } else {
        atkAtt = '0'; // No attack bonus found, damage only
      }
    }
    let atkDmg = atkDM !== '' ? 'degats=' : '0';
    let atkNbDe = 0;
    let atkDe = '';
    let atkBonusDM = 0;
    if (atkDM !== '') {
      atkDM = atkDM.toLowerCase();
      atkDM = atkDM.replace('d', '|');
      atkDM = atkDM.replace('+', '|+');
      atkDM = atkDM.replace('-', '|-');
      let dm = atkDM.split('|');
      atkNbDe = int(dm[0]);
      if (atkNbDe === 0) {
        atkDmg = '0'; // No damage dice, attack only
      }
      atkDe = dm[1];
      if (universe === 'COC') {
        atkDe += '!';
      }
      atkBonusDM = int(dm[2]);
    }
    if (atkNom !== '' && (atkAtt !== '0' || atkDmg !== '0')) {
      newRowID = 'repeating_pnjatk_' + generateRowID();
      let atkRow = {};
      atkRow[`${newRowID}_atkatt`] = atkAtt;
      atkRow[`${newRowID}_atknom`] = atkNom;
      atkRow[`${newRowID}_atkjet`] = '1d20';
      atkRow[`${newRowID}_atkbonus`] = atkBonus;
      atkRow[`${newRowID}_atkcrit`] = '20';
      atkRow[`${newRowID}_atkdmg`] = atkDmg;
      atkRow[`${newRowID}_atkdmnbde`] = atkNbDe;
      atkRow[`${newRowID}_atkdmde`] = atkDe;
      atkRow[`${newRowID}_atkdmbonus`] = atkBonusDM;
      atkRow[`${newRowID}_atkportee`] = atkPortee;
      atkSpec += parsed;
      atkSpec = atkSpec.replace(/\d+d\d+/g, '[[$&]]'); // search for <numbers>d<numbers> and replace with in-line roll
      if (atkSpec !== '') {
        atkRow[`${newRowID}_atkspec`] = atkSpec;
      }
      clog(atkRow, 'NPC statblock parser -> adding attack');
      setAttrs(atkRow);
    } else {
      result +=
        (result.length > 0 ? '\n' : '') +
        'Err: impossible d\'analyser le contenu de "' +
        pnjObj.Atks[atk] +
        '"';
    }
  }

  return result;
}

/**
* Process abilities/traits from parsed NPC object
* @param {string} universe
* @param {object} pnjObj NPC object
* @returns {string} Result message
*/
function processTraits(universe, pnjObj) {
  removeRepeating('pnjcapas');
  let result = '';

  for (const capa of pnjObj.Capas) {
    const capacite = capa.split('~').map(item => stringOrDefault(item));
    if (capacite.length == 2) {
      let [ name, desc ] = capacite;
      if (name !== "" && desc !== "") {
        newRowID = 'repeating_pnjcapas_' + generateRowID();
        let capaRow = {};
        capaRow[`${newRowID}_capanom`] = name;
        ['FOR', 'DEX', 'CON', 'INT', 'PER', 'SAG', 'CHA'].forEach((attr) => {
          regExp = new RegExp(`\\+Mod\. de ${attr}`, 'gi');
          desc = desc.replace(regExp, `+@{pnj_${attr.toLowerCase()}}`);
        });
        desc = desc.replace(/\d+d\d+[+-]*\d*/g, '{{$&}}'); // search for <numbers>d<numbers>+/-<number>
        desc = desc.replace(/\[\d+d\d+[+-]*\d*\]/g, '{$&}'); // search for [<numbers>d<numbers>+/-<number>]
        desc = desc.replace(/}}@/g, '@');
        desc = desc.replace(/\[{{/g, '[[');
        desc = desc.replace(/}}\]/g, ']]');
        desc = desc.replace(/{{/g, '[[');
        desc = desc.replace(/}}/g, ']]');
        desc = desc.replace(/\]\] \+ /g, ' + ');
        desc = desc.replace(/}\]/g, '} ]]');
        capaRow[`${newRowID}_capadesc`] = desc;
        clog(capaRow, 'NPC statblock parser -> adding trait');
        setAttrs(capaRow);
      }
    } else {
      result +=
        (result.length > 0 ? '\n' : '') +
        'Err: impossible d\'analyser le contenu de "' +
        capacite +
        '"';
    }
  }

  return result;
}

/**
* (Re-)Build the CARACS serialized objects
*/
function buildCaracs() {
  getAttrs(
    [
      'FORCE',
      'DEXTERITE',
      'CONSTITUTION',
      'INTELLIGENCE',
      'PERCEPTION',
      'CHARISME',
      'NIVEAU',
      'RANG_VOIE1',
      'RANG_VOIE2',
      'RANG_VOIE3',
      'RANG_VOIE4',
      'RANG_VOIE5',
      'RANG_VOIE6',
      'RANG_VOIE7',
      'RANG_VOIE8',
      'RANG_VOIE9',
      'voie1nom',
      'voie2nom',
      'voie3nom',
      'voie4nom',
      'voie5nom',
      'voie6nom',
      'voie7nom',
      'voie8nom',
      'voie9nom',
      'DEFARMUREON',
    ],
    function (values) {
      let caracs = {
        FOR: 0,
        DEX: 0,
        CON: 0,
        INT: 0,
        PER: 0,
        CHA: 0,
      };
      for (const car in values) {
        let vcar = values[car];
        if (vcar && !isNaN(vcar)) {
          vcar = int(vcar);
        }
        const mod = car.substring(0, 3);
        if (caracs.hasOwnProperty(mod)) {
          caracs[mod] = getMod(vcar);
        }
        if (car.startsWith('RANG_')) {
          if (!caracs.hasOwnProperty('rangs')) {
            caracs.rangs = [0, 0, 0, 0, 0, 0, 0, 0, 0];
          }
          let voie = int(car.substring(car.length - 1));
          if (voie > 0) {
            caracs[car] = vcar;
            caracs.rangs[voie - 1] = vcar;
          }
        } else if (car.startsWith('voie') && car.endsWith('nom')) {
          if (!caracs.hasOwnProperty('voies')) {
            caracs.voies = ['', '', '', '', '', '', '', '', ''];
          }
          let voie = int(car.substring(4, 5));
          if (voie > 0 && vcar) {
            caracs.voies[voie - 1] = vcar.toUpperCase();
          }
        } else {
          caracs[car] = vcar;
        }
      }
      setAttrs({
        CARACS: JSON.stringify(caracs),
      });
    }
  );
}

/**
* Rebuild the abilities attributes
* @param {int} vnum Path number
*/
function buildAbilities(vnum) {
  return; // TODO : future dev
  let vn = int(vnum);
  let attrs = [];
  if (vn !== 0) {
    attrs = attrRanks(vn);
  } else {
    let attrv = [];
    for (let voie = 1; voie <= 9; voie++) {
      attrv[voie - 1] = attrRanks(voie);
    }
    attrs = [
      ...attrv[0],
      ...attrv[1],
      ...attrv[2],
      ...attrv[3],
      ...attrv[4],
      ...attrv[5],
      ...attrv[6],
      ...attrv[7],
      ...attrv[8],
    ];
  }
  attrs.push('hors_fiche');
  attrs.push('hors_fiche_pfx');
  attrs.push('capacites');

  getAttrs(attrs, function (v) {
    if (v.hors_fiche === 'none') return;
    let abilities = {};
    if (vn != 0 && v.hors_fiche === 'serial' && v.capacites !== undefined) {
      abilities = JSON.parse(v.capacites);
    }
    for (let voie = 1; voie <= 9; voie++) {
      for (let rank = 1; rank <= 5; rank++) {
        let ability = stringOrDefault(v[`voie${voie}-${rank}`]);
        let checked = stringOrDefault(v[`v${voie}r${rank}`], '0');
        if (ability !== '') {
          ability = ability.split('\n')[0];
          ability = ability
            .replace(/'/, ' ')
            .split(/\s+/)
            .map((word, ix) => {
              word = word.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return ix === 0
                ? word.toLowerCase()
                : word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            })
            .join('');
          if (v.hors_fiche === 'direct' && v.hors_fiche_pfx !== '')
            ability =
              v.hors_fiche_pfx +
              ability.charAt(0).toUpperCase() +
              ability.slice(1);
          abilities[ability] = checked === '0' ? '0' : '1';
        }
      }
    }
    clog(abilities, 'ability builder');
    if (v.hors_fiche === 'serial') {
      abilities = JSON.stringify(abilities);
      abilities = { capacites: abilities };
    }
    setAttrs(abilities);
  });
}

/**
* Sheet migrations
*/

function migrateSheetV2() {
  getAttrs(
    [
      'UNIVERS',
      'FOR_BONUS',
      'DEX_BONUS',
      'CON_BONUS',
      'INT_BONUS',
      'PER_BONUS',
      'CHA_BONUS',
      'ATKCAC_DIV',
      'ATKTIR_DIV',
      'ATKMAG_DIV',
      'ATKMEN_DIV',
      'PSYINTUI_DIV',
      'PSYINFLU_DIV',
      'INIT_DIV',
      'DEFDIV',
      'DEPDIV',
    ],
    function (values) {
      let for_bonus = int(values.FOR_BONUS);
      let for_bonus_desc = for_bonus !== 0 ? 'Bonus FOR' : '';
      let dex_bonus = int(values.DEX_BONUS);
      let dex_bonus_desc = dex_bonus !== 0 ? 'Bonus DEX' : '';
      let con_bonus = int(values.CON_BONUS);
      let con_bonus_desc = con_bonus !== 0 ? 'Bonus CON' : '';
      let int_bonus = int(values.INT_BONUS);
      let int_bonus_desc = int_bonus !== 0 ? 'Bonus INT' : '';
      let per_bonus = int(values.PER_BONUS);
      let per_bonus_desc = per_bonus !== 0 ? 'Bonus PER' : '';
      let cha_bonus = int(values.CHA_BONUS);
      let cha_bonus_desc = cha_bonus !== 0 ? 'Bonus CHA' : '';
      let atkcac_div = int(values.ATKCAC_DIV);
      let atkcac_bonus_desc = atkcac_div !== 0 ? 'Bonus ATC' : '';
      let atktir_div = int(values.ATKTIR_DIV);
      let atktir_bonus_desc = atktir_div !== 0 ? 'Bonus ATD' : '';
      let atkmag_div = int(values.ATKMAG_DIV);
      let atkmag_bonus_desc = atkmag_div !== 0 ? 'Bonus MAG' : '';
      let atkmen_div = int(values.ATKMEN_DIV);
      let atkmen_bonus_desc = atkmen_div !== 0 ? 'Bonus MEN' : '';
      let psyinflu_div = int(values.ATKPSYINFLU_DIV);
      let psyinflu_bonus_desc = psyinflu_div !== 0 ? 'Bonus Psy Inf.' : '';
      let psyintui_div = int(values.ATKPSYINTUI_DIV);
      let psyintui_bonus_desc = psyintui_div !== 0 ? 'Bonus Psy Int.' : '';
      let init_div = int(values.INIT_DIV);
      let init_bonus_desc = init_div !== 0 ? 'Bonus Init.' : '';
      let defdiv = int(values.DEFDIV);
      let def_bonus_desc = defdiv !== 0 ? 'Bonus DEF' : '';
      let depdiv = int(values.DEPDIV);
      let dep_bonus_desc = depdiv !== 0 ? 'Bonus DEP' : '';
      setAttrs({
        FOR_BUFF1_DESC: for_bonus_desc,
        FOR_BUFF1: for_bonus,
        FOR_BUFF: for_bonus,
        DEX_BUFF1_DESC: dex_bonus_desc,
        DEX_BUFF1: dex_bonus,
        DEX_BUFF: dex_bonus,
        CON_BUFF1_DESC: con_bonus_desc,
        CON_BUFF1: con_bonus,
        CON_BUFF: con_bonus,
        INT_BUFF1_DESC: int_bonus_desc,
        INT_BUFF1: int_bonus,
        INT_BUFF: int_bonus,
        SAG_BUFF1_DESC: sag_bonus_desc,
        SAG_BUFF1: sag_bonus,
        SAG_BUFF: sag_bonus,
        PER_BUFF1_DESC: per_bonus_desc,
        PER_BUFF1: per_bonus,
        PER_BUFF: per_bonus,
        CHA_BUFF1_DESC: cha_bonus_desc,
        CHA_BUFF1: cha_bonus,
        CHA_BUFF: cha_bonus,
        ATKCAC_BUFF1_DESC: atkcac_bonus_desc,
        ATKCAC_BUFF1: atkcac_div,
        ATKCAC_BUFF: atkcac_div,
        ATKTIR_BUFF1_DESC: atktir_bonus_desc,
        ATKTIR_BUFF1: atktir_div,
        ATKTIR_BUFF: atktir_div,
        ATKMAG_BUFF1_DESC: atkmag_bonus_desc,
        ATKMAG_BUFF1: atkmag_div,
        ATKMAG_BUFF: atkmag_div,
        ATKMEN_BUFF1_DESC: atkmen_bonus_desc,
        ATKMEN_BUFF1: atkmen_div,
        ATKMEN_BUFF: atkmen_div,
        PSYINFLU_BUFF1_DESC: psyinflu_bonus_desc,
        PSYINFLU_BUFF1: psyinflu_div,
        PSYINFLU_BUFF: psyinflu_div,
        PSYINTUI_BUFF1_DESC: psyintui_bonus_desc,
        PSYINTUI_BUFF1: psyintui_div,
        PSYINTUI_BUFF: psyintui_div,
        INIT_BUFF1_DESC: init_bonus_desc,
        INIT_BUFF1: init_div,
        INIT_BUFF: init_div,
        DEF_BUFF1_DESC: def_bonus_desc,
        DEF_BUFF1: defdiv,
        DEF_BUFF: defdiv,
        DEP_BUFF1_DESC: dep_bonus_desc,
        DEP_BUFF1: depdiv,
        DEP_BUFF: depdiv,
        VERSION: '2.0',
      });
    }
  );
}

function migrateSheetV2_5() {
  const attrList = [
    'FOR',
    'DEX',
    'CON',
    'INT',
    'PER',
    'CHA',
    'ATKCAC',
    'ATKTIR',
    'ATKMAG',
    'ATKMEN',
    'INIT',
    'DEF',
  ];
  for (let attr of attrList) {
    let attrDesc = [];
    let attrVals = [];
    for (let b = 1; b < 6; b++) {
      attrDesc.push(`${attr}_BUFF${b}_DESC`);
      attrVals.push(`${attr}_BUFF${b}`);
    }
    getAttrs([attr, ...attrDesc, ...attrVals], function (values) {
      let attr = Object.keys(values)[0];
      let buffList = [];
      for (let b = 1; b < 6; b++) {
        let desc = stringOrDefault(values[`${attr}_BUFF${b}_DESC`]);
        let buff = int(values[`${attr}_BUFF${b}`]);
        if (desc !== '') {
          buffList.push(`${desc} : ${buff}`);
        }
      }
      let buffAttr = {};
      buffAttr[`${attr}_BUFF_LIST`] = buffList.join(';');
      setAttrs(buffAttr);
    });
  }
  setAttrs({
    VERSION: '2.5',
  });
}

function migrateSheetV2_9() {
  getAttrs(['PC_DESC'], function (value) {
    const pc_desc = value.PC_DESC || 'Points de Chance';
    setAttrs({
      PC_DESC_PLUR: pc_desc,
      PC_DESC_SNGL: pc_desc,
      PC_DESC_ABRV: 'PC',
      PC_DESC: `${pc_desc},${pc_desc},PC`,
    });
  });
}

function migrateSheetV3() {
  getAttrs(
    [
      'FOR_BUFF_LIST',
      'DEX_BUFF_LIST',
      'CON_BUFF_LIST',
      'INT_BUFF_LIST',
      'PER_BUFF_LIST',
      'CHA_BUFF_LIST',
      'ATKCAC_BUFF_LIST',
      'ATKTIR_BUFF_LIST',
      'ATKMEN_BUFF_LIST',
      'ATKPIL_BUFF_LIST',
      'ATKMAG_BUFF_LIST',
      'INIT_BUFF_LIST',
      'DEF_BUFF_LIST',
      'PV_BUFF_LIST',
    ],
    function (values) {
      const aliases = {
        FOR_BUFF_LIST: 'FOR',
        DEX_BUFF_LIST: 'DEX',
        CON_BUFF_LIST: 'CON',
        INT_BUFF_LIST: 'INT',
        PER_BUFF_LIST: 'PER',
        CHA_BUFF_LIST: 'CHA',
        ATKCAC_BUFF_LIST: 'ATC',
        ATKTIR_BUFF_LIST: 'ATD',
        ATKMEN_BUFF_LIST: 'MEN',
        ATKPIL_BUFF_LIST: 'PIL',
        ATKMAG_BUFF_LIST: 'MAG',
        INIT_BUFF_LIST: 'INIT',
        DEF_BUFF_LIST: 'DEF',
        PV_BUFF_LIST: 'PV',
      };
      buffRepeat = [];
      for (const buffs of Object.keys(values)) {
        const buffList = stringOrDefault(values[buffs]);
        if (buffList == '') {
          continue;
        }
        for (const buff of buffList.split(';')) {
          let buffName = stringOrDefault(buff.split(':')[0]);
          let buffVal = stringOrDefault(buff.split(':')[1]);
          if (buffName != '' && buffVal != '') {
            buffName = buffName.trim().toLowerCase();
            buffEnabled = !buffName.startsWith('-');
            if (!buffEnabled) buffName = buffName.substring(1);
            buffVal = buffVal.trim();
            const newItem = {
              name: buffName,
              value: `${aliases[buffs]} : ${buffVal}`,
              enabled: buffEnabled,
            };
            const foundItem = buffRepeat.findIndex(
              (item) => item.name == newItem.name
            );
            if (foundItem == -1) {
              buffRepeat.push(newItem);
            } else {
              buffRepeat[foundItem].value += `; ${newItem.value}`;
            }
          }
        }
      }
      for (const buffItem of buffRepeat) {
        const rowId = 'repeating_buffs_' + generateRowID();
        let newRow = {};
        newRow[`${rowId}_buffon`] = buffItem.enabled ? '1' : '0';
        newRow[`${rowId}_buffnom`] =
          buffItem.name.substring(0, 1).toUpperCase() +
          buffItem.name.substring(1);
        newRow[`${rowId}_buffmods`] = buffItem.value;
        setAttrs(newRow);
      }
    }
  );
}

function migrateSheetV3_1() {
  getSectionIDs('repeating_materiel', function (ids) {
    for (const id of ids) {
      getAttrs([`repeating_materiel_${id}_mat-desc`], function (value) {
        const rowId = 'repeating_equipement_' + generateRowID();
        let newRow = {};
        newRow[`${rowId}_equip-desc`] = value[Object.keys(value)[0]];
        newRow[`${rowId}_equip-enc`] = 0;
        newRow[`${rowId}_equip-qte`] = 1;
        newRow[`${rowId}_equip-on`] = '0';
        setAttrs(newRow);
      });
    }
  });
}

function migrateSheetV3_2() {
  const vrNames = [];
  for (v = 1; v < 10; v++) {
    for (r = 1; r < 6; r++) {
      vrNames.push(`voie${v}-${r}`);
    }
  }
  getAttrs(vrNames, function (values) {
    const vrFlags = {};
    Object.keys(values).forEach((name) => {
      const flag = name.replace('oie', '').replace('-', 'r');
      if (values[name] !== '') {
        vrFlags[flag] = '1';
      } else {
        vrFlags[flag] = '0';
      }
    });
    setAttrs(vrFlags);
  });
}

function migrateSheetV3_9() {
  const abilities = [];
  for (v = 1; v < 10; v++) {
    for (r = 1; r < 6; r++) {
      abilities.push(`voie${v}-${r}`);
    }
  }
  getAttrs(abilities, function (values) {
    const abilityAttrs = {};
    Object.keys(values).forEach((ability) => {
      if (!values[ability] || values[ability] === '') return;
      const data = values[ability].split('\n');
      const title = data.shift();
      let desc = '';
      if (data.length > 0) desc = data.join('\n');
      abilityAttrs[ability] = desc;
      abilityAttrs[ability.replace('-', '-t')] = title;
    });
    clog(abilityAttrs, 'statblock import -> ability');
    setAttrs(abilityAttrs);
  });
}

function migrateSheetV3_15_PC() {
  getAttrs(["PV_NIVEAU", "PV_max", "logvers"], function (values) {
    const pv_niveau = stringOrDefault(values.PV_NIVEAU);
    if (pv_niveau === "") return;

    let logvers = stringOrDefault(values.logvers);
    let logv = "Migration Version 3.15.0 - " + new Date().toLocaleDateString();
    let pv_max = 0;
    let pv = [];
    try {
      pv = JSON.parse(pv_niveau);
    } catch (e) {}
    if (pv.length === 0) {
      logv += ` : erreur PV_NIVEAU ${pv_niveau}\n`
    } else {
      for (n=0; n <= 9; n++) {
        pv_max += int(pv[n]);
      }
      if (pv_max !== int(values.PV_max)) {
        logv += `PV : ${PV_max}, PV calculés : ${pv_max}\n`;
      } else {
        logv += " : Succès\n";
      }
    }
    setAttrs({ logvers: logv + logvers });
  });
}

function migrateSheetV3_15_Dice(options) {
  getSectionIDs(options.section, function(ids) {
    ids.forEach(id => {
      getAttrs([
        `repeating_${options.section}_${id}_${options.jetde}`, 
        `repeating_${options.section}_${id}_${options.typejet}`, 
        "logvers"
        ], function(values) {
        const jetde = Object.keys(values)[0];
        const typejet = Object.keys(values)[1];
        let logvers = stringOrDefault(values.logvers);
        if (values[typejet] === "!") {
          const attrs = {};
          attrs[jetde] = values[jetde] += "!";
          attrs[typejet] = values[typejet] = "";
          attrs["logvers"] = `Migration ${options.section}-${id} \n` + logvers;
          setAttrs(attrs);
        }
      });
    });
  });
}

function migrateSheetV3_15() {
  getAttrs(["type_personnage"], function (v) {
    if (v.type_personnage === SHEET_PC) migrateSheetV3_15_PC();
    if (v.type_personnage === SHEET_PC) migrateSheetV3_15_Dice({ section: "jetcapas", jetde: "jetcapade", typejet: "jetcapatypjet" });
    if (v.type_personnage === SHEET_VEHICLE) migrateSheetV3_15_Dice({ section: "jetv", jetde: "jetvde", typejet: "jetvtypjet" });
  });
}

function migrateSheet(verfdp, newver) {
  // version 1.x > 2.0
  if (verfdp.major < 2) {
    migrateSheetV2();
    clog(newver, 'migrate sheet');
  }
  // version 2.x > 2.5
  if (verfdp.major == 2 && verfdp.minor < 5) {
    migrateSheetV2_5();
    clog(newver, 'migrate sheet');
  }
  // version 2.x > 2.9
  if (verfdp.major == 2 && verfdp.minor < 9) {
    migrateSheetV2_9();
    clog(newver, 'migrate sheet');
  }
  // version 2.9 > 3.0
  if (verfdp.major < 3) {
    migrateSheetV3();
    clog(newver, 'migrate sheet');
  }
  // version 3.0 > 3.1
  if (verfdp.major == 3 && verfdp.minor < 1) {
    migrateSheetV3_1();
    clog(newver, 'migrate sheet');
  }
  // version 3.1 > 3.2
  if (verfdp.major == 3 && verfdp.minor < 2) {
    migrateSheetV3_2();
    clog(newver, 'migrate sheet');
  }
  // version 3.2 > 3.9
  if (verfdp.major == 3 && verfdp.minor < 9) {
    migrateSheetV3_9();
    clog(newver, 'migrate sheet');
  }
  if (verfdp.major == 3 && verfdp.minor < 15) {
    migrateSheetV3_15();
    clog(newver, 'migrate sheet');
  }
}

/**
* Parse semantic version label
* @param {string} version
*/
function parseSemVer(version) {
  version += '.0.0';
  if (version.toLowerCase().startsWith('v')) version = version.slice(1);
  const semVer = version.split('.');
  return {
    major: int(semVer[0]),
    minor: int(semVer[1]),
    patch: int(semVer[2]),
  };
}

/**
* Get character token's URL
* @param {object} values attribute values
* @returns URL for character token
*/
function getTokenURL(values) {
  let token_url = stringOrDefault(values.character_token);
  if (token_url !== '') token_url = token_url.split('?')[0];
  return token_url;
}

/**
* On opening the character sheet :
* - Perform sheet version updates
* - Update some default attribute values
* - One-time setup some new attribute values
* - Rebuild derived attributes
*/
on('sheet:opened', function () {
  // **** Gestion transition de version
  getAttrs(['debug_mode', 'VERSION', 'VERFDP'], function (values) {
    const debug_mode = int(values.debug_mode);
    wkrSettings.debugMode = debug_mode === 1;
    clog(
      "Running sheetworker script... " + (wkrSettings.debugMode ? "DEBUG" : "PROD"), 
      "",
      { text:"white", back:"brown" }
    );
    const verfdp = parseSemVer(values.VERSION);
    const newver = parseSemVer(values.VERFDP);
    if (
      verfdp.major < newver.major ||
      verfdp.minor < newver.minor ||
      verfdp.patch < newver.patch
    ) {
      migrateSheet(verfdp, newver);
    }
    setAttrs({ VERSION: values.VERFDP });
  });
  // check type
  getAttrs(
    ['type_personnage', 'lib_profil', 'lib_famille', 'lib_origine'],
    function (values) {
      const isVehicle = values.type_personnage === 'vehicule';
      const lib_profil = isVehicle ? 'Type' : values.lib_profil;
      const lib_famille = isVehicle ? ' ' : values.lib_famille;
      const lib_origine = isVehicle ? ' ' : values.lib_origine;
      const physical_traits = isVehicle ? '0' : '1';
      setAttrs({
        lib_profil: lib_profil,
        lib_famille: lib_famille,
        lib_origine: lib_origine,
        physical_traits: physical_traits,
      });
    }
  );
  // MAJ LAST_PV
  getAttrs(['PV'], function (v) {
    setAttrs({ LAST_PV: v.PV });
  });
  // MAJ token
  getAttrs(['vehicle_starship', 'vehicle_mecha', 'character_token'], function (values) {
    const token_url = getTokenURL(values);
    setAttrs({ token_url });
  });
  // seuil_enc (if needed)
  getAttrs(['seuil_enc', 'FORCE'], function (values) {
    let seuil_enc = int(values.seuil_enc);
    if (seuil_enc === 0) {
      setAttrs({
        seuil_enc: int(values.FORCE),
      });
    }
  });
  // rebuild derived attributes
  rebuildAll();
  // update INIT
  updateINIT();
  // update DEF
  updateDEF();
});

[
  { button: "subtab2_skills", attribute: "subtab2", value: "skills" },
  { button: "subtab2_traits", attribute: "subtab2", value: "traits" },
  { button: "subtab2_buffs", attribute: "subtab2", value: "buffs" }
].forEach(swapTab => {
  on(`clicked:${swapTab.button}`, () => {
    const swap = {};
    swap[swapTab.attribute] = swapTab.value;
    setAttrs(swap);
  });
}); 

/**
* Parse a buff text
* @param {string} v Buff text
* @param {object} caracs CARACS attribute deserialized as an object
* @returns Buff value as number
*/
function buffValue(v, caracs) {
  v = v.trim();
  let bv = 0;
  let bm = 1;
  if (v.startsWith('-')) {
    bm = -1;
  }
  if (v.indexOf('2[') !== -1) {
    v = v.replace('2[', '[');
    bm *= 2;
  }
  v = v.replace(/[\+\-\[\]]/g, '');
  if (isNaN(v)) {
    // c'est une référence d'attribut
    if (v.length === 5 && v.toUpperCase().startsWith('VOIE')) {
      // c'est un rang dans une voie identifiée par son no
      let rv = int(v.substring(4).trim());
      if (rv > 0) {
        bv = caracs.rangs[rv - 1];
      }
    } else if (v.toUpperCase().startsWith('RANG ')) {
      // c'est un rang dans une voie identifiée par son nom
      const vname = v.substring(4).trim().toUpperCase();
      const vfound = caracs.voies.findIndex((item) => item === vname);
      if (vfound > -1) {
        bv = caracs.rangs[vfound];
      }
    } else {
      if (caracs.hasOwnProperty(v)) {
        // c'est un mod. de carac
        bv = caracs[v];
      } else {
        // c'est une expression numérique
        for (const attr of Object.keys(caracs)) {
          const re = new RegExp(`${attr}`, 'g');
          v = v.replace(re, "caracs['$&']");
        }
        bv = eval(v);
      }
    }
  } else {
    // c'est une valeur fixe
    bv = v;
  }
  return int(bv) * bm;
}

/**
* Parse an attribute list of buffs and sets its value
* @param {string} buffAttr Name of attribute buff list to parse
*/
function parseBuff(buffAttr) {
  getAttrs([`${buffAttr}_BUFF_LIST`, 'CARACS'], function (v) {
    let buffAttr = Object.keys(v)[0];
    let buffList = v[buffAttr];
    let caracs = JSON.parse(v.CARACS);
    let buffSum = 0;
    if (buffList && buffList !== '') {
      let buffs = buffList.split(';');
      for (const buff of buffs) {
        if (buff && buff !== '') {
          let delim = buff.indexOf(':') !== -1 ? ':' : ' ';
          let buffv = buff.split(delim);
          let buffName = '';
          let buffVal = 0;
          if (delim === ' ') {
            buffVal = buffValue(buffv[buffv.length - 1], caracs);
            buffv.pop();
            buffName = buffv.join(' ').trim();
          } else {
            buffName = buffv[0].trim();
            buffVal = buffValue(buffv[1], caracs);
          }
          if (!buffName.startsWith('-')) buffSum += buffVal;
        }
      }
    }
    let attr = {};
    attr[buffAttr.replace('_LIST', '')] = buffSum;
    setAttrs(attr);
  });
}

/**
* Update buffs after an attribute value change
* @param {object} e eventInfo object
*/
function updateBuffs(e) {
  const caracs = ['FOR', 'DEX', 'CON', 'INT', 'PER', 'CHA'];
  let ref = e.sourceAttribute;
  let mod = ref.substring(0, 3);
  if (caracs.includes(mod.toUpperCase())) {
    ref = mod;
  }
  const attrs = [
    ...caracs,
    'ATKCAC',
    'ATKTIR',
    'ATKMAG',
    'ATKMEN',
    'ATKPIL',
    'INIT',
    'DEF',
    'PV',
  ];
  for (let a = 0; a < attrs.length; a++) {
    attrs[a] = `${attrs[a]}_BUFF_LIST`;
  }
  attrs.unshift(ref);
  getAttrs(attrs, function (values) {
    let props = Object.keys(values);
    for (let p = 1; p < props.length; p++) {
      let ref = props[0];
      if (props[p].startsWith(ref)) continue;
      if (values[props[p]].toLowerCase().indexOf(ref) !== -1) {
        parseBuff(props[p].replace('_BUFF_LIST', ''));
      }
    }
  });
}

/**
* On changing an attribute serialized in the CARACS attribute
*/
on(
  [
    'change:force',
    'change:dexterite',
    'change:constitution',
    'change:intelligence',
    'change:perception',
    'change:charisme',
    'change:niveau',
    'change:defarmureon',
    'change:voie1nom',
    'change:voie2nom',
    'change:voie3nom',
    'change:voie4nom',
    'change:voie5nom',
    'change:voie6nom',
    'change:voie7nom',
    'change:voie8nom',
    'change:voie9nom',
    'change:rang_voie1',
    'change:rang_voie2',
    'change:rang_voie3',
    'change:rang_voie4',
    'change:rang_voie5',
    'change:rang_voie6',
    'change:rang_voie7',
    'change:rang_voie8',
    'change:rang_voie9',
  ].join(' '),
  function (eventInfo) {
    // on reconstruit d'abord l'attribut caché CARACS...
    buildCaracs();
    // ... puis on met à jour les buffs qui contiennent une référence à la caractéristique modifiée
    updateBuffs(eventInfo);
  }
);

/**
* Update the INIT(iative) attribute
*/
function updateINIT() {
  getAttrs(
    ['DEXTERITE', 'INIT_BUFF', 'DEFARMUREON', 'DEFARMUREMALUS'],
    function (values) {
      let initVal = 0;
      initVal += int(values.DEXTERITE);
      initVal += int(values.INIT_BUFF);
      initVal -= int(values.DEFARMUREON) * int(values.DEFARMUREMALUS);
      setAttrs({ INIT: initVal });
    }
  );
}

/**
* On changing the relevant attributes
* Update the INIT(iative) attribute
*/
on(
  [
    'change:dexterite',
    'change:init_buff',
    'change:defarmureon',
    'change:defarmuremalus',
  ].join(' '),
  function () {
    updateINIT();
  }
);

/**
* Update the DEF(ense) attribute
*/
function updateDEF() {
  getAttrs(
    ['DEFARMURE', 'DEFARMUREON', 'DEXTERITE', 'DEF_BUFF', 'DEFACT'],
    function (values) {
      let defVal = 10;
      defVal += int(values.DEFARMURE) * int(values.DEFARMUREON);
      defVal += getMod(values.DEXTERITE);
      defVal += int(values.DEF_BUFF);
      defVal += int(values.DEFACT);
      setAttrs({ DEF: defVal });
    }
  );
}

/**
* On changing the relevant attributes
* Update the DEF(ense) attribute
*/
on(
  [
    'change:defarmure',
    'change:defarmureon',
    'change:dexterite',
    'change:def_buff',
    'change:defact',
  ].join(' '),
  function () {
    updateDEF();
  }
);

/**
* On changing the buff lists
*/
on('change:for_buff_list', function () {
  parseBuff('FOR');
});

on('change:dex_buff_list', function () {
  parseBuff('DEX');
});

on('change:con_buff_list', function () {
  parseBuff('CON');
});

on('change:int_buff_list', function () {
  parseBuff('INT');
});

on('change:per_buff_list', function () {
  parseBuff('PER');
});

on('change:cha_buff_list', function () {
  parseBuff('CHA');
});

on('change:atkcac_buff_list', function () {
  parseBuff('ATKCAC');
});

on('change:atktir_buff_list', function () {
  parseBuff('ATKTIR');
});

on('change:atkmen_buff_list', function () {
  parseBuff('ATKMEN');
});

on('change:atkpil_buff_list', function () {
  parseBuff('ATKPIL');
});

on('change:atkmag_buff_list', function () {
  parseBuff('ATKMAG');
});

on('change:init_buff_list', function () {
  parseBuff('INIT');
});

on('change:def_buff_list', function () {
  parseBuff('DEF');
});

on('change:pv_buff_list', function () {
  parseBuff('PV');
});

/**
* Rebuild the buff lists from the buffs repeating section
*/
function rebuildBuffs() {
  getSectionIDs('buffs', function (ids) {
    const aliases = {
      atc: 'atkcac',
      atd: 'atktir',
      cac: 'atkcac',
      contact: 'atkcac',
      cad: 'atktir',
      distance: 'atktir',
      mag: 'atkmag',
      magie: 'atkmag',
      magique: 'atkmag',
      men: 'atkmen',
      mental: 'atkmen',
      mentale: 'atkmen',
      pil: 'atkpil',
      pilotage: 'atkpil',
      tir: 'atktir',
      initiative: 'init',
    };
    let buffs = {
      for: '',
      dex: '',
      con: '',
      int: '',
      per: '',
      cha: '',
      atkcac: '',
      atktir: '',
      atkmen: '',
      atkpil: '',
      atkmag: '',
      init: '',
      def: '',
      pv: '',
    };
    for (const id of ids) {
      getAttrs(
        [
          `repeating_buffs_${id}_buffon`,
          `repeating_buffs_${id}_buffnom`,
          `repeating_buffs_${id}_buffmods`,
        ],
        function (values) {
          const enabled = int(values[Object.keys(values)[0]]);
          const buffName = values[Object.keys(values)[1]];
          const buffMods = values[Object.keys(values)[2]];
          if (enabled == 1 && buffName !== '' && buffMods !== '') {
            const mods = buffMods.split(';');
            for (const mod of mods) {
              const parsed = parseNameValue(mod);
              let attrName = parsed.name.toLowerCase();
              let attrBuff = parsed.value;
              if (Object.keys(aliases).indexOf(attrName) != -1) {
                attrName = aliases[attrName];
              }
              if (attrName !== '' && attrBuff !== '') {
                buffs[attrName] += `${buffName} : ${attrBuff}; `;
              }
            }
          }
          let setBuffs = {};
          for (const attr in buffs) {
            setBuffs[`${attr.toUpperCase()}_BUFF_LIST`] = buffs[attr];
          }
          setAttrs(setBuffs);
        }
      );
    }
  });
}

/**
* On changing or removing an entry in the buff repeating section
* - Rebuild the buff lists
*/
on('change:repeating_buffs', function () {
  rebuildBuffs();
});

on('remove:repeating_buffs', function () {
  rebuildBuffs();
});

/**
* On changing the 'Blessure' checkbox
* - Set the ETATDE attribute (roll d20 or d12)
* - Or enable POISSE in the 'Monstres' setting
*/
on('change:blessure', function () {
  getAttrs(['coc_setting', 'BLESSURE'], function (values) {
    let attrs = {};
    if (values.coc_setting === 'monstres') {
      attrs.ETATDE = '12';
      attrs.POISSE = values.BLESSURE;
    } else {
      attrs.ETATDE = values.BLESSURE === '1' ? '12' : '20';
    }
    setAttrs(attrs);
  });
});

/**
* On changing the 'POISSE' checkbox
* - Set the standard rolls
*/
on('change:poisse', function () {
  getAttrs(['POISSE'], function (values) {
    const jetn = values.POISSE === '1' ? '2d@{ETATDE}kl1' : '1d@{ETATDE}';
    const jets = values.POISSE === '1' ? '1d@{ETATDE}' : '2d@{ETATDE}kh1';
    const jetsh =
      values.POISSE === '1' ? '2d@{ETATDE}kh1' : '{2d@{ETATDE}kh1, 0d20+10}kh1';
    const jetr = values.POISSE === '1' ? '2d12kl1' : '1d12';
    setAttrs({
      JETNORMAL: jetn,
      JETSUP: jets,
      JETSUPHERO: jetsh,
      JETRISQUE: jetr,
      JDEX: jetn,
      JDEXSUP: jets,
      JDEXSUPHERO: jetsh,
      JDEXRISQUE: jetr,
    });
  });
});

/**
* On changing the 'PV' value
* - Set the 'BLESSURE' attribute
*/
on('change:pv', function () {
  getAttrs(
    ['PV', 'PV_max', 'LAST_PV', 'SEUILBG', 'BLESSURE'],
    function (values) {
      const seuilbg = int(values.SEUILBG);
      const max_pv = int(values.PV_max);
      const last_pv = int(values.LAST_PV, max_pv);
      const curr_pv = int(values.PV);
      let blessure = values.BLESSURE;
      if (seuilbg > 0) {
        if (last_pv - curr_pv >= seuilbg || curr_pv === 0) {
          blessure = '1';
        }
      }
      setAttrs({
        LAST_PV: values.PV,
        BLESSURE: blessure,
      });
    }
  );
});

/**
* On changing (pasting) an NPC statblock
* - Parse the statblock text
* - Create the NPC character sheet
*/
on('clicked:statblockimport-btn', function () {
  getAttrs(['UNIVERS', 'statblock'], function (values) {
    if (values.statblock.trim() === '') return;
    let messages = '';
    // parse statblock text
    pnjObj = importStatblock(values.statblock);
    if (pnjObj) {
      clog(pnjObj, 'statblock import -> NPC object');
      // process base characteristics & combat attributes
      messages = processBaseAttributes(values.UNIVERS, pnjObj);
      // process attack lines
      if (pnjObj.Atks.length > 0) {
        result = processAttacks(values.UNIVERS, pnjObj);
        if (result != '' && messages != '') {
          result = '\n' + result;
        }
        messages += result;
      }
      delete pnjObj.Atks;
      // process trait/ability lines
      if (pnjObj.Capas.length > 0) {
        result = processTraits(values.UNIVERS, pnjObj);
        if (result != '' && messages != '') {
          result = '\n' + result;
        }
        messages += result;
      }
      delete pnjObj.Capas;
      // Other attributes go to DIVERS field
      let divers = '';
      if (pnjObj.Extras.length > 0) {
        divers = pnjObj.Extras.join('\n');
      }
      delete pnjObj.Extras;
      const otherAttrs = Object.keys(pnjObj);
      clog(otherAttrs, 'statblock import -> additional data');
      for (const other of otherAttrs) {
        divers += '\n' + other + ' ' + pnjObj[other];
      }
      setAttrs({
        pnj_divers: divers,
        sbresult: messages,
      });
    }
  });
});

/**
* Convert an NPC to a PC character sheet
*/
function convertToPC() {
  const npcAtkAttribs = [
    'atkatt',
    'atknom',
    'atkjet',
    'atkbonus',
    'atkcrit',
    'atkdmg',
    'atkdmnbde',
    'atkdmde',
    'atkdmbonus',
    'atkportee',
    'atkspec',
  ];

  getAttrs(
    [
      'pnj_for',
      'pnj_dex',
      'pnj_con',
      'pnj_int',
      'pnj_per',
      'pnj_cha',
      'pnj_jetfor',
      'pnj_jetdex',
      'pnj_jetcon',
      'pnj_jetint',
      'pnj_jetper',
      'pnj_jetcha',
      'pnj_init',
      'pnj_def',
      'pnj_pv',
      'pnj_pv_max',
    ],
    function (values) {
      let attrs = {};
      for (let attr of [
        'FORCE',
        'DEXTERITE',
        'CONSTITUTION',
        'INTELLIGENCE',
        'PERCEPTION',
        'CHARISME',
      ]) {
        let attrv = int(values[`pnj_${attr.substring(0, 3).toLowerCase()}`]);
        attrs[attr] = 10 + 2 * attrv;
        if (attr === 'DEXTERITE') {
          let init = int(values.pnj_init);
          if (init === attrv + 1) {
            attrs[attr]++;
          } else {
            attrs.INIT_BUFF = init - attrs[attr];
          }
          let defb = 10 + attrv;
          let def = int(values.pnj_def);
          if (def !== defb) {
            attrs.DEF_BUFF = def - defb;
          }
          attrs.DEX_SUP =
            values.pnj_jetdex === '2d20kh1' ? '@{JDEXSUP}' : '@{JDEX}';
        } else {
          attrs[`${attr.substring(0, 3)}_SUP`] =
            values[`pnj_jet${attr.substring(0, 3).toLowerCase()}`] === '2d20kh1'
              ? '@{JETSUP}'
              : '@{JETNORMAL}';
        }
      }
      attrs.PV = int(values.pnj_pv);
      attrs.PV_max = int(values.pnj_pv_max);
      getSectionIDs('repeating_armes', function (ids) {
        for (let id of ids) {
          removeRepeatingRow(`repeating_armes_${id}`);
        }
      });
      getSectionIDs('repeating_pnjatk', function (ids) {
        for (let id of ids) {
          getAttrs(
            [
              ...npcAtkAttribs.map((attr) => `repeating_pnjatk_${id}_${attr}`),
              'pnj_for',
              'pnj_dex',
              'pnj_cha',
            ],
            function (values) {
              clog(values, 'statblock import -> NPC attack');
              let v = {};
              for (const attr of npcAtkAttribs) {
                v[attr] = stringOrDefault(values[`repeating_pnjatk_${id}_${attr}`]);
              }
              newRowID = 'repeating_armes_' + generateRowID();
              let atkRow = {};
              atkRow[`${newRowID}_armeatt`] = v.atkatt;
              atkRow[`${newRowID}_armenom`] = v.atknom;
              let magic = v.atknom.toLowerCase().includes('attaque magique');
              let tohit = int(v.atkbonus);
              let atk = 0;
              let bdm = 0;
              if (v.atkportee && v.atkportee !== '') {
                atk = magic ? int(values.pnj_cha) : int(values.pnj_dex);
                atkRow[`${newRowID}_armeatk`] = magic
                  ? '@{ATKMAG}'
                  : '@{ATKTIR}';
              } else {
                atk = magic ? int(values.pnj_cha) : int(values.pnj_for);
                bdm = magic ? 0 : atk;
                atkRow[`${newRowID}_armeatk`] = magic
                  ? '@{ATKMAG}'
                  : '@{ATKCAC}';
                atkRow[`${newRowID}_armedmcar`] = magic ? '' : '@{FOR}';
              }
              if (tohit !== atk) {
                atkRow[`${newRowID}_armeatkdiv`] = tohit - atk;
              }
              atkRow[`${newRowID}_armejetd`] = v.atkjet;
              atkRow[`${newRowID}_armecrit`] = v.atkcrit;
              atkRow[`${newRowID}_armedmg`] = v.atkdmg;
              atkRow[`${newRowID}_armedmnbde`] = v.atkdmnbde;
              atkRow[`${newRowID}_armedmde`] = v.atkdmde;
              let dmdiv = int(v.atkdmbonus);
              if (dmdiv !== bdm) {
                atkRow[`${newRowID}_armedmdiv`] = dmdiv - bdm;
              }
              atkRow[`${newRowID}_armeportee`] = v.atkportee;
              atkRow[`${newRowID}_armespec`] = v.atkspec;
              setAttrs(atkRow);
            }
          );
        }
      });
      setAttrs(attrs);
    }
  );
}

/**
* On changing the sheet type
* - Convert an NPC to a PC
*/
on('change:type_personnage', function (eventInfo) {
  if (eventInfo.previousValue === 'pnj' && eventInfo.newValue === 'pj') {
    convertToPC();
  }
  // if (eventInfo.previousValue === 'pj' && eventInfo.newValue === 'pnj') convertToNPC();
  getAttrs(
    ['type_personnage', 'lib_profil', 'lib_famille', 'lib_origine'],
    function (values) {
      const isVehicle = values.type_personnage === 'vehicule';
      setAttrs({
        type_fiche: values.type_personnage,
        lib_profil: isVehicle ? 'Type' : values.lib_profil,
        lib_famille: isVehicle ? ' ' : values.lib_famille,
        lib_origine: isVehicle ? ' ' : values.lib_origine,
        physical_traits: isVehicle ? '0' : '1',
      });
    }
  );
});

/**
* Initialize an array of abilities
* @param {string} voie path #
* @returns Array of attribute names
*/
function attrRanks(voie) {
  let attrs = [];
  for (let r = 1; r < 6; r++) {
    attrs.push(`v${voie}r${r}`);
    attrs.push(`voie${voie}-${r}`);
  }
  return attrs;
}

/**
* Determine current rank in a path
* @param {string} voie path #
*/
function setRank(voie) {
  getAttrs(attrRanks(voie), function (v) {
    let vr = 0;
    for (let r = 1; r < 6; r++) {
      const flag = int(v[`v${voie}r${r}`]);
      const title = stringOrDefault(v[`voie${voie}-t${r}`]);
      const text = stringOrDefault(v[`voie${voie}-${r}`]);
      if (flag === 1 && (title !== '' || text !== '')) {
        vr = r;
      }
    }
    let attrs = {};
    attrs[`RANG_VOIE${voie}`] = vr;
    setAttrs(attrs);
    buildCaracs();
  });
}

/**
* On changing any of the paths info (title or abilities)
* - Determine the current rank in the path
* - Rebuild the CARACS attribute
*/
on(
  [
    'change:voie1nom',
    'change:voie1-t1',
    'change:voie1-t2',
    'change:voie1-t3',
    'change:voie1-t4',
    'change:voie1-t5',
    'change:voie1-1',
    'change:voie1-2',
    'change:voie1-3',
    'change:voie1-4',
    'change:voie1-5',
    'change:v1r1',
    'change:v1r2',
    'change:v1r3',
    'change:v1r4',
    'change:v1r5',
  ].join(' '),
  function () {
    setRank('1');
    buildAbilities(1);
  }
);

on(
  [
    'change:voie2nom',
    'change:voie2-t1',
    'change:voie2-t2',
    'change:voie2-t3',
    'change:voie2-t4',
    'change:voie2-t5',
    'change:voie2-1',
    'change:voie2-2',
    'change:voie2-3',
    'change:voie2-4',
    'change:voie2-5',
    'change:v2r1',
    'change:v2r2',
    'change:v2r3',
    'change:v2r4',
    'change:v2r5',
  ].join(' '),
  function () {
    setRank('2');
    buildAbilities(2);
  }
);

on(
  [
    'change:voie3nom',
    'change:voie3-t1',
    'change:voie3-t2',
    'change:voie3-t3',
    'change:voie3-t4',
    'change:voie3-t5',
    'change:voie3-1',
    'change:voie3-2',
    'change:voie3-3',
    'change:voie3-4',
    'change:voie3-5',
    'change:v3r1',
    'change:v3r2',
    'change:v3r3',
    'change:v3r4',
    'change:v3r5',
  ].join(' '),
  function () {
    setRank('3');
    buildAbilities(3);
  }
);

on(
  [
    'change:voie4nom',
    'change:voie4-t1',
    'change:voie4-t2',
    'change:voie4-t3',
    'change:voie4-t4',
    'change:voie4-t5',
    'change:voie4-1',
    'change:voie4-2',
    'change:voie4-3',
    'change:voie4-4',
    'change:voie4-5',
    'change:v4r1',
    'change:v4r2',
    'change:v4r3',
    'change:v4r4',
    'change:v4r5',
  ].join(' '),
  function () {
    setRank('4');
    buildAbilities(4);
  }
);

on(
  [
    'change:voie5nom',
    'change:voie5-t1',
    'change:voie5-t2',
    'change:voie5-t3',
    'change:voie5-t4',
    'change:voie5-t5',
    'change:voie5-1',
    'change:voie5-2',
    'change:voie5-3',
    'change:voie5-4',
    'change:voie5-5',
    'change:v5r1',
    'change:v5r2',
    'change:v5r3',
    'change:v5r4',
    'change:v5r5',
  ].join(' '),
  function () {
    setRank('5');
    buildAbilities(5);
  }
);

on(
  [
    'change:voie6nom',
    'change:voie6-t1',
    'change:voie6-t2',
    'change:voie6-t3',
    'change:voie6-t4',
    'change:voie6-t5',
    'change:voie6-1',
    'change:voie6-2',
    'change:voie6-3',
    'change:voie6-4',
    'change:voie6-5',
    'change:v6r1',
    'change:v6r2',
    'change:v6r3',
    'change:v6r4',
    'change:v6r5',
  ].join(' '),
  function () {
    setRank('6');
    buildAbilities(6);
  }
);

on(
  [
    'change:voie7nom',
    'change:voie7-t1',
    'change:voie7-t2',
    'change:voie7-t3',
    'change:voie7-t4',
    'change:voie7-t5',
    'change:voie7-1',
    'change:voie7-2',
    'change:voie7-3',
    'change:voie7-4',
    'change:voie7-5',
    'change:v7r1',
    'change:v7r2',
    'change:v7r3',
    'change:v7r4',
    'change:v7r5',
  ].join(' '),
  function () {
    setRank('7');
    buildAbilities(7);
  }
);

on(
  [
    'change:voie8nom',
    'change:voie8-t1',
    'change:voie8-t2',
    'change:voie8-t3',
    'change:voie8-t4',
    'change:voie8-t5',
    'change:voie8-1',
    'change:voie8-2',
    'change:voie8-3',
    'change:voie8-4',
    'change:voie8-5',
    'change:v8r1',
    'change:v8r2',
    'change:v8r3',
    'change:v8r4',
    'change:v8r5',
  ].join(' '),
  function () {
    setRank('8');
    buildAbilities(8);
  }
);

on(
  [
    'change:voie9nom',
    'change:voie9-t1',
    'change:voie9-t2',
    'change:voie9-t3',
    'change:voie9-t4',
    'change:voie9-t5',
    'change:voie9-1',
    'change:voie9-2',
    'change:voie9-3',
    'change:voie9-4',
    'change:voie9-5',
    'change:v9r1',
    'change:v9r2',
    'change:v9r3',
    'change:v9r4',
    'change:v9r5',
  ].join(' '),
  function () {
    setRank('9');
    buildAbilities(9);
  }
);

/**
* On changing the 2nd damage info
* - Set the roll macro for the 2nd damage
*/
on(
  [
    'change:repeating_armes:armedm2_de',
    'change:repeating_armes:armedm2_desc',
  ].join(' '),
  function () {
    getAttrs(
      ['repeating_armes_armedm2_de', 'repeating_armes_armedm2_desc'],
      function (values) {
        let dm2_de = stringOrDefault(values.repeating_armes_armedm2_de);
        let dm2_desc = stringOrDefault(values.repeating_armes_armedm2_desc);
        let dmg2 = '';
        if (dm2_desc !== '') {
          dm2_desc = `[${dm2_desc}] `;
        }
        if (dm2_de !== '') {
          dmg2 = `[[${dm2_de}${dm2_desc}]]`;
        }
        setAttrs({
          repeating_armes_armedmg2: dmg2,
        });
      }
    );
  }
);

/**
* On changing the attack range
* - Set the ranged attack text for the roll template
*/
on('change:repeating_armes:armeportee', function () {
  getAttrs(['repeating_armes_armeportee'], function (value) {
    let um = '';
    if (value.repeating_armes_armeportee.indexOf(' m') !== -1) {
      um = ' m';
    } else if (value.repeating_armes_armeportee.indexOf('m') !== -1) {
      um = 'm';
    }
    let portee = value.repeating_armes_armeportee;
    if (um !== '') {
      portee = portee.replace(um, '');
    }
    let portees = int(portee);
    if (portees !== 0) {
      setAttrs({
        repeating_armes_armeportees: `${portees}m | ${portees * 2}m (-5) | ${
          portees * 3
        }m (-10)`,
      });
    }
  });
});

/**
* Process a limited action checkbox attribute
* @param {object} v Attributes object
* @returns (L) if limited action
*/
function actionLimitee(v) {
  return int(v[Object.keys(v)[0]]) === 1 ? '(L)' : '';
}

/**
* On changing an attack limited action checkbox
* - Set the limited action portion of the roll macro
*/
on('change:repeating_armes:arme_al', function () {
  getAttrs(['repeating_armes_arme_al'], function (value) {
    setAttrs({
      repeating_armes_armelim: actionLimitee(value),
    });
  });
});

/**
* On changing an ability limited action checkbox
* - Set the limited action portion of the roll macro
*/
on('change:repeating_jetcapas:jetcapa_al', function () {
  getAttrs(['repeating_jetcapas_jetcapa_al'], function (value) {
    setAttrs({
      repeating_jetcapas_jetcapalim: actionLimitee(value),
    });
  });
});

/**
* On changing ranks modifier attributes
* - Set the ability/skill description
*/
on(
  [
    'change:repeating_jetcapas:jetcapavoie',
    'change:repeating_jetcapas:jetcapacoeff',
    'change:repeating_jetcapas:jetcaparang',
  ].join(' '),
  function () {
    getAttrs(
      [
        'repeating_jetcapas_jetcapavoie',
        'repeating_jetcapas_jetcapacoeff',
        'repeating_jetcapas_jetcaparang',
        'CARACS',
      ],
      function (values) {
        const caracs = JSON.parse(values.CARACS);
        const voierang = stringOrDefault(values.repeating_jetcapas_jetcapavoie);
        const coeff = int(values.repeating_jetcapas_jetcapacoeff);
        let vn = 0;
        let rang = stringOrDefault(values.repeating_jetcapas_jetcaparang);
        if (rang.startsWith('@{') && rang.endsWith('}')) {
          vn = int(rang.slice(rang.length - 2, rang.length - 1), -1);
          if (vn >= 0) {
            voie = stringOrDefault(caracs.voies[vn - 1]);
            if (voie !== '') {
              voie = voie.slice(0, 1) + voie.slice(1).toLowerCase();
            }
            rang = int(caracs.rangs[vn - 1]);
          }
        }
        let skill = voierang;
        if (voie !== '' && coeff !== 0 && rang !== 0) {
          skill = `Bonus ${voie}, rang ${rang} : [[${coeff}[Bonus]*${rang}[rang ${voie}] ]]`;
        }
        setAttrs({
          repeating_jetcapas_jetcapaskill: skill,
        });
      }
    );
  }
);

/**
* On changing path & rank number attributes
* - Set the path & rank identifier (v?r?)
*/
on(
  [
    'change:repeating_jetcapas:jetcapavoieno',
    'change:repeating_jetcapas:jetcapavoierang',
  ].join(' '),
  function () {
    getAttrs(
      [
        'repeating_jetcapas_jetcapavoieno',
        'repeating_jetcapas_jetcapavoierang',
      ],
      function (values) {
        const vr = `${values.repeating_jetcapas_jetcapavoieno}${values.repeating_jetcapas_jetcapavoierang}`;
        if (vr.length !== 4) return;
        const rankData = [];
        rankData.push(vr.replace('v', 'voie').replace('r', '-t'));
        rankData.push(vr.replace('v', 'voie').replace('r', '-'));
        getAttrs(rankData, function (values) {
          const rankName = values[Object.keys(values)[0]];
          const rankDesc = values[Object.keys(values)[1]];
          const updated = {
            repeating_jetcapas_jetcapanom: rankName,
            repeating_jetcapas_jetcapadesc: rankDesc,
            repeating_jetcapas_jetcapavr: vr,
          };
          setAttrs(updated);
        });
      }
    );
  }
);

/**
* Return a pilot-qualified characteristic name
* @param {string} pilote Character name of vehicle pilot
* @param {string} carac Vehicle pilot characteristic name
*/
function pilotStat(pilote, carac) {
  let pilote_carac = '0';
  if (carac !== '0') {
    if (pilote !== '') {
      pilote += '|';
    }
    pilote_carac = carac.replace('@{', `@{${pilote}`);
  }
  return pilote_carac;
}

/**
* On changing a vehicle 'PILOTE' attribute
* - Update the vehicle rolls
*/
on('change:pilote', function () {
  getAttrs(['PILOTE'], function (value) {
    const pilote = stringOrDefault(value.PILOTE).trim();
    if (pilote === '') {
      return;
    }
    getSectionIDs('repeating_jetv', function (ids) {
      for (let id = 0; id < ids.length; id++) {
        getAttrs(
          [
            `repeating_jetv_${ids[id]}_jetvcaracpil`,
            `repeating_jetv_${ids[id]}_jetvcaracp`,
          ],
          function (values) {
            let attr = values[Object.keys(values)[0]];
            let pilote_carac = '0';
            if (attr !== '0') pilote_carac = pilotStat(pilote, attr);
            let rattr = {};
            rattr[Object.keys(values)[1]] = pilote_carac;
            setAttrs(rattr);
          }
        );
      }
    });
  });
});

/**
* On changing a pilot characteristic in a vehicle roll
* - Update the vehicle roll
*/
on('change:repeating_jetv:jetvcaracpil', function () {
  getAttrs(['PILOTE', 'repeating_jetv_jetvcaracpil'], function (values) {
    const pilote = stringOrDefault(values.PILOTE);
    const carac = stringOrDefault(values.repeating_jetv_jetvcaracpil);
    let pilote_carac = '0';
    if (carac !== '0') pilote_carac = pilotStat(pilote, carac);
    setAttrs({
      repeating_jetv_jetvcaracp: pilote_carac,
    });
  });
});

/**
* Compute character encumbrance
*/
function encumbrance() {
  getSectionIDs('repeating_equipement', function (ids) {
    setAttrs({ total_enc: 0 });
    const encombrement = {
      total: 0,
      zeros: 0,
    };
    for (const id of ids) {
      getAttrs(
        [
          `repeating_equipement_${id}_equip-qte`,
          `repeating_equipement_${id}_equip-enc`,
          `repeating_equipement_${id}_equip-on`,
        ],
        function (values) {
          const qte = int(values[Object.keys(values)[0]]);
          const enc = int(values[Object.keys(values)[1]]);
          const equipe = int(values[Object.keys(values)[2]]);
          if (equipe === 1) {
            if (enc === 0) {
              encombrement.zeros += qte;
              if (encombrement.zeros >= 3) {
                encombrement.total += Math.floor(encombrement.zeros / 3);
                encombrement.zeros %= 3;
              }
            } else {
              encombrement.total += qte * enc;
            }
            setAttrs({ total_enc: encombrement.total });
          }
        }
      );
    }
  });
}

/**
* Rebuild the list of equipments with Udie
*/
function rebuildUD() {
  getAttrs(['coc_setting'], function (v) {
    if (v.coc_setting !== 'bitume') return;
    getSectionIDs('repeating_equipement', function (ids) {
      var uds = [];
      ids.forEach((id, ix) => {
        const rowId = `repeating_equipement_${id}_`;
        getAttrs(
          [`${rowId}equip-desc`, `${rowId}equip-props`],
          function (values) {
            const desc = values[Object.keys(values)[0]];
            const props = stringOrDefault(values[Object.keys(values)[1]]).split(',');
            const uD = props.find((prop) => {
              return (
                prop !== '' && parseNameValue(prop).name.toUpperCase() === 'UD'
              );
            });
            let dU = 0;
            if (uD !== undefined) {
              dU = int(parseNameValue(uD).value.replace(/d/g, ''));
            }
            if (dU !== 0) {
              uds.push(`${desc},d${dU}`);
            }
            if (ix == ids.length - 1) {
              let qryud = '';
              if (uds.length == 1) {
                qryud = uds[0].split(',')[1];
              } else if (uds.length > 1) {
                qryud = `?{Dé d'usure ?|${uds.join('|')}}`;
              }
              setAttrs({ QRYUD: qryud });
            }
          }
        );
      });
    });
  });
}

/**
* On changing character equipment
* - Recompute character encumbrance
*/
on(
  ['change:repeating_equipement', 'remove:repeating_equipement'].join(' '),
  function () {
    encumbrance();
    rebuildUD();
  }
);

/**
* On changing equipment properties
* - Change DEF & RD for armor
* - Add or remove attack line for a weapon
*/
on(
  [
    'change:repeating_equipement:equip-props',
    'change:repeating_equipement:equip-on',
    'change:repeating_equipement:equip-atk',
  ].join(' '),
  function (eventInfo) {
    getAttrs(
      [
        'repeating_equipement_equip-props',
        'repeating_equipement_equip-on',
        'repeating_equipement_equip-atk',
        'repeating_equipement_equip-atkid',
        'repeating_equipement_equip-desc',
        'DEFARMURE',
        'DEFARMUREON',
        'DEFARMUREMALUS',
        'RDS',
      ],
      function (values) {
        const props = values[Object.keys(values)[0]];
        const eqpon = int(values[Object.keys(values)[1]]);

        const attrs = {};

        const hasAtk = int(values[Object.keys(values)[2]]);
        let atkId = values[Object.keys(values)[3]];
        if (eventInfo.sourceAttribute.endsWith('equip-atk') && !hasAtk) {
          if (atkId) {
            removeRepeatingRow(`repeating_armes_${atkId}`);
            attrs['repeating_equipement_equip-atkid'] = '';
            setAttrs(attrs);
          }
          return;
        }

        const atkName = values[Object.keys(values)[4]];
        let atkInfo = { type: '@{ATKCAC}' };

        for (const prop of props.split(',')) {
          const parsed = parseNameValue(prop);
          const propName = parsed.name ? parsed.name.toUpperCase() : '';
          // Armor DEF modifier
          if (propName === 'DEF') {
            const propVal = int(parsed.value);
            attrs.DEFARMUREON = eqpon;
            if (eqpon === 1) {
              if (propVal !== int(values.DEFARMURE)) {
                attrs.DEFARMURE = propVal;
              }
              if (propVal !== int(values.DEFARMUREMALUS)) {
                attrs.DEFARMUREMALUS = propVal;
              }
            }
          }
          // Armor malus
          if (propName === 'DEF-') {
            const defmalus = int(values.DEFARMUREMALUS);
            if (propVal !== defmalus) {
              attrsDEFARMUREMALUS = propVal;
            }
          }
          // Damage reduction
          if (propName === 'RD') {
            const rds = values.RDS;
            const propVal = int(parsed.value);
            if (eqpon === 1) {
              if (propVal !== rds) {
                attrs.RDS = propVal;
              }
            }
          }
          // Damage dice 1 & 2
          if (propName === 'DM') {
            atkInfo.dm = [];
            if (parsed.value) {
              if (parsed.value.indexOf(' ') !== -1) {
                atkInfo.dmtype = parsed.value.split(' ')[1];
                parsed.value = parsed.value.split(' ')[0];
              }
              atkInfo.dm = parsed.value.toLowerCase().split('d');
            }
          }
          if (propName === 'DM2') {
            atkInfo.dm2 = [];
            if (parsed.value) {
              if (parsed.value.indexOf(' ') !== -1) {
                atkInfo.dm2type = parsed.value.split(' ')[1];
                parsed.value = parsed.value.split(' ')[0];
              }
              atkInfo.dm2 = parsed.value;
            }
          }
          // Attack range
          if (propName === 'ATD') {
            atkInfo.portee = parsed.value;
            atkInfo.type = '@{ATKTIR}';
          }
        }
        if (hasAtk) {
          if (!atkId) {
            atkId = generateRowID();
          }
          attrs['repeating_equipement_equip-atkid'] = atkId;
          atkId = `repeating_armes_${atkId}`;
          attrs[`${atkId}_armenom`] = atkName;
          attrs[`${atkId}_armeatt`] = 'attaque=';
          attrs[`${atkId}_armeatk`] = atkInfo.type;
          attrs[`${atkId}_armeportee`] = stringOrDefault(atkInfo.portee);
          if (atkInfo.dm.length) {
            attrs[`${atkId}_armedmg`] = 'degats=';
            attrs[`${atkId}_armedmnbde`] = atkInfo.dm[0];
            attrs[`${atkId}_armedmde`] = atkInfo.dm[1].replace('+', '!');
            if (atkInfo.type === '@{ATKTIR}') {
              attrs[`${atkId}_armedmcar`] = '0';
            }
            if (atkInfo.dmtype) {
              attrs[`${atkId}_armedmtype`] = atkInfo.dmtype;
            }
            if (atkInfo.dm2) attrs[`${atkId}_armedm2_de`] = atkInfo.dm2;
            if (atkInfo.dm2type)
              attrs[`${atkId}_armedm2_desc`] = atkInfo.dm2type;
          } else {
            attrs[`${atkId}_armedmg`] = '';
          }
        }
        if (Object.keys(attrs).length > 0) {
          setAttrs(attrs);
        }
      }
    );
  }
);

/**
* On changing the total character's encumbrance
* - Set character's conditions
*/
on('change:total_enc', function () {
  getAttrs(
    ['use_encombrement', 'coc_setting', 'total_enc', 'seuil_enc'],
    function (values) {
      const use_encombrement = values.use_encombrement === 1 ? true : false;
      if (!use_encombrement) {
        return;
      }
      const seuil_enc = int(values.seuil_enc);
      const encombrement = int(values.total_enc);
      if (seuil_enc > 0 && encombrement > 0) {
        let cond = {};
        if (encombrement > seuil_enc * 3) {
          cond.CONDITION = 'I'; // Immobilisé
        } else if (encombrement > seuil_enc * 2) {
          cond.CONDITION = 'L'; // Ralenti
          // +Affaibli
          if (values.coc_setting === 'monstres') {
            cond.POISSE = '1';
          } else {
            cond.ETATDE = '12';
          }
        } else if (encombrement > seuil_enc) {
          cond.CONDITION = '';
          cond.JDEX = values.coc_setting === 'monstres' ? '2d20kl1' : '1d12';
          cond.JDEXSUP = values.coc_setting === 'monstres' ? '1d20' : '2d12kh1';
          cond.JDEXSUPHERO =
            values.coc_setting === 'monstres'
              ? '{1d20, 0d20+10}kh1'
              : '{2d12kh1, 0d12+10}kh1';
          cond.JDEXRISQUE =
            values.coc_setting === 'monstres' ? '2d20kl1' : '2d12kl1';
          cond.ETATDE = '20';
        } else {
          cond.CONDITION = '';
          cond.JDEX = '1d@{ETATDE}';
          cond.JDEXSUP = '2d@{ETATDE}kh1';
          cond.JDEXSUPHERO = '{2d@{ETATDE}kh1, 0d20+10}kh1';
          cond.JDEXRISQUE = '1d12';
          cond.ETATDE = '20';
        }
        if (cond !== null) {
          setAttrs(cond);
        }
      }
    }
  );
});

/**
* Rebuild derived attributes
* - Reset the CARACS attribute
* - Reset characters encumbrance
* - Rebuild the general buffs
* - Rebuild the attack and DM modifiers
*/
function rebuildAll() {
  for (let v = 1; v <= 9; v++) {
    setRank(v.toString());
  }
  buildCaracs();
  buildAbilities();
  encumbrance();
  rebuildBuffs();
  rebuildModAtkDM('repeating_modatk', 'armebuff');
  rebuildModAtkDM('repeating_moddm', 'armebuffdm');
  rebuildUD();
  rebuildCounter(1);
  rebuildCounter(2);
  rebuildCounter(3);
}


/**
 * Scan abilities for usage mention in description
 */
function abilityUsage() {

  const attrs = [];
  seq(9).forEach(v => {
    seq(5).forEach(r => {
      attrs.push(`voie${v}-${r}`);
      attrs.push(`v${v}r${r}_freq`);
    });
  });
  getAttrs(attrs, function (values) {
    const updatedAbilities = {};
    const rx = new RegExp("([U|u]ne|[D|d]eux|[T|t]rois) fois par ([A-Za-z]+)","gm");
    Object.keys(values).filter(v => v.endsWith("_freq")).forEach(value => {
      if (stringOrDefault(values[value]) !== "") return; // already has a usage freq

      const [ ability ] = value.split("_");
      const abilityDesc = `voie${ ability.charAt(1) }-${ ability.charAt(3) }`;
      const description = stringOrDefault(values[abilityDesc]);
      if (description === "") return; // no description found

      const matches = [ ...description.matchAll(rx) ];
      if (matches.length === 0) return; // no regex match

      const [ , use, freq ] = matches[0];
      if ([ "round", "tour" ].includes(freq.toLowerCase())) return; // no per round usage

      const use_max = [ "une", "deux", "trois" ].indexOf(use.toLowerCase()) + 1;
      if (use_max > 0) {
        updatedAbilities[`${ability}_use_max`] = use_max;
        updatedAbilities[`${ability}_freq`] = freq;
      }
    });
    if (Object.keys(updatedAbilities).length > 0) {
      setAttrs(updatedAbilities);
    }
    clog(updatedAbilities, "ABILITY USAGE");
  }); 
  
}

/**
* On clicking the Reset button
* - Rebuild derived attributes
*/
on('clicked:resetattrib-btn', function () {
  rebuildAll();
  abilityUsage();
});

/**
* Search for a general buff to synchronize with an attack modifier
* @param {string} buffName Name of buff to synchronize
* @param {string} buffOn State of buff to synchronize
*/
function updateMatchBuffs(buffName, buffOn) {
  getSectionIDs('repeating_buffs', function (ids) {
    const attrs = {};
    for (const id of ids) {
      getAttrs([`repeating_buffs_${id}_buffnom`], function (v) {
        const name = stringOrDefault(v[Object.keys(v)[0]]);
        if (name.toLowerCase() === buffName.toLowerCase()) {
          attrs[`repeating_buffs_${id}_buffon`] = buffOn;
        }
        setAttrs(attrs);
      });
    }
  });
}

/**
* Rebuild the attack/dm modifiers
* @param {string} section Repeating section name
* @param {string} buffAttr Attack modifier attribute being rebuilt
*/
function rebuildModAtkDM(section, buffAttr) {
  getSectionIDs(section, function (ids) {
    const sectId = section.split('_')[1];
    let armebuff = '';
    for (const id of ids) {
      getAttrs(
        [
          `${section}_${id}_${sectId}on`,
          `${section}_${id}_${sectId}nom`,
          `${section}_${id}_${sectId}val`,
          'CARACS',
        ],
        function (values) {
          let caracs = JSON.parse(values.CARACS);
          const modOn = values[Object.keys(values)[0]] || '0';
          const modNom = stringOrDefault(values[Object.keys(values)[1]]);
          let modVal = stringOrDefault(values[Object.keys(values)[2]]);
          if (modOn === '1' && modNom !== '' && modVal !== '') {
            if (modVal.search(/\d+[dD]\d+/) !== -1) {
              let sign = '';
              if (modVal.startsWith('-') || modVal.startsWith('+')) {
                sign = modVal.substring(0, 1);
                modVal = modVal.substring(1);
              }
              modVal = `${sign}[[${modVal}]]`;
            } else {
              modVal = buffValue(modVal, caracs);
            }
            armebuff += ` ${modVal}[${modNom}]`;
          }
          updateMatchBuffs(modNom, modOn);
        }
      );
    }
    getSectionIDs('repeating_armes', function (ids) {
      const attrs = {};
      for (const id of ids) {
        attrs[`repeating_armes_${id}_${buffAttr}`] = armebuff;
      }
      setAttrs(attrs, { silent: true });
    });
  });
}

/**
* On changing or removing attack modifiers
* - Rebuild attack buffs from modifiers
*/
on(
  ['change:repeating_modatk', 'remove:repeating_modatk'].join(' '),
  function () {
    rebuildModAtkDM('repeating_modatk', 'armebuff');
  }
);

/**
* On changing or removing damage modifiers
* - Rebuild damage buffs from modifiers
*/
on(['change:repeating_moddm', 'remove:repeating_moddm'].join(' '), function () {
  rebuildModAtkDM('repeating_moddm', 'armebuffdm');
});

/**
*
*/
on('change:distance change:couvert change:visibilite', function () {
  getAttrs(['distance', 'couvert', 'visibilite'], function (values) {
    let tir_special = '';
    let tir = [];
    if (values.distance.startsWith('+3')) tir.push('courte portée');
    if (values.distance.startsWith('-5')) tir.push('portée double');
    if (values.distance.startsWith('-10')) tir.push('portée triple');
    if (values.couvert.startsWith('-2')) tir.push('couverture partielle');
    if (values.couvert.startsWith('-5')) tir.push('couverture importante');
    if (values.visibilite.startsWith('-2')) tir.push('cible au contact');
    if (values.visibilite.startsWith('-5')) tir.push('cible masquée par allié');
    if (tir.length != 0) tir_special = 'Tir : ' + tir.join(', ');
    setAttrs({ tir_special: tir_special });
  });
});

/**
* Condition codes
*/
const CONDITIONS = {
  aveugle: 'A',
  effraye: 'F',
  etourdi: 'E',
  immobilise: 'I',
  panique: 'P',
  ralenti: 'L',
  renverse: 'R',
  surpris: 'S',
};

/**
* Condition modifiers
*/
const CONDITIONS_INFO = {
  '': {
    atc: 0,
    atd: 0,
    def: 0,
    init: 0,
    title: '',
  },
  A: {
    atc: 5,
    atd: 10,
    def: 5,
    init: 5,
    title: 'Aveuglé',
  },
  E: {
    atc: 0,
    atd: 0,
    def: 5,
    init: 0,
    title: 'Etourdi',
  },
  F: {
    atc: 5,
    atd: 5,
    def: 0,
    init: 0,
    title: 'Effrayé',
  },
  I: {
    atc: 0,
    atd: 0,
    def: 0,
    init: 0,
    title: 'Immobilisé',
  },
  P: {
    atc: 0,
    atd: 0,
    def: 2,
    init: 0,
    title: 'Paniqué',
  },
  L: {
    atc: 0,
    atd: 0,
    def: 0,
    init: 0,
    title: 'Ralenti',
  },
  R: {
    atc: 5,
    atd: 5,
    def: 5,
    init: 0,
    title: 'Renversé',
  },
  S: {
    atc: 0,
    atd: 0,
    def: 5,
    init: 0,
    title: 'Surpris',
  },
};

/**
* Apply condition(s) as buffs to combat stats
* @param {object} buffs Buff object
* @param {string} conditionAttr Name of attribute storing conditions
* @param {integer} s Sign (-1/+1)
*/
function applyConditions(buffs, conditionAttr, s) {
  if (conditionAttr === '') {
    return;
  }
  for (const condition of conditionAttr) {
    buffs.atc += s * CONDITIONS_INFO[condition].atc;
    buffs.atd += s * CONDITIONS_INFO[condition].atd;
    buffs.def += s * CONDITIONS_INFO[condition].def;
    buffs.init += s * CONDITIONS_INFO[condition].init;
  }
}

/**
* On changing the enabled condition(s)
* - Set/Unset combat stats buffs
*/
on(
  [
    'clicked:aveugle',
    'clicked:effraye',
    'clicked:etourdi',
    'clicked:immobilise',
    'clicked:panique',
    'clicked:ralenti',
    'clicked:renverse',
    'clicked:surpris',
  ].join(' '),
  function (eventInfo) {
    const [ , clicked ] = eventInfo.triggerName.split(":");
    const conditionCode = CONDITIONS[clicked];
    getAttrs(
      [
        'coc_setting',
        'PCONDITION',
        'CONDITION',
        'ATKCAC_BUFF',
        'ATKTIR_BUFF',
        'INIT_BUFF',
        'DEF_BUFF',
        'ETATDE',
        'POISSE',
      ],
      function (values) {
        let buffs = {
          atc: int(values.ATKCAC_BUFF),
          atd: int(values.ATKTIR_BUFF),
          def: int(values.DEF_BUFF),
          init: int(values.INIT_BUFF),
        };
        // debuffs prior condition
        let pcondition = stringOrDefault(values.PCONDITION);
        applyConditions(buffs, pcondition, +1);
        // change condition
        let condition = stringOrDefault(values.CONDITION);
        if (condition.includes(conditionCode)) {
          condition = condition.replace(conditionCode, '');
        } else {
          condition += conditionCode;
        }
        // buff new condition
        applyConditions(buffs, condition, -1);
        // check prior condition for die roll
        let etatde = values.ETATDE;
        let poisse = values.POISSE || '0';
        if (
          pcondition !== '' &&
          (pcondition.includes(CONDITIONS.immobilise) ||
            pcondition.includes(CONDITIONS.panique))
        ) {
          etatde = '20';
          poisse = '0';
        }
        // check condition for die roll
        if (
          condition !== '' &&
          (condition.includes(CONDITIONS.immobilise) ||
            condition.includes(CONDITIONS.panique))
        ) {
          etatde = values.coc_settings === 'monstres' ? '20' : '12';
          poisse = values.coc_settings === 'monstres' ? '1' : '0';
        }
        //
        let displayConditions = '';
        if (condition !== '') {
          for (const cond of Object.keys(CONDITIONS)) {
            if (condition.includes(CONDITIONS[cond])) {
              displayConditions +=
                (displayConditions === '' ? '' : ', ') +
                CONDITIONS_INFO[CONDITIONS[cond]].title;
            }
          }
        }
        if (displayConditions === '') {
          displayConditions = ' ';
        }
        setAttrs({
          ATKCAC_BUFF: buffs.atc,
          ATKTIR_BUFF: buffs.atd,
          DEF_BUFF: buffs.def,
          INIT_BUFF: buffs.init,
          ETATDE: etatde,
          POISSE: poisse,
          CONDITION: condition,
          PCONDITION: condition,
          conditions: displayConditions,
        });
      }
    );
  }
);

/**
* On changing the HP buff
* - Re-compute max HP for PC
*/
on("change:pv_buff", function (eventInfo) {
  const oldVal = int(eventInfo.previousValue);
  const newVal = int(eventInfo.newValue);
  getAttrs(["PV_max"], function(v) {
    setAttrs({ PV_max: int(v.PV_max) - oldVal + newVal });
  });
});

/**
* On changing DEF base or pilot DEX
* - Recompute vehicle DEF
*/
on('change:defv_base change:defv_dex', function() {
  getAttrs(['DEFV_BASE', 'DEFV_DEX'], function (values) {
    const defv = int(values.DEFV_BASE) + int(values.DEFV_DEX);
    setAttrs({ DEFV: defv });
  });
});

/**
* On changing Bitume vehicle RAP components
* - Recompute total RAP
*/
on('change:vbrap_base change:vbrap_div', function () {
  getAttrs(['vbrap_base', 'vbrap_div'], function (values) {
    let vbrap = int(values.vbrap_base);
    vbrap += int (values.vbrap_div);
    setAttrs({
      vbrap: vbrap,
    });
  });
});

/**
* On changing Bitume vehicle MAN components
* - Recompute total MAN
* - Recompute vehicle DEF
*/
on('change:vbman_base change:vbman_div', function () {
  getAttrs(['vbman_base', 'vbman_div', 'vbimp'], function (values) {
    let vbman = int(values.vbman_base);
    vbman += int(values.vbman_div);
    let vbimp = int(values.vbimp);
    setAttrs({
      vbman: vbman,
      vbdef: 10 + vbimp + vbman,
    });
  });
});

/**
* On changing Bitume vehicle IMP components
* - Recompute total IMP
* - Recompute vehicle DEF
*/
on('change:vbimp_base change:vbimp_div', function () {
  getAttrs(['vbimp_base', 'vbimp_div', 'vbman'], function (values) {
    let vbimp = int(values.vbimp_base);
    vbimp += int(values.vbimp_div);
    let vbman = int(values.vbman);
    setAttrs({
      vbimp: vbimp,
      vbdef: 10 + vbimp + vbman,
    });
  });
});

/**
* On changing Bitume vehicle EMP components
* - Recompute total EMP
*/
on('change:vbemp_base change:vbemp_div', function () {
  getAttrs(['vbemp_base', 'vbemp_div'], function (values) {
    let vbemp = int(values.vbemp_base);
    vbemp += int(values.vbemp_div);
    setAttrs({
      vbemp: vbemp,
    });
  });
});

/**
* Rebuild Bitume vehicle used EMP
*/
function rebuildUsedSlots() {
  getAttrs(['coc_setting'], function (value) {
    if (value.coc_setting !== 'bitume') return;
    getSectionIDs('vbmods', function (ids) {
      setAttrs({ vbemp_total: 0 });
      let used = 0;
      ids.forEach((id) => {
        getAttrs([`repeating_vbmods_${id}_vbmod-emp`], function (value) {
          used += int(value[Object.keys(value)[0]]);
          setAttrs({ vbemp_total: used });
        });
      });
    });
  });
}

/**
* On changing Bitume vehicle mods
* - Rebuild vehicle buffs if any
* - Rebuild used slots
* - Check if installed mods do not use more slots than the max
*/
on('change:repeating_vbmods remove:repeating_vbmods', function (eventInfo) {
  const attrs = {
    vbrap_div: 0,
    vbman_div: 0,
    vbimp_div: 0,
    vbemp_div: 0,
    vbdef_div: 0,
  };
  const eventRowId = eventInfo.sourceAttribute.split('_')[2];
  getSectionIDs('vbmods', function (ids) {
    setAttrs({ vbemp_total: 0 });
    let used = 0;
    ids.forEach((id, ix) => {
      const rowId = `repeating_vbmods_${id}_`;
      getAttrs(
        [
          `${rowId}vbmod-on`,
          `${rowId}vbmod-buffs`,
          `${rowId}vbmod-emp`,
          'vbemp',
        ],
        function (values) {
          const enabled = int(values[Object.keys(values)[0]]);
          const buffs = stringOrDefault(values[Object.keys(values)[1]]);
          if (enabled === 1 && buffs !== '') {
            buffs.split(';').forEach((b) => {
              const buff = parseNameValue(b);
              const div = `vb${buff.name.toLowerCase()}_div`;
              if (Object.keys(attrs).indexOf(div) !== -1) {
                attrs[div] += int(buff.value);
              }
            });
          }
          used += int(values[Object.keys(values)[2]]);
          if ((ix = ids.length - 1)) {
            empmax = int(values.vbemp);
            if (used > empmax) {
              attrs[`repeating_vbmods_${eventRowId}_vbmod-emp`] = 0;
            } else {
              attrs.vbemp_total = used;
            }
          }
          setAttrs(attrs);
        }
      );
    });
  });
});

/**
* On changing Ud max for vehicle
* - Reset current Ud
*/
on('change:vbudmax', function () {
  getAttrs(['vbudmax'], function (value) {
    setAttrs({ vbud: value.vbudmax });
  });
});

/**
* On checking Ud boxes
* - Adjust the current Ud value
*/
[12, 10, 8, 6, 4].forEach((udie) => {
  const udboxes = [];
  for (let cb = 1; cb <= udie; cb++) {
    udboxes.push(`change:vbud${udie}_${cb}`);
  }
  on(udboxes.join(' '), function (eventInfo) {
    const box = eventInfo.sourceAttribute.split('_')[0];
    let maxcb = int(box.slice(4));
    const boxes = [];
    for (let cb = 1; cb <= maxcb; cb++) {
      boxes.push(`${box}_${cb}`);
    }
    getAttrs(['vbudmax', ...boxes], function (v) {
      const vbudmax = int(v.vbudmax);
      delete v.vbudmax;
      values = [];
      for (const k of Object.keys(v)) {
        values.push(v[k]);
      }
      if (values.findIndex((cb) => cb === '1') === -1) {
        if (maxcb < vbudmax) maxcb += 2;
      }
      setAttrs({ vbud: maxcb });
    });
  });
});

/**
* On changing COC setting
* - Set character sheet options to default values for setting
*/
on(['change:coc_setting', 'change:coc_surh'].join(' '), function () {
  getAttrs(['coc_setting', 'coc_surh'], function (values) {
    defaultConfig = {
      base: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '0',
        option_pm: '0',
        option_pc: '1',
        option_pr: '0',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Choc',
        PC_DESC_SNGL: 'Point de Choc',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      cthulhu: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '1',
        option_pm: '0',
        option_pc: '1',
        option_pr: '0',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Choc',
        PC_DESC_SNGL: 'Point de Choc',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '1',
        cpt1_desc_plur: 'Points de Folie',
        cpt1_desc_sngl: 'Point de Folie',
        cpt1_desc_abrv: 'PF',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      pulp: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '1',
        option_pm: '1',
        option_pc: '1',
        option_pr: '1',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Chance',
        PC_DESC_SNGL: 'Point de Chance',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      postapo: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '0',
        option_pm: '0',
        option_pc: '1',
        option_pr: '1',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Chance',
        PC_DESC_SNGL: 'Point de Chance',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      surhumain: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Surhumain',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '1',
        option_pm: '1',
        option_pc: '1',
        option_pr: '1',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Chance',
        PC_DESC_SNGL: 'Point de Chance',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      cyberpunk: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '{[[@{INIT}]]+1d6!, ([[@{INIT}]]*2)+0d6}kl1',
        option_atkmen: '1',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '0',
        option_pm: '0',
        option_pc: '1',
        option_pr: '1',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Cash',
        PC_DESC_SNGL: 'Point de Cash',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+[[1d6]]',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      shadowrun: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Méta-type',
        origine: '',
        coc_surh: '',
        INIT_JET: '{[[@{INIT}]]+1d6!, ([[@{INIT}]]*2)+0d6}kl1',
        option_atkmen: '1',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '1',
        option_pm: '1',
        option_pc: '1',
        option_pr: '1',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Cash',
        PC_DESC_SNGL: 'Point de Cash',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+[[1d6]]',
        coc_setting_bitume: '0',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      menacex: {
        lib_profil: 'Profil',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '1',
        option_atkpil: '0',
        option_defpsi: '1',
        option_atkmag: '0',
        option_pm: '1',
        option_pc: '1',
        option_pr: '0',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Chance',
        PC_DESC_SNGL: 'Point de Chance',
        PC_DESC_ABRV: 'PC',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '1',
        cpt1_desc_plur: 'Points de Tension',
        cpt1_desc_sngl: 'Point de Tension',
        cpt1_desc_abrv: 'PT',
        pm_desc: 'Energie PSI',
        pm_abrv: 'EP',
      },
      bitume: {
        lib_profil: 'Tribu',
        lib_famille: 'Famille',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '{[[@{INIT}]]+1d6!, ([[@{INIT}]]*2)+0d6}kl1',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '1',
        option_defpsi: '0',
        option_atkmag: '0',
        option_pm: '0',
        option_pc: '1',
        option_pr: '0',
        use_encombrement: '0',
        PC_DESC_PLUR: 'Points de Style',
        PC_DESC_SNGL: 'Point de Style',
        PC_DESC_ABRV: 'PS',
        PC_BONUS: 'effet Waouh, réussite héroïque, juste une égratignure',
        coc_setting_bitume: '1',
        option_cpt1: '0',
        cpt1_desc_plur: '',
        cpt1_desc_sngl: '',
        cpt1_desc_abrv: '',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
      monstres: {
        lib_profil: 'Espèce',
        lib_famille: 'Classe',
        lib_origine: 'Origine',
        origine: '',
        coc_surh: '',
        INIT_JET: '@{INIT}',
        option_atkmen: '0',
        option_atkpsi: '0',
        option_atkpil: '0',
        option_defpsi: '0',
        option_atkmag: '1',
        option_pm: '0',
        option_pc: '1',
        option_pr: '0',
        use_encombrement: '0',
        PC_DESC_PLUR: "Points d'Humanité",
        PC_DESC_SNGL: "Point d'Humanité",
        PC_DESC_ABRV: 'PH',
        PC_BONUS: '+10',
        coc_setting_bitume: '0',
        option_cpt1: '1',
        cpt1_desc_plur: 'Points de Pulsion',
        cpt1_desc_sngl: 'Point de Pulsion',
        cpt1_desc_abrv: 'PP',
        pm_desc: 'Magie',
        pm_abrv: 'PM',
      },
    };

    let attrs = {};
    if (values.coc_setting === '') {
      attrs = defaultConfig.base;
    } else {
      attrs = defaultConfig[values.coc_setting];
    }

    if (values.coc_setting === 'postapo') {
      removeRepeating('ressources');
      const resources = [
        'Points de Provisions',
        'Points de Munitions',
        'Points de Transport',
      ];
      for (const resource of resources) {
        let rowId = 'repeating_ressources_' + generateRowID();
        attrs[`${rowId}_res-desc`] = resource;
        attrs[`${rowId}_res-val`] = '0';
      }
    }

    if (
      values.coc_setting === 'cyberpunk' ||
      values.coc_setting === 'shadowrun'
    ) {
      removeRepeating('ressources');
      const resources = ['Cyberlose'];
      for (const resource of resources) {
        let rowId = 'repeating_ressources_' + generateRowID();
        attrs[`${rowId}_res-desc`] = resource;
        attrs[`${rowId}_res-val`] = '0';
      }
    }

    if (values.coc_setting === 'surhumain') {
      attrs.origine = '';
      attrs.option_cpt1 = '0';
      attrs.cpt1_desc = '';
      if (values.coc_surh && values.coc_surh !== '') {
        //const rowId = 'repeating_ressources_' + generateRowID();
        switch (values.coc_surh) {
          case 'ange':
            attrs.origine = 'Ange';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.option_pr = '1';
            break;
          case 'demon':
            attrs.origine = 'Démon';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.option_pr = '0';
            attrs.option_cpt1 = '1';
            attrs.cpt1_desc_plur = "Points d'âme";
            attrs.cpt1_desc_sngl = "Point d'âme";
            attrs.cpt1_desc_abrv = 'PdA';
            break;
          case 'fee-dragon':
            attrs.origine = 'Dragon (être féérique)';
            attrs.DV = '10';
            attrs.ATKCAC_BASE = '2';
            attrs.ATKTIR_BASE = '0';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '0';
            attrs.option_pr = '0';
            break;
          case 'fee-dryade':
            attrs.origine = 'Dryade (être féérique)';
            attrs.DV = '6';
            attrs.ATKCAC_BASE = '0';
            attrs.ATKTIR_BASE = '0';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '2';
            attrs.option_pr = '0';
            break;
          case 'fee-dwergar':
            attrs.origine = 'Dwergar (être féérique)';
            attrs.DV = '8';
            attrs.ATKCAC_BASE = '1';
            attrs.ATKTIR_BASE = '1';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '0';
            attrs.option_pr = '0';
            break;
          case 'fee-gobelin':
            attrs.origine = 'Gobelin (être féérique)';
            attrs.DV = '8';
            attrs.ATKCAC_BASE = '1';
            attrs.ATKTIR_BASE = '1';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '0';
            attrs.option_pr = '0';
            break;
          case 'fee-lutin':
            attrs.origine = 'Lutin (être féérique)';
            attrs.DV = '6';
            attrs.ATKCAC_BASE = '0';
            attrs.ATKTIR_BASE = '1';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '1';
            attrs.option_pr = '0';
            break;
          case 'fee-ogre':
            attrs.origine = 'Ogre (être féérique)';
            attrs.DV = '10';
            attrs.ATKCAC_BASE = '2';
            attrs.ATKTIR_BASE = '0';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.ATKMAG_BASE = '0';
            attrs.option_pr = '0';
            break;
          case 'garou':
            attrs.origine = 'Loup-garou';
            attrs.ATKMAG_CARAC = '@{PER}';
            attrs.option_pr = '0';
            attrs.option_cpt1 = '1';
            attrs.cpt1_desc_plur = 'Points de Rage';
            attrs.cpt1_desc_sngl = 'Point de Rage';
            attrs.cpt1_desc_abrv = 'PdR';
            break;
          case 'vampire':
            attrs.origine = 'Vampire';
            attrs.ATKMAG_CARAC = '@{INT}';
            attrs.option_pr = '0';
            attrs.option_cpt1 = '1';
            attrs.cpt1_desc = 'Points de Sang';
            attrs.cpt1_desc = 'Point de Sang';
            attrs.cpt1_desc = 'PdS';
            break;
          case 'mutant-endo':
            attrs.origine = 'Mutant endogène';
            attrs.ATKMAG_CARAC = '@{CHA}';
            attrs.option_pr = '0';
            break;
          case 'mutant-exo':
            attrs.origine = 'Mutant exogène';
            attrs.ATKMAG_CARAC = '@{PER}';
            attrs.option_pr = '0';
            break;
          case 'mutant-psycho':
            attrs.origine = 'Mutant psychogène';
            attrs.ATKMAG_CARAC = '@{INT}';
            attrs.option_pr = '0';
            break;
        }
      }
    }
    setAttrs(attrs);
  });
});

/**
* On changing the hors-fiche settings
* - Rebuild the hors-fiche attributes
*/
on(['change:hors_fiche', 'change:hors_fiche_pfx'].join(' '), function () {
  buildAbilities();
});

/**
* Parse profile information
* @param {object} attrs attributes to add
* @param {object} data JSON data to parse
* @returns {object} attrs updated attributes
*/
function importProfileJSON(attrs, data) {
  data.paths.forEach((path, ix) => {
    const abilities = path.abilities || [];
    if (abilities.length === 0) return;
    attrs[`voie${ix + 1}nom`] = stringOrDefault(path.name);
    abilities.forEach((ability, rank) => {
      if (typeof ability === "string") {
        attrs[`voie${ix + 1}-t${rank + 1}`] = ability;
      } else {
        attrs[`voie${ix + 1}-t${rank + 1}`] = ability.name;
        attrs[`voie${ix + 1}-${rank + 1}`] = ability.description;
      }
    });
  });
  return attrs;
}

/**
* Parse gear information
* @param {object} attrs attributes to add
* @param {object} data JSON data to parse
* @param {boolean} reset delete weapons & gears lists
* @returns {object} attrs updated attributes
*/
function importGearJSON(attrs, data, reset = false) {
  if (reset) {
    removeRepeating("equipement");
    removeRepeating("armes");
  }
  data.forEach((gear, ix) => {
    const nbr = int(gear.nombre);
    if (nbr <= 0) return;
    let gearName = "";
    if (gear.code === "autre") {
      gearName = gear.special;
    } else {
      gearName = gear.designation;
      if (gear.special) gearName += " " + gear.special;
    }
    let isWeapon = false;
    let gearProps = [];
    gear.props.forEach((prop) => {
      let gearProp = "";
      if (prop.id === "def") gearProp = "DEF";
      if (prop.id === "malus") gearProp = "DEF-";
      if (prop.id === "rd") gearProp = "RD";
      if (prop.id.startsWith("dm")) {
        gearProp = "DM";
        isWeapon = true;
      }
      if (prop.id == "portee") gearProp = "ATD";
      if (gearProp !== "") gearProps.push(`${gearProp}:${prop.valeur}`);
    });
    const newRowID = "repeating_equipement_" + generateRowID();
    attrs[`${newRowID}_equip-desc`] = gearName;
    attrs[`${newRowID}_equip-props`] = gearProps.join(", ");
    attrs[`${newRowID}_equip-atk`] = isWeapon ? "1" : "0";
  });
  return attrs;
}


/**
* On clicking JSON profile import button
* - parse and update profile's path & abilities
*/
on('clicked:importprofile-btn', function () {
  getAttrs([
      'json_profile', 
      'coc_setting', 
      'coc_surh', 
      'coc_setting_bitume', 
      'coc_setting_shadowrun', 
      'reset_gears',
      'NIVEAU',
      'CONSTITUTION',
      'CHARISME'
    ], function (v) {
    if (v.json_profile.trim() === '') return;
    const coc_setting = stringOrDefault(v.coc_setting);
    const coc_surhuman = stringOrDefault(v.coc_surh);
    const coc_setting_bitume = int(v.coc_setting_bitume) === 1 ? true : false;
    const coc_setting_shadowrun = int(v.coc_setting_shadowrun) === 1 ? true : false;
    const reset_gears = int(v.reset_gears) === 1 ? true : false;
    const jsonData = JSON.parse(v.json_profile);
    let attrs = {
      json_profile: '',
      reset_gears: 0,
      PC: 0
    };
    const level = Math.max(1,int(v.NIVEAU));
    const conVal = getMod(v.CONSTITUTION);
    const chaVal = getMod(v.CHARISME);
    if (jsonData.character) {
      attrs["PROFIL"] = jsonData.character.profile;
      attrs["FAMILLE"] = jsonData.character.family;
      const familyId = jsonData.character.familyId || "";
      switch (familyId) {
        case "adc-action":
        case "coc-action":
          attrs.PC = 2;
          attrs.DV = "10";
          break;
        case "adc-aventure":
        case "coc-aventure":
          attrs.PC = 4;
          attrs.DV = "8";
          break;
        case "adc-reflexion":
        case "coc-reflexion":
        case "magie":
          attrs.PC = 2;
          attrs.DV = "6";
          break;
      }
      attrs.PC += chaVal;
      attrs.PC_max = attrs.PC;
      if (["action", "aventure"].indexOf(familyId) !== -1) {
        const combat = jsonData.character.combat || [];
        if (combat.length > 0) {
          combat.forEach(attr => {
            const { name, value } = parseNameValue(attr);
            let atk = "";
            switch (name) {
              case "ATC":
                atk = "CAC";
                break;
              case "ATD":
                atk = "TIR";
                break;
              case "ATM":
                atk = "MEN";
                break;
              case "DV":
                attrs.DV = value;
              case "MAG":
                atk = "MAG";
              break;
              case "INIT":
                const newRowID = "repeating_buffs_" + generateRowID();
                attrs[`${newRowID}_buffon`] = 1;
                attrs[`${newRowID}_buffnom`] = jsonData.character.profile;
                attrs[`${newRowID}_buffmods`] = `INIT: ${value}`;
                break;
            }
            if (atk !== "") {
              attrs[`ATK${atk}_BASE`] = value;
            }
          });
        }
      }
      if (level === 1) {
        attrs.NIVEAU = 1;
        attrs.PV_max = int(attrs.DV) + conVal;
        attrs.PV = attrs.PV_max;
      }
      attrs = importProfileJSON(attrs, jsonData.character);
      if (jsonData.gears) {
        attrs = importGearJSON(attrs, jsonData.gears, reset_gears);
      }  
    } else {
      attrs["PROFIL"] = jsonData.profile;
      attrs["FAMILLE"] = jsonData.family;
      attrs = importProfileJSON(attrs, jsonData);
    }
    clog(attrs, 'JSON profile import');
    setAttrs(attrs);
    buildCaracs();
  });
});

/**
* On changing level and charisma mod
* - recalculate the max. PM / EP for settings with magic or psi
*/
on(
  ['change:coc_setting', 'change:niveau', 'change:charisme'].join(' '),
  function () {
    getAttrs(['coc_setting', 'NIVEAU', 'charisme'], function (values) {
      const setting = values.coc_setting;
      const niveau = values.NIVEAU || 1;
      const modcha = getMod(values.charisme || 0);
      let attrs = {};
      if (
        setting === 'pulp' ||
        setting === 'shadowrun' ||
        setting === 'menacex'
      ) {
        attrs.PMmax = niveau + modcha;
        attrs.PM = attrs.PMmax;
      } else {
        attrs.PM = 0;
        attrs.PMmax = 0;
      }
      setAttrs(attrs);
    });
  }
);

/**
 * Create/Update cptr_xxxx attribute
 * @param {any} cptr counter number
 */
function rebuildCounter(cptr) {
  getAttrs([`cpt${cptr}`, `cpt${cptr}_desc_abrv` ], function(values) {
    const attrs = {};
    let attr = '';
    attr = stringOrDefault(values[Object.keys(values)[1]]).toLowerCase().replaceAll(' ','_');
    if (attr !== '') 
      attrs[`cptr_${attr}`] = int(values[Object.keys(values)[0]]);
    if (Object.keys(attrs).length > 0) 
      setAttrs(attrs);
  });
}

/**
 * On changing counters value
 * - Update counter attribute 
 */
on('change:cpt1 change:cpt2 change:cpt3', function(eventInfo) {
  const attr = eventInfo.sourceAttribute;
  const cptr = attr.charAt(attr.length -1);
  rebuildCounter(cptr);
});

/**
* On clicking the default vehicle rolls button
* - Add default vehicle rolls based on type
*/
on('clicked:vehiclerolls-btn', function () {
  getAttrs(['vehicle_type'], function (v) {
    let rolls = [];
    if (v.vehicle_type === 'sol') {
      rolls = [
        {
          jetvnom: 'Pilotage',
          jetvnbde: '1',
          jetvde: '@{ETATDE}',
          jetvtypejet: '',
          jetvcaracpil: '@{DEX_TEST}',
          jetvcarac: '@{AGI}',
        },
        {
          jetvnom: 'Sortie de route',
          jetvnbde: '4',
          jetvde: '6',
          jetvtypejet: '!',
          jetvcaracpil: '0',
          jetvcarac: '0',
          jetvdesc: 'DM Véhicule',
        },
        {
          jetvnom: 'Sortie de route',
          jetvnbde: '2',
          jetvde: '6',
          jetvtypejet: '!',
          jetvcaracpil: '0',
          jetvcarac: '0',
          jetvdesc: 'DM Passagers',
        },
        {
          jetvnom: 'Percussion',
          jetvnbde: '1',
          jetvde: '6',
          jetvtypejet: '!',
          jetvcaracpil: '0',
          jetvcarac: '@{FOV}',
          jetvdesc: 'DM subis : [[1d6!]]',
        },
      ];
    } else if (v.vehicle_type === 'air') {
      rolls = [
        {
          jetvnom: 'Pilotage',
          jetvnbde: '1',
          jetvde: '@{ETATDE}',
          jetvtypejet: '',
          jetvcaracpil: '@{DEX_TEST}',
          jetvcarac: '@{AGI}',
        },
        {
          jetvnom: 'Crash',
          jetvnbde: '8',
          jetvde: '6',
          jetvtypejet: '!',
          jetvcaracpil: '0',
          jetvcarac: '0',
          jetvdesc: 'DM Véhicule',
        },
        {
          jetvnom: 'Crash',
          jetvnbde: '4',
          jetvde: '6',
          jetvtypejet: '!',
          jetvcaracpil: '0',
          jetvcarac: '0',
          jetvdesc: 'DM Passagers',
        },
      ];
    }
    if (rolls.length !== 0) {
      addRolls = {};
      for (const roll of rolls) {
        newRowID = 'repeating_jetv_' + generateRowID();
        for (const attr of Object.keys(roll)) {
          addRolls[`${newRowID}_${attr}`] = roll[attr];
        }
      }
      setAttrs(addRolls);
    }
  });
});

/**
 * Display buff help
 */
on("clicked:helpbuff-btn", function() {
  sendChatMsg([
    "Format=attribut : valeur (séparés par des ;)",
    "Attributs=Noms & alias",
    "Caracs:=FOR,DEX,CON,INT,PER,CHA",
    "ATC:=Attaque au contact (alias: atkcac, cac, contact)",
    "ATD:=Attaque à distance (alias : atktir, cad, distance, tir)",
    "MAG:=Attaque Magique (alias : atkmag, magie)",
    "PIL:=Pilotage Bitume (alias : atkpil, pilotage)",
    "INIT:=Initiative (alias : initiative)",
    "DEF:=Défense",
    "Valeurs=---",
    "Nombre=Buff/debuff fixe",
    "[attribut]=Valeur de 'attribut'",
    "[VOIE#]=Rang dans la voie no #",
    "[rang {voie}]=Rang dans la voie nommée {voie} ",
  ], {
    title: "Aide BUFFS attributs",
    whisper: "@{character_name}"
  });
});

/**
 * Display gear help
 */
on("clicked:helpgear-btn", function() {
  sendChatMsg([
    "Format=propriété:valeur (séparées par des ,)",
    "DEF:=Bonus de DEF armure",
    "DEF-:=Malus d'armure",
    "RD:=Réduction DM",
    "ATD:=Portée arme à distance",
    "DM:=Dommages arme",
    "Ud:=Dé d'usure (Bitume)",
    "Porté=Cocher pour inclure l'équipement dans l'encombrement",
    "A une attaque=Cocher pour créer un ligne d'attaque",
  ], {
    title: "Aide propriétés d'équipement",
    whisper: "@{character_name}"
  });
});

/**
 * Reset abilities usage
 */
on("clicked:resetuses-btn", function() {
  const attrs = [];
  seq(9).forEach(v => {
    seq(5).forEach(r => {
      attrs.push(`v${v}r${r}`);
      attrs.push(`v${v}r${r}_use`);
      attrs.push(`v${v}r${r}_freq`);
    });
  })
  getAttrs(attrs, function(values) {
    const freqs = [ "Aucune" ];
    const owned = {};
    const abilities = [];
    for (const v in values) {
      if (values[v] !== "") {
        const [ ability, attr ] = v.split("_");
        if (!attr) {
          if (int(values[v]) === 1) 
            owned[ability] = 0;
          continue;
        } else if (attr === "use") {
          if (owned.hasOwnProperty(ability)) 
            owned[ability] = int(values[v]);
          continue;
        }
        if (!owned.hasOwnProperty(ability)) continue;
        if (owned[ability] === 0) continue;
        const freq = capitalize(values[v]);
        if (!freqs.includes(freq)) {
          freqs.push(freq);
          abilities[freq] = [];
        }
        abilities[freq].push(ability);
      } 
    }
    if (freqs.length === 1) {
      const chatMsg = coRollTemplate({
        leftsub: "Capacités",
        rightsub: "Utilisations",
        desc: "Aucune capacité avec fréquence d'utilisation à recharger"
      });
      sendChatMsg(chatMsg, { template: "co1" });
      return;
    }
    ask([ "Fréquence ?", ...freqs], function(selected, choices) {
      const freq = choices[selected];
      const attrs = abilities[freq].map(attr => `voie${ attr.charAt(1) }-t${ attr.charAt(3) }`);
      getAttrs(attrs, function(values) {
        const chatMsg = coRollTemplate({
          leftsub: "Capacités",
          rightsub: `Par ${freq}`,
          desc: Object.values(values).map(v => `${v}\n`).join("")
        });
        sendChatMsg(chatMsg, { template: "co1" });
        const reset = {};
        abilities[freq].forEach(attr => {
          reset[attr + "_use"] = 0;
        });
        setAttrs(reset);
      });
    });
  });
});

/**
 * Display ability text with alert on usage
 * @param {number} path - Path #
 * @param {number} rank - Rank #
 */
function actionAbility(path, rank) {
  getAttrs([ `v${path}r${rank}_use`, `v${path}r${rank}_use_max`, `v${path}r${rank}_freq` ], function(values) {
    const [ kused, kuses, kfreq ] = Object.keys(values);
    const used = int(values[kused]) + 1;
    const uses = int(values[kuses]);
    const freq = stringOrDefault(values[kfreq]);
    let alert = "";
    if (uses !== 0) {
      if (used > uses) {
        alert = `Déjà utilisée ${uses} fois / ${freq.toLowerCase()}`;
      } else {
        alert = `Utilisée ${used} fois`;
      }
    }
    const chatMsg = [
      "@{token_dsp}",
      ...coRollTemplate({
        leftsub: "Capacité ",
        rightsub: `@{voie${path}-t${rank}} `,
        desc: `**@{voie${path}nom}, rang ${rank}** `,
        text: `@{voie${path}-${rank}} }}`
      })
    ];
    if (alert !== "") chatMsg.push("alert=" + alert);
    sendChatMsg(chatMsg, { template: "co1" });
    if (used <= uses) {
      const attr = {};
      attr[kused] = used;
      setAttrs(attr);
    }
  });
}

/**
 * Handle ability buttons roll
 */
seq(9).forEach(path => {
  seq(5).forEach(rank => {
    on(`clicked:v${path}r${rank}-btn`, function() {
      actionAbility(path, rank);
    });
  })
});

/**
 * Change hit points based on roll query input
 * @param {string} button - Name of button clicked
 */

function changeHP(button) {
  let prompt = (button === "hploss-btn") ? "PV perdus ?" : "PV soignés ?";
  let plusminus = (button === "hploss-btn") ? -1 : +1;
  const ask = `!{{ask=[[?{${prompt}}]]}}`;
  askValue(prompt, function(hp) {
    if (hp <= 0) return;
    getAttrs([ "type_personnage", "PV", "PV_max", "SEUILBG", "pnj_pv", "pnj_pv_max", "pnj_sbg" ], function (values) {
      const type = stringOrDefault(values.type_personnage);
      let pv = (type === SHEET_NPC) ? int(values.pnj_pv) : int(values.PV);
      const pvMax = (type === SHEET_NPC) ? int(values.pnj_pv_max) : int(values.PV_max);
      const bg = (type === SHEET_NPC) ? int(values.pnj_sbg) : int(values.SEUILBG);
      let hasBG = (plusminus === -1 && hp >= bg) ? true : false;
      pv += hp * plusminus;
      if (pv < 0) {
        pv = 0;
        hasBG = true;
      }
      if (pv > pvMax) {
        pv = pvMax;
      }
      const chatMsg = [
        "@{token_dsp}",
        "perso=@{character_name}",
        "subtags=Vitalité ",
        `name=${ plusminus === -1 ? "Blessure" : "Soins" } `,
        `text=@{character_name} ${ plusminus === -1 ? "perd" : "gagne" } ${hp} PV${hasBG ? " et subit une blessure grave" : "" } `,
      ]
      sendChatMsg(chatMsg, { template: "co1" });
      const changedHP = (type === SHEET_NPC) ? { pnj_pv: pv } : { PV: pv };
      setAttrs(changedHP);
    });
  });
}

/**
 * On click on any of the HP buttons
 * - Change HP value
 */
on("clicked:hploss-btn clicked:hpheal-btn", function (eventInfo) {
  const [ , button ] = eventInfo.triggerName.split(":");
  changeHP(button);
});

</script>
<!-- FIN SCRIPTS / SHEET WORKERS -->
