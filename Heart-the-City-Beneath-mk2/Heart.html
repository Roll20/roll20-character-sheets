<div class="container">

  <div class="top grid-small">
    <img
      src="https://raw.githubusercontent.com/roll20/roll20-character-sheets/master/Heart-the-City-Beneath-mk2/Heart-logo-transparent.png"
      alt="Heart: The City Beneath logo" />
    <label>
      <span class="redtext" data-i18n="name-label">Name</span>
      <input type="text" spellcheck="false" name="attr_character_name">
    </label>
    <label>
      <span class="redtext" data-i18n="class-label">Class</span>
      <input type="text" spellcheck="false" name="attr_class">
    </label>
    <label>
      <span class="redtext" data-i18n="calling-label">Calling</span>
      <input type="text" spellcheck="false" name="attr_calling">
    </label>
    <label>
      <span class="redtext" data-i18n="ancestry-label">Ancestry</span>
      <input type="text" spellcheck="false" name="attr_ancestry">
    </label>
  </div>

  <div class="stress grid-large">
    <div class="stress-values grid-tiny">
      <h3 class="redtext stresslabel" data-i18n="stress-label">Stress</h3>
      <h3 class="redtext" data-i18n="protection-label">Protection</h3>

      <label>
        <span class="redtext" data-i18n="blood-label">Blood</span>
        <input type="number" value="0" min="0" max="10" name="attr_blood_stress" />
      </label>
      <input type="number" placeholder="0" min="0" max="5" name="attr_blood_protection" />

      <label>
        <span class="redtext" data-i18n="mind-label">Mind</span>
        <input type="number" value="0" min="0" max="10" name="attr_mind_stress" />
      </label>
      <input type="number" placeholder="0" min="0" max="5" name="attr_mind_protection" />

      <label>
        <span class="redtext" data-i18n="echo-label">Echo</span>
        <input type="number" value="0" min="0" max="10" name="attr_echo_stress" />
      </label>
      <input type="number" placeholder="0" min="0" max="5" name="attr_echo_protection" />

      <label>
        <span class="redtext" data-i18n="fortune-label">Fortune</span>
        <input type="number" value="0" min="0" max="10" name="attr_fortune_stress" />
      </label>
      <input type="number" placeholder="0" min="0" max="5" name="attr_fortune_protection" />

      <label>
        <span class="redtext" data-i18n="supplies-label">Supplies</span>
        <input type="number" value="0" min="0" max="10" name="attr_supplies_stress" />
      </label>
      <input type="number" placeholder="0" min="0" max="5" name="attr_supplies_protection" />

      <label>
        <span class="redtext" data-i18n="total-label">Total</span>
        <input type="number" value="0" min="0" max="10" name="attr_total_stress" readonly />
      </label>
    </div>

    <div class="stress-clear">
      <h3 class="redtext" data-i18n="clearstress-label">Clear Stress</h3>
      <select name="attr_clearedstress">
        <option value="blood" data-i18n="blood-label" selected>Blood</option>
        <option value="mind" data-i18n="mind-label">Mind</option>
        <option value="echo" data-i18n="echo-label">Echo</option>
        <option value="fortune" data-i18n="fortune-label">Fortune</option>
        <option value="supplies" data-i18n="supplies-label">Supplies</option>
        <option value="all" data-i18n="all-stress-label">All Stress</option>
      </select>
      <button type="action" title="Clear Stress" name="act_clear_stress" data-i18n="clear-label">Clear</button>
    </div>

    <button type="roll" title="Receive fallout?" name="roll_fallout" data-i18n="fallout-test-label"
      value="&{template:heart} {{title=^{fallout-label}}} {{name=@{character_name}}} {{fallout_against=[[@{total_stress}]]}} {{roll=[[1d12cs0cf0]] vs. [[@{total_stress}]]}}">Fallout</button>

    <div class="rollbutton grid-large">
      <button type="roll" title="roll dice" name="roll_normal" data-i18n="roll-label"
        value="/roll ?{@{howmanydice-msg}|1}d10kl[[?{@{howmanydice-msg}|1}-?{Difficulty|Standard, 0|Risky, 1|Dangerous, 2}]]dl[[?{@{howmanydice-msg}|1}-?{Difficulty|Standard, 0|Risky, 1|Dangerous, 2}-1]]">Roll</button>
      <div class="small-text">
        <span data-i18n="build-pool-label">Build dice pool: 1D + Skill + Domain + Mastery + Knack</span>
        <br />
        <b><span data-i18n="standard-msg">Standard</span>:</b>
        <span data-i18n="standard-pool-label">use highest result</span>
        <br />
        <b><span data-i18n="risky-msg">Risky</span>:</b>
        <span data-i18n="risky-pool-label">drop highest result, use second-highest result</span>
        <br />
        <b><span data-i18n="dangerous-msg">Dangerous</span>:</b>
        <span data-i18n="dangerous-pool-label">drop 2 highest results, use third-highest result</span>
      </div>
    </div>
  </div>

  <div class="beats grid-tiny">
    <h3 class="redtext" data-i18n="active-beats-label">Active Beats</h3>
    <fieldset class="repeating_activebeats">
      <div class="reprow grid-tiny">
        <input type="text" spellcheck="false" name="attr_beat_name" />
        <select name="attr_beat_type">
          <option value="minor" data-i18n="minor-label">Minor</option>
          <option value="major" data-i18n="major-label">Major</option>
          <option value="zenith" data-i18n="zenith-label">Zenith</option>
        </select>
      </div>
    </fieldset>
  </div>

  <div class="equipment grid-tiny">
    <h3 class="redtext" data-i18n="equipment-label">Equipment</h3>
    <div class="equipment-grid grid-tiny">
      <h4 data-i18n="name-label">Name</h4>
      <h4 data-i18n="description-label">Domain/Tags</h4>
      <h4 data-i18n="die-label">Die</h4>
    </div>
    <fieldset class="repeating_equipment">
      <div class="equipment-grid grid-tiny">
        <div class="auto-expand"><span name="attr_equipment_name"></span>
          <textarea spellcheck="false" name="attr_equipment_name"></textarea>
        </div>
        <div class="auto-expand"><span name="attr_equipment_desc"></span>
          <textarea spellcheck="false" name="attr_equipment_desc"></textarea>
        </div>
        <select name="attr_equipment_die">
          <option value="0" data-i18n="none" selected>None</option>
          <option value="2">d2</option>
          <option value="4">d4</option>
          <option value="6">d6</option>
          <option value="8">d8</option>
          <option value="10">d10</option>
          <option value="12">d12</option>
          <option value="20">d20</option>
        </select>
        <button type="roll" name="roll_roll"
          value="&{template:heart} {{name=@{character_name}}} {{title=@{equipment_name}}} {{roll=[[d@{equipment_die}]]}} {{details=@{equipment_desc}}}"></button>
      </div>
    </fieldset>
  </div>

  <div class="resources grid-tiny">
    <h3 class="redtext" data-i18n="resources-label">Resources</h3>
    <div class="equipment-grid grid-tiny">
      <h4 data-i18n="name-label">Name</h4>
      <h4 data-i18n="description-label">Domain/Tags</h4>
      <h4 ata-i18n="die-label">Die</h4>
    </div>
    <fieldset class="repeating_resources">
      <div class="equipment-grid grid-tiny">
        <div class="auto-expand"><span name="attr_resource_name"></span>
          <textarea spellcheck="false" name="attr_resource_name"></textarea>
        </div>
        <div class="auto-expand"><span name="attr_resource_desc"></span>
          <textarea spellcheck="false" name="attr_resource_desc"></textarea>
        </div>
        <select name="attr_resource_die">
          <option value="0" data-i18n="none" selected>None</option>
          <option value="2">d2</option>
          <option value="4">d4</option>
          <option value="6">d6</option>
          <option value="8">d8</option>
          <option value="10">d10</option>
          <option value="12">d12</option>
          <option value="20">d20</option>
        </select>
        <button type="roll" name="roll_roll"
          value="&{template:heart} {{name=@{character_name}}} {{title=@{resource_name}}} {{roll=[[d@{resource_die}]]}} {{details=@{resource_desc}}}"></button>
      </div>
    </fieldset>
  </div>

  <div class="skills-domains grid-large">
    <div class="skills grid-small">
      <h3 class="redtext" data-i18n="skills-label">Skills</h3>
      <h4 class="pinktext" data-i18n="knacks-label">Knacks</h4>

      <label>
        <input type="checkbox" name="attr_skill_compel" value="1" />
        <span data-i18n="compel">Compel</span>
      </label>
      <div class="auto-expand"><span name="attr_compel_knacks"></span>
        <textarea spellcheck="false" name="attr_compel_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_delve" value="1" />
        <span data-i18n="delve">Delve</span>
      </label>
      <div class="auto-expand"><span name="attr_delve_knacks"></span>
        <textarea spellcheck="false" name="attr_delve_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_discern" value="1" />
        <span data-i18n="discern">Discern</span>
      </label>
      <div class="auto-expand"><span name="attr_discern_knacks"></span>
        <textarea spellcheck="false" name="attr_discern_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_endure" value="1" />
        <span data-i18n="endure">Endure</span>
      </label>
      <div class="auto-expand"><span name="attr_endure_knacks"></span>
        <textarea spellcheck="false" name="attr_endure_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_evade" value="1" />
        <span data-i18n="evade">Evade</span>
      </label>
      <div class="auto-expand"><span name="attr_evade_knacks"></span>
        <textarea spellcheck="false" name="attr_evade_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_hunt" value="1" />
        <span data-i18n="hunt">Hunt</span>
      </label>
      <div class="auto-expand"><span name="attr_hunt_knacks"></span>
        <textarea spellcheck="false" name="attr_hunt_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_kill" value="1" />
        <span data-i18n="kill">Kill</span>
      </label>
      <div class="auto-expand"><span name="attr_kill_knacks"></span>
        <textarea spellcheck="false" name="attr_kill_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_mend" value="1" />
        <span data-i18n="mend">Mend</span>
      </label>
      <div class="auto-expand"><span name="attr_mend_knacks"></span>
        <textarea spellcheck="false" name="attr_mend_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_skill_sneak" value="1" />
        <span data-i18n="sneak">Sneak</span>
      </label>
      <div class="auto-expand"><span name="attr_sneak_knacks"></span>
        <textarea spellcheck="false" name="attr_sneak_knacks"></textarea>
      </div>
    </div>
    <div class="domains grid-small">
      <h3 class="redtext" data-i18n="domains-label">Domains</h3>
      <h4 class="pinktext" data-i18n="knacks-label">Knacks</h4>

      <label>
        <input type="checkbox" name="attr_domain_cursed" value="1" />
        <span data-i18n="cursed">Cursed</span>
      </label>
      <div class="auto-expand"><span name="attr_cursed_knacks"></span>
        <textarea spellcheck="false" name="attr_cursed_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_desolate" value="1" />
        <span data-i18n="desolate">Desolate</span>
      </label>
      <div class="auto-expand"><span name="attr_desolate_knacks"></span>
        <textarea spellcheck="false" name="attr_desolate_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_haven" value="1" />
        <span data-i18n="haven">Haven</span>
      </label>
      <div class="auto-expand"><span name="attr_haven_knacks"></span>
        <textarea spellcheck="false" name="attr_haven_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_occult" value="1" />
        <span data-i18n="occult">Occult</span>
      </label>
      <div class="auto-expand"><span name="attr_occult_knacks"></span>
        <textarea spellcheck="false" name="attr_occult_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_religion" value="1" />
        <span data-i18n="religion">Religion</span>
      </label>
      <div class="auto-expand"><span name="attr_religion_knacks"></span>
        <textarea spellcheck="false" name="attr_religion_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_technology" value="1" />
        <span data-i18n="technology">Technology</span>
      </label>
      <div class="auto-expand"><span name="attr_technology_knacks"></span>
        <textarea spellcheck="false" name="attr_technology_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_warren" value="1" />
        <span data-i18n="warren">Warren</span>
      </label>
      <div class="auto-expand"><span name="attr_warren_knacks"></span>
        <textarea spellcheck="false" name="attr_warren_knacks"></textarea>
      </div>

      <label>
        <input type="checkbox" name="attr_domain_wild" value="1" />
        <span data-i18n="wild">Wild</span>
      </label>
      <div class="auto-expand"><span name="attr_wild_knacks"></span>
        <textarea spellcheck="false" name="attr_wild_knacks"></textarea>
      </div>
    </div>
  </div>

  <div class="abilities-fallout grid-large">
    <div class="abilities grid-tiny">
      <h3><span class="whiteonredtext" data-i18n="abilities-label">Abilities</span></h3>
      <fieldset class="repeating_abilities">
        <div class="reprow grid-tiny">
          <input type="text" class="redtext" spellcheck="false" name="attr_ability_name"
            data-i18n-placeholder="ability_name" />
          <select name="attr_ability_type">
            <option value="minor" data-i18n="minor-label">Minor</option>
            <option value="major" data-i18n="major-label">Major</option>
            <option value="zenith" data-i18n="zenith-label">Zenith</option>
          </select>
          <div class="auto-expand"><span name="attr_ability_details"></span>
            <textarea spellcheck="false" name="attr_ability_details"></textarea>
          </div>
        </div>
      </fieldset>
    </div>
    <div class="fallout grid-tiny">
      <h3><span class="whiteonredtext" data-i18n="fallout-label">Fallout</span></h3>
      <fieldset class="repeating_fallout">
        <div class="reprow grid-tiny">
          <input type="text" spellcheck="false" class="sheet-redtext" name="attr_fallout_name"
            data-i18n-placeholder="fallout_name" />
          <select name="attr_fallout_type">
            <option value="blood" data-i18n="blood-label" selected>Blood</option>
            <option value="mind" data-i18n="mind-label">Mind</option>
            <option value="echo" data-i18n="echo-label">Echo</option>
            <option value="fortune" data-i18n="fortune-label">Fortune</option>
            <option value="supplies" data-i18n="supplies-label">Supplies</option>
          </select>
          <select name="attr_fallout_severity">
            <option value="minor" data-i18n="minor-label">Minor</option>
            <option value="major" data-i18n="major-label">Major</option>
            <option value="critical" data-i18n="critical-label">Critical</option>
          </select>
          <div class="auto-expand"><span name="attr_fallout_details"></span>
            <textarea spellcheck="false" name="attr_fallout_details"></textarea>
          </div>
        </div>
      </fieldset>
    </div>
  </div>


  <div class="notes grid-tiny">
    <h3><span class="redtext" data-i18n="notes-label">Notes</h3>
    <fieldset class="repeating_notes">
      <div class="auto-expand"><span name="attr_notes"></span>
        <textarea spellcheck="false" name="attr_notes"></textarea>
      </div>
    </fieldset>
  </div>

</div>

<input type="hidden" name="attr_version" value="0" />
<input type="hidden" name="attr_howmanydice-msg" value="" />
<input type="hidden" name="attr_difficulty-msg" value="" />
<input type="hidden" name="attr_standard-msg" value="" />
<input type="hidden" name="attr_risky-msg" value="" />
<input type="hidden" name="attr_dangerous-msg" value="" />
<input type="hidden" name="attr_check-fallout-msg" value="" />

<rolltemplate class="sheet-rolltemplate-heart">
  <div class="title">{{title}}</div>
  <div class="name">{{name}}</div>
  <div class="roll">
    {{roll}}
    {{#fallout_against}}
      <span>â€”</span>
      {{#rollGreater() roll fallout_against}}
      <span data-i18n="no-fallout"></span>
      {{/rollGreater() roll fallout_against}}
      {{#^rollGreater() roll fallout_against}}
      {{#rollGreater() roll 6}}<span data-i18n="take-major-fallout"></span>{{/rollGreater() roll 6}}
      {{#^rollGreater() roll 6}}<span data-i18n="take-minor-fallout"></span>{{/^rollGreater() roll 6}}
      {{/^rollGreater() roll fallout_against}}
    {{/fallout_against}}
  </div>
  {{#details}}<div class="details">{{details}}</div>{{/details}}

</rolltemplate>

<script type="text/worker">
  const kStresses = ["blood", "mind", "echo", "fortune", "supplies"].map(
    (x) => `${x}_stress`
  );
  
  on("sheet:opened", function (eventInfo) {
    setAttrs({
      ["howmanydice-msg"]: getTranslationByKey("howmanydice-msg"),
      ["difficulty-msg"]: getTranslationByKey("difficulty-msg"),
      ["standard-msg"]: getTranslationByKey("standard-msg"),
      ["risky-msg"]: getTranslationByKey("risky-msg"),
      ["dangerous-msg"]: getTranslationByKey("dangerous-msg"),
      ["check-fallout-msg"]: getTranslationByKey("check-fallout-msg"),
    });
  });
  
  on("clicked:clear_stress", function () {
    console.log("foo");
    getAttrs(["clearedstress"], function (values) {
      const attrs = {};
      if (values["clearedstress"] === "all") {
        kStresses.forEach((stress) => {
          attrs[stress] = 0;
        });
      } else {
        attrs[values["clearedstress"] + "_stress"] = 0;
      }
      setAttrs(attrs);
    });
  });
  
  on(kStresses.map((x) => `change:${x}`).join(" "), () => {
    console.log("boo");
    getAttrs(kStresses, (values) => {
      const total_stress = kStresses.reduce((m, stress) => {
        return m + parseInt(values[stress], 10) || 0;
      }, 0);
      setAttrs({ total_stress });
    });
  });
  
  on("sheet:opened", () => {
    getAttrs(["version"], (v) => {
      if (v.version == "0") runLegacyUpgrade();
      setAttrs({ version: "1" });
    });
  });
  
  // This is not very efficient, but it only runs at most once.
  function runLegacyUpgrade() {
    console.log("Running one-time upgrade from pre-versioned sheet.");
    const attrRenames = {
      "domainCursed": "domain_cursed",
      "domainDesolate": "domain_desolate",
      "domainHaven": "domain_haven",
      "domainOccult": "domain_occult",
      "domainReligion": "domain_religion",
      "domainTechnology": "domain_technology",
      "domainWarren": "domain_warren",
      "domainWild": "domain_wild",
      "skillCompel": "skill_compel",
      "skillDelve": "skill_delve",
      "skillDiscern": "skill_discern",
      "skillEndure": "skill_endure",
      "skillEvade": "skill_evade",
      "skillHunt": "skill_hunt",
      "skillKill": "skill_kill",
      "skillMend": "skill_mend",
      "skillSneak": "skill_sneak",
    };
    getAttrs([...Object.keys(attrRenames), "fallout"], (v) => {
      const attrs = {};
      for (const [oldName, newName] of Object.entries(attrRenames)) {
        if (v[oldName] === "1") attrs[newName] = "1";
      }
      if (v.fallout) {
        attrs[`repeating_fallout_${generateRowID()}_fallout_details`] = v.fallout;
      }
      setAttrs(attrs);
    });
  
    const repeatingRenames = {
      "abilities": {
        "abilityTitle": "ability_name",
        "abilityDetails": "ability_details",
      },
      "activebeats": {
        "beats": "beat_name",
      },
    };
    for (const [sectionName, sectionAttrs] of Object.entries(repeatingRenames)) {
      getSectionIDs(`repeating_${sectionName}`, (sectionIds) => {
        const attrsToGet = sectionIds.flatMap((id) =>
          Object.keys(sectionAttrs).map(
            (x) => `repeating_${sectionName}_${id}_${x}`
          )
        );
        getAttrs(attrsToGet, (v) => {
          const attrs = {};
          for (const [oldName, newName] of Object.entries(sectionAttrs)) {
            for (const id of sectionIds) {
              attrs[`repeating_${sectionName}_${id}_${newName}`] =
                v[`repeating_${sectionName}_${id}_${oldName}`];
            }
          }
          setAttrs(attrs);
        });
      });
    }
  }
</script>