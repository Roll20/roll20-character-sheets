<div class="sheet-body">
	<div class="border">
		<h1 class="title">
			<img
				src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/Draw%20Steel/images/powered_by_draw_steel_vertical.webp"
				alt="Powered By Draw Steel"
				style="height: 100px"
			/>
		</h1>
		<div class="header-panel">
			<div class="profile-panel border">
				<div class="name-input-group">
					<input type="text" name="attr_name" />
					<label class="sublabel" data-i18n="character-name"></label>
				</div>
				<div class="ancestry-input-group">
					<input type="text" class="input-md" name="attr_ancestry" />
					<label class="sublabel" data-i18n="ancestry"></label>
				</div>
				<div class="class-input-group">
					<input type="text" class="input-md" name="attr_class" />
					<label class="sublabel" data-i18n="class"></label>
				</div>
				<div class="career-input-group">
					<input type="text" class="input-md" name="attr_career" />
					<label class="sublabel" data-i18n="career"></label>
				</div>
				<div class="subclass-input-group">
					<input type="text" class="input-md" name="attr_subclass" />
					<label class="sublabel" data-i18n="subclass"></label>
				</div>
			</div>
			<div class="progress-panel border">
				<div class="victories-input-group">
					<h5 data-i18n="victories"></h5>
					<input type="number" name="attr_victories" />
				</div>
				<div class="level-input-group">
					<h5 data-i18n="level"></h5>
					<input type="number" name="attr_level" />
				</div>
				<div class="wealth-input-group">
					<label data-i18n="wealth"></label>
					<input type="number" class="input-md" name="attr_wealth" />
				</div>
				<div class="renown-input-group">
					<label data-i18n="renown"></label>
					<input type="number" class="input-md" name="attr_renown" />
				</div>
				<div class="experience-input-group">
					<label data-i18n="experience"></label>
					<input type="number" class="input-md" name="attr_experience" />
				</div>
			</div>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="stats-panel border minimizable">
		<div class="minimize-control">
			<input id="stats-minimize-checkbox" class="minimize" type="checkbox" />
			<label for="stats-minimize-checkbox">Minimize Panel</label>
		</div>
		<div class="core-panel minimize-ignore">
			<div class="characteristics minimize-ignore">
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="might" data-i18n="might"></label>
					<input type="number" name="attr_might" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="agility" data-i18n="agility"></label>
					<input type="number" name="attr_agility" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="reason" data-i18n="reason"></label>
					<input type="number" name="attr_reason" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="intuition" data-i18n="intuition"></label>
					<input type="number" name="attr_intuition" />
				</div>
				<div class="characteristic-input-group hexagon">
					<label data-characteristic="presence" data-i18n="presence"></label>
					<input type="number" name="attr_presence" />
				</div>
			</div>
			<div class="roller-wrapper popup-wrapper">
				<div class="overlay" data-popup-target="roller-wrapper"></div>
				<div class="popup-content">
					<h2>
						<input type="hidden" class="characteristic-i18n-switch" name="attr_roller_characteristic" />
						<span class="characteristic-i18n" data-i18n="might"></span>
						<span class="characteristic-i18n" data-i18n="agility"></span>
						<span class="characteristic-i18n" data-i18n="reason"></span>
						<span class="characteristic-i18n" data-i18n="intuition"></span>
						<span class="characteristic-i18n" data-i18n="presence"></span>
						<span>Power Roll</span>
					</h2>
					<div class="roller-edge-bane-select">
						<label>Double Bane</label>
						<label>Bane</label>
						<label></label>
						<label>Edge</label>
						<label>Double Edge</label>
						<input type="radio" name="attr_roller_edge_bane" value="doubleBane" />
						<input type="radio" name="attr_roller_edge_bane" value="bane" />
						<input type="radio" name="attr_roller_edge_bane" value="" checked />
						<input type="radio" name="attr_roller_edge_bane" value="edge" />
						<input type="radio" name="attr_roller_edge_bane" value="doubleEdge" />
					</div>
					<div>
						<label>Bonus or Penalty</label>
						<input type="number" class="inner-spin" name="attr_roller_mod" />
					</div>
					<div>
						<button type="action" name="act_powerroll">Roll!</button>
					</div>
				</div>
			</div>
			<div class="potencies">
				<h5 class="panel-title" data-i18n="potencies"></h5>
				<div>
					<label data-i18n="potency-weak"></label>
					<input type="number" class="input-md" name="attr_potency_weak" />
					<label data-i18n="potency-average"></label>
					<input type="number" class="input-md" name="attr_potency_average" />
					<label data-i18n="potency-strong"></label>
					<input type="number" class="input-md" name="attr_potency_strong" />
				</div>
			</div>
			<div class="movement">
				<div class="movement-input-group">
					<input type="text" class="input-md" name="attr_size" />
					<label class="sublabel" data-i18n="size"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_speed" />
					<label class="sublabel" data-i18n="speed"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_disengage" />
					<label class="sublabel" data-i18n="disengage"></label>
				</div>
				<div class="movement-input-group">
					<input type="number" class="input-md" name="attr_stability" />
					<label class="sublabel" data-i18n="stability"></label>
				</div>
			</div>
		</div>
		<div class="stamina-panel">
			<h5 class="panel-title" data-i18n="stamina"></h5>
			<div class="stamina-input-group">
				<input type="number" name="attr_stamina" />
				<label class="sublabel" data-i18n="stamina-current"></label>
			</div>
			<input type="number" class="input-md" name="attr_stamina_max" />
			<label class="sublabel" data-i18n="stamina-max"></label>
			<input type="number" class="input-md" name="attr_stamina_winded" />
			<label class="sublabel" data-i18n="winded"></label>
			<div class="stamina-temporary-input-group">
				<input type="number" class="input-md" name="attr_stamina_temporary" />
				<label class="sublabel" data-i18n="stamina-temporary"></label>
			</div>
			<input type="number" class="input-md" disabled value="0" />
			<label class="sublabel" data-i18n="dying"></label>
			<input type="number" class="input-md" name="attr_stamina_dead" />
			<label class="sublabel" data-i18n="dead"></label>
		</div>
		<div class="recoveries-panel">
			<h5 class="panel-title" data-i18n="recoveries"></h5>
			<div class="recoveries-input-group">
				<input type="number" name="attr_recoveries" />
			</div>
			<div class="recovery-amount-input-group">
				<input type="number" class="input-md" name="attr_recovery_amount" />
				<label class="sublabel" data-i18n="recovery-amount"></label>
			</div>
			<div class="recoveries-max-input-group">
				<input type="number" class="input-md" name="attr_recoveries_max" />
				<label class="sublabel" data-i18n="recoveries-max"></label>
			</div>
		</div>
		<div class="damage-mod-panel">
			<label>Immunity</label>
			<input type="text" class="input-md" name="attr_immunity" />
			<label>Weakness</label>
			<input type="text" class="input-md" name="attr_weakness" />
		</div>
		<div class="resource-description-panel">
			<textarea data-i18n-placeholder="resource-description-placeholder" name="attr_resource_description"></textarea>
		</div>
		<div class="resource-panel">
			<h5 class="panel-title" data-i18n="resource"></h5>
			<div class="resource-input-group">
				<input type="number" name="attr_resource" />
			</div>
			<div class="resource-name-input-group">
				<input type="text" class="input-md" name="attr_resource_name" data-i18n-placeholder="resource-name-placeholder" />
			</div>
		</div>
		<div class="surges-panel">
			<h5 class="panel-title" data-i18n="surges"></h5>
			<div class="surges-input-group">
				<input type="number" name="attr_surges" />
			</div>
			<label class="sublabel">
				1 Surge = Damage <input type="number" class="input-sm" name="attr_surge_damage" />
			</label>
			<label class="sublabel">
				2 Surges = Potency + 1
			</label>
		</div>
		<div class="conditions-panel">
			<h5 class="panel-title" data-i18n="conditions"></h5>
			<fieldset class="repeating_conditions">
				<input type="text" name="attr_condition_name" data-i18n-placeholder="condition" />
				<div>
					<input type="radio" name="attr_end" />
					<label data-i18n="eot"></label>
				</div>
				<div>
					<input type="radio" name="attr_end" />
					<label data-i18n="save-ends"></label>
				</div>
			</fieldset>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="biography-panel border minimizable">
		<div class="minimize-control">
			<input id="biography-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="biography-minimize-checkbox">Minimize Panel</label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="biography"></h5>
		</div>
		<div class="ancestry-panel">
			<h5 class="panel-title" data-i18n="ancestry"></h5>
			<code>TODO: ancestry</code>
		</div>
		<div class="culture-panel">
			<h5 class="panel-title" data-i18n="culture"></h5>
			<code>TODO: culture</code>
		</div>
		<div class="career-panel">
			<h5 class="panel-title" data-i18n="career"></h5>
			<code>TODO: career</code>
		</div>
		<div class="complication-panel">
			<h5 class="panel-title" data-i18n="complication"></h5>
			<code>TODO: complication</code>
		</div>
		<div class="class-panel">
			<h5 class="panel-title" data-i18n="class"></h5>
			<code>TODO: class</code>
		</div>
		<div class="perks-panel">
			<h5 class="panel-title" data-i18n="perks"></h5>
			<code>TODO: perks</code>
		</div>
		<div class="titles-panel">
			<h5 class="panel-title" data-i18n="titles"></h5>
			<code>TODO: titles</code>
		</div>
	</div>
	<div class="v-spacer"></div>
	<div class="skills-panel border minimizable">
		<div class="minimize-control">
			<input id="skills-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="skills-minimize-checkbox">Minimize Panel</label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="skills"></h5>
		</div>
		<code>TODO: skills</code>
		<code>TODO: languages</code>
	</div>
	<div class="v-spacer"></div>
	<div class="combat-panel border minimizable">
		<div class="minimize-control">
			<input id="combat-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="combat-minimize-checkbox">Minimize Panel</label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="combat"></h5>
		</div>
		<code>TODO: loadout (kit/augmentation/enchantment/prayer/ward)</code>
		<code>TODO: abilities</code>
	</div>
	<div class="v-spacer"></div>
	<div class="projects-panel border minimizable">
		<div class="minimize-control">
			<input id="projects-minimize-checkbox" class="minimize" type="checkbox" checked />
			<label for="projects-minimize-checkbox">Minimize Panel</label>
		</div>
		<div class="minimize-show">
			<h5 data-i18n="projects"></h5>
		</div>
		<code>TODO: projects</code>
	</div>
	</div>
	<code>TODO: TOC?</code>
	<div style="font-family: Menlo, Monaco, Consolas">This Draw Steel character sheet for Roll20 is an independent product published under the DRAW STEEL Creator License and is not affiliated with MCDM Productions, LLC. DRAW STEEL Â© 2024 MCDM Productions, LLC.</div>
</div>
<rolltemplate class="sheet-rolltemplate-power">
	<div class="sheet-template-body">
		{{#rollGreater() computed::rawDice 18}}
			<div class="sheet-template-crit">Critical</div>
		{{/rollGreater() computed::rawDice 18}}
		<div class="sheet-template-result">
			Tier
			{{computed::roll}}
			Result
		</div>
	</div>
</rolltemplate>
<script type="text/worker">
	function setActiveCharacterId(id) {
		const ocid = getActiveCharacterId();
		const data = {
			id: '0',
			type: 'setActiveCharacter',
			data: id,
		};
		if (self.dispatchEvent) {
			const event = new CustomEvent('message');
			event.data = data;
			self.dispatchEvent(event);
		}
		else {
			self.onmessage({ data });
		}
		return ocid;
	}
	function getAttrsAsync(props) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				getAttrs(props, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}
	function setAttrsAsync(props) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				setAttrs(props, undefined, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}
	$20('.characteristic-input-group > label').on('click', async (e) => {
		await setAttrsAsync({
			roller_characteristic: e.htmlAttributes['data-characteristic'],
			roller_edge_bane: '',
			roller_mod: 0,
		});
		$20('.roller-wrapper').addClass('show');
	});
	$20('.overlay').on('click', (e) => {
		$20(`.${e.htmlAttributes['data-popup-target']}`).removeClass('show');
	});
	on("clicked:powerroll", async () => {
		const attrs = await getAttrsAsync([
			'roller_characteristic', 'roller_edge_bane', 'roller_mod',
			'might', 'agility', 'reason', 'intuition', 'presence',
		]);
		const characteristicValue = attrs[attrs.roller_characteristic];
		const characteristicTranslation = getTranslationByKey(attrs.roller_characteristic);
		const modifier = (() => {
			if (!attrs.roller_mod) {
				return '';
			}
			return attrs.roller_mod > 0
				? ` + ${attrs.roller_mod} [Bonus]`
				: ` - ${0 - attrs.roller_mod} [Penalty]`;
		})();
		const edgeBaneMod = (() => {
			switch (attrs.roller_edge_bane) {
				case 'bane':
					return ' - 2 [Bane]';
				case 'edge':
					return ' + 2 [Edge]';
				default:
					return '';
			}
		})();
		startRoll(
			`&{template:power} {{roll=[[` +
				`2d10 + ${characteristicValue} [${characteristicTranslation}]` +
				modifier + edgeBaneMod +
				`]]}} {{rawDice=[[0]]}} {{edgeBane=todo}}`,
			(roll) => {
				const doubleEdgeBane = (() => {
					switch (attrs.roller_edge_bane) {
						case 'doubleBane':
							return -1;
						case 'doubleEdge':
							return 1;
						default:
							return 0;
					}
				})();
				finishRoll(
					roll.rollId,
					{
						rawDice: roll.results.roll.dice.reduce((sum, d) => sum + d, 0),
						roll: (() => {
							if (roll.results.roll.result >= 17) {
								return Math.min(3 + doubleEdgeBane, 3);
							}
							if (roll.results.roll.result >= 12) {
								return 2 + doubleEdgeBane;
							}
							return Math.max(1 + doubleEdgeBane, 1);
						})(),
					}
				);
			}
		);
	});
</script>
