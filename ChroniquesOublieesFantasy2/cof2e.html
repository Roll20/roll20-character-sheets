<div class="cofmain">

  <!-- Nouvelle version fiche -->
  <input type="hidden" name="attr_verfdp" value="1.0.0">
  <!-- Version courante fiche -->
  <input type="hidden" name="attr_version" value="1.0.0">
  <!-- Mode debug -->
  <input type="hidden" name="attr_debug_mode" value="0">

  <!-- Token -->
  <input type="hidden" name="attr_token_url" value="">
  <input type="hidden" name="attr_token_dsp" value="">
  
  <!-- Jets -->
  <input type="hidden" name="attr_devol" value="d4">
  <input type="hidden" name="attr_last_rolls" value="">

  <!-- Buffs PJ -->
  <input type="hidden" name="attr_agi_buff" value="0">
  <input type="hidden" name="attr_con_buff" value="0">
  <input type="hidden" name="attr_for_buff" value="0">
  <input type="hidden" name="attr_per_buff" value="0">
  <input type="hidden" name="attr_cha_buff" value="0">
  <input type="hidden" name="attr_int_buff" value="0">
  <input type="hidden" name="attr_vol_buff" value="0">
  <input type="hidden" name="attr_atkcac_buff" value="0">
  <input type="hidden" name="attr_atkcac_cond" value="0">
  <input type="hidden" name="attr_atktir_buff" value="0">
  <input type="hidden" name="attr_atktir_cond" value="0">
  <input type="hidden" name="attr_atkmag_buff" value="0">
  <input type="hidden" name="attr_atkmag_cond" value="0">
  <input type="hidden" name="attr_init_base" value="10">
  <input type="hidden" name="attr_init_buff" value="0">
  <input type="hidden" name="attr_init_cond" value="0">
  <input type="hidden" name="attr_def_base" value="10">
  <input type="hidden" name="attr_def_car" value="AGI">
  <input type="hidden" name="attr_def_car_bonus" value="0">
  <input type="hidden" name="attr_def_buff" value="0">
  <input type="hidden" name="attr_def_cond" value="0">
  <input type="hidden" name="attr_pv_buff" value="0">
  <input type="hidden" name="attr_dr_buff" value="0">
  <input type="hidden" name="attr_pm_buff" value="0">
  <input type="hidden" name="attr_pc_buff" value="0">

  <!-- Other hidden attributes -->
  <input type="hidden" name="attr_rangs_voies" value="">
  <input type="hidden" name="attr_noms_voies" value="">
  <input type="hidden" name="attr_armor_malus" value="0">

  <!-- COFantasy MOD interaction -->
  <input type="hidden" name="attr_script_title" value="">
  <input type="hidden" name="attr_cofantasy" value="">

  <!-- Repeating labels -->
  <input type="hidden" name="attr_max_attack_label" value="">

  <!-- Entête : Logo, Avatar, Identité -->
  <div class="heading">

    <!-- Logo COF -->
    <div>
      <img
        class="logo"
        title="Version 1.0.0 - 20/12/2024"
        src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cof2e_logo.jpg"
      />
    </div>

    <!-- Token -->
    <div>
      <img class="token"  name="attr_character_token">
    </div>

    <!-- Identité -->
    <div class="bordered border-rounded identity">
      <input type="hidden" class="cof-head-toggle" name="attr_sheet_type" value="pc"/> 

      <!-- Identité PJ -->
      <div class="identity-pc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name} Nom du personnage" value="">
          </div>
          <div><strong>Genre</strong></div>
          <div>
            <input type="text" name="attr_genre" title="@{genre}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Profil / Famille</strong></div>
          <div class="d-flex">
            <input type="text" name="attr_profil" list="pc-profiles" placeholder="Profil" title="@{profil} Profil" value="">
            <datalist id="pc-profiles"></datalist>
            <select class="select-lg" name="attr_famille" title="@{famille} Famille de profil">
              <option value="">Choisir...</option>
              <option>Aventuriers</option>
              <option>Combattants</option>
              <option>Mages</option>
              <option>Mystiques</option>
            </select>
          </div>
          <div><strong>Age</strong></div>
          <div>
            <input type="text" name="attr_age" title="@{age}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Peuple</strong></div>
          <div>
            <input type="text" name="attr_peuple" title="@{peuple}" value="">
          </div>
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_taille" title="@{taille}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Idéal héroïque</strong></div>
          <div>
            <input type="text" name="attr_ideal" title="@{ideal}" value="">
          </div>
          <div><strong>Poids</strong></div>
          <div>
            <input type="text" name="attr_poids" title="@{poids}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Travers</strong></div>
          <div>
            <input type="text" name="attr_travers" title="@{travers}" value="">
          </div>
          <div></div>
          <div></div>
        </div>

      </div>

      <!-- Identité PNJ -->
      <div class="identity-npc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Type</strong></div>
          <div>
            <input type="text" name="attr_creature" title="@{creature}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_taille" title="@{taille}" value="">
          </div>
        </div>

      </div>

      <!-- Niveau & Type de fiche -->
      <div class="level-type">
        <div class="d-flex d-flex-middle">
          <strong>Niveau</strong>
        </div>
        <div class="d-flex d-flex-middle">
          <input type="number" name="attr_niveau" title="@{niveau}" value="1">
        </div>
        <div>
          <strong>Type</strong>
          <select class="select-md" name="attr_sheet_type">
            <option value="pc" selected>PJ</option>
            <option value="npc">PNJ</option>
          </select>
        </div>
        <div class="d-flex d-flex-middle">
          <button type="action" class="flat-btn img-btn" name="act_alias-toggle">
            <span class="img-btn"></span><strong>Alias</strong>
          </button>
        </div>
        <div class="d-flex d-flex-middle">
          <input type="text" name="attr_alias" title="@{alias} Alias du personnage" value="">
        </div>
      </div>
      
    </div>
  </div>

  <!-- Fiches -->
  <div class="cofsheet">
    <input type="hidden" class="cof-type-toggle" name="attr_sheet_type" value="pc"/> 
    <button type="action" class="hidden" name="act_pc_menus-btn"></button>
    
      <!-- Fiche PJ -->
    <div class="cof-pc">
      <input type="hidden" class="tabs-toggle" name="attr_pc_tab" value="main" />
      <div>
        <button type="action" name="act_pc_main-btn" class="main-tab tab-btn pc-main-btn">ATTRIBUTS</button>
        <button type="action" name="act_pc_abilities-btn" class="main-tab tab-btn pc-abilities-btn">CAPACITES</button>
        <button type="action" name="act_pc_gears-btn" class="main-tab tab-btn pc-gears-btn">EQUIPEMENT</button>
        <button type="action" name="act_pc_config-btn" class="main-tab tab-btn pc-config-btn">CONFIGURATION</button>
        <button type="action" name="act_pc_script-btn" class="main-tab tab-btn pc-script-btn">SCRIPT</button>
        <button type="action" name="act_pc_version-btn" class="main-tab tab-btn pc-version-btn">VERSION</button>
      </div>

      <!-- Fiche PJ, Onglet Caracs -->
      <div class="pc-main-tab">

        <div class="pc-attributes">
  
          <!-- Caractéristiques -->
          <div class="traits">

            <div class="trait">
              <h4>
                Carac
                <button type="action" class="flat-btn img-btn" name="act_caract_menu-btn" title="%{caract_menu-btn} Menu des jets de caractéristiques">
                  <span class="img-btn">l</span>
                </button>
              </h4>
              <h4></h4>
              <h4>Mod</h4>
              <h4>Bonus</h4>
              <h4>Test</h4>
            </div>


            <!-- AGI -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_agi-btn">
                  <span class="d20-btn">t</span>
                  AGI
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_agi_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_agi" title="@{agi}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_agi_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_agi_test" title="@{agi_test}" value="0">
                <span name="attr_agi_test"></span>
              </div>
            </div>

            <!-- CON -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_con-btn">
                  <span class="d20-btn">t</span>
                  CON
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_con_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_con" title="@{con}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_con_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_con_test" title="@{con_test}" value="0">
                <span name="attr_con_test"></span>
              </div>
            </div>

            <!-- FOR -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_for-btn">
                  <span class="d20-btn">t</span>
                  FOR
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_for_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_for" title="@{for}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_for_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_for_test" title="@{for_test}" value="0">
                <span name="attr_for_test"></span>
              </div>
            </div>

            <!-- PER -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_per-btn">
                  <span class="d20-btn">t</span>
                  PER
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_per_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_per" title="@{per}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_per_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_per_test" title="@{per_test}" value="0">
                <span name="attr_per_test"></span>
              </div>
            </div>

            <!-- CHA -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_cha-btn">
                  <span class="d20-btn">t</span>
                  CHA
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_cha_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_cha" title="@{cha}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_cha_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_cha_test" title="@{cha_test}" value="0">
                <span name="attr_cha_test"></span>
              </div>
            </div>

            <!-- INT -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_int-btn">
                  <span class="d20-btn">t</span>
                  INT
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_int_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_int" title="@{int}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_int_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_int_test" title="@{int_test}" value="0">
                <span name="attr_int_test"></span>
              </div>
            </div>

            <!-- VOL -->
            <div class="trait">
              <div class="block-title">
                <button class="block-title" type="action" name="act_vol-btn">
                  <span class="d20-btn">t</span>
                  VOL
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_vol_sup">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
              </div>
              <div class="bordered">
                <input type="number" name="attr_vol" title="@{vol}" value="0">
              </div>
              <div class="centered bordered">
                <span name="attr_vol_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_vol_test" title="@{vol_test}" value="0">
                <span name="attr_vol_test"></span>
              </div>
            </div>

          </div>

          <!-- Scores d'attaque -->
          <div class="attacks">

            <div class="attack">
              <h4>Combat</h4>
              <h4>Base</h4>
              <h4>Mod.</h4>
              <h4>Div.</h4>
              <h4><strong>Score</strong></h4>
            </div>

            <!-- Init -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_init-btn">
                  <span class="d20-btn">t</span>
                  INITIATIVE
                </button>
              </div>
              <div class="centered bordered">
                <span name="attr_init_base"></span>
              </div>
              <div class="centered bordered">
                PER: <span name="attr_per"></span>
                <input type="hidden" name="attr_cfg_init_agi" class="init-agi" value="0">
                <div class="init-agi">+AGI: <span name="attr_agi"></span></div>
              </div>
              <div class="centered bordered">
                <span name="attr_init_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_init" value="10">
                <span name="attr_init" title="@{init}"></span>
              </div>
            </div>

            <!-- CONTACT -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkcac-btn">
                  <span class="d20-btn">t</span>
                  AU CONTACT
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkcac_base" title="@{atkcac_base}" value="1">
              </div>
              <div class="centered bordered">
                FOR : <span name="attr_for"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atkcac_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkcac" value="1">
                <span name="attr_atkcac" title="@{atkcac}"></span>
              </div>
            </div>

            <!-- DISTANCE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atktir-btn">
                  <span class="d20-btn">t</span>
                  A DISTANCE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atktir_base" title="@{atktir_base}" value="1">
              </div>
              <div class="centered bordered">
                AGI : <span name="attr_agi"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atktir_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atktir" value="1">
                <span name="attr_atktir" title="@{atktir}"></span>
              </div>
            </div>

            <!-- MAGIE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkmag-btn">
                  <span class="d20-btn">t</span>
                  MAGIE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkmag_base" title="@{atkmag_base}" value="1">
              </div>
              <div class="centered bordered">
                VOL : <span name="attr_vol"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atkmag_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkmag" value="1">
                <span name="attr_atkmag" title="@{atkmag}"></span>
              </div>
            </div>

          </div>
          
          <!-- VIGUEUR & MISC -->
          <div class="vitality">

            <!-- PV -->
            <div class="centered">
              <h4>POINTS DE VIGUEUR</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vigloss-btn">
                  <span class="img-btn">e</span>
                </button>
                PV
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vigheal-btn">
                  <span class="img-btn">k</span>
                </button>
              </div>

              <div class="bordered centered">
                <input type="number" class="two-digits" name="attr_pv" title="@{pv} PV courants" value="0">
                /
                <input type="number" class="two-digits" name="attr_pv_max" title="@{pv_max} PV maximum" value="0">
              </div>

            </div>

            <!-- DR -->
            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn" type="action" name="act_drecup-btn">
                  DR
                </button>
                <select name="attr_drecup" class="select-xs" title="@{drecup} Type de DR">
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                </select>
              </div>

              <div class="bordered centered">
                <input type="number" name="attr_dr" title="@{dr} DR courants" value="2">
                /
                <input type="number" name="attr_dr_max" title="@{dr_max} DR maximum" value="2">
              </div>

            </div>

            <div class="bordered centered hit">
              DM temporaires
              <input type="number" name="attr_temp_dm" title="@{temp_dm}" value="">
            </div>

            <!-- PM -->
            <div class="centered">
              <h4>POINTS DE MANA</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">PM</div>

              <div class="bordered centered">
                <input type="number" name="attr_pm" title="@{pm} PM courants" value="0">
                /
                <input type="number" name="attr_pm_max" title="@{pm_max} PM maximum" value="0">
              </div>

            </div>

            <!-- D4° -->
            <div class="centered">
              <h4>DE EVOLUTIF</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn" type="action" name="act_devol-btn">
                  D4°
                </button>
              </div>

              <div class="bordered centered">
                <span name="attr_devol"></span>
              </div>

            </div>

          </div>
  
        </div>
  
        <!-- Conditions & Défenses -->
        <div class="pc-cond-def">
  
          <div class="conditions">
            <div class="centered block-header">Etats préjudiciables</div>
            <div class="bordered centered">
              <input type="hidden" class="condition-affaibli" name="attr_condition_affaibli" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_affaibli-icon"
                title="Affaibli"
              ><img
                class="bubble-img condition-affaibli"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_affaibli.png"
                />
              </button>
              <input type="hidden" class="condition-aveugle" name="attr_condition_aveugle" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_aveugle-icon"
                title="Aveuglé"
              ><img
                class="bubble-img condition-aveugle"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_aveugle.png"
                />
              </button>
              <input type="hidden" class="condition-essoufle" name="attr_condition_essoufle" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_essoufle-icon"
                title="Essouflé"
              ><img
                class="bubble-img condition-essoufle"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_essoufle.png"
                />
              </button>
<!-- 
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_effraye"
                title="Effrayé"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_effraye.png"
                />
              </button>
-->
              <input type="hidden" class="condition-etourdi" name="attr_condition_etourdi" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_etourdi-icon"
                title="Etourdi"
              ><img
                class="bubble-img condition-etourdi"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_etourdi.png"
                />
              </button>
              <input type="hidden" class="condition-immobilise" name="attr_condition_immobilise" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_immobilise-icon"
                title="Immobilisé"
              ><img
                class="bubble-img condition-immobilise" 
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_immobilise.png"
                />
              </button>
<!-- 
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_panique"
                title="Paniqué"
              ><img
                class="bubble-img"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_panique.png"
                />
              </button>
-->
              <br>
              
              <input type="hidden" class="condition-invalide" name="attr_condition_invalide" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_invalide-icon"
                title="Invalide"
              ><img
                class="bubble-img condition-invalide"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_invalide.png"
                />
              </button>
              <input type="hidden" class="condition-paralyse" name="attr_condition_paralyse" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_paralyse-icon"
                title="Paralysé"
              ><img
                class="bubble-img condition-paralyse"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_paralyse.png"
                />
              </button>
              <input type="hidden" class="condition-ralenti" name="attr_condition_ralenti" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_ralenti-icon"
                title="Ralenti"
              ><img
                class="bubble-img condition-ralenti"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_ralenti.png"
                />
              </button>
              <input type="hidden" class="condition-renverse" name="attr_condition_renverse" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_renverse-icon"
                title="Renversé"
              ><img
                class="bubble-img condition-renverse"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_renverse.png"
                />
              </button>                
              <input type="hidden" class="condition-surpris" name="attr_condition_surpris" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_surpris-icon"
                title="Surpris"
              ><img
                class="bubble-img condition-surpris"
                src="https://raw.githubusercontent.com/stephaned68/COF2e/main/cond_surpris.png"
                />
              </button>

            </div>
          </div>

          <div class="defenses">

            <div class="defense">
              <div><strong>DEFENSE</strong></div>
              <div></div>
              <div class="centered">
                Armure
                <input type="checkbox" name="attr_armure_eqp" title="@{armure_eqp} Armure équipée" value="1">
              </div>
              <div class="centered">
                Bouclier
                <input type="checkbox" name="attr_bouclier_eqp" title="@{bouclier_eqp} Bouclier équipé" value="1">
              </div>
              <div class="centered"><span name="attr_def_car" title="@{def_car} Caractéristique"></span></div>
              <div class="centered">Div.</div>
              <div class="centered">Action défensive</div>
              <div class="centered"><strong>Score</strong></div>
            </div>

            <div class="defense">
              <div class="block-title">DEF</div>
              <div class="bordered centered"><span name="attr_def_base"></span>+</div>
              <div class="bordered centered">
                <input type="number" name="attr_armure" title="@{armure} Bonus d'armure" value="0">
              </div>
              <div class="bordered centered">
                <input type="number" name="attr_bouclier" title="@{bouclier} Bonus de bouclier" value="0">
              </div>
              <div class="bordered centered">
                <span name="attr_def_car_bonus" title="@{def_car_bonus} Bonus de caractéristique"></span> <!--
                <select class="select-sm" name="attr_def_car" title="@{def_car} AGI/CON">
                  <option value="agi" selected>AGI</option>
                  <option value="con">CON</option>
                </select> -->
              </div>
              <div class="bordered centered">
                <span name="attr_def_buff" title="@{def_buff} Bonus divers"></span>
              </div>
              <div class="bordered centered">
                <select class="select-md" name="attr_def_action" title="@{def_action} Action défensive">
                  <option value="">-</option>
                  <option value="3">Partielle (A)</option>
                  <option value="5">Totale (L)</option>
                </select>
              </div>
              <div class="bordered centered">
                <input type="hidden" name="attr_def" value="10">
                <span name="attr_def" title="@{def} Défense"></span>
              </div>
            </div>

            <div class="defense">
              <div class="centered">
                <strong>Malus</strong>
              </div>
              <div></div>
              <div class="bordered centered">
                <input type="number" name="attr_armure_malus" title="@{armure_malus} Malus d'armure" value="0">
              </div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
              <div></div>
            </div>

          </div>
  
        </div>

        <!-- PC & RD -->
        <div class="pc-luck-rd">

          <div class="luck">
            <div class="block-title">
              <button class="block-title" type="action" name="act_luck-btn">
                <span class="d20-btn">t</span>
                PC
              </button>
            </div>
            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_pc_max" value="0">
                <input type="number" name="attr_pc" title="@{pc} PC courants" value="0">
                &nbsp;/&nbsp;
                <span name="attr_pc_max" title="@{pc_max} PC maximum"></span>
                &nbsp;=&nbsp;
                <input type="number" name="attr_pc_base" title="@{pc_base} Base" value="2">
                &nbsp;+&nbsp;
                <span name="attr_cha" title="Score de CHArisme"></span>
                &nbsp;+&nbsp;
                <span name="attr_pc_buff" title="@{pc_buff} Bonus divers"></span>
              </div>
            </div>
          </div>

          <div class="dmred">
            <div class="block-title">RD</div>
            <div class="bordered">
              <input type="text" name="attr_rd" title="@{rd} Réduction des DM" value="">
            </div>
          </div>

        </div>

        <hr>

        <!-- Attaques & Armes -->
        <div class="pc-attacks">
          
          <div class="weapon">
            <div></div>
            <h4>
              ARME / SORT
              <button type="action" class="flat-btn img-btn" name="act_attacks_menu-btn" title="%{attacks_menu-btn} Menu des jets d'attaques">
                <span class="img-btn">l</span>
              </button>
            </h4>
            <h4>ATTAQUE</h4>
            <h4>CRIT.</h4>
            <h4>DM</h4>
            <h4>PORTEE</h4>
            <h4>SPECIAL</h4>
          </div>

          <fieldset class="repeating_armes">

            <div class="weapon">
              
              <div>
                <button type="action" class="flat-btn" name="act_attack-btn">
                  <span class="d20-btn">t</span>
                </button>
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="hidden" name="attr_arme-label" value="">
                <span class="align-self-center" name="attr_arme-label"></span>&nbsp;
                <input type="text" name="attr_arme-nom" title="@{arme-nom}" placeholder="Arme/attaque" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <select class="select-md" name="attr_arme-atk" title="@{arme-atk} Score d'attaque">
                  <option value="0">-</option>
                  <option value="atkcac" selected>CONTACT</option>
                  <option value="atktir">DISTANCE</option>
                  <option value="atkmag">MAGIE</option>
                </select>
                &nbsp;<span class="align-self-center">+</span>&nbsp;
                <input type="number" name="attr_arme-atkdiv" title="@{arme-atkdiv} Bonus divers" value="">
                <input type="hidden" name="attr_arme-buffatk" value="0">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="number" class="two-digits" name="attr_arme-crit" title="@{arme-crit} Seuil de Critique" value="20" min="2" max="20">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="checkbox" name="attr_arme-2m" title="@{arme-2m} Arme à deux mains" value="1">
                <input type="text" name="attr_arme-dm" title="@{arme-dm} Dé(s) de DM" placeholder="1d8, 2d6..." value="">
                <select class="select-xxs" name="attr_arme-dmtype" title="@{arme-dmtype} Type de dommages">
                  <optgroup label="Physiques">
                    <option disabled class="optgroup">
                      &nbsp;Physiques
                    </option>
                    <option value="contondants">C - Contondants</option>
                    <option value="perforants">P - Perforants</option>
                    <option value="poison">Po - Poison</option>
                    <option value="tranchants" selected>T - Tranchants</option>
                  </optgroup>
                  <optgroup label="Elementaires">
                    <option disabled class="optgroup">
                      &nbsp;Elémentaires
                    </option>
                    <option value="acide">A - Acide</option>
                    <option value="électricité">E - Electricité</option>
                    <option value="feu">Fe - Feu</option>
                    <option value="froid">Fr - Froid</option>
                  </optgroup>
                  <optgroup label="Autres">
                    <option disabled class="optgroup">
                      &nbsp;Autres
                    </option>
                    <option value="magiques">M - Magiques</option>
                  </optgroup>
                </select>
                &nbsp;<span class="align-self-center">+</span>&nbsp;
                <select class="select-md" name="attr_arme-bonus" title="@{arme-bonus} Bonus aux dommages">
                  <option value="0">-</option>
                  <optgroup label="Base">
                    <option class="optgroup" value="" disabled>&nbsp;Base</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{for}" selected>FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{int}">INT</option>
                    <option value="@{cha}">CHA</option>
                  </optgroup>
                  <optgroup label="Test">
                    <option class="optgroup" value="" disabled>&nbsp;Test</option>
                    <option value="@{agi_test}">AGI (t)</option>
                    <option value="@{for_test}">FOR (t)</option>
                    <option value="@{per_test}">PER (t)</option>
                    <option value="@{int_test}">INT (t)</option>
                    <option value="@{cha_test}">CHA (t)</option>
                  </optgroup>
                </select>
                &nbsp;<span class="align-self-center">+</span>&nbsp;
                <input type="number" name="attr_arme-dmdiv" title="@{arme-dmdiv} Bonus DM divers" value="0">
                <input type="hidden" name="attr_arme-buffdm" value="0">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-portee" title="@{arme-portee}" value="">
                <input type="hidden" name="attr_arme-portees" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-special" title="@{arme-special}" placeholder="Effet spécial..." value="">
                <button type="action" class="flat-btn img-btn float-right" name="act_armeopt-btn">
                  <span class="img-btn">y</span>
                </button>
              </div>

            </div>

            <input type="hidden" class="cof-wopt-toggle" name="attr_armeopt" value="0"/>
            <div class="weapon-opt">
              <div class="weapon-option">
                <div></div>
                <div class="bordered">
                  <select name="attr_arme-atktype" class="select-lg" title="@{arme-atktype} Type d'arme/attaque">
                    <option value="">Type d'attaque...</option>
                    <option value="naturel">Arme naturelle</option>
                    <option value="sort">Sortilège</option>
                    <option value="gauche">Arme main gauche</option>
                    <option value="jet">Arme de jet</option>
                  </select>
                </div>
                <div class="bordered">
                  <input type="text" name="attr_arme-atkmods" placeholder="Modificateurs d'attaque" title="@{arme-atkmods} Modificateurs séparés par des virgules&#10; deBonus: avec dé bonus&#10; deMalus: avec dé malus&#10; auto: réussite automatique&#10; choc: peut faire des attaques non léthales sans malus&#10; explodeMax: dés de dégâts explosifs&#10; pasDeDmg: l'attaque ne fait pas de DM&#10; poudre: arme à poudre&#10; reroll1: relance les 1 sur les dés de DM&#10; tempDmg: fait toujours des attaques non léthales" value="">
                </div>
                <div class="bordered">
                  <input type="text" name="attr_arme-options" placeholder="Options d'attaque avec argument" title="@{arme-options} Options d'attaque">
                </div>
              </div>
            </div>

          </fieldset>

          <hr>
          
          <div class="sheet-2colrow">
            
            <div class="sheet-col">
              <h4>Options Tactiques</h4>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="0" checked>
                  Aucune
                </div>
                <div>
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="1">
                  Attaque assurée
                </div>
                <div>
                  +5 en attaque et DM divisés par 2
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="2">
                  Att. précise/violente
                </div>
                <div>
                  -3 en attaque et +1d4° DM
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="3">
                  Att. précise/violente
                </div>
                <div>
                  -7 en attaque et +2d4° DM
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="4">
                  Autres bonus/malus
                </div>
                <div class="d-flex">
                  <input type="number" class="align-self-center" name="attr_tactdiv" value="0">
                  <span class="align-self-center">DM :&nbsp;</span>
                  <input type="text" class="w-auto align-self-center" name="attr_tactdmdiv" placeholder="DM supplémentaires" value="">
                </div>
              </div>

            </div>

            <div class="sheet-col">
              <h4>Modificateurs de situation</h4>

              <div class="pc-tactic">
                <div>Cible à couvert</div>
                <div>
                  <select class="select-md" name="attr_modsit_couvert" title="@{modsit_couvert} Mod. couvert">
                    <option value="0">Aucun</option>
                    <option value="2" title="Végétation">Faible (-2)</option>
                    <option value="5" title="Muraille">Fort (-5)</option>
                  </select>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Cible en pleine mêlée</div>
                <div>
                  <select class="select-md" name="attr_modsit_melee" title="@{modsit_melee} Mod. en mêlée">
                    <option value="0">Non</option>
                    <option value="2" title="">Oui (-2)</option>
                    <option value="5" title="Masquée par un allié">Masquée (-5)</option>
                  </select>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Tireur</div>
                <div>
                  <input type="checkbox" name="attr_modsit_contact" title="@{modsit_contact} Mod. au contact" value="1">
                  <span>&nbsp;Au contact d'un adversaire</span>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Visibilité</div>
                <div>
                  <input type="checkbox" name="attr_modsit_visibilite" title="@{modsit_visibilite} Mod. de visibilité" value="5">
                  <span>&nbsp;Brouillard / Pénombre</span>
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Capacités -->
      <div class="pc-abilities-tab">

        <input type="checkbox" class="block-switch" name="attr_abilities_edit" value="1">
        
        <!-- Fiche PJ, Onglet Capacités, Mode Affichage -->
        <div class="abilities-view">
          <div class="d-flex d-flex-between">
            <div>
              <h3>
                CAPACITES
              </h3>
            </div>
            <div class="change-view">
              <button type="action" class="flat-btn img-btn" name="act_abilities_menu-btn" title="%{abilities_menu-btn} Menu des voies et capacités">
                <span class="img-btn">l</span>
              </button>
              <button type="action" class="flat-btn img-btn" name="act_reset_uses-btn" title="Ré-initialiser l'usage des capacités">
                <span class="img-btn">t</span>
              </button>
              Editer <input type="checkbox" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <!-- Voie 1 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie1nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie1_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r1" title="@{v1r1}" value="1">
                      <span class="rank-title" name="attr_voie1-t1"></span>
                      <button type="action" class="flat-btn" name="act_v1r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-1" title="@{voie1-1}"></span>
                  <br>
                  <input type="number" name="attr_v1r1_use" title="@{v1r1_use} Utilisations">
                  / <span name="attr_v1r1_use_max" title="@{v1r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r1_freq" title="@{v1r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r2" title="@{v1r2}" value="1">
                      <span class="rank-title" name="attr_voie1-t2"></span>
                      <button type="action" class="flat-btn" name="act_v1r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-2" title="@{voie1-2}"></span>
                  <br>
                  <input type="number" name="attr_v1r2_use" title="@{v1r2_use} Utilisations">
                  / <span name="attr_v1r2_use_max" title="@{v1r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r2_freq" title="@{v1r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->  
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r3" title="@{v1r3}" value="1">
                      <span class="rank-title" name="attr_voie1-t3"></span>
                      <button type="action" class="flat-btn" name="act_v1r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-3" title="@{voie1-3}"></span>
                  <br>
                  <input type="number" name="attr_v1r3_use" title="@{v1r3_use} Utilisations">
                  / <span name="attr_v1r3_use_max" title="@{v1r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r3_freq" title="@{v1r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r4" title="@{v1r4}" value="1">
                      <span class="rank-title" name="attr_voie1-t4"></span>
                      <button type="action" class="flat-btn" name="act_v1r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-4" title="@{voie1-4}"></span>
                  <br>
                  <input type="number" name="attr_v1r4_use" title="@{v1r4_use} Utilisations" >
                  / <span name="attr_v1r4_use_max" title="@{v1r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r4_freq" title="@{v1r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r5" title="@{v1r5}" value="1">
                      <span class="rank-title" name="attr_voie1-t5"></span>
                      <button type="action" class="flat-btn" name="act_v1r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-5" title="@{voie1-5}"></span>
                  <br>
                  <input type="number" name="attr_v1r5_use" title="@{v1r5_use} Utilisations" >
                  / <span name="attr_v1r5_use_max" title="@{v1r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r5_freq" title="@{v1r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 2 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie2nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie2_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r1" title="@{v2r1}" value="1">
                      <span class="rank-title" name="attr_voie2-t1"></span>
                      <button type="action" class="flat-btn" name="act_v2r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-1" title="@{voie2-1}"></span>
                  <br>
                  <input type="number" name="attr_v2r1_use" title="@{v2r1_use} Utilisations" >
                  / <span name="attr_v2r1_use_max" title="@{v2r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r1_freq" title="@{v2r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r2" title="@{v2r2}" value="1">
                      <span class="rank-title" name="attr_voie2-t2"></span>
                      <button type="action" class="flat-btn" name="act_v2r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-2" title="@{voie2-2}"></span>
                  <br>
                  <input type="number" name="attr_v2r2_use" title="@{v2r2_use} Utilisations" >
                  / <span name="attr_v2r2_use_max" title="@{v2r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r2_freq" title="@{v2r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r3" title="@{v2r3}" value="1">
                      <span class="rank-title" name="attr_voie2-t3"></span>
                      <button type="action" class="flat-btn" name="act_v2r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-3" title="@{voie2-3}"></span>
                  <br>
                  <input type="number" name="attr_v2r3_use" title="@{v2r3_use} Utilisations" >
                  / <span name="attr_v2r3_use_max" title="@{v2r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r3_freq" title="@{v2r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r4" title="@{v2r4}" value="1">
                      <span class="rank-title" name="attr_voie2-t4"></span>
                      <button type="action" class="flat-btn" name="act_v2r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-4" title="@{voie2-4}"></span>
                  <br>
                  <input type="number" name="attr_v2r4_use" title="@{v2r4_use} Utilisations" >
                  / <span name="attr_v2r4_use_max" title="@{v2r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r4_freq" title="@{v2r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r5" title="@{v2r5}" value="1">
                      <span class="rank-title" name="attr_voie2-t5"></span>
                      <button type="action" class="flat-btn" name="act_v2r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-5" title="@{voie2-5}"></span>
                  <br>
                  <input type="number" name="attr_v2r5_use" title="@{v2r5_use} Utilisations" >
                  / <span name="attr_v2r5_use_max" title="@{v2r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r5_freq" title="@{v2r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 3 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie3nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie3_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r1" title="@{v3r1}" value="1">
                      <span class="rank-title" name="attr_voie3-t1"></span>
                      <button type="action" class="flat-btn" name="act_v3r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-1" title="@{voie3-1}"></span>
                  <br>
                  <input type="number" name="attr_v3r1_use" title="@{v3r1_use} Utilisations" >
                  / <span name="attr_v3r1_use_max" title="@{v3r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r2" title="@{v3r2}" value="1">
                      <span class="rank-title" name="attr_voie3-t2"></span>
                      <button type="action" class="flat-btn" name="act_v3r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-2" title="@{voie3-2}"></span>
                  <br>
                  <input type="number" name="attr_v3r2_use" title="@{v3r2_use} Utilisations" >
                  / <span name="attr_v3r2_use_max" title="@{v3r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r2_freq" title="@{v3r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r3" title="@{v3r3}" value="1">
                      <span class="rank-title" name="attr_voie3-t3"></span>
                      <button type="action" class="flat-btn" name="act_v3r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-3" title="@{voie3-3}"></span>
                  <br>
                  <input type="number" name="attr_v3r3_use" title="@{v3r3_use} Utilisations" >
                  / <span name="attr_v3r3_use_max" title="@{v3r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r3_freq" title="@{v3r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r4" title="@{v3r4}" value="1">
                      <span class="rank-title" name="attr_voie3-t4"></span>
                      <button type="action" class="flat-btn" name="act_v3r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-4" title="@{voie3-4}"></span>
                  <br>
                  <input type="number" name="attr_v3r4_use" title="@{v3r4_use} Utilisations" >
                  / <span name="attr_v3r4_use_max" title="@{v3r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r5" title="@{v3r5}" value="1">
                      <span class="rank-title" name="attr_voie3-t5"></span>
                      <button type="action" class="flat-btn" name="act_v3r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-5" title="@{voie3-5}"></span>
                  <br>
                  <input type="number" name="attr_v3r5_use" title="@{v3r5_use} Utilisations" >
                  / <span name="attr_v3r5_use_max" title="@{v3r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r5_freq" title="@{v3r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
          </div>
  
          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <div class="abilities">
            <!-- Voie 4 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie4nom" title="@{voie4nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie4_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r1" title="@{v4r1}" value="1">
                      <span class="rank-title" name="attr_voie4-t1"></span>
                      <button type="action" class="flat-btn" name="act_v4r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-1" title="@{voie4-1}"></span>
                  <br>
                  <input type="number" name="attr_v4r1_use" title="@{v4r1_use} Utilisations" >
                  / <span name="attr_v4r1_use_max" title="@{v4r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r1_freq" title="@{v4r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r2" title="@{v4r2}" value="1">
                      <span class="rank-title" name="attr_voie4-t2"></span>
                      <button type="action" class="flat-btn" name="act_v4r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-2" title="@{voie4-2}"></span>
                  <br>
                  <input type="number" name="attr_v4r2_use" title="@{v4r2_use} Utilisations" >
                  / <span name="attr_v4r2_use_max" title="@{v4r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r2_freq" title="@{v4r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r3" title="@{v4r3}" value="1">
                      <span class="rank-title" name="attr_voie4-t3"></span>
                      <button type="action" class="flat-btn" name="act_v4r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-3" title="@{voie4-3}"></span>
                  <br>
                  <input type="number" name="attr_v4r3_use" title="@{v4r3_use} Utilisations" >
                  / <span name="attr_v4r3_use_max" title="@{v4r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r3_freq" title="@{v4r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r4" title="@{v4r4}" value="1">
                      <span class="rank-title" name="attr_voie4-t4"></span>
                      <button type="action" class="flat-btn" name="act_v4r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-4" title="@{voie4-4}"></span>
                  <br>
                  <input type="number" name="attr_v4r4_use" title="@{v4r4_use} Utilisations" >
                  / <span name="attr_v4r4_use_max" title="@{v4r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r4_freq" title="@{v4r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r5" title="@{v4r5}" value="1">
                      <span class="rank-title" name="attr_voie4-t5"></span>
                      <button type="action" class="flat-btn" name="act_v4r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-5" title="@{voie4-5}"></span>
                  <br>
                  <input type="number" name="attr_v4r5_use" title="@{v4r5_use} Utilisations" >
                  / <span name="attr_v4r5_use_max" title="@{v4r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r5_freq" title="@{v4r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 5 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie5nom" title="@{voie5nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie5_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r1" title="@{v5r1}" value="1">
                      <span class="rank-title" name="attr_voie5-t1"></span>
                      <button type="action" class="flat-btn" name="act_v5r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-1" title="@{voie5-1}"></span>
                  <br>
                  <input type="number" name="attr_v5r1_use" title="@{v5r1_use} Utilisations" >
                  / <span name="attr_v5r1_use_max" title="@{v5r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r1_freq" title="@{v5r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r2" title="@{v5r2}" value="1">
                      <span class="rank-title" name="attr_voie5-t2"></span>
                      <button type="action" class="flat-btn" name="act_v5r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-2" title="@{voie5-2}"></span>
                  <br>
                  <input type="number" name="attr_v5r2_use" title="@{v5r2_use} Utilisations" >
                  / <span name="attr_v5r2_use_max" title="@{v5r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r2_freq" title="@{v5r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r3" title="@{v5r3}" value="1">
                      <span class="rank-title" name="attr_voie5-t3"></span>
                      <button type="action" class="flat-btn" name="act_v5r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-3" title="@{voie5-3}"></span>
                  <br>
                  <input type="number" name="attr_v5r3_use" title="@{v5r3_use} Utilisations" >
                  / <span name="attr_v5r3_use_max" title="@{v5r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r3_freq" title="@{v5r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r4" title="@{v5r4}" value="1">
                      <span class="rank-title" name="attr_voie5-t4"></span>
                      <button type="action" class="flat-btn" name="act_v5r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-4" title="@{voie5-4}"></span>
                  <br>
                  <input type="number" name="attr_v5r4_use" title="@{v5r4_use} Utilisations" >
                  / <span name="attr_v5r4_use_max" title="@{v5r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r4_freq" title="@{v5r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r5" title="@{v5r5}" value="1">
                      <span class="rank-title" name="attr_voie5-t5"></span>
                      <button type="action" class="flat-btn" name="act_v5r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-5" title="@{voie5-5}"></span>
                  <br>
                  <input type="number" name="attr_v5r5_use" title="@{v5r5_use} Utilisations" >
                  / <span name="attr_v5r5_use_max" title="@{v5r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r5_freq" title="@{v5r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 6 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie6nom" title="@{voie6nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie6_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r1" title="@{v6r1}" value="1">
                      <span class="rank-title" name="attr_voie6-t1"></span>
                      <button type="action" class="flat-btn" name="act_v6r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-1" title="@{voie6-1}"></span>
                  <br>
                  <input type="number" name="attr_v6r1_use" title="@{v6r1_use} Utilisations" >
                  / <span name="attr_v6r1_use_max" title="@{v6r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r1_freq" title="@{v6r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r2" title="@{v6r2}" value="1">
                      <span class="rank-title" name="attr_voie6-t2"></span>
                      <button type="action" class="flat-btn" name="act_v6r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-2" title="@{voie6-2}"></span>
                  <br>
                  <input type="number" name="attr_v6r2_use" title="@{v6r2_use} Utilisations" >
                  / <span name="attr_v6r2_use_max" title="@{v6r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r2_freq" title="@{v6r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r3" title="@{v6r3}" value="1">
                      <span class="rank-title" name="attr_voie6-t3"></span>
                      <button type="action" class="flat-btn" name="act_v6r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-3" title="@{voie6-3}"></span>
                  <br>
                  <input type="number" name="attr_v6r3_use" title="@{v6r3_use} Utilisations" >
                  / <span name="attr_v6r3_use_max" title="@{v6r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r3_freq" title="@{v6r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r4" title="@{v6r4}" value="1">
                      <span class="rank-title" name="attr_voie6-t4"></span>
                      <button type="action" class="flat-btn" name="act_v6r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-4" title="@{voie6-4}"></span>
                  <br>
                  <input type="number" name="attr_v6r4_use" title="@{v6r4_use} Utilisations" >
                  / <span name="attr_v6r4_use_max" title="@{v6r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r4_freq" title="@{v6r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r5" title="@{v6r5}" value="1">
                      <span class="rank-title" name="attr_voie6-t5"></span>
                      <button type="action" class="flat-btn" name="act_v6r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-5" title="@{voie6-5}"></span>
                  <br>
                  <input type="number" name="attr_v6r5_use" title="@{v6r5_use} Utilisations" >
                  / <span name="attr_v6r5_use_max" title="@{v6r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <input type="hidden" class="show-paths-789" name="attr_voies_789" value="0">
          <div class="abilities">
            <!-- Voie 7 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie7nom" title="@{voie7nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie7_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r1" title="@{v7r1}" value="1">
                      <span class="rank-title" name="attr_voie7-t1"></span>
                      <button type="action" class="flat-btn" name="act_v7r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-1" title="@{voie7-1}"></span>
                  <br>
                  <input type="number" name="attr_v7r1_use" title="@{v7r1_use} Utilisations" >
                  / <span name="attr_v7r1_use_max" title="@{v7r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r1_freq" title="@{v7r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r2" title="@{v7r2}" value="1">
                      <span class="rank-title" name="attr_voie7-t2"></span>
                      <button type="action" class="flat-btn" name="act_v7r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-2" title="@{voie7-2}"></span>
                  <br>
                  <input type="number" name="attr_v7r2_use" title="@{v7r2_use} Utilisations" >
                  / <span name="attr_v7r2_use_max" title="@{v7r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r2_freq" title="@{v7r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r3" title="@{v7r3}" value="1">
                      <span class="rank-title" name="attr_voie7-t3"></span>
                      <button type="action" class="flat-btn" name="act_v7r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-3" title="@{voie7-3}"></span>
                  <br>
                  <input type="number" name="attr_v7r3_use" title="@{v7r3_use} Utilisations" >
                  / <span name="attr_v7r3_use_max" title="@{v7r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r3_freq" title="@{v7r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r4" title="@{v7r4}" value="1">
                      <span class="rank-title" name="attr_voie7-t4"></span>
                      <button type="action" class="flat-btn" name="act_v7r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-4" title="@{voie7-4}"></span>
                  <br>
                  <input type="number" name="attr_v7r4_use" title="@{v7r4_use} Utilisations" >
                  / <span name="attr_v7r4_use_max" title="@{v7r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r4_freq" title="@{v7r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r5" title="@{v7r5}" value="1">
                      <span class="rank-title" name="attr_voie7-t5"></span>
                      <button type="action" class="flat-btn" name="act_v7r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-5" title="@{voie7-5}"></span>
                  <br>
                  <input type="number" name="attr_v7r5_use" title="@{v7r5_use} Utilisations" >
                  / <span name="attr_v7r5_use_max" title="@{v7r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r5_freq" title="@{v7r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 8 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie8nom" title="@{voie8nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie8_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r1" title="@{v8r1}" value="1">
                      <span class="rank-title" name="attr_voie8-t1"></span>
                      <button type="action" class="flat-btn" name="act_v8r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-1" title="@{voie8-1}"></span>
                  <br>
                  <input type="number" name="attr_v8r1_use" title="@{v8r1_use} Utilisations" >
                  / <span name="attr_v8r1_use_max" title="@{v8r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r1_freq" title="@{v8r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r2" title="@{v8r2}" value="1">
                      <span class="rank-title" name="attr_voie8-t2"></span>
                      <button type="action" class="flat-btn" name="act_v8r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-2" title="@{voie8-2}"></span>
                  <br>
                  <input type="number" name="attr_v8r2_use" title="@{v8r2_use} Utilisations" >
                  / <span name="attr_v8r2_use_max" title="@{v8r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r2_freq" title="@{v8r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r3" title="@{v8r3}" value="1">
                      <span class="rank-title" name="attr_voie8-t3"></span>
                      <button type="action" class="flat-btn" name="act_v8r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-3" title="@{voie8-3}"></span>
                  <br>
                  <input type="number" name="attr_v8r3_use" title="@{v8r3_use} Utilisations" >
                  / <span name="attr_v8r3_use_max" title="@{v8r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r3_freq" title="@{v8r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r4" title="@{v8r4}" value="1">
                      <span class="rank-title" name="attr_voie8-t4"></span>
                      <button type="action" class="flat-btn" name="act_v8r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-4" title="@{voie8-4}"></span>
                  <br>
                  <input type="number" name="attr_v8r4_use" title="@{v8r4_use} Utilisations" >
                  / <span name="attr_v8r4_use_max" title="@{v8r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r4_freq" title="@{v8r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r5" title="@{v8r5}" value="1">
                      <span class="rank-title" name="attr_voie8-t5"></span>
                      <button type="action" class="flat-btn" name="act_v8r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-5" title="@{voie8-5}"></span>
                  <br>
                  <input type="number" name="attr_v8r5_use" title="@{v8r5_use} Utilisations" >
                  / <span name="attr_v8r5_use_max" title="@{v8r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r5_freq" title="@{v8r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
            <!-- Voie 9 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie9nom" title="@{voie9nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie9_menu-btn"></button>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r1" title="@{v9r1}" value="1">
                      <span class="rank-title" name="attr_voie9-t1"></span>
                      <button type="action" class="flat-btn" name="act_v9r1-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-1" title="@{voie9-1}"></span>
                  <br>
                  <input type="number" name="attr_v9r1_use" title="@{v9r1_use} Utilisations" >
                  / <span name="attr_v9r1_use_max" title="@{v9r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r1_freq" title="@{v9r1_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r2" title="@{v9r2}" value="1">
                      <span class="rank-title" name="attr_voie9-t2"></span>
                      <button type="action" class="flat-btn" name="act_v9r2-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-2" title="@{voie9-2}"></span>
                  <br>
                  <input type="number" name="attr_v9r2_use" title="@{v9r2_use} Utilisations" >
                  / <span name="attr_v9r2_use_max" title="@{v9r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r2_freq" title="@{v9r2_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r3" title="@{v9r3}" value="1">
                      <span class="rank-title" name="attr_voie9-t3"></span>
                      <button type="action" class="flat-btn" name="act_v9r3-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-3" title="@{voie9-3}"></span>
                  <br>
                  <input type="number" name="attr_v9r3_use" title="@{v9r3_use} Utilisations" >
                  / <span name="attr_v9r3_use_max" title="@{v9r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r3_freq" title="@{v9r3_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r4" title="@{v9r4}" value="1">
                      <span class="rank-title" name="attr_voie9-t4"></span>
                      <button type="action" class="flat-btn" name="act_v9r4-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-4" title="@{voie9-4}"></span>
                  <br>
                  <input type="number" name="attr_v9r4_use" title="@{v9r4_use} Utilisations" >
                  / <span name="attr_v9r4_use_max" title="@{v9r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r4_freq" title="@{v9r4_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r5" title="@{v9r5}" value="1">
                      <span class="rank-title" name="attr_voie9-t5"></span>
                      <button type="action" class="flat-btn" name="act_v9r5-btn">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-5" title="@{voie9-5}"></span>
                  <br>
                  <input type="number" name="attr_v9r5_use" title="@{v9r5_use} Utilisations" >
                  / <span name="attr_v9r5_use_max" title="@{v9r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r5_freq" title="@{v9r5_freq} Fréquence d'utilisation" ></span>
                </details>
              </div>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Capacités, Mode Edition -->
        <div class="abilities-edit">
          <div class="d-flex d-flex-between">
            <div>
              <h3>CAPACITES</h3>
            </div>
            <div class="change-view">
              Afficher <input type="checkbox" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">1 - Voie de peuple</div>
              <div class="path-title">
                <input type="text" name="attr_voie1nom" title="@{voie1nom}" value="1 - Voie de peuple">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t1" title="@{voie1-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r1_spell" title="@{v1r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-1" title="@{voie1-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r1_use_max" title="@{v1r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v1r1_freq" title="@{v1r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t2" title="@{voie1-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r2_spell" title="@{v1r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-2" title="@{voie1-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r2_use_max" title="@{v1r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v1r2_freq" title="@{v1r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t3" title="@{voie1-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r3_spell" title="@{v1r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-3" title="@{voie1-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r3_use_max" title="@{v1r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v1r3_freq" title="@{v1r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t4" title="@{voie1-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r4_spell" title="@{v1r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-4" title="@{voie1-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r4_use_max" title="@{v1r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v1r4_freq" title="@{v1r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t5" title="@{voie1-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r5_spell" title="@{v1r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-5" title="@{voie1-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r5_use_max" title="@{v1r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v1r5_freq" title="@{v1r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">2 - Voie de profil</div>
              <div class="path-title">
                <input type="text" name="attr_voie2nom" title="@{voie2nom}" value="2 - Voie de profil">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t1" title="@{voie2-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r1_spell" title="@{v2r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-1" title="@{voie2-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r1_use_max" title="@{v2r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v2r1_freq" title="@{v2r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t2" title="@{voie2-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r2_spell" title="@{v2r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-2" title="@{voie2-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r2_use_max" title="@{v2r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v2r2_freq" title="@{v2r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t3" title="@{voie2-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r3_spell" title="@{v2r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-3" title="@{voie2-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r3_use_max" title="@{v2r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v2r3_freq" title="@{v2r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t4" title="@{voie2-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r4_spell" title="@{v2r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-4" title="@{voie2-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r4_use_max" title="@{v2r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v2r4_freq" title="@{v2r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t5" title="@{voie2-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r5_spell" title="@{v2r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-5" title="@{voie2-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r5_use_max" title="@{v2r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v2r5_freq" title="@{v2r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">3 - Voie de profil</div>
              <div class="path-title">
                <input type="text" name="attr_voie3nom" title="@{voie3nom}" value="3 - Voie de profil">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t1" title="@{voie3-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r1_spell" title="@{v3r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-1" title="@{voie3-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r1_use_max" title="@{v3r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t2" title="@{voie3-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r2_spell" title="@{v3r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-2" title="@{voie3-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r2_use_max" title="@{v3r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v3r2_freq" title="@{v3r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t3" title="@{voie3-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r3_spell" title="@{v3r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-3" title="@{voie3-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r3_use_max" title="@{v3r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v3r3_freq" title="@{v3r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t4" title="@{voie3-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r4_spell" title="@{v3r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-4" title="@{voie3-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r4_use_max" title="@{v3r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v3r4_freq" title="@{v3r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t5" title="@{voie3-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r5_spell" title="@{v3r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-5" title="@{voie3-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r5_use_max" title="@{v3r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v3r5_freq" title="@{v3r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">4 - Voie de profil</div>
              <div class="path-title">
                <input type="text" name="attr_voie4nom" title="@{voie4nom}" value="4 - Voie de profil">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t1" title="@{voie4-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r1_spell" title="@{v4r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-1" title="@{voie4-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r1_use_max" title="@{v4r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v4r1_freq" title="@{v4r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t2" title="@{voie4-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r2_spell" title="@{v4r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-2" title="@{voie4-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r2_use_max" title="@{v4r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v4r2_freq" title="@{v4r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-fle">
                  <input type="text" name="attr_voie4-t3" title="@{voie4-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r3_spell" title="@{v4r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-3" title="@{voie4-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r3_use_max" title="@{v4r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v4r3_freq" title="@{v4r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t4" title="@{voie4-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r4_spell" title="@{v4r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-4" title="@{voie4-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r4_use_max" title="@{v4r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v4r4_freq" title="@{v4r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t5" title="@{voie4-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r5_spell" title="@{v4r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-5" title="@{voie4-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r5_use_max" title="@{v4r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v4r5_freq" title="@{v4r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">5 - Voie de profil</div>
              <div class="path-title">
                <input type="text" name="attr_voie5nom" title="@{voie5nom}" value="5 - Voie de profil">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t1" title="@{voie5-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r1_spell" title="@{v5r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-1" title="@{voie5-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r1_use_max" title="@{v5r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v5r1_freq" title="@{v5r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t2" title="@{voie5-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r2_spell" title="@{v5r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-2" title="@{voie5-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r2_use_max" title="@{v5r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v5r2_freq" title="@{v5r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t3" title="@{voie5-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r3_spell" title="@{v5r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-3" title="@{voie5-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r3_use_max" title="@{v5r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v5r3_freq" title="@{v5r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t4" title="@{voie5-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r4_spell" title="@{v5r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-4" title="@{voie5-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r4_use_max" title="@{v5r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v5r4_freq" title="@{v5r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t5" title="@{voie5-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r5_spell" title="@{v5r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-5" title="@{voie5-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r5_use_max" title="@{v5r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v5r5_freq" title="@{v5r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">6 - Voie de profil</div>
              <div class="path-title">
                <input type="text" name="attr_voie6nom" title="@{voie6nom}" value="6 - Voie de profil">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t1" title="@{voie6-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r1_spell" title="@{v6r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-1" title="@{voie6-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r1_use_max" title="@{v6r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v6r1_freq" title="@{v6r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t2" title="@{voie6-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r2_spell" title="@{v6r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-2" title="@{voie6-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r2_use_max" title="@{v6r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v6r2_freq" title="@{v6r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t3" title="@{voie6-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r3_spell" title="@{v6r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-3" title="@{voie6-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r3_use_max" title="@{v6r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v6r3_freq" title="@{v6r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t4" title="@{voie6-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r4_spell" title="@{v6r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-4" title="@{voie6-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r4_use_max" title="@{v6r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v6r4_freq" title="@{v6r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t5" title="@{voie6-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r5_spell" title="@{v6r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-5" title="@{voie6-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r5_use_max" title="@{v6r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v6r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <div class="abilities">
            <div class="path">
              <div class="block-title">7 - Voie de prestige 1</div>
              <div class="path-title">
                <input type="text" name="attr_voie7nom" title="@{voie7nom}" value="7 - Voie de prestige 1">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t1" title="@{voie7-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r1_spell" title="@{v7r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-1" title="@{voie7-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r1_use_max" title="@{v7r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v7r1_freq" title="@{v7r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t2" title="@{voie7-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r2_spell" title="@{v7r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-2" title="@{voie7-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r2_use_max" title="@{v7r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v7r2_freq" title="@{v7r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t3" title="@{voie7-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r3_spell" title="@{v7r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-3" title="@{voie7-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r3_use_max" title="@{v7r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v7r3_freq" title="@{v7r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t4" title="@{voie7-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r4_spell" title="@{v7r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-4" title="@{voie7-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r4_use_max" title="@{v7r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v7r4_freq" title="@{v7r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t5" title="@{voie7-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r5_spell" title="@{v7r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-5" title="@{voie7-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r5_use_max" title="@{v7r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v7r5_freq" title="@{v7r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path">
              <div class="block-title">8 - Voie de prestige 2</div>
              <div class="path-title">
                <input type="text" name="attr_voie8nom" title="@{voie8nom}" value="8 - Voie de prestige 2">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t1" title="@{voie8-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r1_spell" title="@{v8r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-1" title="@{voie8-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r1_use_max" title="@{v8r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v8r1_freq" title="@{v8r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t2" title="@{voie8-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r2_spell" title="@{v8r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-2" title="@{voie8-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r2_use_max" title="@{v8r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v8r2_freq" title="@{v8r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t3" title="@{voie8-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r3_spell" title="@{v8r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-3" title="@{voie8-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r3_use_max" title="@{v8r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v8r3_freq" title="@{v8r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t4" title="@{voie8-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r4_spell" title="@{v8r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-4" title="@{voie8-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r4_use_max" title="@{v8r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v8r4_freq" title="@{v8r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t5" title="@{voie8-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r5_spell" title="@{v8r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-5" title="@{voie8-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r5_use_max" title="@{v8r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v8r5_freq" title="@{v8r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
            <div class="path">
              <div class="block-title">Voie n°9</div>
              <div class="path-title">
                <input type="text" name="attr_voie9nom" title="@{voie9nom}" value="Voie n°9">
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t1" title="@{voie9-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r1_spell" title="@{v9r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-1" title="@{voie9-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r1_use_max" title="@{v9r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v9r1_freq" title="@{v9r1_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t2" title="@{voie9-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r2_spell" title="@{v9r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-2" title="@{voie9-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r2_use_max" title="@{v9r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v9r2_freq" title="@{v9r2_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t3" title="@{voie9-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r3_spell" title="@{v9r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-3" title="@{voie9-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r3_use_max" title="@{v9r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v9r3_freq" title="@{v9r3_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t4" title="@{voie9-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r4_spell" title="@{v9r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-4" title="@{voie9-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r4_use_max" title="@{v9r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v9r4_freq" title="@{v9r4_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t5" title="@{voie9-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r5_spell" title="@{v9r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-5" title="@{voie9-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r5_use_max" title="@{v9r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text"  name="attr_v9r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" value="">
                </div>
              </div>
            </div>
          </div>

        </div>

        <hr>

        <details>
          <summary>Langues maîtrisées, Autres capacités</summary>
          <div class="sheet-3colrow">
            <div class="sheet-col">
              <div>
                <input type="checkbox" name="attr_lang_abyssal">
                <span title="Démons, élémentaires du feu">Abyssal</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_aquarien">
                <span title="Créatures sous-marines, élementaires de l'eau">Aquarien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_argotien">
                <span title="Argot des voleurs et langue des signes">Argotien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_Runique">
                <span title="Anges, créatures des plans supérieurs, élémentaires de l'air">Célestien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_commun">
                <span title="Humains, halfelins">Commun</span>
              </div>
            </div>
            <div class="sheet-col">
              <div>
                <input type="checkbox" name="attr_lang_draconique">
                <span title="Dragons, kobolds, hommes-lézards">Draconique</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_noirparle">
                <span title="Goblinoïdes, orcs, ogres, trolls, créatures maléfiques">Noir parlé</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_profond">
                <span title="Créatures souterraines (elfes des profondeurs)">Profond</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_runique">
                <span title="Gnomes, nains, géants, élémentaires de la terre">Runique</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_sylvestre">
                <span title="Elfes, fées, dryandes, sylvaniens">Sylvestre</span>
              </div>
            </div>
            <div class="sheet-col">
              <textarea name="attr_autres" class="medium" placeholder="Autres capacités"></textarea>
            </div>
          </div>
        </details>

        <!-- Fiche PJ, Onglet Capacités, Sous-onglets -->
        <input type="hidden" class="tabs-toggle" name="attr_pc_subtab" value="rolls" />
        <div class="pc-subtabs">
          <button type="action" name="act_pc_rolls-btn" class="sub-tab tab-btn pc-rolls-btn">JETS</button>
          <input type="hidden" class="pc-skills-btn" name="attr_use_skills" value="0">
          <button type="action" name="act_pc_skills-btn" class="sub-tab tab-btn pc-skills-btn">COMPETENCES</button>
          <button type="action" name="act_pc_buffs-btn" class="sub-tab tab-btn pc-buffs-btn">BUFFS</button>
        </div>
        
        <hr>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Jets -->
        <div class="pc-rolls-subtab">
          
          <div class="pc-roll-r1">
            <div>&nbsp;</div>
            <h4>
              Nom
              <button type="action" class="flat-btn img-btn" name="act_rolls_menu-btn" title="%{rolls_menu-btn} Menu des jets de capacités">
                <span class="img-btn">l</span>
              </button>
            </h4>
            <h4>Capacité / Compétence</h4>
            <h4>Description / Jet spécial</h4>
          </div>

          <fieldset class="repeating_rolls">

            <div class="pc-roll-r1">

              <div>
                <button class="flat-btn" type="action" name="act_roll-btn">
                  <span class="d20-btn">t</span>
                </button>
              </div>

              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_roll-nom" title="@{roll-nom} Nom du jet ou compétence" placeholder="Nom du jet" value="">
              </div>

              <div class="d-flex d-flex-middle bordered">
                <select class="select-xs" name="attr_roll-type" title="@{roll-type} Type de jet">
                  <option value="1d20" selected>No - Normal</option>
                  <option value="2d20kh1">Db - Dé bonus</option>
                  <option value="2d20kl1">Dm - Dé malus</option>
                  <option value="0">Jet - Autre</option>
                </select>
                <span class="align-self-center">&nbsp;+&nbsp;</span>
                <select class="select-sm" name="attr_roll-carac" title="@{roll-carac} Bonus de caractéristique">
                  <option value="0" selected>-</option>
                  <option value="@{agi}">AGI</option>
                  <option value="@{con}">CON</option>
                  <option value="@{for}">FOR</option>
                  <option value="@{per}">PER</option>
                  <option value="@{cha}">CHA</option>
                  <option value="@{int}">INT</option>
                  <option value="@{vol}">VOL</option>
                  <option value="?">Demander</option>
                </select>
                <span class="align-self-center">+ Rang</span>
                <select class="select-md" name="attr_roll-voie" title="@{roll-voie} Rang dans la voie">
                  <option value="0" selected>-</option>
                  <option value="1">Voie 1</option>
                  <option value="2">Voie 2</option>
                  <option value="3">Voie 3</option>
                  <option value="4">Voie 4</option>
                  <option value="5">Voie 5</option>
                  <option value="6">Voie 6</option>
                  <option value="7">Voie 7</option>
                  <option value="8">Voie 8</option>
                  <option value="9">Voie 9</option>
                </select>
                <span class="align-self-center">&nbsp;+&nbsp;</span>
                <input type="number" class="two-digits" name="attr_roll-bonus" title="@{roll-bonus} Bonus de compétence" value="0">
              </div>
              
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_roll-cmd" title="@{roll-cmd} Autre jet de dés" placeholder="Jet spécial ou description" value="">
              </div>

            </div>

            <!--
            <div class="pc-roll-r2">

              <div>

              </div>

              <div class="bordered">
                Compétence (CAR)
              </div>

              <div class="bordered">
                Description
              </div>

            </div>
            -->
            
          </fieldset>

        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Compétences -->
        <div class="pc-skills-subtab">
          <button type="action" class="hidden" name="act_skills_menu-btn"></button>
          <div class="sheet-2colrow">

            <div class="sheet-col">

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_acrobaties_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-acrobaties">
                    <span class="img-btn"></span>Acrobaties
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_acrobaties_carac" title="@{acrobaties_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_acrobaties_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_artisanat_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-artisanat">
                    <span class="img-btn"></span>Artisanat
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_artisanat_carac" title="@{artisanat_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_artisanat_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_athletisme_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-athletisme">
                    <span class="img-btn"></span>Athlétisme
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_athletisme_carac" title="@{athletisme_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_athletisme_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_commerce_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-commerce">
                    <span class="img-btn"></span>Commerce
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_commerce_carac" title="@{commerce_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_commerce_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_connaissance_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-connaissance">
                    <span class="img-btn"></span>Connaissance
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_connaissance_carac" title="@{connaissance_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_connaissance_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_discretion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-discretion">
                    <span class="img-btn"></span>Discrétion
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_discretion_carac" title="@{discretion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_discretion_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_divertissement_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-divertissement">
                    <span class="img-btn"></span>Divertissement
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_divertissement_carac" title="@{divertissement_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_divertissement_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_equitation_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-equitation">
                    <span class="img-btn"></span>Equitation
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_equitation_carac" title="@{equitation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_equitation_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_escalade_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-escalade">
                    <span class="img-btn"></span>Escalade
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_escalade_carac" title="@{escalade_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_escalade_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_effraction_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-effraction">
                    <span class="img-btn"></span>Effraction
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_effraction_carac" title="@{effraction_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_effraction_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_empathie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-empathie">
                    <span class="img-btn"></span>Empathie
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_empathie_carac" title="@{empathie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_empathie_bonus" value="0">
                </div>
              </div>

            </div>

            <div class="sheet-col">
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_intimidation_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-intimidation">
                    <span class="img-btn"></span>Intimidation
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_intimidation_carac" title="@{intimidation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_intimidation_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_medecine_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-medecine">
                    <span class="img-btn"></span>Médecine
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_medecine_carac" title="@{medecine_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_medecine_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_natation_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-natation">
                    <span class="img-btn"></span>Natation
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_natation_carac" title="@{natation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}" selected>CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_natation_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_occultisme_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-occultisme">
                    <span class="img-btn"></span>Occultisme
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_occultisme_carac" title="@{occultisme_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_occultisme_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_persuasion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-persuasion">
                    <span class="img-btn"></span>Persuasion
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_persuasion_carac" title="@{persuasion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_persuasion_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_religion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-religion">
                    <span class="img-btn"></span>Religion
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_religion_carac" title="@{religion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_religion_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_renseignement_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-renseignement">
                    <span class="img-btn"></span>Renseignement
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_renseignement_carac" title="@{renseignement_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_renseignement_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_sciences_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-sciences">
                    <span class="img-btn"></span>Sciences
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_sciences_carac" title="@{sciences_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_sciences_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_tromperie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-tromperie">
                    <span class="img-btn"></span>Tromperie
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_tromperie_carac" title="@{tromperie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_tromperie_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_survie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-survie">
                    <span class="img-btn"></span>Survie
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_survie_carac" title="@{survie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_survie_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_vigilance_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-vigilance">
                    <span class="img-btn"></span>Vigilance
                  </button>
                </div>
                <div>
                  <select class="select-md" name="attr_vigilance_carac" title="@{vigilance_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_vigilance_bonus" value="0">
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Buffs -->
        <div class="pc-buffs-subtab">
          <div class="pc-buffs">
            <h4>Nom</h4>
            <h4>Attribut affecté</h4>
            <h4>Valeur</h4>
          </div>

          <fieldset class="repeating_buffs">

            <div class="pc-buffs">

              <div class="bordered d-flex">
  
                <input type="checkbox" name="attr_buff-on" title="@{buff-on} Actif/Inactif" value="1">
                <input type="text" name="attr_buff-nom" title="@{buff-nom}" placeholder="Nom du buff/debuff" value="">
  
              </div>

              <div class="bordered d-flex">
                <span class="align-self-center">Attribut :</span>&nbsp;
                <select class="select-lg" name="attr_buff-attrib" title="@{buff-attrib} Cible du buff/debuff">
                  <optgroup label="Caractéristiques">
                    <option disabled class="optgroup">
                      &nbsp;Caractéristiques
                    </option>
                    <option value="agi">AGI</option>
                    <option value="con">CON</option>
                    <option value="for">FOR</option>
                    <option value="per">PER</option>
                    <option value="cha">CHA</option>
                    <option value="int">INT</option>
                    <option value="vol">VOL</option>
                  </optgroup>
                  <optgroup label="Combat">
                    <option disabled class="optgroup">
                      &nbsp;Combat
                    </option>
                    <option value="init">Initiative</option>
                    <option value="atkcac">Contact</option>
                    <option value="atktir">Distance</option>
                    <option value="atkmag">Magique</option>
                    <option value="def">Défense</option>
                  </optgroup>
                  <optgroup label="Ressources">
                    <option disabled class="optgroup">
                      &nbsp;Ressources
                    </option>
                    <option value="pv">Points de Vigueur</option>
                    <option value="dr">Dés de Récup</option>
                    <option value="pm">Points de Mana</option>
                    <option value="pc">Points de Chance</option>
                  </optgroup>
                </select>
              </div>
  
              <div class="bordered d-flex">
  
                <input type="text" name="attr_buff-value" title="@{buff-value}" placeholder="Valeur fixe ou [CAR] ou [rang voie N]" value="">
  
              </div>

            </div>


          </fieldset>

          <hr>

          <input type="hidden" name="attr_agi_buff_list" value="">
          <input type="hidden" name="attr_con_buff_list" value="">
          <input type="hidden" name="attr_for_buff_list" value="">
          <input type="hidden" name="attr_per_buff_list" value="">
          <input type="hidden" name="attr_cha_buff_list" value="">
          <input type="hidden" name="attr_int_buff_list" value="">
          <input type="hidden" name="attr_vol_buff_list" value="">
          <input type="hidden" name="attr_atkcac_buff_list" value="">
          <input type="hidden" name="attr_atktir_buff_list" value="">
          <input type="hidden" name="attr_atkmag_buff_list" value="">
          <input type="hidden" name="attr_init_buff_list" value="">
          <input type="hidden" name="attr_def_buff_list" value="">
          <input type="hidden" name="attr_pv_buff_list" value="">
          <input type="hidden" name="attr_dr_buff_list" value="">
          <input type="hidden" name="attr_pm_buff_list" value="">
          <input type="hidden" name="attr_pc_buff_list" value="">

          <details>
            <summary>
              Détail par attribut
            </summary>

            <div class="buff-detail">
              <div class="bordered">AGI</div>
              <div class="bordered"><span name="attr_agi_buff_list"></span></div>
              <div class="bordered"><span name="attr_agi_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">CON</div>
              <div class="bordered"><span name="attr_con_buff_list"></span></div>
              <div class="bordered"><span name="attr_con_buff"></span></div>
            </div>

            
            <div class="buff-detail">
              <div class="bordered">FOR</div>
              <div class="bordered"><span name="attr_for_buff_list"></span></div>
              <div class="bordered"><span name="attr_for_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">PER</div>
              <div class="bordered"><span name="attr_per_buff_list"></span></div>
              <div class="bordered"><span name="attr_per_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">CHA</div>
              <div class="bordered"><span name="attr_cha_buff_list"></span></div>
              <div class="bordered"><span name="attr_cha_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">INT</div>
              <div class="bordered"><span name="attr_int_buff_list"></span></div>
              <div class="bordered"><span name="attr_int_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">VOL</div>
              <div class="bordered"><span name="attr_vol_buff_list"></span></div>
              <div class="bordered"><span name="attr_vol_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">INIT</div>
              <div class="bordered"><span name="attr_init_buff_list"></span></div>
              <div class="bordered"><span name="attr_init_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">ATC</div>
              <div class="bordered"><span name="attr_atkcac_buff_list"></span></div>
              <div class="bordered"><span name="attr_atkcac_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">ATD</div>
              <div class="bordered"><span name="attr_atktir_buff_list"></span></div>
              <div class="bordered"><span name="attr_atktir_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">MAG</div>
              <div class="bordered"><span name="attr_atkmag_buff_list"></span></div>
              <div class="bordered"><span name="attr_atkmag_buff"></span></div>
            </div>

            <div class="buff-detail">
              <div class="bordered">DEF</div>
              <div class="bordered"><span name="attr_def_buff_list"></span></div>
              <div class="bordered"><span name="attr_def_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">PV</div>
              <div class="bordered"><span name="attr_pv_buff_list"></span></div>
              <div class="bordered"><span name="attr_pv_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">DR</div>
              <div class="bordered"><span name="attr_dr_buff_list"></span></div>
              <div class="bordered"><span name="attr_dr_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">PM</div>
              <div class="bordered"><span name="attr_pm_buff_list"></span></div>
              <div class="bordered"><span name="attr_pm_buff"></span></div>
            </div>
            
            <div class="buff-detail">
              <div class="bordered">PC</div>
              <div class="bordered"><span name="attr_pc_buff_list"></span></div>
              <div class="bordered"><span name="attr_pc_buff"></span></div>
            </div>

          </details>

        </div>
      </div>

      <!-- Fiche PJ, Onglet Equipement -->
      <div class="pc-gears-tab">
        
        <div class="pc-gears">

          <!-- Liste des équipements -->
          <div class="gears">

            <div class="block-title block-header">
              Equipements
              <button type="action" name="act_helpgear-btn" class="img-btn flat-btn" title="Aide équipement" >
                <span class="img-btn img-btn-lg">i</span>
              </button>
            </div>

            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_total_enc" value="0">
                <input type="hidden" name="attr_limite_enc" value="10">
                &nbsp;Trésor&nbsp;:&nbsp;<input type="text" name="attr_tresor" title="@{tresor}" placeholder="Bourses et possessions" value="">
                &nbsp;Encombrement&nbsp;:&nbsp;<span class="align-self-center" name="attr_total_enc" title="@{total_enc} Encombrement total"></span>
                &nbsp;/&nbsp;<span class="align-self-center" name="attr_limite_enc" title="@{limite_enc} Seuil d'encombrement"></span>
              </div>
            </div>

            <div class="bordered">
              
              <fieldset class="repeating_equipement">

                <details>
                  <summary>

                    <span>
                      <input type="text" name="attr_equip-nom" title="@{equip-nom}" placeholder="Nom de l'équipement">
                      Enc. <input type="number" name="attr_equip-enc" title="@{equip-enc} Encombrement (0,1,2)" value="0">
                      Nbre <input type="number" name="attr_equip-qte" title="@{equip-qte} Quantité possédée" value="1">
                      <input type="checkbox" name="attr_equip-on" title="@{equip-on} Equipement porté" value="1">
                    </span>

                  </summary>

                  <div class="d-flex">
                    <input type="text" name="attr_equip-detail" title="@{equip-detail}" placeholder="Description" value="">
                  </div>

                  <div class="d-flex d-flex-middle">
                    <input type="text" name="attr_equip-props" title="@{equip-props} Propriétés" value="">
                    <input type="checkbox" name="attr_equip-atk" title="@{equip-atk} A une attaque" value="1">
                    &nbsp;A une attaque
                    <input type="hidden" name="attr_atkid" value="">
                  </div>

                </details>


              </fieldset>

            </div>
          </div>

          <!-- Liste des ressources -->
          <div class="resources">
            <div class="block-title block-header">
              Ressources
            </div>

            <div class="bordered">
              
              <fieldset class="repeating_ressources">

                <div class="d-flex">
                  <input type="text" name="attr_res-desc" title="@{res-desc}" placeholder="Nom de la ressource" value="">
                  Valeur :
                  <input type="number" name="attr_res-val" title="@{res-val}" value="1">
                </div>

              </fieldset>

            </div>
          </div>

        </div>

        <div class="pc-gears">

          <!-- Equipements divers (free-form) -->
          <div class="misc-gears">
            <div class="block-title block-header">
              Equipement divers
            </div>
            <textarea name="attr_equip_divers" title="@{equip_divers}" value=""></textarea>
          </div>

          <!-- Notes -->
          <div class="notes">
            <div class="block-title block-header">
              Notes
            </div>
            <textarea name="attr_notes" title="@{notes}" value=""></textarea>
          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Config -->
      <div class="pc-config-tab">

        <hr>

        <div class="sheet-2colrow">
          
          <div class="sheet-col">
            <ul>
              <li>
                Jets&nbsp;:&nbsp;
                <select class="select-md" name="attr_togm" title="@{togm}">
                  <option value="" selected>Publics</option>
                  <option value="/w gm ">Chuchotés au MJ</option>
                </select>
                <input type="checkbox" name="attr_token_dsp" title="@{token_dsp}" value=" {{token=[x](@{token_url}) }} ">
                <span>Avec token</span>
              </li>
              <li>
                <span>Afficher voies 7-8-9&nbsp;</span>
                <input type="checkbox" name="attr_voies_789" value="1">
              </li>
              <li>
                <span>Afficher compétences&nbsp;</span>
                <input type="checkbox" name="attr_use_skills" value="1">
              </li>
            </ul>

            <h4>Règles optionnelles</h4>
            <ul>
              <li class="config-check" title="Atlas & règles optionnelles, p. 160">
                <input type="checkbox" name="attr_cfg_init_variable" value="1d6!">
                <span>Initiative variable</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 153">
                <input type="checkbox" name="attr_cfg_init_agi" value="1">
                <span>Initiative + AGI</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 157">
                <input type="checkbox" name="attr_cfg_use_encmb" value="1">
                <span>Encombrement&nbsp;</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 161">
                <input type="checkbox" name="attr_cfg_crit_diff" value="1">
                <span>Critiques différenciés&nbsp;</span>
              </li>
            </ul>

            <h4><input type="checkbox" name="attr_cfg_highfan" value="1">&nbsp;High fantasy</h4>
            <ul>
              <li class="config-check" title="Atlas & règles optionnelles, p. 184">
                <input type="checkbox" name="attr_cfg_use_epic" value="1">
                <span>Progression épique&nbsp;</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 183">
                <input type="checkbox" name="attr_cfg_use_drniv" value="1">
                <span>Récupération + niveau&nbsp;</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 191">
                <input type="checkbox" name="attr_cfg_use_mana" value="1">
                <span>Plus de Mana&nbsp;</span>
              </li>
            </ul>
  
            <h4><input type="checkbox" name="attr_cfg_lowfan" value="1">&nbsp;Low Fantasy</h4>
            <ul>
              <li class="config-check" title="Atlas & règles optionnelles, p. 193">
                <input type="checkbox" name="attr_cfg_use_capped6" value="1">
                <span>Progression limitée&nbsp;</span>
              </li>
              <li class="config-check" title="Atlas & règles optionnelles, p. 193">
                <input type="checkbox" name="attr_cfg_use_dronly" value="1">
                <span>Récupération - niveau&nbsp;</span>
              </li>
            </ul>

          </div>


          <div class="sheet-col">

            <div class="float-right">
              <input type="checkbox" name="attr_debug_mode" value="1" title="Mode Debug">&nbsp;
              <button type="action" class="flat-btn img-btn" name="act_reset_all-btn" title="Re-calculer attributs (rangs, encombrement)">
                <span class="img-btn">x</span>
              </button>
            </div>

            <h4>Notifications</h4>
            <ul>
              <li>
                <span>Etats préjudiciables</span>
                <select class="select-md" name="attr_notif_conditions">
                  <option value="0">Aucune</option>
                  <option value="1">Public</option>
                  <option value="2" selected>Chuchoté</option>
                </select>
              </li>
              <li>
                <span>Gain/Perte de PV</span>
                <select class="select-md" name="attr_notif_pv">
                  <option value="0">Aucune</option>
                  <option value="1">Public</option>
                  <option value="2" selected>Chuchoté</option>
                </select>
              </li>
            </ul>
            
            <h4>Apparence des messages</h4>
            <ul>
              <li>
                <span>Couleur :&nbsp;</span>
                <select class="select-md" name="attr_couleur_pj">
                  <option value="" selected>Défaut</option>
                  <option value="blue">Bleu</option>
                  <option value="indigo">Indigo</option>
                  <option value="purple">Violet</option>
                  <option value="pink">Rose</option>
                  <option value="red">Rouge</option>
                  <option value="orange">Orange</option>
                  <option value="yellow">Jaune</option>
                  <option value="green">Vert</option>
                  <option value="teal">Sarcelle</option>
                  <option value="cyan">Cyan</option>
                  <option value="gray">Gris</option>
                  <option value="dark">Sombre</option>
                </select>
              </li>
            </ul>
    
            <details>
              <summary>
                <strong>Premiers rangs</strong>
              </summary>
              <ul>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie1nom"></span>
                    <input type="number" name="attr_v1br" title="@{v1br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie2nom"></span>
                    <input type="number" name="attr_v2br" title="@{v2br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie3nom"></span>
                    <input type="number" name="attr_v3br" title="@{v3br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie4nom"></span>
                    <input type="number" name="attr_v4br" title="@{v4br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie5nom"></span>
                    <input type="number" name="attr_v5br" title="@{v5br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie6nom"></span>
                    <input type="number" name="attr_v6br" title="@{v6br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie7nom"></span>
                    <input type="number" name="attr_v7br" title="@{v7br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie8nom"></span>
                    <input type="number" name="attr_v8br" title="@{v8br}" value="1">
                  </div>
                </li>
                <li>
                  <div class="pc-configs">
                    <span name="attr_voie9nom"></span>
                    <input type="number" name="attr_v9br" title="@{v9br}" value="1">
                  </div>
                </li>
              </ul>
            </details>

          </div>

        </div>

        <hr>

        <details>

          <summary>Importer profil & équipement</summary>

          <div class="sheet-2colrow">

            <div class="sheet-col">
              <textarea class="statblock" name="attr_json_profile"></textarea>
            </div>

            <div class="sheet-col">
              <button type="action" class="flat-btn img-btn" name="act_comob_export-btn" title="Exporter le profil">
                <span class="img-btn">c</span>&nbsp;Export Chroniques Mobiles
              </button>
              <br>
              Composez votre profil avec l'application Export Chroniques Mobiles et insérez le code JSON dans le champ ci-contre
              <br>
              <button type="action" class="flat-btn img-btn" name="act_import_json-btn" title="Importer le profil">
                <span class="img-btn">W</span>&nbsp;Importer
              </button>
              <input type="checkbox" name="attr_reset_gears" value="1">
              <span>Réinitialiser les listes armes & équipement</span>
            </div>

          </div>

        </details>

      </div>

      <div class="pc-script-tab">
        <h3><span name="attr_script_title"></span></h3>

        <input class="show-script" type="hidden" name="attr_script_show" value="0">
        <div class="show-script">

          <div class="sheet-2colrow">
  
            <div class="sheet-col">
  
              <ul>
                <li>
                  Renuméroter les attaques&nbsp;
                  <button type="action" class="flat-btn img-btn" name="act_renum_atk-btn" title="Renuméroter les attaques">
                    <span class="img-btn">x</span>
                  </button>
                </li>
              </ul>

            </div>
  
            <div class="sheet-col">
              <h4>Prédicats</h4>
              <textarea name="attr_predicats_script" title="@{predicats_script} Prédicats" value=""></textarea>
            </div>
  
          </div>

        </div>
      </div>

      <!-- Fiche PJ, Onglet Version -->
      <div class="pc-version-tab">
        <h3>
          Notes de version (v<span name="attr_version"></span>)
          <button type="action" class="flat-btn img-btn" name="act_helpdoc-btn"><span class="img-btn">N</span></button>
        </h3>

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <ul>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.0.0</strong> (2024-12-24)
                  </summary>
                  <ul>
                    <li>Première version de la fiche</li>
                  </ul>
                </details>
              </li>

            </ul>

          </div>

          <div class="sheet-col">

          </div>

        </div>
      </div>


    </div>

    <!-- Fiche PNJ -->
    <div class="cof-npc">
      <input type="hidden" class="tabs-toggle" name="attr_npc_tab" value="main" />
      <div>
        <button type="action" name="act_npc_main-btn" class="main-tab tab-btn npc-main-btn">TRAITS</button>
        <button type="action" name="act_npc_config-btn" class="main-tab tab-btn npc-config-btn">CONFIGURATION</button>
      </div>

      <div class="npc-main-tab">

        <div class="npc-main">
  
          <div>
            <h4>Caractéristiques</h4>
  
            <div class="npc-4colrow">
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_agi-btn">
                    <span class="d20-btn">t</span>
                    AGI
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_agi" title="@{agi}" value="0">
                  <input type="checkbox" name="attr_agi_sup" title="@{agi_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_con-btn">
                    <span class="d20-btn">t</span>
                    CON
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_con" title="@{con}" value="0">
                  <input type="checkbox" name="attr_con_sup" title="@{con_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_for-btn">
                    <span class="d20-btn">t</span>
                    FOR
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_for" title="@{for}" value="0">
                  <input type="checkbox" name="attr_for_sup" title="@{for_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_per-btn">
                    <span class="d20-btn">t</span>
                    PER
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_per" title="@{per}" value="0">
                  <input type="checkbox" name="attr_per_sup" title="@{per_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

            </div>
  
            <div class="npc-4colrow">
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_cha-btn">
                    <span class="d20-btn">t</span>
                    CHA
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_cha" title="@{cha}" value="0">
                  <input type="checkbox" name="attr_cha_sup" title="@{cha_sup} Caractéristique supérieure" value="1">
                </div>
              </div>
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_int-btn">
                    <span class="d20-btn">t</span>
                    INT
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_int" title="@{int}" value="0">
                  <input type="checkbox" name="attr_int_sup" title="@{int_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_vol-btn">
                    <span class="d20-btn">t</span>
                    VOL
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_vol" title="@{vol}" value="0">
                  <input type="checkbox" name="attr_vol_sup" title="@{vol_sup} Caractéristique supérieure" value="1">
                </div>
              </div>

            </div>

          
            <div class="npc-2colrow">
              
              <div class="npc-row">

                <div class="npc-trait">
                  <div class="block-title">
                    <span>PV</span>
                    (RD <input type="number" name="attr_rd" title="@{rd}" value="">)
                  </div>
                  <div class="bordered">
                    <input type="number" class="two-digits" name="attr_pv" title="@{pv}" value="0">
                    /
                    <input type="number" class="two-digits" name="attr_pv_max" title="@{pv_max}" value="0">
                  </div>
                </div>
                
              </div>

              <div class="npc-2colrow">

                <div class="npc-trait">
                  <div class="block-title">
                    <button class="block-title" type="action" name="act_pnj_init-btn">
                      <span class="d20-btn">t</span>
                      Init.
                    </button>
                  </div>
                  <div class="bordered">
                    <input type="number" class="two-digits" name="attr_init" title="@{init}" value="0">
                  </div>
                </div>
                
                <div class="npc-trait">
                  <div class="block-title">
                    Défense
                  </div>
                  <div class="bordered">
                    <input type="number" class="two-digits" name="attr_def" title="@{def}" value="0">
                  </div>
                </div>

              </div>

            </div>

          </div>

          <div>
            <h4>Description</h4>
            <textarea name="attr_pnj_desc" title="@{pnj_desc}" rows="8" value=""></textarea>  
          </div>
  
        </div>

        <hr>

        <div class="npc-attacks">
          
          <div class="weapon">
            <div></div>
            <h4>ARME / SORT</h4>
            <h4>ATTAQUE</h4>
            <h4>CRIT.</h4>
            <h4>DM</h4>
            <h4>PORTEE</h4>
            <h4>SPECIAL</h4>
          </div>

          <fieldset class="repeating_npcarmes">

            <div class="weapon">
              
              <div>
                <button type="action" class="flat-btn" name="act_npcatk-btn">
                  <span class="d20-btn">t</span>
                </button>
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-nom" title="@{arme-nom}" placeholder="Arme/attaque" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="checkbox" name="attr_arme-multi" title="@{arme-multi} Attaques multiples" value="1">&nbsp;
                <select class="select-xs" name="attr_arme-roll" title="@{arme-roll} Type de jet">
                  <option value="1d20" selected>No - Normal</option>
                  <option value="2d20kh1">Db - Dé bonus</option>
                  <option value="2d20kl1">Dm - Dé malus</option>
                </select>&nbsp;
                <input type="number" class="two-digits" name="attr_arme-atk" title="@{arme-atk} Bonus d'attaque" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="number" class="two-digits" name="attr_arme-crit" title="@{arme-crit} Seuil de Critique" value="20" min="2" max="20">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-dm" title="@{arme-dm} Dé(s) de DM" placeholder="1d8, 2d6..." value="">
                <select class="select-xxs" name="attr_arme-dmtype" title="@{arme-dmtype} Type de dommages">
                  <optgroup label="Physiques">
                    <option disabled class="optgroup">
                      &nbsp;Physiques
                    </option>
                    <option value="contondants">C - Contondants</option>
                    <option value="perforants">P - Perforants</option>
                    <option value="poison">Po - Poison</option>
                    <option value="tranchants" selected>T - Tranchants</option>
                  </optgroup>
                  <optgroup label="Naturels">
                    <option disabled class="optgroup">
                      &nbsp;Naturels
                    </option>
                    <option value="coup">Co - Coup</option>
                    <option value="morsure">M - Morsure</option>
                    <option value="griffes">G - Griffes</option>
                  </optgroup>
                  <optgroup label="Elementaires">
                    <option disabled class="optgroup">
                      &nbsp;Elémentaires
                    </option>
                    <option value="acide">A - Acide</option>
                    <option value="électricité">E - Electricité</option>
                    <option value="feu">Fe - Feu</option>
                    <option value="froid">Fr - Froid</option>
                  </optgroup>
                  <optgroup label="Autres">
                    <option disabled class="optgroup">
                      &nbsp;Autres
                    </option>
                    <option value="magiques">M - Magiques</option>
                  </optgroup>
                </select>
                &nbsp;<span class="align-self-center">+</span>&nbsp;
                <input type="number" class="two-digits" name="attr_arme-dmdiv" title="@{arme-dmdiv} Bonus DM" value="0">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-portee" title="@{arme-portee}" value="">
              </div>
              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_arme-special" title="@{arme-special}" placeholder="Effet, capacités spéciales..." value="">
              </div>
              <!-- <button type="action" class="flat-btn img-btn" name="act_arme-opt-btn">
                <span class="img-btn">y</span>
              </button> -->

            </div>

            <input type="hidden" class="cof-wopt-toggle" name="attr_arme-opt" value="0"/>
            <div class="weapon-opt">
              <div class="weapon-option">
                <div></div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div class="bordered">
                </div>
                <div></div>
              </div>
            </div>

          </fieldset>

        </div>

        <hr>
        
        <div class="npc-abilities">

          <div class="npc-ability">
            <div></div>
            <h4>CAPACIT&Eacute;</h4>
            <h4>DESCRIPTION</h4>
          </div>

          <fieldset class="repeating_npcrolls">
            
            <div class="npc-ability">

              <div>
                <button type="action" class="flat-btn" name="act_npcroll-btn">
                  <span class="d20-btn">t</span>
                </button>
              </div>

              <div class="bordered">
                <input type="text" name="attr_npcroll-name" title="@{npcroll-name}" placeholder="Nom de la capacité" value="">
              </div>

              <div class="bordered">
                <input type="text" name="attr_npcroll-desc" title="@{npcroll-desc}" placeholder="Description de la capacité" value="">
              </div>

            </div>

          </fieldset>

        </div>

      </div>

      <div class="npc-config-tab">

        <hr>

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <ul>

              <li>
                Jets&nbsp;:&nbsp;
                <select class="select-md" name="attr_togm" title="@{togm}">
                  <option value="" selected>Publics</option>
                  <option value="/w gm ">Chuchotés au MJ</option>
                </select>
                <input type="checkbox" name="attr_token_dsp" title="@{token_dsp}" value=" {{token=[x](@{token_url}) }} ">
                <span>Avec token</span>
              </li>

              <li>
                <strong>Règles optionnelles : </strong>
                <ul>
                  <li>
                    <span>Initiative variable&nbsp;</span>
                    <input type="checkbox" name="attr_cfg_init_variable" value="1d6!">
                  </li>
                  <li>
                    <span>Critiques différenciés&nbsp;</span>
                    <input type="checkbox" name="attr_cfg_crit_diff" value="1">
                  </li>
                </ul>
              </li>
              
            </ul>

          </div>

        </div>
        
        <hr>

        <details>
          <summary>Importer un statblock</summary>
          <div class="npc-2colrow">
            <div>
              <textarea name="attr_statblock" class="stat-block" placeholder="Coller ici un statblock copié depuis le PDF"></textarea>
            </div>
            <div>
              <button type="action" name="act_importsb-btn" class="flat-btn img-btn" title="Importer le statblock">
                <span class="img-btn">W</span>&nbsp;Import
              </button>
              <textarea class="import-result" name="attr_resultsb"></textarea>
            </div>
          </div>
        </details>

      </div>

    </div>

  </div>
</div>

<rolltemplate class="sheet-rolltemplate-cof2">

  {{^token}}
  <div class="sheet-rt sheet-rt-header sheet-color-{{color}} sheet-rt-title">
    {{perso}}
  </div>
  {{/token}}
  {{#token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header sheet-color-{{color}} sheet-rt-title">
    <div class="sheet-rt-token">{{token}}</div>
    <div>{{perso}}</div>
  </div>
  {{/token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header sheet-color-{{color}}">
    <div>{{lsub}}</div>
    <div>{{rsub}}</div>
  </div>
  {{#roll}}
  <div class="sheet-rt sheet-rt-roll">
    {{roll}} 
    {{#broll}}
    | {{broll}}
    {{/broll}}
  </div>
  {{/roll}}
  {{#powder}}
  {{#rollWasFumble() roll}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt-fumble">{{powder}}</span>
  </div>
  {{/rollWasFumble() roll}}
  {{#broll}}
  {{#rollWasFumble() broll}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt-fumble">{{powder}} (si dé malus)</span>
  </div>
  {{/rollWasFumble() broll}}
  {{/broll}}
  {{/powder}}
  {{#dm}}
  <div class="sheet-rt sheet-rt-2cols">
    <div>Dommages</div>
    <div>
      {{dm}} {{#rollWasCrit() roll}}
      {{#rollTotal() critdiff 0}}
      <span class="sheet-rt-critical"> + {{dm}} CRITIQUE !</span>
      {{/rollTotal() critdiff 0}}
      {{/rollWasCrit() roll}}
      {{#^rollWasCrit() roll}} {{#rollWasCrit() broll}}
      {{#rollTotal() critdiff 0}}
      ( + <span class="sheet-rt-critical">{{dm}}</span> si dé bonus)
      {{/rollTotal() critdiff 0}}
      {{/rollWasCrit() broll}}
      {{/^rollWasCrit() roll}} {{dmdesc}}
    </div>
  </div>
  {{/dm}}
  {{#dmcrit}}
  {{#rollWasCrit() roll}}
  <div class="sheet-rt sheet-rt-2cols">
    <div><span class="sheet-rt-critical">CRITIQUE !</span></div>
    <div>
      {{dmcrit}}
    </div>
  </div>
  {{/rollWasCrit() roll}}
  {{#rollWasCrit() broll}}
  <div class="sheet-rt sheet-rt-2cols">
    <div><span class="sheet-rt-critical">CRITIQUE (si dé bonus)</span></div>
    <div>
      {{dmcrit}}
    </div>
  </div>
  {{/rollWasCrit() broll}}
  {{/dmcrit}}
  {{#text}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt-{{textclass}}">{{text}}</span>
  </div>
  {{/text}}

</rolltemplate>

<rolltemplate class="sheet-rolltemplate-custom">

  <div class="sheet-container sheet-color-{{color}}">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#allprops() title subtitle desc color token}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title subtitle desc color token}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>

</rolltemplate>

<script type="text/worker">

/**
 * COF2e Sheet Worker
 */

const SWData = {
  settings: {
    debugMode: false,
    hiddenClass: "hidden",
    visibleClass: "visible"
  },
  SHEET_TYPE: {
    PC: "pc",
    NPC: "npc"
  },
  RT_OPTIONS: {
    template: "cof2"
  },
  COLORS: {
    default:  [ "burlywood", "#000" ],
    blue:     [ "#0d6efd", "#fff" ],
    indigo:   [ "#6610f2", "#fff" ],
    purple:   [ "#6f42c1", "#fff" ],
    pink:     [ "#d63384", "#fff" ],
    red:      [ "#dc3545", "#fff" ],
    orange:   [ "#fd7e14", "#000" ],
    yellow:   [ "#ffc107", "#000" ],
    green:    [ "#198754", "#fff" ],
    teal:     [ "#20c997", "#fff" ],
    cyan:     [ "#0dcaf0", "#fff" ],
    gray:     [ "#6c757d", "#fff" ],
    dark:     [ "#343a40", "#fff" ],
  },
  PC: {
    PROFILES: {
      Aventuriers: [
        { 
          value: "Arquebusier",
          pv: 4,
          skills: "artisanat,athletisme,equitation,intimidation,natation,sciences,vigilance"
        },
        { 
          value: "Barde",
          pv: 4,
          skills: "acrobaties,artisanat,athletisme,commerce,connaissances,divertissement,empathie,equitation,intimidation,natation, persuasion, religion, renseignement,tromperie"
        },
        { 
          value: "Rôdeur",
          pv: 4,
          skills: "acrobaties,artisanat,athletisme,discretion,equitation,escalade,medecine,natation,survie,vigilance"
        },
        { 
          value: "Voleur",
          pv: 4, 
          skills: "acrobaties,artisanat,athletisme,commerce,discrétion,escalade,effraction,intimidation,natation,persuasion,renseignement,tromperie,vigilance"
        },
      ],
      Combattants: [
        { 
          value: "Barbare",
          pv: 5,
          skills: "artisanat,athletisme,equitation,escalade,intimidation,natation,survie,vigilance"
        },
        { 
          value: "Chevalier",
          pv: 5,
          skills: "athlétisme,connaissance,equitation,intimidation,natation,persuasion,religion"
        },
        { 
          value: "Guerrier",
          pv: 5,
          skills: "artisanat,athletisme,equitation,intimidation,natation"
        },
      ],
      Mages: [
        { 
          value: "Ensorceleur",
          pv: 3,
          skills: "artisanat,connaissance,occultisme,sciences"
        },
        { 
          value: "Forgesort",
          pv: 3,
          skills: "artisanat,connaissance,occultisme,sciences"
        },
        { 
          value: "Magicien",
          pv: 3,
          skills: "artisanat,connaissance,occultisme,sciences"
        },
        { 
          value: "Sorcier",
          pv: 3,
          skills: "artisanat,connaissance,occultisme,sciences"
        },
      ],
      Mystiques: [
        { 
          value: "Druide",
          pv: 4,
          skills: "artisanat,athletisme,connaissance,discretion,equitation,empathie,medecine,natation,religion,survie,vigilance"
        },
        { 
          value: "Moine",
          pv: 4,
          skills: "acrobaties,artisanat,athletisme,connaissance,discretion,empathie,escalade,medecine,natation,religion,survie,vigilance"
        },
        { 
          value: "Prêtre",
          pv: 4,
          skills: "artisanat,athletisme,connaissance,empathie,equitation,intimidation,medecine,persuasion,religion,survie"
        },
      ],
    },
    ABILITIES: [ 
      "agilité",
      "constitution",
      "force",
      "perception",
      "charisme",
      "intelligence",
      "volonté"
    ],
    COMBAT: {
      init: [
        "cfg_init_agi",
        "init_base",
        "per",
        "agi",
        "init_cond",
        "init_buff" 
      ],
      attacks: [ 
        [ "atkcac", "for", "Au Contact" ],
        [ "atktir", "agi", "A Distance" ], 
        [ "atkmag", "vol", "Magique" ]
      ],
      def: [
        "def_base",
        "armure", "armure_eqp",
        "bouclier", "bouclier_eqp",
        "agi", "con", "def_car_bonus", "capabilities",
        "def_cond",
        "def_buff",
        "def_action"
      ]
    },
    BUFFS: {
      To: [
        "agi",
        "con",
        "for",
        "per",
        "cha",
        "int",
        "vol",
        "init",
        "atkcac",
        "atktir",
        "atkmag",
        "def",
        "pv",
        "dr",
        "pm",
        "pc",
      ],
      From: [
        "agi",
        "con",
        "for",
        "per",
        "cha",
        "int",
        "vol",
        ...seq(9).map(v => `rang_voie${v}`),
        "rangs_voies",
        "niveau",
      ]
    },
    CONDITIONS: [ 
      { 
        name: "affaibli",
        label: "Affaibli",
        effects: { },
        description: [
          "Dé malus à tous les tests"
        ]
      },
      { 
        name: "aveugle",
        label: "Aveuglé",
        effects: {
          init: -5,
          atkcac: -5,
          def: -5,
          atktir: -10
        },
        description: [
          "Pas d'attaque magique nécessitant de voir la cible"
        ]
      }, 
      { 
        name: "essoufle",
        label: "Essouflé",
        effects: { },
        description: [
          "Déplacement limité à 5 m par action de mouvement"
        ]
      }, 
      { 
        name: "etourdi",
        label: "Etourdi",
        effects: {
          def: -5
        },
        description: [
          "Aucune action possible"
        ]
      }, 
      { 
        name: "immobilise", 
        label: "Immobilisé",
        effects: { },
        description: [
          "Pas de déplacement",
          "Dé malus aux tests d'attaque"
        ]
      }, 
      { 
        name: "invalide", 
        label: "Invalide",
        effects: { },
        description: [
          "Déplacement limité à 5 m par action de mouvement"
        ]
      }, 
      { 
        name: "paralyse", 
        label: "Paralysé",
        effects: { },
        description: [
          "Aucune action possible",
          "Touché et critique automatique en cas d'attaque"
        ]
      }, 
      { 
        name: "ralenti",
        label: "Ralenti",
        effects: { },
        description: [
          "Une seule action par round (attaque ou mouvement)"
        ]
      }, 
      { 
        name: "renverse",
        label: "Renversé",
        effects: {
          atkcac: -5,
          atktir: -5,
          atkmag: -5,
          def: -5
        },
        description: [
          "Nécessite une action d'attaque pour se relever"
        ]
      }, 
      { 
        name: "surpris",
        label: "Surpris",
        effects: {
          def: -5
        },
        description: [
          "Pas d'action au premier round de combat"
        ]
      }
    ],
    CAPABILITIES: [
      "peaudepierre"
    ],
    SKILLS: [
      {
        name: "acrobaties",
        label: "",
        ability: "agi"
      },
      {
        name: "artisanat",
        label: "",
        ability: "int"
      },
      {
        name: "athletisme",
        label: "Athlétisme",
        ability: "?"
      },
      {
        name: "commerce",
        label: "",
        ability: "cha"
      },
      {
        name: "connaissance",
        label: "",
        ability: "int"
      },
      {
        name: "discretion",
        label: "Discrétion",
        ability: "agi"
      },
      {
        name: "divertissement",
        label: "",
        ability: "cha"
      },
      {
        name: "equitation",
        label: "",
        ability: "?"
      },
      {
        name: "escalade",
        label: "",
        ability: "agi"
      },
      {
        name: "effraction",
        label: "",
        ability: "agi"
      },
      {
        name: "empathie",
        label: "",
        ability: "per"
      },
      {
        name: "intimidation",
        label: "",
        ability: "cha"
      },
      {
        name: "medecine",
        label: "Médecine",
        ability: "per"
      },
      {
        name: "natation",
        label: "",
        ability: "con"
      },
      {
        name: "occultisme",
        label: "",
        ability: "int"
      },
      {
        name: "persuasion",
        label: "",
        ability: "cha"
      },
      {
        name: "religion",
        label: "",
        ability: "int"
      },
      {
        name: "renseignement",
        label: "",
        ability: "cha"
      },
      {
        name: "sciences",
        label: "",
        ability: "int"
      },
      {
        name: "tromperie",
        label: "",
        ability: "cha"
      },
      {
        name: "survie",
        label: "",
        ability: "per"
      },
      {
        name: "vigilance",
        label: "",
        ability: "per"
      },
    ]
  },
  GEARS: {
    props: [
      "dm-1m",
      "dm-2m",
      "type-dm",
      "portee",
      "critique",
      "bonus-def"
    ]
  }
}

// =================
// UTILITY FUNCTIONS
// =================

/**
* Convert to integer
* @param {string} value - value to cast
* @param {number} onError - default value on error
* @returns {number}
*/
function intval(value, onError = 0) {
  return parseInt(value) || onError;
}

/**
 * Convert 0/1 value to boolean
 * @param {string} value - value
 * @returns {boolean}
 */
function boolval(value) {
  return (intval(value) === 1);
}

/**
* Convert to float
* @param {string} value - value to cast
* @param {float} onError - default value on error
* @returns float value
*/
function numval(value, onError = 0) {
  return parseFloat(value) || onError;
}


/**
* Get string or empty value
* @param {string} value - value to cast
* @param {string} onError - default value on null/undefined
* @returns string value
*/
function strval(value, onError = "") {
  return value || onError;
}

/**
* Capitalize string
* @param {string} str - string to capitalize
* @returns capitalized string
*/
function capitalize(str) {
  if (str && str !== "")
    return str.charAt(0).toUpperCase() + str.substring(1);
}

/**
 * Return ability short name
 * @param {string} ability - ability name
 * @returns {string}
 */
function shorten(ability) {
  return ability.substring(0, 3);
}

/**
 * @typedef clogOptions
 * @property {string} title - title of logged data
 * @property {boolean} debug - display only if debug_mode attribute enabled
 * @property {string} color - color name for log line
 * @property {string} style - CSS style for log line
 * @property {string} headerStyle - CSS style for log title
 */

/**
* Log to JS console with color & style
* @param {any} data - data to log
* @param {clogOptions} options - console display options
*/
function clog(data, options = {}) {
  let { 
    title = "",
    debug = true,
    textColor = "orange",
    backColor = "",
    style = "font-size:12px; font-weight:normal;",
    headerStyle = "font-size:13px; font-weight:bold;"
  } = options;

  if (debug && !SWData.settings.debugMode)
    return;

  title = strval(title);
  if (title !== "") title = ` Sheet-Worker : ${title} `;
  const titleStyle = `color:${textColor}; background-color:${backColor}; ${headerStyle} text-decoration:underline;`;
  const textStyle = `color:${textColor}; background-color:${backColor}; ${style}`;

  if (title) {
    if (typeof data === "object") {
      const output = `%c${title}`;
      console.log(output, titleStyle, data);
    } else {
      const output = `%c${title} %c${data}`;
      console.log(output, titleStyle, textStyle);
    }
  } else {
    if (typeof data === "object") {
      console.log(data);
    } else {
      const output = `%c${data}`;
      console.log(output, textStyle);
    }
  }
}

/**
* Generate a random number between 1 and max
* @param {integer} max - Upper bound of range
* @returns {integer} Generated random number
*/
function getRandom(max) {
  const min = 1;
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/**
* Parse a chunk of data into name & value
* @param {string} data - chunk of data to parse
* @param {string} [delim=":"] - delimiter, defaults to ":"
* @returns an object with name and value properties
*/
function parseNameValue(data, delim = ":") {
  delim = strval(delim, ":");
  let name = "", value = "";
  if (data.indexOf(delim) !== -1) {
    [ name, value ] = data.split(delim);
    name = strval(name).trim();
    value = strval(value).trim();
  }
  return { name, value };
}

/**
 * Return a sequence of numbers as an array
 * @param {number} count - Length of the sequence
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {number[]}
 */
function seq(count, base = 1) {
  return [ ...Array(count).keys() ].map(i => i += base);
}

/**
 * Return a sequence of names
 * @param {number} count - Length of the sequence
 * @param {string} name - Name template (with | placeholder to insert the sequence)
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {string[]}
 */
 function nameSeq(count, name, base = 1) {
  const [ prepend, append ] = name.split("|");
  return seq(count, base).map(s => `${prepend || ""}${s}${append || ""}`)
}

/**
 * Return a list of event as array or as string
 * @param {string} eventName - Name of the event
 * @param {string[]} attributeList - List of attributes
 * @param {string} joinChar - Character to use for joining the items
 * @returns {string[]|string}
 */
function eventList(eventName, attributeList, joinChar = "") {
  const result = attributeList.map(a => `${eventName}:${ a.toLowerCase() }`)
  return joinChar !== "" ? result.join(joinChar) : result;
}

/**
* Remove all rows for a repeating section
* @param {string} sectionName repeating section to clear
*/
function removeRepeatingAll(sectionName) {
  getSectionIDs(sectionName, function (rowIds) {
    rowIds.forEach(rowId => {
      removeRepeatingRow(`repeating_${sectionName}_${rowId}`);
    });
  });
}

/**
 * Process repeating section rows in order
 * @param {string} sectionName - repeating section to process
 * @param {object} callback - callback function
 */
function getSectionIDsOrdered(sectionName, callback) {
  getAttrs([`_reporder_${sectionName}`], function (v) {
    getSectionIDs(sectionName, function (idArray) {
      let reporderArray = v[`_reporder_${sectionName}`] ? v[`_reporder_${sectionName}`].toLowerCase().split(',') : [],
        ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
      callback(ids);
    });
  });
};

/** @typedef sendChatMsgOptions
 * @property {string} title - Title of the message
 * @property {string} template - Name of roll template
 * @property {string} whisper - Target for whispered message
 */

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {sendChatMsgOptions} options - Options for the message
 */
function buildChatMsg(msg, options = SWData.RT_OPTIONS) {
  let { title = "", template = "default", whisper = "@{togm}" } = options;
  if (whisper.charAt(0) !== "@" && whisper !== "") whisper = "/w \"" + whisper + "\" ";
  let chatMsg;
  if (Array.isArray(msg)) {
    chatMsg = msg.map(t => `{{${t}}}`).join(" ");
  } else {
    chatMsg = "{{" + msg + "}}";
  }
  chatMsg += " @{token_dsp}";
  if (template !== "")
    return `${whisper}&{template:${template}} ${title ? (template === "default" ? `{{name=${title} }}` : `{{${title} }}`) : "" } ${chatMsg}`;
  else
    return msg;
}

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {sendChatMsgOptions} options - Options for the message
 */
 function sendChatMsg(msg, options = SWData.RT_OPTIONS) {
  const chatCmd = buildChatMsg(msg, options);
  startRoll(chatCmd, roll => {
    let save = 1;
    if (roll.results.save) 
      save = roll.results.save.result;
    let last_rolls = "";
    if (roll.results.roll)
      last_rolls += roll.results.roll.result;
    if (roll.results.broll)
      last_rolls += "|" + roll.results.broll.result;
    if (last_rolls !== "" && save)
      setAttrs({ last_rolls });
    finishRoll(roll.rollId);
  });
}

/**
 * Return COF 2e rolltemplate
 * @param {object} props - List of {{ }} sections as object properties
 * @returns {string[]}
 */
function cof2RollTemplate(props) {
  return [
    "perso=@{character_name}",
    "color=@{couleur_pj}",
    ...Object.entries(props).map(e => {
      const [ prop, value ] = e;
      const space = (value !== "") ? " " : ""
      return `${prop}=${value}${space}`;
    })
  ];
}

/**
 * Send a single value roll query to chat and process response
 * @param {string} prompt - Input box label
 * @param {object} callback - Callback function to process input
 */
function askValue(prompt, callback) {
  const askValue = `!{{ask=[[?{${prompt}}]]}}`;
  startRoll(askValue, question => {
    const query = question.results.ask.result;
      if(query && callback) {
          callback(query);
      }
  });
}

/**
 * Send a drop-down roll query to chat and process response
 * @param {string|array} askParams - Parameters of the roll query 
 * @param {object} callback - Callback function to process input
 */
function ask(askParams, callback) {
  if (!Array.isArray(askParams)) {
    askParams = [ askParams, "Non", "Oui" ];
  }
  const [ prompt, ...choices ] = askParams;
  const choice = choices.map((ch, ix) => `${ch},${ix}`).join("|");
  const ask = `!{{ask=[[?{${prompt}|${choice}}]]}}`;
  startRoll(ask, question => {
      const query = question.results.ask.result;
      if(query && callback) {
          callback(query, choices);
      }
      //finishRoll(question.rollId);
  });
};

/**
 * Add numeric attributes values
 * @param {object} values - getAttrs object with numeric values
 * @returns - {number}
 */
function addValues(values) {
  return Object.keys(values).reduce((sum, attr) => {
    return sum + intval(values[attr]);
  }, 0);
}

/**
 * Return the die roll formula for type
 * @param {string} type - Type of d20 roll
 * @param {number} [weakened=0] - Has weakened condition
 * @returns - {string}
 */
function dieRoll(type, weakened = 0) {
  let roll = "";
  switch (type) {
    case "S":
      roll = (weakened === 1) ? "1d20" : "2d20kh1";
      break;
    case "H":
      roll = (weakened === 1) ? "2d20kh1" : "{2d20kh1, 0d20+10}kh1";
      break;
    default:
      roll = (weakened === 1) ? "2d20kl1" : "1d20";
      break;
  }
  return roll;
}

/**
 * Detect MOD script
 * @param {object} values - getAttrs() object values
 * @returns {boolean}
 */
function hasMODScript(values) {
  return (strval(values.scriptVersion).toLowerCase() === "true");
}

/**
 * Show a div area via Roll20 jQuery
 * @param {string} div - Name of div area to show
 */
function showArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.hiddenClass);
  $20(`.${div}`).addClass(SWData.settings.visibleClass);
}

/**
 * Hide a div area via Roll20 jQuery
 * @param {string} div - Name of div area to hide
 */
function hideArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.visibleClass);
  $20(`.${div}`).addClass(SWData.settings.hiddenClass);
}

// ===============
// PC SHEET EVENTS
// ===============

/**
 * Change identity heading
 */
on("change:sheet_type", function() {
  getAttrs([ "sheet_type" ], function(value) {
    const sheet_type = strval(value.sheet_type);
    if (!sheet_type) return;

    Object.values(SWData.SHEET_TYPE).forEach(type => {
      if (type === sheet_type) {
        showArea(`identity-${type}`);
      } else {
        hideArea(`identity-${type}`);
      }
    })

  });
});

/**
 * Change tabs
 */
[ 
  "pc_main", "pc_abilities", "pc_gears", "pc_config", "pc_script", "pc_version",
  "npc_main", "npc_config"
].forEach(button => {
  on(`clicked:${button}-btn`, function() {
    const [ type, value ] = button.split("_");
    setAttrs({ [`${type}_tab`]: value });
  });
});

/**
 * Change subtabs
 */
[ "rolls", "skills", "buffs" ].forEach(button => {
  on(`clicked:pc_${button}-btn`, function() {
      setAttrs({ pc_subtab: button });
  });
});

/**
 * Populate the profiles datalist
 * @param {string} family - name of profiles family
 * @param {string} profile - name of current profile
 * @returns 
 */
function setProfilesList(family, profile) {
  const profiles = SWData.PC.PROFILES[family] || [];
  if (profiles.length === 0)
    return;
  populateListOptions({
    elemSelector: "#pc-profiles",
    optionsArray: profiles.map(prof => ({ value: prof.value, selected: (prof.value === profile)}))
  });
}

/**
 * On change of family
 * - set list of profiles
 * - set DR
 * - compute level 1 PV
 */
on("change:famille", function() {
  getAttrs([ "profil", "famille", "niveau", "con" ], function(values) {
    
    const family = strval(values.famille);
    const profile = strval(values.profil);
    setProfilesList(family, profile);

    const level = intval(values.niveau);
    const con = intval(values.con);
    let drMax = 8;
    const updates = new Map();
    if (level === 1) {
      switch (family) {
        case "Combattants":
          drMax = 10;
          break;
        case "Mages":
          drMax = 6
          break;
      }
      const pvMax = drMax + con;
      updates.set("pv", pvMax);
      updates.set("pv_max", pvMax);
    }
    updates.set("drecup", drMax);
    setAttrs(Object.fromEntries(updates));
  });
});

/**
 * On change of profile, check skill proficiencies
 */
on("change:profil", function() {
  getAttrs([ "profil", "famille", "use_skills" ], function(values) {
    const useSkills = boolval(values.use_skills);
    if (!useSkills)
      return;

    const family = strval(values.famille);
    if (!SWData.PC.PROFILES[family])
      return;

    const [ primary ] = strval(values.profil).split("/");
    const profile = strval(SWData.PC.PROFILES[family].find(p => p.value === primary));
    if (!profile)
      return;

    const skillList = profile.skills.split(",");
    const proficiencies = new Map();
    SWData.PC.SKILLS.forEach(skill => {
      const proficient = skillList.includes(skill.name) ? 1 : 0;
      proficiencies.set(skill.name + "_prof", proficient);
    });
        
    if (proficiencies.size > 0)
      setAttrs(Object.fromEntries(proficiencies));
  });
});

/**
 * Update the base attack scores
 * @param {number} level - PC's level
 * @param {number} levelCap - level cap (6 or 10)
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map} updated Map object
 */
function updateAttacksBase(level, levelCap, attributes) {
  let atkBase = Math.min(level, levelCap);
  attributes.set("atkcac_base", atkBase);
  attributes.set("atktir_base", atkBase);
  attributes.set("atkmag_base", atkBase);
  return attributes;
}

/**
 * Update the evolutive die
 * @param {number} level - PC's level
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map} updated Map object
 */
function updateDEvol(level, attributes) {
  let devol;
  switch (true) {
    case level >= 15:
      devol = "d12";
      break;
    case level >= 12:
      devol = "d10";
      break;
    case level >= 9:
      devol = "d8";
      break;
    case level >= 6:
      devol = "d6";
      break;
    default:
      devol = "d4";
  }
  attributes.set("devol", devol);
  return attributes;
}

/**
 * On level change
 */
on("change:niveau", function() {
  getAttrs([ "niveau", "cfg_use_epic", "cfg_use_capped6" ], function(values) {
    const cappedAt6 = boolval(values.cfg_use_capped6);
    // base progression
    const levelCap = cappedAt6 ? 6 : 10;
    const level = intval(values.niveau);
    let updateAttrs = new Map;
    updateAttrs = updateAttacksBase(level, levelCap, updateAttrs);
    updateAttrs = updateDEvol(level, updateAttrs);
    updateAttrs.set("def_base", 10);
    // epic progression
    const useEpic = boolval(values.cfg_use_epic);
    if (level > levelCap && useEpic) {
      const oddLevel = (level %2 === 1) ? level : level -1;
      const epicBase = levelCap + Math.ceil((oddLevel - levelCap) / 2);
      updateAttrs.set("atkcac_base", epicBase);
      updateAttrs.set("atktir_base", epicBase);
      updateAttrs.set("atkmag_base", epicBase);
      updateAttrs.set("def_base", epicBase);
    }
    setAttrs(Object.fromEntries(updateAttrs))
  });
});

/**
 * Change character name to true name
 */
on("clicked:alias-toggle", function() {
  getAttrs([ "character_name", "alias", "notes" ], function(values) {
    const name = strval(values.character_name);
    const alias = strval(values.alias);
    const text = `Le vrai nom de ${name} est ${alias}`;
    const notes = strval(values.notes) + "\n=====\n" + text;
    if (alias !== "") {
      const cofantasy = JSON.stringify({ action: "alias", param: name });
      setAttrs({ character_name: alias, alias: "", notes, cofantasy });
      sendChatMsg(cof2RollTemplate({
        text
      }));
    }
  });
})

/**
 * On ability components change
 */
SWData.PC.ABILITIES.forEach(ability => {
  const short = shorten(ability);
  const attrs = [ 
    short, 
    `${short}_buff` 
  ];
  on(eventList("change", attrs, " "), function () {
    getAttrs(attrs, function(values) {
      const score = addValues(values);
      setAttrs({ [`${short}_test`]: score });
    });
  });
});

/**
 * Update the init attribute
 */
function updateInit() {
  getAttrs([ ...SWData.PC.COMBAT.init ], function(values) {
    values.agi *= intval(values.cfg_init_agi);
    delete values.cfg_init_agi;
    const init = addValues(values);
    setAttrs({ init });
  });
}

/**
 * On init components change
 */
on(eventList("change", SWData.PC.COMBAT.init, " "), updateInit);

/**
 * On attacks components change
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, ability ] = attk;
  const changed = [
    `${attack}_base`,
    `${ability}`,
    `${attack}_cond`,
    `${attack}_buff`
  ];
  on(eventList("change", changed, " "), function() {
    getAttrs(changed, function(values) {
      const score = addValues(values);
      setAttrs({ [attack]: score });
    });
  });
});

/**
 * Compute max DR
 */
function updateDRMax() {
  getAttrs([ "con", "dr_buff" ], function(values) {
    const dr_max = 2 + intval(values.con) + intval(values.dr_buff);
    setAttrs({ dr_max });
  });
}

/**
 * On CON change
 */
on("change:con", updateDRMax);

/**
 * Comput load limit
 * @param {number} force - FOR score
 * @returns {number}
 */
function loadLimit(force) {
  return 10 + 2 * force;
}

/**
 * Compute load threshold
 */
function updateLoadLimit() {
  getAttrs([ "for" ], function(value) {
    setAttrs({ limite_enc: loadLimit(intval(value.for)) });
  });
}

/**
 * On FOR change
 */
on("change:for", updateLoadLimit);

/**
 * Compute max PM
 */
function updatePMMax() {
  const owned = [];
  const spells = [];
  const bRanks = [];
  seq(9).forEach(p => {
    bRanks.push(`v${p}br`)
    seq(5).forEach(r => {
      owned.push(`v${p}r${r}`);
      spells.push(`v${p}r${r}_spell`);
    });
  });
  getAttrs([ "cfg_use_mana", "vol", "pm_buff", ...spells, ...owned, ...bRanks ], function(values) {
    const useMorePM = boolval(values.cfg_use_mana);
    const spellPM = spells.reduce((pm, spell) => {
      const [ ability ] = spell.split("_");
      const baseRank = intval(values[`v${ability.charAt(1)}br`]);
      const rank = intval(ability.charAt(3));
      let pmGain = 1;
      if (useMorePM && (baseRank + rank -1) >= 3)
        pmGain = 2;
      return pm + (intval(values[ability]) * intval(values[spell]) * pmGain);
    }, 0);
    const pm_max = intval(values.vol) + spellPM + intval(values.pm_buff);
    setAttrs({ pm_max });
  });
}

/**
 * On VOL & PM buff change
 */
on("change:vol change:pm_buff", updatePMMax);

/**
 * On change of an ability spell
 */
seq(9).forEach(p => {
  seq(5).forEach(r => {
    on(`change:v${p}r${r} change:v${p}r${r}_spell`, updatePMMax)
  });
});

/**
 * Compute max PC
 */
function updatePCMax() {
  getAttrs([ "cha", "pc_base", "pc_buff" ], function(values) {
    const pc_max = addValues(values);
    setAttrs({ pc_max });
  });
}

/**
 * On PC components change
 */
on("change:cha change:pc_base change:pc_buff", updatePCMax);

/**
 * On ability button click
 */
SWData.PC.ABILITIES.forEach(ability => {
  const short = shorten(ability);
  on(`clicked:${short}-btn`, function () {
    getAttrs([ `d${short}_sup`, "condition_affaibli", "armure_malus", "armure_eqp" ], function(values) {
      const [ dType ] = Object.keys(values);
      const weakened = intval(values.condition_affaibli);
      let roll = dieRoll(values[dType], weakened);
      const armure_eqp = intval(values.armure_eqp);
      const armure_malus = intval(values.armure_malus) * armure_eqp;
      const armor_malus = short === "agi" ? ` - ${armure_malus}[Malus armure]` : "";
      const carac = `[[${roll}[Dé] + @{${short}_test}[Bonus ${short.toUpperCase()}]${armor_malus} ]] `;
      const chatMsg = cof2RollTemplate({
        lsub: "Test",
        rsub: capitalize(ability),
        roll: carac
      });
      sendChatMsg(chatMsg);
    });
  });
});

/**
 * On initiative button click
 */
on("clicked:init-btn", function () {
  const init = `[[@{init}[Initiative] + @{cfg_init_variable}[Dé(s)] &{tracker} ]]`;
  const chatMsg = cof2RollTemplate({
    lsub: "Jet",
    rsub: "Initiative",
    roll: init
  });
  sendChatMsg(chatMsg);
});

/**
 * On attack button click
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, , description ] = attk;
  on(`clicked:${attack}-btn`, function () {
    getAttrs([ "condition_affaibli" ], function (value) {
      const roll = (intval(value.condition_affaibli) === 1) ? "2d20kl1" : "1d20";
      const atkRoll = `[[${roll}cs20cf1[Dé] + @{${attack}}[Bonus] ]]`;
      const atkProps = {
        lsub: "Attaque",
        rsub: description,
        roll: atkRoll,
        broll: ""
      };
      if (roll === "1d20")
        atkProps.broll = atkRoll;
      const chatMsg = cof2RollTemplate(atkProps);
      sendChatMsg(chatMsg);
    });
  });
});

/**
 * Update PV & DR
 * @param {number} vp - Number of PV lost or gained
 * @param {number} lossOrGain - Type of change (-1 = loss, +1 = gain)
 * @param {boolean} [buttonClicked=true] - Updated via button
 */
function updatePVDR(vp, lossOrGain, buttonClicked = true) {
  getAttrs([ "sheet_type", "pv", "pv_max", "dr", "rd", "notif_pv" ], function (values) {
    let pv = intval(values.pv);
    const pvMax = intval(values.pv_max);
    let dr = intval(values.dr);
    const rd = strval(values.rd);
    const hasRD = (lossOrGain === -1 && rd !== "") ? "\n" + "RD " + rd : "";
    const notify = numval(values.notif_pv);

    let effect = "";
    const updateAttrs = new Map;

    // already up-to-date if not via button
    if (buttonClicked) {
      pv += vp * lossOrGain;
      updateAttrs.set("pv", pv);
    }

    if (pv > pvMax) {
      pv = pvMax;
      updateAttrs.set("pv", pv);
    }
    if (pv < 0) {
      pv = 0;
      updateAttrs.set("pv", pv);
    }

    if (pv > 1) {
      updateAttrs.set("condition_affaibli", 0);
    } else if (pv === 1) {
      effect = " et subit la condition Affaibli-e (PV = 1)";
      updateAttrs.set("condition_affaibli", 1);
    } else if (pv === 0) {
      dr = Math.max(dr - 1, 0);
      updateAttrs.set("dr", dr);
      effect = ", perd un DR et tombe au sol inconscient-e (PV = 0)"
    }
    
    if (notify > 0) {
      const chatMsg = cof2RollTemplate({
          lsub: "PV",
          rsub: `${ lossOrGain === -1 ? "Blessure" : "Soins" } `,
          text : `@{character_name} ${ lossOrGain === -1 ? "perd" : "gagne" } ${vp} PV${effect}${hasRD} `
      });
      const whisper = (notify === 2) ? "gm" : "";
      sendChatMsg(chatMsg, {
        ...SWData.RT_OPTIONS,
        whisper
      });
    }

    if (updateAttrs.size > 0)
      setAttrs(Object.fromEntries(updateAttrs));
  });
}

/**
 * Handle PV change buttons
 * @param {string} button Name of action button
 */
function changeVP(button) {
  let prompt = (button === "vigloss-btn") ? "PV perdus ?" : "PV soignés ?";
  let lossOrGain = (button === "vigloss-btn") ? -1 : +1;
  //const ask = `!{{ask=[[?{${prompt}}]]}}`;
  askValue(prompt, function(vp) {
    if (vp <= 0) return;
    updatePVDR(vp, lossOrGain);
  });
}

/**
 * On PV change action buttons
 */
on("clicked:vigloss-btn clicked:vigheal-btn", function (eventInfo) {
  const [ , button ] = eventInfo.triggerName.split(":");
  changeVP(button);
});

/**
 * On PV value change
 */
on("change:pv", function (eventInfo) {
  if (eventInfo.sourceType === "sheetworker")
    return;

  const oldPV = intval(eventInfo.previousValue);
  const newPV = intval(eventInfo.newValue);
  const vp = oldPV > newPV ? oldPV - newPV : newPV - oldPV;
  const lossOrGain = oldPV > newPV ? -1 : +1;
  //updatePVDR(vp, lossOrGain, false);
});

/**
 * On Recup button click
 */
on("clicked:drecup-btn", function() {
  const recupAttrs = [ 
    "dr",
    "drecup",
    "niveau",
    "pv",               
    "pv_max",
    "cfg_use_drniv",
    "cfg_use_dronly" 
  ];
  getAttrs(recupAttrs, function(values) {
    const lsub = "Jet";
    const rsub = "Récupération Rapide";
    let dr = intval(values.dr);
    if (dr === 0) {
      const chatMsg = cof2RollTemplate({
        lsub,
        rsub,
        text: "Plus de Dé de Récupération !",
        textclass: "fumble"
      });
      sendChatMsg(chatMsg);
      return;
    }

    const pvMax = intval(values.pv_max);
    let pv = intval(values.pv);
    if (pv === pvMax) {
      const chatMsg = cof2RollTemplate({
        lsub,
        rsub,
        text: "@{character_name} est déjà à son maximum de PV !",
      });
      sendChatMsg(chatMsg);
      return;
    }

    dr -= 1;
    const dRecup = `d${values.drecup}`;
    const level = intval(values.niveau);
    const addLevel = boolval(values.cfg_use_drniv);
    const drOnly = boolval(values.cfg_use_dronly);
    let bRecup = "", bLevel = 0;
    if (drOnly) {
      bLevel = addLevel ? level : Math.ceil(level / 2);
      bRecup = `+ ${bLevel}[Niveau${ addLevel ? "" : "/2" }] `;
    }
    const recup = `[[${dRecup}[DR] ${bRecup}]] PV récupérés`;
    const chatMsg = cof2RollTemplate({
      lsub,
      rsub,
      roll: recup,
      text: `${dr} DR restants`
    });
    const chatCmd = buildChatMsg(chatMsg);
    startRoll(chatCmd, roll => {
      pv += roll.results.roll.result;
      pv = Math.min(pv, pvMax);
      finishRoll(roll.rollId);
      setAttrs({ dr, pv });
    });
  });
});

/**
 * Update the def attribute
 */
function updateDef() {
  getAttrs(SWData.PC.COMBAT.def, function(values) {
    const capabilities = strval(values.capabilities).split(",");
    delete values.capabilities;
    values.armure = intval(values.armure) * intval(values.armure_eqp);
    delete values.armure_eqp;
    values.bouclier = intval(values.bouclier) * intval(values.bouclier_eqp);
    delete values.bouclier_eqp;
    let def_car = "AGI";
    let def_car_bonus = intval(values.agi);
    if (capabilities.includes("peaudepierre")) {
      const conValue = intval(values.con);
      if (conValue > def_car_bonus) {
        def_car = "CON";
        def_car_bonus = conValue;
      }
    }
    values.agi = 0;
    values.con = 0;
    values.def_car_bonus = def_car_bonus;
    def = addValues(values);
    setAttrs({ def, def_car, def_car_bonus }, false);
  });
}

/**
 * On Init components change
 */
on(eventList("change", SWData.PC.COMBAT.def, " "), updateDef);

/**
 * On Luck button click
 */
on("clicked:luck-btn", function() {
  getAttrs([ "pc", "last_rolls" ], function(values) {
    const lsub = "Jet";
    const rsub = "Chance";
    let pc = intval(values.pc);
    if (pc === 0) {
      const chatMsg = cof2RollTemplate({
        lsub,
        rsub,
        text: "Plus de Points de Chance !",
        textclass: "fumble"
      });
      sendChatMsg(chatMsg);
      return;
    }

    pc -= 1;
    const [ last_roll, last_broll ] = strval(values.last_rolls).split("|");
    let roll = "[[10" + (last_roll !== "" ? ` + ${last_roll} ` : "" ) + "]]";
    if (last_broll)
      roll += " | [[10" + ` + ${last_broll} ` + "]]";
    const chatMsg = cof2RollTemplate({
      lsub,
      rsub,
      roll,
      text: `${pc} Points de Chance restants`,
      save: "[[0]]"
    });
    sendChatMsg(chatMsg);
    setAttrs({ pc });
  });
});

/**
 * Roll evolutive die
 */
on("clicked:devol-btn", function() {
    askValue("Nombre de dés ?", function(dice) {
    const chatMsg = cof2RollTemplate({
      lsub: "Jet",
      rsub: "Dé évolutif",
      roll: `[[${dice}@{devol}]]`
    });
    sendChatMsg(chatMsg);
  });
});

/**
 * Return a Map of attribute buffs values
 * @param {number} hasCondition - set/unset condition flag
 * @param {object} effects - key/value pairs of attributes and debuffs
 * @param {string[]} buffs - list of attribute names
 * @param {object} values - list of attribute values as returned by getAttrs()
 * @returns {Map}
 */
function setCondition(hasCondition, effects, buffs, values) {
  const attributes = new Map();
  const toggle = hasCondition === 1 ? +1 : -1;
  buffs.forEach(buff => {
    const [ attribute ] = buff.split("_");
    const newValue = intval(values[buff]) + toggle * effects[attribute];
    attributes.set(buff, newValue);
  });
  return attributes;
}

/**
 * Return attack name given attribute name
 * @param {string} attribute - attack score attribute
 * @returns {string}
 */
function getAttackName(attribute) {
  const found = SWData.PC.COMBAT.attacks.find(attack => {
    const [ atkAttr ] = attack;
    return atkAttr === attribute;
  });
  if (!found)
    return "";
  const [ , , name ] = found;
  return name;
}

/**
 * Display a chat message with a condition effects
 * @param {string} label - Condition name
 * @param {object} effects - key/value pairs of attributes and mods
 * @param {string[]} description - list of additional effects
 * @param {number} notify - 1 = public, 2 = whispered
 */
function displayCondition(label, effects, description, notify) {
  const malus = [];
  Object.keys(effects).forEach(attribute => {
    let name = "";
    switch (attribute) {
      case "init":
        name = "Initiative";
        break;
      case "def":
        name = "Défense";
        break;
      default:
        name = "Attaque " + getAttackName(attribute);
        break;
    }
    malus.push(`${effects[attribute]} en ${name}`);
  });
  text = [ "@{character_name} subit les effets suivants :", ...malus, ...description ].join("\n");
  const chatMsg = cof2RollTemplate({
    lsub: "Condition",
    rsub: label,
    text
  });
  const whisper = (notify === 2) ? "gm" : "";
  sendChatMsg(chatMsg, {
    ...SWData.RT_OPTIONS,
    whisper
  });
}

/**
 * Update condition attributes & buffs
 */
SWData.PC.CONDITIONS.forEach(condition => {
  const { name, label, effects, description } = condition;

  // Set/Unset conditions
  on(`clicked:${name}-icon`, function () {
    const buffs = Object.entries(effects).map(([ attribute ]) => `${attribute}_cond`);
    getAttrs([ `condition_${name}`, ...buffs ], function(values) {
      const [ attribute, ...buffs ] = Object.keys(values);
      const hasCondition = 1 - intval(values[attribute]);
      const updateAttrs = setCondition(hasCondition, effects, buffs, values);
      updateAttrs.set(attribute, hasCondition);
      setAttrs(Object.fromEntries(updateAttrs));
    });
  });

  // Display enabled condition
  on(`change:condition_${name}`, function() {
    getAttrs([ `condition_${name}`, "notif_conditions" ], function(values) {
      const [ attribute ] = Object.keys(values);
      const hasCondition = intval(values[attribute]);
      const notify = intval(values.notif_conditions);
      if (hasCondition === 1 && notify !== 0)
        displayCondition(label, effects, description, notify);
    });
  });
});

/**
 * Return matches for pattern in text
 * @param {string} text - text to match
 * @param {RegExp} pattern - regular expression
 * @returns {string[]}
 */
function matchRegExp(text, pattern) {
  return [ ...text.matchAll(pattern) ];
}

/**
 * Get the path number from the path name
 * @param {string} name - ability qualifier ('rang voie 1', 'rang voie <name>', 'rang <name>')
 * @param {string} pathNames - noms_voies attribute value (| delimited)
 * @returns {number}
 */
function findPathByName(name, pathNames) {
  const q = name.split(" ").slice(1) || [];
  if (q.length === 0)
    return 0;

  const qualifier = q.slice(1).join(" ");
  if (qualifier === "")
    return 0

  if (q[0].toLowerCase() === "voie") {
    if (Number.isInteger(intval(qualifier)) && intval(qualifier) > 0) {
      return intval(qualifier);
    }
  }

  const pathNumber = pathNames.split("|").findIndex(pathName => pathName.toLowerCase() === qualifier.toLowerCase());

  return pathNumber + 1;
}

/**
 * @typedef insertRollsOptions
 * @property {string} pathNames - comma-separated list of path names
 * @property {boolean} useNPC - prepend attribute names with npc_
 */

/**
 * Substitute expressions with in-line rolls
 * @param {string} text - text to process
 * @param {insertRollsOptions} [options={}] - options
 * @returns {string}
 */
function insertRolls(text, options = {}) {
  if (!text)
    return "";
  
  const { pathNames = "", useNPC = false } = options;
  const devol = `@{${ useNPC ? "target|" : "" }devol}` ;

  // Search for " [#d4° + XXX] " or " [#dE + XXX] "
  matchRegExp(text, /([ ]*)\[([1-9])d(4°|E)[ ]*\+[ ]*(AGI|CON|FOR|PER|CHA|INT|VOL|rang voie [1-9])\]([ ]*)/gm).forEach(result => {
    let [ matched, sb, dice, , ability, sa ] = result;
    if (ability.startsWith("rang "))
      ability = `rang_voie${ findPathByName(ability, pathNames) }`;
    const replace = `${sb}[[${dice}${devol} + @{${ability.toLowerCase()}}[${ability}] ]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for "... #d4° ..." or "... #dE ..."
  matchRegExp(text, /([ ]*)([1-9])d(4°|E)([ ])*/gm).forEach(result => {
    const [ matched, sb, dice, , sa ] = result;
    const replace = `${sb}[[${dice}${devol}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for " [# + XXX] "
  matchRegExp(text, /([ ]*)\[([0-9]+)[ ]*\+[ ]*(AGI|CON|FOR|PER|CHA|INT|VOL|rang voie [1-9])\]([ ]*)/gm).forEach(result => {
    let [ matched, sb, value, ability, sa ] = result;
    if (ability.startsWith("rang ")) {
      ability = `rang_voie${ findPathByName(ability, pathNames) }`;
    }
    const replace = `${sb}[[${value} + @{${ability.toLowerCase()}}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for " [XXX] "
  matchRegExp(text, /([ ]*)\[(AGI|CON|FOR|PER|CHA|INT|VOL)\]([ ]*)/gm).forEach(result => {
    let [ matched, sb, ability, sa ] = result;
    const replace = `${sb}[[@{${ability.toLowerCase()}}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for "... #d# +/- M..."
  matchRegExp(text, /([0-9]+[dD][0-9]+)([ ]*[\+\-]*[ ]*[0-9]*)?/gm).forEach(result => {
    const [ matched, dice, mod ] = result;
    const replace = `[[${dice}${mod || ""}]]`;
    text = text.replace(matched, replace);
  });
  
  return text;
}

/**
 * Numbering attacks
 */
on("change:repeating_armes:arme-nom clicked:renum_atk-btn", function(eventInfo) {
  const renumber = (eventInfo.triggerName === "clicked:renum_atk-btn");
  getSectionIDsOrdered("repeating_armes", function (rowIds) {
    const labels = rowIds.map(id => `repeating_armes_${id}_arme-label`);
    getAttrs([ "max_attack_label", ...labels ], function (values) {
      const maxLabel = intval(values.max_attack_label);
      delete values.max_attack_label;
      let numLabel = renumber ? 0 : maxLabel;
      const updates = new Map();
      Object.keys(values).forEach(label => {
        if (renumber || intval(values[label]) === 0)
          updates.set(label, ++numLabel);
      });
      if (renumber || numLabel > maxLabel)
        updates.set("max_attack_label", numLabel);
      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  });
});

/**
 * Display attack options row
 */
on("clicked:repeating_armes:armeopt-btn", function() {
  getAttrs(["repeating_armes_armeopt"], function(values) {
    const option = 1 - intval(values.repeating_armes_armeopt);
    setAttrs({ repeating_armes_armeopt: option });
  });
});

/**
 * Roll an attack in chat
 */
on("clicked:repeating_armes:attack-btn", function() {
  const section = "repeating_armes_arme-"
  const attackAttrs = [
    "nom",
    "atk",
    "atkdiv",
    "crit",
    "2m",
    "dm",
    "dmtype",
    "bonus",
    "dmdiv",
    "portee",
    "special",
    "atkmods",
  ];
  const sitModAttrs = [
    "couvert",
    "melee",
    "contact",
    "visibilite"
  ];
  getAttrs([
    "cfg_crit_diff", 
    "bouclier_eqp",
    "condition_affaibli",
    "tactique",
    "tactdiv",
    "tactdmdiv",
    "noms_voies",
    ...sitModAttrs.map(a => `modsit_${a}`),
    ...attackAttrs.map(a => `${section}${a}`) 
  ], function (values) {
    
    // general options
    const useCritDiff = intval(values.cfg_crit_diff);
    const shieldUsed = boolval(values.bouclier_eqp);
    const tactics = intval(values.tactique);
    const tactBM = intval(values.tactdiv);
    const tactDM = strval(values.tactdmdiv);
    const weakened = intval(values.condition_affaibli);
    const pathNames = strval(values.noms_voies);
    
    // situational modifiers
    const modCover = intval(values.modsit_couvert) * -1;
    const modMelee = intval(values.modsit_melee) * -1;
    const modContact = intval(values.modsit_contact);
    const modVisible = intval(values.modsit_visibilite) * -1;
    
    // attack parameters
    const atk = strval(values[section + "atk"]);
    const atkdiv = intval(values[section + "atkdiv"]);
    const name = capitalize(strval(values[section + "nom"], getAttackName(atk)));
    const portee = strval(values[section + "portee"]);
    const range = (portee !== "") ? ` (${portee})` : "";
    const crit = intval(values[section + "crit"], 20);
    const isRanged = (atk === "atktir" && portee !== "");
    const modifiers = strval(values[section + "atkmods"]).split(",").map(mod => mod.trim().toLowerCase());

    // 2 mains & bouclier 
    const twoHanded = boolval(values[section + "2m"]);
    if (twoHanded && shieldUsed) {
      sendChatMsg(cof2RollTemplate({
        lsub: "Attaque",
        rsub: name + range,
        text: `@{character_name} ne peut pas manier ${name} avec son bouclier équipé !`,
        textclass: "fumble"
      }));
      return;
    }

    // Special tactics
    let tacticBonus = "";
    let tacticDM = "";
    switch (tactics) {
      case 1:
        tacticBonus = " +5[Attaque assurée]";
        break;
      case 2:
        tacticBonus = " -3[Att. précise/violente]";
        tacticDM = " +1@{devol}[Att. précise/violente]";
        break;
      case 3:
        tacticBonus = " -7[Att. précise/violente]";
        tacticDM = " +2@{devol}[Att. précise/violente]";
        break;
      case 4:
        tacticBonus = ` + (${tactBM})[Option tactique]`;
        if (tactDM !== "")
          tacticDM = " + (" + tactDM.replace(/d(4°|E)/, "@{devol}") + ")[Option tactique]";
        break;
    }

    // Build situational modifiers
    let modSit = "";
    if (isRanged) {
      modSit += modCover !== 0 ? ` ${modCover}[Cible à ouvert]` : "";
      modSit += modMelee !== 0 ? ` ${modMelee}[Cible en mêlée]` : "";
      modSit += modVisible !== 0 ? ` ${modVisible}[Visibilité]` : "";
    }

    // Determine normal or malus die roll
    let roll = (weakened === 1) ? "2d20kl1" : "1d20";
    let bRoll = (weakened !== 1);
    if (isRanged && modContact === 1)
      roll = "2d20kl1";
    if (modifiers.includes("debonus") && !modifiers.includes("demalus")) {
      switch(roll) {
        case "2d20kl1":
          roll = "1d20";
          bRoll = false;
          break;
        case "1d20":
          roll = "2d20kh1";
          break;
      }
    }
    if (modifiers.includes("demalus") && !modifiers.includes("debonus")) {
      switch(roll) {
        case "1d20":
          roll = "2d20kl1";
          break;
        case "2d20kh1":
          roll = "1d20";
          bRoll = false;
          break;
      }
    }
    
    let fumble = "1";

    let powder = "";
    if (modifiers.includes("poudre")) {
      powder = "La poudre explose et inflige [[1@{devol}]] DM";
      fumble = "<2";
    }

    // Attack roll
    let attack = "";
    if (atk !== "0")
      attack = `[[${roll}cs>${crit}cf${fumble}[Dé] + @{${atk}}[Bonus] + ${atkdiv}[Divers]${tacticBonus}${modSit} ]]`;
    
    // Damage roll
    let [ dm, ...dmextra ] = strval(values[section + "dm"]).split(" ");
    dm = dm.replace("d4°", "@{devol}");
    if (dm.includes("/")) {
      const [ dm1m, dm2m ] = dm.split("/");
      dm = shieldUsed ? dm1m : `?{Maniée à|Une main,${dm1m}|Deux mains,${dm2m}}`;
    }
    
    const dmtype = strval(values[section + "dmtype"]);
    const dmdesc = [ dmtype, ...dmextra ].join(" ").trim();
    const dmbonus = strval(values[section + "bonus"]);
    const dmdiv = strval(values[section + "dmdiv"]);

    let dmOpt = "";
    if (modifiers.includes("explodemax"))
      dmOpt += "!";
    if (modifiers.includes("reroll1"))
      dmOpt += "r";

    let dmroll = "";
    if (dm !== "" )
      dmroll = `[[${dm}${dmOpt}]][DM] + ${dmbonus}[Bonus] + ${dmdiv}[Divers]${tacticDM}`;
    if (dmroll !== "" && tactics === 1)
      dmroll = `floor((${dmroll})/2)`;
    if (dmroll !== "")
      dmroll = `[[${dmroll} ]]`;

    const special = insertRolls(strval(values[section + "special"]), { pathNames });

    // Determine Max DMs
    let dmMax = 0;
    const result = dm.match(/([0-9]*)[dD]([0-9]*)/);
    if (result) {
      let [ matched, dice, faces ] = result;
      if (matched) {
        if (!dice)
          dice = 1;
        dmMax = intval(dice) * intval(faces);
      }
    }

    // Special critical success
    let dmcrit = "";
    if (useCritDiff === 1) {
      switch (dmtype) {
        case "contondants":
          dmcrit = `[[${dmMax}]] DM et cible étourdie au prochain round`;
          break;
        case "perforants":
          if (dice && faces)
            dmcrit = `[[${dice * 2}d${faces}]] DM + hémorragie : [[1@{devol}]] DM/round pendant 4 rounds`;
          break;
        case "tranchants":
          dmcrit = `[[${dmMax}]] DM et hémorragie : [[1@{devol}]] DM/round pendant 4 rounds`;
          break;
      }
    }

    // Roll attack !
    const atkProps = {
      lsub: "Attaque",
      rsub: name + range,
      roll: attack,
      broll: "",
      dm: dmroll,
      dmdesc,
      critdiff: `[[${useCritDiff}]]`,
      dmcrit,
      powder,
      text: special
    };
    if (roll === "1d20" && bRoll)
      atkProps.broll = attack;
    const chatMsg = cof2RollTemplate(atkProps);
    sendChatMsg(chatMsg);
  })
});

/**
 * Display ability text with alert on usage
 * @param {number} path - Path #
 * @param {number} rank - Rank #
 */
function actionAbility(path, rank) {
  const abilityAttrs = [
    `voie${path}nom`,
    `voie${path}-t${rank}`,
    `voie${path}-${rank}`,
    `v${path}r${rank}`,
    `v${path}r${rank}_spell`,
    `v${path}r${rank}_use`,
    `v${path}r${rank}_use_max`,
    `v${path}r${rank}_freq`,
    "pm"
  ];
  getAttrs(abilityAttrs, function(values) {
    const [ path, ability, desc, owned, spell, used, uses, freq ] = Object.keys(values);
    const pathName = strval(values[path]);
    const abilityName = strval(values[ability]);
    const abilityOwned = intval(values[owned]);
    const abilitySpell = intval(values[spell]);
    let description = strval(values[desc]);
    if (abilityName === "")
      return;

    const nbUsed = intval(values[used]) + 1;
    const maxUses = intval(values[uses]);
    const usage = strval(values[freq]);

    const updates = new Map();
    
    // alert on usage
    let alert = "";
    let textclass = "";
    if (maxUses !== 0) {
      if (nbUsed > maxUses) {
        alert = `Déjà utilisée ${maxUses} fois / ${usage.toLowerCase()}`;
        description = "";
        textclass = "fumble";
      } else {
        alert = `Utilisée ${nbUsed} fois`;
      }
    }

    // alert on spells & PM
    if (abilityOwned === 1 && abilitySpell === 1) {
      let pm = intval(values.pm);
      if (rank > pm) {
        alert = "Plus assez de Points de Mana\n";
        alert = `${pm} restants pour ${rank} nécessaires\n`;
        alert += `Brûlure de Mana : [[${rank - pm}d@{drecup}]] PV perdus\n`
        textclass = "fumble";
      } else {
        pm -= rank;
        alert = `${pm} Points de Mana restants`;
        updates.set("pm", pm);
      }
    }

    // build text
    let text = insertRolls(description);
    if (alert !== "")
      text += "\n" + alert

    // send to chat
    const chatMsg = cof2RollTemplate({
      lsub: `${pathName} - ${rank}`,
      rsub: abilityName,
      text,
      textclass
    });
    sendChatMsg(chatMsg);
    
    // Update usages
    if (maxUses > 0 && nbUsed <= maxUses)
      updates.set(used, nbUsed);
    
    // Update attributes
    if (updates.size > 0)
      setAttrs(Object.fromEntries(updates));
  });
}

/**
 * Update the list of special capabilities
 * @param {string} name - name of ability
 * @param {number} owned - owend ability 0/1 
 * @param {string} capabilities - comma-separated of special capabilities
 * @returns {string}
 */
function processCapabilities(name, owned, capabilities) {
  name = name.replace(/ /gm, "").toLowerCase();
  if (SWData.PC.CAPABILITIES.includes(name)) {
    capabilities += ((capabilities !== "") ? "," : "") + name;
    if (!owned) {
      capabilities = capabilities.split(",").filter(cp => cp !== name).join(",");
    }
  }
  return capabilities;
}

/**
 * Update rank in path
 * @param {number} path - Path #
 */
function setRank(path) {
  rankAttrs = [
    "capabilities",
    ...seq(5).map(rank => `v${path}r${rank}`),
    ...seq(5).map(rank => `voie${path}-t${rank}`)
  ];
  getAttrs(rankAttrs, function (values) {
    let rank = 0;
    let capabilities = strval(values.capabilities);
    delete values.capabilities;
    Object.keys(values).filter(a => !a.startsWith("voie")).forEach(ability => {
      const owned = intval(values[ability]);
      const hasRank = intval(ability.charAt(ability.length - 1)) * owned;
      if (hasRank > rank)
        rank = hasRank;
      const name = values[`voie${path}-t${ ability.charAt(ability.length - 1) }`];
      capabilities = processCapabilities(name, owned, capabilities);
    });
    setAttrs({ [`rang_voie${path}`]: rank, capabilities });
  });
}

/**
 * Update the all ranks attribute
 * @param {number} path - path number changed
 */
function updateAllRanks(path) {
  getAttrs([ `rang_voie${path}`, `v${path}br`, "rangs_voies" ], function(values) {
    const [ rankPath, rankBase ] = Object.keys(values);
    let rank = intval(values[rankPath]);
    const base = intval(values[rankBase]);
    const ranks = strval(values.rangs_voies);
    let allRanks = Array(9);
    if (ranks !== "")
      allRanks = ranks.split(",").map(r => intval(r));
    if (rank > 0 && base > 1)
      rank += base - 1;
    allRanks[path - 1] = rank;
    setAttrs({ rangs_voies: allRanks.join(",") });
  });
}

/**
 * Update the all names attribute
 * @param {number} path - path number changed
 */
function updateAllPathNames(path) {
  getAttrs([ `voie${path}nom`, "noms_voies" ], function(values) {
    const [ pathName ] = Object.keys(values);
    const name = strval(values[pathName]);
    const names = strval(values.noms_voies);
    let allNames;
    if (names !== "") {
      allNames = names.split("|").map(n => strval(n));
    } else {
      allNames = Array(9).fill("");
    }
    allNames[path - 1] = name;
    setAttrs({ noms_voies: allNames.join("|") });
  });
}

/**
 * Abilities
 */
seq(9).forEach(path => {
  seq(5).forEach(rank => {
    
    // Handle ability buttons click
    on(`clicked:v${path}r${rank}-btn`, function() {
      actionAbility(path, rank);
    });

    // Update rank in path
    on(`change:v${path}r${rank}`, function() {
      setRank(path);
    });
  });

  // Update all ranks attribute
  on(`change:rang_voie${path} change:v${path}br`, function () {
    updateAllRanks(path);
  });

  // Update all path names attribute
  on(`change:voie${path}nom`, function () {
    updateAllPathNames(path);
  });
});

/**
 * On click of reset abilities usage button
 */
on("clicked:reset_uses-btn", function() {
  const abilityUsage = [];
  seq(9).forEach(v => {
    seq(5).forEach(r => {
      abilityUsage.push(`v${v}r${r}`);
      abilityUsage.push(`v${v}r${r}_use`);
      abilityUsage.push(`v${v}r${r}_freq`);
    });
  });

  getAttrs(abilityUsage, function(values) {
    const freqs = [ "Aucune" ];
    const owned = new Map();
    const abilities = [];

    // build lists of frequencies & usages
    for (const attribute in values) {
      if (values[attribute] === "")
        continue;
      const [ ability, attr ] = attribute.split("_");
      if (!attr) {
        if (intval(values[attribute]) === 1)
          owned.set(ability, 0);
        continue;
      } else if (attr === "use") {
        if (owned.has(ability))
          owned.set(ability, intval(values[attribute]));
        continue;
      }
      if (!owned.has(ability) || owned.get(ability) === 0)
        continue;
      const freq = capitalize(values[attribute]);
      if (!freqs.includes(freq)) {
        freqs.push(freq);
        abilities[freq] = [];
      }
      abilities[freq].push(ability);
    }

    // Nothing to process
    if (freqs.length === 1) {
      const chatMsg = cof2RollTemplate({
        lsub: "Capacités",
        rsub: "Utilisations",
        text: "Aucune capacité avec nombre d'utilisations à recharger"
      });
      sendChatMsg(chatMsg);
      return;
    }

    // Ask for which abilities to reset
    ask([ "Capacités ?", ...freqs ], function(selected, choices) {
      const freq = choices[selected];
      const titles = abilities[freq].map(a => `voie${ a.charAt(1) }-t${ a.charAt(3) }`);
      const usages = abilities[freq].map(a => `v${ a.charAt(1) }r${ a.charAt(3) }_use_max`);
      getAttrs([ ...titles, ...usages ], function(values) {
        let text = "";
        Object.keys(values).filter(k => k.endsWith("_use_max")).forEach(k => {
          const title = values[`voie${ k.charAt(1) }-t${ k.charAt(3) }`];
          const usage = intval(values[k]);
          text += title + " : " + usage + ` utilisation${ usage > 1 ? "s" : ""}\n`;
        });
        const chatMsg = cof2RollTemplate({
          lsub: "Capacités",
          rsub: `Par ${freq}`,
          text
        });
        sendChatMsg(chatMsg);
        const reset = {};
        abilities[freq].forEach(ability => {
          reset[ability + "_use"] = 0;
        });
        setAttrs(reset);
      });
    });
  });
});

/**
 * Scan abilities for usage in description
 */
function abilityUsages() {
  const abilities = [];
  seq(9).forEach(v => {
    seq(5).forEach(r => {
      abilities.push(`voie${v}-${r}`);
      abilities.push(`v${v}r${r}_freq`);
    });
  });
  getAttrs(abilities, function (values) {
    const updateAbilities = new Map();
    const rx = new RegExp("([U|u]ne|[D|d]eux|[T|t]rois) fois par ([A-Za-z]+)","gm");
    Object.keys(values).filter(v => v.endsWith("_freq")).forEach(value => {
      if (strval(values[value]) !== "")
        return; // already has a usage freq

      const [ ability ] = value.split("_");
      const abilityDesc = `voie${ ability.charAt(1) }-${ ability.charAt(3) }`;
      const description = strval(values[abilityDesc]);
      if (description === "")
        return; // no description found

      const matches = [ ...description.matchAll(rx) ];
      if (matches.length === 0)
        return; // no regex match

      const [ , use, freq ] = matches[0];
      if ([ "round", "tour" ].includes(freq.toLowerCase())) 
        return; // no per round usage

      const useMax = [ "une", "deux", "trois" ].indexOf(use.toLowerCase()) + 1;
      if (useMax > 0) {
        updateAbilities.set(`${ability}_use_max`, useMax);
        updateAbilities.set(`${ability}_freq`, freq);
      }
    });
    if (updateAbilities.size > 0)
      setAttrs(Object.fromEntries(updateAbilities));
  }); 
}

/**
 * Build a roll query for ability selection
 * @returns {string}
 */
function abilityRollQuery() {
  return "?{Carac ?|" 
  + SWData.PC.ABILITIES
  .map(a => `${ a.substring(0,3).toUpperCase() },@{${ a.substring(0,3) }}`)
  .join("|")
  + "}";
}

/**
 * On ability roll button click
 */
on("clicked:repeating_rolls:roll-btn", function() {
  const section = "repeating_rolls_roll-";
  const rollAttrs = [
    "nom",
    "cmd",
    "type",
    "carac",
    "voie",
    "bonus"
  ].map(attribute => `${section}${attribute}`);
  getAttrs([ "rangs_voies", "noms_voies", ...rollAttrs ], function (values) {
    const rollName = strval(values[section + "nom"]);
    const type = strval(values[section + "type"]);
    let carac = strval(values[section + "carac"]);
    let path = intval(values[section + "voie"]);
    const bonus = intval(values[section + "bonus"]);
    let rollCmd = strval(values[section + "cmd"]);

    const ranks = values.rangs_voies.split(",").map(r => intval(r));
    const names = values.noms_voies.split("|").map(r => strval(r));

    let lsub = "Compétence";
    let text = "";

    if (type !== "0") {
      text = insertRolls(rollCmd, { pathNames: names });
      let carTip = "";
      // d20
      rollCmd = `${type}[Dés]`;
      // + Carac
      if (carac !== "") {
        if (carac === "?") {
          carac = abilityRollQuery();
        } else {
          carTip = `[${ carac.substring(2,2+3).toUpperCase() }]`;
        }
        rollCmd += ` + (${carac})${carTip}`
      }
      // + Rang
      if (path > 0) {
        rollCmd += ` + (${ranks[path - 1]})[Rang ${names[path - 1]}]`;
        lsub = "Capacité";
      }
      // + Bonus
      if (bonus !== 0)
        rollCmd += ` + (${bonus})[Bonus]`;
      // in-line
      rollCmd = "[[" + rollCmd + " ]]"
    } else {
      lsub = "Jet";
      rollCmd = insertRolls(rollCmd, { pathNames: names });
    }

    // Send to chat
    const chatMsg = cof2RollTemplate({
      lsub,
      rsub: rollName,
      roll: rollCmd,
      text
    });
    sendChatMsg(chatMsg);
  });
})

/**
 * On skill 'button' click
 */
SWData.PC.SKILLS.forEach(skill => {
  on(`clicked:skill-${skill.name}`, function () {
    const skillName = (skill.label !== "") ? skill.label : capitalize(skill.name);
    const skillAttrs = [ "carac", "bonus" ].map(a => `${skill.name}_${a}`);
    getAttrs(skillAttrs, function (values) {
      const [ carac, bonus ] = Object.keys(values);
      let caracBonus = strval(values[carac]);
      const skillBonus = intval(values[bonus]);

      let rollCmd = "1d20cs20cf1[Dés]";

      let carTip = "";
      if (caracBonus === "?") {
        caracBonus = abilityRollQuery();
      } else {
        carTip = `[${ caracBonus.substring(2,2+3).toUpperCase() }]`;
      }
      rollCmd += ` + (${caracBonus})${carTip}`

      if (skillBonus !== 0)
        rollCmd += ` + (${skillBonus})[Bonus ${skillName}]`;

      rollCmd = "[[" + rollCmd + " ]]";

      // Send to chat
      const chatMsg = cof2RollTemplate({
        lsub: "Compétence",
        rsub: skillName,
        roll: rollCmd,
        broll: rollCmd
      });
      sendChatMsg(chatMsg);
    });
  });
});

/**
 * Rebuild buffable attributes xxx_buff_list
 */
function rebuildBuffLists() {
  const section = "repeating_buffs";
  getSectionIDs("buffs", function (rowIds) {
    const buffs = Object.fromEntries(new Map(
      SWData.PC.BUFFS.To.map(attr => [ `${attr}_buff_list`, "" ])
    ));
    const allBuffs = [];
    rowIds.forEach(id => {
      [ "on", "nom", "attrib", "value" ]
        .map(attr => `${section}_${id}_buff-${attr}`)
        .forEach(a => {
        allBuffs.push(a);
      });
    });
    getAttrs(allBuffs, function(values) {
      rowIds.forEach(id => {
        const rowId = `${section}_${id}_buff-`;
        const enabled = intval(values[`${rowId}on`]);
        const name = strval(values[`${rowId}nom`]);
        const attribute = `${strval(values[`${rowId}attrib`])}_buff_list`;
        const value = strval(values[`${rowId}value`]);
        if (enabled === 1 && name !== "" && value !== "") {
          const buffList = buffs[attribute] + `${name} : ${value}; `;
          buffs[attribute] = buffList;
        }
      });
      setAttrs(buffs);
    });
  });
}

/**
 * On change of repeating buffs
 */
on("change:repeating_buffs remove:repeating_buffs", function () {
  rebuildBuffLists();
});

/**
 * Parse an attribute's list of buffs (stored in xxx_buff_list)
 * @param {string} attribute - attribute name 
 */
function parseBuffList(attribute) {
  getAttrs([ `${attribute}_buff_list`, ...SWData.PC.BUFFS.From ], function(values) {
    const [ buff ] = Object.keys(values);
    const buffList = strval(values[buff]).split("; ");
    const allRanks = values.rangs_voies.split(",");
    let buffTotal = 0;
    buffList.forEach(buff => {
      if (buff.trim() === "")
        return;
      let value = 0;
      const [ , expression ] = buff.split(":").map(e => e.trim());
      const attrBuff = SWData.PC.BUFFS.From.find(a => `[${a}]` === expression.toLowerCase());
      if (attrBuff) {
        value = intval(values[attrBuff]);
      } else {
        const result = expression.match(/rang[ ]*voie[ ]*([1-9])/i);
        if (result) {
          const [ matched, path ] = result;
          if (matched && intval(path) > 0)
            value = intval(allRanks[intval(path) - 1]); 
        } else {
          if (expression.startsWith("!")) {
            try {
              value = intval(eval(expression.slice(1)));
            } catch (ex) {
              clog("Erreur JS");
            }
          } else {
            value = intval(expression);
          }
        }
      } 
      buffTotal += value;
    });
    setAttrs({ [`${attribute}_buff`]: buffTotal });
  });
}

/**
 * On change of a list of buffs
 */
SWData.PC.BUFFS.To.forEach(attribute => {
  on(`change:${attribute}_buff_list`, function() {
    parseBuffList(attribute);
  });
});

/**
 * Recalculate all buffs values
 */
function rebuildBuffValues() {
  SWData.PC.BUFFS.To.forEach(attribute => {
    parseBuffList(attribute);
  });
}

/**
 * Recalculate total encumbrance
 */
function encumbrance() {
  const section = "repeating_equipement";
  getSectionIDs("equipement", function (rowIds) {
    const allEquip = [];
    rowIds.forEach(id => {
      [ "on", "qte", "enc" ]
        .map(attr => `${section}_${id}_equip-${attr}`)
        .forEach(a => {
          allEquip.push(a);
        });
    });
    getAttrs([
      "cfg_use_encmb",
      "for",
      ...allEquip
    ], function(values) {
      const useEncumbrance = intval(values.cfg_use_encmb);
      const threshold = loadLimit(intval(values.for));
      let encumbrance = 0;
      let zeroValues = 0;
      rowIds.forEach(id => {
        const rowId = `${section}_${id}_equip-`;
        const used = intval(values[`${rowId}on`]);
        const count = intval(values[`${rowId}qte`]);
        const hasEnc = strval(values[`${rowId}enc`]);
        if (used === 0 || hasEnc === "")
          return;

        const value = intval(hasEnc);
        if (value > 0) {
          encumbrance += count * value;
        } else {
          zeroValues += count;
          if (zeroValues > 3) {
            encumbrance += Math.floor(zeroValues / 3);
            zeroValues %= 3;
          }
        }
      });

      const effects = [];
      if (encumbrance * useEncumbrance > threshold )
        effects.push("Essouflé-e et dé malus aux tests d'AGI");
      if (encumbrance * useEncumbrance > 2 * threshold )
        effects.push("Ralenti");
      if (encumbrance * useEncumbrance > 3 * threshold )
        effects.push("Immobilisé");
      if (effects.length > 0) {
        const text = "@{character_name} est encombré-e et subit les effets suivants :\n" 
        + (effects.length > 1 ? "- " : "")
        + effects.join("\n- ");
        const chatMsg = cof2RollTemplate({
          lsub: "Encombrement",
          rsub: "Limite dépassée",
          text
        });
        sendChatMsg(chatMsg);
      }

      setAttrs({ limite_enc: threshold, total_enc: encumbrance });
    });
  });
}

/**
 * On click on the gear props help button
 */
on("clicked:helpgear-btn", function() {
  sendChatMsg([
    "title=Propriétés d'équipement",
    "subtitle=Liste des codes et valeurs",
    "dm-1m:=Dés de DM une main",
    "dm-2m:=Dés de DM deux mains",
    "type-dm:=Types de dommages",
    "critique:=Seuil de critique",
    "portee:=Portée arme à distance",
    "bonus-def:=Bonus DEF de l'armure",
    "desc=Séparer les propriétés par des virgules"
  ], {
    template: "custom",
    whisper: "gm"
  });
});

/**
 * On change in equipement list
 */
on("change:repeating_equipement remove:repeating_equipement", function() {
  encumbrance();
});

on(eventList("change", [ 
  "on",
  "props",
  "atk"
].map(a => `repeating_equipement:equip-${a}`), " "), function (eventInfo) {
  getAttrs([
    "on",
    "nom",
    "detail",
    "props",
    "atk",
    "atkid"
  ].map(a => `repeating_equipement_equip-${a}`), function(values) {
    const [ on, name, detail, props, atk, atkid ] = Object.keys(values);
    //const equiped = intval(values[on]);
    const equipment = strval(values[name]);
    const description = strval(values[detail]);
    const properties = strval(values[props]);
    const hasAttack = intval(values[atk]);
    let attackId = strval(values[atkid]);

    const attributes = new Map();
    const attackRow = new Map();

    if (eventInfo.sourceAttribute.endsWith("equip-atk") && !hasAttack) {
      if (attackId) {
        removeRepeatingRow(`repeating_armes_${attackId}`);
        setAttrs({ ["repeating_equipement_equip-atkid"]: "" })
      }
      return;
    }

    properties.split(",").forEach(prop => {
      const { name, value } = parseNameValue(prop);

      if (name === "bonus-def") {
        attributes.set("armure", value);
        attributes.set("armure_malus", value);
        return;
      }
      
      attackRow.set(name, value);
    });

    if (eventInfo.sourceAttribute.endsWith("equip-atk") && hasAttack) {
      if (!attackId)
        attackId = generateRowID();

      attributes.set("repeating_equipement_equip-atkid", attackId);
      const rowId = "repeating_armes_" + attackId + "_arme-";
      attributes.set(rowId + "nom", equipment);
      const atk = attackRow.has("portee") ? "atktir" : "atkcac";
      attributes.set(rowId + "atk", atk);
      attributes.set(rowId + "crit", strval(attackRow.get("critique")));
      const dm1m = attackRow.has("dm-1m") ? strval(attackRow.get("dm-1m")) : "";
      const dm2m = attackRow.has("dm-2m") ? strval(attackRow.get("dm-2m")) : "";
      const dm = (dm1m !== "" && dm2m !== "") 
        ? dm1m + "/" + dm2m
        : (dm2m !== "") 
          ? dm2m
          : dm1m;
      if (dm === dm2m)
        attributes.set(rowId + "2m", 1);
      attributes.set(rowId + "dm", dm);
      attributes.set(rowId + "dmtype", strval(attackRow.get("dm-type")));
      attributes.set(rowId + "portee", strval(attackRow.get("portee")));
      attributes.set(rowId + "special", description);
    }

    if (attributes.size > 0)
      setAttrs(Object.fromEntries(attributes));
  });
});

/**
 * Rebuild all ranks in path
 */
function rebuildRanks() {
  const allPaths = [];
  seq(9).forEach(v => {
    allPaths.push([]);
    seq(5).forEach(r => {
      allPaths[v - 1].push(`v${v}r${r}`);
    });
  });
  const allRanks = allPaths.reduce((all, path) => {
    path.forEach(rank => {
      all.push(rank);
    });
    return all;
  }, []);
  const allBases = seq(9).map(v => `v${v}br`);
  getAttrs([ ...allRanks, ...allBases ], function(values) {
    const ranks = new Map();
    allPaths.forEach((path, v) => {
      const pathNum = v + 1;
      ranks.set(`rang_voie${pathNum}`, 0);
      path.forEach((rank, r) => {
        if (intval(values[rank]) === 1) {
          const rankInPath = intval(values[`v${pathNum}br`]) + r;
          ranks.set(`rang_voie${pathNum}`, rankInPath);
        }
      });
    });
    setAttrs(Object.fromEntries(ranks));
  });
}

/**
* On clicking the Reset button
*/
on("clicked:reset_all-btn", function() {
  updateDRMax();
  updatePMMax();
  updatePCMax();
  updateInit();
  updateDef();
  abilityUsages();
  encumbrance();
  rebuildRanks();
  rebuildBuffLists();
  rebuildBuffValues();
});

/**
 * On changing all high/low fantasy options
 */
on("change:cfg_highfan change:cfg_lowfan", function (eventInfo) {
  const { sourceAttribute } = eventInfo;
  getAttrs([ "cfg_highfan", "cfg_lowfan" ], function (values) {
    const checked = intval(values[sourceAttribute]);
    let options;
    switch (sourceAttribute) {
      case "cfg_highfan":
        options = [ "use_epic", "use_drniv", "use_mana" ];
        break;
      case "cfg_lowfan":
        options = [ "use_capped6", "use_dronly" ];
        break;
    }
    const subOptions = new Map(options.map(o => [ `cfg_${o}`, checked]));
    setAttrs(Object.fromEntries(subOptions));
  });
});

/**
 * Return an updated Map of attributes
 * @param {object} charData - character data
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map}
 */
function importProfile(charData, attributes) {
  if (charData.profile)
    attributes.set("profil", charData.profile);
  if (charData.family)
    attributes.set("famille", charData.family);
  
  let buff = [];
  switch (charData.familyId) {
    case "aventuriers":
      attributes.set("drecup", 8);
      buff = [ "Profil d'aventurier", "pc" ];
      break;
    
    case "combattants":
      attributes.set("drecup", 10);
      break;

    case "mages":
      attributes.set("drecup", 6);
      break;

    case "mystiques":
      attributes.set("drecup", 8);
      buff = [ "Profil de mystique", "dr" ];
      break;
  
    default:
      break;
  }

  if (buff.length > 0) {
    const rowId = `repeating_buffs_${ generateRowID() }_`;
    const [ name, attrib ] = buff;
    attributes.set(rowId + "buff-on", "1");
    attributes.set(rowId + "buff-nom", name);
    attributes.set(rowId + "buff-attrib", attrib);
    attributes.set(rowId + "buff-value", "1");
  }

  if (charData.paths[0].name !== "")
    attributes.set("peuple", charData.paths[0].name);

  charData.paths.forEach((path, ix) => {
    const pathNum = ix + 1
    attributes.set(`voie${ pathNum }nom`, path.name);
    path.abilities.forEach((rank, ix) => {
      rankNum = ix + 1;
      const type = rank.limitedUse !== "" ? rank.limitedUse : rank.actionType;
      attributes.set(`voie${pathNum}-t${rankNum}`, rank.name + type);
      attributes.set(`voie${pathNum}-${rankNum}`, rank.description);
      attributes.set(`v${pathNum}r${rankNum}_spell`, (rank.spell === "*" ? "1" : "0"));
      attributes.set(`v${pathNum}r${rankNum}_use`, 0);
      attributes.set(`v${pathNum}r${rankNum}_use_max`, 0);
      attributes.set(`v${pathNum}r${rankNum}_freq`, "");
      if (rank.uses > 0) {
        const { number = 0, per = "" } = rank.uses;
        if (number > 0 && per !== "") {
          attributes.set(`v${pathNum}r${rankNum}_use_max`,number);
          attributes.set(`v${pathNum}r${rankNum}_freq`, per);
        }
      }
    });
  });

  return attributes;
}

/**
 * Process gears property of JSON blob
 * @param {object} gearData - gears property of PC data
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map} updated Map object
 */
function importGears(gearData, attributes) {

  gearData.forEach(gear => {
    const rowId = `repeating_equipement_${ generateRowID() }_`;

    attributes.set(rowId + "equip-nom", gear.designation);
    
    attributes.set(rowId + "equip-qte", gear.nombre);
    if (gear.special !== "") 
      attributes.set(rowId + "equip-detail", gear.special);
    
    const props = gear.props
      .filter(prop => SWData.GEARS.props.includes(prop.id))
      .map(prop => `${prop.id}: ${prop.valeur}`);
    if (props.length > 0)
      attributes.set(rowId + "equip-props", props.join(","));
  })

  return attributes;
}

/**
 * Click on button to display link to COMob Export in chat
 */
on("clicked:comob_export-btn", function () {
  sendChatMsg("[Export Chroniques Mobiles](https://comob-data.rpgapps.net)", { template: "" });
});

/**
 * On import JSON data button click
 */
on("clicked:import_json-btn", function () {
  getAttrs([ "json_profile", "reset_gears" ], function (values) {
    const jsonData = strval(values.json_profile).trim();
    if (jsonData === "")
      return;

    let attributes = new Map();

    const profileData = JSON.parse(jsonData);

    if (profileData.character)
      attributes = importProfile(profileData.character, attributes);

    if (profileData.gears) {
      const resetGears = intval(values.reset_gears);
      if (resetGears === 1)
        removeRepeatingAll("equipement");
      attributes = importGears(profileData.gears, attributes);
    }

    if (attributes.size > 0) {
      attributes.set("json_profile", "");
      setAttrs(Object.fromEntries(attributes));
    }
  });
});

/**
 * On change of debug mode state
 */
on("change:debug_mode", function() {
  getAttrs([ "debug_mode" ], function(value) {
    setDebugMode(value.debug_mode);
  });
});

/**
 * On help doc button click
 */
on("clicked:helpdoc-btn", function() {
  sendChatMsg("[Documentation](https://stephaned68.github.io/COF2e/)", { template: "" });
});

/**
 * Return CSS style for chat menu buttons
 * @param {string} color - PC color name
 * @returns {string}
 */
function menuButton(color) {
  color = color || "default";
  const [ backColor, textColor ] = SWData.COLORS[color];
  return "\" style=\"" + [
    "border: none",
    "border-radius: 3px",
    `background-color: ${backColor}`,
    `color: ${textColor}`,
    "padding: 2px",
    "margin: 1px",
    "font-size: 0.9em",
    "font-weight: bold"
  ].join("; ");
}

/**
 * Display stats rolls menu
 */
on("clicked:caract_menu-btn", function () {
  getAttrs([ "character_name", "couleur_pj" ], function (values) {
    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj);
    const chatMsg = SWData.PC.ABILITIES.map(ability => {
      const short = shorten(ability);
      return `${capitalize(ability)}=[${short.toUpperCase()}](~${charName}|${short}-btn${menuButton(color)})`
    });
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Jets de caractéristiques",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
});

/**
 * Display attack rolls menu
 */
on("clicked:attacks_menu-btn", function () {
  getSectionIDs("armes", function (rowIds) {
    const section = "repeating_armes_"
    const attackNames = rowIds.map(rowId => `${section}${rowId}_arme-nom`);
    getAttrs([ "character_name", "couleur_pj", ...attackNames ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj);
      const chatMsg = rowIds.map((rowId, ix) => `${ix + 1}. ${values[`${section}${rowId}_arme-nom`]}=[Jet](~${charName}|${section}${rowId}_attack-btn${menuButton(color)})`);
      if (chatMsg === 0)
        return;
      sendChatMsg([
        `title=${charName}`,
        "subtitle=Jets d'attaque",
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
});

/**
 * Paths menu
 */
on("clicked:abilities_menu-btn", function () {
  getAttrs([ "character_name", "couleur_pj", "rangs_voies", "noms_voies" ], function (values) {
    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj);
    const pathRanks = strval(values.rangs_voies).split(",");
    const pathNames = strval(values.noms_voies).split("|");
    const chatMsg = pathRanks.reduce((result, rank, ix) => {
      if (intval(rank) > 0)
        result.push(`${pathNames[ix]}=[Capacités](~${charName}|voie${ix + 1}_menu-btn${menuButton(color)})`);
      return result;
    }, []);
    if (chatMsg === 0)
      return;
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Voies",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
});

/**
 * Abilities menu
 */
seq(9).forEach(path => {
  on(`clicked:voie${path}_menu-btn`, function () {
    const abilities = seq(5).map(rank => `voie${path}-t${rank}`);
    getAttrs([ "character_name", "couleur_pj", "rangs_voies", "noms_voies", ...abilities ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj);
      const pathRank = intval(strval(values.rangs_voies).split(",")[path - 1]);
      const pathName = strval(strval(values.noms_voies).split("|")[path -1]);
      const chatMsg = seq(5).reduce((result, rank) => {
        if (rank <= pathRank) {
          const abilityName = values[`voie${path}-t${rank}`];
          result.push(`${abilityName}=[Jet](~${charName}|v${path}r${rank}-btn${menuButton(color)})`);
        }
        return result;
      }, []);
      if (chatMsg === 0)
        return;
      sendChatMsg([
        `title=${charName}`,
        "subtitle=Voie : " + pathName,
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
});

/**
 * Ability rolls menu
 */
on("clicked:rolls_menu-btn", function () {
  getSectionIDs("rolls", function (rowIds) {
    const section = "repeating_rolls_"
    const rollNames = rowIds.map(rowId => `${section}${rowId}_roll-nom`);
    getAttrs([ "character_name", "couleur_pj", ...rollNames ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj);
      const chatMsg = rowIds.map((rowId, ix) => `${ix + 1}. ${values[`${section}${rowId}_roll-nom`]}=[Jet](~${charName}|${section}${rowId}_roll-btn${menuButton(color)})`);
      if (chatMsg.length === 0)
        return;
      sendChatMsg([
        `title=${charName}`,
        "subtitle=Jets de Capacités",
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
});

/**
 * Skill rolls popup
 */
on("clicked:skills_menu-btn", function () {
  const skillProfs = SWData.PC.SKILLS.map((skill) => `${skill.name}_prof`);
  getAttrs([ "character_name", ...skillProfs ], function (values) {
    const charName = strval(values.character_name);
    const skillSelect = SWData.PC.SKILLS.map((skill, ix) => {
      const skillLabel = skill.label !== "" ? skill.label : capitalize(skill.name);
      const proficient = boolval(values[`${skill.name}_prof`]) ? "*" : "";
      return `${skillLabel}${proficient},${ix + 1}`;
    });
    ask([ "Compétence ?", ...skillSelect ], (skill, skills) => {
      const skillName = SWData.PC.SKILLS[skill -1].name;
      const action = "%{" + charName + "|skill-" + skillName + "}";
      startRoll(action, roll => {
        finishRoll(roll.rollId);
      });
    });
  });
});

/**
 * All rolls menu
 */
on("clicked:pc_menus-btn", function () {
  getAttrs([ "character_name", "couleur_pj", "use_skills" ], function (values) {
    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj);
    const menus = [ "caract:Caractéristiques", "attacks:Attaques", "abilities:Capacités", "rolls:Jets de Capacités" ];
    if (boolval(values.use_skills))
      menus.push("skills:Jets de Compétences");
    const chatMsg = menus.map(m => {
      const [ button, label ] = m.split(":");
      return `${label}=[Menu](~${charName}|${button}_menu-btn}${menuButton(color)})`;
    });
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Menus",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
});

// ================
// NPC SHEET EVENTS
// ================

/**
 * On NPC ability button click
 */
SWData.PC.ABILITIES.forEach(ability => {
  const short = shorten(ability);
  on(`clicked:pnj_${short}-btn`, function () {
    getAttrs([ `${short}_sup` ], function (value) {
      const [ dType ] = Object.keys(value);
      const roll = intval(value[dType]) === 1 ? "2d20kh1" : "1d20";
      const carac = `[[${roll}[Dé] + (@{${short}})[Bonus ${short.toUpperCase()}] ]] `;      
      const chatMsg = cof2RollTemplate({
        lsub: "Test",
        rsub: capitalize(ability),
        roll: carac
      });
      sendChatMsg(chatMsg);
    });
  });
});

/**
 * On NPC init button click
 */
on("clicked:pnj_init-btn", function () {
  const init = `[[@{init}[Initiative] + @{cfg_init_variable}[Dé(s)] &{tracker} ]]`;
  const chatMsg = cof2RollTemplate({
    lsub: "Jet",
    rsub: "Initiative",
    roll: init
  });
  sendChatMsg(chatMsg);
});

/**
 * Roll an NPC attack in chat
 */
on("clicked:repeating_npcarmes:npcatk-btn", function() {
  const section = "repeating_npcarmes_arme-"
  const attackAttrs = [
    "nom",
    "multi",
    "roll",
    "atk",
    "crit",
    "dm",
    "dmtype",
    "dmdiv",
    "portee",
    "special"
  ];
  getAttrs([ "cfg_crit_diff", ...attackAttrs.map(attribute => `${section}${attribute}`) ], function (values) {
    const useCritDiff = intval(values["cfg_crit_diff"]);
    const name = capitalize(strval(values[section + "nom"], "Attaque"));
    const use_multi = intval(values[section + "multi"]);
    const roll = strval(values[section + "roll"]);
    const atk = strval(values[section + "atk"]);
    const portee = strval(values[section + "portee"]);
    const range = (portee !== "") ? ` (${portee})` : "";
    const crit = intval(values[section + "crit"], 20);

    let multiAttacks = 1;
    if (use_multi === 1) {
      const result = name.match(/\(([0-9]*)[ ]*attaques\)/);
      if (result) {
        [ , multiAttacks ] = result;
      }
      if (intval(multiAttacks) <= 0 )
        multiAttacks = 1;
    }

    let attack = "";
    if (atk !== "0")
      attack = `[[${roll}cs>${crit}cf1[Dé] + ${atk}[Bonus] ]]`;
    
    let [ dm, ...dmextra ] = strval(values[section + "dm"]).split(" ");
    const dmtype = strval(values[section + "dmtype"]);
    const dmdesc = [ dmtype, ...dmextra ].join(" ").trim();
    const dmdiv = strval(values[section + "dmdiv"]);
    let dmroll = "";
    if (dm !== "" )
      dmroll = `[[[[${dm}]][DM] + ${dmdiv}[Divers] ]]`;
    
    const special = insertRolls(strval(values[section + "special"]), { useNPC: true });

    let dmMax = 0;
    const result = dm.match(/([0-9]*)[dD]([0-9]*)/);
    if (result) {
      let [ matched, dice, faces ] = result;
      if (matched) {
        if (!dice)
          dice = 1;
        dmMax = intval(dice) * intval(faces);
      }
    }

    let dmcrit = "";
    if (useCritDiff === 1) {
      switch (dmtype) {
        case "contondants":
        case "coup":
          dmcrit = `[[${dmMax}]] DM et cible étourdie au prochain round`;
          break;
        case "perforants":
        case "morsure":
          if (dice && faces)
            dmcrit = `[[${dice * 2}d${faces}]] DM + hémorragie : [[1@{devol}]] DM/round pendant 4 rounds`;
          break;
        case "tranchants":
        case "griffes":
          dmcrit = `[[${dmMax}]] DM et hémorragie : [[1@{devol}]] DM/round pendant 4 rounds`;
          break;
      }
    }

    let chatAtk = {
      lsub: "Attaque",
      rsub: name + range,
      roll: attack,
      broll: attack,
      dm: dmroll,
      dmdesc,
      critdiff: `[[${useCritDiff}]]`,
      dmcrit,
      text: special
    };

    for (let atk = 1; atk <= multiAttacks; atk++) {
      if (use_multi === 1)
        chatAtk = { ...chatAtk, lsub: `${atk}${ atk > 1 ? "ème" : "ère" } attaque` };
      const chatMsg = cof2RollTemplate(chatAtk);
      sendChatMsg(chatMsg);
    }
  })
});

/**
 * Roll an NPC ability in chat
 */
on("clicked:repeating_npcrolls:npcroll-btn", function() {
  const section = "repeating_npcrolls_npcroll-";
  getAttrs([ `${section}name`, `${section}desc` ], function (values) {
    const name = capitalize(strval(values[section + "name"], "Capacité"));
    const text = insertRolls(strval(values[section + "desc"]), { useNPC: true });
    const chatMsg = cof2RollTemplate({
      lsub: "Capacité",
      rsub: name,
      text
    });
    sendChatMsg(chatMsg);
  });
});

/**
 * Search abilities values in statblock text
 * @param {string} sbLine - line of text
 * @param {Map} npcAttrs - Map of attributes to update
 * @returns {Map} updated Map
 */
function importNPCAbilities(sbLine, npcAttrs) {
  SWData.PC.ABILITIES.forEach(ability => {
    const short = shorten(ability);
    const rx = new RegExp(` ${short.toUpperCase()} (.)([0-9]*)(\\*)? `);
    const match = sbLine.match(rx);
    if (!match) 
      return;
    let [ , sign, value, sup ] = match;
    value = intval(value);
    if (sign !== "+")
      value *= -1;
    sup = sup === "*" ? "1" : "0"
    npcAttrs.set(short, value)
    npcAttrs.set(short + "_sup", sup)
  });
  return npcAttrs;
}

/**
 * Parse an attack from a statblock line
 * @param {string} sbLine - line of text
 * @param {Map} npcAttrs - Map of attributes to update
 * @returns {Map} updated Map 
 */
function importNPCAttack(sbLine, npcAttrs) {
  const [ latk, ratk ] = sbLine.split(" DM ");
  
  let name = "";
  let bonus = "";
  lmatch = latk.match(/(.*?) ([\+\-][0-9]*)/);
  if (lmatch) {
    [ , name, bonus ] = lmatch;
    bonus = intval(bonus);
  }

  let dm = "";
  let dmdiv = "";
  let [ dmexpr, special ] = ratk.split(" + ");
  if (dmexpr) {
    dmatch = dmexpr.match(/([0-9]*[dD][0-9]*)[\-\+]([0-9]*)/);
    if (dmatch) {
      [ , dm, dmdiv ] = dmatch;
    }
  }

  special = strval(special);
  if (special !== "")
    special = " + " + special;
  
  const rowId = `repeating_npcarmes_${generateRowID()}_arme-`;
  npcAttrs.set(rowId + "nom", name);
  npcAttrs.set(rowId + "roll", "1d20");
  npcAttrs.set(rowId + "atk", bonus);
  npcAttrs.set(rowId + "crit", "20");
  npcAttrs.set(rowId + "dm", dm);
  npcAttrs.set(rowId + "dmtype", "tranchants");
  npcAttrs.set(rowId + "dmdiv", dmdiv);
  npcAttrs.set(rowId + "special", special);
  
  return npcAttrs;
}

/**
 * 
 */
on("clicked:importsb-btn", function() {
  
  // remove olds
  removeRepeatingAll("npcarmes");
  removeRepeatingAll("npcrolls");

  // add new
  getAttrs(["statblock"], function (value) {
    const statblock = strval(value.statblock).split("\n");
    if (statblock.length === 0)
      return;

    let npcAttrs = new Map();
    const abilities = [];
    let ability = "";

    let foundAttacks = false;
    let foundAbilities = false;
    
    statblock.forEach((sbLine, lineNum) => {
      
      // attacks
      if (sbLine.includes(" DM ") && !foundAbilities) {
        npcAttrs = importNPCAttack(sbLine, npcAttrs);
        foundAttacks = true;
        return;
      }
      
      if (foundAttacks) {
        // abilities
        if (sbLine.toUpperCase() === sbLine) {
          foundAbilities = true;
          if (ability !== "") {
            const [ name, action, description ] = ability.split("~");
            abilities.push({ name, action, description });
            ability = "";
          }
          let action = "";
          const match = sbLine.match(/ \(([GMAL])\)/);
          if (match) {
            let matched;
            [ matched , action ] = match;
            sbLine = sbLine.replace(matched, "");
          }
          sbLine = sbLine.split(":")[0].trim().toLowerCase();
          ability = capitalize(sbLine) + "~" + action + "~";
        } else {
          ability += sbLine + " ";
        }
      } else {
        // name & nc
        if (lineNum === 0) {
          match = sbLine.match(/(.*) \| NC ([0-9]*)/);
          if (match) {
            const [ , character_name, nc ] = match;
            npcAttrs.set("character_name", character_name);
            npcAttrs.set("niveau", nc);
          }
          return;
        }
        // creature type & size
        match = sbLine.match(/(CRÉATURE .*) .* TAILLE (.*)/);
        if (match) {
          const [ , creature, taille ] = match;
          if (creature)
            npcAttrs.set("creature", creature);
          if (taille)
            npcAttrs.set("taille", taille);
          return;
        }

        // défense
        match = sbLine.match(/\(S\) Défense ([0-9]*)/);
        if (match) {
          const [ , def ] = match;
          npcAttrs.set("def", def);
        }
        
        // pv
        match = sbLine.match(/\(V\) Points de vigueur ([0-9]*)([ ]\(RD ([0-9]*)\))?/);
        if (match) {
          const [ , pv, rd, rdValue ] = match;
          npcAttrs.set("pv", pv);
          npcAttrs.set("pv_max", pv);
          if (rd)
            npcAttrs.set("rd", rdValue);
        }

        // initiative
        match = sbLine.match(/\(I\) Initiative ([0-9]*)/);
        if (match) {
          const [ , init ] = match;
          npcAttrs.set("init", init);
        }

        npcAttrs = importNPCAbilities(sbLine, npcAttrs);
      }
    });
    if (ability !== "") {
      const [ name, action, description ] = ability.split("~");
      abilities.push({ name, action, description });
    }

    abilities.forEach(ability => {
      const rowId = `repeating_npcrolls_${generateRowID()}_npcroll-`;
      npcAttrs.set(rowId + "name", `${ability.name}${ ability.action !== "" ? " (" + ability.action + ")" : "" }`);
      npcAttrs.set(rowId + "desc", ability.description);
    });

    npcAttrs.set("statblock", "");
    setAttrs(Object.fromEntries(npcAttrs));
  });
});

// ====================
// SHEET INIT & UPDATES
// ====================

/**
 * Set/Unset Debug Mode
 * @param {string} debugMode - value of debug_mode attribute
 */
function setDebugMode(debugMode) {
  SWData.settings.debugMode = boolval(debugMode);
  clog(
    ` Running sheetworker... ${ SWData.settings.debugMode ? "DEBUG" : "PROD" } `,
    { 
      debug: false,
      textColor: "white",
      backColor: "brown"
    }
  );
}

/**
 * Apply sheet migrations
 * @param {string} sheetType - character sheet type
 * @param {object} curVer - current version
 * @returns {void}
 */
function migrateSheet(sheetType, curVer) {
  if (curVer.major === 1 && curVer.minor < 1)
    // migrateSheetV1_1(); // version 1.0 > 1.1
  
  return;
}

/**
 * Process character token
 * @param {Map} updates - Map of attributes to update
 * @param {object} values - attributes names/values pairs
 * @returns {Map} updated Map of attributes
 */
function getTokenURL(updates, values) {
  const url = strval(values.character_token);
  if (url !== "") {
    [ token_url ] = url.split("?");
    if (token_url)
      updates.set("token_url", token_url);
  }
  return updates;
}

/**
 * Rebuild all path info
 * @param {Map} updates - Map of attributes to update
 * @param {object} values - attributes names/values pairs
 * @returns {Map} updated Map of attributes
 */
function rebuildPathAll(updates, values) {
  const allRanks = [];
  const allNames = [];
  seq(9).forEach(p => {
    allRanks.push(values[`rang_voie${p}`]);
    allNames.push(values[`voie${p}nom`]);
  });
  updates.set("rangs_voies", allRanks.join(","));
  updates.set("noms_voies", allNames.join("|"));
  return updates;
}

/**
* Parse semantic version label
* @param {string} version
* @returns version object
*/
function parseSemVer(version) {
  version += ".0.0";
  if (version.toLowerCase().startsWith("v")) version = version.slice(1);
  const [ major, minor, patch ] = version.split(".");
  return { 
    major: intval(major),
    minor: intval(minor),
    patch: intval(patch),
  };
}

/**
 * On opening the sheet
 */
on("sheet:opened", function() {
  const pathAttrs = [
    ...seq(9).map(p => `rang_voie${p}`),
    ...seq(9).map(p => `voie${p}nom`),
  ];
  getAttrs([
    "version",
    "verfdp",
    "debug_mode",
    "scriptVersion",
    "scriptVersion_max",
    "character_token",
    "sheet_type",
    "profil",
    "famille",
    ...pathAttrs
  ], function (values) {

    setDebugMode(values.debug_mode);

    const sheetType = strval(values.sheet_type);
    const newVer = parseSemVer(values.verfdp);
    const curVer = parseSemVer(values.version);
    if (
      curVer.major < newVer.major ||
      curVer.minor < newVer.minor ||
      curVer.patch < newVer.patch
    ) {
      migrateSheet(sheetType, curVer);
    }

    let updates = new Map();
    
    updates = getTokenURL(updates, values);
    
    if (sheetType === SWData.SHEET_TYPE.PC) {
      const family = strval(values.famille);
      const profile = strval(values.profil);
      setProfilesList(family, profile);
      updates = rebuildPathAll(updates, values);
      rebuildBuffValues();
    }

    if (hasMODScript(values)) {
      updates.set("script_title", `COFantasy2 v${ strval(values.scriptVersion_max) }`);
    } else {
      updates.set("script_title", "Le script MOD COFantasy2 n'est pas installé...");
    }
    updates.set("script_show", hasMODScript(values) ? "1" : "0");

    if (values.version !== values.verfdp)
      updates.set("version", values.verfdp);
    setAttrs(Object.fromEntries(updates));
  });
});

</script>