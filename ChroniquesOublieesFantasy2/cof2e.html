<div class="cofmain">
  <!-- Nouvelle version fiche -->
  <input type="hidden" name="attr_verfdp" value="1.13.0">
  <!-- Version courante fiche -->
  <input type="hidden" name="attr_version" value="1.13.0">
  <!-- Mode debug -->
  <input type="hidden" name="attr_debug_mode" value="0">

  <!-- Token -->
  <input type="hidden" name="attr_token_url" value="">
  <input type="hidden" name="attr_token_dsp" value="">
  
  <!-- Jets -->
  <input type="hidden" name="attr_devol" value="d4">
  <input type="hidden" name="attr_last_rolls" value="">
  <input type="hidden" name="attr_last_maneuver" value="">
  <input type="hidden" name="attr_usure_check" value="">
  <input type="hidden" name="attr_next_roll" value="">
  <input type="hidden" name="attr_last_target" value="">

  <!-- Buffs caracs PJ -->
  <input type="hidden" name="attr_agi_buff" value="0">
  <input type="hidden" name="attr_con_buff" value="0">
  <input type="hidden" name="attr_for_buff" value="0">
  <input type="hidden" name="attr_per_buff" value="0">
  <input type="hidden" name="attr_cha_buff" value="0">
  <input type="hidden" name="attr_int_buff" value="0">
  <input type="hidden" name="attr_vol_buff" value="0">

  <!-- Buffs tests carac PJ -->
  <input type="hidden" name="attr_tagi_buff" value="0">
  <input type="hidden" name="attr_tcon_buff" value="0">
  <input type="hidden" name="attr_tfor_buff" value="0">
  <input type="hidden" name="attr_tper_buff" value="0">
  <input type="hidden" name="attr_tcha_buff" value="0">
  <input type="hidden" name="attr_tint_buff" value="0">
  <input type="hidden" name="attr_tvol_buff" value="0">

  <!-- Buffs combat PJ -->
  <input type="hidden" name="attr_atkcac_buff" value="0">
  <input type="hidden" name="attr_atkcac_cond" value="0">
  <input type="hidden" name="attr_atktir_buff" value="0">
  <input type="hidden" name="attr_atktir_cond" value="0">
  <input type="hidden" name="attr_atkmag_buff" value="0">
  <input type="hidden" name="attr_atkmag_cond" value="0">
  <input type="hidden" name="attr_init_base" value="10">
  <input type="hidden" name="attr_init_buff" value="0">
  <input type="hidden" name="attr_init_cond" value="0">
  <input type="hidden" name="attr_def_base" value="10">
  <input type="hidden" name="attr_def_car" value="AGI">
  <input type="hidden" name="attr_def_car_bonus" value="0">
  <input type="hidden" name="attr_def_car_max" value="0">
  <input type="hidden" name="attr_casque" value="0">
  <input type="hidden" name="attr_casque_malus" value="0">
  <input type="hidden" name="attr_def_buff" value="0">
  <input type="hidden" name="attr_def_cond" value="0">
  <input type="hidden" name="attr_dm_buff" value="">

  <!-- Buffs compteurs -->
  <input type="hidden" name="attr_pv_buff" value="0">
  <input type="hidden" name="attr_dr_base" value="2">
  <input type="hidden" name="attr_dr_buff" value="0">
  <input type="hidden" name="attr_pm_buff" value="0">
  <input type="hidden" name="attr_pc_base" value="2">
  <input type="hidden" name="attr_pc_buff" value="0">

  <!-- Buffs toutes caracs / toutes attaques -->
  <input type="hidden" name="attr_allcaracs_desc" value="">
  <input type="hidden" name="attr_allcaracs_buff" value="0">
  <input type="hidden" name="attr_allattacks_desc" value="">
  <input type="hidden" name="attr_allattacks_buff" value="0">

  <!-- Other hidden attributes -->
  <input type="hidden" name="attr_rangs_voies" value="">
  <input type="hidden" name="attr_noms_voies" value="">
  <input type="hidden" name="attr_noms_rangs" value="">
  <input type="hidden" name="attr_voies_rang3" value="0">
  <input type="hidden" name="attr_voies_rang4" value="0">
  <input type="hidden" name="attr_voies_rang5" value="0">
  
  <input type="hidden" name="attr_rang_voie1" value="1">
  <input type="hidden" name="attr_rang_voie2" value="1">
  <input type="hidden" name="attr_rang_voie3" value="1">
  <input type="hidden" name="attr_rang_voie4" value="0">
  <input type="hidden" name="attr_rang_voie5" value="0">
  <input type="hidden" name="attr_rang_voie6" value="0">
  <input type="hidden" name="attr_rang_voie7" value="0">
  <input type="hidden" name="attr_rang_voie8" value="0">
  <input type="hidden" name="attr_rang_voie9" value="0">

  <input type="hidden" name="attr_rang_cavalier" value="0">
    
  <!-- COFantasy MOD interaction -->
  <input type="hidden" name="attr_script_title" value="">
  <input type="hidden" name="attr_cofantasy" value="">

  <!-- Repeating labels -->
  <input type="hidden" name="attr_max_attack_label" value="">
  <input type="hidden" name="attr_max_actions1_label" value="">
  <input type="hidden" name="attr_max_actions2_label" value="">
  <input type="hidden" name="attr_max_actions3_label" value="">
  <input type="hidden" name="attr_max_actions4_label" value="">
  <input type="hidden" name="attr_max_actions5_label" value="">

  <!-- Rolls -->
  <input type="hidden" name="attr_d20roll" value="">

  <!-- PVIG = pv first in dropdown -->
  <input type="hidden" name="attr_PVIG" value="0">
  <input type="hidden" name="attr_PVIG_max" value="0">
  <input type="hidden" name="attr_healing" value="">

  <!-- Help action -->
  <input type="hidden" name="attr_help_roll" value="">
  <input type="hidden" name="attr_help_roll_all" value="">

  <!-- Ongoing effects -->
  <input type="hidden" name="attr_ongoing_actmod" value="">

  <!-- Charmancer
  <input type="hidden" name="attr_charmancer" value=""> -->

  <!-- Entête : Logo, Avatar, Identité -->
  <div class="heading">

    <!-- Logo COF -->
    <div>
      <img
        class="logo"
        title="Version 1.13.0 - 04/01/2026"
        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesFantasy2/cof2e_logo.jpg"
      />
      <input type="hidden" class="d20roll-btns" name="attr_cfg_d20roll" value="0">
      <div class="d20roll-btns d-flex m2">
        <input type="hidden" class="d20-toggle" name="attr_d20roll" value="1d20"/>
        <div>
          <span>Jet :</span>&nbsp;
          <button type="action" class="img-btn d20roll_db" name="act_d20roll_db-btn">
            <span class="img-btn">&</span>&nbsp;Dé bonus
          </button>
          <button type="action" class="img-btn d20roll_1d" name="act_d20roll_1d-btn">
            Normal
          </button>
          <button type="action" class="img-btn d20roll_dm" name="act_d20roll_dm-btn">
            <span class="img-btn">_</span>&nbsp;Dé malus
          </button>
        </div>
      </div>
    </div>

    <!-- Token -->
    <div>
      <img class="token" name="attr_character_token">
      <input type="hidden" class="token-mod" name="attr_tokenmod" value="0">
      <div class="d-flex d-flex-between token-mod">
        <button type="action" class="flat-btn img-btn" name="act_token_min-btn" title="%{token_min-btn} Diminuer la taille de 10%">
          <span class="img-btn">-</span>
        </button>
        <button type="action" class="flat-btn img-btn" name="act_token_def-btn" title="%{token_def-btn} Lier les barres du token">
          <span class="img-btn">2</span>
        </button>
        <button type="action" class="flat-btn img-btn" name="act_token_siz-btn" title="%{token_siz-btn} Forcer la taille">
          <span class="img-btn">`</span>
        </button>
        <button type="action" class="flat-btn img-btn" name="act_token_max-btn" title="%{token_max-btn} Augmenter la taille de 10%">
            <span class="img-btn">+</span>
        </button>
      </div>
    </div>

    <!-- Identité -->
    <div class="bordered border-rounded identity">
      <input type="hidden" class="cof-head-toggle" name="attr_sheet_type" value="pc"/> 

      <!-- Identité PJ -->
      <div class="identity-pc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name} Nom du personnage" value="">
          </div>
          <div><strong>Genre</strong></div>
          <div>
            <input type="text" name="attr_genre" title="@{genre}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Profil / Famille</strong></div>
          <div class="d-flex">
            <input type="text" name="attr_profil" list="pc-profiles" placeholder="Profil" title="@{profil} Profil" value="">
            <datalist id="pc-profiles"></datalist>
            <select class="select-lg" name="attr_famille" title="@{famille} Famille de profil">
              <option value="">Choisir...</option>
              <option>Aventuriers</option>
              <option>Combattants</option>
              <option>Mages</option>
              <option>Mystiques</option>
            </select>
          </div>
          <div><strong>Age</strong></div>
          <div>
            <input type="text" name="attr_age" title="@{age}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Peuple</strong></div>
          <div>
            <input type="text" name="attr_peuple" title="@{peuple}" value="">
          </div>
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_taille" title="@{taille}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Idéal héroïque</strong></div>
          <div>
            <input type="text" name="attr_ideal" title="@{ideal}" value="">
          </div>
          <div><strong>Poids</strong></div>
          <div>
            <input type="text" name="attr_poids" title="@{poids}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Travers</strong></div>
          <div>
            <input type="text" name="attr_travers" title="@{travers}" value="">
          </div>
          <div></div>
          <div></div>
        </div>

      </div>

      <!-- Identité PNJ -->
      <div class="identity-npc">

        <div class="identity-row">
          <div><strong>Nom</strong></div>
          <div>
            <input type="text" name="attr_character_name" title="@{character_name}" value="">
          </div>
          <div><strong>Genre</strong></div>
          <div>
            <input type="text" name="attr_genre" title="@{genre}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Type</strong></div>
          <div>
            <input type="text" name="attr_creature" list="creature-type" title="@{creature}" value="">
            <datalist id="creature-type">
              <option>Créature vivante</option>
              <option>Créature humanoïde</option>
              <option>Créature végétative</option>
              <option>Créature non vivante</option>
            </datalist>
          </div>
          <div><strong>Peuple</strong></div>
          <div>
            <input type="text" name="attr_peuple" title="@{peuple}" value="">
          </div>
        </div>

        <div class="identity-row">
          <div><strong>Taille</strong></div>
          <div>
            <input type="text" name="attr_taille" list="size-list" title="@{taille}" value="">
            <datalist id="size-list">
              <option>Minuscule</option>
              <option>Très petite</option>
              <option>Petite</option>
              <option>Moyenne</option>
              <option>Grande</option>
              <option>Enorme</option>
              <option>Colossale</option>
            </datalist>
          </div>
        </div>

      </div>

      <!-- Niveau & Type de fiche -->
      <div class="level-type">
        <div class="d-flex d-flex-middle">
          <strong>Niveau</strong>
        </div>
        <div class="d-flex d-flex-middle">
          <input type="number" name="attr_niveau" title="@{niveau}" value="0">
        </div>
        <div class="d-flex d-flex-middle">
          <strong>Type</strong>
          <select class="select-sm" name="attr_sheet_type">
            <option value="pc" selected>PJ</option>
            <option value="npc">PNJ</option>
          </select>
          <input type="hidden" name="attr_sheet_type">
          <button type="action" class="flat-btn img-btn" name="act_charmancer-btn" title="Lancer le Persomancien">
            <span class="img-btn">x</span>
          </button>
          <input type="hidden" name="attr_checkup-btn" value="">
          <button type="action" class="hidden" name="act_checkup-btn"/>
          <button type="roll" class="flat-btn img-btn" name="roll_checkup" title="%{checkup-btn} Etat du personnage" value="@{checkup-btn}">
            <span class="img-btn align-self-center">Y</span>
          </button>
        </div>
        <div class="d-flex d-flex-middle">
          <button type="action" class="flat-btn img-btn" name="act_alias-toggle">
            <span class="img-btn"></span><strong>Alias</strong>
          </button>
        </div>
        <div class="d-flex d-flex-middle">
          <input type="text" name="attr_alias" title="@{alias} Alias (vrai nom) du personnage&#10;Cliquer sur Alias pour remplacer le nom 'connu' du personnage par son alias" value="">
        </div>
      </div>
      
    </div>
  </div>

  <!-- Fiches -->
  <div class="cofsheet">
    <input type="hidden" class="cof-type-toggle" name="attr_sheet_type" value="pc"/>

    <button type="action" class="hidden" name="act_pc_actions-btn"></button>
    <button type="action" class="hidden" name="act_pc_menus-btn"></button>
    
    <button type="action" class="hidden" name="act_npc_actions-btn"></button>
    <button type="action" class="hidden" name="act_npc_menus-btn"></button>
    
    <button type="action" class="hidden" name="act_help_other-btn"></button>
       
    <!-- Fiche PJ -->
    <div class="cof-pc">
      <input type="hidden" class="tabs-toggle" name="attr_pc_tab" value="main" />
      <div>
        <button type="action" name="act_pc_main-btn" class="main-tab tab-btn pc-main-btn">ATTRIBUTS</button>
        <button type="action" name="act_pc_abilities-btn" class="main-tab tab-btn pc-abilities-btn">CAPACITES</button>
        <button type="action" name="act_pc_gears-btn" class="main-tab tab-btn pc-gears-btn">EQUIPEMENT</button>
        <button type="action" name="act_pc_notes-btn" class="main-tab tab-btn pc-notes-btn">NOTES</button>
        <button type="action" name="act_pc_config-btn" class="main-tab tab-btn pc-config-btn">CONFIGURATION</button>
        <button type="action" name="act_pc_script-btn" class="main-tab tab-btn pc-script-btn">SCRIPT</button>
        <button type="action" name="act_pc_version-btn" class="main-tab tab-btn pc-version-btn">VERSION</button>
      </div>

      <!-- Fiche PJ, Onglet Caracs -->
      <div class="pc-main-tab">

        <div class="pc-attributes">
  
          <!-- Caractéristiques -->
          <div class="traits">

            <div class="trait">
              <h4>
                <input type="hidden" name="attr_caract_select-btn" value="">
                <button type="action" class="hidden" name="act_caract_select-btn"/>
                <button type="roll" class="flat-btn img-btn" name="roll_caractselect" title="%{caract_select-btn} Choix d'une caractéristique" value="@{caract_select-btn}">
                  Carac
                </button>
                <input type="hidden" name="attr_caract_menu-btn" value="">
                <button type="action" class="hidden" name="act_caract_menu-btn"/>
                <button type="roll" class="flat-btn img-btn" name="roll_caractmenu" title="%{caract_menu-btn} Menu des caractéristiques" value="@{caract_menu-btn}">
                  <span class="img-btn">l</span>
                </button>
              </h4>
              <h4></h4>
              <h4>Base</h4>
              <h4>Mod</h4>
              <h4>Test</h4>
            </div>

            <!-- AGI -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_agi-btn"></button>
                <button type="action" class="block-title" name="act_agi_select-btn">
                  <span class="d20-btn">t</span>
                  AGI
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_agi_sup" title="@{agi_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_agi_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_agi_base" title="@{agi_base}" value="0">
              </div>
              <div class="centered bordered">
                <details class="trait-detail">
                  <input type="hidden" name="attr_agi" value="0">
                  <summary>
                    <span name="attr_agi" title="@{agi}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_agi_base" title="@{agi_base}"></span>
                  <br>
                  + Buff: <span class="trait-detail" name="attr_agi_buff" title="@{agi_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_agi_test" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_agi_test" title="@{agi_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_agi" title="@{agi}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_agi_tbuff" title="@{agi_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- CON -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_con-btn"></button>
                <button type="action" class="block-title" name="act_con_select-btn">
                  <span class="d20-btn">t</span>
                  CON
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_con_sup" title="@{con_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_con_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_con_base" title="@{con_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_con" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_con" title="@{con}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_con_base" title="@{con_base}"></span>
                  <br>
                  + Buff: <span class="trait-detail" name="attr_con_buff" title="@{con_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_con_test" title="@{con_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_con_test"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_con" title="@{con}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_con_tbuff" title="@{con_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- FOR -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_for-btn"></button>
                <button type="action" class="block-title" name="act_for_select-btn">
                  <span class="d20-btn">t</span>
                  FOR
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_for_sup" title="@{for_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_for_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_for_base" title="@{for_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_for" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_for" title="@{for}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_for_base" title="@{for_base}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_for_buff" title="@{for_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_for_test" title="@{for_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_for_test" title="@{for_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_for" title="@{for}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_for_tbuff" title="@{for_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- PER -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_per-btn"></button>
                <button type="action" class="block-title" name="act_per_select-btn">
                  <span class="d20-btn">t</span>
                  PER
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_per_sup" title="@{per_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_per_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_per_base" title="@{per_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_per" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_per" title="@{per}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_per_base" title="@{per_base}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_per_buff" title="@{per_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_per_test" title="@{per_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_per_test" title="@{per_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_per" title="@{per}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_per_tbuff" title="@{per_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- CHA -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_cha-btn"></button>
                <button type="action" class="block-title" name="act_cha_select-btn">
                  <span class="d20-btn">t</span>
                  CHA
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_cha_sup" title="@{cha_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_cha_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_cha_base" title="@{cha_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_cha" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_cha" title="@{cha}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_cha_base" title="@{cha_base}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_cha_buff" title="@{cha_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_cha_test" title="@{cha_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_cha_test" title="@{cha_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_cha" title="@{cha}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_cha_tbuff" title="@{cha_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- INT -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_int-btn"></button>
                <button type="action" class="block-title" name="act_int_select-btn">
                  <span class="d20-btn">t</span>
                  INT
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_int_sup" title="@{int_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_int_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_int_base" title="@{int_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_int" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_int" title="@{int}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_int_base" title="@{int_base}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_int_buff" title="@{int_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_int_test" title="@{int_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_int_test" title="@{int_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_int" title="@{int}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_int_tbuff" title="@{int_tbuff}"></span>
                </details>
              </div>
            </div>

            <!-- VOL -->
            <div class="trait">
              <div class="block-title">
                <button type="action" class="hidden" name="act_vol-btn"></button>
                <button type="action" class="block-title" name="act_vol_select-btn">
                  <span class="d20-btn">t</span>
                  VOL
                </button>
              </div>
              <div>
                <select class="select-xxs" name="attr_vol_sup" title="@{vol_dsup}">
                  <option value="N" selected>N Normale</option>
                  <option value="S">S Supérieure OU Héroïque</option>
                  <option value="H">H Supérieure ET Héroïque</option>
                </select>
                <input type="hidden" name="attr_vol_dsup" value="1d20">
              </div>
              <div class="bordered">
                <input type="number" name="attr_vol_base" title="@{vol_base}" value="0">
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_vol" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_vol" title="@{vol}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_vol_base" title="@{vol_base}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_vol_buff" title="@{vol_buff}"></span>
                </details>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_vol_test" title="@{vol_test}" value="0">
                <details class="trait-detail">
                  <summary>
                    <span name="attr_vol_test" title="@{vol_test}"></span>
                  </summary>
                  Base: <span class="trait-detail" name="attr_vol" title="@{vol}"></span>
                  <br>
                  + Buff : <span class="trait-detail" name="attr_vol_tbuff" title="@{vol_tbuff}"></span>
                </details>
              </div>
            </div>

          </div>

          <!-- Scores d'attaque -->
          <div class="attacks">

            <div class="attack">
              <h4>
                Combat
                <input type="hidden" class="attack-maneuvers" name="attr_manoeuvre" value="0">
                <button type="action" class="flat-btn img-btn attack-maneuvers" name="act_maneuver-btn" title="@{manoeuvre} Manoeuvres (L)">
                  <span class="img-btn">e</span>
                </button>
              </h4>
              <h4>Base</h4>
              <h4>Mod.</h4>
              <h4>Div.</h4>
              <h4><strong>Score</strong></h4>
            </div>

            <!-- Init -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_init-btn">
                  <span class="d20-btn">t</span>
                  INITIATIVE
                </button>
              </div>
              <div class="centered bordered">
                <span name="attr_init_base"></span>
              </div>
              <div class="centered bordered">
                PER: <span name="attr_per"></span>
                <input type="hidden" name="attr_cfg_init_agi" class="init-agi" value="0">
                <div class="init-agi">+AGI: <span name="attr_agi"></span></div>
              </div>
              <div class="centered bordered">
                <span name="attr_init_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_init" value="10">
                <span name="attr_init" title="@{init}"></span>
              </div>
            </div>

            <!-- CONTACT -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkcac-btn">
                  <span class="d20-btn">t</span>
                  AU CONTACT
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkcac_base" title="@{atkcac_base}" value="1">
              </div>
              <div class="centered bordered">
                FOR : <span name="attr_for"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atkcac_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkcac" value="1">
                <span name="attr_atkcac" title="@{atkcac}"></span>
              </div>
            </div>

            <!-- DISTANCE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atktir-btn">
                  <span class="d20-btn">t</span>
                  A DISTANCE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atktir_base" title="@{atktir_base}" value="1">
              </div>
              <div class="centered bordered">
                AGI : <span name="attr_agi"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atktir_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atktir" value="1">
                <span name="attr_atktir" title="@{atktir}"></span>
              </div>
            </div>

            <!-- MAGIE -->
            <div class="attack">
              <div class="block-title">
                <button class="block-title" type="action" name="act_atkmag-btn">
                  <span class="d20-btn">t</span>
                  MAGIE
                </button>
              </div>
              <div class="centered bordered">
                <input type="number" name="attr_atkmag_base" title="@{atkmag_base}" value="1">
              </div>
              <div class="centered bordered">
                VOL : <span name="attr_vol"></span>
              </div>
              <div class="centered bordered">
                <span name="attr_atkmag_buff"></span>
              </div>
              <div class="centered bordered">
                <input type="hidden" name="attr_atkmag" value="1">
                <span name="attr_atkmag" title="@{atkmag}"></span>
              </div>
            </div>

            <!-- DEPLACEMENT, SENS -->
            <h4 class="m2">Déplacement, Sens</h4>

            <div class="speed">
              <div class="block-title">Déplacement</div>
              <div class="bordered">
                <input type="hidden" name="attr_vitesse_cases" value="7" />
                <input type="hidden" name="attr_vitesse_pas" value="35" />
                <input type="number" class="two-digits" name="attr_vitesse" title="@{vitesse} Vitesse de déplacement&#10;1 case = 1,5m = 5 pas" value="10">&nbsp;m&nbsp;
                (cases : <span name="attr_vitesse_cases" title="Vitesse en cases"></span>,
                pas : <span name="attr_vitesse_pas" title="Vitesse en pas"></span>)
              </div>
            </div>

            <div class="speed">
              <div class="block-title">Sens</div>
              <div class="bordered">
                <div class="d-flex">
                  <input type="text" name="attr_sens" list="senses-list" title="@{sens}" placeholder="Sens spéciaux">
                  <datalist id="senses-list">
                    <option>Lumière des étoiles</option>
                    <option>Vision dans le noir</option>
                  </datalist>
                  &nbsp;<input type="number" class="two-digits" name="attr_sens_portee" title="@{sens_portee}">&nbsp;m
                </div>
              </div>
            </div>

          </div>
          
          <!-- VIGUEUR & MISC -->
          <div class="vitality">

            <!-- PV -->
            <div class="centered">
              <h4>POINTS DE VIGUEUR</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vigloss-btn">
                  <span class="img-btn">e</span>
                </button>
                PV
                <button class="flat-btn img-btn img-btn-lg" type="action" name="act_vigheal-btn">
                  <span class="img-btn">k</span>
                </button>
              </div>

              <input type="hidden" class="pv-status" name="attr_pvstatus" value="">
              <div class="bordered centered pv-color">
                <input type="number" class="two-digits" name="attr_pv" title="@{pv} PV courants">
                /
                <input type="number" class="two-digits" name="attr_pv_max" title="@{pv_max} PV maximum">
              </div>

            </div>

            <!-- DR -->
            <div class="hits hit">

              <div class="block-title centered">
                <button class="hidden" type="action" name="act_recovery_fast-btn"></button>
                <button class="hidden" type="action" name="act_recovery_full-btn"></button>
                <button class="flat-btn img-btn" type="action" name="act_drecup-btn">
                  <span title="Récupération rapide / complète">DR</span>
                </button>
                <select name="attr_drecup" class="select-xs" title="@{drecup} Type de DR">
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                </select>
              </div>

              <div class="bordered centered">
                <input type="hidden" name="attr_dr_max" value="2">
                <input type="number" name="attr_dr" title="@{dr} DR courants" value="2">
                /&nbsp;
                <span class="attr-max" name="attr_dr_max" title="@{dr_max} DR maximum"></span>
              </div>

            </div>

            <div class="bordered centered hit">
              DM temporaires
              <input type="number" name="attr_temp_dm" title="@{temp_dm}" value="">
            </div>

            <!-- PM -->
            <div class="centered">
              <h4>POINTS DE MANA</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">PM</div>

              <div class="bordered centered">
                <input type="hidden" name="attr_pm_max" value="0">
                <input class="two-digits" type="number" name="attr_pm" title="@{pm} PM courants" value="0">
                /
                <span class="attr-max" name="attr_pm_max" title="@{pm_max} PM maximum"></span>
              </div>

            </div>

            <!-- D4° -->
            <div class="centered">
              <h4>DE EVOLUTIF</h4>
            </div>

            <div class="hits hit">

              <div class="block-title centered">
                <button class="flat-btn img-btn" type="action" name="act_devol-btn">
                  <span>D4°</span>
                </button>
              </div>

              <div class="bordered centered">
                <span name="attr_devol" title="@{devol}"></span>
              </div>

            </div>

          </div>
  
        </div>
  
        <!-- Conditions & Défenses -->
        <!-- https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/ChroniquesOublieesFantasy2/cond_xxx.png -->
        <div class="pc-cond-def">
  
          <div class="conditions">
            <input type="hidden" name="attr_conditions_markers" value="">
            <div class="centered block-header block-title">
              Etats préjudiciables&nbsp;
              <button type="action" class="flat-btn img-btn" name="act_etats_menu-btn" title="%{etats_menu-btn} Menu des états préjudiciables">
                <span class="img-btn">l</span>
              </button>
            </div>
            <input type="hidden" name="attr_condition_inconscient" value="0">
            <div class="bordered centered">
              <input type="hidden" class="condition-affaibli" name="attr_condition_affaibli" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_affaibli-icon"
                title="@{condition_affaibli} Affaibli"
              ><img
                class="bubble-img condition-affaibli"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-affaibli.png"
                />
              </button>
              <input type="hidden" class="condition-aveugle" name="attr_condition_aveugle" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_aveugle-icon"
                title="@{condition_aveugle} Aveuglé"
              ><img
                class="bubble-img condition-aveugle"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-aveugle.png"
                />
              </button>
              <input type="hidden" class="condition-effraye" name="attr_condition_effraye" value="0">
              <input type="hidden" class="condition-show" name="attr_cfg_use_fear" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg condition-effraye"
                name="act_effraye-icon"
                title="@{condition_effraye} Effrayé"
              ><img
                class="bubble-img condition-effraye"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/markers-alternatifs/cof-apeure.png"
                />
              </button>
              <input type="hidden" class="condition-essoufle" name="attr_condition_essoufle" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_essoufle-icon"
                title="@{condition_essoufle} Essouflé"
              ><img
                class="bubble-img condition-essoufle"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-essoufle.png"
                />
              </button>
              <input type="hidden" class="condition-etourdi" name="attr_condition_etourdi" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_etourdi-icon"
                title="@{condition_etourdi} Etourdi"
              ><img
                class="bubble-img condition-etourdi"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-etourdi.png"
                />
              </button>
              <input type="hidden" class="condition-immobilise" name="attr_condition_immobilise" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_immobilise-icon"
                title="@{condition_immobilise} Immobilisé"
              ><img
                class="bubble-img condition-immobilise" 
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-immobilise.png"
                />
              </button>

              <br>
           
              <input type="hidden" class="condition-invalide" name="attr_condition_invalide" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_invalide-icon"
                title="@{condition_invalide} Invalide"
              ><img
                class="bubble-img condition-invalide"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-invalide.png"
                />
              </button>
              <input type="hidden" class="condition-panique" name="attr_condition_panique" value="0">
              <input type="hidden" class="condition-show" name="attr_cfg_use_fear" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg condition-panique"
                name="act_panique-icon"
                title="@{condition_panique} Paniqué"
              ><img
                class="bubble-img condition-panique"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-apeure.png"
                />
              </button>
              <input type="hidden" class="condition-paralyse" name="attr_condition_paralyse" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_paralyse-icon"
                title="@{condition_paralyse} Paralysé"
              ><img
                class="bubble-img condition-paralyse"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-paralyse.png"
                />
              </button>
              <input type="hidden" class="condition-ralenti" name="attr_condition_ralenti" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_ralenti-icon"
                title="@{condition_ralenti} Ralenti"
              ><img
                class="bubble-img condition-ralenti"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-ralenti.png"
                />
              </button>
              <input type="hidden" class="condition-renverse" name="attr_condition_renverse" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_renverse-icon"
                title="@{condition_renverse} Renversé"
              ><img
                class="bubble-img condition-renverse"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-renverse.png"
                />
              </button>                
              <input type="hidden" class="condition-surpris" name="attr_condition_surpris" value="0">
              <button
                type="action"
                class="flat-btn img-btn img-btn-lg"
                name="act_surpris-icon"
                title="@{condition_surpris} Surpris"
              ><img
                class="bubble-img condition-surpris"
                src="https://raw.githubusercontent.com/Ulty/COFantasy2/master/cof-marker-set/cof-surpris.png"
                />
              </button>

            </div>
          </div>

          <div class="defenses">

            <div class="defense">
              <div><strong>DEFENSE</strong></div>
              <div></div>
              <div class="centered">
                Armure
                <input type="checkbox" name="attr_armure_eqp" title="@{armure_eqp} Armure équipée" value="1">
              </div>
              <div class="centered">
                Bouclier
                <input type="checkbox" name="attr_bouclier_eqp" title="@{bouclier_eqp} Bouclier équipé" value="1">
              </div>
              <div class="centered">
                <span name="attr_def_car" title="@{def_car} Caractéristique"></span>
              </div>
              <div class="centered">Div.</div>
              <div class="centered">Action défensive</div>
              <div class="centered"><strong>Score</strong></div>
            </div>

            <div class="defense">
              <div class="block-title">DEF</div>
              <div class="bordered centered"><span name="attr_def_base"></span>&nbsp;+</div>
              <div class="bordered centered">
                <input type="number" name="attr_armure" title="@{armure} Bonus d'armure" value="0">
              </div>
              <div class="bordered centered">
                <input type="number" name="attr_bouclier" title="@{bouclier} Bonus de bouclier" value="0">
              </div>
              <div class="bordered centered">
                <span name="attr_def_car_bonus" title="@{def_car_bonus} Bonus de caractéristique"></span>
              </div>
              <div class="bordered centered">
                <span name="attr_def_buff" title="@{def_buff} Bonus divers"></span>
              </div>
              <div class="bordered centered">
                <select class="select-md" name="attr_def_action" title="@{def_action} Action défensive">
                  <option value="">-</option>
                  <option value="3">Partielle (A)</option>
                  <option value="5">Totale (L)</option>
                </select>
              </div>
              <div class="bordered centered">
                <input type="hidden" name="attr_def" value="10">
                <span name="attr_def" title="@{def} Défense"></span>
              </div>
            </div>

            <div class="defense">
              <div class="centered">
                <strong>Malus</strong>
              </div>
              <div></div>
              <div class="bordered centered">
                <input type="number" name="attr_armure_malus" title="@{armure_malus} Malus d'armure" value="0">
              </div>
              <div>
                <input type="hidden" class="bouclier-malus" name="attr_cfg_bouclier_malus" value="0">
                <div class="bordered centered bouclier-malus">
                  <input type="number" name="attr_bouclier_malus" title="@{bouclier_malus} Malus de bouclier" value="0">
                </div>
              </div>
              <div></div>
              <div></div>
              <div>
                <input type="checkbox" name="attr_casque_eqp" title="@{casque_eqp} Casque équipé" value="1">
                Casque (RD : <span name="attr_casque"></span>)&nbsp;
              </div>
              <div></div>
            </div>

          </div>
  
        </div>

        <!-- PC & RD -->
        <div class="pc-luck-rd">

          <div class="luck">
            <div class="block-title">
              <button class="block-title" type="action" name="act_luck_apply-btn">
                <span class="d20-btn">t</span>
              </button>
              PC
              <button class="block-title" type="action" name="act_luck_roll-btn">
                <span class="d6-btn">r</span>
              </button>
            </div>
            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_pc_max" value="0">
                <input type="number" class="two-digits" name="attr_pc" title="@{pc} PC courants" value="0">
                &nbsp;/&nbsp;
                <span class="attr-max" name="attr_pc_max" title="@{pc_max} PC maximum"></span>
                &nbsp;(
                <span name="attr_pc_base" title="@{pc_base} Base PC"></span>
                &nbsp;+&nbsp;
                <span name="attr_cha" title="Score de CHArisme"></span>
                &nbsp;+&nbsp;
                <span name="attr_pc_buff" title="@{pc_buff} Bonus divers"></span>
                )&nbsp;
                <input type="hidden" name="attr_double_pc">
                &nbsp;<span name="attr_double_pc" title="PC variables"></span>
              </div>
            </div>
          </div>

          <div class="dmred">
            <div class="block-title">RD</div>
            <div class="bordered">
              <input type="hidden" name="attr_rrdm">
              <span name="attr_rrdm" title="@{rrdm} Réductions et Résistances aux DM"></span>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Caractéristiques, Sous-onglets -->
        <input type="hidden" class="tabs-toggle" name="attr_pc_subtab1" value="attacks" />
        <div class="pc-subtabs">
          <button type="action" name="act_pc_attacks-btn" class="sub-tab tab-btn pc-attacks-btn">ATTAQUES</button>
          <button type="action" name="act_pc_otact-btn" class="sub-tab tab-btn pc-otact-btn">OPTIONS</button>
          <button type="action" name="act_pc_hands-btn" class="sub-tab tab-btn pc-hands-btn">EN MAIN</button>
          <button type="action" name="act_pc_resdm-btn" class="sub-tab tab-btn pc-resdm-btn">RESISTANCES</button>
        </div>
      
        <hr>
        
        <!-- Attaques & Armes -->
        <div class="pc-attacks-subtab">
          
          <div class="pc-attacks">
            
            <div class="weapon">
              <div></div>
              <h4>
                ARME / SORT
                <button type="action" class="flat-btn img-btn" name="act_attacks_menu-btn" title="%{attacks_menu-btn} Menu des jets d'attaques">
                  <span class="img-btn">l</span>
                </button>
              </h4>
              <h4>ATTAQUE</h4>
              <h4>CRIT.</h4>
              <h4>DM</h4>
              <h4>PORTEE</h4>
              <!--<h4>SPECIAL</h4>-->
            </div>

            <fieldset class="repeating_armes">

              <div class="weapon">
                
                <div>
                  <input type="hidden" name="attr_attack-btn" value="">
                  <button type="action" class="hidden" name="act_attack-btn">
                    <span class="d20-btn">t</span>
                  </button>
                  <button type="roll" class="flat-btn" name="roll_attack" title="%{repeating_armes_ID_attack-btn} Jet d'attaque" value="@{attack-btn}"/>
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="hidden" name="attr_arme-label" value="">
                  <input type="hidden" class="arme-label" name="attr_arme-showlbl" value="0">
                  <span class="align-self-center arme-label" name="attr_arme-label"></span>&nbsp;
                  <input type="text" name="attr_arme-nom" title="@{arme-nom}" placeholder="Arme/attaque" value="">
                  <span class="align-self-center">2M&nbsp;:&nbsp;</span>
                  <input type="checkbox" name="attr_arme-2m" title="@{arme-2m} Arme à deux mains" value="1">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <select class="select-md" name="attr_arme-atk" title="@{arme-atk} Score d'attaque">
                    <option value="0">-</option>
                    <option value="atkcac" selected>CONTACT</option>
                    <option value="atktir">DISTANCE</option>
                    <option value="atkmag">MAGIE</option>
                  </select>
                  &nbsp;<span class="align-self-center">+</span>&nbsp;
                  <input type="number" class="two-digits" name="attr_arme-atkdiv" title="@{arme-atkdiv} Bonus divers" value="">
                  <input type="hidden" name="attr_arme-buffatk" value="0">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="number" class="two-digits" name="attr_arme-crit" title="@{arme-crit} Seuil de Critique" value="20" min="16" max="20">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="text" name="attr_arme-dm" title="@{arme-dm} Dé(s) de DM&#10;Séparer les dés de DM à une main et deux mais par un / pour les armes polyvalentes" placeholder="1d8, 2d6..." value="">
                  <select class="select-xxs" name="attr_arme-dmtype" title="@{arme-dmtype} Type de dommages">
                    <optgroup label="Physiques">
                      <option disabled class="optgroup">
                        &nbsp;Physiques
                      </option>
                      <option value="contondants">C - Contondants</option>
                      <option value="perforants">P - Perforants</option>
                      <option value="poison">Po - Poison</option>
                      <option value="tranchants" selected>T - Tranchants</option>
                    </optgroup>
                    <optgroup label="Elementaires">
                      <option disabled class="optgroup">
                        &nbsp;Elémentaires
                      </option>
                      <option value="acide">A - Acide</option>
                      <option value="electrique">E - Electricité</option>
                      <option value="feu">Fe - Feu</option>
                      <option value="froid">Fr - Froid</option>
                      <option value="sonique">S - Sonique</option>
                    </optgroup>
                    <optgroup label="Autres">
                      <option disabled class="optgroup">
                        &nbsp;Autres
                      </option>
                      <option value="drain">Dr - Drain</option>
                      <option value="magique">M - Magiques</option>
                      <option value="maladie">Ma - Maladie</option>
                    </optgroup>
                  </select>
                  &nbsp;<span class="align-self-center">+</span>&nbsp;
                  <select class="select-md" name="attr_arme-bonus" title="@{arme-bonus} Bonus aux dommages">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{for}" selected>FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                  </select>
                  &nbsp;<span class="align-self-center">+</span>&nbsp;
                  <input type="number" class="two-digits" name="attr_arme-dmdiv" title="@{arme-dmdiv} Bonus DM divers" value="0">
                  <input type="hidden" name="attr_arme-buffdm" value="0">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="text" name="attr_arme-portee" title="@{arme-portee}" value="">
                  <input type="hidden" name="attr_arme-portees" value="">
                  <button type="action" class="flat-btn img-btn float-right" name="act_armeopt-btn">
                    <span class="img-btn">y</span>
                  </button>
                </div>

              </div>

              <input type="hidden" name="attr_arme-gearid" value=""/>
              <input type="hidden" class="cof-wopt-toggle" name="attr_armeopt" value="0"/>
              <div class="weapon-opt">
                <div class="weapon-special">
                  <div></div>
                  <div class="bordered weapon-special-ongoing">
                    <textarea class="one-row" name="attr_arme-special" title="@{arme-special}" placeholder="Effet spécial..."></textarea>
                    <details>
                      <summary>
                        <span name="attr_arme-etendu" title="@{arme-etendu} Effet prolongé"></span>
                        <input type="hidden" class="ongoing" name="attr_arme-etendu" value="">
                        <button type="action" class="flat-btn img-btn ongoing" name="act_ongoing-btn" title="%{ongoing-btn} Effets prolongés">
                          <span class="img-btn">0</span>
                        </button>
                      </summary>
                      <input type="text" name="attr_etendu-effet" title="@{etendu-effet} Peut contenir une formule" placeholder="Effet">
                      <input type="text" name="attr_etendu-nom" title="@{etendu-nom} Si différent de l'arme/attaque" placeholder="Nom">
                      <input type="text" name="attr_etendu-duree" title="@{etendu-duree} Peut contenir une formule" placeholder="Durée de l'effet">
                      <input type="text" name="attr_etendu-stop" title="@{etendu-stop} Si pas de durée spécifiée" placeholder="Conditions de fin">
                    </details>
                  </div>
                </div>
                <div class="weapon-option">
                  <div>
                  </div>
                  <div class="bordered">
                    <select name="attr_arme-atktype" class="select-md" title="@{arme-atktype} Type d'arme/attaque">
                      <option value="">Type...</option>
                      <option value="main" title="Arme de contact">En main</option>
                      <option value="jet" title="Arme lancée">Jet</option>
                      <option value="trait" title="Arme à projectiles (munitions)">Trait</option>
                      <option value="sort" title="Sortilège">Sort</option>
                      <option value="naturel" title="Arme naturelle">Naturelle</option>
                    </select>
                    <input class="two-digits" type="number" name="attr_arme-usure" title="@{arme-usure} Usure">
                  </div>
                  <div class="bordered">
                    <input type="text" name="attr_arme-atkmods" placeholder="Modificateurs d'attaque" title="@{arme-atkmods} Modificateurs séparés par des virgules&#10; deBonus: avec dé bonus&#10; deMalus: avec dé malus&#10; auto: réussite automatique&#10; choc: peut faire des attaques non léthales sans malus&#10; explodeMax: dés de dégâts explosifs&#10; pasDeDmg: l'attaque ne fait pas de DM&#10; poudre: arme à poudre&#10; reroll1: relance les 1 sur les dés de DM (:1 = une seule fois)&#10; tempDmg: fait toujours des attaques non léthales&#10; zone: sort de zone&#10; magie: bonus att.+DM&#10; magieAtt: bonus att.&#10; magieDmg: bonus DM&#10; affutee: critiques améliorés&#10; fleau: bonus DM contre créature&#10; element: bonus DM élémentaires/substance&#10; manoeuvres: attaques spéciales" value="">
                  </div>
                  <div class="bordered">
                    <input type="checkbox" name="attr_arme-active" title="@{arme-active} Attaque active" value="1" checked>
                    <textarea class="one-row" name="attr_arme-options" placeholder="Options d'attaque" title="@{arme-options} Options d'attaque"></textarea>
                  </div>

                </div>

                <input type="hidden" class="cof-inhand-toggle" name="attr_arme-main" value="0"/>
                <div class="weapon-hands">
                  <div class="weapon-hand">
                    <div></div>
                    <div class="bordered">
                      <textarea class="one-row" name="attr_arme-predicats" placeholder="Prédicats si porté" title="@{arme-predicats} Prédicats si porté"></textarea>
                    </div>
                  </div>
                </div>

                <input type="hidden" class="cof-thrown-toggle" name="attr_arme-jet" value="0"/>
                <div class="weapon-thrown">
                  <div class="weapon-throw">
                    <div></div>
                    <div class="bordered">
                      Disponibles :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-dispo" title="@{jet-dispo}" value="0">
                    </div>
                    <div class="bordered">
                      Possédés :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-dispo_max" title="@{jet-dispo_max}" value="0">
                    </div>
                    <div class="bordered">
                      Taux perte :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-perte" title="@{jet-perte}" value="0">
                      &nbsp;%
                    </div>
                  </div>
                </div>

                <input type="hidden" class="cof-trait-toggle" name="attr_arme-trait" value="0"/>
                <div class="weapon-traits">
                  <div class="weapon-trait">
                    <div></div>
                    <div class="d-flex bordered">
                      <input type="hidden" name="attr_jet-resid" value="">
                      <input type="text" name="attr_jet-nom" title="@{jet-nom}" placeholder="Nom de la munition">
                      <input type="number" class="two-digits" name="attr_jet-nbre" title="@{jet-nbre} Nombre de munitions dépensées" value="1">
                    </div>
                  </div>
              </div>

            </fieldset>

          </div>

        </div>
        
        <!-- Options tactiques -->
        <div class="pc-otact-subtab">

          <div class="sheet-2colrow">
            
            <div class="sheet-col">
              <h4 title="DM doublés en cas de coup critique">Options Tactiques</h4>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="0" checked>
                  Aucune
                </div>
                <div>
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="1">
                  Attaque assurée
                </div>
                <div>
                  +5 en attaque et DM divisés par 2
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="2">
                  Attaque précise
                </div>
                <div>
                  -3 en attaque et +1d4° DM
                </div>
              </div>

              <div class="pc-tactic">
                <div>
                  <input type="radio" name="attr_tactique" value="3">
                  Attaque violente
                </div>
                <div>
                  -7 en attaque et +2d4° DM
                </div>
              </div>

              <div class="pc-tactic">
                <div class="d-flex">
                  <input type="checkbox" name="attr_tactautre" value="1">
                  <input type="text" class="align-self-center" name="attr_tactname" placeholder="Autre tactique" value="">
                </div>
                <div class="d-flex">
                  <input type="number" class="align-self-center" name="attr_tactdiv" value="0">
                  &nbsp;<input type="checkbox" name="attr_tactroll" title="@{tactroll} Avec dé bonus" value="1">
                  &nbsp;<input type="checkbox" name="attr_tactroll" title="@{tactroll} Avec dé malus" value="2">
                  <input type="text" class="w-auto align-self-center" name="attr_tactdmdiv" placeholder="DM supplémentaires" value="">
                </div>
              </div>

            </div>

            <div class="sheet-col">
              <h4>Modificateurs de situation</h4>

              <div class="pc-tactic">
                <div>Cible à couvert</div>
                <div>
                  <select class="select-md" name="attr_modsit_couvert" title="@{modsit_couvert} Mod. couvert">
                    <option value="0">Aucun</option>
                    <option value="2" title="Végétation">Faible (-2)</option>
                    <option value="5" title="Muraille">Fort (-5)</option>
                  </select>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Cible en pleine mêlée</div>
                <div>
                  <select class="select-md" name="attr_modsit_melee" title="@{modsit_melee} Mod. en mêlée">
                    <option value="0">Non</option>
                    <option value="2" title="">Oui (-2)</option>
                    <option value="5" title="Masquée par un allié">Masquée (-5)</option>
                  </select>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Tireur</div>
                <div>
                  <input type="checkbox" name="attr_modsit_contact" title="@{modsit_contact} Mod. au contact" value="1">
                  <span>&nbsp;Au contact d'un adversaire</span>
                </div>
              </div>

              <div class="pc-tactic">
                <div>Visibilité</div>
                <div>
                  <input type="checkbox" name="attr_modsit_visibilite" title="@{modsit_visibilite} Mod. de visibilité" value="5">
                  <span>&nbsp;Brouillard / Pénombre</span>
                </div>
              </div>
            </div>

          </div>

        </div>

        <!-- Equipé / En maib -->
        <div class="pc-hands-subtab">

          <div class="sheet-2colrow">

            <div class="sheet-col">

              <div class="pc-hands">

                <div>
                  <input type="hidden" name="attr_main_princ-btn" value="">
                  <button type="action" class="hidden" name="act_main_princ-btn"/>
                  <input type="hidden" class="pc-hand" name="attr_main_princ_btn" value="0">
                  <button type="roll" class="flat-btn" name="roll_main_princ" title="%{main_princ-btn} Attaque main principale" value="@{main_princ-btn}"/>
                </div>

                <div class="block-title">
                  <span class="align-self-center">Main principale</span>
                </div>

                <div class="bordered">
                  <select name="attr_main_princ" class="select-lg hand-main">
                  </select>
                </div>

              </div>

              <div class="pc-hands">

                <div>
                  <input type="hidden" name="attr_main_autre-btn" value="">
                  <button type="action" class="hidden" name="act_main_autre-btn"/>
                  <input type="hidden" class="pc-hand" name="attr_main_autre_btn" value="0">
                  <button type="roll" class="flat-btn" name="roll_main_autre" title="%{main_autre-btn} Attaque main secondaire" value="@{main_autre-btn}"/>
                </div>

                <div class="block-title">
                  <span class="align-self-center">Autre Main</span>
                </div>
                
                <div class="bordered">
                  <select name="attr_main_autre" class="select-lg hand-other">
                  </select>
                </div>
              </div>
              
            </div>

            <div class="sheet-col">

              <div class="d-flex">
                <input type="checkbox" name="attr_en_selle" title="@{en_selle}" value="1">
                <span>&nbsp;En selle</span>
              </div>

            </div>

          </div>

        </div>

        <!-- Réductions & Résistances DM -->
        <div class="pc-resdm-subtab">

          <div class="sheet-2colrow">

            <div class="sheet-col">
              <textarea name="attr_rd" title="@{rd}" placeholder="Réductions des DM..."></textarea>
            </div>
            
            <div class="sheet-col">
              <textarea name="attr_resdm" title="@{resdm}" placeholder="Résistances aux DM..."></textarea>
            </div>

          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Capacités -->
      <div class="pc-abilities-tab">

        <input type="checkbox" class="block-switch" name="attr_abilities_edit" value="1">
        
        <!-- Fiche PJ, Onglet Capacités, Mode Affichage -->
        <div class="abilities-view">
          <div class="d-flex d-flex-between">
            <div>
              <h3>
                CAPACITES
              </h3>
            </div>
            <div class="change-view">
              <button type="action" class="flat-btn img-btn" name="act_abilities_menu-btn" title="%{abilities_menu-btn} Menu des voies et capacités">
                <span class="img-btn">l</span>
              </button>
              <button type="action" class="flat-btn img-btn" name="act_ongoing-btn" title="%{ongoing-btn} Effets prolongés">
                <span class="img-btn">0</span>
              </button>
              <button type="action" class="flat-btn img-btn" name="act_reset_uses-btn" title="Ré-initialiser l'usage des capacités">
                <span class="img-btn">t</span>
              </button>
              <input type="hidden" class="spell-concentration" name="attr_concentration" value="0">
              <input type="hidden" class="spell-concentration-show" name="attr_pm_max" value="0">
              <button type="action" class="flat-btn img-btn spell-concentration" name="act_concentration-btn" title="Concentration (L)">
                <span class="img-btn">E</span>
              </button>
              <button type="action" class="flat-btn img-btn" name="act_edit_view-btn" title="Editer les voies et capacités">
                <span class="img-btn"></span>Editer
              </button>
              <input type="hidden" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <!-- Voie 1 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie1nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie1_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie1notes" value="">
                </summary>
                <span name="attr_voie1notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r1" title="@{v1r1}" value="1" checked>
                      <input type="hidden" class="spell" name="attr_v1r1_spell">
                      <span class="rank-title" name="attr_voie1-t1"></span>
                      <input type="hidden" name="attr_v1r1-btn" value="">
                      <button type="action" class="hidden" name="act_x1r1-btn">
                      <button type="action" class="hidden" name="act_v1r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v1r1" title="%{v1r1-btn}" value="@{v1r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-1" title="@{voie1-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v1r1_use_max" value="0">
                  <div class="ability-uses">
                    <input type="number" name="attr_v1r1_use" title="@{v1r1_use} Utilisations">
                    / <span name="attr_v1r1_use_max" title="@{v1r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r1_freq" title="@{v1r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r2" title="@{v1r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v1r2_spell">
                      <span class="rank-title" name="attr_voie1-t2"></span>
                      <input type="hidden" name="attr_v1r2-btn" value="">
                      <button type="action" class="hidden" name="act_x1r2-btn">
                      <button type="action" class="hidden" name="act_v1r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v1r2" title="%{v1r2-btn}" value="@{v1r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-2" title="@{voie1-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v1r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v1r2_use" title="@{v1r2_use} Utilisations">
                    / <span name="attr_v1r2_use_max" title="@{v1r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r2_freq" title="@{v1r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->  
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r3" title="@{v1r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v1r3_spell">
                      <span class="rank-title" name="attr_voie1-t3"></span>
                      <input type="hidden" name="attr_v1r3-btn" value="">
                      <button type="action" class="hidden" name="act_x1r3-btn">
                      <button type="action" class="hidden" name="act_v1r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v1r3" title="%{v1r3-btn}" value="@{v1r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-3" title="@{voie1-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v1r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v1r3_use" title="@{v1r3_use} Utilisations">
                    / <span name="attr_v1r3_use_max" title="@{v1r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r3_freq" title="@{v1r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r4" title="@{v1r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v1r4_spell">
                      <span class="rank-title" name="attr_voie1-t4"></span>
                      <input type="hidden" name="attr_v1r4-btn" value="">
                      <button type="action" class="hidden" name="act_x1r4-btn">
                      <button type="action" class="hidden" name="act_v1r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v1r4" title="%{v1r4-btn}" value="@{v1r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-4" title="@{voie1-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v1r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v1r4_use" title="@{v1r4_use} Utilisations" >
                    / <span name="attr_v1r4_use_max" title="@{v1r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r4_freq" title="@{v1r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v1r5" title="@{v1r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v1r5_spell">
                      <span class="rank-title" name="attr_voie1-t5"></span>
                      <input type="hidden" name="attr_v1r5-btn" value="">
                      <button type="action" class="hidden" name="act_x1r5-btn">
                      <button type="action" class="hidden" name="act_v1r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v1r5" title="%{v1r5-btn}" value="@{v1r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie1-5" title="@{voie1-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v1r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v1r5_use" title="@{v1r5_use} Utilisations" >
                    / <span name="attr_v1r5_use_max" title="@{v1r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v1r5_freq" title="@{v1r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 2 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie2nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie2_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie2notes" value="">
                </summary>
                <span name="attr_voie2notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r1" title="@{v2r1}" value="1" checked>
                      <input type="hidden" class="spell" name="attr_v2r1_spell">
                      <span class="rank-title" name="attr_voie2-t1"></span>
                      <input type="hidden" name="attr_v2r1-btn" value="">
                      <button type="action" class="hidden" name="act_x2r1-btn">
                      <button type="action" class="hidden" name="act_v2r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v2r1" title="%{v2r1-btn}" value="@{v2r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-1" title="@{voie2-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v2r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v2r1_use" title="@{v2r1_use} Utilisations" >
                    / <span name="attr_v2r1_use_max" title="@{v2r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r1_freq" title="@{v2r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r2" title="@{v2r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v2r2_spell">
                      <span class="rank-title" name="attr_voie2-t2"></span>
                      <input type="hidden" name="attr_v2r2-btn" value="">
                      <button type="action" class="hidden" name="act_x2r2-btn">
                      <button type="action" class="hidden" name="act_v2r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v2r2" title="%{v2r2-btn}" value="@{v2r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-2" title="@{voie2-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v2r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v2r2_use" title="@{v2r2_use} Utilisations" >
                    / <span name="attr_v2r2_use_max" title="@{v2r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r2_freq" title="@{v2r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r3" title="@{v2r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v2r3_spell">
                      <span class="rank-title" name="attr_voie2-t3"></span>
                      <input type="hidden" name="attr_v2r3-btn" value="">
                      <button type="action" class="hidden" name="act_x2r3-btn">
                      <button type="action" class="hidden" name="act_v2r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v2r3" title="%{v2r3-btn}" value="@{v2r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-3" title="@{voie2-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v2r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v2r3_use" title="@{v2r3_use} Utilisations" >
                    / <span name="attr_v2r3_use_max" title="@{v2r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r3_freq" title="@{v2r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r4" title="@{v2r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v2r4_spell">
                      <span class="rank-title" name="attr_voie2-t4"></span>
                      <input type="hidden" name="attr_v2r4-btn" value="">
                      <button type="action" class="hidden" name="act_x2r4-btn">
                      <button type="action" class="hidden" name="act_v2r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v2r4" title="%{v2r4-btn}" value="@{v2r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-4" title="@{voie2-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v2r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v2r4_use" title="@{v2r4_use} Utilisations" >
                    / <span name="attr_v2r4_use_max" title="@{v2r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r4_freq" title="@{v2r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v2r5" title="@{v2r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v2r5_spell">
                      <span class="rank-title" name="attr_voie2-t5"></span>
                      <input type="hidden" name="attr_v2r5-btn" value="">
                      <button type="action" class="hidden" name="act_x2r5-btn">
                      <button type="action" class="hidden" name="act_v2r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v2r5" title="%{v2r5-btn}" value="@{v2r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie2-5" title="@{voie2-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v2r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v2r5_use" title="@{v2r5_use} Utilisations" >
                    / <span name="attr_v2r5_use_max" title="@{v2r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v2r5_freq" title="@{v2r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 3 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie3nom"></span>
              </div>
              <button type="action" class="hidden" name="act_voie3_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie3notes" value="">
                </summary>
                <span name="attr_voie3notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r1" title="@{v3r1}" value="1" checked>
                      <input type="hidden" class="spell" name="attr_v3r1_spell">
                      <span class="rank-title" name="attr_voie3-t1"></span>
                      <input type="hidden" name="attr_v3r1-btn" value="">
                      <button type="action" class="hidden" name="act_x3r1-btn">
                      <button type="action" class="hidden" name="act_v3r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v3r1" title="%{v3r1-btn}" value="@{v3r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-1" title="@{voie3-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v3r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v3r1_use" title="@{v3r1_use} Utilisations" >
                    / <span name="attr_v3r1_use_max" title="@{v3r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r2" title="@{v3r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v3r2_spell">
                      <span class="rank-title" name="attr_voie3-t2"></span>
                      <input type="hidden" name="attr_v3r2-btn" value="">
                      <button type="action" class="hidden" name="act_x3r2-btn">
                      <button type="action" class="hidden" name="act_v3r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v3r2" title="%{v3r2-btn}" value="@{v3r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-2" title="@{voie3-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v3r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v3r2_use" title="@{v3r2_use} Utilisations" >
                    / <span name="attr_v3r2_use_max" title="@{v3r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r2_freq" title="@{v3r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r3" title="@{v3r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v3r3_spell">
                      <span class="rank-title" name="attr_voie3-t3"></span>
                      <input type="hidden" name="attr_v3r3-btn" value="">
                      <button type="action" class="hidden" name="act_x3r3-btn">
                      <button type="action" class="hidden" name="act_v3r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v3r3" title="%{v3r3-btn}" value="@{v3r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-3" title="@{voie3-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v3r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v3r3_use" title="@{v3r3_use} Utilisations" >
                    / <span name="attr_v3r3_use_max" title="@{v3r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r3_freq" title="@{v3r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r4" title="@{v3r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v3r4_spell">
                      <span class="rank-title" name="attr_voie3-t4"></span>
                      <input type="hidden" name="attr_v3r4-btn" value="">
                      <button type="action" class="hidden" name="act_x3r4-btn">
                      <button type="action" class="hidden" name="act_v3r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v3r4" title="%{v3r4-btn}" value="@{v3r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-4" title="@{voie3-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v3r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v3r4_use" title="@{v3r4_use} Utilisations" >
                    / <span name="attr_v3r4_use_max" title="@{v3r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v3r5" title="@{v3r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v3r5_spell">
                      <span class="rank-title" name="attr_voie3-t5"></span>
                      <input type="hidden" name="attr_v3r5-btn" value="">
                      <button type="action" class="hidden" name="act_x3r5-btn">
                      <button type="action" class="hidden" name="act_v3r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v3r5" title="%{v3r5-btn}" value="@{v3r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie3-5" title="@{voie3-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v3r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v3r5_use" title="@{v3r5_use} Utilisations" >
                    / <span name="attr_v3r5_use_max" title="@{v3r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v3r5_freq" title="@{v3r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
          </div>
  
          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <input type="hidden" class="show-paths-4to9" name="attr_voies_456" value="1">
          <div class="abilities">
            <!-- Voie 4 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie4nom" title="@{voie4nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie4_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie4notes" value="">
                </summary>
                <span name="attr_voie4notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r1" title="@{v4r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v4r1_spell">
                      <span class="rank-title" name="attr_voie4-t1"></span>
                      <input type="hidden" name="attr_v4r1-btn" value="">
                      <button type="action" class="hidden" name="act_x4r1-btn">
                      <button type="action" class="hidden" name="act_v4r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v4r1" title="%{v4r1-btn}" value="@{v4r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-1" title="@{voie4-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v4r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v4r1_use" title="@{v4r1_use} Utilisations" >
                    / <span name="attr_v4r1_use_max" title="@{v4r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r1_freq" title="@{v4r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r2" title="@{v4r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v4r2_spell">
                      <span class="rank-title" name="attr_voie4-t2"></span>
                      <input type="hidden" name="attr_v4r2-btn" value="">
                      <button type="action" class="hidden" name="act_x4r2-btn">
                      <button type="action" class="hidden" name="act_v4r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v4r2" title="%{v4r2-btn}" value="@{v4r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-2" title="@{voie4-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v4r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v4r2_use" title="@{v4r2_use} Utilisations" >
                    / <span name="attr_v4r2_use_max" title="@{v4r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r2_freq" title="@{v4r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r3" title="@{v4r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v4r3_spell">
                      <span class="rank-title" name="attr_voie4-t3"></span>
                      <input type="hidden" name="attr_v4r3-btn" value="">
                      <button type="action" class="hidden" name="act_x4r3-btn">
                      <button type="action" class="hidden" name="act_v4r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v4r3" title="%{v4r3-btn}" value="@{v4r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-3" title="@{voie4-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v4r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v4r3_use" title="@{v4r3_use} Utilisations" >
                    / <span name="attr_v4r3_use_max" title="@{v4r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r3_freq" title="@{v4r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r4" title="@{v4r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v4r4_spell">
                      <span class="rank-title" name="attr_voie4-t4"></span>
                      <input type="hidden" name="attr_v4r4-btn" value="">
                      <button type="action" class="hidden" name="act_x4r4-btn">
                      <button type="action" class="hidden" name="act_v4r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v4r4" title="%{v4r4-btn}" value="@{v4r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-4" title="@{voie4-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v4r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v4r4_use" title="@{v4r4_use} Utilisations" >
                    / <span name="attr_v4r4_use_max" title="@{v4r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r4_freq" title="@{v4r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v4r5" title="@{v4r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v4r5_spell">
                      <span class="rank-title" name="attr_voie4-t5"></span>
                      <input type="hidden" name="attr_v4r5-btn" value="">
                      <button type="action" class="hidden" name="act_x4r5-btn">
                      <button type="action" class="hidden" name="act_v4r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v4r5" title="%{v4r5-btn}" value="@{v4r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie4-5" title="@{voie4-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v4r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v4r5_use" title="@{v4r5_use} Utilisations" >
                    / <span name="attr_v4r5_use_max" title="@{v4r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v4r5_freq" title="@{v4r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 5 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie5nom" title="@{voie5nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie5_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie5notes" value="">
                </summary>
                <span name="attr_voie5notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r1" title="@{v5r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v5r1_spell">
                      <span class="rank-title" name="attr_voie5-t1"></span>
                      <input type="hidden" name="attr_v5r1-btn" value="">
                      <button type="action" class="hidden" name="act_x5r1-btn">
                      <button type="action" class="hidden" name="act_v5r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v5r1" title="%{v5r1-btn}" value="@{v5r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-1" title="@{voie5-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v5r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v5r1_use" title="@{v5r1_use} Utilisations" >
                    / <span name="attr_v5r1_use_max" title="@{v5r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r1_freq" title="@{v5r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r2" title="@{v5r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v5r2_spell">
                      <span class="rank-title" name="attr_voie5-t2"></span>
                      <input type="hidden" name="attr_v5r2-btn" value="">
                      <button type="action" class="hidden" name="act_x5r2-btn">
                      <button type="action" class="hidden" name="act_v5r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v5r2" title="%{v5r2-btn}" value="@{v5r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-2" title="@{voie5-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v5r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v5r2_use" title="@{v5r2_use} Utilisations" >
                    / <span name="attr_v5r2_use_max" title="@{v5r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r2_freq" title="@{v5r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r3" title="@{v5r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v5r3_spell">
                      <span class="rank-title" name="attr_voie5-t3"></span>
                      <input type="hidden" name="attr_v5r3-btn" value="">
                      <button type="action" class="hidden" name="act_x5r3-btn">
                      <button type="action" class="hidden" name="act_v5r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v5r3" title="%{v5r3-btn}" value="@{v5r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-3" title="@{voie5-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v5r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v5r3_use" title="@{v5r3_use} Utilisations" >
                    / <span name="attr_v5r3_use_max" title="@{v5r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r3_freq" title="@{v5r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r4" title="@{v5r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v5r4_spell">
                      <span class="rank-title" name="attr_voie5-t4"></span>
                      <input type="hidden" name="attr_v5r4-btn" value="">
                      <button type="action" class="hidden" name="act_x5r4-btn">
                      <button type="action" class="hidden" name="act_v5r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v5r4" title="%{v5r4-btn}" value="@{v5r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-4" title="@{voie5-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v5r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v5r4_use" title="@{v5r4_use} Utilisations" >
                    / <span name="attr_v5r4_use_max" title="@{v5r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r4_freq" title="@{v5r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v5r5" title="@{v5r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v5r5_spell">
                      <span class="rank-title" name="attr_voie5-t5"></span>
                      <input type="hidden" name="attr_v5r5-btn" value="">
                      <button type="action" class="hidden" name="act_x5r5-btn">
                      <button type="action" class="hidden" name="act_v5r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v5r5" title="%{v5r5-btn}" value="@{v5r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie5-5" title="@{voie5-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v5r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v5r5_use" title="@{v5r5_use} Utilisations" >
                    / <span name="attr_v5r5_use_max" title="@{v5r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v5r5_freq" title="@{v5r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 6 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie6nom" title="@{voie6nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie6_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie6notes" value="">
                </summary>
                <span name="attr_voie6notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r1" title="@{v6r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v6r1_spell">
                      <span class="rank-title" name="attr_voie6-t1"></span>
                      <input type="hidden" name="attr_v6r1-btn" value="">
                      <button type="action" class="hidden" name="act_x6r1-btn">
                      <button type="action" class="hidden" name="act_v6r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v6r1" title="%{v6r1-btn}" value="@{v6r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-1" title="@{voie6-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v6r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v6r1_use" title="@{v6r1_use} Utilisations" >
                    / <span name="attr_v6r1_use_max" title="@{v6r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r1_freq" title="@{v6r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r2" title="@{v6r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v6r2_spell">
                      <span class="rank-title" name="attr_voie6-t2"></span>
                      <input type="hidden" name="attr_v6r2-btn" value="">
                      <button type="action" class="hidden" name="act_x6r2-btn">
                      <button type="action" class="hidden" name="act_v6r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v6r2" title="%{v6r2-btn}" value="@{v6r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-2" title="@{voie6-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v6r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v6r2_use" title="@{v6r2_use} Utilisations" >
                    / <span name="attr_v6r2_use_max" title="@{v6r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r2_freq" title="@{v6r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r3" title="@{v6r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v6r3_spell">
                      <span class="rank-title" name="attr_voie6-t3"></span>
                      <input type="hidden" name="attr_v6r3-btn" value="">
                      <button type="action" class="hidden" name="act_x6r3-btn">
                      <button type="action" class="hidden" name="act_v6r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v6r3" title="%{v6r3-btn}" value="@{v6r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-3" title="@{voie6-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v6r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v6r3_use" title="@{v6r3_use} Utilisations" >
                    / <span name="attr_v6r3_use_max" title="@{v6r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r3_freq" title="@{v6r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r4" title="@{v6r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v6r4_spell">
                      <span class="rank-title" name="attr_voie6-t4"></span>
                      <input type="hidden" name="attr_v6r4-btn" value="">
                      <button type="action" class="hidden" name="act_x6r4-btn">
                      <button type="action" class="hidden" name="act_v6r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v6r4" title="%{v6r4-btn}" value="@{v6r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-4" title="@{voie6-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v6r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v6r4_use" title="@{v6r4_use} Utilisations" >
                    / <span name="attr_v6r4_use_max" title="@{v6r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r4_freq" title="@{v6r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v6r5" title="@{v6r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v6r5_spell">
                      <span class="rank-title" name="attr_voie6-t5"></span>
                      <input type="hidden" name="attr_v6r5-btn" value="">
                      <button type="action" class="hidden" name="act_x6r5-btn">
                      <button type="action" class="hidden" name="act_v6r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v6r5" title="%{v6r5-btn}" value="@{v6r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie6-5" title="@{voie6-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v6r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v6r5_use" title="@{v6r5_use} Utilisations" >
                    / <span name="attr_v6r5_use_max" title="@{v6r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v6r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <input type="hidden" class="show-paths-4to9" name="attr_voies_789" value="0">
          <div class="abilities">
            <!-- Voie 7 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie7nom" title="@{voie7nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie7_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie7notes" value="">
                </summary>
                <span name="attr_voie7notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r1" title="@{v7r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v7r1_spell">
                      <span class="rank-title" name="attr_voie7-t1"></span>
                      <input type="hidden" name="attr_v7r1-btn" value="">
                      <button type="action" class="hidden" name="act_x7r1-btn">
                      <button type="action" class="hidden" name="act_v7r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v7r1" title="%{v7r1-btn}" value="@{v7r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-1" title="@{voie7-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v7r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v7r1_use" title="@{v7r1_use} Utilisations" >
                    / <span name="attr_v7r1_use_max" title="@{v7r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r1_freq" title="@{v7r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r2" title="@{v7r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v7r2_spell">
                      <span class="rank-title" name="attr_voie7-t2"></span>
                      <input type="hidden" name="attr_v7r2-btn" value="">
                      <button type="action" class="hidden" name="act_x7r2-btn">
                      <button type="action" class="hidden" name="act_v7r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v7r2" title="%{v7r2-btn}" value="@{v7r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-2" title="@{voie7-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v7r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v7r2_use" title="@{v7r2_use} Utilisations" >
                    / <span name="attr_v7r2_use_max" title="@{v7r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r2_freq" title="@{v7r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r3" title="@{v7r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v7r3_spell">
                      <span class="rank-title" name="attr_voie7-t3"></span>
                      <input type="hidden" name="attr_v7r3-btn" value="">
                      <button type="action" class="hidden" name="act_x7r3-btn">
                      <button type="action" class="hidden" name="act_v7r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v7r3" title="%{v7r3-btn}" value="@{v7r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-3" title="@{voie7-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v7r3_use_max" value="0">
                  <div class="ability-uses">
                    <input type="number" name="attr_v7r3_use" title="@{v7r3_use} Utilisations" >
                    / <span name="attr_v7r3_use_max" title="@{v7r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r3_freq" title="@{v7r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r4" title="@{v7r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v7r4_spell">
                      <span class="rank-title" name="attr_voie7-t4"></span>
                      <input type="hidden" name="attr_v7r4-btn" value="">
                      <button type="action" class="hidden" name="act_x7r4-btn">
                      <button type="action" class="hidden" name="act_v7r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v7r4" title="%{v7r4-btn}" value="@{v7r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-4" title="@{voie7-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v7r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v7r4_use" title="@{v7r4_use} Utilisations" >
                    / <span name="attr_v7r4_use_max" title="@{v7r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r4_freq" title="@{v7r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v7r5" title="@{v7r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v7r5_spell">
                      <span class="rank-title" name="attr_voie7-t5"></span>
                      <input type="hidden" name="attr_v7r5-btn" value="">
                      <button type="action" class="hidden" name="act_x7r5-btn">
                      <button type="action" class="hidden" name="act_v7r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v7r5" title="%{v7r5-btn}" value="@{v7r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie7-5" title="@{voie7-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v7r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v7r5_use" title="@{v7r5_use} Utilisations" >
                    / <span name="attr_v7r5_use_max" title="@{v7r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v7r5_freq" title="@{v7r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 8 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie8nom" title="@{voie8nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie8_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie8notes" value="">
                </summary>
                <span name="attr_voie8notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r1" title="@{v8r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v8r1_spell">
                      <span class="rank-title" name="attr_voie8-t1"></span>
                      <input type="hidden" name="attr_v8r1-btn" value="">
                      <button type="action" class="hidden" name="act_x8r1-btn">
                      <button type="action" class="hidden" name="act_v8r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v8r1" title="%{v8r1-btn}" value="@{v8r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-1" title="@{voie8-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v8r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v8r1_use" title="@{v8r1_use} Utilisations" >
                    / <span name="attr_v8r1_use_max" title="@{v8r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r1_freq" title="@{v8r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r2" title="@{v8r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v8r2_spell">
                      <span class="rank-title" name="attr_voie8-t2"></span>
                      <input type="hidden" name="attr_v8r2-btn" value="">
                      <button type="action" class="hidden" name="act_x8r2-btn">
                      <button type="action" class="hidden" name="act_v8r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v8r2" title="%{v8r2-btn}" value="@{v8r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-2" title="@{voie8-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v8r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v8r2_use" title="@{v8r2_use} Utilisations" >
                    / <span name="attr_v8r2_use_max" title="@{v8r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r2_freq" title="@{v8r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r3" title="@{v8r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v8r3_spell">
                      <span class="rank-title" name="attr_voie8-t3"></span>
                      <input type="hidden" name="attr_v8r3-btn" value="">
                      <button type="action" class="hidden" name="act_x8r3-btn">
                      <button type="action" class="hidden" name="act_v8r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v8r3" title="%{v8r3-btn}" value="@{v8r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-3" title="@{voie8-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v8r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v8r3_use" title="@{v8r3_use} Utilisations" >
                    / <span name="attr_v8r3_use_max" title="@{v8r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r3_freq" title="@{v8r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r4" title="@{v8r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v8r4_spell">
                      <span class="rank-title" name="attr_voie8-t4"></span>
                      <input type="hidden" name="attr_v8r4-btn" value="">
                      <button type="action" class="hidden" name="act_x8r4-btn">
                      <button type="action" class="hidden" name="act_v8r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v8r4" title="%{v8r4-btn}" value="@{v8r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-4" title="@{voie8-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v8r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v8r4_use" title="@{v8r4_use} Utilisations" >
                    / <span name="attr_v8r4_use_max" title="@{v8r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r4_freq" title="@{v8r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v8r5" title="@{v8r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v8r5_spell">
                      <span class="rank-title" name="attr_voie8-t5"></span>
                      <input type="hidden" name="attr_v8r5-btn" value="">
                      <button type="action" class="hidden" name="act_x8r5-btn">
                      <button type="action" class="hidden" name="act_v8r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v8r5" title="%{v8r5-btn}" value="@{v8r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie8-5" title="@{voie8-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v8r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v8r5_use" title="@{v8r5_use} Utilisations" >
                    / <span name="attr_v8r5_use_max" title="@{v8r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v8r5_freq" title="@{v8r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
            <!-- Voie 9 -->
            <div class="path">
              <div class="block-title">
                <span name="attr_voie9nom" title="@{voie9nom}"></span>
              </div>
              <button type="action" class="hidden" name="act_voie9_menu-btn"></button>
              <details>
                <summary class="notes">
                  Notes
                  <input type="hidden" class="notes" name="attr_voie9notes" value="">
                </summary>
                <span name="attr_voie9notes"></span>
              </details>
              <!-- Rang 1 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r1" title="@{v9r1}" value="1">
                      <input type="hidden" class="spell" name="attr_v9r1_spell">
                      <span class="rank-title" name="attr_voie9-t1"></span>
                      <input type="hidden" name="attr_v9r1-btn" value="">
                      <button type="action" class="hidden" name="act_x9r1-btn">
                      <button type="action" class="hidden" name="act_v9r1-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v9r1" title="%{v9r1-btn}" value="@{v9r1-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-1" title="@{voie9-1}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v9r1_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v9r1_use" title="@{v9r1_use} Utilisations" >
                    / <span name="attr_v9r1_use_max" title="@{v9r1_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r1_freq" title="@{v9r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 2 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r2" title="@{v9r2}" value="1">
                      <input type="hidden" class="spell" name="attr_v9r2_spell">
                      <span class="rank-title" name="attr_voie9-t2"></span>
                      <input type="hidden" name="attr_v9r2-btn" value="">
                      <button type="action" class="hidden" name="act_x9r2-btn">
                      <button type="action" class="hidden" name="act_v9r2-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v9r2" title="%{v9r2-btn}" value="@{v9r2-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-2" title="@{voie9-2}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v9r2_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v9r2_use" title="@{v9r2_use} Utilisations" >
                    / <span name="attr_v9r2_use_max" title="@{v9r2_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r2_freq" title="@{v9r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 3 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r3" title="@{v9r3}" value="1">
                      <input type="hidden" class="spell" name="attr_v9r3_spell">
                      <span class="rank-title" name="attr_voie9-t3"></span>
                      <input type="hidden" name="attr_v9r3-btn" value="">
                      <button type="action" class="hidden" name="act_x9r3-btn">
                      <button type="action" class="hidden" name="act_v9r3-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v9r3" title="%{v9r3-btn}" value="@{v9r3-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-3" title="@{voie9-3}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v9r3_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v9r3_use" title="@{v9r3_use} Utilisations" >
                    / <span name="attr_v9r3_use_max" title="@{v9r3_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r3_freq" title="@{v9r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 4 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r4" title="@{v9r4}" value="1">
                      <input type="hidden" class="spell" name="attr_v9r4_spell">
                      <span class="rank-title" name="attr_voie9-t4"></span>
                      <input type="hidden" name="attr_v9r4-btn" value="">
                      <button type="action" class="hidden" name="act_x9r4-btn">
                      <button type="action" class="hidden" name="act_v9r4-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v9r4" title="%{v9r4-btn}" value="@{v9r4-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-4" title="@{voie9-4}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v9r4_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v9r4_use" title="@{v9r4_use} Utilisations" >
                    / <span name="attr_v9r4_use_max" title="@{v9r4_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r4_freq" title="@{v9r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
              <!-- Rang 5 -->
              <div class="rank">
                <details>
                  <summary>
                    <div class="rank-summary">
                      <input type="checkbox" name="attr_v9r5" title="@{v9r5}" value="1">
                      <input type="hidden" class="spell" name="attr_v9r5_spell">
                      <span class="rank-title" name="attr_voie9-t5"></span>
                      <input type="hidden" name="attr_v9r5-btn" value="">
                      <button type="action" class="hidden" name="act_x9r5-btn">
                      <button type="action" class="hidden" name="act_v9r5-btn">
                      <button type="roll" class="flat-btn img-btn" name="roll_v9r5" title="%{v9r5-btn}" value="@{v9r5-btn}">
                        <span class="img-btn">w</span>
                      </button>
                    </div>
                  </summary>
                  <span name="attr_voie9-5" title="@{voie9-5}"></span>
                  <input type="hidden" class="ability-uses" name="attr_v9r5_use_max" value="0">
                  <div class="ability-uses">                  
                    <input type="number" name="attr_v9r5_use" title="@{v9r5_use} Utilisations" >
                    / <span name="attr_v9r5_use_max" title="@{v9r5_use_max} Nombre d'utilisations maximum" ></span> par <span name="attr_v9r5_freq" title="@{v9r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." ></span>
                  </div>
                </details>
              </div>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Capacités, Mode Edition -->
        <datalist id="abilities-freqs">
          <option value="combat"></option>
          <option value="jour"></option>
          <option value="aventure"></option>
        </datalist>
        <div class="abilities-edit">
          <div class="d-flex d-flex-between">
            <div>
              <h3>CAPACITES</h3>
            </div>
            <div class="change-view">
              <button type="action" class="flat-btn img-btn" name="act_edit_view-btn" title="Afficher les voies et capacités">
                <span class="img-btn"></span>Afficher
              </button>
              <input type="hidden" name="attr_abilities_edit" value="1">
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 1-3 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">1 - Voie de peuple</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie1nom" title="@{voie1nom}" value="1 - Voie de peuple">
                PV&nbsp;<input type="number" name="attr_voie1pv" title="@{voie1pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v1-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie1notes" title="@{voie1notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t1" title="@{voie1-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r1_spell" title="@{v1r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-1" title="@{voie1-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r1_use_max" title="@{v1r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v1r1_freq" title="@{v1r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text"  name="attr_v1r1_param" title="@{v1r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v1r1_props" title="@{v1r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t2" title="@{voie1-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r2_spell" title="@{v1r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-2" title="@{voie1-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r2_use_max" title="@{v1r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v1r2_freq" title="@{v1r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v1r2_param" title="@{v1r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v1r2_props" title="@{v1r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t3" title="@{voie1-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r3_spell" title="@{v1r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-3" title="@{voie1-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r3_use_max" title="@{v1r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v1r3_freq" title="@{v1r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v1r3_param" title="@{v1r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v1r3_props" title="@{v1r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t4" title="@{voie1-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r4_spell" title="@{v1r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-4" title="@{voie1-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r4_use_max" title="@{v1r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v1r4_freq" title="@{v1r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v1r4_param" title="@{v1r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v1r4_props" title="@{v1r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie1-t5" title="@{voie1-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v1r5_spell" title="@{v1r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie1-5" title="@{voie1-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v1r5_use_max" title="@{v1r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v1r5_freq" title="@{v1r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v1r5_param" title="@{v1r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v1r5_props" title="@{v1r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">2 - Voie de profil</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie2nom" title="@{voie2nom}" value="2 - Voie de profil">
                PV&nbsp;<input type="number" name="attr_voie2pv" title="@{voie2pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v2-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie2notes" title="@{voie2notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t1" title="@{voie2-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r1_spell" title="@{v2r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-1" title="@{voie2-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r1_use_max" title="@{v2r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v2r1_freq" title="@{v2r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v2r1_param" title="@{v2r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v2r1_props" title="@{v2r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t2" title="@{voie2-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r2_spell" title="@{v2r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-2" title="@{voie2-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r2_use_max" title="@{v2r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v2r2_freq" title="@{v2r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v2r2_param" title="@{v2r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v2r2_props" title="@{v2r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t3" title="@{voie2-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r3_spell" title="@{v2r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-3" title="@{voie2-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r3_use_max" title="@{v2r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v2r3_freq" title="@{v2r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v2r3_param" title="@{v2r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v2r3_props" title="@{v2r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t4" title="@{voie2-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r4_spell" title="@{v2r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-4" title="@{voie2-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r4_use_max" title="@{v2r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v2r4_freq" title="@{v2r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v2r4_param" title="@{v2r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v2r4_props" title="@{v2r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie2-t5" title="@{voie2-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v2r5_spell" title="@{v2r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie2-5" title="@{voie2-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v2r5_use_max" title="@{v2r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v2r5_freq" title="@{v2r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v2r5_param" title="@{v2r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v2r5_props" title="@{v2r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">3 - Voie de profil</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie3nom" title="@{voie3nom}" value="3 - Voie de profil">
                PV&nbsp;<input type="number" name="attr_voie3pv" title="@{voie3pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v3-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie3notes" title="@{voie3notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t1" title="@{voie3-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r1_spell" title="@{v3r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-1" title="@{voie3-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r1_use_max" title="@{v3r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v3r1_freq" title="@{v3r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v3r1_param" title="@{v3r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v3r1_props" title="@{v3r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t2" title="@{voie3-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r2_spell" title="@{v3r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-2" title="@{voie3-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r2_use_max" title="@{v3r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v3r2_freq" title="@{v3r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v3r2_param" title="@{v3r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v3r2_props" title="@{v3r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t3" title="@{voie3-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r3_spell" title="@{v3r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-3" title="@{voie3-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r3_use_max" title="@{v3r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v3r3_freq" title="@{v3r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v3r3_param" title="@{v3r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v3r3_props" title="@{v3r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t4" title="@{voie3-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r4_spell" title="@{v3r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-4" title="@{voie3-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r4_use_max" title="@{v3r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v3r4_freq" title="@{v3r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v3r4_param" title="@{v3r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v3r4_props" title="@{v3r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie3-t5" title="@{voie3-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v3r5_spell" title="@{v3r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie3-5" title="@{voie3-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v3r5_use_max" title="@{v3r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v3r5_freq" title="@{v3r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v3r5_param" title="@{v3r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v3r5_props" title="@{v3r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 4-6 -->
          <div class="abilities">
            <div class="path bordered">
              <div class="block-title">4 - Voie de profil</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie4nom" title="@{voie4nom}" value="4 - Voie de profil">
                PV&nbsp;<input type="number" name="attr_voie4pv" title="@{voie4pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v4-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie4notes" title="@{voie4notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t1" title="@{voie4-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r1_spell" title="@{v4r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-1" title="@{voie4-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r1_use_max" title="@{v4r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v4r1_freq" title="@{v4r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v4r1_param" title="@{v4r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v4r1_props" title="@{v4r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t2" title="@{voie4-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r2_spell" title="@{v4r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-2" title="@{voie4-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r2_use_max" title="@{v4r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v4r2_freq" title="@{v4r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v4r2_param" title="@{v4r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v4r2_props" title="@{v4r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t3" title="@{voie4-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r3_spell" title="@{v4r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-3" title="@{voie4-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r3_use_max" title="@{v4r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v4r3_freq" title="@{v4r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v4r3_param" title="@{v4r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v4r3_props" title="@{v4r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t4" title="@{voie4-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r4_spell" title="@{v4r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-4" title="@{voie4-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r4_use_max" title="@{v4r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v4r4_freq" title="@{v4r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v4r4_param" title="@{v4r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v4r4_props" title="@{v4r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie4-t5" title="@{voie4-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v4r5_spell" title="@{v4r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie4-5" title="@{voie4-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v4r5_use_max" title="@{v4r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v4r5_freq" title="@{v4r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v4r5_param" title="@{v4r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v4r5_props" title="@{v4r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">5 - Voie de profil</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie5nom" title="@{voie5nom}" value="5 - Voie de profil">
                PV&nbsp;<input type="number" name="attr_voie5pv" title="@{voie5pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v5-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie5notes" title="@{voie5notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t1" title="@{voie5-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r1_spell" title="@{v5r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-1" title="@{voie5-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r1_use_max" title="@{v5r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v5r1_freq" title="@{v5r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v5r1_param" title="@{v5r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v5r1_props" title="@{v5r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t2" title="@{voie5-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r2_spell" title="@{v5r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-2" title="@{voie5-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r2_use_max" title="@{v5r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v5r2_freq" title="@{v5r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v5r2_param" title="@{v5r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v5r2_props" title="@{v5r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t3" title="@{voie5-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r3_spell" title="@{v5r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-3" title="@{voie5-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r3_use_max" title="@{v5r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v5r3_freq" title="@{v5r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v5r3_param" title="@{v5r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v5r3_props" title="@{v5r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t4" title="@{voie5-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r4_spell" title="@{v5r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-4" title="@{voie5-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r4_use_max" title="@{v5r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v5r4_freq" title="@{v5r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v5r4_param" title="@{v5r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v5r4_props" title="@{v5r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie5-t5" title="@{voie5-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v5r5_spell" title="@{v5r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie5-5" title="@{voie5-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v5r5_use_max" title="@{v5r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v5r5_freq" title="@{v5r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v5r5_param" title="@{v5r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v5r5_props" title="@{v5r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path bordered">
              <div class="block-title">6 - Voie de profil</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie6nom" title="@{voie6nom}" value="6 - Voie de profil">
                PV&nbsp;<input type="number" name="attr_voie6pv" title="@{voie6pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v6-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie6notes" title="@{voie6notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t1" title="@{voie6-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r1_spell" title="@{v6r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-1" title="@{voie6-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r1_use_max" title="@{v6r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v6r1_freq" title="@{v6r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v6r1_param" title="@{v6r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v6r1_props" title="@{v6r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t2" title="@{voie6-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r2_spell" title="@{v6r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-2" title="@{voie6-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r2_use_max" title="@{v6r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v6r2_freq" title="@{v6r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v6r2_param" title="@{v6r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v6r2_props" title="@{v6r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t3" title="@{voie6-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r3_spell" title="@{v6r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-3" title="@{voie6-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r3_use_max" title="@{v6r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v6r3_freq" title="@{v6r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v6r3_param" title="@{v6r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v6r3_props" title="@{v6r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t4" title="@{voie6-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r4_spell" title="@{v6r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-4" title="@{voie6-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r4_use_max" title="@{v6r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v6r4_freq" title="@{v6r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v6r4_param" title="@{v6r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v6r4_props" title="@{v6r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie6-t5" title="@{voie6-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v6r5_spell" title="@{v6r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie6-5" title="@{voie6-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v6r5_use_max" title="@{v6r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v6r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v6r5_param" title="@{v6r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v6r5_props" title="@{v6r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Fiche PJ, Onglet Capacités, Voies 7-9 -->
          <div class="abilities">
            <div class="path">
              <div class="block-title">7 - Voie de prestige 1</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie7nom" title="@{voie7nom}" value="7 - Voie de prestige 1">
                PV&nbsp;<input type="number" name="attr_voie7pv" title="@{voie7pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v7-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie7notes" title="@{voie7notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t1" title="@{voie7-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r1_spell" title="@{v7r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-1" title="@{voie7-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r1_use_max" title="@{v7r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v7r1_freq" title="@{v7r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v7r1_param" title="@{v7r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v7r1_props" title="@{v7r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t2" title="@{voie7-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r2_spell" title="@{v7r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-2" title="@{voie7-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r2_use_max" title="@{v7r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v7r2_freq" title="@{v7r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v7r2_param" title="@{v7r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v7r2_props" title="@{v7r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t3" title="@{voie7-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r3_spell" title="@{v7r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-3" title="@{voie7-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r3_use_max" title="@{v7r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v7r3_freq" title="@{v7r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v7r3_param" title="@{v7r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v7r3_props" title="@{v7r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t4" title="@{voie7-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r4_spell" title="@{v7r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-4" title="@{voie7-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r4_use_max" title="@{v7r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v7r4_freq" title="@{v7r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v7r4_param" title="@{v7r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v7r4_props" title="@{v7r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie7-t5" title="@{voie7-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v7r5_spell" title="@{v7r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie7-5" title="@{voie7-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v7r5_use_max" title="@{v7r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v7r5_freq" title="@{v7r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v7r5_param" title="@{v7r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v7r5_props" title="@{v7r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path">
              <div class="block-title">8 - Voie de prestige 2</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie8nom" title="@{voie8nom}" value="8 - Voie de prestige 2">
                PV&nbsp;<input type="number" name="attr_voie8pv" title="@{voie8pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v8-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie8notes" title="@{voie8notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t1" title="@{voie8-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r1_spell" title="@{v8r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-1" title="@{voie8-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r1_use_max" title="@{v8r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v8r1_freq" title="@{v8r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v8r1_param" title="@{v8r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v8r1_props" title="@{v8r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t2" title="@{voie8-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r2_spell" title="@{v8r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-2" title="@{voie8-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r2_use_max" title="@{v8r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v8r2_freq" title="@{v8r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v8r2_param" title="@{v8r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v8r2_props" title="@{v8r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t3" title="@{voie8-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r3_spell" title="@{v8r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-3" title="@{voie8-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r3_use_max" title="@{v8r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v8r3_freq" title="@{v8r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v8r3_param" title="@{v8r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v8r3_props" title="@{v8r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t4" title="@{voie8-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r4_spell" title="@{v8r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-4" title="@{voie8-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r4_use_max" title="@{v8r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v8r4_freq" title="@{v8r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v8r4_param" title="@{v8r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v8r4_props" title="@{v8r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie8-t5" title="@{voie8-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v8r5_spell" title="@{v8r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie8-5" title="@{voie8-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v8r5_use_max" title="@{v8r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v8r5_freq" title="@{v8r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v8r5_param" title="@{v8r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v8r5_props" title="@{v8r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
            <div class="path">
              <div class="block-title">Voie n°9</div>
              <div class="path-title d-flex">
                <input type="text" name="attr_voie9nom" title="@{voie9nom}" value="Voie n°9">
                PV&nbsp;<input type="number" name="attr_voie9pv" title="@{voie9pv}" value="">
                <button type="action" class="flat-btn img-btn" name="act_import_v9-btn" title="Importer les capacités">
                  <span class="img-btn">W</span>
                </button>
              </div>
              <textarea class="one-row" name="attr_voie9notes" title="@{voie9notes}" placeholder="Notes"></textarea>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t1" title="@{voie9-t1}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r1_spell" title="@{v9r1_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-1" title="@{voie9-1}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r1_use_max" title="@{v9r1_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v9r1_freq" title="@{v9r1_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v9r1_param" title="@{v9r1_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v9r1_props" title="@{v9r1_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t2" title="@{voie9-t2}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r2_spell" title="@{v9r2_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-2" title="@{voie9-2}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r2_use_max" title="@{v9r2_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v9r2_freq" title="@{v9r2_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v9r2_param" title="@{v9r2_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v9r2_props" title="@{v9r2_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t3" title="@{voie9-t3}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r3_spell" title="@{v9r3_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-3" title="@{voie9-3}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r3_use_max" title="@{v9r3_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v9r3_freq" title="@{v9r3_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v9r3_param" title="@{v9r3_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v9r3_props" title="@{v9r3_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t4" title="@{voie9-t4}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r4_spell" title="@{v9r4_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-4" title="@{voie9-4}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r4_use_max" title="@{v9r4_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v9r4_freq" title="@{v9r4_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v9r4_param" title="@{v9r4_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v9r4_props" title="@{v9r4_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
              <div class="rank">
                <div class="d-flex">
                  <input type="text" name="attr_voie9-t5" title="@{voie9-t5}" placeholder="Nom de la capacité">
                  <input type="checkbox" name="attr_v9r5_spell" title="@{v9r5_spell} Est un sort" value="1">
                </div>
                <textarea name="attr_voie9-5" title="@{voie9-5}" placeholder="Description"></textarea>
                <div class="d-flex">
                  <input type="number" name="attr_v9r5_use_max" title="@{v9r5_use_max} Nombre d'utilisations maximum" value="">
                  <input type="text" list="abilities-freqs" name="attr_v9r5_freq" title="@{v6r5_freq} Fréquence d'utilisation" placeholder="Par combat, par jour..." value="">
                </div>
                <div class="d-flex">
                  <input type="text" name="attr_v9r5_param" title="@{v9r5_param} Paramètre de capacité" placeholder="Paramètre de capacité" value="">
                </div>
                <div class="d-flex">
                  <textarea class="one-row" name="attr_v9r5_props" title="@{v9r5_props} Propriétés de capacité&#10;initial: capacité niveau 1&#10;doublon: doublon de capacité" placeholder="Propriétés de capacité"></textarea>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet Capacités, Sous-onglets -->
        <input type="hidden" class="tabs-toggle" name="attr_pc_subtab2" value="rolls" />
        <div class="pc-subtabs">
          <button type="action" name="act_pc_rolls-btn" class="sub-tab tab-btn pc-rolls-btn">JETS</button>
          <button type="action" name="act_pc_master-btn" class="sub-tab tab-btn pc-master-btn">MAITRISES</button>
          <input type="hidden" class="pc-skills-btn" name="attr_use_skills" value="0">
          <button type="action" name="act_pc_skills-btn" class="sub-tab tab-btn pc-skills-btn">COMPETENCES</button>
          <button type="action" name="act_pc_buffs-btn" class="sub-tab tab-btn pc-buffs-btn">BUFFS</button>
          <button type="action" name="act_pc_import-btn" class="sub-tab tab-btn pc-import-btn">IMPORT</button>
        </div>
        
        <hr>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Jets -->
        <div class="pc-rolls-subtab">
          
          <div class="pc-roll-r1">
            <div>&nbsp;</div>
            <h4>
              Nom
              <button type="action" class="flat-btn img-btn" name="act_rolls_menu-btn" title="%{rolls_menu-btn} Menu des jets de capacités">
                <span class="img-btn">l</span>
              </button>
            </h4>
            <h4>Capacité / Compétence</h4>
            <h4>Description / Jet spécial</h4>
          </div>

          <fieldset class="repeating_rolls">

            <div class="pc-roll-r1">

              <div>
                <input type="hidden" name="attr_roll-btn" value="">
                <button class="hidden" type="action" name="act_roll-btn">
                  <span class="d20-btn">t</span>
                </button>
                <button type="roll" class="flat-btn" name="roll_roll" title="%{repeating_rolls_ID_roll-btn}" value="@{roll-btn}"/>
              </div>

              <div class="d-flex d-flex-middle bordered">
                <input type="text" name="attr_roll-nom" title="@{roll-nom} Nom du jet ou compétence" placeholder="Nom du jet" value="">
              </div>

              <div class="d-flex d-flex-middle bordered">
                <select class="select-xs" name="attr_roll-type" title="@{roll-type} Type de jet">
                  <option value="1d20" selected>No - Normal</option>
                  <option value="2d20kh1">Db - Dé bonus</option>
                  <option value="2d20kl1">Dm - Dé malus</option>
                  <option value="0">Jet - Autre</option>
                </select>
                <span class="align-self-center">&nbsp;+&nbsp;</span>
                <select class="select-sm" name="attr_roll-carac" title="@{roll-carac} Bonus de caractéristique">
                  <option value="0" selected>-</option>
                  <option value="@{agi_test}">AGI</option>
                  <option value="@{con_test}">CON</option>
                  <option value="@{for_test}">FOR</option>
                  <option value="@{per_test}">PER</option>
                  <option value="@{cha_test}">CHA</option>
                  <option value="@{int_test}">INT</option>
                  <option value="@{vol_test}">VOL</option>
                  <option value="?">Demander</option>
                </select>
                <span class="align-self-center">+ Rang</span>
                <select class="select-md" name="attr_roll-voie" title="@{roll-voie} Rang dans la voie">
                  <option value="0" selected>-</option>
                  <option value="1">Voie 1</option>
                  <option value="2">Voie 2</option>
                  <option value="3">Voie 3</option>
                  <option value="4">Voie 4</option>
                  <option value="5">Voie 5</option>
                  <option value="6">Voie 6</option>
                  <option value="7">Voie 7</option>
                  <option value="8">Voie 8</option>
                  <option value="9">Voie 9</option>
                </select>
                <span class="align-self-center">&nbsp;+&nbsp;</span>
                <input type="number" class="two-digits" name="attr_roll-bonus" title="@{roll-bonus} Bonus de compétence" value="0">
              </div>
              
              <div class="d-flex d-flex-middle bordered">
                <textarea class="one-row" name="attr_roll-cmd" title="@{roll-cmd} Autre jet de dés" placeholder="Jet spécial ou description"></textarea>
              </div>

            </div>

            <!--
            <div class="pc-roll-r2">

              <div>

              </div>

              <div class="bordered">
                Compétence (CAR)
              </div>

              <div class="bordered">
                Description
              </div>

            </div>
            -->
            
          </fieldset>

        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Maitrises -->
        <div class="pc-master-subtab">

          <div class="sheet-3colrow">
            <div class="sheet-col">
              <h4>Langues</h4>
              <div>
                <input type="checkbox" name="attr_lang_abyssal" value="1">
                <span title="Démons, élémentaires du feu">Abyssal</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_aquarien" value="1">
                <span title="Créatures sous-marines, élementaires de l'eau">Aquarien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_argotien" value="1">
                <span title="Argot des voleurs et langue des signes">Argotien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_celestien" value="1">
                <span title="Anges, créatures des plans supérieurs, élémentaires de l'air">Célestien</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_commun" value="1">
                <span title="Humains, halfelins">Commun</span>
              </div>
            </div>
            <div class="sheet-col">
              <h4>&nbsp;</h4>
              <div>
                <input type="checkbox" name="attr_lang_draconique" value="1">
                <span title="Dragons, kobolds, hommes-lézards">Draconique</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_noirparle" value="1">
                <span title="Goblinoïdes, orcs, ogres, trolls, créatures maléfiques">Noir parlé</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_profond" value="1">
                <span title="Créatures souterraines (elfes des profondeurs)">Profond</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_runique" value="1">
                <span title="Gnomes, nains, géants, élémentaires de la terre">Runique</span>
              </div>
              <div>
                <input type="checkbox" name="attr_lang_sylvestre" value="1">
                <span title="Elfes, fées, dryades, sylvaniens">Sylvestre</span>
              </div>
            </div>
            <div class="sheet-col">
              <h4>Armes</h4>
              <div>
                <textarea class="one-row" name="attr_maitrises_armes" title="@{maitrises_armes}" placeholder="Autres maitrises d'armes"></textarea>
              </div>
              <h4>Armures</h4>
              <textarea class="one-row" name="attr_maitrises_armures" title="@{maitrises_armures}" placeholder="Autres maitrises d'armures"></textarea>
            </div>
          </div>

        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Compétences -->
        <div class="pc-skills-subtab">
          <button type="action" class="hidden" name="act_skills_menu-btn"></button>
          <div class="sheet-2colrow">

            <div class="sheet-col">

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_acrobaties_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-acrobaties"
                  title="Esquiver&#10;Garder son équilibre&#10;Chuter sans danger&#10;Faire un roulé-boulé">
                    <span class="img-btn"></span>Acrobaties
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_acrobaties_def" value="@{agi}">
                  <select class="select-md" name="attr_acrobaties_carac" title="@{acrobaties_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_acrobaties_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_artisanat_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-artisanat"
                  title="Concevoir et fabriquer des objets (forgeron, armurier, cuisinier...)">
                    <span class="img-btn"></span>Artisanat
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_artisanat_def" value="@{int}">
                  <select class="select-md" name="attr_artisanat_carac" title="@{artisanat_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_artisanat_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_athletisme_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-athletisme-agi" />
                  <button type="action" class="hidden" name="act_skill-athletisme-con" />
                  <button type="action" class="hidden" name="act_skill-athletisme-for" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-athletisme"
                  title="Courir et sauter (AGI)&#10;Lancer loin ou soulever (FOR)&#10;Marcher ou courir longtemps (CON)">
                    <span class="img-btn"></span>Athlétisme
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_athletisme_def" value="?">
                  <select class="select-md" name="attr_athletisme_carac" title="@{athletisme_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_athletisme_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_commerce_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-commerce"
                  title="Estimer la valeur d'un objet&#10;Trouver un article rare&#10;Négocier son prix">
                    <span class="img-btn"></span>Commerce
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_commerce_def" value="@{cha}">
                  <select class="select-md" name="attr_commerce_carac" title="@{commerce_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_commerce_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_connaissance_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-connaissance"
                  title="Histoire, Géographie, Erudition">
                    <span class="img-btn"></span>Connaissance
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_connaissance_def" value="@{int}">
                  <select class="select-md" name="attr_connaissance_carac" title="@{connaissance_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_connaissance_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_discretion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-discretion"
                  title="Se cacher en forêt&#10;Se fondre dans la foule&#10;Marcher silencieusement">
                    <span class="img-btn"></span>Discrétion
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_discretion_def" value="@{agi}">
                  <select class="select-md" name="attr_discretion_carac" title="@{discretion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_discretion_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_divertissement_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-divertissement"
                  title="Arts vivants (danse, chant, poésie, théâtre)">
                    <span class="img-btn"></span>Divertissement
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_divertissement_def" value="@{cha}">
                  <select class="select-md" name="attr_divertissement_carac" title="@{divertissement_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_divertissement_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_equitation_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-equitation-agi" />
                  <button type="action" class="hidden" name="act_skill-equitation-cha" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-equitation"
                  title="Monter à cheval (AGI)&#10;Maîtriser et calmer une monture (CHA)">
                    <span class="img-btn"></span>Equitation
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_equitation_def" value="?">
                  <select class="select-md" name="attr_equitation_carac" title="@{equitation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_equitation_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_escalade_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-escalade"
                  title="Grimper à la corde, dans un arbre, une façade ou une falaise">
                    <span class="img-btn"></span>Escalade
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_escalade_def" value="@{agi}">
                  <select class="select-md" name="attr_escalade_carac" title="@{escalade_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_escalade_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_effraction_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-effraction"
                  title="Crocheter une serrure&#10;Désamorcer un piège&#10;Pickpocket">
                    <span class="img-btn"></span>Effraction
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_effraction_def" value="@{agi}">
                  <select class="select-md" name="attr_effraction_carac" title="@{effraction_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}" selected>AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_effraction_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_empathie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-empathie"
                  title="Jauger l'état émotionnel d'un interlocuteur&#10;Discerner un mensonge">
                    <span class="img-btn"></span>Empathie
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_empathie_def" value="@{per}">
                  <select class="select-md" name="attr_empathie_carac" title="@{empathie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_empathie_bonus" value="0">
                </div>
              </div>

              <input type="hidden" class="custom-skill" name="attr_custom1_skillname" value="">
              <div class="custom-skill custom-skill-top d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_custom1_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-custom1-agi" />
                  <button type="action" class="hidden" name="act_skill-custom1-con" />
                  <button type="action" class="hidden" name="act_skill-custom1-for" />
                  <button type="action" class="hidden" name="act_skill-custom1-per" />
                  <button type="action" class="hidden" name="act_skill-custom1-cha" />
                  <button type="action" class="hidden" name="act_skill-custom1-int" />
                  <button type="action" class="hidden" name="act_skill-custom1-vol" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-custom1">
                    <span class="img-btn"></span><span name="attr_custom1_skillname"></span>
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_custom1_def" value="?">
                  <select class="select-md" name="attr_custom1_carac" title="@{custom1_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_custom1_bonus" value="0">
                </div>
              </div>

              <input type="hidden" class="custom-skill" name="attr_custom3_skillname" value="">
              <div class="custom-skill d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_custom3_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-custom3-agi" />
                  <button type="action" class="hidden" name="act_skill-custom3-con" />
                  <button type="action" class="hidden" name="act_skill-custom3-for" />
                  <button type="action" class="hidden" name="act_skill-custom3-per" />
                  <button type="action" class="hidden" name="act_skill-custom3-cha" />
                  <button type="action" class="hidden" name="act_skill-custom3-int" />
                  <button type="action" class="hidden" name="act_skill-custom3-vol" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-custom3">
                    <span class="img-btn"></span><span name="attr_custom3_skillname"></span>
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_custom3_def" value="?">
                  <select class="select-md" name="attr_custom3_carac" title="@{custom3_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_custom3_bonus" value="0">
                </div>
              </div>
              
            </div>

            <div class="sheet-col">
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_intimidation_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-intimidation"
                  title="Impressionner un interlocuteur&#10;Commander des troupes">
                    <span class="img-btn"></span>Intimidation
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_intimidation_def" value="@{cha}">
                  <select class="select-md" name="attr_intimidation_carac" title="@{intimidation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_intimidation_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_medecine_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-medecine"
                  title="Premiers soins&#10;Diagnostiquer ou soigner une maladie, un empoisonnement">
                    <span class="img-btn"></span>Médecine
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_medecine_def" value="@{per}">
                  <select class="select-md" name="attr_medecine_carac" title="@{medecine_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_medecine_bonus" value="0">
                </div>
              </div>

              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_natation_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-natation"
                  title="Ne pas se noyer, lutter contre les flots, retenir sa respiration&#10;Manoeuvrer à bord d'un navire">
                    <span class="img-btn"></span>Natation
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_natation_def" value="@{con}">
                  <select class="select-md" name="attr_natation_carac" title="@{natation_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}" selected>CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_natation_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_occultisme_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-occultisme"
                  title="Connaissance de la magie, des arts occultes et créatures magiques">
                    <span class="img-btn"></span>Occultisme
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_occultisme_def" value="@{int}">
                  <select class="select-md" name="attr_occultisme_carac" title="@{occultisme_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_occultisme_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_persuasion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-persuasion"
                  title="Négociations, commandement et autres interactions sociales">
                    <span class="img-btn"></span>Persuasion
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_persuasion_def" value="@{cha}">
                  <select class="select-md" name="attr_persuasion_carac" title="@{persuasion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_persuasion_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_religion_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-religion"
                  title="Connaissance des dieux et de la théologie&#10;Peut être utilisé à la place de persuasion auprès d'un prêtre">
                    <span class="img-btn"></span>Religion
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_religion_def" value="@{int}">
                  <select class="select-md" name="attr_religion_carac" title="@{religion_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_religion_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_renseignement_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-renseignement"
                  title="Obtenir une information ou rumeur&#10;Ecouter une conversation&#10;Interroger un suspect ou un témoin">
                    <span class="img-btn"></span>Renseignement
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_renseignement_def" value="@{cha}">
                  <select class="select-md" name="attr_renseignement_carac" title="@{renseignement_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_renseignement_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_sciences_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-sciences"
                  title="Mathématiques, sciences physiques, cartographie, énigmes">
                    <span class="img-btn"></span>Sciences
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_sciences_def" value="@{int}">
                  <select class="select-md" name="attr_sciences_carac" title="@{sciences_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}" selected>INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_sciences_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_tromperie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-tromperie"
                  title="Se déguiser, imiter une voix, mentir, faire diversion">
                    <span class="img-btn"></span>Tromperie
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_tromperie_def" value="@{cha}">
                  <select class="select-md" name="attr_tromperie_carac" title="@{tromperie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}" selected>CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_tromperie_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_survie_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-survie"
                  title="Pister, s'orienter, éviter les dangers des milieux naturels&#10;Connaissances des créatures sauvages et animaux fantastiques">
                    <span class="img-btn"></span>Survie
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_survie_def" value="@{per}">
                  <select class="select-md" name="attr_survie_carac" title="@{survie_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_survie_bonus" value="0">
                </div>
              </div>
              
              <div class="d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_vigilance_prof" value="1">
                  <button type="action" class="flat-btn img-btn" name="act_skill-vigilance"
                  title="Monter la garde, détecter un embuscade, un passage secret ou un piège">
                    <span class="img-btn"></span>Vigilance
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_vigilance_def" value="@{per}">
                  <select class="select-md" name="attr_vigilance_carac" title="@{vigilance_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}" selected>PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?">Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_vigilance_bonus" value="0">
                </div>
              </div>

              <input type="hidden" class="custom-skill" name="attr_custom2_skillname" value="">
              <div class="custom-skill custom-skill-top d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_custom2_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-custom2-agi" />
                  <button type="action" class="hidden" name="act_skill-custom2-con" />
                  <button type="action" class="hidden" name="act_skill-custom2-for" />
                  <button type="action" class="hidden" name="act_skill-custom2-per" />
                  <button type="action" class="hidden" name="act_skill-custom2-cha" />
                  <button type="action" class="hidden" name="act_skill-custom2-int" />
                  <button type="action" class="hidden" name="act_skill-custom2-vol" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-custom2">
                    <span class="img-btn"></span><span name="attr_custom2_skillname"></span>
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_custom2_def" value="?">
                  <select class="select-md" name="attr_custom2_carac" title="@{custom2_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_custom2_bonus" value="0">
                </div>
              </div>
              
              <input type="hidden" class="custom-skill" name="attr_custom4_skillname" value="">
              <div class="custom-skill d-flex d-flex-between">
                <div>
                  <input type="checkbox" name="attr_custom4_prof" value="1">
                  <button type="action" class="hidden" name="act_skill-custom4-agi" />
                  <button type="action" class="hidden" name="act_skill-custom4-con" />
                  <button type="action" class="hidden" name="act_skill-custom4-for" />
                  <button type="action" class="hidden" name="act_skill-custom4-per" />
                  <button type="action" class="hidden" name="act_skill-custom4-cha" />
                  <button type="action" class="hidden" name="act_skill-custom4-int" />
                  <button type="action" class="hidden" name="act_skill-custom4-vol" />
                  <button type="action" class="flat-btn img-btn" name="act_skill-custom4">
                    <span class="img-btn"></span><span name="attr_custom4_skillname"></span>
                  </button>
                </div>
                <div>
                  <input type="hidden" name="attr_custom4_def" value="?">
                  <select class="select-md" name="attr_custom4_carac" title="@{custom4_carac} Bonus de caractéristique">
                    <option value="0">-</option>
                    <option value="@{agi}">AGI</option>
                    <option value="@{con}">CON</option>
                    <option value="@{for}">FOR</option>
                    <option value="@{per}">PER</option>
                    <option value="@{cha}">CHA</option>
                    <option value="@{int}">INT</option>
                    <option value="@{vol}">VOL</option>
                    <option value="?" selected>Demander</option>
                  </select>
                  <span>+</span>
                  <input type="number" class="two-digits" name="attr_custom4_bonus" value="0">
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Buffs -->
        <div class="pc-buffs-subtab">
          <div class="pc-buffs">
            <h4>
              Nom
              <button type="action" name="act_multibuff-btn" class="img-btn flat-btn" title="Activer/désactiver un buff temporaire par nom" >
                <span class="img-btn">Q</span>
              </button>
            </h4>
            <h4>Attribut cible</h4>
            <h4>
              Valeur
              <button type="action" name="act_helpbuff-btn" class="img-btn flat-btn" title="Aide au paramétage des buffs" >
                <span class="img-btn img-btn-lg">i</span>
              </button>
            </h4>
          </div>

          <fieldset class="repeating_buffs">

            <div class="pc-buffs">

              <div class="bordered d-flex">
  
                <input type="checkbox" name="attr_buff-on" title="@{buff-on} Actif/Inactif" value="1">
                <input type="text" name="attr_buff-nom" title="@{buff-nom}" placeholder="Nom du buff/debuff" value="">
                <input type="checkbox" name="attr_buff-temp" title="@{buff-temp} Temporaire" value="1">
  
              </div>

              <div class="bordered d-flex">
                <select class="select-lg" name="attr_buff-attrib" title="@{buff-attrib} Cible du buff/debuff">
                  <optgroup label="Caractéristiques">
                    <option disabled class="optgroup">
                      &nbsp;Caractéristiques
                    </option>
                    <option value="agi">AGI</option>
                    <option value="con">CON</option>
                    <option value="for">FOR</option>
                    <option value="per">PER</option>
                    <option value="cha">CHA</option>
                    <option value="int">INT</option>
                    <option value="vol">VOL</option>
                  </optgroup>
                  <optgroup label="Tests">
                    <option disabled class="optgroup">
                      &nbsp;Tests
                    </option>
                    <option value="tagi">AGI</option>
                    <option value="tcon">CON</option>
                    <option value="tfor">FOR</option>
                    <option value="tper">PER</option>
                    <option value="tcha">CHA</option>
                    <option value="tint">INT</option>
                    <option value="tvol">VOL</option>
                    <option value="*car">Tests de caracs</option>
                  </optgroup>
                  <optgroup label="Combat">
                    <option disabled class="optgroup">
                      &nbsp;Combat
                    </option>
                    <option value="init">Initiative</option>
                    <option value="def">Défense</option>
                    <option value="dm" title="DM non doublés si coup critique">DM</option>
                  </optgroup>
                  <optgroup label="Attaques">
                    <option disabled class="optgroup">
                      &nbsp;Attaques
                    </option>
                    <option value="atkcac">Contact</option>
                    <option value="atktir">Distance</option>
                    <option value="atkmag">Magique</option>                    
                    <option value="*atk">Tests d'attaque</option>                    
                  </optgroup>
                  <optgroup label="Ressources">
                    <option disabled class="optgroup">
                      &nbsp;Ressources
                    </option>
                    <option value="pv">Points de Vigueur</option>
                    <option value="dr">Dés de Récup.</option>
                    <option value="pm">Points de Mana</option>
                    <option value="pc">Points de Chance</option>
                  </optgroup>
                </select>
              </div>
  
              <div class="bordered d-flex">
  
                <input type="text" name="attr_buff-value" title="@{buff-value}" placeholder="Valeur fixe ou [CAR] ou [rang voie]" value="">
  
              </div>

            </div>


          </fieldset>

          <hr>

          <input type="hidden" name="attr_agi_buff_list" value="">
          <input type="hidden" name="attr_con_buff_list" value="">
          <input type="hidden" name="attr_for_buff_list" value="">
          <input type="hidden" name="attr_per_buff_list" value="">
          <input type="hidden" name="attr_cha_buff_list" value="">
          <input type="hidden" name="attr_int_buff_list" value="">
          <input type="hidden" name="attr_vol_buff_list" value="">
          <input type="hidden" name="attr_tagi_buff_list" value="">
          <input type="hidden" name="attr_tcon_buff_list" value="">
          <input type="hidden" name="attr_tfor_buff_list" value="">
          <input type="hidden" name="attr_tper_buff_list" value="">
          <input type="hidden" name="attr_tcha_buff_list" value="">
          <input type="hidden" name="attr_tint_buff_list" value="">
          <input type="hidden" name="attr_tvol_buff_list" value="">
          <input type="hidden" name="attr_atkcac_buff_list" value="">
          <input type="hidden" name="attr_atktir_buff_list" value="">
          <input type="hidden" name="attr_atkmag_buff_list" value="">
          <input type="hidden" name="attr_init_buff_list" value="">
          <input type="hidden" name="attr_def_buff_list" value="">
          <input type="hidden" name="attr_dm_buff_list" value="">
          <input type="hidden" name="attr_pv_buff_list" value="">
          <input type="hidden" name="attr_dr_buff_list" value="">
          <input type="hidden" name="attr_pm_buff_list" value="">
          <input type="hidden" name="attr_pc_buff_list" value="">

          <details>
            <summary class="buffs-detail">
              Détail par attribut
            </summary>

            <details>
              <summary>Caractéristiques</summary>

              <div class="buff-detail">
                <div class="bordered">AGI</div>
                <div class="bordered"><span name="attr_agi_buff_list"></span></div>
                <div class="bordered"><span name="attr_agi_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">CON</div>
                <div class="bordered"><span name="attr_con_buff_list"></span></div>
                <div class="bordered"><span name="attr_con_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">FOR</div>
                <div class="bordered"><span name="attr_for_buff_list"></span></div>
                <div class="bordered"><span name="attr_for_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">PER</div>
                <div class="bordered"><span name="attr_per_buff_list"></span></div>
                <div class="bordered"><span name="attr_per_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">CHA</div>
                <div class="bordered"><span name="attr_cha_buff_list"></span></div>
                <div class="bordered"><span name="attr_cha_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">INT</div>
                <div class="bordered"><span name="attr_int_buff_list"></span></div>
                <div class="bordered"><span name="attr_int_buff"></span></div>
              </div>

              <div class="buff-detail">
                <div class="bordered">VOL</div>
                <div class="bordered"><span name="attr_vol_buff_list"></span></div>
                <div class="bordered"><span name="attr_vol_buff"></span></div>
              </div>

            </details>

            <details>
              <summary>Tests</summary>
              
              <div class="buff-detail">
                <div class="bordered">AGI</div>
                <div class="bordered"><span name="attr_tagi_buff_list"></span></div>
                <div class="bordered"><span name="attr_tagi_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">CON</div>
                <div class="bordered"><span name="attr_tcon_buff_list"></span></div>
                <div class="bordered"><span name="attr_tcon_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">FOR</div>
                <div class="bordered"><span name="attr_tfor_buff_list"></span></div>
                <div class="bordered"><span name="attr_tfor_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">PER</div>
                <div class="bordered"><span name="attr_tper_buff_list"></span></div>
                <div class="bordered"><span name="attr_tper_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">CHA</div>
                <div class="bordered"><span name="attr_tcha_buff_list"></span></div>
                <div class="bordered"><span name="attr_tcha_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">INT</div>
                <div class="bordered"><span name="attr_tint_buff_list"></span></div>
                <div class="bordered"><span name="attr_tint_buff"></span></div>
              </div>

              <div class="buff-detail">
                <div class="bordered">VOL</div>
                <div class="bordered"><span name="attr_tvol_buff_list"></span></div>
                <div class="bordered"><span name="attr_tvol_buff"></span></div>
              </div>

            </details>
            
            <details>
              <summary>Combat</summary>
  
              <div class="buff-detail">
                <div class="bordered">INIT</div>
                <div class="bordered"><span name="attr_init_buff_list"></span></div>
                <div class="bordered"><span name="attr_init_buff"></span></div>
              </div>
  
              <div class="buff-detail">
                <div class="bordered">ATC</div>
                <div class="bordered"><span name="attr_atkcac_buff_list"></span></div>
                <div class="bordered"><span name="attr_atkcac_buff"></span></div>
              </div>
  
              <div class="buff-detail">
                <div class="bordered">ATD</div>
                <div class="bordered"><span name="attr_atktir_buff_list"></span></div>
                <div class="bordered"><span name="attr_atktir_buff"></span></div>
              </div>
  
              <div class="buff-detail">
                <div class="bordered">MAG</div>
                <div class="bordered"><span name="attr_atkmag_buff_list"></span></div>
                <div class="bordered"><span name="attr_atkmag_buff"></span></div>
              </div>
  
              <div class="buff-detail">
                <div class="bordered">DEF</div>
                <div class="bordered"><span name="attr_def_buff_list"></span></div>
                <div class="bordered"><span name="attr_def_buff"></span></div>
              </div>

              <div class="buff-detail">
                <div class="bordered">DM</div>
                <div class="bordered"><span name="attr_dm_buff_list"></span></div>
                <div class="bordered"><span name="attr_dm_buff"></span></div>
              </div>

            </details>

            <details>
              <summary>Ressources</summary>
              
              <div class="buff-detail">
                <div class="bordered">PV</div>
                <div class="bordered"><span name="attr_pv_buff_list"></span></div>
                <div class="bordered"><span name="attr_pv_buff"></span></div>
              </div>
  
              <div class="buff-detail">
                <div class="bordered">DR</div>
                <div class="bordered"><span name="attr_dr_buff_list"></span></div>
                <div class="bordered"><span name="attr_dr_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">PM</div>
                <div class="bordered"><span name="attr_pm_buff_list"></span></div>
                <div class="bordered"><span name="attr_pm_buff"></span></div>
              </div>
              
              <div class="buff-detail">
                <div class="bordered">PC</div>
                <div class="bordered"><span name="attr_pc_buff_list"></span></div>
                <div class="bordered"><span name="attr_pc_buff"></span></div>
              </div>

            </details>

          </details>

        </div>

        <!-- Fiche PJ, Onglet CAPACITES, Sous-onglet Import -->
        <div class="pc-import-subtab">

          <div class="sheet-2colrow">

            <div class="sheet-col">
              <h4>Import des capacités</h4>
              <textarea class="statblock" name="attr_voie_pdf" placeholder="Copiez ici le texte de la voie..."></textarea>
            </div>

            <div class="sheet-col">

              <ul>
                <li>N'oubliez pas d'indiquer le premier rang de la voie dans la configuration</li>
                <li>
                  La première ligne est le nom de la voie<br>
                  Les préfixes ("Voie du ...", "Voie de la ...") sont tronqués
                </li>
                <li>Une ligne commençant par un chiffre marque le début d'une capacité</li>
                <li>Les lignes suivantes constituent la description de la capacité</li>
              </ul>

              <input type="checkbox" name="attr_from_drs" title="@{from_drs}" value="1">
              &nbsp;Texte copié depuis le DRS de Chroniques Oubliées
              <br>
              <input type="text" value="https://drs.chroniques-oubliees.fr/fantasy/voies" readonly>

            </div>

          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Equipement -->
      <div class="pc-gears-tab">
        
        <div class="pc-gears">

          <!-- Liste des équipements -->
          <div class="gears">

            <div class="block-title block-header">
              Equipements
              <button type="action" name="act_helpgear-btn" class="img-btn flat-btn" title="Aide équipement" >
                <span class="img-btn img-btn-lg">i</span>
              </button>
            </div>

            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_total_enc" value="0">
                <input type="hidden" name="attr_limite_enc" value="10">
                <input type="hidden" name="attr_tresor" value="">
                <input type="hidden" name="attr_tresor_pieces" value="">
                &nbsp;Trésor&nbsp;:&nbsp;<input type="text" name="attr_tresor" title="@{tresor}" readonly>
                &nbsp;Encombrement&nbsp;:&nbsp;<span class="align-self-center" name="attr_total_enc" title="@{total_enc} Encombrement total"></span>
                &nbsp;/&nbsp;<span class="align-self-center" name="attr_limite_enc" title="@{limite_enc} Seuil d'encombrement"></span>
                <button type="action" name="act_profequip-btn" class="flat-btn img-btn" title="Equipement de base du profil">
                  <span class="img-btn">l</span>
                </button>
              </div>
              <div class="d-flex d-flex-middle">
                <details>
                  <summary>Bourse</summary>
                  <div class="d-flex">
                    PC:<input type="number" class="treasure" name="attr_tresor_pc">
                    <input type="radio" class="treasure" name="attr_tresor_monnaie" title="@{tresor_monnaie} Compter le trésor en PA" value="1" checked>
                    &nbsp;PA:<input type="number" class="treasure" name="attr_tresor_pa">
                    <input type="radio" class="treasure" name="attr_tresor_monnaie" title="@{tresor_monnaie} Compter le trésor en PO" value="2">
                    &nbsp;PO:<input type="number" class="treasure" name="attr_tresor_po">
                    PP:<input type="number" class="treasure" name="attr_tresor_pp">
                  </div>
                </details>
              </div>
            </div>

            <div class="bordered">
              
              <input type="hidden" class="has-script" name="attr_script_show" value="0">

              <fieldset class="repeating_equipement">

                <details>
                  <summary>

                    <span>
                      <input type="text" name="attr_equip-nom" title="@{equip-nom}" placeholder="Nom de l'équipement">
                      <button type="action" class="flat-btn" name="act_equipshow-btn" title="Informations sur l'équipement">
                        <span class="img-btn">w</span>
                      </button>
                      Enc. <input type="number" name="attr_equip-enc" title="@{equip-enc} Encombrement (0,1,2)" value="0">
                      Nbre <input type="number" name="attr_equip-qte" title="@{equip-qte} Quantité possédée" value="1">
                      <input type="checkbox" name="attr_equip-on" title="@{equip-on} Equipement porté" value="1">
                    </span>

                  </summary>

                  <div class="d-flex">
                    <textarea class="one-row full-width" name="attr_equip-detail" title="@{equip-detail}" placeholder="Description détaillée"></textarea>
                  </div>

                  <div class="d-flex d-flex-middle">
                    <input type="hidden" name="attr_equip-modprops" value="">
                    <textarea class="one-row" name="attr_equip-props" title="@{equip-props} Propriétés"></textarea>
                    &nbsp;<input type="checkbox" name="attr_equip-atk" title="@{equip-atk} A une attaque" value="1">
                    &nbsp;<span>A une attaque</span>
                    <input type="hidden" name="attr_atkid" value="">
                  </div>

                  <div class="d-flex">
                    <textarea class="one-row full-width has-script" name="attr_equip-predicats" title="@{equip-predicats}" placeholder="Prédicats si porté"></textarea>
                  </div>

                </details>


              </fieldset>

            </div>
          </div>

          <!-- Liste des ressources & munitions -->
          <div>

            <div class="resources">
              <div class="block-title block-header">
                Ressources
              </div>
  
              <div class="bordered">
                
                <fieldset class="repeating_ressources">
  
                  <div class="d-flex">
                    <input type="text" name="attr_res-desc" title="@{res-desc}" placeholder="Nom de la ressource" value="">
                    Nombre :
                    <input type="number" class="two-digits" name="attr_res-val" title="@{res-val}" value="1">
                    <button type="action" class="flat-btn img-btn" name="act_resconso-btn" title="Utiliser un consommable">
                      <span class="img-btn">-</span>
                    </button>
                  </div>
  
                  <div class="d-flex">
                    <textarea class="one-row" name="attr_res-props" title="@{res-props} Propriétés&#10;type: munitions&#10;type: soins [formule si différent de 1d4°]" placeholder="Propriétés nom: valeur"></textarea>
                  </div>
  
                </fieldset>
  
              </div>
            </div>
            
            <input type="hidden" class="has-script" name="attr_script_show" value="0">
            <div class="ammos">

              <div class="block-title block-header">
                Munitions
              </div>
  
              <div class="bordered">
                
                <fieldset class="repeating_ammos">
  
                  <div class="d-flex">
                    <input type="text" name="attr_ammo-nom" title="@{ammo-nom}" placeholder="Nom de la munition" value="">
                    &nbsp;
                    <select class="select-md" name="attr_ammo-type" title="@{ammo-type} Type de munition">
                      <option value="fleche" selected>Flèche</option>
                      <option value="carreau">Carreau</option>
                      <option value="balle">Balle</option>
                      <option value="autre">Autre</option>
                    </select>
                  </div>
                  
                  <div class="d-flex">
                    <input type="number" class="two-digits" name="attr_ammo-qte" title="@{ammo-qte}" min="0" value="1">
                    &nbsp;/&nbsp;
                    <input type="number" class="two-digits" name="attr_ammo-qte_max" title="@{ammo-qte_max}" min="0" value="1">
                    &nbsp;%&nbsp;
                    <input type="number" name="attr_ammo-taux" title="@{ammo-taux} Taux de perte" min="0" max="100" value="100">
                    &nbsp;
                    <textarea class="one-row" name="attr_ammo-effet" title="@{ammo-effet} Effets" placeholder="Effets (liste de mots-clé)"></textarea>
                  </div>

                  <div class="d-flex">
                    <textarea class="one-row" name="attr_ammo-exteff" title="@{ammo-exteff} Effets étendus" placeholder="Effets étendus (syntaxe des options d'attaque)"></textarea>
                  </div>

                </fieldset>
  
              </div>
            </div>

          </div>

        </div>

        <div class="pc-gears">

          <!-- Equipements divers (free-form) -->
          <div class="misc-gears">
            <div class="block-title block-header">
              Equipement divers
            </div>
            <textarea name="attr_equip_divers" title="@{equip_divers}"></textarea>
          </div>

          <!-- Notes -->
          <div class="notes">
            <div class="block-title block-header">
              Notes
            </div>
            <textarea name="attr_notes" title="@{notes}"></textarea>
          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Notes -->
      <div class="pc-notes-tab">

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <div class="block-title block-header">
              <button type="action" class="flat-btn img-btn" name="act_appearance-btn">
                <span class="img-btn-lg">Apparence</span>
              </button>
            </div>
            <textarea class="xx-large" name="attr_apparence" title="@{apparence}"></textarea>

          </div>

          <div class="sheet-col">

            <div class="block-title block-header">
              Organisations, Alliés & Ennemis
            </div>
            <textarea class="xx-large" name="attr_contacts" title="@{contacts}"></textarea>

          </div>

        </div>

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <div class="block-title block-header">
              Biographie
            </div>
            <textarea class="xx-large" name="attr_biographie" title="@{biographie}"></textarea>

          </div>

          <div class="sheet-col">

            <div class="block-title block-header">
              Evènements & Aventures
            </div>
            <textarea class="xx-large" name="attr_aventures" title="@{aventures}"></textarea>

          </div>

        </div>

      </div>

      <!-- Fiche PJ, Onglet Config -->
      <div class="pc-config-tab">

        <hr>

        <div class="sheet-3colrow">
          
          <div class="sheet-col">

            <h4>Préférences</h4>
            <ul>
              <li>
                Jets&nbsp;:&nbsp;
                <select class="select-md" name="attr_togm" title="@{togm}">
                  <option value="" selected>Publics</option>
                  <option value="/w gm ">Chuchotés au MJ</option>
                </select>
                <input type="checkbox" name="attr_token_dsp" title="@{token_dsp}" value=" {{token=[x](@{token_url}) }} ">
                <span>Avec token</span>
              </li>
              <li class="config-check">
                <input type="checkbox" name="attr_cfg_pvmax_auto" value="1">
                <span>Calcul automatique des PV max.</span>
              </li>
              <li class="config-check">
                <input type="checkbox" name="attr_cfg_pts_capas" value="1">
                <span>Contrôle des points de capacités</span>
              </li>
              <li class="config-check">
                <input type="checkbox" name="attr_cfg_cible" value="1">
                <span>Attaques ciblées</span>
              </li>
            </ul>

            <h4>Affichage</h4>
            <ul>
              <li class="config-check">
                <input type="checkbox" name="attr_voies_456" value="1" checked>
                <span>Voies 4-5-6</span>
              </li>
              <li class="config-check">
                <input type="checkbox" name="attr_voies_789" value="1">
                <span>Voies 7-8-9</span>
              </li>
              <li class="config-check">
                <input type="checkbox" name="attr_use_skills" value="1">
                <span>Compétences</span>
              </li>
            </ul>

            <details>
              <summary>
                <h4>Initiative</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 160">
                  <input type="checkbox" name="attr_cfg_init_variable" value="1d6!">
                  <span>Initiative variable</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 153">
                  <input type="checkbox" name="attr_cfg_init_agi" value="1">
                  <span>Initiative + AGI</span>
                </li>
                <li class="config-check" title="Ajoute (PER+AGI)/10 au score final">
                  <input type="checkbox" name="attr_cfg_init_mod" value="1">
                  <span>Départager les init. identiques</span>
                </li>
              </ul>
            </details>

            <details>
              <summary>
                <h4>Règles optionnelles</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 157">
                  <input type="checkbox" name="attr_cfg_use_encmb" value="1">
                  <span>Encombrement</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 159">
                  <input type="checkbox" name="attr_cfg_pc_var" value="1">
                  <span>Points de chance variables</span>
                </li>
                <li class="config-check">
                  <input type="checkbox" name="attr_cfg_bouclier_malus" value="1">
                  <span>Utiliser le malus de bouclier</span>
                </li>
                <li class="config-check">
                  <input type="checkbox" name="attr_cfg_use_ammo" value="1">
                  <span>Suivre les munitions</span>
                  &nbsp;<input type="number" name="attr_cfg_ammo_alert" title="Seuil d'alerte munitions restantes" value="">
                </li>
              </ul>
            </details>

            <details>
              <summary>
                <h4>Règles optionnelles (COMBAT)</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 161">
                  <input type="checkbox" name="attr_cfg_crit_diff" value="1">
                  <span>Critiques différenciés</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 163-164">
                  <input type="checkbox" name="attr_cfg_tbl_crit" value="1">
                  <span>Table de coups critiques</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 162">
                  <input type="checkbox" name="attr_cfg_tbl_fumble" value="1">
                  <span>Table d'échec critique</span>
                </li>
              </ul>
            </details>

            <details>
              <summary>
                <h4><input type="checkbox" name="attr_cfg_highfan" value="1">&nbsp;High fantasy</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 184">
                  <input type="checkbox" name="attr_cfg_use_epic" value="1">
                  <span>Progression épique</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 183">
                  <input type="checkbox" name="attr_cfg_use_drniv" value="1">
                  <span>Récupération + niveau</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 191">
                  <input type="checkbox" name="attr_cfg_use_mana" value="1">
                  <span>Plus de Mana</span>
                </li>
              </ul>
            </details>
  
            <details>
              <summary>
                <h4><input type="checkbox" name="attr_cfg_lowfan" value="1">&nbsp;Low Fantasy</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 193">
                  <input type="checkbox" name="attr_cfg_use_capped6" value="1">
                  <span>Progression limitée</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 193">
                  <input type="checkbox" name="attr_cfg_use_dronly" value="1">
                  <span>Récupération - niveau</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 194">
                  <input type="checkbox" name="attr_cfg_atk_diff" value="1">
                  <span>Attaques différenciées</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 206">
                  <input type="checkbox" name="attr_cfg_usure" value="1">
                  <span>Usure des armes</span>
                </li>
                <li class="config-check" title="Atlas & règles optionnelles, p. 206">
                  <input type="checkbox" name="attr_cfg_use_fear" value="1">
                  <span>Règles de peur</span>
                </li>
              </ul>
            </details>
  
            <details>
              <summary>
                <h4>Dark Fantasy</h4>
              </summary>
              <ul>
                <li class="config-check" title="Atlas & règles optionnelles, p. 209">
                  <input type="checkbox" name="attr_cfg_shadow" value="1">
                  <span>Lutte contre l'Ombre</span>
                </li>
              </ul>
            </details>

          </div>

          <div class="sheet-col">

            <details>
              <summary>
                <h4>Forcer les valeurs maxi.</h4>
              </summary>
              <ul>
                <li class="force-max">
                  <input type="checkbox" class="force-max" name="attr_pvmax_force" title="@{pvmax_force}" value="1">
                  <span>PV</span>:
                  <input type="number" class="two-digits" name="attr_pv_max" title="@{pv_max}">
                </li>
                <li class="force-max">
                  <input type="checkbox" class="force-max" name="attr_drmax_force" title="@{drmax_force}" value="1">
                  <span>DR</span>:
                  <input type="number" class="two-digits" name="attr_dr_max" title="@{dr_max}">
                </li>
                <li class="force-max">
                  <input type="checkbox" class="force-max" name="attr_pcmax_force" title="@{pcmax_force}" value="1">
                  <span>PC</span>:
                  <input type="number" class="two-digits" name="attr_pc_max" title="@{pc_max}">
                </li>
                <li class="force-max">
                  <input type="checkbox" class="force-max" name="attr_pmmax_force" title="@{pmmax_force}" value="1">
                  <span>PM</span>:
                  <input type="number" class="two-digits" name="attr_pm_max" title="@{pm_max}">
                </li>
              </ul>
            </details>

            <details>
              <summary>
                <h4>Voies avec rang acquis</h4>
              </summary>
              <ul>
                <li>Rang 3 : 
                  <span name="attr_voies_rang3" title="@{voies_rang3} Nombre de voies avec le rang 3"></span>
                </li>
                <li>Rang 4 :
                  <span name="attr_voies_rang4" title="@{voies_rang4} Nombre de voies avec le rang 4"></span>
                </li>
                <li>Rang 5 :
                  <span name="attr_voies_rang5" title="@{voies_rang5} Nombre de voies avec le rang 5"></span>
                </li>
              </ul>
            </details>

            <details>
              <summary>
                <h4>Attributs personnalisés</h4>
              </summary>
              <textarea 
                name="attr_custom"
                placeholder="nom_attribut: valeur"
                title="Un nom d'attribut et sa valeur par ligne &#10;Les attributs sont créés sous le nom @{nom_attribut} &#10;Les lignes commençant par // sont des commentaires et ne sont pas traitées"
              ></textarea>
            </details>

            <details>
              <summary>
                <h4>Compétences personnalisées</h4>
              </summary>
              <ol>
                <li>
                  <input type="text" name="attr_custom1_skillname" title="@{custom1_skillname}" maxlength="30" value="">
                  <br>Carac(s)
                  &nbsp;<input type="checkbox" name="attr_custom1_agi" title="@{custom1_agi} AGI" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_con" title="@{custom1_con} CON" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_for" title="@{custom1_for} FOR" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_per" title="@{custom1_per} PER" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_cha" title="@{custom1_cha} CHA" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_int" title="@{custom1_int} INT" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom1_vol" title="@{custom1_vol} VOL" value="1">
                </li>
                <li>
                  <input type="text" name="attr_custom2_skillname" title="@{custom2_skillname}" maxlength="30" value="">
                  <br>Carac(s)
                  &nbsp;<input type="checkbox" name="attr_custom2_agi" title="@{custom2_agi} AGI" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_con" title="@{custom2_con} CON" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_for" title="@{custom2_for} FOR" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_per" title="@{custom2_per} PER" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_cha" title="@{custom2_cha} CHA" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_int" title="@{custom2_int} INT" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom2_vol" title="@{custom2_vol} VOL" value="1">
                </li>
                <li>
                  <input type="text" name="attr_custom3_skillname" title="@{custom3_skillname}" maxlength="30" value="">
                  <br>Carac(s)
                  &nbsp;<input type="checkbox" name="attr_custom3_agi" title="@{custom3_agi} AGI" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_con" title="@{custom3_con} CON" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_for" title="@{custom3_for} FOR" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_per" title="@{custom3_per} PER" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_cha" title="@{custom3_cha} CHA" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_int" title="@{custom3_int} INT" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom3_vol" title="@{custom3_vol} VOL" value="1">
                </li>
                <li>
                  <input type="text" name="attr_custom4_skillname" title="@{custom4_skillname}" maxlength="30" value="">
                  <br>Carac(s)
                  &nbsp;<input type="checkbox" name="attr_custom4_agi" title="@{custom4_agi} AGI" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_con" title="@{custom4_con} CON" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_for" title="@{custom4_for} FOR" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_per" title="@{custom4_per} PER" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_cha" title="@{custom4_cha} CHA" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_int" title="@{custom4_int} INT" value="1">
                  &nbsp;<input type="checkbox" name="attr_custom4_vol" title="@{custom4_vol} VOL" value="1">
                </li>
              </ol>
            </details>

            <details>
              <summary>
                <h4>Pense-bête</h4>
              </summary>
              <textarea class="medium" name="attr_pense_bete"></textarea>
            </details>

          </div>

          <div class="sheet-col">

            <div class="float-right">
              <input type="checkbox" name="attr_debug_mode" value="1" title="Mode Debug">&nbsp;
              <button type="action" class="flat-btn img-btn" name="act_def_config-btn" title="Importer la configuration&#10;Valider la configuration par défaut (fiche PJBase)">
                <span class="img-btn">x</span>
              </button>
              <button type="action" class="flat-btn img-btn" name="act_reset_all-btn" title="Re-calculer attributs&#10;DR, PM, PC, PV max.&#10;Initiative, Défense&#10;Encombrement&#10;Rangs et utilisations capacités&#10;Buffs / De-buffs&#10;Liens Att. <=> Equip.">
                <span class="img-btn">x</span>
              </button>
            </div>

            <h4>Notifications</h4>
            <ul>
              <li>
                <span>Etats préjudiciables</span>
                <select class="select-md" name="attr_notif_conditions">
                  <option value="0">Aucune</option>
                  <option value="1">Public</option>
                  <option value="2" selected>Chuchoté</option>
                </select>
              </li>
              <li>
                <span>Gain/Perte de PV</span>
                <select class="select-md" name="attr_notif_pv">
                  <option value="0">Aucune</option>
                  <option value="1">Public</option>
                  <option value="2" selected>Chuchoté</option>
                </select>
              </li>
              <li>
                <div class="d-flex">
                  <span>FX (caract.)&nbsp;</span>
                  <input class="d-flex-1" type="text" name="attr_notif_fx" title="@{notif_fx} FX à jouer pour les jets de caractéristiques" value="">
                </div>
              </li>
            </ul>
            
            <h4>Apparence des messages</h4>
            <ul>
              <li>
                <span>Couleur :&nbsp;</span>
                <select class="select-md" name="attr_couleur_pj">
                  <option value="" selected>Défaut</option>
                  <option value="blue">Bleu</option>
                  <option value="indigo">Indigo</option>
                  <option value="purple">Violet</option>
                  <option value="pink">Rose</option>
                  <option value="red">Rouge</option>
                  <option value="orange">Orange</option>
                  <option value="yellow">Jaune</option>
                  <option value="green">Vert</option>
                  <option value="teal">Sarcelle</option>
                  <option value="cyan">Cyan</option>
                  <option value="gray">Gris</option>
                  <option value="dark">Sombre</option>
                </select>
              </li>
              <li>Contenu
                <ul>
                  <li class="config-check">
                    <input type="checkbox" name="attr_cfg_1attack_roll" value="1">
                    <span>Un seul jet d'attaque</span>
                  </li>
                  <li class="config-check">
                    <input type="checkbox" name="attr_cfg_1skill_roll" value="1">
                    <span>Un seul jet de compétence</span>
                  </li>
                  <li class="config-check">
                    <input type="checkbox" name="attr_cfg_luck_btn" value="1">
                    <span>Bouton Chance</span>
                  </li>
                </ul>
              </li>
              <li>Dé bonus/Dé malus
                <ul>
                  <li class="config-check">
                    <input type="checkbox" name="attr_cfg_d20roll" value="1">
                    <span>Boutons</span>
                  </li>
                  <li class="config-check">
                    <input type="checkbox" name="attr_cfg_d20roll" value="2">
                    <span>Demander</span>
                  </li>
                </ul>
              </li>
            </ul>
    
            <details>
              <summary>
                <strong>Premiers rangs</strong>
              </summary>
              <ul class="pc-configs">
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie1nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v1br" title="@{v1br}" value="1">
                      <input type="text" name="attr_v1profil" title="@{v1profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie2nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v2br" title="@{v2br}" value="1">
                      <input type="text" name="attr_v2profil" title="@{v2profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie3nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v3br" title="@{v3br}" value="1">
                      <input type="text" name="attr_v3profil" title="@{v3profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie4nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v4br" title="@{v4br}" value="1">
                      <input type="text" name="attr_v4profil" title="@{v4profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie5nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v5br" title="@{v5br}" value="1">
                      <input type="text" name="attr_v5profil" title="@{v5profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie6nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v6br" title="@{v6br}" value="1">
                      <input type="text" name="attr_v6profil" title="@{v6profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie7nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v7br" title="@{v7br}" value="4">
                      <input type="text" name="attr_v7profil" title="@{v7profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie8nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v8br" title="@{v8br}" value="4">
                      <input type="text" name="attr_v8profil" title="@{v8profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
                <li>
                  <div class="pc-configs first-rank">
                    <span name="attr_voie9nom"></span>
                    <div class="d-flex">
                      <input type="number" name="attr_v9br" title="@{v9br}" value="1">
                      <input type="text" name="attr_v9profil" title="@{v9profil}" placeholder="Profil" value="">
                    </div>
                  </div>
                </li>
              </ul>
            </details>

          </div>

        </div>
        
        <!-- 
          
        <hr>

        <details>

          <summary>Importer profil & équipement</summary>

          <div class="sheet-2colrow">

            <div class="sheet-col">
              <textarea class="statblock" name="attr_json_profile"></textarea>
            </div>

            <div class="sheet-col">
              <button type="action" class="flat-btn img-btn" name="act_comob_export-btn" title="Exporter le profil">
                <span class="img-btn">c</span>&nbsp;Export Chroniques Mobiles
              </button>
              <br>
              Composez votre profil avec l'application Export Chroniques Mobiles et insérez le code JSON dans le champ ci-contre
              <br>
              <button type="action" class="flat-btn img-btn" name="act_import_json-btn" title="Importer le profil">
                <span class="img-btn">W</span>&nbsp;Importer
              </button>
              <input type="checkbox" name="attr_reset_gears" value="1">
              <span>Réinitialiser les listes armes & équipement</span>
            </div>

          </div>

        </details>
        -->

      </div>

      <div class="pc-script-tab">
        <h3><span name="attr_script_title"></span></h3>

        <input class="show-script" type="hidden" name="attr_script_show" value="0">
        <div class="show-script">
          <div class="sheet-2colrow">
  
            <div class="sheet-col">
  
              <ul>
                <li>
                  Renuméroter les attaques&nbsp;
                  <button type="action" class="flat-btn img-btn" name="act_renum_atk-btn" title="Renuméroter les attaques">
                    <span class="img-btn">x</span>
                  </button>
                </li>
              </ul>

              <h4>Listes d'actions</h4>

              <div class="pc-actions">
               
                <details open>
                  <summary class="block-title">
                    <span name="attr_liste_actions_1"></span>
                  </summary>
                  <input type="hidden" name="attr_liste_actions_1" value="Actions du tour">
                  <fieldset class="repeating_actions1">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="pc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_2"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_2" title="@{liste_actions_2}" value="Liste d'actions n°2">
                  <fieldset class="repeating_actions2">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="pc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_3"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_3" title="@{liste_actions_3}" value="Liste d'actions n°3">
                  <fieldset class="repeating_actions3">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="pc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_4"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_4" title="@{liste_actions_4}" value="Liste d'actions n°4">
                  <fieldset class="repeating_actions4">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="pc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_5"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_5" title="@{liste_actions_5}" value="Liste d'actions n°5">
                  <fieldset class="repeating_actions5">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

            </div>
  
            <div class="sheet-col">
              <h4>Prédicats</h4>
              <textarea class="x-large" name="attr_predicats_script" title="@{predicats_script} Prédicats" value=""></textarea>
            </div>
  
          </div>

        </div>

        <hr>

        <h4>Autres scripts MOD</h4>
        
        <div class="sheet-2colrow">

          <div class="sheet-col">
            <input type="checkbox" name="attr_tokenmod" title="@{tokenmod}" value="1">
            <span title="Pour autoriser les joueurs à modifier leur token, le MJ doit activer 'Players can use --ids' dans la configuration du script">Token Mod</span>
            <div class="pc-configs m2">
              <div>Marker 0 PV</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_tkmarker_dead_on" title="@{tkmarker_dead_on}" value="1">
                &nbsp;<input type="text" name="attr_tkmarker_dead" title="@{tkmarker_dead}" value="dead">
              </div>
            </div>
            <div class="pc-configs m2">
              <div>Teinte 1/2 PV</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_token_tint_on" title="@{token_tint_on}" value="1">
                &nbsp;<input type="text" name="attr_token_tint" title="@{token_tint}" value="ED2939">
              </div>
            </div>
            <div class="pc-configs m2">
              <div>Pense-bête (Tooltip)</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_token_tooltip_on" title="@{token_tooltip_on}" value="1">
              </div>
            </div>
            <div class="pc-configs m2">
              <div>Marker PC</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_tkmarker_pc_on" title="@{tkmarker_pc_on}" value="1">
                &nbsp;<input type="text" name="attr_tkmarker_pc" title="@{tkmarker_pc}" value="three-leaves">
              </div>
            </div>
            <div class="pc-configs m2">
              <div>Markers états préjudiciables</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_tkmarker_cond" title="@{tkmarker_cond}" value="1">
              </div>
            </div>
            <hr>
            <input type="checkbox" name="attr_chatsetattr" title="@{chatsetattr}" value="1">
            <span>ChatSetAttr</span>
            <hr>
            <input type="checkbox" name="attr_addcustrn" title="@{addcustrn}" value="1">
            <span>AddCustomTurn</span>
          </div>
          
          <div class="sheet-col">
          </div>
        </div>

      </div>

      <!-- Fiche PJ, Onglet Version -->
      <div class="pc-version-tab">
        <h3>
          Notes de version (v<span name="attr_version"></span>)
          <button type="action" class="flat-btn img-btn" name="act_helpdoc-btn" title="Documentation en ligne">
            <span class="img-btn img-btn-xl">i</span>
          </button>
        </h3>

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <ul>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.13.0</strong> (2026-01-04)
                  </summary>
                  <ul>
                    <li>Prise en charge de l'action <em>Aider</em> (script MOD SetChatAttr nécessaire)</li>
                    <li>Ajout de 4 compétences personnalisées optionnelles avec caractéristiques associées</li>
                    <li>Ajout d'un champ pour le score d'attaque à distance de base à la fiche de PNJ</li>
                    <li>Ajout d'un champ Genre à la fiche de PNJ</li>
                    <li>Mise à jour automatique des PV en cas d'utilisation d'un consommable de soins</li>
                    <li>Gestion des effets prolongés des attaques et capacités</li>
                    <li>Prise en charge du script MOD <em>AddCustomTurn</em> pour améliorer les effets prolongés</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.12.0</strong> (2025-11-30)
                  </summary>
                  <ul>
                    <li>Sélection d'un jet sec, de capacité ou de compétence au clic sur une caractéristique</li>
                    <li>Plus d'insertion automatique d'inline-roll [[ ]] dans le texte d'une capacité si ce dernier en comporte déjà</li>
                    <li>Effacement de la liaison entre une ligne d'arme et de munition quand le type d'attaque n'est pas <em>trait</em></li>
                    <li>Pas d'affichage des champs fréquence d'utilisation pour les capacités dont le nombre d'utilisation maximum est 0</li>
                    <li>Ajout de la gestion des Points de Chance à la fiche de PNJ</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.11.0</strong> (2025-11-11)
                  </summary>
                  <ul>
                    <li>Correction DM x 2 si le seuil de critique est inférieur à 20</li>
                    <li>Ajout de boutons <em>Récupérations</em> et <em>Soins</em> au menu d'actions du PJ</li>
                    <li>Ajout d'une mention pour les manoeuvres avec modificateur de tailles</li>
                    <li>Ajout du jet opposé sur l'utilisation d'une manoeuvre</li>
                    <li>Ajout de champs pour les scores d'attaque au contact (jet de manoeuvre opposé) et magique aux fiches de PNJ</li>
                    <li>Possibilité de combiner les options tactiques avec une option spécifique au PJ</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.10.0</strong> (2025-10-31)
                  </summary>
                  <ul>
                    <li>Réinitialisation des capacités utilisées par combat / par jour en cas de récupération rapide ou complète</li>
                    <li>Réinitialisation des PM maximum ec cas de récupération complète</li>
                    <li>Ajout d'un sous-onglet pour les RD et Résistances aux DM sur la fiche de PJ</li>
                    <li>Ajout d'une section dépliante pour les RD et Résistances aux DM sur la fiche de PNJ</li>
                    <li>Ajout d'attributs vitesse pour les déplacements</li>
                    <li>Prise en charge des valeurs de buffs qui changent à certains rangs dans une voie</li>
                    <li>Prise en charge des manoeuvres spéciales dans les jets d'attaque</li>
                    <li>Ajout de listes de tailles et de type de créatures sur la fiche de PNJ</li>
                    <li>Ajout d'une option pour cibler un token lors d'un jet d'attaque</li>
                    <li>Effacement de l'option tactique choisie après un jet d'attaque</li>
                    <li>Ajout d'une macro <em>pc_actions-btn</em> pour une liste d'actions dans le chat</li>
                    <li>Prise en charge des ressources consommables de type <em>soins</em></li>
                    <li>Ajout d'un bouton <em>Consommable</em> à la liste des ressources</li>
                    <li>Ajout du nombre d'utilisations par jour/combat aux capacités de PNJ</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.9.0</strong> (2025-09-28)
                  </summary>
                  <ul>
                    <li>Possibilité de cacher aussi les voies 4, 5 et 6</li>
                    <li>Ajout d'un type de buff <em>Tous les test de caracs</em> et <em>Tous les jets d'attaque</em></li>
                    <li>Ajout d'un paramètre <em>temporaire</em> dans la définition d'un buff</li>
                    <li>Ajout d'un bouton pour regrouper les buffs temporaires par leur nom et les activer/désactiver</li>
                    <li>
                      Ajout des attributs <em>voies_rang3</em>, <em>voies_rang4</em>, <em>voies_rang5</em>
                      avec le nombre de voies dans lesquelles les rangs 3 à 5 sont atteints
                    </li>
                    <li>Remplacement de la propriété de capacité <em>evol</em> par la propriété <em>selonRang</em></li>
                    <li>Ajout d'une option de configuration pour lancer un seul d20 dans les jets de compétence</li>
                    <li>Harmonisation des icones d'états préjudiciables avec le token marker set du script COFantasy2</li>
                    <li>Mise au point de l'option <em>Etats préjudiciables</em> de l'interface <em>Token Mod</em></li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.8.0</strong> (2025-08-31)
                  </summary>
                  <ul>
                    <li>Prise en compte des capacités épiques dans le calcul des rangs dans la voie et des PV (propriété <em>epic:</em>).</li>
                    <li>Prise en compte des capacités épiques <em>Défense héroïque</em> et <em>Mana épique</em> dans le calcul de la DEF et des PM.</li>
                    <li>Possibilité de compter le trésor en PA ou en PO.</li>
                    <li>Ajout d'une option dans la configuration <em>Token Mod</em> pour appliquer une teinte au token quand le nombre de PV tombe au-dessous de sa valeur maximum.</li>
                    <li>Ajout d'un bouton pour copier la configuration par défaut depuis une fiche nommée PJBase.</li>
                    <li>Option <em>jet:N</em> déplacée du champ <em>Spécial</em> d'une attaque au champ <em>Modificateurs d'attaque</em></li>
                    <li>Ajout d'une option dans les coups spéciaux des PNJ pour n'affecter que la prochaine attaque</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.7.0</strong> (2025-07-26)
                  </summary>
                  <ul>
                    <li>Sous-onglet <em>Maîtrises</em> dans l'onglet <em>Capacités</em> pour les langues et les maîtrises spéciales d'armes / armures</li>
                    <li>Ajout d'un popup Roll20 sur le bouton DR pour choisir entre Récupération <em>Rapide</em> ou <em>Complète</em> ou <em>Se dépasser</em></li>
                    <li>Ajout de la possibilité d'indiquer <em>jet:N</em> dans le champ Spécial d'une attaque de PNJ pour afficher la description du jet correspondant dans le chat</li>
                    <li>Ajout d'une option <em>Token Mod</em> dans l'onglet Script pour permettre aux joueurs d'interagir avec le token de leur personnage</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.6.0</strong> (2025-06-22)
                  </summary>
                  <ul>
                    <li>Déplacement des propriétés magiques des armes vers les modificateurs d'attaque</li>
                    <li>Ajout d'un champ <em>Prédicats si porté</em> aux lignes d'attaques et d'équipements</li>
                    <li>Création de 2 attaques pour les armes avec propriété <em>lancer</em> depuis l'onglet équipement</li>
                    <li>Ajout des jets des capacités aux boutons épinglables à la barre d'actions Roll20</li>
                    <li>Ajout d'une gestion de compétences dans la fiche de PNJ</li>
                    <li>Ajout des options tactiques et de 3 coups spéciaux dans la fiche de PNJ</li>
                    <li>Ajout d'une liste de munitions sur l'onglet équipement (script COFantasy2)</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.5.0</strong> (2025-05-08)
                  </summary>
                  <ul>
                    <li>Ajout d'un onglet Notes aux fiches de PJ</li>
                    <li>Ajout d'une couleur de fond aux PV selon l'état courant (Jaune si moins de 50% de PV restants, Rouge si 1 PV restant, Rouge foncé si 0 PV restant)</li>
                    <li>Ajout d'une '*' aux capacités de sort en mode affichage</li>
                    <li>Ajout d'une option pour ajuster les PM dépensés par une capacité de sort</li>
                    <li>Prise en compte des capacités avec paramètre évolutif</li>
                    <li>Amélioration des objets en main (main gauche selon bouclier équipé ou pas)</li>
                    <li>Mise au point de la vérif. des points de capacités et du calcul auto. des PV</li>
                    <li>Correction de l'import PDF pour les voies de magie destructrice et magie élémentaire</li>
                    <li>Ajout de la possibilité d'épingler certains jets à la barre d'actions Roll20</li>
                    <li>Ajout de buffs aux DMs avec possibilité de jet optionnel</li>
                    <li>Ajout d'une gestion d'attributs personnalisés</li>
                    <li>Ajout d'une case attaque active/inactive pour le script COFantasy2</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.4.0</strong> (2025-04-08)
                  </summary>
                  <ul>
                    <li>Ajout d'un bouton pour afficher un check-up de l'état du personnage</li>
                    <li>Ajout d'un bouton pour activer la concentration sur les capacités de sort</li>
                    <li>Ajout des tables de coups et d'échecs critiques sur les fiches de PJ et PNJ</li>
                    <li>Ajout d'une question pour les DM des sorts de zone en attaque</li>
                    <li>Prise en compte des propriétés magiques des armes</li>
                    <li>Prise en compte des règles optionnelles de peur</li>
                    <li>Prise en compte de la valeur d'Ombre</li>
                    <li>Ajout des bonus de base aux titres des jets d'attaques, de capacités et de compétences</li>
                    <li>Ajout de tags aux jets dans le chat</li>
                    <li>Amélioration des textes descriptifs dans les jets de capacités</li>
                    <li>Ajustements cosmétiques pour les cases à cocher et boutons radio</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.3.0</strong> (2025-03-09)
                  </summary>
                  <ul>
                    <li>Ajout de buffs aux caractéristiques pris en compte dans les attributes dérivés</li>
                    <li>Ajout d'un contrôle sur le niveau minimum requis pour les rangs de capacités</li>
                    <li>Ajout d'une case "en selle" (pour gestion de la voie du cavalier)</li>
                    <li>Affichage optionnel d'un bouton Chance dans tous les jets de D20</li>
                    <li>Ajout d'un menu de chat pour les états préjudiciables</li>
                    <li>Prise en compte de l'état Immobilisé pour les jets d'attaque avec dé malus</li>
                    <li>Ajout de toutes les armes et armures dans la liste des équipements reconnus</li>
                    <li>Gestion simplifée du suivi des munitions</li>
                    <li>Gestion de l'usure des armes</li>
                    <li>Ajout de 4 listes d'actions sur l'onglet Script des fiches de PJ et PNJ</li>
                    <li>Prise en compte des attaques groupées sur la fiche de PNJ</li>
                    <li>Ajout d'un onglet Equipement simplifié sur la fiche de PNJ</li>
                    <li>Correction d'un bug sur l'appel du Persomancien</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.2.0</strong> (2025-02-04)
                  </summary>
                  <ul>
                    <li>Ajout d'une gestion des armures, boucliers et casques équipés</li>
                    <li>Ajout d'une option pour vérifier les points de capacités utilisés</li>
                    <li>Import des voies déplacé de l'onglet Configuration dans un sous-onglet Import de l'onglet Capacités</li>
                    <li>Ajout d'une icône pour chaque nom de voie en mode Edition pour l'import du texte des capacités</li>
                    <li>Modification du calcul des DR max avec une base de 2 sauf pour les profils de Mystiques (3 DR)</li>
                    <li>Modification du calcul des PC max avec une base de 2 sauf pour les profils d'Aventuriers (3 PC)</li>
                    <li>Ajout d'options de configuration pour forcer la valeur max des PV, DR, PC et PM</li>
                    <li>Modification du champ RD dans la fiche de PNJ</li>
                    <li>Amélioration de la reconnaissance d'inline-rolls dans les descriptions de capacités</li>
                    <li>Ajout du détail de la bourse par type de pièces et total du trésor en PA</li>
                    <li>Ajout des boutons des menus d'action sur la fiche de PNJ</li>
                    <li>Ajout gestion des objets en main</li>
                    <li>Ajout de la possibilité de lier un FX Roll20 aux jets de caractéristiques, d'attaques et de capacités</li>
                    <li>Persomancien (version expérimentale)</li>
                    <li>Améliorations visuelles diverses (dont support du darkmode dans le chat)</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.1.0</strong> (2025-01-05)
                  </summary>
                  <ul>
                    <li>Ajout d'un bouton pour le test de chance</li>
                    <li>Ajout d'un champ paramètre et d'un champ propriétés pour chaque capacité</li>
                    <li>Ajout d'un champ PV de voie pour chaque voie</li>
                    <li>Rangs 1 des voies 1,2 & 3 cochés par défaut</li>
                    <li>Ajout d'une option de calcul automatique des PV max</li>
                    <li>Ajout de la gestion de compagnons</li>
                    <li>Ajout d'options d'attaque pour le script COFantasy2</li>
                    <li>Remplacement import profil en JSON par import de voie depuis PDF</li>
                    <li>Ajout d'un bouton de génération de l'équipement de base du profil</li>
                    <li>Ajout de la gestion de l'AGI/CON maximum selon l'armure</li>
                    <li>Ajout de l'onglet Script et des options d'attaque sur les fiches de PNJ</li>
                    <li>Ajout d'un champ propriétés sur les ressources</li>
                  </ul>
                </details>
              </li>

              <li>
                <details>
                  <summary>
                    <strong>Version 1.0.0</strong> (2024-12-24)
                  </summary>
                  <ul>
                    <li>Première version de la fiche</li>
                  </ul>
                </details>
              </li>

            </ul>

          </div>

          <div class="sheet-col">

            <h4>Migrations</h4>
            <details>
              <summary>Détail des mises à jour</summary>
              <textarea class="large migration" name="attr_migration"></textarea>
            </details>

          </div>

        </div>
      </div>


    </div>

    <!-- Fiche PNJ -->
    <div class="cof-npc">
      <input type="hidden" class="tabs-toggle" name="attr_npc_tab" value="main" />
      <div>
        <button type="action" name="act_npc_main-btn" class="main-tab tab-btn npc-main-btn">TRAITS</button>
        <button type="action" name="act_npc_gears-btn" class="main-tab tab-btn npc-gears-btn">EQUIPEMENT</button>
        <button type="action" name="act_npc_config-btn" class="main-tab tab-btn npc-config-btn">CONFIGURATION</button>
        <button type="action" name="act_npc_script-btn" class="main-tab tab-btn npc-script-btn">SCRIPT</button>
      </div>

      <div class="npc-main-tab">

        <div class="npc-main">
  
          <div class="npc-traits">

            <h4>
              <input type="hidden" name="attr_caract_select-btn" value="">
              <button type="action" class="hidden" name="act_caract_select-btn"/>
              <button type="roll" class="flat-btn img-btn" name="roll_caractselect" title="%{caract_select-btn} Choix d'une caractéristique" value="@{caract_select-btn}">
                Caractéristiques
              </button>
              <input type="hidden" name="attr_caract_menu-btn" value="">
              <button type="action" class="hidden" name="act_caract_menu-btn"/>
              <button type="roll" class="flat-btn img-btn" name="roll_caractmenu" title="%{caract_menu-btn} Menu des caractéristiques" value="@{caract_menu-btn}">
                <span class="img-btn">l</span>
              </button>
            </h4>
  
            <div class="npc-4colrow">
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_agi-btn">
                    <span class="d20-btn">t</span>
                    AGI
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_agi" title="@{agi}" value="0">
                  <input type="checkbox" name="attr_agi_sup" title="@{agi_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_con-btn">
                    <span class="d20-btn">t</span>
                    CON
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_con" title="@{con}" value="0">
                  <input type="checkbox" name="attr_con_sup" title="@{con_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_for-btn">
                    <span class="d20-btn">t</span>
                    FOR
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_for" title="@{for}" value="0">
                  <input type="checkbox" name="attr_for_sup" title="@{for_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_per-btn">
                    <span class="d20-btn">t</span>
                    PER
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_per" title="@{per}" value="0">
                  <input type="checkbox" name="attr_per_sup" title="@{per_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

            </div>
  
            <div class="npc-4colrow">
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_cha-btn">
                    <span class="d20-btn">t</span>
                    CHA
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_cha" title="@{cha}" value="0">
                  <input type="checkbox" name="attr_cha_sup" title="@{cha_sup} Caractéristique supérieure" value="S">
                </div>
              </div>
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_int-btn">
                    <span class="d20-btn">t</span>
                    INT
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_int" title="@{int}" value="0">
                  <input type="checkbox" name="attr_int_sup" title="@{int_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_pnj_vol-btn">
                    <span class="d20-btn">t</span>
                    VOL
                  </button>
                </div>
                <div class="bordered">
                  <input type="number" name="attr_vol" title="@{vol}" value="0">
                  <input type="checkbox" name="attr_vol_sup" title="@{vol_sup} Caractéristique supérieure" value="S">
                </div>
              </div>

            </div>

            <div class="npc-4colrow">

              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_init-btn">
                    Init.
                  </button>
                </div>
                <div class="bordered centered">
                  <input type="number" class="two-digits" name="attr_init" title="@{init}" value="0">
                </div>
              </div>
              
              <div class="npc-trait">
                <div class="block-title">
                  <button class="block-title" type="action" name="act_defsup-btn">
                    Défense
                  </button>
                </div>
                <div class="bordered">
                  <input type="hidden" class="has-buff" name="attr_def_sup" value="0">
                  <input type="number" class="has-buff two-digits" name="attr_def" title="@{def}" value="0">
                </div>
              </div>

              <div class="npc-trait">
                <div class="block-title">Vitesse</div>
                <div class="bordered">
                  <input type="number" name="attr_vitesse" title="@{vitesse} Déplacement" value="">&nbsp;m
                </div>
              </div>

            </div>
          
            <div class="npc-2colrow">
              
              <div class="npc-trait">
                <div class="block-title">
                  <span>Points de Vigueur</span>
                </div>
                <div class="bordered centered">
                  <input type="number" class="two-digits" name="attr_pv" title="@{pv}" value="0">
                  /
                  <input type="number" class="two-digits" name="attr_pv_max" title="@{pv_max}" value="0">
                </div>
              </div>
              
              <div class="npc-trait">
                <div class="block-title">
                  <span>Points de Chance</span>
                </div>
                <div class="bordered centered">
                  <input type="number" name="attr_pc" title="@{pc}" value="0">
                  /
                  <input type="number" name="attr_pc_max" title="@{pc_max}" value="0">
                </div>
              </div>
              
            </div>

            <div class="npc-row">

              <div class="npc-trait-rd">
                <div class="block-title">
                  <span>RD</span>
                </div>
                <div class="bordered">
                  <details>
                    <summary>
                      <input type="hidden" name="attr_rrdm">
                      <span name="attr_rrdm"></span>
                    </summary>
                    <div class="d-flex m2">
                      <textarea class="one-row" name="attr_rd" title="@{rd}" placeholder="Réductions DM..."></textarea>
                    </div>
                    <div class="d-flex m2">
                      <textarea class="one-row" name="attr_resdm" title="@{resdm}" placeholder="Résistances aux DM..."></textarea>
                    </div>
                  </details>
                </div>
              </div>

            </div>

          </div>

          <div>
            <button type="action" class="flat-btn img-btn" name="act_description-btn">
              <h4 class="img-btn">Description</h4>
            </button>
            <textarea name="attr_pnj_desc" class="x-large" title="@{pnj_desc}"></textarea>  
          </div>
  
        </div>

        <!-- Fiche PNJ, Onglet Caractéristiques, Sous-onglets -->
        <input type="hidden" class="tabs-toggle" name="attr_npc_subtab1" value="attacks" />
        <div class="npc-subtabs">
          <button type="action" name="act_npc_attacks-btn" class="sub-tab tab-btn npc-attacks-btn">ATTAQUES</button>
          <button type="action" name="act_npc_abilities-btn" class="sub-tab tab-btn npc-abilities-btn">CAPACITES</button>
          <button type="action" name="act_npc_notes-btn" class="sub-tab tab-btn npc-notes-btn">NOTES</button>
        </div>

        <hr>

        <div class="npc-attacks-subtab">

          <div class="npc-attacks">
          
            <div class="weapon">
              <div></div>
              <h4>
                ARME / SORT
                <button type="action" class="flat-btn img-btn" name="act_npcatks_menu-btn" title="%{npcatks_menu-btn} Menu des jets d'attaques">
                  <span class="img-btn">l</span>
                </button>
              </h4>
              <h4>ATTAQUE</h4>
              <h4>CRIT.</h4>
              <h4>DM</h4>
              <h4>PORTEE</h4>
            </div>
  
            <input type="hidden" name="attr_pnjatk">
            <input type="hidden" class="has-script" name="attr_script_show" value="">
  
            <fieldset class="repeating_npcarmes">
  
              <div class="weapon">
                
                <div>
                  <input type="hidden" name="attr_npcatk-btn" value="">
                  <button type="action" class="hidden" name="act_npcatk-btn">
                    <span class="d20-btn">t</span>
                  </button>
                  <button type="roll" class="flat-btn" name="roll_npcatk" title="%{repeating_npcarmes_ID_npcatk-btn}" value="@{npcatk-btn}" />
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="hidden" name="attr_arme-label" value="">
                  <input type="hidden" class="arme-label" name="attr_arme-showlbl" value="0">
                  <span class="align-self-center arme-label" name="attr_arme-label"></span>&nbsp;
                  <input type="text" name="attr_arme-nom" title="@{arme-nom}" placeholder="Arme/attaque" value="">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <span class="align-self-center">Att*&nbsp;:&nbsp;</span>
                  <input type="checkbox" name="attr_arme-multi" title="@{arme-multi} Attaques multiples" value="1">&nbsp;
                  <select class="select-md" name="attr_arme-roll" title="@{arme-roll} Type de jet">
                    <option value="1d20" selected>Normal</option>
                    <option value="2d20kh1">Dé bonus</option>
                    <option value="2d20kl1">Dé malus</option>
                  </select>&nbsp;
                  <input type="number" class="two-digits" name="attr_arme-atk" title="@{arme-atk} Bonus d'attaque" value="">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="number" class="two-digits" name="attr_arme-crit" title="@{arme-crit} Seuil de Critique" value="20" min="16" max="20">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="text" name="attr_arme-dm" title="@{arme-dm} Dé(s) de DM" placeholder="1d8, 2d6..." value="">
                  <select class="select-xxs" name="attr_arme-dmtype" title="@{arme-dmtype} Type de dommages">
                    <optgroup label="Physiques">
                      <option disabled class="optgroup">
                        &nbsp;Physiques
                      </option>
                      <option value="contondants">C - Contondants</option>
                      <option value="perforants">P - Perforants</option>
                      <option value="poison">Po - Poison</option>
                      <option value="tranchants" selected>T - Tranchants</option>
                    </optgroup>
                    <optgroup label="Naturels">
                      <option disabled class="optgroup">
                        &nbsp;Naturels
                      </option>
                      <option value="coup">Co - Coup</option>
                      <option value="morsure">M - Morsure</option>
                      <option value="griffes">G - Griffes</option>
                    </optgroup>
                    <optgroup label="Elementaires">
                      <option disabled class="optgroup">
                        &nbsp;Elémentaires
                      </option>
                      <option value="acide">A - Acide</option>
                      <option value="électricité">E - Electricité</option>
                      <option value="feu">Fe - Feu</option>
                      <option value="froid">Fr - Froid</option>
                    </optgroup>
                    <optgroup label="Autres">
                      <option disabled class="optgroup">
                        &nbsp;Autres
                      </option>
                      <option value="magiques">M - Magiques</option>
                    </optgroup>
                  </select>
                  &nbsp;<span class="align-self-center">+</span>&nbsp;
                  <input type="number" class="two-digits" name="attr_arme-dmdiv" title="@{arme-dmdiv} Bonus DM" value="0">
                </div>
                <div class="d-flex d-flex-middle bordered">
                  <input type="text" name="attr_arme-portee" title="@{arme-portee}" value="">
                  <button type="action" class="flat-btn img-btn float-right" name="act_armeopt-btn">
                    <span class="img-btn">y</span>
                  </button>
                </div>
  
              </div>
  
              <input type="hidden" class="cof-wopt-toggle" name="attr_armeopt" value="0"/>
              <div class="weapon-opt">
                <div class="weapon-special">
                  <div></div>
                  <div class="bordered">
                    <textarea class="one-row" name="attr_arme-special" title="@{arme-special}" placeholder="Effet, capacités spéciales..."></textarea>
                  </div>
                </div>
                <div class="weapon-option">
                  <div></div>
                  <div class="bordered">
                    <select name="attr_arme-atktype" class="select-md" title="@{arme-atktype} Type d'arme/attaque">
                      <option value="">Type...</option>
                      <option value="main" title="Arme de contact">En main</option>
                      <option value="jet" title="Arme lancée">Jet</option>
                      <option value="trait" title="Arme à projectiles (munitions)">Trait</option>
                      <option value="sort" title="Sortilège">Sort</option>
                      <option value="naturel" title="Arme naturelle">Naturelle</option>
                    </select>
                  </div>
                  <div class="bordered">
                    <input type="checkbox" name="attr_arme-active" title="@{arme-active} Attaque active" value="1" checked>
                    <input type="text" name="attr_arme-atkmods" placeholder="Modificateurs d'attaque" title="@{arme-atkmods} Modificateurs séparés par des virgules&#10; deBonus: avec dé bonus&#10; deMalus: avec dé malus&#10; auto: réussite automatique&#10; choc: peut faire des attaques non léthales sans malus&#10; explodeMax: dés de dégâts explosifs&#10; pasDeDmg: l'attaque ne fait pas de DM&#10; poudre: arme à poudre&#10; reroll1: relance les 1 sur les dés de DM (:1 = une seule fois)&#10; tempDmg: fait toujours des attaques non léthales&#10; jet:N: lance le jet de capacité N&#10;" value="">
                  </div>
                  <div class="bordered">
                    <textarea class="one-row" name="attr_arme-options" placeholder="Options d'attaque avec argument" title="@{arme-options} Options d'attaque"></textarea>
                  </div>
                </div>
  
                <div class="weapon-effect">
                  <div></div>
                  <div class="d-flex bordered">
                    Cible&nbsp;
                    <input type="number" class="two-digits" name="attr_arme-seuil" title="@{arme-seuil}" value="0">
                    <textarea class="one-row" name="attr_arme-effet" placeholder="Effet spécial si le jet atteint la valeur cible" title="@{arme-effet} Effet spécial"></textarea>
                  </div>
                </div>

                <input type="hidden" class="cof-thrown-toggle" name="attr_arme-jet" value="0"/>
                <div class="weapon-thrown">
                  <div class="weapon-throw">
                    <div></div>
                    <div class="bordered">
                      Disponibles :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-dispo" title="@{jet-dispo}" value="0">
                    </div>
                    <div class="bordered">
                      Possédés :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-dispo_max" title="@{jet-dispo_max}" value="0">
                    </div>
                    <div class="bordered">
                      Taux perte :&nbsp;
                      <input type="number" class="two-digits" name="attr_jet-perte" title="@{jet-perte}" value="0">
                      &nbsp;%
                    </div>
                  </div>
                </div>
    
              </div>
  
            </fieldset>
  
          </div>

          <hr>

          <div class="sheet-2colrow">

            <div class="sheet-col">

              <h4>Attaque groupée (MJ)</h4>

              <div class="npc-tactic">
                <div>
                  <input type="radio" name="attr_atkgroup" value="1" checked>
                  1 créature
                </div>
                <div>
                </div>
              </div>

              <div class="npc-tactic">
                <div>
                  <input type="radio" name="attr_atkgroup" value="2">
                  2 créatures
                </div>
                <div>
                  +5 en attaque
                </div>
              </div>

              <div class="npc-tactic">
                <div>
                  <input type="radio" name="attr_atkgroup" value="3">
                  3 créatures
                </div>
                <div>
                  +10 en attaque
                </div>
              </div>

              <div class="npc-tactic">
                <div>
                  <input type="radio" name="attr_atkgroup" value="4">
                  4 créatures
                </div>
                <div>
                  Touche automatique
                </div>
              </div>

              <div class="npc-tactic">
                <div>
                  <input type="radio" name="attr_atkgroup" value="5">
                  Jusqu'à 8 créatures
                </div>
                <div class="d-flex">
                  Nombre :&nbsp;
                  <input type="number" name="attr_nbgroup" title="@{nbgroup}" min="5" max="8" value="">
                </div>
              </div>

            </div>

            <div class="sheet-col">

              <h4>Coups spéciaux</h4>

              <div class="d-flex m2">

                <input type="checkbox" name="attr_pnj_tact" value="1">
                &nbsp;<span title="+5 en attaque, DM / 2">Attaque assurée</span>
                
                &nbsp;<input type="checkbox" name="attr_pnj_tact" value="2">
                &nbsp;<span title="-3 en attaque, +1d4° DM">Précise</span>
                
                &nbsp;<input type="checkbox" name="attr_pnj_tact" value="3">
                &nbsp;<span title="-7 en attaque, +2d4° DM">Violente</span>

              </div>
              
              <div class="d-flex m2">

                <input type="radio" name="attr_pnj_spec" value="0" checked>
                &nbsp;<span>Aucun</span>

              </div>


              <div class="d-flex m2">

                <input type="radio" name="attr_pnj_spec" value="1">
                &nbsp;<input type="text" name="attr_cspec1_nom" title="@{cspec1_nom}" placeholder="Coup spécial 1" value="">
                &nbsp;<input type="checkbox" name="attr_cspec1_roll" title="@{cspec1_roll} Dé bonus" value="1">
                &nbsp;<input type="checkbox" name="attr_cspec1_roll" title="@{cspec1_roll} Dé malus" value="2">
                &nbsp;/&nbsp;<input type="number" name="attr_cspec1_bonus" title="@{cspec1_bonus} Bonus attaque" value="">
                &nbsp;<input type="text" name="attr_cspec1_dm" title="@{cspec1_dm}" placeholder="Bonus DM 1" value="">
                &nbsp;<input type="checkbox" name="attr_cspec1_next" title="@{cspec1_next} Prochaine attaque" value="1">

              </div>

              <div class="d-flex m2">

                <input type="radio" name="attr_pnj_spec" value="2">
                &nbsp;<input type="text" name="attr_cspec2_nom" title="@{cspec2_nom}" placeholder="Coup spécial 2" value="">
                &nbsp;<input type="checkbox" name="attr_cspec2_roll" title="@{cspec2_roll} Dé bonus" value="1">
                &nbsp;<input type="checkbox" name="attr_cspec2_roll" title="@{cspec2_roll} Dé malus" value="2">
                &nbsp;/&nbsp;<input type="number" name="attr_cspec2_bonus" title="@{cspec2_bonus} Bonus attaque" value="">
                &nbsp;<input type="text" name="attr_cspec2_dm" title="@{cspec2_dm}" placeholder="Bonus DM 2" value="">
                &nbsp;<input type="checkbox" name="attr_cspec2_next" title="@{cspec2_next} Prochaine attaque" value="1">

              </div>

              <div class="d-flex m2">

                <input type="radio" name="attr_pnj_spec" value="3">
                &nbsp;<input type="text" name="attr_cspec3_nom" title="@{cspec3_nom}" placeholder="Coup spécial 3" value="">
                &nbsp;<input type="checkbox" name="attr_cspec3_roll" title="@{cspec3_roll} Dé bonus" value="1">
                &nbsp;<input type="checkbox" name="attr_cspec3_roll" title="@{cspec3_roll} Dé malus" value="2">
                &nbsp;/&nbsp;<input type="number" name="attr_cspec3_bonus" title="@{cspec3_bonus} Bonus attaque" value="">
                &nbsp;<input type="text" name="attr_cspec3_dm" title="@{cspec3_dm}" placeholder="Bonus DM 3" value="">
                &nbsp;<input type="checkbox" name="attr_cspec3_next" title="@{cspec3_next} Prochaine attaque" value="1">

              </div>

            </div>

          </div>

        </div>

        <div class="npc-abilities-subtab">
        
          <div class="npc-abilities">

            <div class="npc-ability">
              <div></div>
              <h4>
                CAPACIT&Eacute;
                <button type="action" class="flat-btn img-btn" name="act_npcrolls_menu-btn" title="%{npcrolls_menu-btn} Menu des jets de capacités">
                  <span class="img-btn">l</span>
                </button>
              </h4>
              <h4>UTILISATIONS</h4>
              <h4>DESCRIPTION</h4>
            </div>
  
            <fieldset class="repeating_npcrolls">
              
              <div class="npc-ability">
  
                <div>
                  <input type="hidden" name="attr_npcroll-btn" value="">
                  <button type="action" class="hidden" name="act_npcroll-btn"/>
                  <button type="roll" class="flat-btn img-btn" name="roll_npcroll" title="%{repeating_npcrolls_ID_npcroll-btn}" value="@{npcroll-btn}">
                    <span class="img-btn img-btn-lg">w</span>
                  </button>
                </div>
  
                <div class="bordered d-flex">
                  <input type="text" name="attr_npcroll-name" title="@{npcroll-name}" placeholder="Nom de la capacité" value="">
                </div>

                <div class="bordered d-flex">
                  <input type="number" name="attr_npcroll-uses" title="@{npcroll-uses} Nombre d'utilisations" value="">
                  /
                  <input type="number" name="attr_npcroll-max" title="@{npcroll-max} Nombre d'utilisations max"value="">
                  &nbsp;
                  <input type="text" list="npcroll-freqs" name="attr_npcroll-freq" title="@{npcroll-freq} Fréquence d'utilisation" placeholder="Par ..." value="">
                  <datalist id="npcroll-freqs">
                    <option value="combat"></option>
                    <option value="jour"></option>
                  </datalist>

                </div>
  
                <div class="bordered d-flex">
                  <textarea class="one-row" name="attr_npcroll-desc" title="@{npcroll-desc}" placeholder="Description de la capacité"></textarea>
                </div>
  
              </div>
  
            </fieldset>
  
          </div>

        </div>

        <div class="npc-notes-subtab">

          <div class="sheet-2colrow">

            <div class="sheet-col">

              <div class="block-title block-header">
                Tactique
              </div>
              <textarea class="xx-large" name="attr_pnj_tactique" title="@{pnj_tactique}"></textarea>

            </div>

            <div class="sheet-col">

              <div class="block-title block-header">
                Notes
              </div>
              <textarea class="xx-large" name="attr_notes" title="@{notes}"></textarea>

            </div>
            
          </div>


        </div>

      </div>

      <div class="npc-gears-tab">

        <div class="npc-gears">

          <!-- Liste des équipements -->
          <div class="gears">

            <div class="block-title block-header">
              Equipements
              <button type="action" name="act_helpgear-btn" class="img-btn flat-btn" title="Aide équipement" >
                <span class="img-btn img-btn-lg">i</span>
              </button>
            </div>

            <div class="bordered">
              <div class="d-flex d-flex-middle">
                <input type="hidden" name="attr_tresor" value="">
                <input type="hidden" name="attr_tresor_pieces" value="">
                &nbsp;Trésor&nbsp;:&nbsp;<input type="text" name="attr_tresor" title="@{tresor}" readonly>
              </div>
              <div class="d-flex d-flex-middle">
                <details>
                  <summary>Bourse</summary>
                  <div class="d-flex">
                    PC:<input type="number" class="treasure" name="attr_tresor_pc">
                    <input type="radio" class="treasure" name="attr_tresor_monnaie" title="@{tresor_monnaie} Compter le trésor en PA" value="pa" checked>
                    &nbsp;PA:<input type="number" class="treasure" name="attr_tresor_pa">
                    <input type="radio" class="treasure" name="attr_tresor_monnaie" title="@{tresor_monnaie} Compter le trésor en PO" value="po">
                    &nbsp;PO:<input type="number" class="treasure" name="attr_tresor_po">
                    PP:<input type="number" class="treasure" name="attr_tresor_pp">
                  </div>
                </details>
              </div>
            </div>

            <div class="bordered">
              
              <fieldset class="repeating_equipement">

                <details>
                  <summary>

                    <span>
                      <input type="text" name="attr_equip-nom" title="@{equip-nom}" placeholder="Nom de l'équipement">
                      <button type="action" class="flat-btn" name="act_equipshow-btn" title="Informations sur l'équipement">
                        <span class="img-btn">w</span>
                      </button>
                      Nbre <input type="number" name="attr_equip-qte" title="@{equip-qte} Quantité possédée" value="1">
                    </span>

                  </summary>

                  <div class="d-flex">
                    <textarea class="one-row" name="attr_equip-detail" title="@{equip-detail}" placeholder="Description détaillée" value=""></textarea>
                  </div>

                  <div class="d-flex d-flex-middle">
                    <input type="hidden" name="attr_equip-modprops" value="">
                    <textarea class="one-row" name="attr_equip-props" title="@{equip-props} Propriétés" placeholder="Propriétés"></textarea>
                  </div>

                </details>


              </fieldset>

            </div>
          </div>

          <input type="hidden" class="has-script" name="attr_script_show" value="0">
          <div class="ammos">
  
            <div class="block-title block-header">
              Munitions
            </div>
  
            <div class="bordered">
              
              <fieldset class="repeating_ammos">
  
                <div class="d-flex">
                  <input type="text" name="attr_ammo-nom" title="@{ammo-nom}" placeholder="Nom de la munition" value="">
                  &nbsp;
                  <select class="select-md" name="attr_ammo-type" title="@{ammo-type} Type de munition">
                    <option value="fleche" selected>Flèche</option>
                    <option value="carreau">Carreau</option>
                    <option value="balle">Balle</option>
                    <option value="autre">Autre</option>
                  </select>
                </div>
                
                <div class="d-flex">
                  <input type="number" class="two-digits" name="attr_ammo-qte" title="@{ammo-qte}" min="0" value="1">
                  &nbsp;/&nbsp;
                  <input type="number" class="two-digits" name="attr_ammo-qte_max" title="@{ammo-qte_max}" min="0" value="1">
                  &nbsp;%&nbsp;
                  <input type="number" name="attr_ammo-taux" title="@{ammo-taux} Taux de perte" min="0" max="100" value="100">
                  &nbsp;
                  <textarea class="one-row" name="attr_ammo-effet" title="@{ammo-effet} Effets" placeholder="Effets (liste de mots-clé)"></textarea>
                </div>
  
                <div class="d-flex">
                  <textarea class="one-row" name="attr_ammo-exteff" title="@{ammo-exteff} Effets étendus" placeholder="Effets étendus (syntaxe des options d'attaque)"></textarea>
                </div>
  
              </fieldset>
  
            </div>
          </div>
        </div>

      </div>

      <div class="npc-config-tab">

        <hr>

        <div class="sheet-2colrow">

          <div class="sheet-col">

            <ul>

              <li>
                Jets&nbsp;:&nbsp;
                <select class="select-md" name="attr_togm" title="@{togm}">
                  <option value="" selected>Publics</option>
                  <option value="/w gm ">Chuchotés au MJ</option>
                </select>
                <input type="checkbox" name="attr_token_dsp" title="@{token_dsp}" value=" {{token=[x](@{token_url}) }} ">
                <span>Avec token</span>
              </li>

              <li class="config-check">
                <input type="checkbox" name="attr_cfg_1attack_roll" value="1">
                <span>Un seul jet d'attaque</span>
              </li>
              
              <li class="config-check">
                <input type="checkbox" name="attr_cfg_cible" value="1">
                <span>Attaques ciblées</span>
              </li>

            </ul>

            <h4>Règles optionnelles</h4>
            <ul>

              <li class="config-check" title="Atlas & règles optionnelles, p. 160">
                <input type="checkbox" name="attr_cfg_init_variable" value="1d6!">
                <span>Initiative variable&nbsp;</span>
              </li>

              <li class="config-check" title="Ajoute (PER+AGI)/10 au score final">
                <input type="checkbox" name="attr_cfg_init_mod" value="1">
                <span>Départager les init. identiques</span>
              </li>

            </ul>

            <h4>Règles optionnelles (COMBAT)</h4>
            <ul>

              <li class="config-check" title="Atlas & règles optionnelles, p. 161">
                <input type="checkbox" name="attr_cfg_crit_diff" value="1">
                <span>Critiques différenciés&nbsp;</span>
              </li>

              <li class="config-check" title="Atlas & règles optionnelles, p. 163-164">
                <input type="checkbox" name="attr_cfg_tbl_crit" value="1">
                <span>Table de coups critiques</span>&nbsp;
                <select class="select-md" name="attr_cfg_tbl_critdie" title="@{cfg_tbl_critdie}">
                  <option value="">Choisir...</option>
                  <option value="6">d6</option>
                  <option value="8">d8</option>
                  <option value="10">d10</option>
                  <option value="12">d12</option>
                  <option value="20">d20</option>
                  <option value="20b">d20 bonus</option>
                </select>
              </li>

              <li class="config-check" title="Atlas & règles optionnelles, p. 162">
                <input type="checkbox" name="attr_cfg_tbl_fumble" value="1">
                <span>Table d'échec critique</span>
              </li>

            </ul>

            <h4 title="@{atkbase_pnj} Utiliser les scores de base">
              Attaques&nbsp;
              <input type="checkbox" name="attr_atkbase_pnj" value="1">
            </h4>
            
            <ul>

              <li>
                <div class="npc-configs m2">
                  <div>Contact</div>
                  <div class="d-flex">
                    : <input type="number" class="two-digits" name="attr_atkcac_pnj" title="@{atkcac_pnj} Bonus d'attaque au contact">
                    <input type="hidden" name="attr_atkcac">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Distance</div>
                  <div class="d-flex">
                    : <input type="number" class="two-digits" name="attr_atktir_pnj" title="@{atktir_pnj} Bonus d'attaque à distance">
                    <input type="hidden" name="attr_atktir">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Magique</div>
                  <div class="d-flex">
                    : <input type="number" class="two-digits" name="attr_atkmag_pnj" title="@{atkmag_pnj} Bonus d'attaque magique">
                    <input type="hidden" name="attr_atkmag">                    
                  </div>
                </div>
              </li>

            </ul>

            <h4>Défense</h4>

            <ul>

              <li>
                <div class="npc-configs m2">
                  <div>Base</div>
                  <div class="d-flex">
                    : <input type="number" class="two-digits" name="attr_def_val" title="@{def_val}">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Supérieure</div>
                  <div class="d-flex">
                    : <input type="number" class="two-digits" name="attr_def_supval" title="@{def_supval}">
                  </div>
                </div>
              </li>

            </ul>

          </div>

          <div class="sheet-col">
            
            <div class="float-right">
              <input type="checkbox" name="attr_debug_mode" value="1" title="Mode Debug">&nbsp;
              <button type="action" class="flat-btn img-btn" name="act_def_config-btn" title="Importer la configuration&#10;Valider la configuration par défaut (fiche PNJBase)">
                <span class="img-btn">x</span>
              </button>
            </div>

            <h4 title="Permet de choisir un jet de caractéristique ou de compétence">Compétences</h4>
            <textarea class="large" name="attr_pnj_comp" title="@{pnj_comp}" placeholder="XXX: +bonus Nom de la compétence" value=""></textarea>

            <h4 title="Permet de calculer les attributs du compagnon selon ceux de son propriétaire">Compagnon</h4>
            <ul>

              <li>
                <div class="npc-configs m2">
                  <div>Nom du PJ</div>
                  <div class="d-flex">
                    : <input type="text" name="attr_compagnon" title="@{compagnon}">
                  </div>
                </div>
              </li>
                
              <li>
                <div class="npc-configs m2">
                  <div>Défense</div>
                  <div class="d-flex">
                    : <input type="text" name="attr_comp_def" title="@{comp_def}" placeholder="Expression (ex : 10 + [rang_voie2])">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Vigueur</div>
                  <div class="d-flex">
                    : <input type="text" name="attr_comp_pv_max" title="@{comp_pv_max}" placeholder="Expression (ex : 10 + [niveau]*4)">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Initiative</div>
                  <div class="d-flex">
                    : <input type="text" name="attr_comp_init" title="@{comp_init}" placeholder="Expression (ex : [init])">
                  </div>
                </div>
              </li>

              <li>
                <div class="npc-configs m2">
                  <div>Attaque</div>
                  <div class="d-flex">
                    : <input type="text" name="attr_comp_pnjatk" title="@{comp_pnjatk}" placeholder="Expression (ex : [atkmag])">
                  </div>
                </div>
              </li>
              
            </ul>

          </div>

        </div>
        
        <hr>

        <details>
          <summary>Importer un statblock</summary>
          <div class="npc-2colrow">
            <div>
              <textarea name="attr_statblock" class="stat-block" placeholder="Coller ici un statblock copié depuis le PDF ou le DRS"></textarea>
            </div>
            <div>
              <button type="action" name="act_importsb-btn" class="flat-btn img-btn" title="Importer le statblock">
                <span class="img-btn">W</span>&nbsp;Import
              </button>
              <br>
              &nbsp;<input type="checkbox" name="attr_from_drs" title="@{from_drs}" value="1">
              &nbsp;Texte copié depuis le DRS de Chroniques Oubliées
              <br>
              <input type="text" value="https://drs.chroniques-oubliees.fr/fantasy/creatures" readonly>              
              <textarea class="import-result medium" name="attr_resultsb"></textarea>
            </div>
          </div>
        </details>

      </div>

      <div class="npc-script-tab">
        <h3><span name="attr_script_title"></span></h3>

        <input class="show-script" type="hidden" name="attr_script_show" value="0">
        <div class="show-script">

          <div class="sheet-2colrow">
  
            <div class="sheet-col">
  
              <ul>
                <li>
                  Renuméroter les attaques&nbsp;
                  <button type="action" class="flat-btn img-btn" name="act_renum_npcatk-btn" title="Renuméroter les attaques">
                    <span class="img-btn">x</span>
                  </button>
                </li>
              </ul>

              
              <h4>Listes d'actions</h4>

              <div class="npc-actions">
               
                <details open>
                  <summary class="block-title">
                    <span name="attr_liste_actions_1"></span>
                  </summary>
                  <input type="hidden" name="attr_liste_actions_1" value="Actions du tour">
                  <fieldset class="repeating_actions1">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="npc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_2"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_2" title="@{liste_actions_2}" value="Liste d'actions n°2">
                  <fieldset class="repeating_actions2">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="npc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_3"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_3" title="@{liste_actions_3}" value="Liste d'actions n°3">
                  <fieldset class="repeating_actions3">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="npc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_4"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_4" title="@{liste_actions_4}" value="Liste d'actions n°4">
                  <fieldset class="repeating_actions4">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

              <div class="npc-actions">
               
                <details>
                  <summary class="block-title">
                    <span name="attr_liste_actions_5"></span>
                  </summary>
                  <input class="list-name" type="text" name="attr_liste_actions_5" title="@{liste_actions_5}" value="Liste d'actions n°5">
                  <fieldset class="repeating_actions4">
                    <div class="d-flex">
                      <input type="checkbox" name="attr_action-on" title="@{action-on} Action disponible" value="1" checked>
                      <input type="text" name="attr_action-nom" title="@{action-nom}" placeholder="Nom de l'action">
                      <select class="select-sm" name="attr_action-type" title="@{action-type} Type G/M/A/L">
                        <option value="" selected>n/a</option>
                        <option value="G">(G)</option>
                        <option value="M">(M)</option>
                        <option value="A">(A)</option>
                        <option value="L">(L)</option>
                      </select>
                    </div>
                    <textarea class="one-row" name="attr_action-cmd" title="@{action-cmd}" placeholder="Commande de script"></textarea>
                  </fieldset>
                </details>

              </div>

            </div>
  
            <div class="sheet-col">

              <h4>Prédicats</h4>
              <textarea class="x-large" name="attr_predicats_script" title="@{predicats_script} Prédicats" value=""></textarea>

            </div>
  
          </div>

        </div>

        <hr>
        
        <h4>Autres scripts MOD</h4>
        
        <div class="sheet-2colrow">

          <div class="sheet-col">
            <input type="checkbox" name="attr_tokenmod" title="@{tokenmod}" value="1">
            <span>Token Mod</span>
            <div class="npc-configs m2">
              <div>Teinte 1/2 PV</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_token_tint_on" title="@{token_tint_on}" value="1">
                &nbsp;<input type="text" name="attr_token_tint" title="@{token_tint}" value="ED2939">
              </div>
            </div>
            <div class="npc-configs m2">
              <div>Marker 0 PV</div>
              <div class="d-flex">
                <input type="checkbox" name="attr_tkmarker_dead_on" title="@{tkmarker_dead_on}" value="1">
                &nbsp;<input type="text" class="w-auto" name="attr_tkmarker_dead" title="@{tkmarker_dead}" value="dead">
              </div>
            </div>
            <hr>
            <input type="checkbox" name="attr_chatsetattr" title="@{chatsetattr}" value="1">
            <span>ChatSetAttr</span>
          </div>

          <div class="sheet-col">
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- Character mancer -->
  <charmancer class="sheet-charmancer-main">

    <div class="cofmancer">

      <h1>Chroniques Oubliées Fantasy 2E</h1>

      <div class="sheet-2colrow">
        
        <h3>Persomancien</h3>

        <div class="sheet-col">
        
          <div>
            Type :
            <select class="select-md" name="comp_type">
              <option value="pol">Polyvalent</option>
              <option value="exp" selected>Expert</option>
              <option value="spe">Spécialiste</option>
            </select>
          </div>

          <br>

          <input type="hidden" name="comp_display" value="exp">

          <div class="type-pol">

            <div class="d-flex d-flex-between">
              <div class="stat-cell">&nbsp;</div>
              <div class="stat-cell">+2</div>
              <div class="stat-cell">+2</div>
              <div class="stat-cell">+2</div>
              <div class="stat-cell">+1</div>
              <div class="stat-cell">+1</div>
              <div class="stat-cell">+0</div>
              <div class="stat-cell">-1</div>
              <div class="stat-cell">Peuple</div>
              <div class="stat-cell">&nbsp;</div>
            </div>

          </div>

          <div class="type-exp">

            <div class="d-flex d-flex-between">
              <div class="stat-cell">&nbsp;</div>
              <div class="stat-cell">+3</div>
              <div class="stat-cell">+2</div>
              <div class="stat-cell">+1</div>
              <div class="stat-cell">+1</div>
              <div class="stat-cell">+0</div>
              <div class="stat-cell">+0</div>
              <div class="stat-cell">-1</div>
              <div class="stat-cell">Peuple</div>
              <div class="stat-cell">&nbsp;</div>
            </div>

          </div>

          <div class="type-spe">

            <div class="d-flex d-flex-between">
              <div class="stat-cell">&nbsp;</div>
              <div class="stat-cell">+4</div>
              <div class="stat-cell">+2</div>
              <div class="stat-cell">+1</div>
              <div class="stat-cell">+0</div>
              <div class="stat-cell">+0</div>
              <div class="stat-cell">-1</div>
              <div class="stat-cell">-1</div>
              <div class="stat-cell">Peuple</div>
              <div class="stat-cell">&nbsp;</div>
            </div>

          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">AGI</div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_agi_rb" value="6"></div>
            <div>
              <select class="select-xs agi-mod" name="comp_agi_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell agi-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">CON</div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_con_rb" value="6"></div>
            <div>
              <select class="select-xs con-mod" name="comp_con_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell con-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">FOR</div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_for_rb" value="6"></div>
            <div>
              <select class="select-xs for-mod" name="comp_for_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell for-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">PER</div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_per_rb" value="6"></div>
            <div>
              <select class="select-xs per-mod" name="comp_per_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell per-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">CHA</div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_cha_rb" value="6"></div>
            <div>
              <select class="select-xs cha-mod" name="comp_cha_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell cha-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">INT</div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_int_rb" value="6"></div>
            <div>
              <select class="select-xs int-mod" name="comp_int_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell int-val">0</div>
          </div>

          <div class="d-flex d-flex-between">
            <div class="stat-cell">VOL</div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="0"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="1"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="2"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="3"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="4"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="5"></div>
            <div class="stat-cell"><input type="radio" name="comp_vol_rb" value="6"></div>
            <div>
              <select class="select-xs vol-mod" name="comp_vol_mod">
                <option>-1</option>
                <option selected>+0</option>
                <option>+1</option>
              </select>
            </div>
            <div class="stat-cell vol-val">0</div>
          </div>

          <hr>

          <div class="d-flex">
            <span class="align-self-center">Peuple :</span>
            <select class="select-md align-self-center" name="comp_peuple">
              <option value="">Choisir...</option>
              <option>Demi-elfe</option>
              <option>Demi-orc</option>
              <option>Elfe (haut)</option>
              <option>Elfe (sylvain)</option>
              <option>Gnome</option>
              <option>Halfelin</option>
              <option>Humain</option>
              <option>Nain</option>
            </select>
            <span class="people-mods align-self-center"></span>
          </div>

          <hr>
    
          <div class="d-flex">
            <span>Profil :</span>
            <select class="select-lg" name="comp_famille_profil">
              <option value="">Choisir...</option>
              <optgroup label="Aventuriers">
                <option disabled class="optgroup">
                  &nbsp;Aventuriers
                </option>
                <option value="Aventuriers:Arquebusier">Arquebusier</option>
                <option value="Aventuriers:Barde">Barde</option>
                <option value="Aventuriers:Rôdeur">Rôdeur</option>
                <option value="Aventuriers:Voleur">Voleur</option>
              </optgroup>
              <optgroup label="Combattants">
                <option disabled class="optgroup">
                  &nbsp;Combattants
                </option>
                <option value="Combattants:Barbare">Barbare</option>
                <option value="Combattants:Chevalier">Chevalier</option>
                <option value="Combattants:Guerrier">Guerrier</option>
              </optgroup>
              <optgroup label="Mages">
                <option disabled class="optgroup">
                  &nbsp;Mages
                </option>
                <option value="Mages:Ensorceleur">Ensorceleur</option>
                <option value="Mages:Forgesort">Forgesort</option>
                <option value="Mages:Magicien">Magicien</option>
                <option value="Mages:Sorcier">Sorcier</option>
              </optgroup>
              <optgroup label="Mystique">
                <option disabled class="optgroup">
                  &nbsp;Mystique
                </option>
                <option value="Mystiques:Druide">Druide</option>
                <option value="Mystiques:Moine">Moine</option>
                <option value="Mystiques:Prêtre">Prêtre</option>
              </optgroup>
            </select>
          </div>

          <div>
            <input type="checkbox" name="comp_base_gear" value="1">
            Charger l'équipement de base
          </div>

          <div>
            <input type="checkbox" name="comp_gear_atks" value="1">
            Créer des attaques pour les armes
          </div>
    
        </div>

        <div class="sheet-col">

          <h4>Voie de peuple (1)</h4>
          <textarea name="comp_voie1" placeholder="Coller le texte de la voie de peuple ou du mage"></textarea>
          <div class="d-flex">
            <input type="radio" name="comp_rank2" value="1">
            &nbsp;Rang 2 (famille des mages)
          </div>
          <br>

          <h4>Voie de profil (2)</h4>
          <textarea name="comp_voie2" placeholder="Coller le texte d'une voie de profil"></textarea>
          <div class="d-flex">
            <input type="radio" name="comp_rank2" value="2">
            &nbsp;Rang 2 (famille des mages)
          </div>
          <br>

          <h4>Voie de profil (3)</h4>
          <textarea name="comp_voie3" placeholder="Coller le texte d'une voie de profil"></textarea>
          <div class="d-flex">
            <input type="radio" name="comp_rank2" value="3">
            &nbsp;Rang 2 (famille des mages)
          </div>
          <br>

        </div>

      </div>
      
      <hr>
    
      <div class="d-flex d-flex-between">
        <button type="cancel" value="cancel">Annuler</button>
        <button type="finish" value="finish">Valider</button>
      </div>

    </div>

  </charmancer>

</div>

<rolltemplate class="sheet-rolltemplate-cof2">

  {{^token}}
  <div class="sheet-rt sheet-rt-header sheet-color-{{color}} sheet-rt-title">
    {{perso}}
  </div>
  {{/token}}
  {{#token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header sheet-color-{{color}} sheet-rt-title">
    <div class="sheet-rt-token">{{token}}</div>
    <div>{{perso}}</div>
  </div>
  {{/token}}
  <div class="sheet-rt sheet-rt-2cols sheet-rt-header sheet-color-{{color}}">
    <div>{{lsub}}</div>
    <div>{{rsub}}</div>
  </div>
  {{#tags}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt sheet-rt-tags">{{tags}}</span>
  </div>
  {{/tags}}
  {{#roll}}
  <div class="sheet-rt sheet-rt-roll">
    <span class="sheet-rt sheet-rt-roll">{{roll}}</span>
    {{#broll}}
    | <span class="sheet-rt sheet-rt-roll">{{broll}}</span>
    {{/broll}}
  </div>
  {{#tohit}}
  {{#^rollLess() roll tohit}}
  <div class="sheet-rt sheet-rt-text sheet-rt-centered">
    <span>Contre *{{target}}* :</span>
    {{#rollTotal() opposed 1}}
    <span>{{tohit}}</span><br>
    {{/rollTotal() opposed 1}}
    <span class="sheet-rt sheet-rt-hit">SUCCÈS !</span>
  </div>
  {{/^rollLess() roll tohit}}
  {{#rollLess() roll tohit}}
  <div class="sheet-rt sheet-rt-text sheet-rt-centered">
    <span>Contre *{{target}}* :</span>
    {{#rollTotal() opposed 1}}
    <span>{{tohit}}</span><br>
    {{/rollTotal() opposed 1}}
    <span class="sheet-rt sheet-rt-miss">ÉCHEC !</span>
  </div>
  {{/rollLess() roll tohit}}
  {{/tohit}}
  {{/roll}}
  {{#powder}}
    {{#rollWasFumble() roll}}
    <div class="sheet-rt sheet-rt-text">
      <span class="sheet-rt-fumble">{{powder}}</span>
    </div>
    {{/rollWasFumble() roll}}
    {{#broll}}
      {{#rollWasFumble() broll}}
      <div class="sheet-rt sheet-rt-text">
        <span class="sheet-rt-fumble">{{powder}} (si dé malus)</span>
      </div>
      {{/rollWasFumble() broll}}
    {{/broll}}
  {{/powder}}
  {{#dm}}
  <div class="sheet-rt sheet-rt-2cols">
    <div>Dommages</div>
    <div>
      {{dm}} {{#rollWasCrit() roll}}
      {{#rollTotal() critdiff 0}}
      <span class="sheet-rt-critical"> + {{dm}} CRITIQUE !</span><br>
      {{/rollTotal() critdiff 0}}
      {{/rollWasCrit() roll}}
      {{#^rollWasCrit() roll}} {{#rollWasCrit() broll}}
      {{#rollTotal() critdiff 0}}
      ( + <span class="sheet-rt-critical">{{dm}}</span> si dé bonus)<br>
      {{/rollTotal() critdiff 0}}
      {{/rollWasCrit() broll}}
      {{/^rollWasCrit() roll}} {{dmdesc}}
    </div>
    {{#dmextra}}
    <div></div>
    <div>{{dmextra}}</div>
    {{/dmextra}}
  </div>
  {{/dm}}
  {{#dmcrit}}
    {{#rollWasCrit() roll}}
    <div class="sheet-rt sheet-rt-2cols">
      <div><span class="sheet-rt-critical">CRITIQUE !</span></div>
      <div>
        {{dmcrit}}
      </div>
    </div>
    {{/rollWasCrit() roll}}
    {{#rollWasCrit() broll}}
    <div class="sheet-rt sheet-rt-2cols">
      <div><span class="sheet-rt-critical">CRITIQUE (si dé bonus)</span></div>
      <div>
        {{dmcrit}}
      </div>
    </div>
    {{/rollWasCrit() broll}}
  {{/dmcrit}}
  {{#roll}}
    {{#rollTotal() computed::critsuccess 1}}
    <div class="sheet-rt sheet-rt-text">
      <span class="sheet-rt sheet-rt-critical">{{crithit}}</span>
    </div>
    {{/rollTotal() computed::critsuccess 1}}
    {{#broll}}
      {{#rollTotal() computed::bcritsuccess 1}}
      <div class="sheet-rt sheet-rt-text">
        <span class="sheet-rt sheet-rt-secondary">Si dé bonus :</span>
        <br>
        <span class="sheet-rt sheet-rt-critical">{{crithit}}</span>
      </div>
      {{/rollTotal() computed::bcritsuccess 1}}
    {{/broll}}
  {{/roll}}
  {{#roll}}
    {{#rollTotal() computed::critfail 1}}
    <div class="sheet-rt sheet-rt-text">
      <span class="sheet-rt sheet-rt-fumble">{{fumble}}</span>
    </div>
    {{/rollTotal() computed::critfail 1}}
    {{#broll}}
      {{#rollTotal() computed::bcritfail 1}}
      <div class="sheet-rt sheet-rt-text">
        <span class="sheet-rt sheet-rt-secondary">Si dé malus :</span>
        <br>
        <span class="sheet-rt sheet-rt-fumble">{{fumble}}</span>
      </div>
      {{/rollTotal() computed::bcritfail 1}}
    {{/broll}}
  {{/roll}}
  {{#roll}}
    {{#rollTotal() computed::rollf 1}}
    <div class="sheet-rt sheet-rt-text">
      {{rolleffect}}
    </div>
    {{/rollTotal() computed::rollf 1}}
    {{#broll}}
      {{#rollTotal() computed::brollf 1}}
      <div class="sheet-rt sheet-rt-text">
        <span class="sheet-rt sheet-rt-secondary">Si dé bonus :</span>
        <br>
        {{brolleffect}}
      </div>
      {{/rollTotal() computed::brollf 1}}
    {{/broll}}
  {{/roll}}
  {{#heal}}
  <div class="sheet-rt sheet-rt-roll">
    <span class="sheet-rt sheet-rt-roll">{{heal}} PV récupérés</span>
  </div>
  {{/heal}}
  {{#text}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt-{{textclass}}">{{text}}</span>
  </div>
  {{/text}}
  {{#chance}}
  <div class="sheet-rt sheet-rt-text">
    <span>{{chance}}</span>
    {{#aide}}
    <span>{{aide}}</span>
    {{/aide}}
  </div>
  {{/chance}}
  {{^chance}}
  {{#aide}}
  <div class="sheet-rt sheet-rt-text">
    <span>{{aide}}</span>
  </div>
  {{/aide}}
  {{/chance}}
  {{#alert}}
  <div class="sheet-rt sheet-rt-text">
    <span class="sheet-rt-{{alertclass}}">{{alert}}</span>
  </div>
  {{/alert}}

</rolltemplate>

<rolltemplate class="sheet-rolltemplate-custom">

  <div class="sheet-container sheet-color-{{color}}">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    {{#text}}
      <div class="sheet-content">
        <div class="sheet-text">{{text}}</div>
      </div>
    {{/text}}
    <div class="sheet-content">
      {{#text}}
      <div></div>
      <div></div>
      {{/text}}
      {{#allprops() title subtitle desc text color token}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title subtitle desc text color token}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>

</rolltemplate>

<script type="text/worker">

/**
 * COF2e Sheet Worker
 * v1.13.0
 */

const SWData = {
  settings: {
    debugMode: false,
    hiddenClass: "hidden",
    visibleClass: "visible",
    peoplePath: 1,
    profilePaths: [ 2, 3 ],
    level1Paths: [ 1, 2, 3 ],
    minLevels: [ 1, 2, 3, 5, 7, 9, 11, 13 ],
    highFan: [ 
      "cfg_use_epic",
      "cfg_use_drniv",
      "cfg_use_mana"
    ],
    lowFan: [
      "cfg_use_capped6",
      "cfg_use_dronly",
      "cfg_atk_diff",
      "cfg_usure",
      "cfg_use_fear"
    ],
    tokens: {
      size: 70,
      target: {
        def: "[[@{target|def}]]",
        opposed: "[[1d20[Dé] + @{target|atkcac}[Att. Contact Cible] ]]",
        name: "@{target|token_name}",
      },
      PC: {
        bar1: "",
        bar1_link: "pm",
        bar2: "",
        bar2_link: "def", 
        bar3: "",
        bar3_link: "pv",
        bar4: "",
        bar4_link: "vitesse_cases",
      },
      NPC: {
        bar1: "",
        bar1_link: "", 
        bar2: "",
        bar2_link: "def",
        bar3: "@{pv}",
        bar3_link: "",
        bar4: "",
        bar4_link: "vitesse_cases"
      }
    }
  },
  emojis: {
    "atkcac":   "&#9876;&#65039;",  // crossed-swords
    "atktir":   "&#127993;",        // bow and arrow
    "atkmag":   "&#129668;",        // magic wand
    "actions":  "&#128262;",        // bright
    "skills":   "&#128170;",        // flexed biceps
    "heal":     "&#129505;",        // red heart
  },
  SHEET_TYPE: {
    PC: "pc",
    NPC: "npc"
  },
  RT_OPTIONS: {
    template: "cof2"
  },
  COLORS: {
    default:  [ "burlywood", "#000" ],
    blue:     [ "#0d6efd", "#fff" ],
    indigo:   [ "#6610f2", "#fff" ],
    purple:   [ "#6f42c1", "#fff" ],
    pink:     [ "#d63384", "#fff" ],
    red:      [ "#dc3545", "#fff" ],
    orange:   [ "#fd7e14", "#000" ],
    yellow:   [ "#ffc107", "#000" ],
    green:    [ "#198754", "#fff" ],
    teal:     [ "#20c997", "#fff" ],
    cyan:     [ "#0dcaf0", "#fff" ],
    gray:     [ "#6c757d", "#fff" ],
    dark:     [ "#343a40", "#fff" ],
  },
  PC: {
    PROFILES: {
      Aventuriers: [
        { 
          value: "Arquebusier",
          pv: 4,
          atks: { cac: 2, tir: 3, mag: 0 },
          skills: "artisanat,athletisme,equitation,intimidation,natation,sciences,vigilance",
          gear: [
            {
              name: "Pétoire",
              number: "1",
            },
            {
              name: "Epée longue",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Cuir renforcé",
              number: "1",
            },
          ]
        },
        { 
          value: "Barde",
          pv: 4,
          atks: { cac: 2, tir: 1, mag: 2 },
          skills: "acrobaties,artisanat,athletisme,commerce,connaissances,divertissement,empathie,equitation,intimidation,natation, persuasion, religion, renseignement,tromperie",
          gear : [
            {
              name: "Rapière",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Cuir simple",
              number: "1",
            },
            {
              name: "Instrument de musique",
              number: "1",
            }
          ]
        },
        { 
          value: "Rôdeur",
          pv: 4,
          atks: { cac: 2, tir: 3, mag: 0 },
          skills: "acrobaties,artisanat,athletisme,discretion,equitation,escalade,medecine,natation,survie,vigilance",
          gear: [
            {
              name: "Epée longue",
              number: "1",
            },
            {
              name: "Arc court",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Cuir renforcé",
              number: "1",
            }
          ]
        },
        { 
          value: "Voleur",
          pv: 4,
          atks: { cac: 2, tir: 2, mag: 1 }, 
          skills: "acrobaties,artisanat,athletisme,commerce,discrétion,escalade,effraction,intimidation,natation,persuasion,renseignement,tromperie,vigilance",
          gear: [
            {
              name: "Rapière",
              number: "1",
            },
            {
              name: "Dague",
              number: "5",
            },
            {
              name: "Cuir simple",
              number: "1",
            },
            {
              name: "Outils de crochetage",
              number: "1",
            },
            {
              name: "Corde (10 m)",
              number: "1",
            }
          ]
        },
      ],
      Combattants: [
        { 
          value: "Barbare",
          pv: 5,
          atks: { cac: 3, tir: 2, mag: 0 },
          skills: "artisanat,athletisme,equitation,escalade,intimidation,natation,survie,vigilance",
          gear: [
            {
              name: "Hache à deux mains",
              number: "1",
            },
            {
              name: "Javelot",
              number: "2",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Cuir simple",
              number: "1",
            }
          ]
        },
        { 
          value: "Chevalier",
          pv: 5,
          atks: { cac: 3, tir: 0, mag: 2 },
          skills: "athlétisme,connaissance,equitation,intimidation,natation,persuasion,religion",
          gear: [
            {
              name: "Epée longue",
              number: "1",
            },
            {
              name: "Lance de cavalerie",
              number: "1",
            },
            {
              name: "Cotte de mailles",
              number: "1",
            },
            {
              name: "Grand bouclier",
              number: "1",
            }
          ]
        },
        { 
          value: "Guerrier",
          pv: 5,
          atks: { cac: 3, tir: 2, mag: 0 },
          skills: "artisanat,athletisme,equitation,intimidation,natation",
          gear: [
            {
              name: "Epée longue",
              number: "1",
            },
            {
              name: "Hache à deux mains",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Chemise de mailles",
              number: "1",
            },
            {
              name: "Grand bouclier",
              number: "1",
            }
          ]
        },
      ],
      Mages: [
        { 
          value: "Ensorceleur",
          pv: 3,
          atks: { cac: 1, tir: 1, mag: 3 },
          skills: "artisanat,connaissance,occultisme,sciences",
          gear: [
            {
              name: "Bâton ferré",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            }
          ]
        },
        { 
          value: "Forgesort",
          pv: 3,
          atks: { cac: 2, tir: 0, mag: 3 },
          skills: "artisanat,connaissance,occultisme,sciences",
          gear: [
            {
              name: "Bâton ferré",
              number: "1"
            },
            {
              name: "Dague",
              number: "1"
            },
            {
              name: "Marteau",
              number: "1"
            }
          ]
        },
        { 
          value: "Magicien",
          pv: 3,
          atks: { cac: 1, tir: 1, mag: 3 },
          skills: "artisanat,connaissance,occultisme,sciences",
          gear: [
            {
              name: "Bâton ferré",
              number: "1"
            },
            {
              name: "Dague",
              number: "1"
            },
            {
              name: "Grimoire",
              number: "1"
            }
          ]
        },
        { 
          value: "Sorcier",
          pv: 3,
          atks: { cac: 1, tir: 1, mag: 3 },
          skills: "artisanat,connaissance,occultisme,sciences",
          gear: [
            {
              name: "Bâton ferré",
              number: "1"
            },
            {
              name: "Dague",
              number: "1"
            },
            {
              name: "Grimoire",
              number: "1"
            }
          ]
        },
      ],
      Mystiques: [
        { 
          value: "Druide",
          pv: 4,
          atks: { cac: 2, tir: 1, mag: 2 },
          skills: "artisanat,athletisme,connaissance,discretion,equitation,empathie,medecine,natation,religion,survie,vigilance",
          gear: [
            {
              name: "Epieu",
              number: "1",
            },
            {
              name: "Dague",
              number: "1",
            },
            {
              name: "Arc court",
              number: "1",
            },
            {
              name: "Cuir simple",
              number: "1",
            }
          ]
        },
        { 
          value: "Moine",
          pv: 4,
          atks: { cac: 3, tir: 0, mag: 2 },
          skills: "acrobaties,artisanat,athletisme,connaissance,discretion,empathie,escalade,medecine,natation,religion,survie,vigilance",
          gear: [
            {
              name: "Bâton ferré",
              number: "1"
            }
          ]
        },
        { 
          value: "Prêtre",
          pv: 4,
          atks: { cac: 2, tir: 0, mag: 3 },
          skills: "artisanat,athletisme,connaissance,empathie,equitation,intimidation,medecine,persuasion,religion,survie",
          gear: [
            {
              name: "Marteau de guerre",
              number: "1"
            },
            {
              name: "Chemise de mailles",
              number: "1"
            },
            {
              name: "Petit bouclier",
              number: "1"
            }
          ]
        },
      ],
    },
    STATS: [ 
      "agilité",
      "constitution",
      "force",
      "perception",
      "charisme",
      "intelligence",
      "volonté"
    ],
    STATSUP: {
      "0": "",
      "N": "",
      "S": "*",
      "H": "**",
    },
    COMBAT: {
      init: [
        "cfg_init_agi",
        "init_base",
        "per",
        "agi",
        "init_cond",
        "init_buff" 
      ],
      attacks: [ 
        [ "atkcac", "for", "Au Contact" ],
        [ "atktir", "agi", "A Distance" ], 
        [ "atkmag", "vol", "Magique" ]
      ],
      def: [
        "def_base",
        "armure", "armure_eqp",
        "bouclier", "bouclier_eqp",
        "agi", "con", "def_car_bonus", "def_car_max",
        "rangs_voies", "noms_voies",
        "def_cond",
        "def_buff",
        "def_action"
      ],
      maneuvers: [
        { 
          name: "Distraire (CHA:{{cha}})",
          mod: "{{cha}}",
          effect: `La cible subit un malus de ‑10 à tous ses tests de PER et ‑5 en DEF pendant 1 round.
          Elle est considérée comme surprise pour les attaques sournoises`
        },
        { 
          name: "Gêner",
          mod: "-",
          effect: `Au choix, la cible est ralentie (une seule action M ou A) ou elle subit ‑5 en attaque pendant 1 round.`
        },
        { 
          name: "Repousser°",
          mod: "-",
          effect: `La cible recule de [FOR attaquant + 3] mètres et l’attaquant occupe le terrain libéré.
          Si la cible est acculée (mur, précipice, adversaire), elle perd autant en DEF pour 1 round.
          Cette action peut être précédée d’un déplacement de 10 m en direction de la cible.`
        },
        { 
          name: "Bloquer°",
          mod: "-5",
          effect: `La cible est immobilisée pendant 1 round (dé malus en attaque et pas de déplacement).
          Contre une créature de NC inférieur au niveau de l’attaquant, ce dernier peut maintenir sa prise à chaque round qui suit en emportant un test opposé de FOR (action limitée, modifiée en cas de différence de taille).`
        },
        { 
          name: "Désarmer°",
          mod: "-5",
          effect: `La cible laisse tomber son arme au sol. 
          Elle peut la ramasser avant tout le monde en sacrifiant son prochain tour (elle n’agira pas).`
        },
        { 
          name: "Aveugler",
          mod: "-5",
          effect: `La cible est aveuglée pendant 1 round (‑5 en attaque au contact et en DEF, ‑10 contre une cible à distance).`
        },
        {
          name: "Renverser°",
          mod: "-5",
          effect: `La cible est renversée (‑5 en DEF et action d’attaque pour se relever). 
          Cette action peut être précédée d’un déplacement de 10 m en direction de la cible.`
        },
        { 
          name: "Renverser° (quad.:-10)",
          mod: "-10",
          effect: `La cible est renversée (‑5 en DEF et action d’attaque pour se relever). 
          Cette action peut être précédée d’un déplacement de 10 m en direction de la cible.`
        },
        { 
          name: "Etourdir°",
          mod: "-10",
          effect: `La cible est étourdie pendant 1 round (pas d’action et ‑5 en DEF). 
          Si cette manoeuvre est réussie contre une cible surprise de NC inférieur au niveau de l’attaquant, elle doit réussir un test de CON difficulté 10 (15 si l’attaquant utilise une arme contondante) ou être assommée (inconsciente) pour 1d6 min.`
        },
      ]
    },
    BUFFS: {
      To: [
        "agi", "con", "for", "per", "cha", "int", "vol",
        "tagi", "tcon", "tfor", "tper", "tcha", "tint", "tvol",
        "init",
        "atkcac",
        "atktir",
        "atkmag",
        "def",
        "dm",
        "pv",
        "dr",
        "pm",
        "pc",
      ],
      From: [
        "agi",
        "con",
        "for",
        "per",
        "cha",
        "int",
        "vol",
        ...nameSeq(9, "rang_voie#"),
        "rangs_voies",
        "niveau",
      ]
    },
    CONDITIONS: [
      {
        name: "inconscient",
        label: "Inconscient",
        lowFantasy: false,
        effects: { },
        description: [
          "Tombe au sol inconscient",
          "Perd 1 Dé de Récupération"
        ]
      },
      { 
        name: "affaibli",
        label: "Affaibli",
        lowFantasy: false,
        effects: { },
        description: [
          "Dé malus à tous les tests"
        ]
      },
      { 
        name: "aveugle",
        label: "Aveuglé",
        lowFantasy: false,
        effects: {
          init: -5,
          atkcac: -5,
          def: -5,
          atktir: -10
        },
        description: [
          "Pas d'attaque magique nécessitant de voir la cible"
        ]
      },
      { 
        name: "effraye",
        label: "Effrayé",
        lowFantasy: true,
        effects: {
          atkcac: -2,
          atktir: -2,
          atkmag: -2
        },
        description: [
          "Malus -2 à tous les tests"
        ]
      },
      { 
        name: "essoufle",
        label: "Essouflé",
        lowFantasy: false,
        effects: { },
        description: [
          "Déplacement limité à 5 m par action de mouvement"
        ]
      }, 
      { 
        name: "etourdi",
        label: "Etourdi",
        lowFantasy: false,
        effects: {
          def: -5
        },
        description: [
          "Aucune action possible"
        ]
      }, 
      { 
        name: "immobilise",
        label: "Immobilisé",
        lowFantasy: false,
        effects: { },
        description: [
          "Pas de déplacement",
          "Dé malus aux tests d'attaque"
        ]
      }, 
      { 
        name: "invalide", 
        label: "Invalide",
        lowFantasy: false,
        effects: { },
        description: [
          "Déplacement limité à 5 m par action de mouvement"
        ]
      },
      { 
        name: "panique",
        label: "Paniqué",
        lowFantasy: true,
        effects: {
          def: -2
        },
        description: [
          "Malus -5 à tous les tests",
          "Impossible d'attaquer ou d'incanter"
        ]
      }, 
      { 
        name: "paralyse", 
        label: "Paralysé",
        lowFantasy: false,
        effects: { },
        description: [
          "Aucune action possible",
          "Touché et critique automatique en cas d'attaque"
        ]
      }, 
      { 
        name: "ralenti",
        label: "Ralenti",
        lowFantasy: false,
        effects: { },
        description: [
          "Une seule action par round (attaque ou mouvement)"
        ]
      }, 
      { 
        name: "renverse",
        label: "Renversé",
        lowFantasy: false,
        effects: {
          atkcac: -5,
          atktir: -5,
          atkmag: -5,
          def: -5
        },
        description: [
          "Nécessite une action d'attaque pour se relever"
        ]
      }, 
      { 
        name: "surpris",
        label: "Surpris",
        lowFantasy: false,
        effects: {
          def: -5
        },
        description: [
          "Pas d'action au premier round de combat"
        ]
      }
    ],
    SKILLS: [
      {
        name: "acrobaties",
        label: "",
        ability: "agi",
        emoji: "&#129336;"
      },
      {
        name: "artisanat",
        label: "",
        ability: "int",
        emoji: "&#128296;"
      },
      {
        name: "athletisme",
        label: "Athlétisme",
        ability: [ "agi", "con", "for" ],
        emoji: "&#127939;"
      },
      {
        name: "commerce",
        label: "",
        ability: "cha",
        emoji: "&#128176;"
      },
      {
        name: "connaissance",
        label: "",
        ability: "int",
        emoji: "&#129504;"
      },
      {
        name: "discretion",
        label: "Discrétion",
        ability: "agi",
        emoji: "&#128100;"
      },
      {
        name: "divertissement",
        label: "",
        ability: "cha",
        emoji: "&#129337;"
      },
      {
        name: "equitation",
        label: "",
        ability: [ "agi", "cha" ],
        emoji: "&#128014;"
      },
      {
        name: "escalade",
        label: "",
        ability: "agi",
        emoji: "&#129495;"
      },
      {
        name: "effraction",
        label: "",
        ability: "agi",
        emoji: "&#128275;"
      },
      {
        name: "empathie",
        label: "",
        ability: "per",
        emoji: "&#128149;"
      },
      {
        name: "intimidation",
        label: "",
        ability: "cha",
        emoji: "&#128162;"
      },
      {
        name: "medecine",
        label: "Médecine",
        ability: "per",
        emoji: "&#128150;"
      },
      {
        name: "natation",
        label: "",
        ability: "con",
        emoji: "&#127754;"
      },
      {
        name: "occultisme",
        label: "",
        ability: "int",
        emoji: "&#128302;"
      },
      {
        name: "persuasion",
        label: "",
        ability: "cha",
        emoji: "&#128483;"
      },
      {
        name: "religion",
        label: "",
        ability: "int",
        emoji: "&#128327;"
      },
      {
        name: "renseignement",
        label: "",
        ability: "cha",
        emoji: "&#128269;"
      },
      {
        name: "sciences",
        label: "",
        ability: "int",
        emoji: "&#129514;"
      },
      {
        name: "tromperie",
        label: "",
        ability: "cha",
        emoji: "&#127917;"
      },
      {
        name: "survie",
        label: "",
        ability: "per",
        emoji: "&#128293;"
      },
      {
        name: "vigilance",
        label: "",
        ability: "per",
        emoji: "&#128065;"
      },
      {
        name: "custom1",
        label: "",
        ability: [ "agi", "con", "for", "per", "cha", "int", "vol" ]
      },
      {
        name: "custom2",
        label: "",
        ability: [ "agi", "con", "for", "per", "cha", "int", "vol" ]
      },
      {
        name: "custom3",
        label: "",
        ability: [ "agi", "con", "for", "per", "cha", "int", "vol" ]
      },
      {
        name: "custom4",
        label: "",
        ability: [ "agi", "con", "for", "per", "cha", "int", "vol" ]
      },
    ]
  },
  COINS: [
    "pp",
    "po",
    "pa",
    "pc",
  ],
  GEARPROPS: [
    "dm-1m",
    "dm-2m",
    "type-dm",
    "portee",
    "critique",
    "usure",
    "bonus-def",
    "armure",
    "armure-malus",
    "agi-max",
    "bouclier",
    "bouclier-malus",
    "casque",
    "casque-malus",
  ],
  COMPANIONS: [
    "def",
    "pv_max",
    "init",
    "pnjatk"
  ],
  GEARS: [
    {
      name: "Bâton",
      altname: "",
      props: [
        "dm-2m: 1d4",
        "type-dm: contondants",
      ]
    },
    {
      name: "Bâton ferré",
      altname: "",
      props: [
        "dm-2m: 1d6",
        "type-dm: contondants",
      ]
    },
    {
      name: "Dague",
      altname: "",
      props: [ 
        "dm-1m: 1d4",
        "type-dm: perforants",
        "lancer: 5"
      ]
    },
    {
      name: "Epée à deux mains",
      altname: "epee a 2 mains,epee 2m",
      props: [ 
        "dm-2m: 2d6",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Epée bâtarde",
      altname: "",
      props: [ 
        "dm-1m: 1d8",
        "dm-2m: 1d12",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Epée courte",
      altname: "",
      props: [ 
        "dm-1m: 1d6",
        "type-dm: perforants",
      ]
    },
    {
      name: "Epée longue",
      altname: "",
      props: [ 
        "dm-1m: 1d8",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Epieu",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "dm-2m: 1d10",
        "type-dm: perforants",
      ]
    },
    {
      name: "Fléau",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "type-dm: contondants",
      ]
    },
    {
      name: "Fléau à deux mains",
      altname: "fleau a 2m,fleau 2m",
      props: [
        "dm-2m: 1d10",
        "type-dm: contondants",
      ]
    },
    {
      name: "Gourdin",
      altname: "",
      props: [
        "dm-1m: 1d4",
        "type-dm: contondants",
      ]
    },
    {
      name: "Hache",
      altname: "",
      props: [
        "dm-1m: 1d8",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Hache à deux mains",
      altname: "hache a 2m,hache 2m",
      props: [
        "dm-2m: 2d6",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Lance",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "dm-2m: 1d10",
        "type-dm: perforants",
        "lancer: 10"
      ]
    },
    {
      name: "Lance de cavalerie",
      altname: "",
      props: [
        "dm-1m: 2d6",
        "type-dm: perforants",
      ]
    },
    {
      name: "Marteau",
      altname: "marteau de guerre",
      props: [
        "dm-1m: 1d6",
        "type-dm: contondants",
      ]
    },
    {
      name: "Masse",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "type-dm: contondants",
      ]
    },
    {
      name: "Pique",
      altname: "",
      props: [
        "dm-2m: 1d10",
        "type-dm: perforants",
      ]
    },
    {
      name: "Rapière",
      altname: "",
      props: [ 
        "critique: 19",
        "dm-1m: 1d6",
        "type-dm: perforants",
      ]
    },
    {
      name: "Stylet",
      altname: "",
      props: [ 
        "dm-1m: 1d3",
        "type-dm: perforants",
      ]
    },
    {
      name: "Vivelame",
      altname: "",
      props: [ 
        "critique: 19",
        "dm-2m: 1d10",
        "type-dm: tranchants",
      ]
    },
    {
      name: "Arbalète de poing",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "portee: 10",
        "type-dm: perforants",
      ]
    },
    {
      name: "Arbalète lègère",
      altname: "",
      props: [
        "dm-2m: 2d4",
        "portee: 30",
        "type-dm: perforants",
      ]
    },
    {
      name: "Arbalète lourde",
      altname: "",
      props: [
        "dm-2m: 2d6",
        "portee: 60",
        "type-dm: perforants",
      ]
    },
    {
      name: "Arc court",
      altname: "",
      props: [ 
        "dm-2m: 1d6",
        "portee: 30",
        "type-dm: perforants",
      ]
    },
    {
      name: "Arc long",
      altname: "",
      props: [ 
        "dm-2m: 1d8",
        "portee: 50",
        "type-dm: perforants",
      ]
    },
    {
      name: "Couteaux de lancer",
      altname: "",
      props: [ 
        "dm-1m: 1d4",
        "portee: 10",
        "type-dm: perforants",
      ]
    },
    {
      name: "Fronde",
      altname: "",
      props: [ 
        "dm-1m: 1d4",
        "portee: 20",
        "type-dm: contondants",
      ]
    },
    {
      name: "Hachette",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "portee: 5",
        "type-dm: perforants",
      ]
    },
    {
      name: "Javelot",
      altname: "",
      props: [
        "dm-1m: 1d6",
        "type-dm: perforants",
      ]
    },
    {
      name: "Lance-pierre",
      altname: "lance-pierres,lance pierre,lance pierres",
      props: [
        "dm-1m: 1d3",
        "type-dm: contondants",
      ]
    },
    {
      name: "Pétoire",
      altname: "",
      props: [
        "dm-1m: 1d10",
        "portee: 20",
        "type-dm: perforants",
      ]
    },
    {
      name: "Mousquet",
      altname: "",
      props: [
        "dm-2m: 2d6",
        "portee: 50",
        "type-dm: perforants",
      ]
    },
    {
      name: "Tissus matelassés",
      altname: "tissu matelasse",
      props: [
        "armure: +1",
        "agi-max: +7",
      ]
    },
    {
      name: "Fourrures",
      altname: "fourrure",
      props: [
        "armure: +1",
        "agi-max: +7",
      ]
    },
    {
      name: "Cuir simple",
      altname: "armure de cuir",
      props: [
        "armure: +2",
        "agi-max: +6",
      ]
    },
    {
      name: "Cuir renforcé",
      altname: "armure de cuir renforce",
      props: [
        "armure: +3",
        "agi-max: +5",
      ]
    },
    {
      name: "Chemise de mailles",
      altname: "",
      props: [
        "armure: +4",
        "agi-max: +4",
      ]
    },
    {
      name: "Cotte de mailles",
      altname: "",
      props: [
        "armure: +5",
        "agi-max: +3",
      ]
    },
    {
      name: "Armure de plaques",
      altname: "demi-plaque,demi plaque",
      props: [
        "armure: +6",
        "agi-max: +2",
      ]
    },
    {
      name: "Plaque complète",
      altname: "harnois",
      props: [
        "armure: +7",
        "agi-max: +1",
      ]
    },
    {
      name: "Petit bouclier",
      altname: "",
      props: [ 
        "bouclier: +1",
      ],
    },
    {
      name: "Grand bouclier",
      altname: "",
      props: [
        "bouclier: +2",
      ],
    },
  ],
  PVPATH: [
    { pv: 4, name: "artilleur", profile: "arquebusier",
      abilities: [ "mecanismes", "arme a repetition", "tir de barrage", "canon double", "couleuvrine" ] 
    },
    { pv: 4, name: "explosifs", profile: "arquebusier",
      abilities: [ "tir de grenaille", "demolition", "poudre puissante", "piege explosif", "boulet explosif" ]
     },
    { pv: 4, name: "mercenaire", profile: "arquebusier",
      abilities: [ "pilier de bar", "mort ou vif", "combattant aguerri", "constitution heroique", "combat de masse" ]
     },
    { pv: 4, name: "pistolero", profile: "arquebusier",
      abilities: [ "plus vite que son ombre", "ajuster le tir", "tir double", "agilite heroique", "as de la gachette" ]
     },
    { pv: 4, name: "precision", profile: "arquebusier",
      abilities: [ "joli coup", "defaut dans la cuirasse", "tir precis", "tireur d'elite", "tir fatal" ]
     },
    { pv: 4, name: "escrime", profile: "barde",
      abilities: [ "precision", "feinte", "intelligence du combat", "attaque flamboyante", "botte mortelle" ]
     }, 
    { pv: 4, name: "musicien", profile: "barde",
      abilities: [ "chant des heros", "chant de reconfort", "attaque sonore", "zone de silence", "danse irresistible" ]
     },
    { pv: 4, name: "saltimbanque", profile: "barde",
      abilities: [ "acrobate", "grace feline", "lanceur de couteau", "liberte d'action", "esquive acrobatique" ]
     },
    { pv: 4, name: "seduction", profile: "barde",
      abilities: [ "charmant", "dentelle et rapiere", "baratineur de genie", "charisme heroique", "suggestion" ]
     },
    { pv: 4, name: "vagabond", profile: "barde",
      abilities: [ "rumeurs et legendes", "eclectique", "attirail", "comprehension des langues", "deguisement" ]
     },
    { pv: 4, name: "archer", profile: "rodeur",
      abilities: [ "archer emerite", "tir chirurgical", "dans le mille", "tir rapide", "fleche de mort" ]
     },
    { pv: 4, name: "compagnon animal", profile: "rodeur",
      abilities: [ "le loup", "travail d'equipe", "lien empathique", "loup alpha", "tactique de meute" ]
     },
    { pv: 4, name: "survie", profile: "rodeur",
      abilities: [ "survie", "nature nourriciere", "grand pas", "constitution heroique", "increvable" ]
     },
    { pv: 4, name: "traqueur", profile: "rodeur",
      abilities: [ "eclaireur", "attaque eclair", "chasseur emerite", "perception heroique", "repli" ]
     },
    { pv: 4, name: "combat a deux armes", profile: "rodeur",
      abilities: [ "attaque a suivre", "parade croisee", "droite - gauche", "combattant heroique", "double peine" ]
     },
    { pv: 4, name: "assassin", profile: "voleur",
      abilities: [ "discretion", "attaque sournoise", "attaque par surprise", "disparition", "ouverture mortelle" ]
     },
    { pv: 4, name: "aventurier", profile: "voleur",
      abilities: [ "baratin", "provocation", "souplesse du felin", "charisme heroique", "attaque paralysante" ]
     },
    { pv: 4, name: "deplacement", profile: "voleur",
      abilities: [ "agile", "reflexes felins", "acrobaties", "agilite heroique", "esquive de la magie" ]
     },
    { pv: 4, name: "roublard", profile: "voleur",
      abilities: [ "doigts agiles", "aux aguets", "feindre la mort", "expert en criminalite", "maitre du poison" ]
     },
    { pv: 4, name: "spadassin", profile: "voleur",
      abilities: [ "attaque en finesse", "esquive fatale", "frappe chirurgicale", "ambidextrie", "botte secrete" ]
     },
    { pv: 5, name: "brute", profile: "barbare",
      abilities: [ "argument de taille", "tour de force", "attaque brutale", "force heroique", "briseur d'os" ]
     },
    { pv: 5, name: "pagne", profile: "barbare",
      abilities: [ "vigueur", "peau de pierre", "tatouages", "constitution heroique", "peau d'acier" ]
     },
    { pv: 5, name: "pourfendeur", profile: "barbare",
      abilities: [ "reflexes eclair", "charge", "enchainement", "dechainement d'acier", "attaque tourbillon" ]
     },
    { pv: 5, name: "primitif", profile: "barbare",
      abilities: [ "proche de la nature", "armure de vent", "vigilance", "resistance a la magie", "vitalite debordante" ]
     },
    { pv: 5, name: "rage", profile: "barbare",
      abilities: [ "cri de guerre", "defier la mort", "rage du berserk", "meme pas mal", "furie du berserk" ]
     },
    { pv: 5, name: "cavalier", profile: "chevalier",
      abilities: [ "fidele monture", "cavalier emerite", "charge", "monture magique", "monture fantastique" ]
     },
    { pv: 5, name: "guerre", profile: "chevalier",
      abilities: [ "armure sur mesure", "encaisser un coup", "frappe du justicier", "force heroique", "mon armure est une arme" ]
     },
    { pv: 5, name: "preux", profile: "chevalier",
      abilities: [ "ignorer la douleur", "piqures d'insectes", "laissez-le moi", "charisme heroique", "seul contre tous" ]
     },
    { pv: 5, name: "meneur d'homme", profile: "chevalier",
      abilities: [ "sans peur", "intercepter", "exemplaire", "charge fantastique", "ordre de bataille" ]
     },
    { pv: 5, name: "noblesse", profile: "chevalier",
      abilities: [ "eduquer", "ecuyer", "autorite naturelle", "massacrer la pietaille", "formation d'elite" ]
     },
    { pv: 5, name: "bouclier", profile: "guerrier",
      abilities: [ "proteger un allie", "parer un coup", "defense au bouclier", "absorber un sort", "renvoi de sort" ]
     },
    { pv: 5, name: "combat", profile: "guerrier",
      abilities: [ "vivacite", "manoeuvre", "attaque puissante", "double attaque", "attaque circulaire" ]
     },
    { pv: 5, name: "maitre d'armes", profile: "guerrier",
      abilities: [ "arme de predilection", "science du critique", "specialisation", "attaque parfaite", "riposte" ]
     },
    { pv: 5, name: "resistance", profile: "guerrier",
      abilities: [ "robustesse", "resilient", "armure lourde", "constitution heroique", "dur a cuire" ]
     },
    { pv: 5, name: "soldat", profile: "guerrier",
      abilities: [ "teigneux", "prouesse", "piqure de rappel", "force heroique", "rempart" ]
     },
    { pv: 3, name: "mage", profile: "ensorceleur,forgesort,magicien,sorcier",
      abilities: [ "occultisme", "maitrise de la magie", "tour de magie", "esprit superieur", "tempete de mana" ]
     },
    { pv: 3, name: "air", profile: "ensorceleur",
      abilities: [ "murmures dans le vent", "sous tensiion", "telekinesie", "foudre", "forme etheree" ]
     },
    { pv: 3, name: "divination", profile: "ensorceleur",
      abilities: [ "divination", "detection de l'invisible", "clairvoyance", "perception heroique", "prescience" ]
     },
    { pv: 3, name: "envouteur", profile: "ensorceleur",
      abilities: [ "injonction", "sommeil", "confusion", "amitie", "domination" ]
     },
    { pv: 3, name: "illusions", profile: "ensorceleur",
      abilities: [ "mirage", "image decalee", "sort illusoire", "imitation", "execution mentale" ]
     },
    { pv: 3, name: "invocation", profile: "ensorceleur",
      abilities: [ "choc", "serviteur invisible", "arme de mana", "porte dimensionnelle", "mur de mana" ]
     },
    { pv: 3, name: "artefacts", profile: "forgesort",
      abilities: [ "baton de mage", "ouverture - fermeture", "sac sans fond", "frappe des arcanes", "artefact etrange" ]
     },
    { pv: 3, name: "elixirs", profile: "forgesort",
      abilities: [ "fortifiant", "feu gregeois", "elixir de guerison", "elixirs mineurs", "elixirs majeurs" ]
     },
    { pv: 3, name: "metal", profile: "forgesort",
      abilities: [ "morsure de la forge", "metal brulant", "magnetisme", "metal hurlant", "endurant" ]
     },
    { pv: 3, name: "golem", profile: "forgesort",
      abilities: [ "grosse tete", "golem", "protecteur", "statuette", "golem superieur" ]
     },
    { pv: 3, name: "runes", profile: "forgesort",
      abilities: [ "runes de defense", "rune de puissance", "rune de protection", "rune d'energie", "rune de garde" ]
     },
    { pv: 3, name: "arcanes exhumes", profile: "ensorceleur,forgesort,magicien,sorcier",
      abilities: [ "message magique", "toiles", "sphere de tenebres", "chien de garde", "nuage empoisonne" ]
     },
    { pv: 3, name: "arcanes oublies", profile: "ensorceleur,forgesort,magicien,sorcier",
      abilities: [ "ventriloquie", "bouclier de mana", "corde magique", "retrecissement", "zone de magie nulle" ]
     },
    { pv: 3, name: "arcanes perdus", profile: "ensorceleur,forgesort,magicien,sorcier",
      abilities: [ "disque de transport", "fuite rapide", "agrandissement", "inversion de la gravite", "metamorphose" ]
     },
    { pv: 3, name: "magie des arcanes", profile: "magicien",
      abilities: [ "projectile de mana", "levitation", "forme gazeuse", "acceleration", "desintegration" ]
     },
    { pv: 3, name: "magie destructrice", profile: "magicien",
      abilities: [ "arc de feu", "saper les forces", "fleche de feu", "explosion de feu", "appel de la foudre" ]
     },
    { pv: 3, name: "magie elementaire", profile: "magicien",
      abilities: [ "asphyxie", "maitrise des elements", "arme elementaire", "respiration aquatique", "armure de pierre" ]
     },
    { pv: 3, name: "magie protectrice", profile: "magicien",
      abilities: [ "armure de mana", "chute ralentie", "dephasage", "cercle de protection", "interruption du temps" ]
     },
    { pv: 3, name: "magie universelle", profile: "magicien",
      abilities: [ "lumiere", "familier", "invisibilite", "vol", "teleportation" ]
     },
    { pv: 3, name: "demon", profile: "sorcier",
      abilities: [ "malediction", "beaute de la succube", "pacte demoniaque", "aspect du demon", "invocation d'un demon" ]
     },
    { pv: 3, name: "mort", profile: "sorcier",
      abilities: [ "siphon des ames", "masque mortuaire", "baiser du vampire", "peur", "briser les coeurs" ]
     },
    { pv: 3, name: "outre-tombe", profile: "sorcier",
      abilities: [ "un pied dans la tombe", "armure d'os", "animation des morts", "ensevelissement", "armee des morts" ]
     },
    { pv: 3, name: "sang", profile: "sorcier",
      abilities: [ "saignements", "sang mordant", "exsangue", "rituel de sang", "lien de sang" ]
     },
    { pv: 3, name: "sombre magie", profile: "sorcier",
      abilities: [ "tenebres", "reptation", "strangulation", "manteau d'ombre", "pacte tenebreux" ]
     },
    { pv: 3, name: "arcanes obscurs", profile: "sorcier",
      abilities: [ "contact vampirique", "tentation du demon", "epidemie", "aura maudite", "extinction de masse" ]
     },
    { pv: 4, name: "animaux", profile: "druide",
      abilities: [ "langage des animaux", "petit compagnon", "nuee d'insectes", "masque du predateur", "forme animale" ]
     },
    { pv: 4, name: "fauve", profile: "druide",
      abilities: [ "vitesse du felin", "panthere", "attaque bondissante", "grand felin", "les sept vies du chat" ]
     },
    { pv: 4, name: "nature", profile: "druide",
      abilities: [ "maitre de la survie", "terrains difficiles", "baton de druide", "constitution heroique", "resistant" ]
     },
    { pv: 4, name: "protecteur", profile: "druide",
      abilities: [ "baies magiques", "foret vivante", "regeneration", "perception heroique", "forme d'arbre" ]
     },
    { pv: 4, name: "vegetaux", profile: "druide",
      abilities: [ "peau d'ecorce", "prison vegetale", "fleche vivante", "animation d'un arbre", "porte vegetale" ]
     },
    { pv: 4, name: "energie vitale", profile: "moine",
      abilities: [ "mains d'energie", "projection du ki", "invulnerable", "pression mortelle", "ascetisme" ]
     },
    { pv: 4, name: "maitrise", profile: "moine",
      abilities: [ "agilite du singe", "griffes du tigre", "morsure du serpent", "fureur du dragon", "moment de perfection" ]
     },
    { pv: 4, name: "meditation", profile: "moine",
      abilities: [ "pacifisme", "transe de guerison", "matrise du ki", "volonte heroique", "projection mentale" ]
     },
    { pv: 4, name: "poing", profile: "moine",
      abilities: [ "poings de fer", "peau de fer", "parade de projectiles", "deluge de coups", "puissance du ki" ]
     },
    { pv: 4, name: "vent", profile: "moine",
      abilities: [ "pas du vent", "course du vent", "course des airs", "agilite heroique", "passe-muraille" ]
     },
    { pv: 4, name: "foi", profile: "pretre",
      abilities: [ "predicateur", "miracle mineur", "arme de lumiere", "ailes celestes", "foudres divines" ]
     },
    { pv: 4, name: "guerre sainte", profile: "pretre",
      abilities: [ "arme benie", "bouclier de la foi", "chatiment divin", "marteau de la foi", "mot de pouvoir" ]
     },
    { pv: 4, name: "priere", profile: "pretre",
      abilities: [ "benediction", "sanctuaire", "destruction du mal", "volonte heroique", "intervention divine" ]
     },
    { pv: 4, name: "soins", profile: "pretre",
      abilities: [ "recuperation mineure", "vigueur divine", "recuperation majeure", "phenix", "retablissement" ]
     },
    { pv: 4, name: "spiritualite", profile: "pretre",
      abilities: [ "vetements sacres", "augure", "delivrance", "charisme heroique", "marche des plans" ]
     },
    { pv: 4, name: "corruption", profile: "pretre",
      abilities: [ "blessure mineure", "poison", "blessure majeure", "vengeance", "epidemie" ]
     },
  ],
  HERITAGE: [
    {
      name: [ "demi orc", "demi-orc", "demie orque", "demie-orque" ],
      abilities: [ "impressionnant", "talent pour la violence", "critique brutal", "attaque sanglante", "colosse" ]
    },
    {
      name: [ "elfe haut", "haut elfe", "haut-elfe" ],
      abilities: [ "lumiere interieure", "force d'ame", "talent pour la magie", "immortel", "superiorite elfique" ]
    },
    {
      name: [ "elfe sylvain", "elfe sylvaine", "elfe sylvestre", "elfe des bois" ],
      abilities: [ "lumiere des etoiles", "enfant de la foret", "archer emerite", "fleche sanglante", "superiorite elfique" ]
    },
    {
      name: [ "gnome" ],
      abilities: [ "don etrange", "petit pote", "insignifiant", "merveille technologique", "bonne nature" ]
    },
    {
      name: [ "halfelin", "halfeline" ],
      abilities: [ "petite taille", "resistance legendaire", "bon pour le moral", "petit veinard", "vif et bien nourri" ]
    },
    {
      name: [ "humain", "humaine" ],
      abilities: [ "diversite", "instinct de survie", "touche-a-tout", "loup parmi les loups", "polyvalence" ]
    },
    {
      name: [ "nain", "naine" ],
      abilities: [ "habitant des tunnels", "haches et marteaux", "resistance a la magie", "fils du roc", "tenacite" ]
    }
  ],
  ATTACKS: {
    CF: [
      "se blesse lui-même (DM / 2)",
      "blesse un-e allié-e à portée (DM / 2)",
      "laisse tomber son arme au sol (action (A) pour la ramasser)",
      "endommage son arme (DM -1, jusqu'à la fin du combat si magique)",
      "endommage son armure (DEF -1, jusqu'à la fin du combat si magique)",
      "se tord la cheville (mouvement / 2 jusqu'à la fin du combat)",
      "trébuche et subit l'état préjudiciable *renversé*",
      "donne une ouverture à l'adversaire (attaque au contact gratuite)",
    ],
    CS: {
      tranchants: [
        "",
        "*Brise-bouclier* : le bouclier de la cible est brisé ou arraché.",
        "*Brise-armure* : l'armure de la cible perd [[2]] en DEF.",
        "*Brise-arme* : l'arme de la cible est brisée ou elle subit +[[1d6]] DM.",
        "*Entaille profonde* : +[[3]] DM",
        "*Entaille sévère* : +[[5]] DM",
        "*Entaille sanglante* : +[[5]] DM, *hémorragie* [[1]]",
        "*Entaille profonde* : +[[7]] DM, *hémorragie* [[1]]",
        "*Coup puissant* aux membres supérieurs : +[[3]] DM, *CON diff. 10* pour ne pas lâcher l'arme.",
        "*Tendon entaillé* : *dé malus* aux actions des membres supérieurs de la cible.",
        "*Coup puissant* aux membres inférieurs : *invalide*, *FOR diff. 15* ou la cible est *renversée*.",
        "*Large plaie* à un membre supérieur : *CON diff. 13* ou le membre de la cible n'est plus utilisable.",
        "*Coup puissant* à la poitrine : +[[6]] DM et *CON diff. 13* ou la cible est *ralentie*.",
        "*Plaie béante* à la poitrine : +[[6]] DM et *CON diff. 13* ou la cible est *affaiblie*.",
        "*Coup puissant * à la poitrine : +[[6]] DM, la cible est *étourdie* [[1]] round.",
        "*Coup terrible* aux membres inférieurs : le sang gicle à gros bouillons, +[[8]] DM, la cible est *invalide*, *hémorragie* [[2]].",
        "*Éventration* : la cible doit ramasser ses entrailles dans un flot de sang. +[[10]] DM, *hémorragie* [[3]], *étourdie* [[1]] round.",
        "*Coup à la gorge* : la cible est muette et saigne à gros bouillon, *hémorragie* [[5]], +[[15]] DM.",
        "*Membre tranché* : le membre est inutilisable pour le reste du combat (tranché dans le cas d’un PNJ).",
        "*Décapitation* : *CON diff. 15* ou la cible perd la tête dans une gerbe de sang. Gore !",
      ],
      perforants: [
        "",
        "*Coup précis* : piqûre à la main. Une arme ou un bouclier est lâché.",
        "*Point faible* : vous avez repéré le point faible, la cible perd [[1]] en DEF contre vos attaques.",
        "*Épinglé* : la cible est clouée au sol ou au mur, elle est *immobilisée* jusqu'à la fin de son prochain tour.",
        "*Perforation profonde* : +[[2]] DM",
        "*Perforation interne* : +[[2]] DM, *hémorragie* [[1]]",
        "*Perforation sanglante* : +[[3]] DM, *hémorragie* [[2]]",
        "*Perforation sanglante* : +[[5]] DM, *hémorragie* [[2]]",
        "*Coup profond* aux membres supérieurs : +[[2]] DM, *CON diff. 12* pour ne pas lâcher l'arme.",
        "*Muscle perforé* : *dé malus* aux actions des membres supérieurs de la cible, *hémorragie* [[1]].",
        "*Coup précis* aux membres inférieurs : *invalide*, *hémorragie* [[1]], *FOR diff. 10* ou la cible est *renversée*.",
        "*Plaie profonde* à un membre supérieur : *CON diff. 10* ou le membre de la cible n'est plus utilisable.",
        "*Blessure profonde* à la poitrine : +[[3]] DM et *CON diff. 13* ou la cible est *ralentie*.",
        "*Perforation profonde* à la poitrine : +[[3]] DM et *CON diff. 13* ou la cible est *affaiblie*.",
        "*Blessure profonde * à la poitrine : +[[3]] DM, *hémorragie* [[1]], la cible est *étourdie* [[1]] round.",
        "*Empalé* : +[[6]] DM, *hémorragie* [[3]]. Arme de trait : cible *affaiblie* tant que l'arme n'est pas retirée (action (A), [[1d6]] DM).",
        "*Embroché* : le coup d'une précision diabolique vise le coeur, +[[10]] DM, *hémorragie* [[4]], cible *étourdie* [[1]] round",
        "*Dans le mille* : attaque vicieuse au cerveau en passant par les yeux. +[[12]] DM, *CON diff. 10* ou *inconscient*, cible *aveuglée*.",
        "*Poumon perforé* : cible *ralentie*.",
        "*En plein coeur* : *CON diff. 15* ou la cible meurt dans un hoquet de surprise. Net et sans bavure.",
      ],
      contondants: [
        "",
        "*Brise-bouclier* : le bouclier de la cible est brisé ou arraché.",
        "*Brise-armure* : l'armure de la cible perd [[3]] en DEF.",
        "*Assommée* : la cible est frappée à la tête, *étourdie* jusqu'à la fin de son prochain tour.",
        "*Choc puissant* : la cible recule de 3 m dans une direction au choix de l'attaquant.",
        "*Hématome douloureux* : +[[1]] DM, *-1* aux actions de la cible",
        "*Hématome très douloureux* : +[[2]] DM, *-2* aux actions de la cible",
        "*Hématome très douloureux* : +[[3]] DM, *-2* aux actions de la cible",
        "*Coup violent* aux membres supérieurs : +[[1]] DM, *CON diff. 15* ou la cible lâche son arme.",
        "*Articulation luxée* : *dé malus* aux actions des membres supérieurs de la cible.",
        "*Coup violent* aux membres inférieurs : *invalide*, *FOR diff. 20* ou la cible est *renversée*.",
        "*Os brisé* à un membre supérieur : *CON diff. 15* ou le membre de la cible n'est plus utilisable.",
        "*Coup violent* à la poitrine : *CON diff. 15* ou la cible est *ralentie*.",
        "*Coup violent* à la poitrine : *CON diff. 15* ou la cible est *affaiblie*.",
        "*Coup violent* à la poitrine : la cible est *étourdie* [[2]] rounds.",
        "*Coup phénoménal* aux membres inférieurs : +[[10]] DM, la cible effectue une pirouette et arrive en vrac, elle est *renversée* et *invalide*.",
        "*Coup destructeur* à la cage thoracique : +[[5]] DM, la cible s'effondre net dans un craquement de mauvais augure. Elle est *renversée*, *étourdie* [[1]] round et *affaiblie*.",
        "*Sbrotch* : la tête amorce une spirale infernale bientôt imitée par tout le corps. +[[20]] DM, *CON diff. 10* ou *inconscient*.",
        "*KO !* : Coup brutal à la poitrine, souffle coupé. La cible est *renversée* et *étourdie* pendant [[1]] round, puis *immobilisée* pour [[3]] rounds.",
        "*Coup du lapin* : *FOR diff. 15* ou les cervicales cassent dans un craquement sinistre. Mort sur le coup.",
      ]
    }
  }
}

// =================
// UTILITY FUNCTIONS
// =================

/**
 * Async/Await functions
 * https://github.com/onyxring/orcsAsync/blob/master/orcsAsync.min.js
 */
function isRunningOnServer() { return self.dispatchEvent == undefined; }
function setActiveCharacterId(charId){
    var oldAcid=getActiveCharacterId();
    var msg={"id":"0", "type":"setActiveCharacter", "data":charId};
    
    if(isRunningOnServer()==false){ //if in a browser, use "dispatchEvent" to process the message
        var ev = new CustomEvent("message");
        ev.data=msg; 
        self.dispatchEvent(ev);
    }else{ //otherwise, use the API (server) message processor, "onmessage"
        self.onmessage({data:msg});
    }
    return oldAcid; //return what the value used to be, so calling code can be a little cleaner 
} 
var _sIn=setInterval;
setInterval=function(callback, timeout){
    var acid=getActiveCharacterId();
    _sIn(
        function(){
            var prevAcid=setActiveCharacterId(acid);
            callback();
            setActiveCharacterId(prevAcid);
        }
    ,timeout);
}
var _sto=setTimeout
setTimeout=function(callback, timeout){
    var acid=getActiveCharacterId();
    _sto(
        function(){
            var prevAcid=setActiveCharacterId(acid);
            callback();
            setActiveCharacterId(prevAcid);
        }
    ,timeout);
}
async function getAttrsAsync(props){
    var acid=getActiveCharacterId(); //save the current activeCharacterID in case it has changed when the promise runs 
    var prevAcid=null;               //local variable defined here, because it needs to be shared across the promise callbacks defined below
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  //in case the activeCharacterId has changed, restore it to what we were expecting and save the current value to restore later
            try{
                getAttrs(props,(values)=>{  resolve(values); }); 
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); //restore activeCharcterId to what it was when the promise first ran
    });
}
//use the same pattern for each of the following...
async function setAttrsAsync(propObj, options){
    var acid=getActiveCharacterId(); 
    var prevAcid=null;               
    return new Promise((resolve,reject)=>{
            prevAcid=setActiveCharacterId(acid);  
            try{
                setAttrs(propObj,options,(values)=>{ resolve(values); });
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); 
    });
}

async function getSectionIDsAsync(sectionName){
    var acid = getActiveCharacterId(); 
    var prevAcid=null;               
    return new Promise((resolve,reject)=>{
            prevAcid = setActiveCharacterId(acid);  
            try{
                getSectionIDs(sectionName,(values)=>{ resolve(values); });
            }
            catch{ reject(); }
    }).finally(()=>{
        setActiveCharacterId(prevAcid); 
    });
}

/**
* Convert to integer
* @param {string} value - value to cast
* @param {number} onError - default value on error
* @returns {number}
*/
function intval(value, onError = 0) {
  return parseInt(value) || onError;
}

/**
 * Convert 0/1 value to boolean
 * @param {string} value - value
 * @returns {boolean}
 */
function boolval(value) {
  return (intval(value) === 1);
}

/**
* Convert to float
* @param {string} value - value to cast
* @param {float} onError - default value on error
* @returns float value
*/
function numval(value, onError = 0) {
  return parseFloat(value) || onError;
}


/**
* Get string or empty value
* @param {string} value - value to cast
* @param {string} onError - default value on null/undefined
* @returns string value
*/
function strval(value, onError = "") {
  return value || onError;
}

/**
 * Get object from serialized JSON
 * @param {string} value - stringified JSON value
 * @param {object} onError - default value on parse error
 * @returns {object}
 */
function objval(value, onError = {}) {
  try {
    return JSON.parse(value);
  } catch (e) {
    return onError;
  }
}

/**
 * Capitalize string
 * @param {string} s - string to capitalize
 * @param {boolean} [forceLower=true] - force lower to end of string
 * @returns {string}
*/
function capitalize(s, forceLower = true) {
  if (s && s !== "")
    return s.charAt(0).toUpperCase() + (forceLower ? s.substring(1).toLowerCase() : s.substring(1));
}

/**
 * Convert camelCase string to kebab-case
 * @param {string} s - string to kebabize
 * @returns {string}
 */
function toKebabCase(s) {
    return s.replace(/([a-z])([A-Z])/g, "$1-$2").toLowerCase();
}

/**
 * Return stat short name
 * @param {string} stat - stat name
 * @returns {string}
 */
function shorten(stat) {
  return stat.substring(0, 3);
}

/**
 * Return stat upper short name
 * @param {string} stat - stat name
 * @returns {string}
 */
function upperShort(stat) {
  return shorten(stat).toUpperCase();
}

/**
 * Log to JS console with color & style
 * @param {any}     data - data to log
 * @param {object}  options - console display options
 * @param {string}  options.title - title of logged data
 * @param {boolean} options.debug - display only if debug_mode attribute enabled
 * @param {string}  options.color - color name for log line
 * @param {string}  options.style - CSS style for log line
 * @param {string}  options.headerStyle - CSS style for log title
*/
function clog(data, options = {}) {
  let { 
    title = "",
    debug = true,
    textColor = "orange",
    backColor = "",
    style = "font-size:12px; font-weight:normal;",
    headerStyle = "font-size:13px; font-weight:bold;"
  } = options;

  if (debug && !SWData.settings.debugMode)
    return;

  title = strval(title);
  if (title !== "") title = ` Sheet-Worker > ${title} `;
  const titleStyle = `color:${textColor}; background-color:${backColor}; ${headerStyle} text-decoration:underline;`;
  const textStyle = `color:${textColor}; background-color:${backColor}; ${style}`;

  if (title) {
    if (typeof data === "object") {
      const output = `%c${title}`;
      console.log(output, titleStyle, data);
    } else {
      const output = `%c${title} %c${data}`;
      console.log(output, titleStyle, textStyle);
    }
  } else {
    if (typeof data === "object") {
      console.log(data);
    } else {
      const output = `%c${data}`;
      console.log(output, textStyle);
    }
  }
}

/**
 * Return title for event log
 * @param {object} eventInfo - Roll20 eventInfo object
 * @returns {string}
 */
function logTitle(eventInfo) {
  return `CHANGE:${ strval(eventInfo.triggerName) }`;
}

/**
 * Log and set attributes data
 * @param {object} data - attributes name/value pairs
 * @param {string} [title=""] - title for the JS console log
 */
function logAndSet(data, title = "") {
  clog(data, { title, textColor: "white", backColor: "brown" });
  setAttrs(data);
}

/**
* Generate a random number between 1 and max
* @param {integer} max - Upper bound of range
* @returns {integer} Generated random number
*/
function getRandom(max) {
  max = Math.floor(max);
  return Math.floor(Math.random() * max) + 1;
}

/**
* Parse a chunk of data into name & value
* @param {string} data - chunk of data to parse
* @param {string} [delim=":"] - delimiter, defaults to ":"
* @returns an object with name and value properties
*/
function parseNameValue(data, delim = ":") {
  if (data === "" || data.trim().startsWith("//"))
    return { name: "", value: "" };

  delim = strval(delim, ":");
  let name = "", value = "";
  if (data.indexOf(delim) !== -1) {
    [ name, value ] = data.split(delim);
    name = strval(name).trim();
    value = strval(value).trim();
  }
  return { name, value };
}

/**
 * Clean text from non printable characters
 * @param {string} text - text to clean
 * @param {boolean} stripSurrogatesAndFormats - clean more
 * @returns {string}
 * @see https://stackoverflow.com/questions/11598786/how-to-replace-non-printable-unicode-characters-javascript
 */
function stripNonPrintable(text, stripSurrogatesAndFormats) {
    // strip control chars. optionally, keep surrogates and formats
    if(stripSurrogatesAndFormats) {
      text = text.replace(/\p{C}/gu, '');
    } else {
      text = text.replace(/\p{Cc}/gu, '');
      text = text.replace(/\p{Co}/gu, '');
      text = text.replace(/\p{Cn}/gu, '');
    }

    // other common tasks are to normalize newlines and other whitespace

    // normalize newline
    text = text.replace(/\n\r/g, '\n');
    text = text.replace(/\p{Zl}/gu, '\n');
    text = text.replace(/\p{Zp}/gu, '\n');

    // normalize space
    text = text.replace(/\p{Zs}/gu, ' ');

    return text;
}

/**
 * Clean-up text
 * @param {string} t - text to cleanup (multiple spaces & accents)
 * @param {boolean} [clearTags=true] - also remove COF2 tags (action types & spells)
 * @returns {string}
 */
function cleanText(t, clearTags = true) {
  t = strval(t).toLowerCase();
  t = t.replace(/\s\s+/g,   " ");
  t = t.replace(/[àâä]/g,   "a");
  t = t.replace(/[éèêë]/g,  "e");
  t = t.replace(/[îï]/g,    "i");
  t = t.replace(/[ôö]/g,    "o");
  t = t.replace(/[ùûü]/g,   "u");
  t = t.replace(/ÿ/g,       "y");
  t = t.replace(/ç/g,       "c");
  t = t.replace(/œ/g,       "oe");
  t = t.replace(/æ/g,       "ae");
  t = t.replace(/’/g,       "'");
  if (clearTags) {
    t = t.replace(/\(g\)/,  "");
    t = t.replace(/\(m\)/,  "");
    t = t.replace(/\(a\)/,  "");
    t = t.replace(/\(l\)/,  "");
    t = t.replace(/\(e\)/,  "");
    t = t.replace(/\*/,     "");
  }
  return t.trim();
}

/**
 * Return if a property exists
 * @param {string} data - list of properties separated by \n
 * @param {string} propName - property name to search
 * @returns {boolean}
 */
function hasProp(data, propName) {
  const props = data.split("\n").reduce((props, prop) => {
    if (prop.trim() !== "") {
      const { name } = parseNameValue(prop);
      if (name)
        props.push(name);
    }
    return props;
  }, []);
  return props.includes(propName);
}

/**
 * Get a property value
 * @param {string} data - list of properties separated by \n 
 * @param {string} name - property name
 * @returns {boolean|string}
 */
function getProp(data, propName) {
  let propValue = undefined;
  data.split("\n").forEach(prop => {
    if (prop.trim() === "")
      return;
    let { name, value } = parseNameValue(prop);
    if (!name) {
      ({ name, value } = parseNameValue(prop.trim() + ":"));
      if (name)
        value = true;
    }
    if (name && name === propName) {
      propValue = value;
    }
  });
  return propValue;
}

/**
 * Find the index of an attack modifier in a list
 * @param {string[]} mods - list of attack modifiers
 * @param {string} modName - name of modifier to find
 * @returns {number}
 */
function findAtkMod(mods, modName) {
  return mods.findIndex(mod => mod.startsWith(modName));
}

/**
 * Check if an attack modifier is set
 * @param {string[]} mods - list of attack modifiers
 * @param {string} modName - name of modifier to check
 * @returns {boolean}
 */
function hasAtkMod(mods, modName) {
  return findAtkMod(mods, modName) !== -1;
}

/**
 * Get an attack modifier value
 * @param {string[]} mods - comma-delimited list of attack modifiers
 * @param {string} modName - name of modifier to check
 * @returns {string}
 */
function getAtkMod(mods, modName) {
  const ix = findAtkMod(mods, modName);
  if (ix === -1)
    return "";
  return strval(mods[ix]).replace(modName, "").replace(/[:=]/g, "").trim();
}

/**
 * Return a sequence of numbers as an array
 * @param {number} count - Length of the sequence
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {number[]}
 */
function seq(count, base = 1) {
  return [ ...Array(count).keys() ].map(i => i += base);
}

/**
 * Return a sequence of names
 * @param {number} count - Length of the sequence
 * @param {string} name - Name template (with # placeholder to insert the sequence)
 * @param {number} base - Base number for the sequence (default 1)
 * @returns {string[]}
 */
function nameSeq(count, name, base = 1) {
  const [ prepend, append ] = name.split("#");
  return seq(count, base).map(s => `${prepend || ""}${s}${append || ""}`)
}

/**
 * Return 9 paths x 5 ranks ability attributes names
 * @param {string} attr - attribute name from abilityInfo() object
 * @returns {string[]}
 */
function allPathRanks(attr) {
  const all = [];
  const template = abilityInfo()[attr];
  if (template) {
    const [ start, middle, end ] = template.split("#").map(v => strval(v));
    seq(9).forEach(p => {
      seq(5).forEach(r => {
        all.push(`${start}${p}${middle}${r}${end}`);
      });
    });
  }
  return all;
}

/**
 * Return a list of event as array or as string
 * @param {string} eventName - Name of the event
 * @param {string[]} attributeList - List of attributes
 * @param {string} [joinChar=""] - Character to use for items concatenation
 * @returns {string[]|string}
 */
function eventList(eventName, attributeList, joinChar = "") {
  const result = attributeList.map(a => `${eventName}:${ a.toLowerCase() }`);
  return joinChar !== "" ? result.join(joinChar) : result;
}

/**
 * Return a list of change: events as string
 * @param {string[]} attributeList - List of attributes
 * @param {string} [section=""] - Repeating section name
 * @returns {string}
 */
function changeEvent(attributeList, section = "") {
  if (section !== "")
    attributeList = attributeList.map(attr => `repeating_${section}:${attr}`);
  return eventList("change", attributeList, " ");
}

/**
 * Return repeating attribute name
 * @param {string} section - section name
 * @param {string} name - attribute name
 * @param {string} [id=""] - row Id
 * @returns {string}
 */
function rptAttr(section, name, id = "") {
  return Repeating.getName(section, name, id);
}

/**
 * Return repeating attributes list
 * @param {string} section - section name
 * @param {string[]} names - list of attribute names
 * @param {string} [id=""] - rowId
 * @returns {string[]}
 */
function rptAttrs(section, names, id = "") {
  return names.map(a => rptAttr(section, a, id));
}

/**
 * Return repeating attribute information
 * @param {string} fullRepeatName - fully qualified repeating attribute name
 * @returns { { section: string, rowId: string, attribute: string } }
 */ 
function rptInfo(fullRepeatName) {
  let section = "", rowId = "", attribute = "";
  if (strval(fullRepeatName) !== "")
    [ section, rowId, attribute ] = fullRepeatName.split("_").slice(1).map(v => strval(v));
  return { section, rowId, attribute };
}

/**
 * @typedef {(repeatingRowId: string) => void} removeRepeatingRow
 */

/**
* Remove all rows for a repeating section
* @param {string} sectionName repeating section to clear
*/
function removeRepeatingAll(sectionName) {
  getSectionIDs(sectionName, function (rowIds) {
    rowIds.forEach(rowId => {
      removeRepeatingRow(`repeating_${sectionName}_${rowId}`);
    });
  });
}

/**
 * Process repeating section rows in order
 * @param {string} sectionName - repeating section to process
 * @param {object} callback - callback function
 */
function getSectionIDsOrdered(sectionName, callback) {
  getAttrs([`_reporder_${sectionName}`], function (v) {
    getSectionIDs(sectionName, function (idArray) {
      let reporderArray = v[`_reporder_${sectionName}`] ? v[`_reporder_${sectionName}`].toLowerCase().split(',') : [],
        ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
      callback(ids);
    });
  });
}

/**
 * Return ordered array of row ids for a repeating section
 * @param {string} sectionName - repeating section name (repeating_ prefix optional)
 * @returns string[]
 */
async function getSectionIDsOrderedAsync(sectionName) {
  if (!sectionName.startsWith("repeating_"))
    sectionName = "repeating_" + sectionName;
  const values = await getAttrsAsync([`_reporder_${sectionName}`]);
  const idArray = await getSectionIDsAsync(sectionName);
  const reporderArray = values[`_reporder_${sectionName}`] ? values[`_reporder_${sectionName}`].toLowerCase().split(',') : [];
  return [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
}

class Repeating {

  /**
   * @param {string} section - repeating section name
   * @param {string[]} list - list of attribute names
   * @param {string} prefix - prefix for full attribute names
   */
  constructor(section, list, prefix = "") {
    this.section = section;
    this.prefix = prefix;
    this.data = new Map(list.map(attribute => [attribute, `repeating_${section}_${prefix}${attribute}`]));
  }

  /**
   * Return repeating attribute name
   * @param {string} section - section name
   * @param {string} name - attribute name
   * @param {string} [id=""] - row Id
   * @returns {string}
   */
  static getName(section, name, id = "") {
    const repeat = [ "repeating", strval(section), strval(name) ];
    if (strval(id) !== "")
      repeat.splice(2, 0, id);
    return repeat.join("_");
  }
  /**
   * Get fully qualified attribute name
   * @param {string} name - attribute name
   * @returns {string}
   */
  attribute(name) {
    return this.data.get(name);
  }

  /**
   * Get all qualified attribute names
   * @returns {string[]}
   */
  attributes() {
    return this.data.values().toArray();
  }

  /**
   * Return attribute value
   * @param {string} name - attribute name
   * @param {object} values - Roll20 getAttrs() object
   * @returns {string}
   */
  value(name, values) {
    return values[this.attribute(name)] || "";
  }
}

/**
 * @typedef MsgOptions
 * @property {string}   title           - Title of the message
 * @property {string}   template        - Name of roll template
 * @property {string}   whisper         - Target for whispered message 
 * @property {number}   rollTN          - Target number for special roll effect
 * @property {boolean}  critical        - Use critical effect
 * @property {integer}  crit            - Critical value threshold
 * @property {boolean}  fumble          - Use fumble effect
 * @property {object}   usure           - Has usure effects
 * @property {string}   usure.attackId  - Row id of repeating attack item
 * @property {string}   usure.name      - Weapon name
 * @property {integer}  usure.value     - Current usure value
 * @property {string}   nextRoll        - Next chat roll command
 */

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {MsgOptions} options - Options for the message
 */
function buildChatMsg(msg, options) {
  options = { ...SWData.RT_OPTIONS, ...options };
  let { title = "", template = "default", whisper = "@{togm}" } = options;
  if (whisper.charAt(0) !== "@" && whisper !== "") 
    whisper = "/w \"" + whisper + "\" ";
  let chatMsg;
  if (Array.isArray(msg)) {
    chatMsg = msg.map(t => `{{${t}}}`).join(" ");
  } else {
    chatMsg = "{{" + msg + "}}";
  }
  chatMsg += " @{token_dsp}";
  if (template !== "")
    return `${whisper}&{template:${template}} ${title ? (template === "default" ? `{{name=${title} }}` : `{{${title} }}`) : "" } ${chatMsg}`;
  else
    return msg;
}

/**
 * Return min or max die based on expression
 * @param {object} roll - Roll20 roll results object
 * @returns {number}
 */
function diceRoll(roll) {
  let min = 0;
  let max = 0;
  if (roll.dice.length > 1) {
    min = Math.min(...roll.dice);
    max = Math.max(...roll.dice);
  } else {
    max = roll.dice[0];
  }
  if (roll.expression && roll.expression.includes("2d20kl1"))
    return min;
  return max;
}

/**
 * Send a command to Roll20 chat
 * @param {string} chatCmd - command to send to chat
 */
function sendChatCmd(chatCmd) {
  startRoll(chatCmd, roll => {
    if (chatCmd.startsWith("!"))
      console.log(chatCmd);
    finishRoll(roll.rollId);
  });
}

/**
 * Send a message to chat
 * @param {string|string[]} msg - Message to send
 * @param {MsgOptions} options - Options for the message
 */
function sendChatMsg(msg, options) {
  options = { ...SWData.RT_OPTIONS, ...options };
  const chatCmd = buildChatMsg(msg, options);
  startRoll(chatCmd, roll => {

    const updates = new Map();
    const computed = {};

    let save = 1;
    if (roll.results.save) 
      save = roll.results.save.result;
    let last_rolls = "";
    if (roll.results.roll)
      last_rolls += roll.results.roll.result;
      
    if (roll.results.broll)
      last_rolls += "|" + roll.results.broll.result;

    if (last_rolls !== "" && save)
      updates.set("last_rolls", last_rolls);

    if (roll.results.roll) {
      const rx = "\\[(" + SWData.PC.COMBAT.maneuvers.map(mn => mn.name.split(" ")[0]).join("|") + ")\\]\\)";
      const matched = roll.results.roll.expression.match(rx);
      if (matched)
        updates.set("last_maneuver", `${ cleanText(matched[1]) }~${roll.rollId}`); // make it unique
    }

    // check TN
    const rollTN = intval(options.rollTN);
    if (rollTN > 0) {
      const rollD20 = diceRoll(roll.results.roll);
      if (rollD20 >= rollTN)
        computed.rollf = 1;
      if (!computed.rollf && roll.results.broll) {
        const brollD20 = diceRoll(roll.results.broll);
        if (brollD20 >= rollTN)
          computed.brollf = 1;
      }
    }

    // check crit success
    if (options.critical) {
      const rollD20 = diceRoll(roll.results.roll);
      if (rollD20 >= options.crit)
        computed.critsuccess = 1;
      if (!computed.critsuccess && roll.results.broll) {
        const brollD20 = diceRoll(roll.results.broll);
        if (brollD20 >= options.crit)
          computed.bcritsuccess = 1;
      }
    }

    // check crit failure
    if (options.fumble) {
      const rollCar = diceRoll(roll.results.fumbletest);
      if (rollCar < 10) {
        const rollD20 = diceRoll(roll.results.roll);
        if (rollD20 === 1)
          computed.critfail = 1;
        if (!computed.critfail && roll.results.broll) {
          const brollD20 = diceRoll(roll.results.broll);
          if (brollD20 === 1)
            computed.bcritfail = 1;
        }
      }
    }

    // check usure
    if (options.usure) {
      const attackId = strval(options.usure.attackId);
      const name = strval(options.usure.name);
      const usure = intval(options.usure.value);
      if (usure > 0 && attackId !== "") {
        const rollD20 = diceRoll(roll.results.roll);
        if (rollD20 === 1 && roll.results.usure)
          updates.set("usure_check", JSON.stringify({ attack: attackId, name, usure, roll: roll.results.usure.result }));
      }
    }

    // store healing result
    if (roll.results.heal) {
      updates.set("healing", `${ roll.results.heal.result }~${ roll.rollId }`); // make it unique
    }

    // additional chat roll
    if (strval(options.nextRoll) !== "")
      updates.set("next_roll", `${ options.nextRoll }~${ roll.rollId }`); // make it unique

    if (roll.results.targetname)
      updates.set("last_target", getRollData(roll, "targetname"));

    if (updates.size > 0)
      setAttrs(Object.fromEntries(updates));

    finishRoll(roll.rollId, computed);
  });
}

/**
 * Return COF 2e rolltemplate
 * @param {object} props - list of {{ }} sections as object properties
 * @param {object} [options={}] - optional properties to add to roll
 * @returns {string[]}
 */
function rollTemplate(props, options = {}) {
  if (options.tags) {
    if (Array.isArray(options.tags)) {
      if (options.tags.length > 0)
        props.tags = options.tags.join(" | ");
    }
  }
  return [
    "perso=@{character_name}",
    "color=@{couleur_pj}",
    ...Object.entries(props).map(e => {
      const [ prop, value ] = e;
      const space = (value !== "") ? " " : ""
      return `${prop}=${value}${space}`;
    })
  ];
}

/**
 * Send a single value roll query to chat and process response
 * @param {string} prompt - Input box label
 * @param {object} callback - Callback function to process input
 */
function askValue(prompt, callback) {
  const askValue = `! {{ask=[[?{${prompt}}]]}}`;
  startRoll(askValue, question => {
    const query = question.results.ask.result;
    if(query && callback) {
        callback(query);
    }
    finishRoll(question.rollId);
  });
}

/**
 * Send a drop-down roll query to chat and process response
 * @param {string|string[]} askParams - Parameters of the roll query 
 * @param {(query:integer, choices:string[]) => void} callback - Callback function to process input
 */
function ask(askParams, callback) {
  if (!Array.isArray(askParams)) {
    askParams = [ askParams, "Non", "Oui" ];
  }
  const [ prompt, ...choices ] = askParams;
  const choice = choices.map((ch, ix) => `${ch},${ix + 1}`).join("|");
  const ask = `! {{ask=[[?{${prompt}|${choice}}]]}}`;
  startRoll(ask, question => {
      const query = question.results.ask.result;
      if(query && callback) {
          callback(query, choices);
      }
      finishRoll(question.rollId);
  });
};

/**
 * Extract string data from CRP roll object
 * @param {object} rollInfo - startRoll roll object
 * @param {string} name - name of roll to parse data from
 * @returns {string}
 */
function getRollData(rollInfo, name) {
  const expr = strval(rollInfo.results[name].expression);
  if (expr === "")
    return;
  return (expr.match(/^0\[(.*)\]\s*$/) || [])[1];
}

/**
 * Add numeric attributes values
 * @param {object} values - getAttrs object with numeric values
 * @returns - {number}
 */
function addValues(values) {
  return Object.keys(values).reduce((sum, attr) => {
    return sum + intval(values[attr]);
  }, 0);
}

/**
 * Return die expression with cf/cs options
 * @param {string} dice - Die roll
 * @param {{ cf: number, cs: number }} options - Critical failure/success target numbers
 * @returns {string}
 */
function rollCfCs(dice, options = {}) {
  const { cf, cs } = { cf: 1, cs: 20, ...options };
  return dice + `cf${cf}cs${cs}`;
}

/**
 * Return the die roll formula for type
 * @param {string} type - Type of d20 roll
 * @param {number} [weakened=0] - Has weakened condition
 * @param {{cf: number, cs: number }} [cfcs={}] - Critical failure/success target numbers
 * @returns - {string}
 */
function dieRoll(type, weakened = 0, cfcs = {}) {
  let roll = "";
  switch (strval(type)) {
    case "S":
      roll = (weakened === 1) ? rollCfCs("1d20", cfcs) : rollCfCs("2d20kh1", cfcs);
      break;
    case "H":
      roll = (weakened === 1) ? rollCfCs("2d20kh1", cfcs) : "{" + rollCfCs("2d20kh1", cfcs) + ", 0d0 + 10}kh1";
      break;
    default:
      roll = (weakened === 1) ? rollCfCs("2d20kl1", cfcs) : rollCfCs("1d20", cfcs);
      break;
  }
  return roll;
}

/**
 * Return the actual d20 roll
 * @param {string} base - Base d20 roll
 * @param {string} d20Roll - Type of roll selected
 * @param {{cf: number, cs: number }} [cfcs={}] - Critical failure/success target numbers
 * @returns {string}
 */
function d20Roll(base, d20Roll, cfcs = {}) {
  let roll = base;
  switch (roll) {
    case "1d20":
    case rollCfCs("1d20"):
      if (d20Roll !== "1d20")
        return rollCfCs(d20Roll, cfcs);
      break;
    case "2d20kh1":
    case rollCfCs("2d20kh1"):
      if (d20Roll === "2d20kl1")
        return rollCfCs("1d20", cfcs);
      break;
    case "2d20kl1":
    case rollCfCs("2d20kl1"):
      if (d20Roll === "2d20kh1")
        return rollCfCs("1d20", cfcs);
      break;
    case "{2d20kh1, 0d0 + 10}kh1":
    case "{" + rollCfCs("2d20kh1") +", 0d0 + 10}kh1":
      if (d20Roll === "2d20kl1")
        return rollCfCs("2d20kh1", cfcs);
      break;
  }
  if (roll === "1d20")
    roll = rollCfCs("1d20", cfcs);
  return roll;
}

/**
 * Detect MOD script
 * @param {object} values - getAttrs() object values
 * @returns {boolean}
 */
function hasMODScript(values) {
  if (!values.scriptVersion)
    return false;
  return values.scriptVersion;
}

/**
 * Returns Token Mod command to complete
 * @param {string} charName - character name
 * @param {Object} [props={}] - properties name/value pairs
 * @returns {string}
 */
function tokenMod(charName, props = {}) {
  const tokenmod = `!token-mod {{ --current-page --ignore-selected --ids @{${charName}|character_id}`;
  const tokenProps = Object.keys(props).map(prop => `${prop}|${props[prop]}`).join(" ");
  return tokenmod + (tokenProps !== "" ? " --set " : "") + tokenProps + " }}";
}

/**
 * Build ChatSetAttr command
 * @param { { silent: boolean, mute: boolean, select: string, from: string, header: string, content: string } } options - !setattr options
 * @param {Object} attrs - attributes name/value pairs
 * @returns {string}
 */
function chatSetAttr(options, attrs = {}) {
  options = { select: "--sel", from: "COF2e", header: "", ...options };
  if (!options.select)
    return "";
  const setattr = Object.keys(options).reduce((result, optk) => {
    if ([ "silent", "mute" ].includes(optk))
      result += ` --${optk}`;
    if ([ "from", "header", "content" ].includes(optk) && options[optk])
      result += ` --fb-${optk} ${options[optk]}`;
    return result;
  }, `!setattr ${options.select}`);
  const attribs = " " + Object.entries(attrs).map(([ name, value ]) => `--${name}|${value}`).join(" ");
  return setattr + attribs;
}

/**
 * Build addCustomTurn command
 * @param { { formula: number, initial: string|number, name: string } } options - !act options
 * @returns {string}
 */
function addCustomTurn(options) {
  options = { formula: -1, ...options };
  const actCmd = Object.keys(options).reduce((result, optk) => {
    if (optk === "formula")
      return result;
    if (optk === "initial")
      return result += ` ${options[optk]}`;
    if (optk === "index")
      return result += ` --index ${options[optk]}`;
    if (optk === "name")
      return result += ` --${options[optk]}`;
    else
      return result += ` --${toKebabCase(optk)}`;
  }, `!act ${options.formula}`);
  return actCmd;
}

/**
 * Show a div area via Roll20 jQuery
 * @param {string} div - Name of div area to show
 */
function showArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.hiddenClass);
  $20(`.${div}`).addClass(SWData.settings.visibleClass);
}

/**
 * Hide a div area via Roll20 jQuery
 * @param {string} div - Name of div area to hide
 */
function hideArea(div) {
  $20(`.${div}`).removeClass(SWData.settings.visibleClass);
  $20(`.${div}`).addClass(SWData.settings.hiddenClass);
}

/**
 * Send an /fx command to Roll20 chat
 * @param {string} fxValue - FX parameter "name {target} {count}[,name {target} {count}]"
 * @returns {void}
 */
function playFX(fxValue) {
  if (fxValue === "")
    return;

  let fxChat = "";
  fxValue.split(",").forEach((fx, ix) => {
    if (ix > 0)
      fxChat += "\n";
    const [ fxName, ...params ] = (fx.replace(/\s\s+/g, " ") + " ").split(" ");
    let count = 1;
    const fxCmd = `/fx ${fxName} @{selected|token_id}`;
    if (params[0] !== "")
      count = intval(params[0]);
    
    fxChat += fxCmd;
    while (--count > 0) {
      fxChat += "\n" + fxCmd;
    }
  });

  if (fxChat !== "")
    sendChatCmd(fxChat);
}

/**
 * Ability info
 * @typedef abilityInformations
 * @property {number} path - path number
 * @property {number} rank - rank number
 * @property {string} pathName - path name attribute
 * @property {string} pathPV - path PV attribute
 * @property {string} rankBase - base rank number
 * @property {string} rankName - ability name attribute
 * @property {string} rankDesc - ability description attribute
 * @property {string} rankOwned - is ability owned
 * @property {string} rankSpell - is spell ability attribute
 * @property {string} rankUse - ability uses attribute
 * @property {string} rankUseMax - ability max uses attribute
 * @property {string} rankUseFreq - ability uses frequence attribute
 * @property {string} rankParam - ability param attribute
 * @property {string} rankProps - ability properties attribute
 */

/**
 * Return info for path+rank identifier
 * @param {string|{ path: number, rank: number }} [pathRank=""] - v#r# identifier (path + rank)
 * @returns {abilityInformations}
 */
function abilityInfo(pathRank = "") {
  if (pathRank === "") {
    return {
      pathName:     "voie#nom",
      pathPV:       "voie#pv",
      pathProfile:  "v#profil",
      rankBase:     "v#br",
      rankName:     "voie#-t#",
      rankDesc:     "voie#-#",
      rankOwned:    "v#r#",
      rankSpell:    "v#r#_spell",
      rankUse:      "v#r#_use",
      rankUseMax:   "v#r#_use_max",
      rankUseFreq:  "v#r#_freq",
      rankParam:    "v#r#_param",
      rankProps:    "v#r#_props",
    };
  }

  let path = 0;
  let rank = 0;
  if (typeof(pathRank) === "string") {
    path = intval(pathRank.charAt(1));
    rank = intval(pathRank.charAt(3));
  } else {
    ({ path, rank } = pathRank);
  }
  const vr = `v${path}r${rank}`;
  return {
    path,
    rank,
    pathName:     `voie${path}nom`,
    pathPV:       `voie${path}pv`,
    pathProfile:  `v${path}profil`,
    rankBase:     `v${path}br`,
    rankName:     `voie${path}-t${rank}`,
    rankDesc:     `voie${path}-${rank}`,
    rankOwned:    vr,
    rankSpell:    `${vr}_spell`,
    rankUse:      `${vr}_use`,
    rankUseMax:   `${vr}_use_max`,
    rankUseFreq:  `${vr}_freq`,
    rankParam:    `${vr}_param`,
    rankProps:    `${vr}_props`,
  };
}

/**
 * Return paths names
 * @param {string} noms_voies - noms_voies attribute value
 * @returns {string[]}
 */
function getPathNames(noms_voies) {
  return strval(noms_voies).split("|").map(n => strval(n).trim());
}

/**
 * Return paths ranks
 * @param {string} rangs_voies - rangs_voies attribute value
 * @returns {number[]}
 */
function getPathRanks(rangs_voies) {
  return strval(rangs_voies).split(",").map(r => intval(r));
}

/**
 * Return list of rank names
 * @param {string} pathName - Name of path
 * @param {object} values - getAttrs() Roll20 object
 * @returns {string[]}
 */
function getRankNames(pathName, values) {
  const rankNames = objval(strval(values.noms_rangs, "[]"));
  return rankNames.filter(rn => rn.path === pathName).map(rn => rn.rank);
}

/**
 * Return list of owned abilities
 * @param {object} values - getAttrs() object
 * @returns {string[]}
 */
function ownedAbilities(values) {
  const ranks = getPathRanks(strval(values.rangs_voies));
  let abilities = [];
  getPathNames(strval(values.noms_voies)).forEach((pathName, ix) => {
    if (ranks[ix] === 0)
      return;
    pathName = cleanText(pathName);
    const path = SWData.PVPATH.find(path => path.name === pathName);
    if (!path)
      return;
    //const owned = path.abilities.slice(0, ranks[ix]);
    const owned = getRankNames(pathName, values).slice(0, ranks[ix]);
    abilities = [ ...abilities, ...owned ];
  });
  return abilities;
}

/**
 * Return owned abilities tree
 * @param {object} values - getAttrs() object
 * @returns {{ name: string, profile: string, abilities: string[]}[]} ability tree
 */
function ownedAbilityTree(values) {
  const ranks = getPathRanks(strval(values.rangs_voies));
  let abilities = [];
  getPathNames(strval(values.noms_voies)).forEach((pathName, ix) => {
    if (ranks[ix] === 0)
      return;
    pathName = cleanText(pathName)
    const path = SWData.PVPATH.find(path => path.name === pathName);
    if (!path)
      return;
    //const owned = path.abilities.slice(0, ranks[ix]);
    const owned = getRankNames(pathName, values).slice(0, ranks[ix]);
    abilities.push({ name: pathName, profile: path.profile, abilities: owned });
  });
  return abilities;
}

/**
 * Check if ability name is owned
 * @param {object} search - search parameters
 * @param {string} search.name - ability name to search for
 * @param {string} [search.inPath=""] - name of path to search ability in
 * @param {object} values - getAttrs() object
 * @returns {boolean}
 */
function hasAbility(search, values) {
  const { name, inPath = "" } = search;
  let owned;
  if (inPath !== "") {
    owned = ownedAbilityTree(values);
    const path = owned.find(path => path.name === cleanText(inPath));
    if (!path)
      return false;
    owned = path.abilities;
  } else {
    owned = ownedAbilities(values);
  }
  return owned.includes(cleanText(name));
}

/**
 * Search ability name 
 * @param {string} search - ability name to search
 * @param {object} values - getAttrs() object (should contain noms_rangs)
 * @returns {boolean}
 * @description Useful for epic abilities
 */
function hasAbilityName(search, values) {
  try {
    const rankNames = objval(strval(values.noms_rangs, "[]")).map(rn => rn.rank);
    return rankNames.includes(search);
  } catch (error) { 
    return false;
  }
}

/**
 * Count the number of paths with attained rank 
 * @param {object} search - search option
 * @param {string} search.profile - profile name to search
 * @param {number} [search.minRank=5] - attained rank to search
 * @param {object} values - getAtts() object values
 * @returns {number}
 */
function getPathsWithRank(search, values) {
  const { profile, minRank = 5 } = search;
  const owned = ownedAbilityTree(values);
  const withRank = owned
  .filter(path => path.profile === cleanText(profile, false))
  .filter(path => path.abilities.length >= minRank);
  return withRank.length;
}


/**
 * Return list of attributes for fear conditions
 * @returns {string[]}
 */
function fearConditionsAttrs() {
  return [
    "condition_effraye",
    "condition_panique" 
  ];
}

/**
 * Return fear malus (if any)
 * @param {object} values - Roll20 getAttrs() object
 * @returns {string}
 */
function fearConditionMalus(values) {
  let fear = "";
  const hasFear = Object.fromEntries(fearConditionsAttrs().map(attr => {
    return [ attr.split("_")[1], boolval(values[attr]) ];
  }));
  if (hasFear["panique"]) {
    fear = " -5[Paniqué-e]";
  } else if (hasFear["effraye"]) {
    fear = " -2[Effrayé-e]";
  }
  return fear;
}

/**
 * Return Valeur d'Ombre
 * @param {object} values - Roll20 getAttrs() object
 * @returns { {
 * value: number,
 * malus: string,
 * dm: string,
 * tag: string
 * } }
 */
function shadowValue(values) {
  const pc = intval(values.pc);
  let shadow = { 
    value: 0,
    malus: "",
    dm: "",
    tag: ""
  };
  if (boolval(values.cfg_shadow) && pc < 0) {
    shadow.value = Math.abs(pc);
    shadow.malus = ` -${ shadow.value }[Ombre]`;
    shadow.dm = ` +${ shadow.value }[Ombre]`;
    shadow.tag = `Ombre:${ shadow.value }`;
  }
  return shadow;
}

/**
 * Return roll tags list
 * @param {object} values - Roll20 getAttrs() object
 * @returns {string[]}
 */
function getAllTags(values) {
  const allTags = [];

  SWData.PC.CONDITIONS.filter(condition => {
    return [
      "affaibli",
      "immobilise",
      ...fearConditionsAttrs().map(cn => cn.split("_")[1])
    ].includes(condition.name);
  }).forEach(condition => {
    if (boolval(values[`condition_${ condition.name }`]))
      allTags.push(condition.label + "-e");
  });
  const shadow = shadowValue(values);
  if (shadow.value > 0)
    allTags.push(shadow.tag);

  return allTags;
}

/**
 * Return family for profile name
 * @param {string} name - profile name
 * @returns {string}
 */
function getFamilyByProfile(name) {
  let familyName = "";
  for (const family of Object.keys(SWData.PC.PROFILES)) {
    const found = SWData.PC.PROFILES[family].find(profile => cleanText(profile.value) === cleanText(name));
    if (found) {
      familyName = cleanText(family);
      break;
    }
  }
  return familyName;
}

/**
 * Return PV number for an ability
 * @param {string} name - ability name
 * @returns {number}
 */
function getAbilityPV(name) {
  let pv = 0;
  name = cleanText(name);
  const profileInfo = SWData.PVPATH.find(p => p.abilities.includes(name));
  if (profileInfo) {
    const family = getFamilyByProfile(profileInfo.profile);
    const rank = profileInfo.abilities.findIndex(ability => ability === name) + 1;
    switch (family) {
      case "aventuriers":
      case "mystiques":
        if (rank === 1 || rank === 2)
          pv = 2;
        if (rank >= 3)
          pv = 4;
        break;
      case "combattants":
        if (rank === 1)
          pv = 3;
        if (rank === 2)
          pv = 2;
        if (rank >= 3)
          pv = 5;
        break;
      case "mages":
        if (rank === 1)
          pv = 2;
        if (rank === 2)
          pv = 1;
        if (rank >= 3)
          pv = 3;
        break;
    }
  }
  return pv;
}

/**
 * Return modifier with sign prefix
 * @param {number} mod - modifier value
 * @returns {string}
 */
function displayMod(mod) {
  mod = intval(mod);
  return `${ mod >= 0 ? "+" : "" }${mod}`;
}

/**
 * Replace evolutive dice expression with attribute reference
 * @param {string} expr - dice expression
 * @returns {string}
 */
function replaceDevol(expr) {
  return expr.replaceAll(/d(4°|E)/g, "@{devol}");
}

// ===============
// PC SHEET EVENTS
// ===============

/**
 * Change identity heading
 */
on("change:sheet_type", function() {
  getAttrs([ "sheet_type" ], function(values) {
    const sheetType = strval(values.sheet_type);
    if (!sheetType) 
      return;

    Object.values(SWData.SHEET_TYPE).forEach(type => {
      if (type === sheetType) {
        showArea(`identity-${type}`);
      } else {
        hideArea(`identity-${type}`);
      }
    });

    if (sheetType === SWData.SHEET_TYPE.NPC)
      setAttrs({ atkcac: 0, atkmag: 0 });

  });
});

/**
 * Change d20 roll
 */
[ "1d", "db", "dm" ].forEach(button => {
  on(`clicked:d20roll_${button}-btn`, function() {
    const d20roll = ({ "1d": "1d20", db: "2d20kh1", dm: "2d20kl1" })[button];
    setAttrs({ d20roll });
  });
});

on("change:cfg_d20roll", function() {
  getAttrs([ "cfg_d20roll" ], function(values) {
    const d20roll = intval(values.cfg_d20roll) === 2
    ? "?{Jet ?|Normal,1d20|Dé bonus,2d20kh1|Dé malus,2d20kl1}"
    : "1d20";
    setAttrs({ d20roll });
  });
});

/**
 * Change tabs
 */
[ 
  "pc_main", "pc_abilities", "pc_gears", "pc_notes",
  "pc_config", "pc_script", "pc_version",
  "npc_main", "npc_gears", "npc_config", "npc_script"
].forEach(button => {
  on(`clicked:${button}-btn`, function() {
    const [ type, value ] = button.split("_");
    setAttrs({ [`${type}_tab`]: value });
  });
});

/**
 * Change subtabs
 */
[ "attacks", "otact", "hands", "resdm" ].forEach(button => {
  on(`clicked:pc_${button}-btn`, function() {
    setAttrs({ pc_subtab1: button });
  });
});

[ "rolls", "master", "skills", "buffs", "import" ].forEach(button => {
  on(`clicked:pc_${button}-btn`, function() {
    setAttrs({ pc_subtab2: button });
  });
});

[ "attacks", "abilities", "notes" ].forEach(button => {
  on(`clicked:npc_${button}-btn`, function() {
    setAttrs({ npc_subtab1: button });
  });
});

/**
 * Populate the profiles datalist
 * @param {string} family - name of profiles family
 * @param {string} profile - name of current profile
 * @returns 
 */
function setProfilesList(family, profile) {
  const profiles = SWData.PC.PROFILES[family] || [];
  if (profiles.length === 0)
    return;
  populateListOptions({
    elemSelector: "#pc-profiles",
    optionsArray: profiles.map(prof => ({ value: prof.value, selected: (prof.value === profile)}))
  });
}

/**
 * Get profile data object
 * @param {string} profile - profile name
 * @param {string} [selectFamily=""] - family name
 * @returns {object}
 */
function getProfileData(profile, selectFamily = "") {
  let data;
  const [ primary ] = strval(profile).split("/");
  if (primary) {
    for (const family in SWData.PC.PROFILES) {
      if (selectFamily !== "" && family.toLowerCase() !== selectFamily.toLowerCase())
        continue;
      data = SWData.PC.PROFILES[family].find(p => primary.toLowerCase() === p.value.toLowerCase());
      if (data)
        break;
    }
  }
  return data;
}

/**
 * On change of family
 * - set list of profiles
 * - set DR type
 * - set PC & DR base
 */
on("change:famille", function(eventInfo) {
  getAttrs([ "profil", "famille" ], function(values) {
    const family = strval(values.famille);
    const profile = strval(values.profil);
    setProfilesList(family, profile);

    const updates = new Map();

    let dRecup = 8;
    let pcBase = 2;
    let drBase = 2;
    let voie123pv = 4;
    switch (family) {
      case "Aventuriers":
        pcBase = 3;
        break;
      case "Combattants":
        dRecup = 10;
        voie123pv = 5;
        break;
      case "Mages":
        dRecup = 6;
        voie123pv = 3;
        break;
      case "Mystiques":
        drBase = 3;
        break;
    }
    updates.set("drecup", dRecup);
    updates.set("pc_base", pcBase);
    updates.set("dr_base", drBase);
    updates.set("voie1pv", voie123pv);
    updates.set("voie2pv", voie123pv);
    updates.set("voie3pv", voie123pv);

    logAndSet(Object.fromEntries(updates), logTitle(eventInfo));
  });
});

/**
 * On change of profile, check skill proficiencies
 */
on("change:profil", function(eventInfo) {
  getAttrs([ 
    "profil", "famille", "niveau",
    "cfg_atk_diff", "use_skills"
  ], function(values) {
    const useSkills = boolval(values.use_skills);
    if (!useSkills)
      return;

    const family = strval(values.famille);
    if (!SWData.PC.PROFILES[family])
      return;

    const profile = getProfileData(strval(values.profil));
    if (!profile)
      return;

    const updates = new Map();

    if (boolval(values.cfg_atk_diff) && intval(values.niveau) < 2) {
      Object.keys(profile.atks).forEach(atk => {
        updates.set(`atk${atk}_base`, profile.atks[atk]);
      });
    }

    const skillList = profile.skills.split(",");
    SWData.PC.SKILLS.forEach(skill => {
      const proficient = skillList.includes(skill.name) ? 1 : 0;
      updates.set(skill.name + "_prof", proficient);
    });
        
    if (updates.size > 0)
      logAndSet(Object.fromEntries(updates), logTitle(eventInfo));
  });
});

/**
 * On change of heritage, set/reset abilities
 */
on("change:peuple", function(eventInfo) {
  const path = SWData.settings.peoplePath;
  const rankNames = seq(5).map(rank => abilityInfo({ path, rank }).rankName);
  getAttrs([ "peuple", ...rankNames ], function(values) {
    const updates = new Map();
    const people = strval(values.peuple);

    if (people.trim() === "") {
      updates.set(abilityInfo({ path }).pathName, "");
      // reset abilities
      rankNames.forEach((rank, ix) => {
        rank = ix + 1;
        updates.set(abilityInfo({ path, rank }).rankOwned, "");
        updates.set(abilityInfo({ path, rank }).rankName, "");
        updates.set(abilityInfo({ path, rank }).rankDesc, "");
        updates.set(abilityInfo({ path, rank }).rankSpell, "");
        updates.set(abilityInfo({ path, rank }).rankParam, "");
        updates.set(abilityInfo({ path, rank }).rankUse, "");
        updates.set(abilityInfo({ path, rank }).rankUseFreq, "");
        updates.set(abilityInfo({ path, rank }).rankUseMax, "");
        setAttrs(Object.fromEntries(updates));
      });
      return;
    }

    const peopleInfo = SWData.HERITAGE.find(p => p.name.includes(cleanText(people)));
    if (!peopleInfo)
      return;

    rankNames.forEach((rank, ix) => {
      if (strval(values[rank]) === "")
        updates.set(abilityInfo({ path, rank: ix + 1 }).rankName, capitalize(peopleInfo.abilities[ix]));
    });

    const sens = ({
      "demiorc": "Vision dans le noir",
      "demieorc": "Vision dans le noir",
      "demieorque": "Vision dans le noir",
      "elfehaut": "Lumière des étoiles",
      "elfehaute": "Lumière des étoiles",
      "elfesylvain": "Lumière des étoiles",
      "elfesylvaine": "Lumière des étoiles",
      "elfesylvestre": "Lumière des étoiles",
      "elfedesbois": "Lumière des étoiles",
      "gnome": "Vision dans le noir",
      "nain": "Vision dans le noir",
      "naine": "Vision dans le noir"
    })[people.replaceAll("-", "").replaceAll(" ", "").trim().toLowerCase()];
    if (sens)
      updates.set("sens", sens);

    setAttrs(Object.fromEntries(updates));
  });
});

/**
 * Update the base attack scores
 * @param {number} level - PC's level
 * @param {number} levelCap - level cap (6 or 10)
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map} updated Map object
 */
function updateAttacksBase(level, levelCap, attributes) {
  if (level > 1) {
    for (let lv = 2; lv <= Math.min(level, levelCap); lv++) {
      SWData.PC.COMBAT.attacks.map(a => a[0]).forEach(atk => {
        const atkBase = `${atk}_base`;
        attributes.set(atkBase, intval(attributes.get(atkBase)) + 1);
      });
    }
  }
  return attributes;
}

/**
 * Return the evolutive die for level
 * @param {number} level - PC's level
 * @returns {string} 
 */
function getDEvol(level) {
  let dEvol;
  switch (true) {
    case level >= 15:
      dEvol = "d12";
      break;
    case level >= 12:
      dEvol = "d10";
      break;
    case level >= 9:
      dEvol = "d8";
      break;
    case level >= 6:
      dEvol = "d6";
      break;
    default:
      dEvol = "d4";
  }
  return dEvol;
}

/**
 * On level change
 */
on(changeEvent([ 
  "niveau", "noms_rangs",
  "cfg_use_epic", "cfg_use_capped6", "cfg_atk_diff"
]), function(eventInfo) {
  getAttrs([ 
    "sheet_type", "niveau", "profil", "pc", "pc_max",
    "cfg_use_epic", "cfg_use_capped6", "cfg_atk_diff",
    "noms_rangs",
  ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;

    const cappedAt6 = boolval(values.cfg_use_capped6);
    const atkDiff = boolval(values.cfg_atk_diff);
    // base progression
    const levelCap = cappedAt6 ? 6 : 10;
    const level = intval(values.niveau);

    let updateAttrs = new Map();

    // reset PC
    if (intval(eventInfo.newValue) === intval(eventInfo.previousValue) + 1) {
      const pcMax = intval(values.pc_max);
      if (intval(values.pc) < pcMax)
        updateAttrs.set("pc", pcMax);
    }

    let atks = { cac: 1, tir: 1, mag: 1 };
    const profile = getProfileData(strval(values.profil));
    if (profile && atkDiff)
      atks = profile.atks;
    Object.keys(atks).forEach(atk => updateAttrs.set(`atk${atk}_base`, atks[atk]));
    updateAttrs = updateAttacksBase(level, levelCap, updateAttrs);
    updateAttrs.set("devol", getDEvol(level));
    updateAttrs.set("def_base", 10);
    
    // epic progression
    const useEpic = boolval(values.cfg_use_epic);
    if (level > levelCap && useEpic) {
      const oddLevel = (level %2 === 1) ? level : level -1;
      const epicBase = levelCap + Math.ceil((oddLevel - levelCap) / 2);
      const heroicDef = hasAbilityName("defense heroique", values) ? 2 : 0;
      updateAttrs.set("atkcac_base", epicBase);
      updateAttrs.set("atktir_base", epicBase);
      updateAttrs.set("atkmag_base", epicBase);
      updateAttrs.set("def_base", epicBase + heroicDef);
    }
    logAndSet(Object.fromEntries(updateAttrs), logTitle(eventInfo));
  });
});

/**
 * Change character name to true name
 */
on("clicked:alias-toggle", function() {
  getAttrs([ "character_name", "alias", "notes" ], function(values) {
    const name = strval(values.character_name);
    const alias = strval(values.alias);
    const text = `Le vrai nom de ${name} est ${alias}`;
    const notes = strval(values.notes) + "\n=====\n" + text;
    if (alias !== "") {
      const cofantasy = JSON.stringify({ action: "alias", param: name });
      setAttrs({ character_name: alias, alias: "", notes, cofantasy });
      sendChatMsg(rollTemplate({
        text
      }));
    }
  });
})

/**
 * On stats components change
 */
SWData.PC.STATS.forEach(stat => {
  const short = shorten(stat);
  const attrs = [
    `${short}_base`,
    `${short}_buff`,
    `t${short}_buff`,
  ];
  on(changeEvent(attrs), function (eventInfo) {
    getAttrs([ "sheet_type", ...attrs], function(values) {
      if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
        return;
      
      const base = intval(values[`${short}_base`]);
      const buff = intval(values[`${short}_buff`]);
      const tbuff = intval(values[`t${short}_buff`]);
      logAndSet({
        [short]: base + buff,
        [`${short}_test`]: base + buff + tbuff
      }, logTitle(eventInfo));
    });
  });
});

/**
 * Update the init attribute
 */
function updateInit(eventInfo) {
  getAttrs([ ...SWData.PC.COMBAT.init, "sheet_type" ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;

    delete values.sheet_type;
    const car = Object.keys(values).find(k => k.startsWith("agi"));
    values[car] *= intval(values.cfg_init_agi);
    delete values.cfg_init_agi;
    const init = addValues(values);
    logAndSet({ init }, logTitle(eventInfo));
  });
}

/**
 * On init components change
 */
on(changeEvent(SWData.PC.COMBAT.init), updateInit);

/**
 * On attacks components change
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, ability ] = attk;
  const changed = [
    `${attack}_base`,
    `${ability}`,
    `${attack}_cond`,
    `${attack}_buff`
  ];
  on(changeEvent(changed), function(eventInfo) {
    getAttrs(changed, function(values) {
      const sheetType = strval(values.sheet_type);
      delete values.sheet_type;
      if (sheetType === SWData.SHEET_TYPE.NPC)
        return;
      const score = addValues(values);
      logAndSet({ [attack]: score }, logTitle(eventInfo));
    });
  });
});

/**
 * Compute max DR
 */
function updateDRMax(eventInfo) {
  getAttrs([ "sheet_type", "drmax_force", "dr_base", "con", "dr_buff" ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;
    if (boolval(values.drmax_force))
      return;

    const dr_max = intval(values.dr_base) + intval(values.con) + intval(values.dr_buff);
    logAndSet({ dr_max }, logTitle(eventInfo));
  });
}

/**
 * On CON change
 */
on("change:dr_base change:con change:dr_buff", updateDRMax);

/**
 * Compute pv_max
 * @param {object} eventInfo - Roll20 eventInfo object
 * @param {string} [changed=""] - path+rank ability id
 */
function updatePVMax(eventInfo, changed = "") {
  const owned = allPathRanks("rankOwned");
  const other = [ 
    ...nameSeq(9, abilityInfo().pathPV),
    ...allPathRanks("rankProps")
  ];
  getAttrs([
    "sheet_type",
    "cfg_lowfan",
    "cfg_pvmax_auto",
    "pvmax_force",
    "famille", "niveau",
    "con", 
    "pv", "pv_buff",
    "noms_voies",
    ...owned,
    ...other 
  ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;
    if (!boolval(values.cfg_pvmax_auto) && strval(eventInfo.triggerName) !== "RESET")
      return;
    if (boolval(values.pvmax_force))
      return;

    const level = intval(values.niveau);
    if (boolval(values.cfg_lowfan) && level > 6)
      return;
    
    // Won't update if changing rank 2 for Mages profiles
    if (changed !== "")
      if (level === 1
          && strval(values.famille) === "Mages" 
          && abilityInfo(changed).rank === 2)
        return;
      
    let pv = intval(values.pv);
    let pvMax = boolval(values.cfg_lowfan) ? 5 : 0;

    // niveau * CON 
    pvMax += level * intval(values.con);

    const unknowns = [];
    owned.forEach(ability => {
      if (!boolval(values[ability]))
        return;
      
      const props = strval(values[`${ability}_props`]).toLowerCase();
      if (hasProp(props, "doublon") || hasProp(props, "epic"))
        return;

      const { path, rank } = abilityInfo(ability);
      let pathPV = intval(values[abilityInfo(ability).pathPV]);

      if (path === SWData.settings.peoplePath && rank === 1)
        return;

      if (SWData.settings.profilePaths.includes(path) && rank === 1) {
        pvMax += pathPV;
        return;
      }

      if (SWData.settings.level1Paths.includes(path) 
          && rank === 2 
          && hasProp(props, "initial"))
        return;
      
      if (pathPV === 0) {
        const pathName = strval(getPathNames(values.noms_voies)[path - 1]);
        if (pathName !== "") {
          const pathInfo = SWData.PVPATH.find(p => p.name === cleanText(pathName));
          if (pathInfo)
            pathPV = pathInfo.pv;
        }
        if (pathPV === 0)
          unknowns.push(pathName);
      }
      if (pathPV === 0)
        return;

      if (rank > 2) {
        pvMax += pathPV;
      } else {
        pvMax += pathPV / 2;
      }

    });
    
    if (unknowns.length > 0) {
      sendChatMsg(rollTemplate({
        lsub: "Erreur",
        rsub: "Calcul PV max",
        alert: `**Calcul impossible : Pas de PV indiqué pour la ou les voies ${ unknowns.join(", ") }**`,
        alertclass: "fumble"
      }), {
        ...SWData.RT_OPTIONS,
        whisper: "gm"
      });
      return;
    }

    pvMax += intval(values.pv_buff);
    if (level === 1 && pv === 0)
      pv = pvMax;

    logAndSet({ pv, pv_max: pvMax }, logTitle(eventInfo));
  });
}

/**
 * On max PV config, niveau, CON, pv_buff change
 */
on("change:cfg_pvmax_auto change:niveau change:con change:pv_buff", updatePVMax);

/**
 * Compute load limit
 * @param {number} force - FOR score
 * @returns {number}
 */
function loadLimit(force) {
  return 10 + 2 * force;
}

/**
 * Compute load threshold
 */
function updateLoadLimit(eventInfo) {
  getAttrs([ "sheet_type", "for" ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;
    logAndSet({ limite_enc: loadLimit(intval(values.for)) }, logTitle(eventInfo));
  });
}

/**
 * On FOR change
 */
on("change:for", updateLoadLimit);

/**
 * Compute max PM
 */
function updatePMMax(eventInfo) {
  const owned = allPathRanks("rankOwned");
  const spells = allPathRanks("rankSpell");
  const bRanks = nameSeq(9, abilityInfo().rankBase);
  getAttrs([ 
    "cfg_use_mana", "pmmax_force",
    "vol", "pm_buff",
    "cha", "rangs_voies", "noms_voies", "noms_rangs",
    ...spells,
    ...owned,
    ...bRanks
  ], function(values) {
    if (boolval(values.pmmax_force))
      return;

    const useMorePM = boolval(values.cfg_use_mana);
    const spellPM = spells.reduce((pm, spell) => {
      const [ ability ] = spell.split("_");
      const baseRank = intval(values[abilityInfo(ability).rankBase]);
      const rank = abilityInfo(ability).rank;
      let pmGain = 1;
      if (useMorePM && (baseRank + rank -1) >= 3)
        pmGain = 2;
      return pm + (intval(values[ability]) * intval(values[spell]) * pmGain);
    }, 0);
    let base = intval(values.vol);
    if (hasAbility({ name: "charisme heroique", inPath: "seduction" }, values)) {
      const cha = intval(values.cha);
      if (cha > base)
        base = cha;
    }

    const epicMana = hasAbilityName("mana epique", values) ? 5 : 0;
    const pm_max = spellPM > 0 ? base + spellPM + intval(values.pm_buff) + epicMana : 0;
    logAndSet({ pm_max }, logTitle(eventInfo));
  });
}

/**
 * On VOL & PM buff change
 * On CHA & ranks change
 */
on(changeEvent([ "vol","pm_buff","cha","rangs_voies","noms_voies","noms_rangs" ]), updatePMMax);

/**
 * On change of an ability spell
 */
seq(9).forEach(p => {
  seq(5).forEach(r => {
    on(`change:v${p}r${r} change:v${p}r${r}_spell`, updatePMMax);
  });
});

/**
 * Compute max PC
 */
function updatePCMax(eventInfo) {
  getAttrs([ "sheet_type", "pcmax_force", "pc_base", "cha", "pc_buff", "cfg_pc_var" ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;
    if (boolval(values.pcmax_force))
      return;
    
    const doublePC = boolval(values.cfg_pc_var) ? 2 : 1;
    delete values.cfg_pc_var;
    const pc_max = addValues(values) * doublePC;
    logAndSet({ pc_max, double_pc: doublePC === 2 ? " x 2" : "" }, logTitle(eventInfo));
  });
}

/**
 * On PC components change
 */
on(changeEvent([ "pc_base","cha","pc_buff","cfg_pc_var" ]), updatePCMax);

/**
 * Return list of attributes for luck roll button
 * @returns {string[]}
 */
function luckButtonAttrs() {
  return [
    "cfg_luck_btn",
    "cfg_shadow", 
    "character_name", 
    "couleur_pj", 
    "pc"
  ];
}

/**
 * Return roll template field for luck button
 * @param {Object} values - getAttrs() object
 * @returns {string}
 */
function addLuckButton(values) {
  if (!boolval(values.cfg_luck_btn))
    return "";
  const pc = intval(values.pc);
  if (!boolval(values.cfg_shadow) && pc === 0)
    return "";
  const charName = strval(values.character_name);
  const color = strval(values.couleur_pj);
  const pcLabel = boolval(values.cfg_shadow) ? "Choc" : "Chance";
  return `[${pcLabel}](~${charName}|luck_apply-btn${menuButton(color, { size: "1.3em" }, { class: "chat-button" })}) (Reste ${pc} PC)`;
}

/**
 * Return roll template field for help button
 * @param {Object} values - getAttrs() object
 * @returns {string}
 */
function addHelpButton(values) {
  if (!boolval(values.chatsetattr))
    return "";
  if (strval(values.sheet_type) !== SWData.SHEET_TYPE.PC)
    return "";
  const charName = strval(values.character_name);
  const color = strval(values.couleur_pj);
  return `[Aider](~${charName}|help_other-btn${menuButton(color, { size: "1.3em" }, { class: "chat-button" }, { title: "Cliquer le token du destinataire de l'aide" })})`;
}

/**
 * Limit PC loss
 */
on("change:pc", function() {
  getAttrs([ "pc", "cfg_shadow" ], function(values) {
    const shadow = boolval(values.cfg_shadow);
    const pc = intval(values.pc);
    const pcMin = Math.max(pc, shadow ? -5 : 0);
    if (pcMin > pc)
      setAttrs({ pc: pcMin });
  });
});

/**
 * Return modifier for all rolls
 * @param {object} values - Roll20 getAttrs() object
 * @param {string} type - All buffs type caracs | attacks
 * @returns {string}
 */
function allRollsBuff(values, type) {
  let allRolls = "";
  const value = intval(values[`all${type}_buff`]);
  if (value !== 0) {
    let desc = type === "caracs" ? " de caracs" : type === "attacks" ? " d'attaques" : "";
    desc = strval(values[`all${type}_desc`], "Tous les jets" + desc);
    allRolls = ` + ([[${value}]])[${desc}]`;
  }
  return allRolls;
}

/**
 * Stats rolls
 */
SWData.PC.STATS.forEach(stat => {
  const short = shorten(stat);

  // Set the stat die rolls
  on(`change:${short}_sup change:condition_affaibli`, function(eventInfo) {
    getAttrs([ `${short}_sup`, "condition_affaibli" ], function(values) {
      const [ dType ] = Object.keys(values);
      const weakened = intval(values.condition_affaibli);
      const roll = dieRoll(values[dType], weakened);
      logAndSet({ [`${short}_dsup`]: roll }, logTitle(eventInfo));
    });
  });
  
  // Roll stat
  on(`clicked:${short}-btn`, function () {
    const defGearAttrs = [
      "armure_malus", "armure_eqp",
      "cfg_bouclier_malus", "bouclier_malus", "bouclier_eqp",
      "casque", "casque_eqp"
    ];
    getAttrs([
      `${short}_dsup`, short, `${short}_test`,
      "sheet_type",
      "cfg_shadow", "pc", 
      "notif_fx",
      "chatsetattr", "help_roll_all",
      "condition_affaibli",
      ...fearConditionsAttrs(),
      ...luckButtonAttrs(),
      ...defGearAttrs, 
      "def_action",
      "d20roll",
      "allcaracs_desc", "allcaracs_buff",
    ], function(values) {
      // Play FX !
      const fxValue = strval(values.notif_fx);
      if (fxValue !== "")
        playFX(fxValue);

      const allTags = getAllTags(values);

      // Peur
      let fear = fearConditionMalus(values);

      // Valeur d'Ombre
      const shadow = shadowValue(values);
      
      // Roll ability
      const [ kroll, mod, test ] = Object.keys(values);
      const roll = d20Roll(strval(values[kroll]), strval(values.d20roll));
      const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
      const statMod = ` *(${ displayMod(values[isNPC ? mod : test]) })*`;
      
      const armure_eqp = intval(values.armure_eqp);
      const armure_malus = intval(values.armure_malus) * armure_eqp;
      
      const bouclier_eqp = intval(values.bouclier_eqp);
      const bouclier_malus = intval(values.bouclier_malus) * bouclier_eqp;
      
      const armor_malus = short === "agi" ? ` - ${armure_malus}[Malus armure]` : "";
      const shield_malus = (short === "agi" && boolval(values.cfg_bouclier_malus)) ? ` - ${bouclier_malus}[Malus bouclier]` : "";
      const helmet_malus = short === "per" ? helmetMalus(values) : "";

      const helpAllRolls = strval(values.help_roll_all);
      const defAction = intval(values.def_action);
      const text = ( defAction !== 0
      ? `+ [[${defAction}]] Défense ${ defAction === 5 ? "totale" : "partielle" }`
      : "" )
      + helpAllRolls !== "" ? "\n" + helpAllRolls : "";
      const allRolls = allRollsBuff(values, "caracs");
      const carac = `[[${roll}[Dé] + @{${short}${ isNPC ? "" : "_test" }}[Bonus ${short.toUpperCase()}]${allRolls}${helpAllRolls}${shadow.malus}${fear}${armor_malus}${shield_malus}${helmet_malus} ]] `;

      const chatMsg = rollTemplate({
        lsub: "Test",
        rsub: capitalize(stat) + statMod,
        roll: carac,
        text,
        chance: addLuckButton(values),
        aide: addHelpButton(values),
      }, { tags: allTags });
      sendChatMsg(chatMsg);

      if (helpAllRolls !== "")
        setAttrs({ help_roll_all: "" });
    });
  });

  // Stat & ability roll select
  on(`clicked:${short}_select-btn`, async function() {
    const rollIds = await getSectionIDsAsync("rolls");
    const abilityRolls = [];
    rollIds.forEach(id => {
      abilityRolls.push(rptAttr("rolls", "roll-nom", id));
      abilityRolls.push(rptAttr("rolls", "roll-carac", id));
    });
    const skillMods = SWData.PC.SKILLS.map(skill => `${ skill.name }_bonus`);
    getAttrs([ 
      "character_name", "use_skills",
      ...abilityRolls,
      ...skillMods,
      ...nameSeq(4, "custom#_skillname"),
      ...nameSeq(4, `custom#_${short}`),
    ], function(values) {
      const charName = strval(values.character_name);
      const actions = [ `%{${charName}|${short}-btn}` ];
      let rolls = rollIds
      .filter(id => strval(values[rptAttr("rolls", "roll-carac", id)]) === `@{${short}_test}`)
      .map(id => {
        actions.push(`%{${charName}|${ rptAttr("rolls", "roll-btn", id) }}`);
        return `${SWData.emojis.actions} ${ strval(values[rptAttr("rolls", "roll-nom", id)]) }`;
      });
      const skills = [];
      if (boolval(values.use_skills)) {
        SWData.PC.SKILLS
        .filter(skill => {
          if (Array.isArray(skill.ability))
            return skill.ability.includes(short);
          else
            return skill.ability === short;
        })
        .filter(skill => intval(values[`${ skill.name }_bonus`]) > 0)
        .forEach(skill => {
          const skillBonus = ` (+${ intval(values[`${ skill.name }_bonus`]) })`;
          if (skill.name.startsWith("custom")) {
            if (!boolval(values[skill.name + "_" + short]))
              return;
            skill.label = strval(values[skill.name + "_skillname"]);
            if (skill.label.trim() === "")
              return;
          }
          const emoji = skill.emoji || SWData.emojis.skills;
          skills.push(emoji + getSkillName(skill) + skillBonus);
          if (Array.isArray(skill.ability))
            actions.push(`%{${charName}|skill-${ skill.name }-${short}}`);
          else
            actions.push(`%{${charName}|skill-${ skill.name }}`);
        });
      }
      if (rolls.length === 0 && skills.length === 0) {
        sendChatCmd(actions[0]);
        return;
      }
      ask([ "Jet ?", short.toUpperCase(), ...rolls, ...skills ], (selected) => {
        sendChatCmd(actions[selected - 1]);
      });
    });
  });

});

/**
 * On initiative button click
 * Used by PC & NPC sheet
 */
on("clicked:init-btn", function () {
  getAttrs([ 
    "sheet_type",
    "cfg_init_mod",
    "per", "agi",
    "casque_eqp",
    "casque",
    "pnj_tactique" 
  ], function(values) {
    let initMod = "";
    if (boolval(values.cfg_init_mod))
      initMod = ` + [[(@{per}+@{agi})/10]][Distinct]`;
    let helmet = "";
    const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
    if (!isNPC)
      helmet = helmetMalus(values);
    const tactique = isNPC ? strval(values.pnj_tactique) : "";
    const initBonus = isNPC ? " + ?{Bonus ?|0}[Bonus]" : "";
    const roll = `[[@{init}[Initiative]${helmet}${initBonus} + @{cfg_init_variable}[Dé(s)]${initMod} &{tracker} ]]`;
    const chatMsg = rollTemplate({
      lsub: "Jet",
      rsub: "Initiative",
      roll
    });
    sendChatMsg(chatMsg);

    if (tactique.replaceAll("0", "") !== "") {
      const chatMsg = rollTemplate({
        lsub: "Combat",
        rsub: "Tactique",
        text: tactique
      });
      sendChatMsg(chatMsg, { whisper: "gm" });
    }
  });
});

/**
 * On attack button click
 */
SWData.PC.COMBAT.attacks.forEach(attk => {
  const [ attack, , description ] = attk;
  on(`clicked:${attack}-btn`, function () {
    getAttrs([
      attack,
      "cfg_1attack_roll", "cfg_cible",
      "cfg_d20roll", "d20roll",
      "cfg_shadow", "pc",
      "condition_affaibli", "condition_immobilise",
      ...luckButtonAttrs(),
      "manoeuvre", "cha"
      ], function (values) {
      const atkBonus = `${ displayMod(values[attack]) }`;
      const useOneRoll = intval(values.cfg_d20roll) === 0
      ? boolval(values.cfg_1attack_roll)
      : true;
      const weakened = intval(values.condition_affaibli);
      const restrained = intval(values.condition_immobilise);
      const withMalusDie = (weakened === 1) || (restrained === 1);
      let roll = withMalusDie ? rollCfCs("2d20kl1") : rollCfCs("1d20");
      roll = d20Roll(roll, strval(values.d20roll));
      const tags = [];
      let shadow = shadowValue(values);
      if (shadow.value > 0)
        tags.push(shadow.tag);
      const maneuvers = (boolval(values.manoeuvre) && [ "atkcac", "atktir" ].includes(attack)) 
      ? maneuversRollQuery(intval(values.cha)) 
      : "";
      const atkRoll = `[[${roll}[Dé] + @{${attack}}[Bonus]${shadow.malus}${maneuvers} ]]`;
      const atkProps = {
        lsub: "Attaque",
        rsub: `${description} *(${atkBonus})*`,
        roll: atkRoll,
        broll: "",
        chance: addLuckButton(values),
        tohit: "",
        opposed: "",
        target: "",
        targetname: ""
      };
      
      if (roll.startsWith("1d20") && !useOneRoll)
        atkProps.broll = atkRoll;
      
      if (boolval(values.cfg_cible)) {
        if (maneuvers === "") {
          atkProps.tohit = SWData.settings.tokens.target.def;
        } 
        else {
          atkProps.tohit = SWData.settings.tokens.target.opposed;
          atkProps.opposed = "[[1]]";
        }
        atkProps.target = SWData.settings.tokens.target.name;
        atkProps.targetname = `[[0[${atkProps.target}] ]]`;
      }
      
      const chatMsg = rollTemplate(atkProps, { tags });
      sendChatMsg(chatMsg);
    });
  });
});

/** 
 * Enable / Disable attack maneuvers
 */
on("clicked:maneuver-btn", function() {
  getAttrs([ "manoeuvre" ], function (values) {
    const manoeuvre = 1 - intval(values.manoeuvre);
    setAttrs({ manoeuvre });
  });
});

/**
 * On speed/m change, compute feet & square speed
 */
on("change:vitesse", function () {
  getAttrs([ "vitesse" ], function(values) {
    const vitesse = numval(values.vitesse);
    const vitesse_cases = Math.ceil(vitesse / 1.5);
    const vitesse_pas = vitesse_cases * 5;
    setAttrs({ vitesse_pas, vitesse_cases });
  });
});

/**
 * On special sense change, set range based on species
 */
on("change:sens", function () {
  getAttrs([ "sens", "sens_portee", "peuple" ], function(values) {
    if (numval(values.sens_portee) !== 0)
      return;
    let sens_portee = 0;
    switch (strval(values.peuple.toLowerCase()) + "," + strval(values.sens).toLowerCase()) {
      case "demi-orc,vision dans le noir":
      case "demie-orc,vision dans le noir":
      case "demie-orque,vision dans le noir":
      case "nain,vision dans le noir":
      case "naine,vision dans le noir":
        sens_portee = 30;
        break;
      case "gnome,vision dans le noir":
        sens_portee = 10;
        break;
    }
    if (sens_portee > 0)
      setAttrs({ sens_portee });
  })
})

/**
 * Return object for wounds conditions
 * @param {object} values - Roll20 getAttrs() object
 * @returns { {
 * dr: number,
 * condition_affaibli: number,
 * condition_inconscient: number,
 * effects: string[],
 * pvstatus: string
 * } }
 */
function wounded(values) {
  let pv = intval(values.pv);
  let dr = intval(values.dr);
  let condition_affaibli = 0;
  let condition_inconscient = 0;
  let effects = [];
  if (pv <= 1) {
    condition_affaibli = 1;
    effects.push("subit la condition Affaibli-e (PV = 1)");
  } 
  if (pv === 0) {
    dr = Math.max(dr - 1, 0);
    condition_inconscient = 1;
    effects.push("perd un DR et tombe au sol inconscient-e (PV = 0)");
  }

  const pvMax = intval(values.pv_max);
  let pvstatus = "";
  if (pv <= Math.floor(pvMax / 2))
    pvstatus = "yellow";
  if (pv < 2)
    pvstatus = "red";
  if (pv === 0)
    pvstatus = "black";

  return {
    dr,
    condition_affaibli,
    condition_inconscient,
    effects,
    pvstatus
  }
}

/**
 * Update PV & DR
 * @param {number} vp - Number of PV lost or gained
 * @param {number} lossOrGain - Type of change (-1 = loss, +1 = gain)
 * @param {boolean} [buttonClicked=true] - Updated via button
 */
function updatePVDR(vp, lossOrGain, buttonClicked = true) {
  getAttrs([ "sheet_type", "pv", "pv_max", "dr", "rd", "notif_pv" ], function (values) {
    let pv = intval(values.pv);
    const pvMax = intval(values.pv_max);
    let dr = intval(values.dr);
    const rd = strval(values.rd);
    const hasRD = (lossOrGain === -1 && rd !== "") ? "\n" + "RD " + rd : "";
    const notify = numval(values.notif_pv);

    let effects = "";
    const updateAttrs = new Map;

    // already up-to-date if not via button
    if (buttonClicked) {
      pv += vp * lossOrGain;
      updateAttrs.set("pv", pv);
    }

    if (pv > pvMax) {
      pv = pvMax;
      updateAttrs.set("pv", pv);
    }
    if (pv < 0) {
      pv = 0;
      updateAttrs.set("pv", pv);
    }

    const wounds = wounded(values);
    updateAttrs.set("condition_affaibli", wounds.condition_affaibli);
    updateAttrs.set("dr", wounds.dr);
    effects = wounds.effects.length > 0 ? "\n" : "";
    effects += wounds.effects.join("\n");

    /*if (pv > 1) {
      updateAttrs.set("condition_affaibli", 0);
    } else if (pv === 1) {
      effect = " et subit la condition Affaibli-e (PV = 1)";
      updateAttrs.set("condition_affaibli", 1);
    } else if (pv === 0) {
      dr = Math.max(dr - 1, 0);
      updateAttrs.set("dr", dr);
      effect = ", perd un DR et tombe au sol inconscient-e (PV = 0)"
    }*/
    
    if (notify > 0) {
      const chatMsg = rollTemplate({
          lsub: "PV",
          rsub: `${ lossOrGain === -1 ? "Blessure" : "Soins" } `,
          text : `@{character_name} ${ lossOrGain === -1 ? "perd" : "regagne" } ${vp} PV${effects}${hasRD} `
      });
      const whisper = (notify === 2) ? "gm" : "";
      sendChatMsg(chatMsg, {
        ...SWData.RT_OPTIONS,
        whisper
      });
    }

    if (updateAttrs.size > 0)
      setAttrs(Object.fromEntries(updateAttrs));
  });
}

/**
 * Handle PV change buttons
 * @param {string} button Name of action button
 */
function changeVP(button) {
  let prompt = (button === "vigloss-btn") ? "PV perdus ?" : "PV soignés ?";
  let lossOrGain = (button === "vigloss-btn") ? -1 : +1;
  //const ask = `!{{ask=[[?{${prompt}}]]}}`;
  askValue(prompt, function(vp) {
    if (vp <= 0) return;
    updatePVDR(vp, lossOrGain);
  });
}

/**
 * On PV change action buttons
 */
on("clicked:vigloss-btn clicked:vigheal-btn", function (eventInfo) {
  const [ button ] = strval(eventInfo.triggerName).split(":").slice(1);
  changeVP(button);
});

/**
 * Change PV background color
 * + Token tint color if TokenMod installed
 */
on("change:pv change:pvig", function (eventInfo) {
  const PV = strval(eventInfo.triggerName) === "pvig" ? "PVIG" : "pv";
  getAttrs([ 
    "sheet_type", "character_name", 
    "tokenmod", "token_tint_on", "token_tint", "tkmarker_dead_on", "tkmarker_dead", 
    "pv", "pv_max", "PVIG"
  ], function (values) {
    const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
    const tokenTint = boolval(values.token_tint_on);
    const tokenmod = boolval(values.tokenmod);
    const markerDead = boolval(values.tkmarker_dead_on) ? strval(values.tkmarker_dead).trim() : "";
    const wounds = wounded(values);
    
    const tokenProps = {};
    if (tokenTint) {
      const tokenTintColor = strval(values.token_tint).split("").every(ch => ch.match(/[0-9A-Fa-f]/))
      ? strval(values.token_tint)
      : "ED2939";
      tokenProps.tint_color = numval(values[PV]) <= Math.floor(numval(values.pv_max) / 2)
      ? tokenTintColor
      : "transparent";
    }
    if (tokenmod && markerDead !== "") {
      let deadOrAlive = wounds.condition_inconscient === 1 ? "+" : "-";
      tokenProps.statusmarkers = `${deadOrAlive}${markerDead}`;
    }
    if (Object.keys(tokenProps).length > 0)
      sendChatCmd(tokenMod(strval(values.character_name), tokenProps));
    if (isNPC)
      return;
  
    setAttrs({ pvstatus: wounds.pvstatus });
  });
});

function recovery(typeRecup) {

}

/**
 * On Recup button click
 */
on("clicked:drecup-btn clicked:recovery_fast-btn clicked:recovery_full-btn", function(eventInfo) {
  const recoveryBtn = strval(eventInfo.triggerName).split(":")[1];
  const typeRecup = [ "fast", "full" ].findIndex(b => recoveryBtn === `recovery_${b}-btn`);
  const recupAttrs = [
    "dr", "dr_max", "drecup",
    "niveau", "vol",
    "pv", "pv_max",
    "pm", "pm_max",
    "cfg_highfan",
    "cfg_use_drniv",
    "cfg_use_dronly",
    "last_rolls",
  ];
  const owned = allPathRanks("rankOwned");
  const abilities = allPathRanks("rankName");
  const uses = allPathRanks("rankUseMax");
  const freqs = allPathRanks("rankUseFreq");
  getAttrs([ ...recupAttrs, ...owned, ...abilities, ...uses, ...freqs ], function(values) {
    const lsub = "Jet";
    let rsub = "Récupération";
    const highFan = boolval(values.cfg_highfan);
    const effort = highFan ? "Se dépasser" : "";
    const rolls = strval(values.last_rolls).split("|").map(r => intval(r));

    let dr = intval(values.dr);
    let drMax = intval(values.dr_max);
    if (dr === 0 && drMax !== 0) {
      const chatMsg = rollTemplate({
        lsub,
        rsub,
        text: "Plus de Dé de Récupération !",
        textclass: "fumble"
      });
      sendChatMsg(chatMsg);
      return;
    }

    const pvMax = intval(values.pv_max);
    let pv = intval(values.pv);
    if (pv === pvMax && !highFan) {
      const chatMsg = rollTemplate({
        lsub,
        rsub,
        text: "@{character_name} est déjà à son maximum de PV !",
      });
      sendChatMsg(chatMsg);
      return;
    }

    const pm = intval(values.pm);
    const pmMax = intval(values.pm_max);

    const combat = [];
    const daily = [];
    freqs.filter(attr => strval(values[attr]) !== "").forEach(attr => {
      const vr = attr.split("_")[0];
      if (!boolval(values[abilityInfo(vr).rankOwned]))
        return;
      const name = strval(values[abilityInfo(vr).rankName]);
      const uses = numval(values[abilityInfo(vr).rankUseMax]);
      if ([ "combat", "rencontre" ].includes(cleanText(values[attr])))
        combat.push({ reset: abilityInfo(vr).rankUse, name, uses });
      if ([ "jour", "journee", "repos long" ].includes(cleanText(values[attr])))
        daily.push({ reset: abilityInfo(vr).rankUse, name, uses });
    });

    /**
     * Perform recovery or push self
     * @param {number} typeRecup - recovery type 1=fast, 2=full, 3=push 
     */
    const recovery = (typeRecup) => {
      if (typeRecup !== 2 && dr > 0)
        dr -= 1;
      const dRecup = `${ (typeRecup === 1 || drMax === 0) ? "d" : "" }${values.drecup}`;
      const level = intval(values.niveau);
      const addLevel = boolval(values.cfg_use_drniv);
      const drOnly = boolval(values.cfg_use_dronly);
      let bRecup = "", bLevel = 0;
      if (!drOnly) {
        bLevel = addLevel ? level : Math.ceil(level / 2);
        bRecup = `+ ${bLevel}[Niveau${ addLevel ? "" : "/2" }] `;
      }  
      let text = `${dr} DR restants`;
      if (typeRecup === 2 && pmMax > 0)
        text = `${ pmMax - pm } PM récupérés, ` + text;
      let recup;
      let resetAbilities;
      if (typeRecup === 3) {
        rsub = effort;
        recup = `[[${rolls[0]} + 1d10 + @{vol}[VOL] ]]`;
      } else {
        rsub += " *" + (typeRecup === 1 ? "Rapide" : "Complète") + "*"
        recup = `[[${dRecup}[DR] ${bRecup}]] PV récupérés`;
        if (typeRecup === 1)
          resetAbilities = combat;
        else
          resetAbilities = combat.concat(daily);
        if (resetAbilities.length > 0)
          text += "\n" + resetAbilities.map(a => `${a.name} : ${a.uses} ${ a.uses <= 1 ? "utilisation" : "utilisations" }`).join("\n");
      }
      let chatMsg = {
        lsub,
        rsub,
        roll: recup,
        text
      };
      if (typeRecup === 3 && rolls.length > 1)
        chatMsg = { ...chatMsg, broll: `[[${rolls[1]} + 1d10 + @{vol}[VOL] ]]` };
      const chatCmd = buildChatMsg(rollTemplate(chatMsg));
      startRoll(chatCmd, roll => {
        finishRoll(roll.rollId);
        let updates = new Map([ [ "dr", dr ] ]);
        if (typeRecup !== 3) {
          pv += roll.results.roll.result;
          updates.set("pv", Math.min(pv, pvMax));
          updates.set("PVIG", Math.min(pv, pvMax));
        }
        if (typeRecup === 2 && pmMax > 0)
          updates.set("pm", pmMax);
        resetAbilities.forEach(ability => updates.set(ability.reset, 0));
        setAttrs(Object.fromEntries(updates));
      });
    }

    if (typeRecup >= 0) {
      recovery(typeRecup + 1);
      return;
    }

    const recups = [ "Rapide", "Complète" ];
    if (effort !== "")
      recups.push(effort);

    ask([ "Récupération ?", ...recups ], recovery);
  });
});

/**
 * Update the def attribute
 */
function updateDef(eventInfo) {
  getAttrs([ "sheet_type", ...SWData.PC.COMBAT.def ], function(values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;

    delete values.sheet_type;
    values.armure = intval(values.armure) * intval(values.armure_eqp);
    delete values.armure_eqp;
    values.bouclier = intval(values.bouclier) * intval(values.bouclier_eqp);
    delete values.bouclier_eqp;
    let def_car = "AGI";
    let def_car_bonus = intval(values.agi);
    if (hasAbility({ name: "peau de pierre", inPath: "pagne" }, values)) {
      const conValue = intval(values.con);
      if (conValue > def_car_bonus) {
        def_car = "CON";
        def_car_bonus = conValue;
      }
    }
    delete values.rangs_voies;
    delete values.noms_voies;
    values.agi = 0;
    values.con = 0;
    def_car_max = intval(values.def_car_max);
    def_car_bonus = def_car_max > 0 ? Math.min(def_car_bonus, def_car_max) : def_car_bonus;
    values.def_car_max = 0;
    values.def_car_bonus = def_car_bonus;
    def = addValues(values);
    logAndSet({ def, def_car, def_car_bonus }, logTitle(eventInfo));
  });
}

/**
 * Update the equipment section
 * @param {string} attribute - name of defense attribute
 */
function updateEquiped(attribute) {
  processAllGear([ "on", "nom", "props" ], function(gearIds, allGears) {
    const section = "equipement";
    const defense = attribute.replace("_eqp", "");
    getAttrs([ attribute, defense, ...allGears ], function(values) {
      const equiped = intval(values[attribute]);
      const defBonus = intval(values[defense]);

      let gears;
      if (defense === "armure")
        gears = getArmors(values, gearIds);
      if (defense === "bouclier") 
        gears = getShields(values, gearIds);
      if (defense === "casque") 
        gears = getHelmets(values, gearIds);
      if (!gears)
        return;

      const updates = new Map();

      // un-equip all armor | shields
      gears.keys().forEach(id => {
        updates.set(rptAttr(section, "equip-on", id), 0);
      });

      // equip armor | shield | helmet with def bonus
      if (equiped === 1) {
        let equipId = "";
        gears.forEach((gear, id) => {
          const gearDef = getDefBonus(gear.props, defense);
          if (gearDef == defBonus)
            equipId = id;
        });
        if (equipId !== "")
          updates.set(rptAttr(section, "equip-on", equipId), 1);
      }

      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates), { silent: true });
    });
  });
}

/**
 * On DEF components change
 */
on(changeEvent(SWData.PC.COMBAT.def), function(eventInfo) {
  updateDef(eventInfo);
  const attribute = strval(eventInfo.triggerName, "");
  if (attribute.endsWith("_eqp"))
    updateEquiped(attribute);
});

on("change:casque_eqp", function() {
  updateEquiped("casque_eqp");
});

/**
 * On Luck apply button click
 */
on("clicked:luck_apply-btn", function() {
  getAttrs([ "pc", "last_rolls", "cfg_pc_var", "cfg_shadow" ], function(values) {
    const shadow = boolval(values.cfg_shadow);
    const pcLabel = `Point de ${ shadow ? "Choc" : "Chance" }`;
    const pcMin = shadow ? -5 : 0;
    const lsub = "Utilisation";
    const rsub = pcLabel;
    let pc = intval(values.pc);
    if (pc === pcMin) {
      const chatMsg = rollTemplate({
        lsub,
        rsub,
        text: `Plus de ${pcLabel} !`,
        textclass: "fumble"
      });
      sendChatMsg(chatMsg);
      return;
    }

    const luck = shadow ? "1d12" : boolval(values.cfg_pc_var) ? "1d10" : "10";
    pc -= 1;
    const [ last_roll, last_broll ] = strval(values.last_rolls).split("|");
    let roll = "[[" + luck + (last_roll !== "" ? ` + ${last_roll} ` : "" ) + "]]";
    if (last_broll)
      roll += " | [[" + luck + ` + ${last_broll} ` + "]]";
    const chatMsg = rollTemplate({
      lsub,
      rsub,
      roll,
      text: `${pc} ${pcLabel} restants`,
      save: "[[0]]"
    });
    sendChatMsg(chatMsg);
    setAttrs({ pc });
  });
});

/**
 * On Luck roll button click
 */
on("clicked:luck_roll-btn", function() {
  getAttrs([ "cfg_shadow" ], function(values) {
    const pcLabel = boolval(values.cfg_shadow) ? "Choc" : "Chance";
    const chatMsg = rollTemplate({
      lsub: "Jet",
      rsub: pcLabel,
      roll: `[[ 1d6![Dé] + @{pc}[Points de ${pcLabel} restants] ]]`,
      save: "[[0]]"
    });
    sendChatMsg(chatMsg);
  });
});

/**
 * On Help button click (assistant character)
 */
on("clicked:help_other-btn", function() {
  getAttrs([ "character_name", "last_rolls" ], function(values) {
    const helpRoll = numval(strval(values.last_rolls).split("|")[0]);
    const helpBonus = helpRoll < 10 ? 0 : helpRoll >= 20 ? 4 : 2;
    if (helpBonus === 0)
      return;
    const help_roll = `${helpBonus}~${ strval(values.character_name) }~${ new Date().toISOString() }`; // make it unique with datetime
    const chatCmd = chatSetAttr({ silent: true, select: "--charid @{target|character_id}" }, { help_roll });
    sendChatCmd(chatCmd);
  });
});

/**
 * On Help field change (assisted character)
 */
on("change:help_roll", function() {
  getAttrs([ "help_roll", "help_roll_all" ], function(values) {
    const [ bonus, charName ] = strval(values.help_roll).split("~");
    const helpRoll = ` +[[${bonus}]][Aide ${charName}]`;
    let helpAllRolls = strval(values.help_roll_all);
    if (!helpAllRolls.includes(helpRoll)) {
      helpAllRolls += helpRoll;
      setAttrs({ help_roll_all: helpAllRolls });
    }
  });
});

/**
 * Roll evolutive die
 */
on("clicked:devol-btn", function() {
    askValue("Nombre de dés ?", function(dice) {
    const chatMsg = rollTemplate({
      lsub: "Jet",
      rsub: "Dé évolutif",
      roll: `[[${dice}@{devol}]]`
    });
    sendChatMsg(chatMsg);
  });
});

/**
 * Return a Map of attribute buffs values
 * @param {number} hasCondition - set/unset condition flag
 * @param {object} effects - key/value pairs of attributes and debuffs
 * @param {string[]} buffs - list of attribute names
 * @param {object} values - list of attribute values as returned by getAttrs()
 * @returns {Map}
 */
function setCondition(hasCondition, effects, buffs, values) {
  const attributes = new Map();
  const toggle = hasCondition === 1 ? +1 : -1;
  buffs.forEach(buff => {
    const [ attribute ] = buff.split("_");
    const newValue = intval(values[buff]) + toggle * effects[attribute];
    attributes.set(buff, newValue);
  });
  return attributes;
}

/**
 * Return attack name given attribute name
 * @param {string} attribute - attack score attribute
 * @returns {string}
 */
function getAttackName(attribute) {
  const found = SWData.PC.COMBAT.attacks.find(attack => {
    const [ atkAttr ] = attack;
    return atkAttr === attribute;
  });
  if (!found)
    return "";
  const [ name ] = found.slice(2);
  return name;
}

/**
 * Return the list of conditions attributes
 * @returns {string[]}
 */
function allConditions() {
  return SWData.PC.CONDITIONS.map(condition => `condition_${ condition.name }`);
}

/**
 * Display a chat message with a condition effects
 * @param {string} label - Condition name
 * @param {object} effects - key/value pairs of attributes and mods
 * @param {string[]} description - list of additional effects
 * @param {number} notify - 1 = public, 2 = whispered
 */
function displayCondition(label, effects, description, notify) {
  const malus = [];
  Object.keys(effects).forEach(attribute => {
    let name = "";
    switch (attribute) {
      case "init":
        name = "Initiative";
        break;
      case "def":
        name = "Défense";
        break;
      default:
        name = "Attaque " + getAttackName(attribute);
        break;
    }
    malus.push(`${effects[attribute]} en ${name}`);
  });
  text = [ "@{character_name} subit les effets suivants :", ...malus, ...description ].join("\n");
  const chatMsg = rollTemplate({
    lsub: "Condition",
    rsub: label,
    text
  });
  const whisper = (notify === 2) ? "gm" : "";
  sendChatMsg(chatMsg, {
    ...SWData.RT_OPTIONS,
    whisper
  });
}

/**
 * Update condition attributes & buffs
 */
SWData.PC.CONDITIONS.forEach(condition => {
  const { name, label, effects, description } = condition;

  // Set/Unset conditions
  on(`clicked:${name}-icon`, function () {
    const buffs = Object.entries(effects).map(([ attribute ]) => `${attribute}_cond`);
    getAttrs([ "conditions_markers", `condition_${name}`, ...buffs ], function(values) {
      const [ markers, attribute, ...buffs ] = Object.keys(values);
      const hasCondition = 1 - intval(values[attribute]);
      const updateAttrs = setCondition(hasCondition, effects, buffs, values);
      updateAttrs.set(attribute, hasCondition);
      const updMarkers = strval(values[markers]).split("|").filter(m => !m.endsWith(name));
      updMarkers.push(`${hasCondition === 1 ? "+" : "-" }cof-${name}`);
      updateAttrs.set("conditions_markers", updMarkers.filter(m => m !== "").join("|"));
      setAttrs(Object.fromEntries(updateAttrs));
    });
  });

  // Display enabled condition
  on(`change:condition_${name}`, function() {
    getAttrs([ `condition_${name}`, "notif_conditions" ], function(values) {
      const [ attribute ] = Object.keys(values);
      const hasCondition = intval(values[attribute]);
      const notify = intval(values.notif_conditions);

      if (hasCondition === 1 && notify !== 0)
        displayCondition(label, effects, description, notify);
    });
  });
});

/**
 * Update token markers
 */
on("change:conditions_markers", function() {
  getAttrs([ 
    "character_name", "conditions_markers",
    "tokenmod", "tkmarker_cond"
  ], function (values) {
    const statusmarkers = strval(values.conditions_markers);
    if (statusmarkers === "")
      return;
    const tokenmod = boolval(values.tokenmod);
    const markConditions = boolval(values.tkmarker_cond);
    if (!tokenmod || !markConditions)
      return;
    sendChatCmd(tokenMod(strval(values.character_name), { statusmarkers }));
  });
});

/**
 * Return matches for pattern in text
 * @param {string} text - text to match
 * @param {RegExp} pattern - regular expression
 * @returns {string[]}
 */
function matchRegExp(text, pattern) {
  return [ ...text.matchAll(pattern) ];
}

/**
 * Get the path number from the path name
 * @param {string} name - ability qualifier ('rang voie 1', 'rang voie <name>', 'rang <name>')
 * @param {string[]} names - list of path names
 * @returns {number}
 */
function findPathByName(name, names) {
  const q = name.replace(/\s\s+/g, " ").trim().split(" ").slice(1) || [];
  if (q.length === 0)
    return 0;

  const qualifier = q.slice(q.length - 1).join(" ");
  if (qualifier === "")
    return 0;

  if (q[0].toLowerCase() === "voie") {
    if (Number.isInteger(intval(qualifier)) && intval(qualifier) > 0) {
      return intval(qualifier);
    }
  }

  const pathNumber = names.findIndex(pathName => pathName.toLowerCase() === qualifier.toLowerCase());

  return pathNumber + 1;
}

/**
 * Substitute expressions with in-line rolls
 * @param {string}    text - text to process
 * @param {object}    options - options
 * @param {string[]}  options.pathNames - list of path names
 * @param {boolean}   options.isNPC - processing NPC abilities 
 * @param {string}    options.companionOf - name of PC the NPC is a companion of (ends with |)
 * @returns {string}
 */
function insertRolls(text, options = {}) {
  if (!text)
    return "";
  
  if (text.match(/\[\[.+\]\]/))
    return text;

  const { pathNames = [], isNPC = false, companionOf = "" } = options;
  if (isNPC && companionOf !== "")
    companionOf += "|";
  const devol = `@{${ isNPC ? companionOf : "" }devol}`;
  
  // Search for " [#d4° + XXX] " or " [#dE + XXX] "
  matchRegExp(text, /([ ]*)\[([1-9])d(4°|E)[ ]*\+[ ]*(AGI|CON|FOR|PER|CHA|INT|VOL|rang voie [1-9])\]([ ]*)/gm).forEach(result => {
    let [ matched, sb, dice, , stat, sa ] = result;
    if (stat.startsWith("rang "))
      stat = `rang_voie${ findPathByName(stat, pathNames) }`;
    const replace = `${sb}[[${dice}${devol} + @{${stat.toLowerCase()}}[${stat}] ]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for "... #d4° ..." or "... #dE ..."
  matchRegExp(text, /([ ]*)([1-9])d(4°|E)([ ]*)/gm).forEach(result => {
    const [ matched, sb, dice, , sa ] = result;
    const replace = `${sb}[[${dice}${devol}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for " [# + XXX] "
  matchRegExp(text, /([ ]*)\[([0-9]+)[ ]*\+[ ]*(AGI|CON|FOR|PER|CHA|INT|VOL|rang voie [1-9])\]([ ]*)/gm).forEach(result => {
    let [ matched, sb, value, ability, sa ] = result;
    if (ability.startsWith("rang ")) {
      ability = `rang_voie${ findPathByName(ability, pathNames) }`;
    }
    const replace = `${sb}[[${value} + @{${ability.toLowerCase()}}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for " [XXX] "
  matchRegExp(text, /([ ]+)\[(AGI|CON|FOR|PER|CHA|INT|VOL|NIV|NIVEAU|NC|NOM)\]([ ]+)/gm).forEach(result => {
    let [ matched, sb, ability, sa ] = result;
    if (ability === "NIV")
      ability = "niveau";
    if (ability === "NOM")
      ability = "character_name";
    const replace = `${sb}[[@{${ability.toLowerCase()}}]]${sa}`;
    text = text.replace(matched, replace);
  });

  // Search for "... #d# +/- X..."
  matchRegExp(text, /([0-9]+d[0-9]+)([ ]*[\+\-]*[ ]*[0-9]*)?/gm).forEach(result => {
    const [ matched, dice, mod ] = result;
    const replace = `[[${dice}${ strval(mod).trim() }]] `;
    text = text.replace(matched, replace);
  });
  
  return text;
}

/**
 * Numbering PC attacks 
 */
on("change:repeating_armes:arme-nom clicked:renum_atk-btn", function(eventInfo) {
  const renumber = (eventInfo.triggerName === "clicked:renum_atk-btn");
  let atkId = "";
  if (!renumber)
    atkId = strval(eventInfo.triggerName.split("_")[2]);
  getSectionIDsOrdered("repeating_armes", function (rowIds) {
    const labels = rowIds.map(id => rptAttr("armes", "arme-label", id));
    getAttrs([ "character_name", "max_attack_label", "scriptVersion", ...labels ], function (values) {
      const updates = new Map();

      if (!renumber) {
        // display attack options row if script detected
        updates.set(rptAttr("armes", "armeopt"), hasMODScript(values) ? 1 : 0);
        // update roll button linked attribute
        const atkBtn = rptAttr("armes", "attack-btn", atkId);
        updates.set(atkBtn, `%{${ strval(values.character_name) }|${atkBtn}}`);
      }
      
      const maxLabel = intval(values.max_attack_label);
      let numLabel = renumber ? 0 : maxLabel;
      labels.forEach(label => {
        if (renumber || intval(values[label]) === 0)
          updates.set(label, ++numLabel);
        updates.set(label.replace("label", "showlbl"), hasMODScript(values) ? 1 : 0);
      });
      if (renumber || numLabel > maxLabel)
        updates.set("max_attack_label", numLabel);

      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  });
});

/**
 * Display attack options row
 */
on("clicked:repeating_armes:armeopt-btn clicked:repeating_npcarmes:armeopt-btn", function(eventInfo) {
  const { section } = rptInfo(eventInfo.triggerName);
  const toggle = rptAttr(section, "armeopt");
  getAttrs([ toggle ], function(values) {
    const option = 1 - intval(values[toggle]);
    setAttrs({ [toggle]: option });
  });
});

/**
 * Return list of ongoing effect attributes
 * @returns {string[]}
 */
function ongoingAttrs() {
  return [ "effet", "nom", "duree", "stop" ];
}

/**
 * Update ongoing effect for attack
 */
on(ongoingAttrs().map(attr => `change:repeating_armes:etendu-${attr}`).join(" "), function() {
  getAttrs(ongoingAttrs().map(attr => rptAttr("armes", "etendu-" + attr)), function(values) {
    const ongoing = Object.keys(values)
    .map(k => strval(values[k]))
    .filter(v => v !== "")
    .join(" ");
    setAttrs({ [rptAttr("armes", "arme-etendu")]: ongoing });
  });
})

/**
 * Roll ongoing effect for attack
 */
on("clicked:repeating_armes:ongoing-btn", function() {
  const rptName = rptAttr("armes", "arme-nom");
  getAttrs([
    rptName,
    ...ongoingAttrs().map(attr => rptAttr("armes", "etendu-" + attr))
  ], function(values) {
    let effect = strval(values[rptAttr("armes", "etendu-effet")]);
    effect = insertRolls(" " + effect + " ").trim();
    let name = strval(values[rptAttr("armes", "etendu-nom")]);
    if (name === "")
      name = strval(values[rptName]);
    let stop = strval(values[rptAttr("armes", "etendu-stop")]);
    if (stop === "")
      stop = "Pendant " + strval(values[rptAttr("armes", "etendu-duree")]);
    const text = [ effect, stop ].filter(v => v !== "").join("\n");

    // send to chat
    const rollProps = {
      lsub: "Effet",
      rsub: name,
      text
    };
    
    sendChatMsg(rollTemplate(rollProps));
  });
});

/**
 * Display in-hand / thrown / trait weapon options
 */
on("change:repeating_armes:arme-atktype change:repeating_npcarmes:arme-atktype", function(eventInfo) {
  const { section } = rptInfo(eventInfo.triggerName);
  const attr = rptAttr(section, "arme-atktype");
  getAttrs([ attr, "scriptVersion" ], function(values) {
    const type = strval(values[attr]);
    let reset = {};
    if (type !== "trait")
      reset = { [rptAttr(section, "jet-resid")]: "" };
    setAttrs({
      [rptAttr(section, "arme-main")]: (type === "main" && hasMODScript(values)) ? 1 : 0,
      [rptAttr(section, "arme-jet")]: type === "jet" ? 1 : 0,
      [rptAttr(section, "arme-trait")]: type === "trait" ? 1 : 0,
      ...reset
    });
  });
});

/**
 * Return if attack is combat
 * @param {string} atkAttr - attack attribute
 * @returns {boolean}
 */
function isCombat(atkAttr) {
  return [ "atkcac", "atktir" ].includes(atkAttr);
}

/**
 * Return if attack is ranged
 * @param {string} atkAttr - attack attribute
 * @param {string} range - range value
 * @returns {boolean}
 */
function isRanged(atkAttr, range) {
  return (atkAttr === "atktir" && range !== "");
}

/**
 * Return if weapon is thrown
 * @param {string} type - weapon type
 * @returns {boolean}
 */
function isThrown(type) {
  return [ "jet", "trait" ].includes(type);
}

/**
 * Return if critical hit table used
 * @param {object} values - Roll20 getAttrs() object
 * @param {string} [npc=""] - NPC flag ("npc" | "")
 * @returns {boolean}
 */
function useCriticalHit(values, npc = "") {
  const useCritTable = boolval(values.cfg_tbl_crit);
  const attack = (npc === "npc") ? "atkcac" : strval(values[rptAttr(`${npc}armes`, "arme-atk")]);
  const dmType = strval(values[rptAttr(`${npc}armes`, "arme-dmtype")]);
  return useCritTable && isCombat(attack) && (SWData.ATTACKS.CS[dmType]);
}

/**
 * Return critical hit effect
 * @param {object} values - Roll20 getAttrs() object
 * @param {string} [npc=""] - NPC flag ("npc" | "")
 * @returns {string}
 */
function criticalHit(values, npc = "") {
  const dmType = strval(values[rptAttr(`${npc}armes`, "arme-dmtype")]);
  const critDie = strval(values.cfg_tbl_critdie, "20");
  const roll = critDie === "20b" ? Math.max(getRandom(20), getRandom(20)) : getRandom(numval(critDie));
  const effect = SWData.ATTACKS.CS[dmType][roll - 1];
  if (effect === "")
    return "";
  return `[${roll}] ${effect}`;
}

/**
 * Return if fumble table used
 * @param {object} values - Roll20 getAttrs() object
 * @returns {boolean}
 */
function useFumbleTable(values, npc = "") {
  const useFumbleTable = boolval(values.cfg_tbl_fumble);
  const attack = (npc === "npc") ? "atkcac" : strval(values[rptAttr("armes", "arme-atk")]);
  return useFumbleTable && isCombat(attack);
}

/**
 * Return fumble effect
 * @param {object} values - Roll20 getAttrs() object
 * @returns {string}
 */
function fumbleRoll(values) {
  return strval(values.character_name) + " " + SWData.ATTACKS.CF[getRandom(8) - 1];
}

/**
 * Return range expressed with meters
 * @param {string} portee - range as entered on attack line
 * @param {number} extra - additional range
 * @returns {string}
 */
function rangeWithUnits(portee, extra = 0) {
  portee = portee.replaceAll(" ", "");
  if (portee.toLowerCase().endsWith("m"))
    portee = portee.substring(0, portee.length - 1);
  return `${ intval(portee) + intval(extra) } m`;
}

/**
 * Return the roll query for maneuvers
 * @param {number} cha - CHA stat value
 * @returns {string}
 */
function maneuversRollQuery(cha) {
  const maneuvers = SWData.PC.COMBAT.maneuvers.map(mn => {
    const [ title ] = mn.name.split(" ");
    mn.name = mn.name.replace("{{cha}}", cha);
    mn.name += mn.name.includes("(") ? "" : " (" + mn.mod + ")";
    mn.mod = mn.mod.replace("{{cha}}", cha);
    return `${mn.name},[[${ mn.mod === "-" ? "0" : mn.mod }]][${title}]`;
  }).join("|");
  return " +(?{Manoeuvre ?|Aucune,0|" + maneuvers + "})";
}

/**
 * Roll an attack in chat
 */
on("clicked:repeating_armes:attack-btn", function(eventInfo) {
  const { rowId: attackId } = rptInfo(eventInfo.triggerName);
  const section = "repeating_armes_arme-";
  const rptThrown = "repeating_armes_jet-";
  const rptOngoing = "repeating_armes_etendu-";
  const attackAttrs = [
    "nom", "atk", "atkdiv", "crit", "2m",
    "dm", "dmtype", "bonus", "dmdiv",
    "portee", "special",
    "atktype", "atkmods", "options", "usure"
  ];
  const sitModAttrs = [
    "couvert",
    "melee",
    "contact",
    "visibilite"
  ];
  getAttrs([
    "scriptVersion",
    "character_name",
    "cfg_1attack_roll", "cfg_cible",
    "cfg_d20roll", "d20roll",
    "cfg_crit_diff", "cfg_tbl_crit", "cfg_tbl_fumble",
    "cfg_use_ammo", "cfg_usure",
    "cfg_lowfan", "cfg_shadow", "pc",
    "atkcac", "atktir", "atkmag",
    "agi_dsup", "per_dsup", "cha",
    "bouclier_eqp",
    "condition_affaibli", "condition_immobilise",
    ...fearConditionsAttrs(),
    "tactique",
    "tactautre", "tactroll", "tactname", "tactdiv", "tactdmdiv",
    "noms_voies", "rangs_voies",
    "en_selle",
    ...luckButtonAttrs(),
    ...sitModAttrs.map(attr => `modsit_${attr}`),
    ...attackAttrs.map(attr => rptAttr("armes", `arme-${attr}`)),
    ...[ "resid", "nbre" ].map(attr => rptAttr("armes", `jet-${attr}`)),
    "dm_buff_list", "allattacks_buff", "allattacks_desc",
    ...ongoingAttrs().map(attr => rptAttr("armes", `etendu-${attr}`)),
  ], function (values) {
    
    // general options
    const useOneRoll = intval(values.cfg_d20roll) === 0
    ? boolval(values.cfg_1attack_roll)
    : true;
    const useCritDiff = intval(values.cfg_crit_diff);
    const useAmmo = boolval(values.cfg_use_ammo);
    const useWear = boolval(values.cfg_usure);
    const shieldUsed = boolval(values.bouclier_eqp);
    const tactics = intval(values.tactique);
    const tactOther = boolval(values.tactautre);
    const tactName = strval(values.tactname, "Option tactique");
    const tactBM = intval(values.tactdiv);
    const tactRoll = intval(values.tactroll);
    const tactDM = strval(values.tactdmdiv);
    const weakened = intval(values.condition_affaibli);
    const restrained = intval(values.condition_immobilise);
    const pathNames = getPathNames(strval(values.noms_voies));
    const mounted = boolval(values.en_selle);
    
    // situational modifiers
    let modCover = intval(values.modsit_couvert) * -1;
    const modMelee = intval(values.modsit_melee) * -1;
    const modContact = intval(values.modsit_contact);
    const modVisible = intval(values.modsit_visibilite) * -1;
    
    // attack parameters
    const atk = strval(values[section + "atk"]);
    const atkdiv = intval(values[section + "atkdiv"]);
    const name = capitalize(strval(values[section + "nom"], getAttackName(atk)), false);
    const atkMod = ` *${ displayMod(intval(values[atk]) + intval(values.atkdiv)) }*`;
    const portee = strval(values[section + "portee"]);
    let range = (portee !== "") ? ` *(${ rangeWithUnits(portee) })*` : "";
    let crit = intval(values[section + "crit"], 20);
    const atkType = strval(values[section + "atktype"]);
    const modifiers = strval(values[section + "atkmods"]).split(",").map(mod => mod.trim().toLowerCase());
    const options = strval(values[section + "options"]);
    const usure = strval(values[section + "usure"]);
    const resourceId = strval(values[`${rptThrown}resid`]);
    const resourceNbr = Math.max(1, intval(values[`${rptThrown}nbre`]));

    // DM + all attacks buffs 
    const dmBuffs = strval(values.dm_buff_list).split(";").map(b => b.trim());
    const allAtkBuffs = allRollsBuff(values, "attacks");

    // 2 mains & bouclier 
    const twoHanded = boolval(values[section + "2m"]);
    if (atk !== "atkmag" && twoHanded && shieldUsed) {
      sendChatMsg(rollTemplate({
        lsub: "Attaque",
        rsub: name,
        text: `@{character_name} ne peut pas manier ${name} avec son bouclier équipé !`,
        textclass: "fumble"
      }));
      return;
    }

    let atkTitle = "Attaque";
    const allTags = getAllTags(values);

    const extraDM = [];

    // Magic weapon
    let magicHit = "";
    let magicDM = "";
    const magicProps = {
      full: hasAtkMod(modifiers, "magie"),
      att: hasAtkMod(modifiers, "magieAtt"),
      dm: hasAtkMod(modifiers, "magieDmg"),
    };
    if (Object.values(magicProps).some(p => p)) {
      if (magicProps.full) {
        magicHit = ` +${ intval(getAtkMod(modifiers, "magie")) }`;
        magicDM = magicHit;
        allTags.push("Magique: " + magicHit);
      }
      if (magicProps.att) {
        magicHit = ` +${ intval(getAtkMod(modifiers, "magieAtt")) }`;
        allTags.push("Magique: " + magicHit + " (att)");
      }
      if (magicProps.dm) {
        magicDM = ` +${ getAtkMod(modifiers, "magieDmg") }`;
        allTags.push("Magique: " + magicDM + " (DM)");
        if (magicDM.match(/ \+([1-9]d)/)) {
          magicDM = ` +${ insertRolls(" " + getAtkMod(modifiers, "magieDmg") + " ").trim() }`;
        }
      }
      magicHit += magicHit !== "" ? "[Magique]" : "";
      magicDM += magicDM !== "" ? "[Magique]" : "";
    }

    // Special tactics
    let tacticBonus = "";
    switch (tactics) {
      case 1:
        atkTitle = "Attaque assurée";
        tacticBonus = ` +5[${atkTitle}]`;
        break;
      case 2:
        atkTitle = "Attaque précise";
        tacticBonus = ` -3[${atkTitle}]`;
        extraDM.push(` + [[1@{devol}]] ${atkTitle}`);
        break;
      case 3:
        atkTitle = "Attaque violente";
        tacticBonus = ` -7[${atkTitle}]`;
        extraDM.push(` + [[2@{devol}]] ${atkTitle}`);
        break;
    }
    if (tactOther) {
      if (tactBM !== 0)
          tacticBonus += ` + (${tactBM})[${tactName}]`;
      if (tactDM !== "")
        extraDM.push(` + ([[${ replaceDevol(tactDM) }]]) ${tactName}`);
      if (tactRoll === 1)
        modifiers.push("debonus");
      if (tactRoll === 2)
        modifiers.push("demalus");
    }

    // Build situational modifiers
    let modSit = "";
    if (isRanged(atk, portee)) {
      if (hasAbility({ name: "joli coup", inPath: "precision" }, values)) {
        if (modCover === -2)
          modCover = 0;
        if (modCover === -5)
          modCover = -2;
      }
      modSit += modCover !== 0 ? ` ${modCover}[Cible à couvert]` : "";
      modSit += modMelee !== 0 ? ` ${modMelee}[Cible en mêlée]` : "";
      modSit += modVisible !== 0 ? ` ${modVisible}[Visibilité]` : "";
      if (hasAbility({ name: "tir precis", inPath: "precision" }, values))
        crit = 19;
      if (hasAbility({ name: "tir fatal", inPath: "precision" }, values))
        crit = 18;
    }

    if (hasAtkMod(modifiers, "affutee")) {
      crit = Math.max(16, crit - 1);
    }

    // Determine normal or bonus / malus die roll
    const withMalusDie = (weakened === 1) || (restrained === 1);
    let roll = withMalusDie ? "2d20kl1" : "1d20";
    let bRoll = !withMalusDie;
    if (isRanged(atk, portee) && modContact === 1)
      roll = "2d20kl1";
    const hasBonusDie = modifiers.includes("debonus");
    const hasMalusDie = modifiers.includes("demalus");
    if (hasBonusDie && !hasMalusDie) {
      switch(roll) {
        case "2d20kl1":
          roll = "1d20";
          bRoll = false;
          break;
        case "1d20":
          roll = "2d20kh1";
          break;
      }
    }
    if (hasMalusDie && !hasBonusDie) {
      switch(roll) {
        case "1d20":
          roll = "2d20kl1";
          break;
        case "2d20kh1":
          roll = "1d20";
          bRoll = false;
          break;
      }
    }

    if (bRoll && useOneRoll)
      bRoll = false;
    
    let fumble = "1";

    let powder = "";
    if (modifiers.includes("poudre")) {
      powder = "La poudre explose et inflige [[1@{devol}]] DM";
      fumble = "<2";
    }

    // Peur
    const fear = fearConditionMalus(values);

    // Valeur d'Ombre
    const shadow = shadowValue(values);

    // Manoeuvres
    const maneuvers = modifiers.includes("manoeuvres") ? maneuversRollQuery(intval(values.cha)) : "";

    // Attack roll
    let attack = "";
    if (!hasMalusDie && !hasBonusDie)
      roll = d20Roll(roll, strval(values.d20roll), { cf: fumble, cs: `>${crit}` });
    else
      roll = rollCfCs(roll, { cf: fumble, cs: `>${crit}` });
    if (atk !== "0")
      attack = `[[${roll}[Dés] + @{${atk}}[Bonus]${magicHit}${fear}${shadow.malus} + ${atkdiv}[Divers]${allAtkBuffs}${tacticBonus}${modSit}${maneuvers} ]]`;
    
    // Damage roll
    let [ dm, ...dmextra ] = strval(values[section + "dm"]).split(" ");
    dm = replaceDevol(dm);
    if (dm.includes("/")) {
      const [ dm1m, dm2m ] = dm.split("/");
      dm = shieldUsed ? dm1m : `?{Maniée à|Une main,${dm1m}|Deux mains,${dm2m}}`;
    }

    if (atkType === "sort") {
      allTags.push("Sort");
      if (hasAtkMod(modifiers, "zone")) {
        dm = `?{Sort de zone, privilégier|Cible,${dm}|Allié,floor(${dm}/2)}`;
        allTags.push("Zone");
      }
    }
    
    const dmtype = strval(values[section + "dmtype"]);
    const dmdesc = [ dmtype, ...dmextra ].join(" ").trim();
    const dmbonus = strval(values[section + "bonus"]);
    const dmdiv = strval(values[section + "dmdiv"]);
    let dmAbilities = "";

    if (boolval(values.cfg_lowfan))
      modifiers.push("explodemax");

    let dmOpt = "";
    if (modifiers.includes("explodemax") && !dm.includes("!"))
      dmOpt += "!";
    if (modifiers.includes("reroll1")) {
      if (numval(getAtkMod("reroll1")) === 1)
        dmOpt += "ro";
      else
        dmOpt += "r";
    }
    
    // mounted extra DM
    if (mounted && atk === "atkcac") {
      if (hasAbility({ name: "monture fantastique", inPath: "cavalier" }, values)) {
        dmAbilities += " +2[Monture fantastique]";
      } else if (hasAbility({ name: "cavalier emerite", inPath: "cavalier" }, values)) {
        dmAbilities += " +1[Cavalier émérite]";
      }
    }

    // firearms extra DM
    if (modifiers.includes("poudre")) {
      let powderBonus = 0;
      if (hasAbility({ name: "poudre puissante", inPath: "explosifs" }, values)) {
        powderBonus = 1 + getPathsWithRank({ profile: "arquebusier", minRank: 5 }, values);
        range = " *(" + "``" + rangeWithUnits(portee, 10) + "``" + ")*";
      }
      if (powderBonus > 0)
        dmAbilities +=` + ${powderBonus}[Poudre puissante]`;
    }

    // DM buffs
    dmBuffs.filter(b => b !== "").forEach(buff => {
      let [ buffName, buffDM ] = buff.split(":").map(s => s.replaceAll("|", " ").trim());
      buffDM = replaceDevol(buffDM);
      if (buffName.charAt(0) === "?") {
        buffName = buffName.slice(1).trim();
        const delim = "&";
        let moreDM = buffDM;
        buffDM = buffDM.split(delim)[0];
        let buffMore = "";
        while (moreDM.includes(delim)) {
          const [ dm, ...dms ] = moreDM.split(delim).slice(1);
          const [ label, value ] = dm.split("=").map(v => v.trim());
          buffMore += `|${label},${value}`;
          moreDM = [ ...dms ].join(delim);
        }
        buffDM = `?{${buffName} (DM)|Non,0|Oui,${buffDM}${buffMore}}`;
      }
      const matched = buffDM.match(/\[(.+)\]/);
      if (matched) {
        const [ match, name ] = matched;
        buffDM = buffDM.replace(match, `@{${ name.toLowerCase() }}`);
      }
      extraDM.push(` + [[${buffDM}]] ${buffName}`);
    });

    let dmroll = "";
    if (dm !== "" )
      dmroll = `${dm}${dmOpt} + ${dmbonus}[Bonus]${magicDM}${ shadow.dm } + ${dmdiv}[Divers]${dmAbilities}`;
    if (dmroll !== "" && tactics === 1)
      dmroll = `floor((${dmroll})/2)`;
    if (dmroll !== "")
      dmroll = `[[${dmroll} ]]`;

    let special = insertRolls(strval(values[section + "special"]), { pathNames });

    if (hasAtkMod(modifiers, "fleau")) {
      const [ ...curse ] = strval(getAtkMod(modifiers, "fleau")).split(" ");
      extraDM.push(`?{Contre ${ curse.join(" ").toUpperCase() } ?|Oui,+[[1@{devol}]] DM Fléau des ${ curse.join(" ") }|Non,&nbsp;}`);
    }

    if (hasAtkMod(modifiers, "element")) {
      const [ ...element ] = strval(getAtkMod(modifiers, "element")).split(" ");
      if ("aeioué".includes(element[0].charAt(0)))
        element[0] = "d'" + element[0];
      else
        element.unshift("de");
      extraDM.push(`+[[${ strval(element[1]).trim().toLowerCase() === "intense" ? "2" : "1" }@{devol}]] DM ${ element.join(" ") }`);
    }

    // Determine Max DMs
    let dmMax = 0;
    const result = dm.match(/([0-9]*)[dD]([0-9]*)/);
    if (result) {
      let [ matched, dice, faces ] = result;
      if (matched) {
        if (!dice)
          dice = 1;
        dmMax = intval(dice) * intval(faces);
      }
    }

    // Special critical success
    let dmcrit = "";
    if (useCritDiff === 1) {
      switch (dmtype) {
        case "contondants":
          dmcrit = `[[${dmMax}]] DM et cible étourdie au prochain round`;
          break;
        case "perforants":
          if (dice && faces)
            dmcrit = `[[${dice * 2}d${faces}]] DM + hémorragie : [[1@{devol}]] DM pendant 4 rounds`;
          break;
        case "tranchants":
          dmcrit = `[[${dmMax}]] DM et hémorragie : [[1@{devol}]] DM pendant 4 rounds`;
          break;
      }
    }

    if (hasAtkMod(modifiers, "affutee")) {
      dmcrit += "Affûtée : +[[1@{devol}]] DM";
    }

    // Play FX !
    const fxValue = strval(getProp(options, "fx"));
    if (!hasMODScript(values) && fxValue !== "")
      playFX(fxValue);

    const rollOptions = {};
    
    // Critical hit table
    rollOptions.critical = useCriticalHit(values);
    const critHit = rollOptions.critical ? criticalHit(values) : "";
    rollOptions.crit = rollOptions.critical ? crit : 0;

    // Fumble table
    rollOptions.fumble = useFumbleTable(values);
    const fumbleEffect = rollOptions.fumble ? fumbleRoll(values) : "";

    // Check special effect on die roll
    let rollEffect = "";
    if (!hasMODScript(values) && hasProp(options, "effet")) {
      const [ tn, ...effect ] = getProp(options, "effet").replace(/\s\s+/g, " ").split(" ");
      rollOptions.rollTN = intval(tn.trim());
      rollEffect = effect.join(" ").trim();
    }

    // Roll attack !
    const atkProps = {
      lsub: atkTitle.replace("/", " /\n"),
      rsub: name + atkMod + range,
      roll: attack,
      broll: "",
      rollf: "[[0]]",
      brollf: "[[0]]",
      rolleffect: rollEffect,
      dm: dmroll,
      dmdesc,
      critdiff: `[[${useCritDiff}]]`,
      dmcrit,
      powder,
      text: special,
      chance: addLuckButton(values),
      usure: "",
      critsuccess: "",
      bcritsuccess: "",
      crithit: "",
      critfail: "",
      fumbletest: "",
      fumble: "",
      tohit: "",
      target: "",
      targetname: ""
    };

    if (roll.startsWith("1d20") && bRoll)
      atkProps.broll = attack;

    if(extraDM.length > 0)
      atkProps.dmextra = extraDM.join("\n");

    if (useWear) {
      if (atkType === "main" || isThrown(atkType)) {
        atkProps.usure = "[[1d10]]";
        rollOptions["usure"] = { attackId, value: usure, name };
      }
    }

    if (rollOptions.critical) {
      atkProps.critsuccess = "[[0]]";
      atkProps.crithit = critHit;
      if (atkProps.broll !== "")
        atkProps.bcritsuccess = "[[0]]";
    }

    if (rollOptions.fumble) {
      atkProps.critfail = "[[0]]";
      const stat = isRanged(atk, portee) ? "per" : "agi";
      const stat_dsup = `@{${stat}_dsup}`;
      const stat_mod = `@{${stat}}[${ stat.toUpperCase() }]`;
      atkProps.fumbletest = `[[${stat_dsup} + ${stat_mod} ]]`;
      atkProps.fumble = fumbleEffect;
    }

    if (boolval(values.cfg_cible)) {
      atkProps.tohit = SWData.settings.tokens.target.def;
      atkProps.target = SWData.settings.tokens.target.name;
      atkProps.targetname = `[[0[${atkProps.target}] ]]`;
    }
    
    const chatMsg = rollTemplate(atkProps, { tags: allTags });
    sendChatMsg(chatMsg, rollOptions);
    
    if (tactics > 0)
      setAttrs({ tactique: "0" });

    if (useAmmo && resourceId !== "" && resourceNbr > 0) {
      const resVal = rptAttr("ressources", "res-val", resourceId);
      getAttrs([ resVal ], function(values) {
        const munitions = Math.max(0, intval(values[resVal]) - resourceNbr);
        setAttrs({ [resVal]: munitions });
      });
    }

    const ongoingPrms = ongoingAttrs().map(attr => strval(values[rptOngoing + attr]));
    if(ongoingPrms.some(v => v !== "")) {
      const [ ogEff, ogName, ogTime ] = ongoingPrms;
      let effectName = name;
      if (ogName !== "")
        effectName = ogName;
      effectName += " " + ogEff;
      let timeSpan = "";
      if (ogTime !== "")
        timeSpan = insertRolls(" " + ogTime + " ").trim();
      const ongoing_actmod = effectName + "~" + timeSpan + "~" + new Date().toISOString();
      setAttrs({ ongoing_actmod });
    }

  });
});

/**
 * Check usure
 */
on("change:usure_check", function() {
  getAttrs([ "usure_check" ], function(values) {
    const check = strval(values.usure_check);
    if (check === "")
      return;
    
    const updates = new Map();

    try {
      let { attack, name, usure, roll } = objval(check);
      if (attack !== "") {
        usure = Math.max(0, usure - 1);
        updates.set(rptAttr("armes", "arme-usure", attack), usure);
        if (roll > usure) {
          sendChatMsg(rollTemplate({
            lsub: "Usure",
            rsub: name,
            text: `L'arme se brise (usure : ${usure}) !`,
            textclass: "fumble"
          }));
        }
      }
    }
    catch (e) {} 
    finally {
      updates.set("usure_check", "");
      setAttrs(Object.fromEntries(updates));
    }

  });
});

/**
 * Display effects of last maneuver used
 */
on("change:last_maneuver", function () {
  getAttrs([ "last_maneuver" ], function(values) {
    const [ maneuver ] = strval(values.last_maneuver).split("~");
    const found = SWData.PC.COMBAT.maneuvers.find(mn => maneuver === cleanText(mn.name.split(" ")[0]));
    if (found) {
      const name = found.name.split(" ")[0];
      let text = found.effect;
      if (name.endsWith("°"))
        text = "*-5 / +5 par différence de taille*\n" + text;
      sendChatMsg(rollTemplate({
        lsub: "Manoeuvre",
        rsub: name.replace("°", ""),
        text,
      }), { whisper: "gm" });
    }
  });
});

/**
 * Return the fully qualified name of attack attribute for gear id, if any
 * @param {string} data - in hand data (main_princ | main_autre value)
 * @returns {string}
 */
function getWeaponGearAttr(data) {
  const [ label, weaponId ] = strval(data).split("~");
  return intval(label) > 0 ? rptAttr("armes", "arme-gearid", weaponId) : "";
}

/**
 * Change objects in hands 
 */
on("change:main_princ change:main_autre", function(eventInfo) {
  const attribute = eventInfo.sourceAttribute;
  const hand = attribute.split("_")[1];
  const hands = [
    "main_princ",
    "main_autre"
  ];
  const attrs = [
    attribute,
    "bouclier_eqp",
    hands[1]
  ];

  const offWeaponGear = getWeaponGearAttr(eventInfo.previousValue);
  if (offWeaponGear !== "")
    attrs.push(offWeaponGear);
  
  const onWeaponGear = getWeaponGearAttr(eventInfo.newValue);
  if (onWeaponGear !== "")
    attrs.push(onWeaponGear);
  
  getAttrs(attrs, function(values) {
    const inHand = strval(values[attribute]);
    const hasShield = boolval(values.bouclier_eqp);
    
    const updates = new Map();
    
    if (offWeaponGear !== "") {
      const equipId = strval(values[offWeaponGear]);
      if (equipId !== "")
        updates.set(rptAttr("equipement", "equip-on", equipId), 0);
    }
    
    if (onWeaponGear !== "") {
      const equipId = strval(values[onWeaponGear]);
      if (equipId !== "")
        updates.set(rptAttr("equipement", "equip-on", equipId), 1);
    }

    const [ rowId, twoHands ] = inHand.split("~").splice(1);
    updates.set(`${attribute}_btn`, (rowId) ? 1 : 0);
    if (hand === hands[0].split("_")[1]) {
      if (twoHands === "1") {
        updates.set(hands[1], "2m");
        if (hasShield)
          updates.set("bouclier_eqp", 0);
      } else {
        if (strval(values[hands[1]]) === "2m")
          updates.set(hands[1], "0");
      }
    }

    if (hand === "autre")
      updates.set("bouclier_eqp", inHand === "bouclier" ? 1 : 0);

    if (updates.size > 0)
      setAttrs(Object.fromEntries(updates));
  });
});

/**
 * Process in-hand attack button
 */
on("clicked:main_princ-btn clicked:main_autre-btn", function (eventInfo) {
  const [ button ] = eventInfo.triggerName.split(":").splice(1);
  const hand = button.replace("-btn", "");
  getAttrs([ "character_name", hand ], function(values) {
    const charName = strval(values.character_name);
    const [ rowId ] = strval(values[hand]).split("~").slice(1);
    if (!rowId)
      return;
    const attack = `%{${charName}|${ rptAttr("armes", "attack-btn", rowId) }`;
    sendChatCmd(attack);
  });
});

/**
 * Toggle abilities edit/view mode
 */
on("clicked:edit_view-btn", function() {
  getAttrs([ "abilities_edit" ], function(values) {
    const abilities_edit = 1 - intval(values.abilities_edit);
    setAttrs({ abilities_edit });
  });
});

/**
 * Return ability enhanced parameter if any
 * @param {number} hasRank - rank in path
 * @param {number} rank - rank where ability evolves
 * @param {string} change - value of enhanced parameter
 * @returns {string}
 */
function enhancedAbility(hasRank, rank, change) {
  rank = intval(rank);
  change = strval(change);
  return (hasRank >= rank) ? change : "";
}

/**
 * Return ability description with rank-based parameters
 * @param {string} description - ability description
 * @param {number} path - path #
 * @param {object} values - getAttrs() object
 * @param {string} abilityProps - ability properties
 * @returns {string}
 */
function paramByRank(description, path, values, abilityProps) {
  if (description.includes("{{selonRang}}") && hasProp(abilityProps, "selonRang")) {
    const selonRang = getProp(abilityProps, "selonRang").split(",").map(v => strval(v));
    const hasRank = getPathRanks(strval(values.rangs_voies))[path - 1];
    const param = strval(selonRang[hasRank - 1]);
    if (param !== "")
      description = description.replace("{{selonRang}}", param);
  }
  return description;
}

/**
 * Send an additional roll to chat
 */
on("change:next_roll", function () {
  getAttrs([ "next_roll" ], function(values) {
    const [ chatCmd ] = strval(values.next_roll).split("~");
    if (chatCmd)
      sendChatCmd(chatCmd);
  });
});

/**
 * Display ability text with inline rolls
 * @param {number} path - Path #
 * @param {number} rank - Rank #
 * 
 * @description Adds alerts on usage and spells 
 */
function actionAbility(path, rank) {
  const abilityAttrs = [
    abilityInfo({ path, rank }).pathName,
    abilityInfo({ path, rank }).rankName,
    abilityInfo({ path, rank }).rankDesc,
    abilityInfo({ path, rank }).rankOwned,
    abilityInfo({ path, rank }).rankSpell,
    abilityInfo({ path, rank }).rankUse,
    abilityInfo({ path, rank }).rankUseMax,
    abilityInfo({ path, rank }).rankUseFreq,
    abilityInfo({ path, rank }).rankProps,
    //abilityInfo({ path, rank }).rankParam,
    abilityInfo({ path, rank }).rankBase
  ];
  getAttrs([
    ...abilityAttrs, 
    "character_name",
    "pm", "concentration", "rangs_voies",
  ], function(values) {
    const [ name, ability, desc, owned, spell, used, uses, freq, props, br ] = Object.keys(values);
    const pathName = strval(values[name]);
    let abilityName = strval(values[ability]);
    const abilityOwned = boolval(values[owned]);
    const abilitySpell = boolval(values[spell]);
    const attackSpell = abilitySpell ? abilityName.toLowerCase().includes("(a)") : false;
    const concentration = boolval(values.concentration);
    let description = strval(values[desc]);
    if (abilityName === "" && description === "")
      return;

    const allTags = getAllTags(values);

    const nbUsed = intval(values[used]) + 1;
    const maxUses = intval(values[uses]);
    const usage = strval(values[freq]);

    if (usage !== "")
      allTags.push(`${maxUses} / ${ usage.toLowerCase() }`);

    const abilityProps = strval(values[props]);
    //const abilityParam = strval(values[param]);
    const rankBase = intval(values[br]);

    const charName = strval(values.character_name);

    // Play FX !
    const fxValue = strval(getProp(abilityProps, "fx"));
    if (fxValue !== "")
      playFX(fxValue);

    const updates = new Map();
    
    let alert = "";
    let alertCSS = "";
    let expended = false;

    // alert on usage
    if (maxUses !== 0) {
      if (nbUsed > maxUses) {
        description = "";
        expended = true;
        alert = `Nombre maximum d'utilisations déjà atteint`;
        alertCSS = "fumble";
      } else {
        alert = `Utilisée ${nbUsed} fois`;
        alertCSS = "secondary";
      }
    }

    // alert on spells & PM
    if (!expended && abilityOwned && abilitySpell) {
      let pm = intval(values.pm);
      let mana = rank + rankBase - 1;
      const pmProp = strval(getProp(abilityProps, "pm"));
      if (pmProp !== "") {
        let [ pmMod, ...pmModInfo ] = pmProp.split(" ");
        if ([ "+", "-" ].includes(pmMod.charAt(0))) {
          mana = Math.max(0, mana - intval(pmMod));
        } else {
          mana = intval(pmMod);
        }
        if (mana === 0) {
          alert = `Pas de PM dépensés ${ pmModInfo.join(" ") }`;
          alertCSS = "secondary";
        }
      }
      if (attackSpell && concentration) {
        mana = Math.max(0, mana - 2);
        abilityName = abilityName.replace("(A)", "(L:Concentration)");
      }
      alert += (alert !== "") ? "\n" : "";
      if (mana > pm) {
        alert += "Plus assez de Points de Mana\n";
        alert += `${pm} restants pour ${mana} nécessaires\n`;
        alert += `Brûlure de Mana : [[${mana - pm}d@{drecup}]] PV perdus\n`
        alertCSS = "fumble";
      } else {
        pm -= mana;
        if (mana > 0) {
          alert += `${pm} Points de Mana restants`;
          alertCSS = "secondary";
        }
        updates.set("pm", pm);
      }
    }

    if (abilitySpell) {
      allTags.push("Sort");
      if (hasProp(abilityProps, "zone")) {
        allTags.push("Zone");
      }
    }

    // change rolls based on rank
    description = paramByRank(description, path, values, abilityProps);

    // check ongoing effect
    let ongoing = strval(getProp(abilityProps, "etendu"));
    if (ongoing) {
      let effectName = strval(getProp(abilityProps, "etendu-nom"));
      if (effectName === "")
        effectName = abilityName;
      effectName += " " + ongoing;
      let timeSpan = strval(getProp(abilityProps, "etendu-duree"));
      if (timeSpan !== "")
        timeSpan = insertRolls(" " + timeSpan + " ").trim();
      const ongoing_actmod = effectName + "~" + timeSpan + "~" + new Date().toISOString();
      updates.set("ongoing_actmod", ongoing_actmod);
    }

    // build text
    let text = insertRolls(description);
    if (alert !== "" && alertCSS === "")
      text += "\n" + alert
    
    // Do another roll
    let nextRoll = "";
    if (hasProp(abilityProps, "roll")) {
      const search = [
        { atk: "atkcac", alias: "contact" },
        { atk: "atktir", alias: "distance" },
        { atk: "atkmag", alias: "magie" }
      ];
      let roll = getProp(abilityProps, "roll");
      search.forEach(s => {
        if (cleanText(roll).includes(s.alias))
          roll = s.atk;
        if (roll === s.atk)
          roll += "-btn";
      });
      nextRoll = `%{${charName}|${roll}}`;
    }

    // send to chat
    const rollProps = {
      lsub: `${pathName} - ${rank}`,
      rsub: abilityName,
      text
    };
    if (alertCSS !== "") {
      rollProps.alert = alert;
      rollProps.alertclass = alertCSS;
    }
    
    const chatMsg = rollTemplate(rollProps, { tags: allTags });
    sendChatMsg(chatMsg, { nextRoll });
    
    // Update usages
    if (maxUses > 0 && nbUsed <= maxUses)
      updates.set(used, nbUsed);

    // Update attributes
    if (updates.size > 0)
      setAttrs(Object.fromEntries(updates));

  });
}

/**
 * Display ongoing effect for abilities
 * @param {number} path - path #
 * @param {number} rank - rank #
 */
function ongoingEffect(path, rank) {
  getAttrs([ 
    abilityInfo({ path, rank }).pathName,
    abilityInfo({ path, rank }).rankName,
    abilityInfo({ path, rank }).rankProps
  ], function(values) {
    const [ kpath, kname, kprops ] = Object.keys(values);
    const pathName = strval(values[kpath]);
    const props = strval(values[kprops]);
    const effect = insertRolls(" " + getProp(props, "etendu") + " ").trim();
    let name = strval(getProp(props, "etendu-nom"));
    if (name === "")
      name = strval(values[kname]);
    let stop = strval(getProp(props, "etendu-stop"));
    if (stop === "")
      stop = "Pendant " + strval(getProp(props, "etendu-duree"));
    const text = [ effect, stop ].join("\n");

    // send to chat
    const rollProps = {
      lsub: `${pathName} - ${rank}`,
      rsub: name,
      text
    };
    
    sendChatMsg(rollTemplate(rollProps));
  });
}


/**
 * Update rank in path
 * @param {number} path - Path #
 */
function setRank(path) {
  const rankAttrs = seq(5).map(rank => abilityInfo({ path, rank }).rankOwned);
  getAttrs(rankAttrs, function (values) {
    let rank = 0;
    rankAttrs.forEach(ability => {
      const owned = intval(values[ability]);
      const hasRank = abilityInfo(ability).rank * owned;
      if (hasRank > rank)
        rank = hasRank;
    });
    setAttrs({ [`rang_voie${path}`]: rank });
  });
}

/**
 * Update the all ranks attribute
 * @param {number} path - path number changed
 */
function updateAllRanks(path) {
  getAttrs([ `rang_voie${path}`, `v${path}br`, "rangs_voies", "noms_voies" ], function(values) {
    const [ rankPath, rankBase ] = Object.keys(values);
    let rank = intval(values[rankPath]);
    const base = intval(values[rankBase]);
    const names = getPathNames(strval(values.noms_voies));
    let allRanks = Array(9);
    const rangs_voies = strval(values.rangs_voies);
    if (rangs_voies !== "")
      allRanks = getPathRanks(rangs_voies);
    if (rank > 0 && base > 1)
      rank += base - 1;
    allRanks[path - 1] = rank;
    const updates = { rangs_voies: allRanks.join(",") };
    if (cleanText(names[path - 1], false) === "cavalier")
      updates.rang_cavalier = rank;
    setAttrs(updates);
  });
}

/**
 * Update the voieN_buff_xxx attribute value based on rank
 * Update the buffs_voies attribute with the list of buff attribute names
 * @param {number} path - path number changed
 */
function updateBuffsByRank(path) {
  const rankProps = seq(5).map(rank => abilityInfo({ path, rank }).rankProps);
  getAttrs([ `rang_voie${path}`, "buffs_voies", ...rankProps ], function(values) {
    const rank = intval(values[`rang_voie${path}`]);
    rankProps.filter(a => strval(values[a]) !== "").forEach(props => {
      values[props].split("\n").filter(prop => prop.startsWith("buff:")).forEach(prop => {
        const value = prop.split(":")[1].replace(/\s+/g, " ");
        let [ attr, ...buffs ] = value.split(" ");
        if (attr === "")
          return;
        buffs = buffs.join(" ");
        try {
          const byRank = JSON.parse(buffs.trim());
          const buffAttr = `voie${path}_buff_${ attr.trim() }`;
          const buffByRank = rank > 0 ? byRank[rank - 1] : 0;
          const buffs_voies = JSON.parse(strval(values.buffs_voies, "{}"));
          buffs_voies[buffAttr] = buffByRank;
          setAttrs({ buffs_voies: JSON.stringify(buffs_voies) });
        } catch (e) { }
      });
    });
  });
}

/**
 * Update the all names attribute
 * @param {number} path - path number changed
 */
function updateAllPathNames(path) {
  getAttrs([ `voie${path}nom`, "noms_voies" ], function(values) {
    const [ pathName ] = Object.keys(values);
    const name = strval(values[pathName]);
    const names = strval(values.noms_voies);
    let allNames;
    if (names !== "") {
      allNames = names.split("|").map(n => strval(n));
    } else {
      allNames = Array(9).fill("");
    }
    allNames[path - 1] = name;
    setAttrs({ noms_voies: allNames.join("|") });
  });
}

/**
 * Check max ability points
 * @param {string} [changed=""] - path+rank ability identifier
 */
function checkAbilityPoints(changed = "") {
  const names = allPathRanks("rankName");
  const owned = allPathRanks("rankOwned");
  const props = allPathRanks("rankProps");
  const baseRank = nameSeq(9, abilityInfo().rankBase);
  getAttrs([ 
    "cfg_pts_capas",
    "niveau", "famille",
    ...owned,
    ...names,
    ...props,
    ...baseRank
  ], function(values) {
    const checkAP = boolval(values.cfg_pts_capas);
    if (!checkAP)
      return;
    
    const level = intval(values.niveau);
    
    // Won't update if changing rank 2 for Mages profiles
    if (changed !== "")
      if (level === 1 && cleanText(values.famille) === "mages" && abilityInfo(changed).rank === 2)
        return;

    const alerts = [];
    const maxPoints = level * 2;
    let usedPoints = 0;
    
    owned.forEach(ability => {
      if (!boolval(values[ability]))
        return;
      const { path, rank, rankBase } = abilityInfo(ability);
      const base = intval(values[rankBase], 1);
      const rankPath = rank + base - 1;
      
      if (path === SWData.settings.peoplePath && rankPath === 1)
        return;

      const props = strval(values[ability + "_props"]);
      if (SWData.settings.level1Paths.includes(path) && rankPath === 2 && hasProp(props, "initial"))
        return;

      const minLevel = SWData.settings.minLevels[rankPath - 1];
      if (level < minLevel) {
        const rankName = values[`voie${path}-t${rankPath}`];
        alerts.push(`La capacité ${rankName} (rang ${rankPath}) n'est pas accessible avant le niveau ${minLevel}`);
      }

      usedPoints += (rank > 2) ? 2 : 1;
    });

    if (usedPoints > maxPoints || alerts.length > 0) {
      let text = usedPoints > maxPoints ? `${usedPoints} points utilisés mais ${maxPoints} au maximum` : "";
      if (alerts.length > 0)
        text += ( text !== "" ? "\n" : "") + alerts.join("\n");
      const chatMsg = rollTemplate({
        lsub: "Contrôle",
        rsub: "Points de Capacités",
        text
      });
      sendChatMsg(chatMsg, {
        ...SWData.RT_OPTIONS,
        whisper: "gm"
      });
    }
  });
}

/**
 * Return simple / unqualified path name
 * @param {string} fullPathName - full path name (voie du|de la|des ...)
 * @param {boolean} [cleanup=true] - clean up text (accents & COF tags)
 * @returns {string}
 */
function simplePathName(fullPathName, cleanup = true) {
  let simplePathName = fullPathName.toLowerCase().replace(/voie[ ]+(du|des|de la|de l'|de l’)/, "");
  if (cleanup)
    simplePathName = cleanText(simplePathName);
  return simplePathName.trim();
}

/**
 * Set path PV from path name
 * @param {number} path - path number
 */
function updatePathInfos(path) {
  const rankNames = seq(5).map(rank => abilityInfo({ path, rank }).rankName);
  getAttrs([ `voie${path}nom`, ...rankNames ], function(values) {
    const updates = new Map();
    const [ pathName ] = Object.keys(values);

    const name = simplePathName(strval(values[pathName]));
    if (name === ""
      || name.includes("voie de profil")
      || name.includes("voie de prestige")
    ) {
      // reset abilities
      rankNames.forEach((rank, ix) => {
        rank = ix + 1;
        updates.set(abilityInfo({ path, rank }).rankOwned, "");
        updates.set(abilityInfo({ path, rank }).rankName, "");
        updates.set(abilityInfo({ path, rank }).rankDesc, "");
        updates.set(abilityInfo({ path, rank }).rankSpell, "");
        updates.set(abilityInfo({ path, rank }).rankParam, "");
        updates.set(abilityInfo({ path, rank }).rankUse, "");
        updates.set(abilityInfo({ path, rank }).rankUseFreq, "");
        updates.set(abilityInfo({ path, rank }).rankUseMax, "");
        setAttrs(Object.fromEntries(updates));
      });
      return;
    }

    const pathPV = SWData.PVPATH.find(p => p.name === name);
    if (!pathPV)
      return;

    updates.set(abilityInfo({ path, rank: 0}).pathPV, pathPV.pv);
    updates.set(abilityInfo({ path, rank: 0}).pathProfile, pathPV.profile);
    rankNames.forEach((rank, ix) => {
      if (strval(values[rank]) === "")
        updates.set(abilityInfo({ path, rank: ix + 1 }).rankName, capitalize(pathPV.abilities[ix]));
    });

    setAttrs(Object.fromEntries(updates));
  });
}

/**
 * On check/un-check rank 2 for mages
 */
on(changeEvent(SWData.settings.level1Paths.map(p => `v${p}r2`)), function(eventInfo) {
  const rank = eventInfo.triggerName;
  const rankProps = abilityInfo(rank).rankProps;
  const rank2Props = SWData.settings.level1Paths
    .filter(p => p !== abilityInfo(rank).path)
    .map(p => abilityInfo({ path: p, rank: 2 }).rankProps);
  getAttrs([
    "famille", "niveau", "voie1nom",
    rank, rankProps, ...rank2Props
  ], function(values) {
    if (strval(values.famille) !== "Mages")
      return;
    if (intval(values.niveau) > 1)
      return;

    const path1Mage = strval(values.voie1nom).toLowerCase().includes("mage");
    const checked = boolval(values[rank]);
    const props = strval(values[rankProps])
      .split("\n")
      .filter(p => strval(p) !== "")
      .filter(p => !p.startsWith("initial"));
    
    if (checked) {
      if (!rank2Props.some(a => strval(values[a]).startsWith("initial"))) {
        if (abilityInfo(rank).path === 1 && path1Mage) {
          props.push("initial: ");
        } else if (abilityInfo(rank).path > 1) {
          props.push("initial: ");
        }
      }
    }

    setAttrs({ [rankProps]: props.join("\n") }, {}, () => {
      updatePVMax(eventInfo);
      checkAbilityPoints();
    });
  });
});

/**
 * Abilities
 */
seq(9).forEach(path => {
  seq(5).forEach(rank => {
    
    const ability = abilityInfo({ path, rank }).rankOwned; // `v${path}r${rank}`;

    // Handle ability buttons click
    on(`clicked:${ability}-btn`, function() {
      actionAbility(path, rank);
    });

    // Handle ability ongoing effect
    on(`clicked:x${ ability.slice(1) }-btn`, function() {
      ongoingEffect(path, rank);
    });

    on(`change:${ability} change:${ abilityInfo(ability).rankParam }`, function(eventInfo) {
      
      // Update rank in path
      setRank(path);

      // Update PV
      updatePVMax(eventInfo, ability);
      
      // Check ability points
      checkAbilityPoints(ability);

      // Update roll > action button
      getAttrs([ "character_name", ability ], function(values) {
        const charName = strval(values.character_name);
        const owned = boolval(values[ability]);
        if (charName === "" || !owned)
          return;
        
        setAttrs({ [`${ability}-btn`]: `%{${charName}|${ability}-btn}` });
      });
    });
  });

  // Update all ranks attribute
  on(`change:rang_voie${path} change:${ abilityInfo({ path }).rankBase }`, function () {
    updateAllRanks(path);
    updateBuffsByRank(path);
  });

  on(`change:${ abilityInfo({ path }).pathName }`, function () {

    // Update path names attribute
    updateAllPathNames(path);
    
    // Find path's infos based on name
    updatePathInfos(path);
  });

  // Update PV max
  on(`change:voie${path}pv`, function (eventInfo) {
    updatePVMax(eventInfo);
  });
});

/**
 * On click on concentration button
 */
on("clicked:concentration-btn", function () {
  getAttrs([ "concentration" ], function (values) {
    setAttrs({ concentration: 1 - intval(values.concentration) });
  })
});

/**
 * On click of ongoing effect button
 */
on("clicked:ongoing-btn", function() {
  const allOwned = allPathRanks("rankOwned");
  const allNames = allPathRanks("rankName");
  const allProps = allPathRanks("rankProps");
  getAttrs([ 
    "character_name",
    ...allOwned,
    ...allNames,
    ...allProps
  ], function(values) {
    const ongoing = [ "Aucune" ];
    const action = [];
    allOwned.forEach(attr => {
      if (!boolval(values[attr]))
        return;

      const { path, rank } = abilityInfo(attr);
      const props = strval(values[abilityInfo({ path, rank }).rankProps]);
      if (!hasProp(props, "etendu"))
        return;
      let name = getProp(props, "etendu-nom");
      if (name === "")
        name = capitalize(cleanText(strval(values[abilityInfo({ path, rank }).rankName]), true));
      ongoing.push(name);
      action.push(`%{${ strval(values.character_name) }|x${path}r${rank}-btn}`);
    });
    if (ongoing.length === 1)
      return;

    ask([ "Effet prolongé ?", ...ongoing ], function(selected) {
      if (selected > 1)
        sendChatCmd(action[selected - 2]);
    });
  });
});

/**
 * On click of reset abilities usage button
 */
on("clicked:reset_uses-btn", function() {
  const abilityUsage = [ 
    ...allPathRanks("rankOwned"),
    ...allPathRanks("rankUse"),
    ...allPathRanks("rankUseFreq")
  ];
  getAttrs(abilityUsage, function(values) {
    const freqs = [ "Aucune" ];
    const owned = new Map();
    const abilities = [];

    // build lists of frequencies & usages
    for (const attribute in values) {
      if (values[attribute] === "")
        continue;
      const [ ability, attr ] = attribute.split("_");
      if (!attr) {
        if (intval(values[attribute]) === 1)
          owned.set(ability, 0);
        continue;
      } else if (attr === "use") {
        if (owned.has(ability))
          owned.set(ability, intval(values[attribute]));
        continue;
      }
      if (!owned.has(ability) || owned.get(ability) === 0)
        continue;
      const freq = capitalize(values[attribute]);
      if (!freqs.includes(freq)) {
        freqs.push(freq);
        abilities[freq] = [];
      }
      abilities[freq].push(ability);
    }

    // Nothing to process
    if (freqs.length === 1) {
      const chatMsg = rollTemplate({
        lsub: "Capacités",
        rsub: "Utilisations",
        text: "Aucune capacité avec nombre d'utilisations à recharger"
      });
      sendChatMsg(chatMsg);
      return;
    }

    // Ask for which abilities to reset
    ask([ "Utilisations capacités ?", ...freqs ], function(selected, choices) {
      if (selected === 1)
        return;
      const freq = choices[selected - 1];
      const titles = abilities[freq].map(a => abilityInfo(a).rankName);
      const usages = abilities[freq].map(a => abilityInfo(a).rankUseMax);
      getAttrs([ ...titles, ...usages ], function(values) {
        let text = "";
        Object.keys(values).filter(k => k.endsWith("_use_max")).forEach(k => {
          const title = values[abilityInfo(k).rankName];
          const usage = intval(values[k]);
          text += title + " : " + usage + ` utilisation${ usage > 1 ? "s" : ""}\n`;
        });
        const chatMsg = rollTemplate({
          lsub: "Capacités",
          rsub: `Par ${freq}`,
          text
        });
        sendChatMsg(chatMsg);
        const reset = {};
        abilities[freq].forEach(ability => {
          reset[abilityInfo(ability).rankUse] = 0;
        });
        setAttrs(reset);
      });
    });
  });
});

/**
 * Scan abilities for usage in description
 * @param {number} [path=0] - search usages in a single path
 */
function abilityUsages(path = 0) {
  const abilities = [];
  seq(9).forEach(v => {
    if (path > 0 && v !== path)
      return;
    seq(5).forEach(r => {
      abilities.push(abilityInfo({ path: v, rank: r}).rankDesc);
      abilities.push(abilityInfo({ path: v, rank: r}).rankUseFreq);
    });
  });
  getAttrs(abilities, function (values) {
    const updateAbilities = new Map();
    const rx = new RegExp("([U|u]ne|[D|d]eux|[T|t]rois) fois par ([A-Za-z]+)","gm");
    Object.keys(values).filter(v => v.endsWith("_freq")).forEach(value => {
      if (strval(values[value]) !== "")
        return; // already has a usage freq

      const [ ability ] = value.split("_");
      const abilityDesc = abilityInfo(ability).rankDesc;
      const description = strval(values[abilityDesc]);
      if (description === "")
        return; // no description found

      const matches = [ ...description.matchAll(rx) ];
      if (matches.length === 0)
        return; // no regex match

      const [ use, freq ] = matches[0].slice(1);
      if ([ "round", "tour" ].includes(freq.toLowerCase()))
        return; // no per round usage

      const useMax = [ "une", "deux", "trois" ].indexOf(use.toLowerCase()) + 1;
      if (useMax > 0) {
        updateAbilities.set(abilityInfo(ability).rankUseMax, useMax);
        updateAbilities.set(abilityInfo(ability).rankUseFreq, freq);
      }
    });
    if (updateAbilities.size > 0)
      setAttrs(Object.fromEntries(updateAbilities));
  }); 
}

/**
 * Update roll <=> action button for rolls
 */
on("change:repeating_rolls:roll-nom change:repeating_npcrolls:npcroll-name", function(eventInfo) {
  const [ section, rollId, btName ] = strval(eventInfo.triggerName).split("_").slice(1);
  getAttrs([ "character_name" ], function(values) {
    const charName = strval(values.character_name);
    const rollBtn = rptAttr(section, `${ btName.split("-")[0] }-btn`, rollId);
    setAttrs({ [rollBtn]: `%{${charName}|${rollBtn}}` })
  });
});

/**
 * Build a roll query for ability selection
 * @param {Array} ability - list of abilities
 * @returns {string}
 */
function statRollQuery(ability) {
  return "?{Carac ?|" 
  + SWData.PC.STATS
  .filter(stat => {
    if (Array.isArray(ability) && !ability.includes(shorten(stat)))
      return false;
    return true;
  })
  .map(stat => `${ upperShort(stat) },@{${ shorten(stat) }_test}`)
  .join("|")
  + "}";
}

/**
 * On ability roll button click
 */
on("clicked:repeating_rolls:roll-btn", function() {
  const section = "repeating_rolls_roll-";
  const statsAttrs = SWData.PC.STATS.map(stat => `${ shorten(stat) }_test`);
  const rollAttrs = rptAttrs(rptInfo(section).section, [
    "nom",
    "cmd",
    "type",
    "carac",
    "voie",
    "bonus"
  ].map(a => `${ section.split("_")[2] }${a}`));
  const abilityAttrs = [ 
    ...allPathRanks("rankName"),
    ...allPathRanks("rankDesc"),
    ...allPathRanks("rankProps")
  ];
  getAttrs(
    [
      "rangs_voies", "noms_voies",
      "condition_affaibli",
      "cfg_d20roll", "d20roll",
      "cfg_shadow", "pc",
      "allcaracs_desc", "allcaracs_buff", 
      "help_roll_all",
      ...fearConditionsAttrs(),
      ...luckButtonAttrs(),
      ...statsAttrs,
      ...rollAttrs,
      ...abilityAttrs
    ], function (values) {
    const rollName = strval(values[section + "nom"]);
    let type = strval(values[section + "type"]);
    let carac = strval(values[section + "carac"]);
    const rankInPath = intval(values[section + "voie"]);
    const bonus = intval(values[section + "bonus"]);
    let rollCmd = strval(values[section + "cmd"]);

    const ranks = getPathRanks(strval(values.rangs_voies));
    const names = getPathNames(strval(values.noms_voies));

    let abilityDesc = "";
    let abilityProps = "";
    const abilityMatch = abilityAttrs
    .filter(a => a.includes("-t"))
    .find(a => cleanText(strval(values[a]), true) === cleanText(rollName));
    if (abilityMatch) {
      const path = abilityMatch.charAt(4);
      const rank = abilityMatch.charAt(abilityMatch.length - 1);
      abilityDesc = strval(values[abilityInfo({ path, rank }).rankDesc]);
      abilityProps = strval(values[abilityInfo({ path, rank }).rankProps]);
      if (abilityDesc !== "") {
        abilityDesc = paramByRank(abilityDesc, path, values, abilityProps);
        abilityDesc = insertRolls(abilityDesc, { pathNames: names });
      }
    }
    
    const allTags = getAllTags(values);

    // Weakened condition
    if (boolval(values.condition_affaibli)) {
      switch (type) {
        case "1d20":
          type = "2d20kl1";
          break;
        case "2d20kh1":
          type = "1d20";
          break;
      }
    }
    
    // Peur
    const fear = fearConditionMalus(values);

    // Valeur d'Ombre
    const shadow = shadowValue(values);
    
    let mark;
    if (abilityMatch && carac === "0")
      mark = "rang ";
    else
      mark = "+";
    const rollBonus = carac !== "?" ? ` *(${mark}${ intval(values[carac.slice(2, 2 + 3 + 5)]) + (ranks[rankInPath - 1] || 0) + bonus })*` : "";

    let lsub = "Capacité";
    let text = "";

    if (type !== "0") {
      text = insertRolls(rollCmd, { pathNames: names });
      let carTip = "";
      // d20
      if (type === "1d20")
        type = d20Roll(type, strval(values.d20roll));
      else
        type = rollCfCs(type);
      rollCmd = `${type}[Dés]`;
      const helpAllRolls = strval(values.help_roll_all);
      // + Carac
      if (carac !== "") {
        if (carac === "?") {
          carac = statRollQuery();
        } else {
          carTip = `[${ carac.substring(2, 2+3).toUpperCase() }]`;
        }
        rollCmd += ` + (${carac})${carTip}`;
      }
      // + Rang
      if (rankInPath > 0) {
        rollCmd += ` + (${ranks[rankInPath - 1]})[Rang ${names[rankInPath - 1]}]`;
      }
      // + Bonus
      if (bonus !== 0)
        rollCmd += ` + (${bonus})[Bonus]`;
      // + All rolls buff
      rollCmd += allRollsBuff(values, "caracs");
      // + Help
      if (helpAllRolls !== "") {
        rollCmd += helpAllRolls;
        setAttrs({ help_roll_all: "" });
      }
      // - Ombre
      rollCmd += shadow.malus;
      // - Peur
      rollCmd += fear;
      // in-line
      rollCmd = "[[" + rollCmd + " ]]"
    } else {
      if (!abilityMatch || carac !== "0")
        lsub = "Jet";
      rollCmd = insertRolls(rollCmd, { pathNames: names });
    }

    if (text === "" && abilityDesc !== "")
      text = abilityDesc;

    // Send to chat
    const chatMsg = rollTemplate({
      lsub,
      rsub: rollName + rollBonus,
      roll: rollCmd,
      text,
      chance: addLuckButton(values)
    }, { tags: allTags });
    sendChatMsg(chatMsg);
  });
})

/**
 * Return skill name
 * @param {{ label: string, name: string, ability: string }} skill - Skill object
 * @returns {string}
 */
function getSkillName(skill) {
  return (skill.label !== "") ? skill.label : capitalize(skill.name);
}

/**
 * On skill 'button' click
 */
SWData.PC.SKILLS.forEach(skill => {
  let events = `clicked:skill-${skill.name}`;
  if (Array.isArray(skill.ability))
    events += " " + eventList("clicked", skill.ability.map(ability => `skill-${skill.name}-${ability}`), " ");
  on(events, function (eventInfo) {
    const useCarac = strval(eventInfo.triggerName.split("-")[2]);
    let skillName = getSkillName(skill);
    const statsAttrs = SWData.PC.STATS.map(stat => shorten(stat));
    const skillAttrs = [ "carac", "bonus", "def" ].map(a => `${skill.name}_${a}`);
    const customNames = nameSeq(4, "custom#_skillname");
    const customCaracs = nameSeq(4, "custom#").reduce((all, custom) => {
      all.push(...SWData.PC.STATS.map(stat => `${custom}_${ shorten(stat) }`));
      return all;
    }, []);
    getAttrs([
      ...skillAttrs,
      ...statsAttrs,
      ...customNames,
      ...customCaracs,
      "condition_affaibli",
      "pc", "cfg_shadow", 
      "cfg_1skill_roll", "cfg_d20roll", "d20roll",
      "allcaracs_desc", "allcaracs_buff",
      "help_roll_all",
      ...fearConditionsAttrs(),
      ...luckButtonAttrs()
    ], function (values) {
      const [ carac, bonus, def ] = Object.keys(values);
      let caracBonus = strval(values[carac]);
      
      if (skill.name.startsWith("custom")) {
        skillName = capitalize(strval(values[`${ skill.name }_skillname`]));
        skill.ability = customCaracs.reduce((result, custom) => {
          const [ custName, custCarac ] = custom.split("_");
          if (skill.name === custName && boolval(values[custom]))
            result.push(custCarac);
          return result;
        }, []);
        if (skill.ability.length === 1)
          caracBonus = "@{" + skill.ability[0] + "}";
      }

      if (useCarac !== "")
        caracBonus = "@{" + useCarac + "}";
      let short = "";
      if (caracBonus !== "0" && caracBonus !== "?")
        short = caracBonus.slice(2,5).toUpperCase() + " + ";
      const skillBonus = intval(values[bonus]);
      const skillDef = strval(values[def]);
      const skillTotal = ` *(+${ intval(values[caracBonus.slice(2, 5)]) + skillBonus })*`;

      let rollCmd = "1d20";
      
      const allTags = getAllTags(values);

      // Peur
      const fear = fearConditionMalus(values);

      // Valeur d'Ombre
      const shadow = shadowValue(values);

      // Weakened condition
      if (boolval(values.condition_affaibli)) {
        rollCmd = "2d20kl1";
      }

      // Single roll
      const useOneRoll = intval(values.cfg_d20roll) === 0
      ? boolval(values.cfg_1skill_roll)
      : true;

      if (rollCmd === "1d20")
        rollCmd = d20Roll(rollCfCs(rollCmd), strval(values.d20roll));

      rollCmd += "[Dés]"

      let carTip = "";
      if (caracBonus === "?") {
        caracBonus = statRollQuery(skill.ability);
      } else {
        carTip = `[${ caracBonus.substring(2,2+3).toUpperCase() }]`;
      }
      rollCmd += ` + (${caracBonus})${carTip}`

      if (skillBonus !== 0)
        rollCmd += ` + (${skillBonus})[Bonus ${skillName}]`;

      rollCmd += allRollsBuff(values, "caracs");

      const helpAllRolls = strval(values.help_roll_all);
      if (helpAllRolls !== "")
        rollCmd += helpAllRolls;

      rollCmd += fear;

      rollCmd += shadow.malus;

      rollCmd = "[[" + rollCmd + " ]]";

      let broll = "";
      if (rollCmd.startsWith("[[1d20") && !useOneRoll)
        broll = rollCmd;

      // Send to chat
      const chatMsg = rollTemplate({
        lsub: "Compétence",
        rsub: short + skillName + skillTotal,
        roll: rollCmd,
        broll,
        chance: addLuckButton(values),
        text: helpAllRolls
      }, { tags: allTags });
      sendChatMsg(chatMsg);

      // Restore default carac & clear help rolls
      const updates = new Map();
      if (!skill.name.startsWith("custom") && caracBonus !== skillDef)
        updates.set(`${skill.name}_carac`, skillDef);
      if (helpAllRolls !== "")
        updates.set("help_roll_all", "");
      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  });
});

/**
 * Rebuild buffable attributes xxx_buff_list
 */
function rebuildBuffLists() {
  const section = "repeating_buffs";
  getSectionIDs("buffs", function (rowIds) {
    const buffs = Object.fromEntries(new Map(
      SWData.PC.BUFFS.To.map(attr => [ `${attr}_buff_list`, "" ])
    ));
    const allBuffs = [];
    rowIds.forEach(id => {
      [ "on", "nom", "attrib", "value" ]
        .map(attr => `${section}_${id}_buff-${attr}`)
        .forEach(a => {
        allBuffs.push(a);
      });
    });
    getAttrs(allBuffs, function(values) {
      rowIds.forEach(id => {
        const rowId = `${section}_${id}_buff-`;
        const enabled = intval(values[`${rowId}on`]);
        const name = strval(values[`${rowId}nom`]).replaceAll(":", "|");
        const attrib = strval(values[`${rowId}attrib`]);
        const value = strval(values[`${rowId}value`]);
        if (attrib === "*car" || attrib === "*atk") {
          const allbuff = attrib === "*car" ? "allcaracs_" : "allattacks_";
          const buffValue = enabled ? intval(value) : 0;
          setAttrs({ [allbuff + "desc"]: name, [allbuff + "buff"]: buffValue });
          return;
        }
        const attribute = `${attrib}_buff_list`;
        if (enabled === 1 && name !== "" && value !== "") {
          const buffList = buffs[attribute] + `${name} : ${value}; `;
          buffs[attribute] = buffList;
        }
      });
      setAttrs(buffs);
    });
  });
}

/**
 * On change of repeating buffs
 */
on("change:repeating_buffs remove:repeating_buffs", function () {
  rebuildBuffLists();
});

/**
 * Parse an attribute's list of buffs (stored in xxx_buff_list)
 * @param {string} attribute - attribute name 
 */
function parseBuffList(attribute) {
  getAttrs([ 
    `${attribute}_buff_list`,
    ...SWData.PC.BUFFS.From,
    "noms_voies",
    "buffs_voies"
  ], function(values) {
    const [ buff ] = Object.keys(values);
    const buffList = strval(values[buff]).split("; ");
    const allRanks = getPathRanks(values.rangs_voies);
    let pathBuffs;
    try {
      pathBuffs = JSON.parse(strval(values.buffs_voies, "{}"));
    } catch (e) { }
    let buffTotal = 0;
    buffList.forEach(buff => {
      buff = buff.trim();
      if (buff === "")
        return;
      let value = 0;
      let expression = strval(buff.split(":")[1]).trim();
      if (pathBuffs && Object.keys(pathBuffs).map(k => `[${k}]`).includes(expression)) {
        expression = expression.replace("[", "").replace("]", "");
        value = pathBuffs[expression] || 0;
      } else {
        const attrBuff = SWData.PC.BUFFS.From.find(a => `[${a}]` === expression.toLowerCase());
        if (attrBuff) {
          value = intval(values[attrBuff]);
        } else {
          let result = expression.match(/\[rang[ ]*voie[ ]*([1-9])\][ ]*\+?[ ]*([0-9]*)?/i);
          if (!result)
            result = expression.match(/\[rang[ ]*(.*)\][ ]*\+?[ ]*([0-9]*)?/i);
          if (result) {
            const [ matched, path, bonus ] = result;
            let pathNumber = intval(path);
            if (pathNumber === 0) {
              pathNumber = findPathByName("rang " + path, getPathNames(values.noms_voies));
            }
            if (matched && pathNumber > 0)
              value = allRanks[pathNumber - 1];
            if (bonus)
              value += intval(bonus);
          } else {
            value = intval(expression);
          }
        }
      }
      buffTotal += value;
    });
    setAttrs({ [`${attribute}_buff`]: buffTotal });
  });
}

/**
 * On change of a list of buffs
 */
SWData.PC.BUFFS.To.forEach(attribute => {
  on(`change:${attribute}_buff_list`, function() {
    parseBuffList(attribute);
  });
});

/**
 * Recalculate all buffs values
 */
function rebuildBuffValues() {
  SWData.PC.BUFFS.To.forEach(attribute => {
    parseBuffList(attribute);
  });
}

// Recalculate buffs values on change of source attributes
SWData.PC.BUFFS.From.forEach(attribute => {
  on(`change:${attribute}`, function () {
    rebuildBuffValues();
  })
});

/**
 * On click in the mutiple buffs toggle button
 */
on("clicked:multibuff-btn", function () {
  const section = "buffs";
  getSectionIDs(section, function (rowIds) {
    const allBuffs = rowIds.reduce((all, id) => {
      all.push(...rptAttrs(section, [ "buff-on", "buff-nom", "buff-temp" ], id));
      return all;
    }, []);
    getAttrs(allBuffs, function (values) {
      const multiBuffs = new Map();
      rowIds
      .filter(id => boolval(values[rptAttr(section, "buff-temp", id)]))
      .forEach(id => {
        const buff = strval(values[rptAttr(section, "buff-nom", id)]);
        const { ids } = multiBuffs.get(cleanText(buff)) || { ids: [] };
        ids.push(id);
        multiBuffs.set(cleanText(buff), { name: buff, ids });
      });
      const askBuff = [];
      multiBuffs.forEach(v => {
        if (v.ids.length > 0)
          askBuff.push(v.name);
      });
      if (askBuff.length === 0)
        return;
      ask([ "Buff ?", "Aucun", ...askBuff.sort() ], function(selected, choices) {
        if (selected < 2)
          return;
        const [ kbuff ] = [ ...multiBuffs ].find(([ k, v]) => v.name === choices[selected - 1]);
        if (!kbuff)
          return;
        const updates = {};
        buffIds = multiBuffs.get(kbuff).ids.forEach(id => {
          const rptOn = rptAttr(section, "buff-on", id);
          updates[rptOn] = 1 - intval(values[rptOn]);
        });
        setAttrs(updates);
      });
    });
  });
});

/**
 * On click on the buffs syntax help button
 */
on("clicked:helpbuff-btn", function() {
  sendChatMsg([
    "title=Buffs/De-buffs",
    "Valeur=Valeur fixe",
    "[CAR]=Score de la caractéristique *CAR* (AGI, FOR, CHA...)",
    "[rang voie *N*]=Rang dans la voie n° *N*",
    "[rang voie *Nom*]=Rang dans la voie *Nom*",
    "[rang *Nom*]=Rang dans la voie *Nom*",
    "NdX=Jet de N dés à X faces (d4° ou dE pour dé évolutif)",
    "desc=Vous pouvez ajouter un bonus après la voie" + "\n" + "Ex. : *[rang voie 2] + 1*"
  ], {
    template: "custom",
    whisper: "gm"
  });
});

/**
 * Parse abilities path JSON blob
 * @param {object} data - object parsed from DRS JSON blob
 * @param {number} path - path number
 * @param {number} [base=1] - base rank number
 * @returns {Map<string,string|number>} Map object of attributes to update
 */
function importJsonDRS(data, path, base) {
  const updates = new Map();
  // TODO
  return updates;
}

/**
 * Parse abilities path text from DRS
 * @param {string} text - text of abilities path
 * @param {number} path - path number
 * @param {number} [base=1] - base rank number
 * @returns {Map<string,string|number>} Map object of attributes to update
 */
function importFromDRS(text, path, base = 1) {
  const updates = new Map();

  let ability = `voie${path}notes`;
  let abilityTitle = "";

  const lines = text.replaceAll("\r\n", "\n").split("\n");

  lines.forEach((line, index) => {
    // first line
    if (index === 0) {
      let pathName = simplePathName(line.toLowerCase(), false);
      if (pathName !== "")
        updates.set(`voie${path}nom`, capitalize(pathName));
      return;
    }

    if (strval(line).replace(/[^\x00-\xFF]/g, "") === "")
      return;
    if (strval(line).toLowerCase() === "bordure")
      return;
    
    // Found ability title
    const matchTitle = line.match(/^([1-9])[ ]+·[ ]+(.*)$/);
    if (matchTitle) {
      let [ rank, title ] = matchTitle.slice(1);
      rank = intval(rank) - base + 1;
      /* cannot identify spells
      updates.set(`v${path}r${rank}_spell`, title.includes("*") ? 1 : 0); 
      title = title.replace("*", "");
      */
      abilityTitle = `voie${path}-t${rank}`;
      updates.set(abilityTitle, title.trim());
      ability = `voie${path}-${rank}`;
      return;
    }
    
    // Found action type
    const matchAction = line.match(/^(G|M|A|L)$/);
    if (matchAction && abilityTitle !== "") {
      const [ action ] = matchAction.slice(1);
      updates.set(abilityTitle, updates.get(abilityTitle) + " (" + action + ")");
      return;
    }

    const desc = updates.has(ability) ? updates.get(ability) + " " : "";
    updates.set(ability, desc + line.trim());
  });

  return updates;
}

/**
 * Parse abilities path text from PDF
 * @param {string} text - text of abilities path
 * @param {number} path - path number
 * @param {number} [base=1] - base rank number
 * @returns {Map<string,string|number>} Map object of attributes to update
 */
function importFromPDF(text, path, base = 1) {
  const updates = new Map();

  let ability = `voie${path}notes`;

  const lines = text.replaceAll("\r\n", "\n").split("\n");

  // process screwed up texts
  lines.forEach((line, index) => {
    if (index === text.length -1)
      return;
    if (line.startsWith("5. Appel ") && lines[index + 1].startsWith("de la foudre"))
      lines.splice(index, 2, "5. Appel " + lines[index + 1]);
    if (line.startsWith("3. Arme élémentaire") && lines[index + 1].startsWith("(A) ou (L)*"))
      lines.splice(index, 2, line + lines[index + 1]);
  });

  lines.forEach((line, index) => {
    // first line
    if (index === 0) {
      let pathName = simplePathName(line.toLowerCase(), false);
      if (pathName !== "")
        updates.set(`voie${path}nom`, capitalize(pathName));
      return;
    }

    if (strval(line).replace(/[^\x00-\xFF]/g, "") === "")
      return;
    
    // Found ability title
    const matched = line.match(/([1-9])\.[ ]+(.*)[ ]:/);
    if (matched) {
      let [ rank, title ] = matched.slice(1);
      rank = intval(rank) - base + 1;
      updates.set(`v${path}r${rank}_spell`, title.includes("*") ? 1 : 0);
      title = title.replace("*", "");
      updates.set(`voie${path}-t${rank}`, title.trim());
      ability = `voie${path}-${rank}`;
      return;
    }
    const desc = updates.has(ability) ? updates.get(ability) + " " : "";
    updates.set(ability, desc + line.trim());
  });

  return updates;
}

/**
 * On import path button click
 */
seq(9).forEach(path => {
  
  on(`clicked:import_v${path}-btn`, function() {
    getAttrs([ "voie_pdf", "from_drs", `v${path}br` ], function(values) {
      const text = strval(values.voie_pdf);
      if (text === "")
        return;
           
      const base = values[`v${path}br`];
      let updates;
      try {
        const data = JSON.parse(text);
        updates = importJsonDRS(data, path, base);
      } catch (error) {
        updates = boolval(values.from_drs)
        ? importFromDRS(text, path, base)
        : importFromPDF(text, path, base); 
      }
  
      if (updates.size > 0) {
        updates.set("voie_pdf", "");
        setAttrs(Object.fromEntries(updates), {}, () => {
          abilityUsages(path);
        });
      }
    });
  });

});

/**
 * On inserting PDF text to import - clean it
 */
on("change:voie_pdf", function() {
  getAttrs([ "voie_pdf" ], function(values) {
    let text = strval(values.voie_pdf);
    if (text === "")
      return;
    const stripped = [];
    text.split("\n").forEach(l => stripped.push(stripNonPrintable(l)));
    setAttrs({ voie_pdf: stripped.join("\n")});
  });
});

/**
 * Recalculate total encumbrance
 */
function encumbrance() {
  const section = "repeating_equipement";
  processAllGear([ "on", "qte", "enc" ], function(rowIds, allEquip) {
    getAttrs([ "cfg_use_encmb", "for", ...allEquip ], function(values) {
      const useEncumbrance = intval(values.cfg_use_encmb);
      const threshold = loadLimit(intval(values.for));
      let encumbrance = 0;
      let zeroValues = 0;
      rowIds.forEach(id => {
        const rowId = `${section}_${id}_equip-`;
        const used = intval(values[`${rowId}on`]);
        const count = intval(values[`${rowId}qte`]);
        const hasEnc = strval(values[`${rowId}enc`]);
        if (used === 0 || hasEnc === "")
          return;

        const value = intval(hasEnc);
        if (value > 0) {
          encumbrance += count * value;
        } else {
          zeroValues += count;
          if (zeroValues > 3) {
            encumbrance += Math.floor(zeroValues / 3);
            zeroValues %= 3;
          }
        }
      });

      const effects = [];
      if (encumbrance * useEncumbrance > threshold)
        effects.push("Essouflé-e et dé malus aux tests d'AGI");
      if (encumbrance * useEncumbrance > 2 * threshold)
        effects.push("Ralenti");
      if (encumbrance * useEncumbrance > 3 * threshold)
        effects.push("Immobilisé");
      if (effects.length > 0) {
        const text = "@{character_name} est encombré-e et subit les effets suivants :\n" 
        + (effects.length > 1 ? "- " : "")
        + effects.join("\n- ");
        const chatMsg = rollTemplate({
          lsub: "Encombrement",
          rsub: "Limite dépassée",
          text
        });
        sendChatMsg(chatMsg);
      }

      setAttrs({ limite_enc: threshold, total_enc: encumbrance });
    });
  });
}

/**
 * On click on the gear props help button
 */
on("clicked:helpgear-btn", function() {
  ask([
    "Type ?",
    "Armes",
    "Défense",
    "Armes magiques"
  ], function(selected, choices) {
    if (selected === 0)
      return;
    sendChatMsg([
      "title=Propriétés d'équipement",
      `subtitle=Liste des codes et valeurs (${choices[selected - 1]})`,
      selected === 1 ? "dm-1m:=Dés de DM à une main" : "",
      selected === 1 ? "dm-2m:=Dés de DM à deux mains" : "",
      selected === 1 ? "type-dm:=Types de dommages" : "",
      selected === 1 ? "critique:=Seuil de critique" : "",
      selected === 1 ? "portee:=Portée arme à distance" : "",
      selected === 1 ? "usure:=Seuil d'usure" : "",
      selected === 2 ? "bonus-def:=Bonus DEF de l'armure ou du bouclier" : "",
      selected === 2 ? "armure:=Bonus DEF de l'armure" : "",
      selected === 2 ? "armure-malus:=Malus d'armure portée" : "",
      selected === 2 ? "agi-max:=Bonus d'AGI maximum" : "",
      selected === 2 ? "bouclier:=Bonus DEF du bouclier" : "",
      selected === 2 ? "bouclier-malus:=Malus de bouclier porté" : "",
      selected === 2 ? "casque:=RD du casque contre les DM critiques" : "",
      selected === 2 ? "casque-malus:=Malus de PER et Init du casque porté" : "",
      selected === 3 ? "magie:=Bonus magique pour toucher et DM" : "",
      selected === 3 ? "magieAtt:=Bonus magique pour toucher" : "",
      selected === 3 ? "magieDmg:=Bonus magique aux DM" : "",
      selected === 3 ? "affutee:=Arme affûtée" : "",
      selected === 3 ? "element:=Nom de l'élément (+' intense')" : "",
      selected === 3 ? "fleau:=Nom du type de créature" : "",
      "desc=Une propriété par ligne"
    ].filter(t => t !== ""), {
      template: "custom",
      whisper: "gm"
    });
  });
});

/**
 * Get gear properties list from name
 * @param {string} name - gear name
 * @returns {string[]}
 */
function getGearProps(name) {
  const found = SWData.GEARS.find(gear => {
    if (cleanText(gear.name, false) === cleanText(name, false))
      return gear;
    if (strval(gear.altname) !== "") {
      if (gear.altname.split(",").includes(cleanText(name)))
        return gear;
    }
  });
  return found ? found.props : [];
}

/**
 * Return DEF bonus for armor or shield
 * @param {string} props - properties list
 * @param {string} defense - type of defense gear ("armure" | "bouclier" | "casque")
 * @returns {number}
 */
function getDefBonus(props, defense) {
  let defBonus = intval(getProp(props, defense));
  defBonus = defBonus === 0 ? intval(getProp(props, "bonus-def")) : defBonus;
  return defBonus;
}

/**
 * Return helmet malus to insert in roll
 * @param {object} values - getAttrs() object
 * @returns {string}
 */
function helmetMalus(values) {
  const helmet = intval(values.casque_eqp) * intval(values.casque);
  return (helmet > 0) ? ` - ${helmet}[Malus casque]` : "";
}

/**
 * Detect if equipment is an armor
 * @param {string} name - equipment name
 * @param {string} props - equipment properties
 * @returns {boolean}
 */
function isArmor(name, props) {
  const inName = (intval(getProp(props, "bonus-def")) !== 0) && !name.toLowerCase().includes("bouclier");
  const inProps = (intval(getProp(props, "armure")) !== 0);
  return inName || inProps;
}

/**
 * Detect if equipment is a shield
 * @param {string} name - equipment name
 * @param {string} props - equipment properties
 * @returns {boolean}
 */
function isShield(name, props) {
  const inName = (intval(getProp(props, "bonus-def")) !== 0) && name.toLowerCase().includes("bouclier");
  const inProps = (intval(getProp(props, "bouclier")) !== 0);
  return inName || inProps;
}

/**
 * Detect if equipment is a helmet
 * @param {string} props - equipment properties
 * @returns {boolean}
 */
function isHelmet(props) {
  return (intval(getProp(props, "casque")) !== 0);
}

/**
 * Detect if equipment is a weapon
 * @param {string} props - equipment properties
 * @param {string} [filter=""] - filter weapon prop
 * @returns {boolean}
 */
function isWeapon(props, filter = "") {
  if (filter !== "") {
    const dm = strval(getProp(props, filter));
    if (dm !== "" && filter === "dm-2m")
      return (strval(getProp(props, "dm-1m")) === "");
    return dm !== "";
  }
  return (strval(getProp(props, "dm-1m")) !== "" || strval(getProp(props, "dm-2m")) !== "");
}

/**
 * Return map of defense items
 * @param {object} values - getAttrs() object 
 * @param {string[]} rowIds - list of equipment item ids
 * @param {string} [type="armors"] - type of defense gear
 * @returns {Map<string, object>}
 */
function getDefGear(values, rowIds, type = "armors") {
  const gears = new Map();
  rowIds.forEach(rowId => {
    const equiped = intval(values[rptAttr("equipement", "equip-on", rowId)]);
    const name = strval(values[rptAttr("equipement", "equip-nom", rowId)]);
    const props = strval(values[rptAttr("equipement", "equip-props", rowId)]);
    if (type === "armors" && isArmor(name, props))
      gears.set(rowId, { name, equiped, props });
    if (type === "shields" && isShield(name, props))
      gears.set(rowId, { name, equiped, props });
    if (type === "helmets" && isHelmet(props))
      gears.set(rowId, { name, equiped, props });
  });
  return gears;
}

/**
 * Return map of armor items
 * @param {object} values - getAttrs() object 
 * @param {string[]} rowIds - list of equipment item ids
 * @returns {Map<string, object>}
 */
function getArmors(values, rowIds) {
  return getDefGear(values, rowIds, "armors");
}

/**
 * Return map of shield items
 * @param {object} values - getAttrs() object 
 * @param {string[]} rowIds - list of equipment item ids
 * @returns {Map<string, object>}
 */
function getShields(values, rowIds) {
  return getDefGear(values, rowIds, "shields");
}

/**
 * Return map of helmet items
 * @param {object} values - getAttrs() object 
 * @param {string[]} rowIds - list of equipment item ids
 * @returns {Map<string, object>}
 */
function getHelmets(values, rowIds) {
  return getDefGear(values, rowIds, "helmets");
}

/**
 * Return map of weapon items
 * @param {object} values - getAttrs() object 
 * @param {string[]} rowIds - list of equipment item ids
 * @param {string} [filter=""] - filter weapon props
 * @returns {Map<string, object>}
 */
function getWeapons(values, rowIds, filter = "") {
  const gears = new Map();
  rowIds.forEach(rowId => {
    const equiped = intval(values[rptAttr("equipement", "equip-on", rowId)]);
    const name = strval(values[rptAttr("equipement", "equip-nom", rowId)]);
    const props = strval(values[rptAttr("equipement", "equip-props", rowId)]);
    if (isWeapon(props, filter))
      gears.set(rowId, { name, equiped, props });
  });
  return gears;
}

function getOneHanded(values, rowIds) {
  return getWeapons(values, rowIds, "dm-1m");
}

function getTwoHanded(values, rowIds) {
  return getWeapons(values, rowIds, "dm-2m");
}

/**
 * Process a list of attack/weapons attributes
 * @param {string} section - section name (armes | npcarmes)
 * @param {string[]} attributes - list of attack attributes to retrieve
 * @param {object} callback - callback function (rowIds, allAttacks) => {}
 */
function processAllAttacks(section, attributes, callback) {
  getSectionIDsOrdered("repeating_" + section, rowIds => {
    const allAttacks = [];
    rowIds.forEach(rowId => {
      attributes.forEach(attribute => {
        allAttacks.push(rptAttr(section, `arme-${attribute}`, rowId));
      });
    });
    callback(rowIds, allAttacks);
  });
}

/**
 * Process a list of gear attributes
 * @param {string[]} attributes - list of gear attributes to retrieve
 * @param {object} callback - callback function (rowIds, allGears) => {}
 */
function processAllGear(attributes, callback) {
  const section = "equipement";
  getSectionIDs(section, rowIds => {
    const allGears = [];
    rowIds.forEach(rowId => {
      attributes.forEach(attribute => {
        allGears.push(rptAttr(section, `equip-${attribute}`, rowId));
      });
    });
    callback(rowIds, allGears);
  });
}

/**
 * Process coins & treasure
 */
SWData.COINS.forEach(coin => {
  on(`change:tresor_${coin} change:tresor_monnaie`, function() {
    const coins = SWData.COINS.map(c => `tresor_${c}`);
    getAttrs([ "tresor_monnaie", ...coins ], function(values) {
      const monnaie = intval(values.tresor_monnaie) === 2 ? "po" : "pa";
      delete values.tresor_monnaie;
      const tresor_pieces = SWData.COINS
        .filter(c => intval(values[`tresor_${c}`]) !== 0)
        .map(c=> `${ c.toUpperCase() } : ${ intval(values[`tresor_${c}`]) }`)
        .join(", ");
      const multiplier = monnaie === "pa" ? 1 : 0.1;
      values.tresor_pp = intval(values.tresor_pp) * multiplier * 100;
      values.tresor_po = intval(values.tresor_po) * multiplier * 10;
      const pc = intval(values.tresor_pc);
      values.tresor_pa = (intval(values.tresor_pa) + Math.floor(pc / 10)) * multiplier;
      values.tresor_pc = 0;
      const total = addValues(values);
      const tresor = `${total} ${ monnaie.toUpperCase() }`;
      setAttrs({ tresor, tresor_pieces }, { silent: true });
    });
  });
})

/**
 * On changes in equipement list
 */
on("change:repeating_equipement remove:repeating_equipement", function() {
  encumbrance();
});

/**
 * Display equipment details in chat
 */
on("clicked:repeating_equipement:equipshow-btn", function () {
  const section = "equipement";
  const gearAttrs = [ "nom", "qte", "detail", "props" ].map(a => rptAttr(section, `equip-${a}`));
  getAttrs([ ...gearAttrs, "character_name", "chatsetattr" ], function(values) {
    const name = strval(values[rptAttr(section, "equip-nom")]);
    const qty = numval(values[rptAttr(section, "equip-qte")]);
    const detail = strval(values[rptAttr(section, "equip-detail")]);
    const props = strval(values[rptAttr(section, "equip-props")]);
    if (detail === "" && props === "")
      return

    const chatMsg = [
      "title=Equipement",
      `subtitle=${ qty > 1 ? `${qty} x ` : "" }${name}`,
      `desc=${ strval(values.character_name) }`
    ];
    if (detail !== "")
      chatMsg.push(`text=${detail}`);
    if (props !== "") {
      props.split("\n").filter(prop => strval(prop) !== "").forEach(prop => {
        const [ code, value ] = strval(prop).split(":");
        chatMsg.push(`Prop ${code}: =${value} `);
      });
    }
    if (boolval(values.chatsetattr)) {
      const attrs = rptAttrs(
        "equipement",
        [ "nom", "detail", "modprops" ].map(a => `equip-${a}`),
        "-CREATE"
      );
      const chatSetAttrs = { [attrs[0]]: name };
      if (detail !== "")
        chatSetAttrs[attrs[1]] = detail;
      if (props !== "")
        chatSetAttrs[attrs[2]] = props.replaceAll(":","=").replaceAll("\n", "~");
      const setattrCmd = chatSetAttr({
        header: "Objet ajouté",
        content: "*" + name + "*"
      }, chatSetAttrs);
      const button = menuButton("default", { size: "1.1em" }, { 
        class: "chat-button",
        padding: "0px 5px;",
        "border-radius": "5px;"
      });
      chatMsg.push(`Objet=[Equiper](${setattrCmd}${button})`);
    }
    sendChatMsg(chatMsg, { template: "custom", whisper: "" });
  });
});

/**
 * Retrieve props from name
 */
on("change:repeating_equipement:equip-nom", function() {
  const section = "equipement";
  const gearAttrs = rptAttrs(section, [ "equip-nom", "equip-props" ]);
  getAttrs(gearAttrs, function(values) {
    const name = strval(values[rptAttr(section, "equip-nom")]);
    const hasProps = strval(values[rptAttr(section, "equip-props")]);
    if (name !== "" && hasProps === "") {
      const props = getGearProps(name);
      if (props.length > 0) {
        setAttrs({ [rptAttr(section, "equip-props")]: props.join("\n") }, { silent: true });
      }
    }
  })
});

/**
 * Re-format props to LF-delimited list of 'name: value' pairs
 */
on("change:repeating_equipement:equip-modprops", function() {
  const props = rptAttr("equipement", "equip-modprops");
  getAttrs([ props ], function(values) {
    let updated = strval(values[props]);
    if (updated.includes("~"))
      updated = updated.split("~").join("\n");
    updated = updated.split("\n").map(prop => {
      if (!prop.includes("="))
        return prop;
      const [ name, value ] = prop.split("=");
      return name + ":" + value;
    }).join("\n");
    setAttrs({ [props.replace("-mod", "-")]: updated });
  });
});

/**
 * Equip / Unequip armor & shield
 */
on("change:repeating_equipement:equip-on", function(eventInfo) {
  const { rowId: equipId } = rptInfo(eventInfo.triggerName);
  const section = "repeating_equipement";
  const hands = [
    "main_princ",
    "main_autre"
  ];
  processAllGear([ "on", "nom", "props" ], function(gearIds, allGears) {
    getAttrs([ 
      `${section}_equip-on`, 
      `${section}_equip-nom`, 
      `${section}_equip-props`, 
      `${section}_equip-atkid`, 
      ...allGears,
      ...hands
    ], function (values) {
      const equiped = intval(values[`${section}_equip-on`]);
      const name = strval(values[`${section}_equip-nom`]);
      const props = strval(values[`${section}_equip-props`]);
      const atkId = strval(values[`${section}_equip-atkid`]);
      const armor = isArmor(name, props);
      const shield = isShield(name, props);
      const helmet = isHelmet(props);
      if (!armor && !shield && !helmet && atkId === "")
        return;

      // unequip weapon in hand
      if (equiped === 0 && atkId !== "") {
        let unEquiped;
        hands.forEach(hand => {
          const [ label, attack ] = strval(values[hand]).split("~");
          if (intval(label) > 0 && attack === atkId.toLowerCase())
            unEquiped = hand;
        });
        if (unEquiped) {
          const updates = { [unEquiped]: "0" };
          if (unEquiped === hands[0] && strval(values[hands[1]] === "2m"))
            updates[hands[1]] = "0";
          setAttrs(updates);
        }
        return;
      }

      const defense = armor ? "armure" : ( shield ? "bouclier" : "casque" );
      const defBonus = getDefBonus(props, defense);

      // search for armure-malus: | bouclier-malus: | casque-malus: 
      // or set to armor | shield | casque bonus
      const malus = defense + "-malus";
      let defMalus = intval(getProp(props, malus));
      defMalus = defMalus === 0 && !hasProp(props, malus) ? defBonus : defMalus;

      const defCarMax = intval(getProp(props, "agi-max"));

      const updates = new Map();

      let gears;
      if (armor)
        gears = getArmors(values, gearIds);
      if (shield) 
        gears = getShields(values, gearIds);
      if (helmet)
        gears = getHelmets(values, gearIds);
      if (!gears)
        return;

      // un-equip any other armor or shield
      gears.keys().forEach(id => {
        if (equiped && id !== equipId)
          updates.set(`${section}_${id}_equip-on`, 0);
      });

      // nothing equiped...
      updates.set(defense + "_eqp", 0);
      // ... unless something is equiped
      gears.values().forEach(gear => {
        if (gear.equiped === 1)
          updates.set(defense + "_eqp", 1);
      });

      // set armor | shield values
      let unEquip2Hands = false;
      if (equiped === 1) {
        updates.set(defense, defBonus);
        updates.set(defense + "_malus", defMalus);
        if (armor) 
          updates.set("def_car_max", defCarMax);
        if (shield) {
          if (strval(values[hands[1]]) === "2m") {
            updates.set(hands[0], "");
            unEquip2Hands = true;
          }
          updates.set(hands[1], "bouclier");
        }
      } else {
        if (shield && strval(values[hands[1]]) === "bouclier")
          updates.set(hands[1], "");
      }

      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));

      if (unEquip2Hands) {
        sendChatMsg(rollTemplate({
          lsub: "En main",
          rsub: "Bouclier",
          text: "L'arme en main est rengainée pour lever le bouclier",
          textclass: "secondary"
        }));
      }
    });
  });
});

/**
 * Delete equiped defense gear
 */
on("remove:repeating_equipement", function (eventInfo) {
  const rowId = eventInfo.sourceAttribute + "_";
  const equiped = boolval(eventInfo.removedInfo[rowId + "equip-on"]);
  if (!equiped)
    return;
  const name = strval(eventInfo.removedInfo[rowId + "equip-nom"]);
  const props = strval(eventInfo.removedInfo[rowId + "equip-props"]);
  const defense = [];
  if (isArmor(name, props))
    defense.push(...[ "armure", "armure_eqp", "armure_malus" ]);
  if (isShield(name, props))
    defense.push(...[ "bouclier", "bouclier_eqp", "bouclier_malus" ]);
  if (isHelmet(props))
    defense.push(...[ "casque", "casque_eqp" ]);
  if (defense.length > 0)
    setAttrs(Object.fromEntries(defense.map(a => [ a, 0])));
});

/**
 * Handle attacks 
 */
on(changeEvent([
  "props",
  "atk",
  "predicats"
].map(a => `equip-${a}`), "equipement"), function (eventInfo) {
  const { rowId: gearId } = rptInfo(eventInfo.sourceAttribute);
  const gearAttrs = [
    "nom",
    "detail",
    "props",
    "atk",
    "atkid",
    "predicats"
  ].map(a => rptAttr("equipement", `equip-${a}`));
  getAttrs([ "cfg_usure", ...gearAttrs ], function(values) {
    const usure = boolval(values.cfg_usure);
    const [ name, detail, props, atk, atkid, pred ] = Object.keys(values).slice(1);
    const equipment = strval(values[name]);
    const description = strval(values[detail]);
    const properties = strval(values[props]);
    const hasAttack = boolval(values[atk]);
    const predicats = strval(values[pred]);
    let attackId = strval(values[atkid]);

    const attributes = new Map();
    const attackRow = new Map();

    if (eventInfo.sourceAttribute.endsWith("equip-atk") && !hasAttack) {
      if (attackId) {
        removeRepeatingRow(`repeating_armes_${attackId}`);
        setAttrs({ [rptAttr("equipement", "equip-atkid")]: "" });
      }
      return;
    }

    const weaponProps = [
      "dm-1m",
      "dm-2m",
      "critique",
      "type-dm",
      "portee",
      "lancer",
      "usure"
    ];

    const magicMods = [
      "magie",
      "magieAtt",
      "magieDmg",
      "affutee",
      "fleau",
      "element"
    ];

    const defProps = [ 
      "bonus-def",
      "armure",
      "armure-malus",
      "bouclier",
      "bouclier-malus",
      "agi-max",
    ];
    properties.split("\n").forEach(prop => {
      const { name, value } = parseNameValue(prop);
      if (name === "" || defProps.includes(name))
        return;
      
      attackRow.set(name, value);
    });

    if (eventInfo.sourceAttribute.endsWith("equip-atk") && hasAttack) {
      let thrownId = "";
      if (!attackId) {
        attackId = generateRowID();
        if (attackRow.has("lancer"))
          thrownId = generateRowID();
      }

      attributes.set(rptAttr("equipement", "equip-atkid"), attackId);
      const rowId = rptAttr("armes", "arme-", attackId);
      attributes.set(rowId + "nom", equipment);
      const atk = attackRow.has("portee") ? "atktir" : "atkcac";
      attributes.set(rowId + "atk", atk);
      attributes.set(rowId + "crit", strval(attackRow.get("critique")));
      const dm1m = attackRow.has("dm-1m") ? strval(attackRow.get("dm-1m")) : "";
      const dm2m = attackRow.has("dm-2m") ? strval(attackRow.get("dm-2m")) : "";
      const dm = (dm1m !== "" && dm2m !== "") 
        ? dm1m + "/" + dm2m
        : (dm2m !== "") 
          ? dm2m
          : dm1m;
      if (dm === dm2m)
        attributes.set(rowId + "2m", 1);
      attributes.set(rowId + "dm", dm);
      attributes.set(rowId + "arme-bonus", atk === "atkcac" ? "@{for}" : "");
      attributes.set(rowId + "dmtype", strval(attackRow.get("type-dm")).toLowerCase());
      attributes.set(rowId + "portee", strval(attackRow.get("portee")));
      attributes.set(rowId + "special", description);
      attributes.set(rowId + "atktype", (atk === "atkcac") ? "main" : "trait");
      attributes.set(rowId + "gearid", gearId);
      if (usure && attackRow.has("usure"))
        attributes.set(rowId + "usure", intval(attackRow.get("usure")));
      const atkmods = [];
      const options = [];
      attackRow.forEach((value, prop) => {
        if (magicMods.includes(prop)) {
          atkmods.push(prop + " " + value);
        } else {
          if (!weaponProps.includes(prop))
            options.push(`${prop}: ${value}`);
        }
      });
      if (atkmods.length > 0)
        attributes.set(rowId + "atkmods", atkmods.join(","));
      if (options.length > 0)
        attributes.set(rowId + "options", options.join("\n"));      
      attributes.set(rowId + "predicats", predicats);

      if (thrownId) {
        attributes.forEach((value, name) => {
          attributes.set(name.replace(attackId, thrownId), value);
        });
        attributes.set(rptAttr("armes", "arme-nom", thrownId), `${equipment} (lancer)`);
        attributes.set(rptAttr("armes", "arme-atk", thrownId), "atktir");
        attributes.set(rptAttr("armes", "arme-dm", thrownId), dm1m);
        attributes.set(rptAttr("armes", "arme-bonus", thrownId), "0");
        attributes.set(rptAttr("armes", "arme-portee", thrownId), attackRow.get("lancer"));
        attributes.set(rptAttr("armes", "arme-atktype", thrownId), "jet");
      }
    }

    if (attributes.size > 0)
      setAttrs(Object.fromEntries(attributes));
  });
});

/**
 * Load base gear for profile
 * @param {string} profile - profile name
 * @param {boolean} [attacks=false] - create attacks for gear
 * @returns {void}
 */
function loadBaseGear(profile, attacks = false) {
  const profileData = getProfileData(profile);
  if (!profileData)
    return;

  baseGear = new Map();
  profileData.gear.forEach(gear => {
    const rowId = `repeating_equipement_${ generateRowID() }_`;
    baseGear.set(rowId + "equip-nom", gear.name);
    baseGear.set(rowId + "equip-qte", gear.number);
    const propList = getGearProps(gear.name);
    if (propList.length > 0) {
      const props = propList.join("\n");
      baseGear.set(rowId + "equip-props", props);
      if (props.includes("bonus-def") || props.includes("armure") || props.includes("bouclier"))
        baseGear.set(rowId + "equip-on", 1);
      if (props.includes("dm-1m") || props.includes("dm-2m"))
        if (attacks)
          baseGear.set(rowId + "equip-atk", 1);
    }
  });
  if (baseGear.size > 0)
    setAttrs(Object.fromEntries(baseGear));
}

/**
 * Base gear for profile
 */
on("clicked:profequip-btn", function() {
  getAttrs(["profil"], function(values) {
    const [ profile ] = strval(values.profil).split("/");
    if (profile === "")
      return;
    ask(`Ajouter l'équipement de base pour ${profile} ?`, function(answer) {
      if (answer === 2)
        loadBaseGear(profile);
    });
  });
});

/**
 * On set resource = ammo
 */
on("change:repeating_ressources:res-props", function(eventInfo) {
  const { rowId: resourceId } = rptInfo(eventInfo.sourceAttribute);
  const rptResources = "repeating_ressources";
  const rptArmes = "repeating_armes";
  getSectionIDs(rptArmes, rowIds => {
    const allAttacks = [];
    rowIds.forEach(rowId => {
      allAttacks.push(
        ...[ "arme-atktype", "jet-nom" ].map(a => rptAttr(rptInfo(rptArmes).section, a, rowId))
      );
    });
    getAttrs([
      "cfg_use_ammo",
      `${rptResources}_res-desc`,
      `${rptResources}_res-props`,
      ...allAttacks 
    ], function(values) {
      const useAmmo = boolval(values.cfg_use_ammo);
      if (!useAmmo)
        return;

      const desc = strval(values[`${rptResources}_res-desc`]);
      const props = strval(values[`${rptResources}_res-props`]);
      if (getProp(props, "type").toLowerCase() !== "munitions")
        return;

      const thrownIds = allAttacks
      .filter(a => a.endsWith("arme-atktype"))
      .filter(a => values[a] === "trait")
      .map(a => rptInfo(a).rowId);
      let updates;
      thrownIds.forEach(id => {
        const name = `${rptArmes}_${id}_jet-nom`;
        if (cleanText(values[name]) === cleanText(desc))
          updates = { [`${rptArmes}_${id}_jet-resid`]: resourceId };
      });
      if (updates)
        setAttrs(updates);
    });
  })
});

/**
 * On change of ammo-type resource
 */
on("change:repeating_ressources:res-val", function(eventInfo) {
  const section = "ressources";
  const attrs = rptAttrs(section, [ "res-desc", "res-val", "res-props" ]);
  getAttrs([ "cfg_use_ammo", "cfg_ammo_alert", ...attrs ], function (values) {
    const useAmmo = boolval(values.cfg_use_ammo);
    if (!useAmmo)
      return;
    
    const ammoAlert = intval(values.cfg_ammo_alert);
    const desc = strval(values[rptAttr(section, "res-desc")]);
    const props = strval(values[rptAttr(section, "res-props")]);
    if (getProp(props, "type").toLowerCase() !== "munitions")
      return;

    const value = intval(values[rptAttr(section, "res-val")]);
    if (value <= 0 || value <= ammoAlert) {
      const text = value <= 0 ? `Plus de ${desc}` : `Plus que ${value} ${desc}`;
      const textclass = value <= 0 ? "fumble" : "secondary";
      const chatMsg = rollTemplate({
        lsub: "Attaque",
        rsub: "Munitions",
        text,
        textclass
      });
      sendChatMsg(chatMsg);
    }
  });
});

/**
 * On click of consumable button
 */
on("clicked:repeating_ressources:resconso-btn", function () {
  const section = "ressources";
  getAttrs(rptAttrs(section, [ "res-desc", "res-val", "res-props" ]), function (values) {
    const updates = new Map();
    const value = intval(values[rptAttr(section, "res-val")]);
    if (value === 0)
      return;
    const remaining = value - 1;
    updates.set(rptAttr(section, "res-val"), remaining);
    let text = "";
    let heal = "";
    const rsub = capitalize(strval(values[rptAttr(section, "res-desc")]));
    const props = strval(values[rptAttr(section, "res-props")]);
    const type = strval(getProp(props, "type"));
    if (type.toLowerCase().startsWith("soins")) {
      let [ ...roll ] = type.trim().split(" ").slice(1);
      if (roll.length === 0)
        roll.push("1d4°");
      heal = insertRolls(roll.join(" "));
      text = `Reste ${remaining} ${ rsub.toLowerCase() }`;
    }

    if (heal !== "" || text !== "") {
      const chatMsg = rollTemplate({
        lsub: "Consommable",
        rsub,
        heal,
        text
      });
      sendChatMsg(chatMsg);
    }

    setAttrs(Object.fromEntries(updates));
  });
});

/**
 * Rebuild all ranks in path
 */
function rebuildRanks() {
  const allPaths = [];
  seq(9).forEach(v => {
    allPaths.push([]);
    seq(5).forEach(r => {
      allPaths[v - 1].push(`v${v}r${r}`);
    });
  });
  const allRanks = allPaths.reduce((all, path) => {
    path.forEach(rank => {
      all.push(rank);
    });
    return all;
  }, []);
  const allBases = nameSeq(9, "v#br");
  getAttrs([ ...allRanks, ...allBases ], function(values) {
    const ranks = new Map();
    allPaths.forEach((path, v) => {
      const pathNum = v + 1;
      ranks.set(`rang_voie${pathNum}`, 0);
      path.forEach((rank, r) => {
        if (intval(values[rank]) === 1) {
          const rankInPath = intval(values[`v${pathNum}br`]) + r;
          ranks.set(`rang_voie${pathNum}`, rankInPath);
        }
      });
    });
    setAttrs(Object.fromEntries(ranks));
  });
}

/**
 * Link attacks to gears (by name)
 */
async function linkAttacks() {
  // attack rows
  const atkIds = await getSectionIDsAsync("armes");
  const allAttacks = [];
  atkIds.forEach(id => {
    [ "nom", "atktype", "gearid" ].forEach(attr => {
      allAttacks.push(rptAttr("armes", `arme-${attr}`, id));
    });
  });

  // gear rows
  const gearIds = await getSectionIDsAsync("equipement");
  const allGears = gearIds.map(id => rptAttr("equipement", "equip-nom", id));

  getAttrs([ ...allAttacks, ...allGears ], function (values) {
    const links = new Map();
    atkIds.forEach(id => {
      const type = strval(values[rptAttr("armes", "arme-atktype", id)]);
      if ([ "sort", "naturel" ].includes(type))
        return;
      const nom = strval(values[rptAttr("armes", "arme-nom", id)]);
      const gear = allGears.find(gear => cleanText(nom, false).includes(cleanText(strval(values[gear]), false)));
      if (gear) {
        const gearId = rptInfo(gear).rowId;
        if (gearId)
          links.set(rptAttr("armes", "arme-gearid", id), gearId);
      }
    });
    if (links.size > 0)
      setAttrs(Object.fromEntries(links));
  });

  /*
  getSectionIDs("armes", atkIds => {
    getSectionIDs("equipement", gearIds => {
      const allAttacks = [];
      atkIds.forEach(id => {
        [ "nom", "atktype", "gearid" ].forEach(attr => {
          allAttacks.push(rptAttr("armes", `arme-${attr}`, id));
        });
      });
      const allGears = gearIds.map(id => rptAttr("equipement", "equip-nom", id));
    });
  });*/
}

/**
 * On appearance / NPC description button click
 */

on("clicked:appearance-btn clicked:description-btn", function() {
  getAttrs([
    "sheet_type",
    "character_avatar", "character_token",
    "apparence", "pnj_desc"
  ], function(values) {
    
    const text = strval(values.sheet_type) === SWData.SHEET_TYPE.PC 
    ? strval(values.apparence) 
    : strval(values.pnj_desc);
    sendChatMsg(rollTemplate({ text }), { whisper: "" } );
    
    let avatar = strval(values.character_avatar);
    if (!avatar)
      avatar = strval(values.character_token);
    if (avatar)
      sendChatCmd(avatar);
  })
});

/**
 * On clicking the default configuration button
 */
on("clicked:def_config-btn", function() {
  const allConfigs = [
    "cfg_pvmax_auto",
    "cfg_pts_capas",
    "cfg_cible",
    "voies_456",
    "voies_789",
    "use_skills",
    "$cfg_init_variable",
    "cfg_init_mod",
    "cfg_init_agi",
    "cfg_use_encmb",
    "cfg_pc_var",
    "cfg_bouclier_malus",
    "cfg_use_ammo",
    "cfg_ammo_alert",
    "cfg_crit_diff",
    "cfg_tbl_crit",
    "cfg_tbl_fumble",
    "cfg_use_epic",
    "cfg_use_drniv",
    "cfg_use_mana",
    "cfg_use_capped6",
    "cfg_use_dronly",
    "cfg_atk_diff",
    "cfg_usure",
    "cfg_use_fear",
    "cfg_shadow",
    "pvmax_force",
    "drmax_force",
    "pcmax_force",
    "pmmax_force",
    "notif_conditions",
    "notif_pv",
    "$notif_fx",
    "cfg_1attack_roll",
    "cfg_1skill_roll",
    "cfg_d20roll",
    "cfg_luck_btn",
    "cfg_d20roll",
    "tokenmod",
    "tkmarker_dead_on",
    "$tkmarker_dead",
    "token_tint_on",
    "$token_tint",
    "tkmarker_tooltip_on",
    "tkmarker_pc_on",
    "$tkmarker_pc",
    "tkmarker_cond",
    "chatsetattr",
    "$tresor_monnaie",
  ];
  getAttrs([ "character_name", "sheet_type", ...allConfigs ], function(values) {
    const sheetBase = strval(values.sheet_type) === SWData.SHEET_TYPE.PC ? "PJBase" : "PNJBase";

    // PJBase / PNJBase : make sure all attributes are created
    if (strval(values.character_name).trim() === sheetBase) {
      const updates = new Map();
      allConfigs.filter(attr => !attr.startsWith("$")).forEach(attr => updates.set(attr, intval(values[attr])));
      setAttrs(Object.fromEntries(updates));
      return;
    }

    // Other PCs : copy config
    const askValues = allConfigs.map(attr => {
      if (attr.startsWith("$"))
        return `{{${attr.slice(1)}=[[0[@{${sheetBase}|${attr.slice(1)}}] ]]}}`;
      else
        return `{{${attr}=[[@{${sheetBase}|${attr}}]]}}`;
    }).join(" ");
    startRoll("! " + askValues, values => {
      const updates = new Map();
      allConfigs.forEach(configAttr => {
        let value;
        if (configAttr.startsWith("$"))
          value = getRollData(values, configAttr.slice(1));
        else
          value = intval(values.results[configAttr].result);
        if (value)
          updates.set(configAttr.replace("$",""), value);
      });
      setAttrs(Object.fromEntries(updates));
  
      finishRoll(values.rollId);
    });
  });
});

/**
* On clicking the Reset button
*/
on("clicked:reset_all-btn", function() {
  const e = { triggerName: "RESET" };
  updateDRMax(e);
  updatePMMax(e);
  updatePCMax(e);
  updatePVMax(e);
  updateInit(e);
  updateDef(e);
  abilityUsages(e);
  encumbrance(e);
  rebuildRanks(e);
  updateAbilityList(e)
  rebuildBuffLists(e);
  rebuildBuffValues(e);
  rebuildCustom(e);
  ask("Lier attaques et équipements ?", function(answer) {
    if (answer === 2)
      linkAttacks();
  });
});

/**
 * On changing all high/low fantasy options
 */
on("change:cfg_highfan change:cfg_lowfan", function (eventInfo) {
  const { sourceAttribute } = eventInfo;
  getAttrs([ "cfg_highfan", "cfg_lowfan" ], function (values) {
    const checked = intval(values[sourceAttribute]);
    let options;
    switch (sourceAttribute) {
      case "cfg_highfan":
        options = SWData.settings.highFan;
        break;
      case "cfg_lowfan":
        options = SWData.settings.lowFan;
        break;
    }
    const subOptions = new Map(options.map(o => [ o, checked]));
    setAttrs(Object.fromEntries(subOptions));
  });
});

/**
 * On changing high fantasy options
 */
on(changeEvent(SWData.settings.highFan), function () {
  getAttrs(SWData.settings.highFan, function (values) {
    if (Object.values(values).every(v => boolval(v)))
      setAttrs({ cfg_highfan: 1 }, { silent: true });
  });
});

/**
 * On changing low fantasy options
 */
on(changeEvent(SWData.settings.lowFan), function () {
  getAttrs(SWData.settings.lowFan, function (values) {
    if (Object.values(values).every(v => boolval(v)))
      setAttrs({ cfg_lowfan: 1 }, { silent: true });
  });
});

/**
 * Rebuild custom attributes 
 */
function rebuildCustom() {
  getAttrs([ "custom" ], function (values) {
    const rows = strval(values.custom)
      .split("\n")
      .map(r => strval(r).trim())
      .filter(r => r !== "" && !r.startsWith("//"));
    if (rows.length === 0)
      return;
    
    const updates = new Map();
    rows.forEach(row => {
      const { name, value } = parseNameValue(row);
      if (!name)
        return;
      updates.set(`${name}`, replaceDevol(value));
    });

    if (updates.size > 0)
      setAttrs(Object.fromEntries(updates));
  });
}

/**
 * On changing the custom attributes code
 */
on("change:custom", rebuildCustom);

/**
 * On changing the stats associated with custom skills
 */
nameSeq(4, "custom#").forEach(custom => {
  const custSkillStats = SWData.PC.STATS.map(stat => `${custom}_${ shorten(stat) }`);
  const events = eventList("change", custSkillStats, " ");
  on(events, function() {
    getAttrs(custSkillStats, function(values) {
      const stats = custSkillStats.filter(custStat => boolval(values[custStat]));
      let useStat = "";
      if (stats.length === 1)
        useStat = "@{" + stats[0].split("_")[1] + "}";
      else
        useStat = "?";
      setAttrs({ [custom + "_carac"]: useStat });
    });
  });
});

on("change:pense_bete change:tokenmod change:token_tooltip_on", function() {
  getAttrs([ "character_name", "pense_bete", "tokenmod", "token_tooltip_on" ], function(values) {
    const tokenmod = boolval(values.tokenmod);
    if (!tokenmod)
      return;
    const charName = strval(values.character_name).trim();
    const reminder = strval(values.pense_bete).trim().split("\n")
    .map((r, ix) => `${ix + 1}) ${r}`).join("; ");
    const tokenTip = boolval(values.token_tooltip_on);
    if (!tokenTip || charName === "" || reminder === "")
      return;
    sendChatCmd(tokenMod(strval(values.character_name), { tooltip: "'" + reminder + "'" }));
  });
});

/**
 * Return an updated Map of attributes
 * @param {object} charData - character data
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map}
 */
function importProfile(charData, attributes) {
  if (charData.profile)
    attributes.set("profil", charData.profile);
  if (charData.family)
    attributes.set("famille", charData.family);
  
  let buff = [];
  switch (charData.familyId) {
    case "aventuriers":
      attributes.set("drecup", 8);
      buff = [ "Profil d'aventurier", "pc" ];
      break;
    
    case "combattants":
      attributes.set("drecup", 10);
      break;

    case "mages":
      attributes.set("drecup", 6);
      break;

    case "mystiques":
      attributes.set("drecup", 8);
      buff = [ "Profil de mystique", "dr" ];
      break;
  
    default:
      break;
  }

  if (buff.length > 0) {
    const rowId = `repeating_buffs_${ generateRowID() }_`;
    const [ name, attrib ] = buff;
    attributes.set(rowId + "buff-on", "1");
    attributes.set(rowId + "buff-nom", name);
    attributes.set(rowId + "buff-attrib", attrib);
    attributes.set(rowId + "buff-value", "1");
  }

  if (charData.paths[0].name !== "")
    attributes.set("peuple", charData.paths[0].name);

  charData.paths.forEach((path, ix) => {
    const pathNum = ix + 1
    attributes.set(`voie${ pathNum }nom`, path.name);
    path.abilities.forEach((rank, ix) => {
      rankNum = ix + 1;
      const type = rank.limitedUse !== "" ? rank.limitedUse : rank.actionType;
      attributes.set(`voie${pathNum}-t${rankNum}`, rank.name + type);
      attributes.set(`voie${pathNum}-${rankNum}`, rank.description);
      attributes.set(`v${pathNum}r${rankNum}_spell`, (rank.spell === "*" ? "1" : "0"));
      attributes.set(`v${pathNum}r${rankNum}_use`, 0);
      attributes.set(`v${pathNum}r${rankNum}_use_max`, 0);
      attributes.set(`v${pathNum}r${rankNum}_freq`, "");
      if (rank.uses > 0) {
        const { number = 0, per = "" } = rank.uses;
        if (number > 0 && per !== "") {
          attributes.set(`v${pathNum}r${rankNum}_use_max`,number);
          attributes.set(`v${pathNum}r${rankNum}_freq`, per);
        }
      }
    });
  });

  return attributes;
}

/**
 * Process gears property of JSON blob
 * @param {object} gearData - gears property of PC data
 * @param {Map} attributes - Map of attributes to update
 * @returns {Map} updated Map object
 */
function importGears(gearData, attributes) {

  gearData.forEach(gear => {
    const rowId = `repeating_equipement_${ generateRowID() }_`;

    attributes.set(rowId + "equip-nom", gear.designation);
    
    attributes.set(rowId + "equip-qte", gear.nombre);
    if (gear.special !== "") 
      attributes.set(rowId + "equip-detail", gear.special);
    
    const props = gear.props
      .filter(prop => SWData.GEARPROPS.includes(prop.id))
      .map(prop => `${prop.id}: ${prop.valeur}`);
    if (props.length > 0)
      attributes.set(rowId + "equip-props", props.join("\n"));
  })

  return attributes;
}

/**
 * Click on button to display link to COMob Export in chat
 */
on("clicked:comob_export-btn", function () {
  sendChatMsg("[Export Chroniques Mobiles](https://comob-data.rpgapps.net)", { template: "" });
});

/**
 * On import JSON data button click
 */
on("clicked:import_json-btn", function () {
  getAttrs([ "json_profile", "reset_gears" ], function (values) {
    const jsonData = strval(values.json_profile).trim();
    if (jsonData === "")
      return;

    let attributes = new Map();

    const profileData = objval(jsonData);

    if (profileData.character)
      attributes = importProfile(profileData.character, attributes);

    if (profileData.gears) {
      const resetGears = intval(values.reset_gears);
      if (resetGears === 1)
        removeRepeatingAll("equipement");
      attributes = importGears(profileData.gears, attributes);
    }

    if (attributes.size > 0) {
      attributes.set("json_profile", "");
      setAttrs(Object.fromEntries(attributes));
    }
  });
});

/**
 * On change of debug mode state
 */
on("change:debug_mode", function() {
  getAttrs([ "debug_mode" ], function(values) {
    setDebugMode(values.debug_mode);
  });
});

/**
 * On help doc button click
 */
on("clicked:helpdoc-btn", function() {
  sendChatMsg("[Documentation](https://stephaned68.github.io/COF2e/)", { template: "" });
});

/**
 * Return CSS style for chat menu buttons
 * @param {string|string[]} color - PC color name | [ bckg, text ] color array
 * @param {object} [font={}] - font properties object
 * @param {object} [extraCSS={}] - extra properties object
 * @param {object} [attributes={}] - extra attributes object
 * @returns {string}
 */
function menuButton(color, font = {}, extraCSS = {}, attributes = {}) {
  
  color = color || "default";
  let backColor, textColor;
  if (Array.isArray(color))
    [ backColor, textColor = "white" ] = color;
  else
    [ backColor, textColor ] = SWData.COLORS[color];
  if (Object.keys(extraCSS).includes("color")) {
    textColor = extraCSS.color;
    delete extraCSS.color;
  }
  if (Object.keys(extraCSS).includes("background-color")) {
    backColor = extraCSS["background-color"];
    delete extraCSS["background-color"];
  }

  font = { size: "0.8rem", weight: "bold", ...font };
  
  let border = "none";
  let radius = "3px";
  if (Object.keys(extraCSS).includes("border")) {
    border = extraCSS.border;
    delete extraCSS.border;
  }
  if (Object.keys(extraCSS).includes("border-radius")) {
    radius = extraCSS["border-radius"];
    delete extraCSS["border-radius"];
  }

  let padding = "2px";
  if (Object.keys(extraCSS).includes("padding")) {
    padding = extraCSS.padding;
    delete extraCSS.padding;
  }

  let margin = "1px";
  if (Object.keys(extraCSS).includes("margin")) {
    margin = extraCSS.margin;
    delete extraCSS.margin;
  }
  
  const buttonTitle = (attributes.title) ? ` title=\"${attributes.title}\"` : "";

  let buttonClass = "";
  if (extraCSS.class) {
    buttonClass = ` class=\"${extraCSS.class}\"`;
    delete extraCSS.class;
  }
  
  const props = Object.keys(extraCSS).map(prop => `${prop}: ${ extraCSS[prop] }`);
  return `\"${buttonTitle}${buttonClass} style=\"` + [
    `border: ${border}`,
    `border-radius: ${radius}`,
    `background-color: ${backColor}`,
    `color: ${textColor}`,
    `padding: ${padding}`,
    `margin: ${margin}`,
    `font-size: ${font.size}`,
    `font-weight: ${font.weight}`,
    ...props
  ].join("; ");
}

/**
 * Return CSS style for chat outline menu buttons
 * @param {string} color - PC color name
 * @param {object} [font={}] - font properties object
 * @param {object} [extraCSS={}] - extra properties object
 * @param {object} [attributes={}] - extra attributes object
 * @returns {string}
 */
function menuButtonOutline(color, font = {}, extraCSS = {}, attributes = {}) {
  if (!Object.keys(SWData.COLORS).includes(color))
    color = "default";
  const reverse = [ "whitesmoke", SWData.COLORS[color][0] ];
  return menuButton(reverse, font, {
    border: `1px ${ reverse[1] } solid`,
    color: "#333",
    ...extraCSS
  }, attributes);
}

/**
 * Display roll query for stats
 */
on("clicked:caract_select-btn", function () {
  const allStats = SWData.PC.STATS.map(stat => `${shorten(stat)}`);
  const allTests = SWData.PC.STATS.map(stat => `${shorten(stat)}_test`);
  const allSupH = SWData.PC.STATS.map(stat => `${shorten(stat)}_sup`);
  getAttrs([ "sheet_type", "character_name", ...allStats, ...allTests, ...allSupH ], function (values) {
    const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
    const charName = strval(values.character_name);
    const statSelect = SWData.PC.STATS.map((stat, ix) => {
      const short = shorten(stat);
      const supH = SWData.PC.STATSUP[strval(values[`${short}_sup`], "N")];
      const test = isNPC ? "" : "_test";
      return `${ short.toUpperCase() } (${ displayMod(values[`${short}${test}`]) })${supH},${ix + 1}`
    });
    ask([ "Carac. ?", ...statSelect ], (selected) => {
      const stat = shorten(SWData.PC.STATS[selected -1]);
      const select = isNPC ? "" : "_select";
      sendChatCmd(`%{${charName}|${stat}${select}-btn}`);
    });
  });
});

/**
 * Display stats rolls chat menu
 */
on("clicked:caract_menu-btn", function () {
  const allStats = SWData.PC.STATS.map(stat => `${shorten(stat)}`);
  const allTests = SWData.PC.STATS.map(stat => `${shorten(stat)}_test`);
  getAttrs([ "sheet_type", "character_name", "couleur_pj", ...allStats, ...allTests ], function (values) {
    const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj);
    const chatMsg = SWData.PC.STATS.map(stat => {
      const short = shorten(stat);
      const select = isNPC ? "" : "_select";
      const test = isNPC ? "" : "_test";
      const button = menuButton(color, {}, { width: "3.5rem", ["text-align"]: "center" });
      return `${capitalize(stat)}=[${short.toUpperCase()} (${ values[`${short}${test}`] })](~${charName}|${short}${select}-btn${button})`;
    });
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Jets de caractéristiques",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
});

/**
 * Display conditions menu
 */
on("clicked:etats_menu-btn", function() {
  getAttrs([ 
    "character_name",
    "couleur_pj",
    "notif_conditions",
    "cfg_lowfan",
    ...allConditions()
  ], function (values) {
    const charName = strval(values.character_name);
    const whisper = intval(values.notif_conditions) === 2 ? "gm" : "";
    const lowFantasy = boolval(values.cfg_lowfan);
    const chatMsg = SWData.PC.CONDITIONS
    .filter(condition => {
      if (condition.name === "inconscient")
        return;
      if (condition.lowFantasy && !lowFantasy)
        return;
      return condition;
    })
    .map(condition => {
      const color = boolval(values[`condition_${condition.name}`]) ? [ "#dc3545" ] : [ "#198754" ];
      const button = menuButton(color, {}, { 
        padding: "0px 5px;",
        "border-radius": "50%;",
        "min-width": "10px;"
      });
      return `${condition.label}=[&nbsp;](~${charName}|${condition.name}-icon${button})`;
    });
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Etats préjudiciables",
      "color=" + strval(values.couleur_pj),
      ...chatMsg
    ], {
      whisper,
      template: "custom"
    });
  });
});

/**
 * Display attack rolls chat menu
 * @param {string} [npc=""] - PC ("") or NPC ("npc") attacks
 */
function attackRollsMenu(npc = "") {
  const section = `${npc}armes`;
  getSectionIDsOrdered("repeating_" + section, function (rowIds) {
    const attackNames = rowIds.map(rowId => rptAttr(section, "arme-nom", rowId));
    const atkType = rowIds.map(rowId => rptAttr(section, "arme-atk", rowId));
    const atkRange = rowIds.map(rowId => rptAttr(section, "arme-portee", rowId));
    const attackBtn = (npc === "") ? "attack" : "npcatk";
    getAttrs([
      "character_name",
      "couleur_pj",
      ...attackNames,
      ...atkType,
      ...atkRange
    ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj, "default");
      if (npc === "npc") {
        if (attackNames.length === 0)
          return;
        if (attackNames.length === 1) {
          const action = `%{${charName}|${ rptAttr("npcarmes", "npcatk-btn", rowIds[0]) }}`;
          sendChatCmd(action);
        } else {
          const attackSelect = rowIds.map((rowId,ix) => values[rptAttr(section, "arme-nom", rowId)] + `,${ix + 1}`);
          ask([ "Attaque ?", ...attackSelect ], (attack) => {
            const action = `%{${charName}|${ rptAttr("npcarmes", "npcatk-btn", rowIds[attack - 1]) }}`;
            sendChatCmd(action);
          });
        }
      } else {
        const button = menuButtonOutline(color, {}, { padding: "0px 5px;" });
        const chatMsg = rowIds.map((rowId, ix) => {
          const type = strval(values[rptAttr(section, "arme-atk", rowId)]);
          const range = strval(values[rptAttr(section, "arme-portee", rowId)]);
          const emoji = type === "atkmag" ? SWData.emojis.atkmag : isRanged(type, range) ? SWData.emojis.atktir : SWData.emojis.atkcac;
          return `${ix + 1}. ${ values[rptAttr(section, "arme-nom", rowId)] }=[${emoji}](~${charName}|${ rptAttr(section, attackBtn + "-btn", rowId) }${button})`;
        });
        if (chatMsg === "")
          return;
        sendChatMsg([
          `title=${charName}`,
          "subtitle=Jets d'attaque",
          "color=" + color,
          ...chatMsg
        ], {
          template: "custom",
          whisper: "gm"
        });
      }
    });
  });
}

on("clicked:attacks_menu-btn", function () {
  attackRollsMenu();
});

/**
 * Paths menu
 */
on("clicked:abilities_menu-btn", function () {
  getAttrs([ "character_name", "couleur_pj", "rangs_voies", "noms_voies" ], function (values) {
    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj);
    const pathRanks = strval(values.rangs_voies).split(",");
    const pathNames = strval(values.noms_voies).split("|");
    const chatMsg = pathRanks.reduce((result, rank, ix) => {
      if (intval(rank) > 0) {
        const button = menuButton(color, {}, { padding: "0px 5px;" });
        result.push(`${pathNames[ix]}=[Capacités](~${charName}|voie${ix + 1}_menu-btn${button})`);
      }
      return result;
    }, []);
    if (chatMsg === 0)
      return;
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Voies",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
});

/**
 * Abilities menu
 */
seq(9).forEach(path => {
  on(`clicked:voie${path}_menu-btn`, function () {
    const abilities = seq(5).map(rank => abilityInfo({ path, rank }).rankName);
    const spells = seq(5).map(rank => abilityInfo({ path, rank }).rankSpell);
    getAttrs([
      "character_name",
      "couleur_pj",
      "rangs_voies",
      "noms_voies",
      ...abilities,
      ...spells
    ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj, "default");
      const pathRank = intval(strval(values.rangs_voies).split(",")[path - 1]);
      const pathName = strval(strval(values.noms_voies).split("|")[path -1]);
      const chatMsg = seq(5).reduce((result, rank) => {
        if (rank <= pathRank) {
          const abilityName = values[abilityInfo({ path, rank }).rankName];
          const spell = boolval(values[abilityInfo({ path, rank }).rankSpell]);
          const emoji = spell ? SWData.emojis.atkmag : SWData.emojis.actions;
          const button = menuButtonOutline(color, {}, { padding: "0px 5px;" });
          result.push(`${abilityName}=[${emoji}](~${charName}|v${path}r${rank}-btn${button})`);
        }
        return result;
      }, []);
      if (chatMsg === 0)
        return;
      sendChatMsg([
        `title=${charName}`,
        "subtitle=Voie : " + pathName,
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
});

/**
 * Display ability rolls menu
 * @param {string} [npc=""] - PC ("") or NPC ("npc") ability rolls
 */
function abilityRollsMenu(npc = "") {
  const section = `repeating_${npc}rolls`;
  getSectionIDsOrdered(section, function (rowIds) {
    const rollNameAttr = (npc === "") ? "roll-nom" : "npcroll-name";
    const rollNames = rowIds.map(rowId => `${section}_${rowId}_${rollNameAttr}`);
    getAttrs([ "character_name", "couleur_pj", ...rollNames ], function (values) {
      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj, "default");
      const button = menuButtonOutline(color, {}, { padding: "0px 5px;" });
      const chatMsg = rowIds.map((rowId, ix) => `${ix + 1}. ${values[`${section}_${rowId}_${rollNameAttr}`]}=[${ SWData.emojis.actions }](~${charName}|${section}_${rowId}_${npc}roll-btn${button})`);
      if (chatMsg.length === 0)
        return;
      sendChatMsg([
        `title=${charName}`,
        "subtitle=Jets de Capacités",
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
}

/**
 * Ability rolls menu
 */
on("clicked:rolls_menu-btn", function () {
  abilityRollsMenu();
});

/**
 * Skill rolls popup
 */
on("clicked:skills_menu-btn", function () {
  const skillMods = SWData.PC.SKILLS.map((skill) => `${ skill.name }_bonus`);
  getAttrs([ "character_name", ...skillMods ], function (values) {
    const charName = strval(values.character_name);
    const skillSelect = SWData.PC.SKILLS.map((skill, ix) => {
      const skillLabel = getSkillName(skill);
      const skillStat = Array.isArray(skill.ability) ? "" : " " + skill.ability.toUpperCase();
      const skillBonus = intval(values[`${ skill.name }_bonus`]);
      const skillMod = skillBonus > 0 ? ` (+${skillBonus})` : "";
      return `${skillLabel}${skillStat}${skillMod},${ix + 1}`;
    });
    ask([ "Compétence ?", ...skillSelect ], (skill) => {
      const skillName = SWData.PC.SKILLS[skill -1].name;
      const action = "%{" + charName + "|skill-" + skillName + "}";
      sendChatCmd(action);
    });
  });
});

/**
 * Display all rolls menu
 */
function allRollsMenu(npc = "") {
  getAttrs([ "character_name", "couleur_pj", "use_skills" ], function (values) {
    const charName = strval(values.character_name);
    const color = (npc === "") ? strval(values.couleur_pj) : "";
    let menus = [ "caract_select:Caractéristiques" ];
    if (npc === "npc") {
      menus = [ ...menus, "npcatks_menu:Attaques", "npcrolls_menu:Capacités" ];
    } else {
      menus = [ ...menus, "attacks_menu:Attaques", "abilities_menu:Capacités", "rolls_menu:Jets de Capacités" ];
      if (boolval(values.use_skills))
        menus.push("skills_menu:Jets de Compétences");
    }
    const chatMsg = menus.map(m => {
      const [ button, label ] = m.split(":");
      const menuBtn = menuButton(color, {}, { padding: "0px 5px;" });
      return `${label}=[Menu](~${charName}|${button}-btn}${menuBtn})`;
    });
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Menus",
      "color=" + color,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "gm"
    });
  });
}

on("clicked:pc_menus-btn", function () {
  allRollsMenu();
});

/**
 * Display a PC actions menu
 */
on("clicked:pc_actions-btn clicked:npc_actions-btn", async function(eventInfo) {

  const isNPC = strval(eventInfo.triggerName).split(":")[1].startsWith("npc");

  // weapons
  const weaponRpt = isNPC ? "npcarmes" : "armes";
  const weaponIds = await getSectionIDsOrderedAsync(weaponRpt);
  const attackNames = weaponIds.map(id => rptAttr(weaponRpt, "arme-nom", id));
  const atkType = weaponIds.map(id => rptAttr(weaponRpt, "arme-atk", id));
  const atkRange = weaponIds.map(id => rptAttr(weaponRpt, "arme-portee", id));

  // abilities
  const allRankNames = [];
  const allRankSpells = [];
  const allRankProps = [];
  seq(9).forEach((path) => {
    seq(5).forEach((rank) => {
      allRankNames.push(abilityInfo({ path, rank }).rankName);
      allRankSpells.push(abilityInfo({ path, rank }).rankSpell);
      allRankProps.push(abilityInfo({ path, rank }).rankProps);
    });
  });

  // rolls
  const rollRpt = isNPC ? "npcrolls" : "rolls";
  const rollNameAttr = isNPC ? "npcroll-name" : "roll-nom";
  let rollIds = await getSectionIDsOrderedAsync(rollRpt);
  const rollNames = rollIds.map(id => rptAttr(rollRpt, rollNameAttr, id));

  // buffs
  const buffRpt = "buffs";
  let buffIds = await getSectionIDsOrderedAsync(buffRpt);
  const buffTemp = buffIds.map(id => rptAttr(buffRpt, "buff-temp", id));

  // resources
  const resRpt = "ressources";
  let resIds = await getSectionIDsOrderedAsync(resRpt);
  const resDesc = resIds.map(id => rptAttr(resRpt, "res-desc", id));
  const resProps = resIds.map(id => rptAttr(resRpt, "res-props", id));
  const resVals = resIds.map(id => rptAttr(resRpt, "res-val", id));

  getAttrs([
    "character_name", "couleur_pj",
    ...attackNames, ...atkType, ...atkRange,
    "rangs_voies", "noms_voies",
    ...allRankNames, ...allRankSpells, ...allRankProps,
    ...rollNames,
    ...buffTemp,
    ...resDesc, ...resProps, ...resVals,
    "use_skills"
  ], function (values) {

    /**
     * Build extra properties & CSS for chat menu outline buttons
     * @param {object} css - CSS properties
     * @param {object} attrs - Extra button attributes
     * @returns {string}
     */
    const button = (css = {}, attrs = {}) => menuButtonOutline(color, {}, { padding: "0px 5px", ...css }, attrs);

    const charName = strval(values.character_name);
    const color = strval(values.couleur_pj, "default");
    const chatMsg = [];
    
    // Stats
    const stats = SWData.PC.STATS.map(stat => {
      const short = shorten(stat);
      const button = menuButton(color, {}, { width: "2rem", ["text-align"]: "center" });
      return `[${short.toUpperCase()}](~${charName}|${short}-btn${button})`;
    }).join(" ");
    chatMsg.push("Caractéristiques=" + stats);

    // Attacks
    if (!isNPC) {
      const attacks = SWData.PC.COMBAT.attacks.map((attack) => {
        const emoji = SWData.emojis[attack[0]];
        return `[${emoji}](~${charName}|${ attack[0] }-btn${ button({}, { title: attack[2] }) })`;
      }).join(" ");
      chatMsg.push("Attaques=" + attacks);
    }

    // Weapons
    const weapons = weaponIds.map((id) => {
      const type = strval(values[rptAttr(weaponRpt, "arme-atk", id)]);
      const range = strval(values[rptAttr(weaponRpt, "arme-portee", id)]);
      const emoji = type === "atkmag" ? SWData.emojis.atkmag : isRanged(type, range) ? SWData.emojis.atktir : SWData.emojis.atkcac;
      const atkBtn = isNPC ? "npcatk-btn" : "attack-btn";
      return `[${emoji}](~${charName}|${ rptAttr(weaponRpt, atkBtn, id) }${ button() }) ${ values[rptAttr(weaponRpt, "arme-nom", id)] }`;
    }).join("\n");
    if (weapons.length > 0)
      chatMsg.push("Armes=" + weapons);

    // Abilities
    if (!isNPC) {
      const pathRanks = strval(values.rangs_voies).split(",");
      const pathNames = strval(values.noms_voies).split("|");
      pathNames.forEach((pathName, ix) => {
        const pathRank = intval(pathRanks[ix])
        if (pathRank === 0)
          return;
        const path = ix + 1;
        const abilities = seq(pathRank).reduce((all, rank) => {
          const name = strval(values[abilityInfo({ path, rank }).rankName]);
          const spell = boolval(values[abilityInfo({ path, rank }).rankSpell]);
          const props = strval(values[abilityInfo({ path, rank }).rankProps]);
          const active = (hasProp(props, "action") || hasProp(props, "roll"));  
          let action = "";
          const rollIdx = rollNames.findIndex(r => cleanText(values[r]) === cleanText(name));
          if (!active && rollIdx > -1) {
            const [ roll ] = rollNames.splice(rollIdx, 1);
            rollIds = rollIds.filter(id => id !== rptInfo(roll).rowId);
            const rollBtn = rptAttr(rollRpt, "roll-btn", rptInfo(roll).rowId);
            action = ` [${ SWData.emojis.actions }](~${charName}|${rollBtn}${ button() })`;
          } else {
            const emoji = spell ? SWData.emojis.atkmag : SWData.emojis.actions;
            action = (spell || active)
            ? ` [${emoji}](~${charName}|${ abilityInfo({ path, rank }).rankOwned }-btn${ button() })`
            : "";
          }
          if (action !== "")
            all.push(action + name);
          return all;
        }, []).join("\n");
        if (abilities)
          chatMsg.push(pathName + "=" + abilities);
      });
    }

    // Rolls
    const rolls = rollIds.map((id) => {
      const rollBtn = isNPC ? "npcroll-btn" : "roll-btn";
      return `[${SWData.emojis.actions}](~${charName}|${ rptAttr(rollRpt, rollBtn, id) }${ button() }) ${ values[rptAttr(rollRpt, rollNameAttr, id)] }`;
    }).join("\n");
    if (rolls.length > 0)
      chatMsg.push("Autres capacités=" + rolls);

    // Buffs
    if (!isNPC) {
      const buffs = buffIds.filter((id) => boolval(values[rptAttr(buffRpt, "buff-temp", id)]));
      if (buffs.length > 0)
        chatMsg.push(`Buffs=[Choix](~${charName}|multibuff-btn${menuButton(color, {}, { padding: "0px 5px;" })})`);
    }

    // Skills
    if (!isNPC && boolval(values.use_skills)) {
      chatMsg.push(`Compétences=[Choix](~${charName}|skills_menu-btn${menuButton(color, {}, { padding: "0px 5px;" })})`);
    }

    // Recovery + Healing
    let desc = "";
    if (!isNPC) {
      desc = "Récup. " + [ "fast", "full" ].map(r => {
        const recup = ({ fast: "Rapide", full: "Complète" })[r];
        return `[${recup}](~${charName}|recovery_${r}-btn${ button({ "font-weight": "bolder" }) })`;
      }).join("&nbsp;");
    }

    desc += resIds
    .filter(id => {
      const type = getProp(strval(values[rptAttr(resRpt, "res-props", id)]), "type");
      const onHand = numval(values[rptAttr(resRpt, "res-val", id)]);
      return type.toLowerCase() === "soins" && onHand > 0;
    })
    .map(id => {
      const onHand = numval(values[rptAttr(resRpt, "res-val", id)]);
      const resBtn = rptAttr(resRpt, "resconso-btn", id);
      const title = onHand + " " + values[rptAttr(resRpt, "res-desc", id)];
      return `[${ SWData.emojis.heal }](~${charName}|${resBtn}${ button({}, { title }) })`;
    }).join("&nbsp;");

    // Send all
    sendChatMsg([
      `title=${charName}`,
      "subtitle=Actions",
      "color=" + color,
      "desc=" + desc,
      ...chatMsg
    ], {
      template: "custom",
      whisper: "\"" + charName + "\""
    });
  });
});

/**
 * Return object held in hand
 * @param {string} hand - main_ attribute suffix (princ|autre)
 * @param {object} values - Roll20 getAttrs() object
 * @returns {string}
 */
function holding(hand, values) {
  const inHand = strval(values[`main_${hand}`]);
  let holding = "";
  switch (inHand) {
    case "0":
    case "":
      holding = "Rien";
      break;
    case "2m":
      holding = "à deux mains";
      break;
    case "bouclier":
      holding = "Bouclier";
      break;
    case "torche":
      holding = "Torche";
      break;
    case "autre":
      holding = "Autre objet";
      break;
    default:
      const [ atkId ] = inHand.split("~").splice(1);
      holding = strval(values[rptAttr("armes", "arme-nom", atkId)]);
      break;
  }
  return holding;
}

/**
 * Display character check-up status
 */
function displayCheckup() {
  const owned = allPathRanks("rankOwned");

  const recapAttrs = [
    "character_name", "couleur_pj", "sheet_type",
    "pv", "pv_max",
    "dr", "dr_max",
    "pc", "pc_max", "cfg_shadow",
    "pm", "pm_max",
    ...allConditions(),
    "main_princ", "main_autre",
    ...owned,
    ...allPathRanks("rankName"),
    ...allPathRanks("rankUse"),
    ...allPathRanks("rankUseMax"),
    ...allPathRanks("rankUseFreq"),
  ];
  const allBuffs = SWData.PC.BUFFS.To.map(a => `${a}_buff_list`);
  processAllAttacks("armes", [ "nom" ], function(ids, allAttacks) {
    getAttrs([ ...recapAttrs, ...allAttacks, ...allBuffs ], function(values) {
      if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
        return;
      if (intval(values.pv_max) === 0 && intval(values.dr_max) === 0 && intval(values.pc_max) === 0)
        return;

      const charName = strval(values.character_name);
      const color = strval(values.couleur_pj);
      const chatMsg = [];
  
      chatMsg.push(`PV=${ intval(values.pv) } / ${ intval(values.pv_max) }`);
      chatMsg.push(`DR=${ intval(values.dr) } / ${ intval(values.dr_max) }`);
      chatMsg.push(`PC=${ intval(values.pc) } / ${ intval(values.pc_max) }`);
      if (intval(values.pm_max) > 0)
        chatMsg.push(`PM=${ intval(values.pm) } / ${ intval(values.pm_max) }`);
      
      const shadow = shadowValue(values);
      if (shadow.value > 0)
        chatMsg.push(`Valeur d'Ombre=${shadow.value}`);

      const conditions = SWData.PC.CONDITIONS.filter(condition => boolval(values[`condition_${condition.name}`]));
      if (conditions.length > 0)
        chatMsg.push("Etats=" + conditions.map(condition => condition.label).join(", "));
  
      const inHand = [ holding("princ", values), holding("autre", values) ];
      chatMsg.push(`En main=${ inHand.join(", ") }`);

      const usage = owned
      .filter(ability => boolval(values[ability]))
      .filter(ability => values[`${ability}_use_max`] > 0)
      .map(ability => {
        const uses = intval(values[`${ability}_use_max`]) - intval(values[`${ability}_use`]);
        const freq = strval(values[`${ability}_freq`]);
        const name = strval(values[abilityInfo(ability).rankName]);
        return `${name}=Reste ${uses} utilisations (par ${freq})`;
      });
      if (usage.length > 0)
        chatMsg.push(usage);

      allBuffs.filter(b => strval(values[b]) !== "").forEach(buffList => {
        let target = buffList.split("_")[0];
        switch (target) {
          case "tagi","tcon","tfor","tper","tcha","tint","tvol":
            target = "Tests de " + target.slice(1).toUpperCase();
            break;
          case "init":
            target = "Initiative";
            break;
          case "atkcac":
            target = "Att. Contact";
            break;
          case "atktir":
            target = "Att. Distance";
            break;
          case "atkmag":
            target = "Att. Magique";
            break;
          case "def":
            target = "Défense";
            break;
          default:
            target = target.toUpperCase();
        }
        strval(values[buffList]).trim().split(";")
        .filter(v => strval(v) !== "")
        .forEach((buff, ix, bl) => {
          let ib = "";
          if (bl.length > 1)
            ib = ` ${ix + 1}`;
          if (buff.trim() !== "")
            chatMsg.push(`Buff ${target}${ib}=${buff}`);
        });
      });
  
      sendChatMsg([
        `title=${charName}`,
        "subtitle=",
        "color=" + color,
        ...chatMsg
      ], {
        template: "custom",
        whisper: "gm"
      });
    });
  });
}

/**
 * On PC recap button click
 */
on("clicked:checkup-btn", function() {
  displayCheckup();
});

/**
 * On healing in message
 */
on("change:healing", function() {
  getAttrs([ "healing", "pv", "pv_max" ], function(values) {
    const healing = intval(strval(values.healing).split("~")[0]);
    if (healing === 0)
      return;
    const pvMax = intval(values.pv_max);
    const pv = Math.min(intval(values.pv) + healing, pvMax);
    setAttrs({ pv, PVIG: pv });
  });
});

/**
 * On new ongoing effect & !act mod script
 */
on("change:ongoing_actmod", function() {
  getAttrs([ "addcustrn", "ongoing_actmod" ], function(values) {
    if (!boolval(values.addcustrn))
      return;

    let [ name, timeSpan ] = strval(values.ongoing_actmod).split("~");
    const actOptions = { 
      formula: timeSpan !== "" ? -1 : 0,
      initial: timeSpan !== "" ? timeSpan.trim().split(" ")[0] : "0",
      name,
      index: 0,
      //after: true,
    };
    if (actOptions.formula === -1)
      actOptions.deleteOnZero = true;
    sendChatCmd(addCustomTurn(actOptions));
  });
});

// ================
// NPC SHEET EVENTS
// ================

function npcLuckButton(values) {
  const button = intval(values.pc_max) > 0 
  ? addLuckButton({ ...values, cfg_luck_btn: 1, cfg_shadow: 0, couleur_pj: "default" })
  : "";
  return button;
}

/**
 * On NPC ability button click
 */
SWData.PC.STATS.forEach(stat => {
  const short = shorten(stat);
  on(`clicked:pnj_${short}-btn`, function() {
    getAttrs([ `${short}_sup`, "pnj_comp", "character_name", "pc", "pc_max" ], function(values) {
      const [ dType ] = Object.keys(values);
      const skills = strval(values.pnj_comp).split("\n")
      .filter(r => r.startsWith(short.toUpperCase()))
      .map(r => {
        const [ bonus, ...name ] = strval(r.split(":")[1]).trim().replace(/\s\s+/g, " ").split(" ");
        return `${ SWData.emojis.skills }${ name.join(" ") } (${bonus}),[[${bonus}]][${ name.join(" ") }]`;
      });
      let skill = "";
      if (skills.length > 0)
        skill = `+ ?{Compétence ?|Aucune,0|${skills.join("|")}}`;
      const roll = `[[${ dieRoll(values[dType]) }[Dé] + (@{${short}})[Bonus ${short.toUpperCase()}]${skill} ]] `;
      const chatMsg = rollTemplate({
        lsub: "Test",
        rsub: capitalize(stat),
        roll,
        chance: npcLuckButton(values),
      });
      sendChatMsg(chatMsg);
    });
  });
});

/**
 * On enabling superior DEF
 */
on("change:def_sup", function () {
  getAttrs([ "def", "def_sup", "def_val", "def_supval" ], function (values) {
    const def = intval(values.def);
    const defSup = boolval(values.def_sup);
    let defVal = intval(values.def_val);
    const defSupVal = intval(values.def_supval);
    const updates = {};
    if (defVal === 0) {
      defVal = def;
      updates.def_val = defVal;
    }
    updates.def = defSup ? defSupVal: defVal;
    setAttrs(updates);
  });
});

/**
 * Enable/Disable superior DEF
 */
on("clicked:defsup-btn", function() {
  getAttrs([ "def_sup" ], function (values) {
    const def_sup = 1 - intval(values.def_sup);
    setAttrs({ def_sup });
  });
});

/**
 * Re-format damage reductions & damage resistances
 */
on("change:rd change:resdm sheet:opened", function() {
  getAttrs([ "rd", "resdm" ], function (values) {
    const rd = strval(values.rd),
          resdm = strval(values.resdm);
    let rrdm = "";
    if (rd.length > 0)
      rrdm += rd.split("\n").join(", ");
    if (resdm.length > 0)
      rrdm += ( rrdm !== "" ? ", " : "" ) + "DM " + resdm.split("\n").join(" + ") + " ÷ 2";
    setAttrs({ rrdm });
  });
});

/**
 * Set NPC attack score
 */
on("change:pnjatk", function() {
  getSectionIDs("npcarmes", function(rowIds) {
    const attacks = rowIds.map(id => rptAttr("npcarmes", "arme-atk", id));
    getAttrs([ "pnjatk", ...attacks ], function(values) {
      const npcAtk = intval(values.pnjatk);
      const updates = new Map();
      attacks.forEach(attk => {
        const bonus = intval(values[attk]);
        if (bonus !== npcAtk)
          updates.set(attk, npcAtk);
      });
      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  }) 
});

/**
 * Numbering NPC attacks
 */
on("change:repeating_npcarmes:arme-nom clicked:renum_npcatk-btn", function(eventInfo) {
  const renumber = (eventInfo.triggerName === "clicked:renum_npcatk-btn");
  let atkId = "";
  if (!renumber)
    atkId = strval(eventInfo.triggerName.split("_")[2]);
  getSectionIDsOrdered("repeating_npcarmes", function (rowIds) {
    const labels = rowIds.map(id => rptAttr("npcarmes", "arme-label", id));
    getAttrs([ "character_name", "max_attack_label", "scriptVersion", ...labels ], function (values) {
      const updates = new Map();

      if (!renumber) {
        // display attack options row if script detected
        updates.set(rptAttr("npcarmes", "armeopt"), hasMODScript(values) ? 1 : 0);
        // update roll button linked attribute
        const atkBtn = rptAttr("npcarmes", "npcatk-btn", atkId);
        updates.set(atkBtn, `%{${ strval(values.character_name) }|${atkBtn}}`);
      }
            
      const maxLabel = intval(values.max_attack_label);
      let numLabel = renumber ? 0 : maxLabel;
      labels.forEach(label => {
        if (renumber || intval(values[label]) === 0)
          updates.set(label, ++numLabel);
        updates.set(label.replace("label", "showlbl"), hasMODScript(values) ? 1 : 0);
      });
      if (renumber || numLabel > maxLabel)
        updates.set("max_attack_label", numLabel);

      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  });
});

/**
 * Roll an NPC attack in chat
 */
on("clicked:repeating_npcarmes:npcatk-btn", function() {
  const section = "repeating_npcarmes_arme-";
  const attackAttrs = rptAttrs("npcarmes", [
    "nom",
    "multi",
    "roll",
    "atk",
    "crit",
    "dm",
    "dmtype",
    "dmdiv",
    "portee",
    "special",
    "atktype",
    "atkmods",
    "options",
    "seuil",
    "effet",
  ].map(a => `arme-${a}`));
  const specials = [
    "pnj_spec",
    ...seq(3).map(t => `cspec${t}_nom`),
    ...seq(3).map(t => `cspec${t}_next`),
    ...seq(3).map(t => `cspec${t}_` + "roll"),
    ...seq(3).map(t => `cspec${t}_bonus`),
    ...seq(3).map(t => `cspec${t}_dm`),
  ];
  getAttrs([
    "cfg_1attack_roll", "cfg_cible", "cfg_lowfan",
    "cfg_crit_diff", "cfg_tbl_crit", "cfg_tbl_critdie", "cfg_tbl_fumble",
    "character_name", "niveau", "compagnon", "pc", "pc_max",
    "atkgroup", "nbgroup", "pnj_tact",
    "atkbase_pnj", "atkcac", "atktir", "atkmag",
    ...specials,
    ...attackAttrs,
  ], function (values) {
    const useOneRoll = boolval(values.cfg_1attack_roll);
    const useCritDiff = intval(values.cfg_crit_diff);
    const charName = strval(values.character_name);
    let companionOf = strval(values.compagnon);
    companionOf = companionOf !== "" ? companionOf + "|" : "";
    const group = intval(values.atkgroup);
    const groupNb = intval(values.nbgroup);
    const atkBase = boolval(values.atkbase_pnj);
    const atkCac = intval(values.atkcac);
    const atkTir = intval(values.atktir);
    const atkMag = intval(values.atkmag);
    const name = capitalize(strval(values[section + "nom"], "Attaque"));
    const useMulti = intval(values[section + "multi"]);
    let roll = strval(values[section + "roll"]);
    const atk = strval(values[section + "atk"]);
    const portee = strval(values[section + "portee"]);
    const range = (portee !== "") ? ` *(${ rangeWithUnits(portee) })*` : "";
    const crit = intval(values[section + "crit"], 20);
    const atkType = strval(values[section + "atktype"]);
    const atkMods = strval(values[section + "atkmods"]).split(",").map(mod => mod.trim().toLowerCase());

    const resetValues = new Map();

    const grouped = "Attaque groupée";
    const bonus5 = { nb: 2, bonus: ` +5[${grouped}]` };
    const bonus10 = { nb: 3, bonus: ` +10[${grouped}]` };
    const bonusAuto = { nb: 4, bonus: "" };
    const autoHit = "Touche automatique";
    const atkgrp = [];
    switch (group) {
      case 1:
        atkgrp.push({ nb: 1, bonus: "" });
        break;
      case 2:
        atkgrp.push(bonus5);
        break;
      case 3:
        atkgrp.push(bonus10);
        break;
      case 4:
        atkgrp.push(bonusAuto);
        break;
      case 5:
        if (groupNb === 5) {
          atkgrp.push(bonus10);
          atkgrp.push(bonus5);
        } else if (groupNb === 6) {
          atkgrp.push(bonus10);
          atkgrp.push(bonus10);
        } else if (groupNb === 7) {
          atkgrp.push(bonusAuto);
          atkgrp.push(bonus10);
        } else {
          atkgrp.push(bonusAuto);
          atkgrp.push(bonusAuto);
        }
        break;
    }

    const extraDM = [];

    let tactBonus = "";
    let tactDM = "";
    const tactic = intval(values.pnj_tact);
    if (tactic > 0) {
      let name = "";
      switch (tactic) {
        case 1:
          name = "Attaque assurée";
          tactBonus = "+5";
          break;
        case 2:
          name = "Attaque précise";
          tactBonus = "-3";
          tactDM = "1" + getDEvol(intval(values.niveau));
          break;
        case 3:
          name = "Attaque violente";
          tactBonus = "-7";
          tactDM = "2" + getDEvol(intval(values.niveau));
          break;
      }
      if (tactBonus !== "")
        tactBonus = ` + ([[${tactBonus}]])[${name}]`;
      if (tactDM !== "")
        extraDM.push(` + [[${tactDM}]] ${name}`);
      resetValues.set("pnj_tact", 0);
    }

    let specRoll = 0;
    let specNext = false;
    let specBonus = "";
    let specDM = "";
    let specName = "";

    const specMove = intval(values.pnj_spec);
    if (specMove > 0) {
      specRoll = intval(values[`cspec${specMove}_` + "roll"]);
      specNext = boolval(values[`cspec${specMove}_next`]);
      specName = strval(values[`cspec${specMove}_nom`]);
      const rollMatching = specName.match(/[ ]*jet:([0-9]*)[ ]*/);
      if (rollMatching) {
        const rollMatched = rollMatching[0];
        specName = specName.replace(rollMatched, "").trim();
        if (!atkMods.includes(rollMatched.trim()))
          atkMods.push(rollMatched.trim());
      }
      const bonus = intval(values[`cspec${specMove}_bonus`]);
      if (bonus > 0)
        specBonus = ` + [[${bonus}]][${specName}]`;
      specDM = replaceDevol(strval(values[`cspec${specMove}_dm`]));
      if (specDM !== "") {
        if (isNaN(specDM)) {
          extraDM.push(` + [[${specDM}]] ${specName}`);
          specDM = "";
        } else {
          specDM = ` + [[${specDM}]][${specName}]`;
        }
      }
      if (specBonus !== "" || specDM !== "")
        specName = ` (${specName})`;
      else
        specName = "";
      if (specRoll === 1)
        roll = "2d20kh1";
      if (specRoll === 2)
        roll = "2d20kl1";

      if (specNext)
        resetValues.set("pnj_spec", 0);
    }

    let multiAttacks = 1;
    if (useMulti === 1) {
      const result = name.match(/\(([0-9]*)[ ]*attaques\)/);
      if (result) {
        [ multiAttacks ] = result.slice(1);
      }
      if (intval(multiAttacks) <= 0)
        multiAttacks = 1;
    }

    let atkBonus = strval(atk, "0");
    if (atkBase && atkType !== "") {
      const atkScore = atkType === "sort" 
      ? atkMag 
      : atkType === "main" || atkType === "naturel" 
      ? atkCac : atkTir;
      atkBonus = "(" + atkScore + "+" + atkBonus + ")";
    }

    const attacks = [];
    if (!atkMods.includes("auto") && atkgrp[0].nb !== 4) {
      // (grouped ?) attack
      attacks.push(`[[${roll}cs>${crit}cf1[Dé] + ${atkBonus}[Bonus]${atkgrp[0].bonus}${tactBonus}${specBonus} ]]`);
    } else {
      // auto-hit
      attacks.push(autoHit);
    }
    // second grouped attack ?
    if (atkgrp.length === 2) {
      if (!atkMods.includes("auto") && atkgrp[1].nb !== 4) {
        attacks.push(`[[${roll}cs>${crit}cf1[Dé] + ${atkBonus}[Bonus]${atkgrp[1].bonus}${tactBonus}${specBonus} ]]`);
      } else {
        attacks.push(autoHit);
      }
    }

    if (boolval(values.cfg_lowfan))
      atkMods.push("explodemax");

    let [ dm, ...dmextra ] = strval(values[section + "dm"]).split(" ");
    const dmtype = strval(values[section + "dmtype"]);
    const dmdesc = [ dmtype, ...dmextra ].join(" ").trim();
    const dmdiv = strval(values[section + "dmdiv"]);

    let dmOpt = "";
    if (atkMods.includes("explodemax") && !dm.includes("!"))
      dmOpt += "!";
    if (atkMods.includes("reroll1")) {
      if (numval(getAtkMod("reroll1")) === 1)
        dmOpt += "ro";
      else
        dmOpt += "r";
    }

    let dmroll = "";
    if (dm !== "") {
      dm = dm.replace("dE", "d4°");
      dm = dm.toLowerCase().replace("d4°", `@{${companionOf}devol}`);
      dmroll = `[[${dm}${dmOpt}]][DM] + ${dmdiv}[Divers]${specDM}`;
      if (tactic === 1)
        dmroll = `[[floor((${dmroll})/2)]]`;
      else
        dmroll = "[[" + dmroll + " ]]";
    }

    let special = strval(values[section + "special"]);
    special = insertRolls(special, { isNPC: true, companionOf });

    const specRolls = [];

    atkMods.forEach(atkMod => {
      const matched = atkMod.match(/jet:([0-9]+)/i);
      if (!matched)
        return;
      const index = matched.slice(1)[0];
      if (!index)
        return;
      specRolls.push("%{" + charName + "|" + rptAttr("npcrolls", "npcroll", "$" + (intval(index) - 1) ) + "}");
      special = "Spécial : @{" + rptAttr("npcrolls", "npcroll-name", "$" + (intval(index) - 1) ) + "}\n" + special;
    });

    let dmMax = 0;
    const result = dm.match(/([0-9]*)[dD]([0-9]*)/);
    if (result) {
      let [ matched, dice, faces ] = result;
      if (matched) {
        if (!dice)
          dice = 1;
        dmMax = intval(dice) * intval(faces);
      }
    }

    let dmcrit = "";
    if (useCritDiff === 1) {
      switch (dmtype) {
        case "contondants":
        case "coup":
          dmcrit = `[[${dmMax}]] DM et cible étourdie au prochain round`;
          break;
        case "perforants":
        case "morsure":
          if (dice && faces)
            dmcrit = `[[${dice * 2}d${faces}]] DM + hémorragie : [[1@{${companionOf}devol}]] DM/round pendant 4 rounds`;
          break;
        case "tranchants":
        case "griffes":
          dmcrit = `[[${dmMax}]] DM et hémorragie : [[1@{${companionOf}devol}]] DM/round pendant 4 rounds`;
          break;
      }
    }
    
    const rollOptions = {};
    
    // Critical hit table
    rollOptions.critical = useCriticalHit(values, "npc");
    const critHit = rollOptions.critical ? criticalHit(values, "npc") : "";
    rollOptions.crit = rollOptions.critical ? crit : 0;

    // Fumble table
    rollOptions.fumble = useFumbleTable(values, "npc");
    const fumbleEffect = rollOptions.fumble ? fumbleRoll(values) : "";
    
    // Check special effect on die roll
    let rollEffect = "";
    const tn = intval(values[section + "seuil"]);
    const effect = strval(values[section + "effet"]).trim();
    if (tn > 0 && effect !== "") {
      rollOptions.rollTN = tn;
      rollEffect = effect;
    }
    
    const options = strval(values[section + "options"]);
    
    const fxValue = strval(getProp(options, "fx"));
    
    attacks.forEach((attack, ix) => {
      
      // Play FX !
      if (fxValue !== "")
        playFX(fxValue);
      
      // base attack roll
      let chatAtk = {
        lsub: "Attaque",
        rsub: name + specName + range,
        roll: attack,
        rollf: "[[0]]",
        rolleffect: rollEffect,
        broll: "",
        brollf: "[[0]]",
        brolleffect: "",
        dm: dmroll,
        dmdesc,
        critdiff: `[[${useCritDiff}]]`,
        dmcrit,
        text: special,
        critsuccess: "",
        bcritsuccess: "",
        crithit: "",
        critfail: "",
        fumbletest: "",
        fumble: "",
        tohit: "",
        target: "",
        targetname: "",
        chance: npcLuckButton(values)
      };
      
      if(rollOptions.critical) {
        chatAtk.critsuccess = "[[0]]";
        chatAtk.crithit = critHit;
      }

      if(rollOptions.fumble) {
        chatAtk.critfail = "[[0]]";
        const stat = isRanged("atktir", portee) ? "per" : "agi";
        const stat_dsup = `@{${stat}_dsup}`;
        const stat_mod = `@{${stat}}[${ stat.toUpperCase() }]`;
        chatAtk.fumbletest = `[[${stat_dsup} + ${stat_mod} ]]`;
        chatAtk.fumble = fumbleEffect;
      }

      if (boolval(values.cfg_cible && multiAttacks === 1)) {
        chatAtk.tohit = SWData.settings.tokens.target.def;
        chatAtk.target = SWData.settings.tokens.target.name;
        chatAtk.targetname = `[[0[${chatAtk.target}] ]]`;
      }

      if(extraDM.length > 0)
        chatAtk.dmextra = extraDM.join("\n");

      // process grouped attacks
      if (atkgrp[ix].nb < 4) {
        if (!useOneRoll && roll === "1d20") {
          const broll = attack === autoHit ? "" : attack;
          const brolleffect = attack === autoHit ? "" : rollEffect;
          chatAtk = { ...chatAtk, broll, brolleffect, bcritsuccess: "[[0]]" };
        }
      } else {
        chatAtk.save = 0;
      }
      if (atkgrp[ix].nb > 1)
        chatAtk = { ...chatAtk, alert: `Groupe n°${ix + 1} : [[${atkgrp[ix].nb}]] créatures` };

      // process multi-attacks
      for (let atk = 1; atk <= multiAttacks; atk++) {
        if (useMulti === 1)
          chatAtk = { ...chatAtk, lsub: `${atk}${ atk > 1 ? "ème" : "ère" } attaque` };
        const chatMsg = rollTemplate(chatAtk);
        sendChatMsg(chatMsg, rollOptions);
      }
    });

    // Special rolls
    if (specRolls.length > 0)
      sendChatCmd(specRolls.join(" "));

    // Reset attributes
    if (resetValues.size > 0)
      setAttrs(Object.fromEntries(resetValues));
  });
});

/**
 * Roll an NPC ability in chat
 */
on("clicked:repeating_npcrolls:npcroll-btn", function() {
  const section = "repeating_npcrolls_npcroll-";
  const rollAttrs = [ "name", "uses", "max", "freq", "desc" ].map(a => `${section}${a}`);
  getAttrs([ "compagnon", ...rollAttrs ], function (values) {
    const companionOf = strval(values.compagnon);
    let name = strval(values[section + "name"], "Capacité");
    const action = name.match(/ \((G|M|A|L)\)[ ]*$/);
    let actionType = "";
    if (action) {
      name = name.replace(action[0], "");
      actionType = " - " + action[1];
    }

    let text = "";
    let alert = "";
    let alertCSS = "";
    const maxUses = numval(values[section + "max"]);
    const freq = strval(values[section + "freq"]);
    if (freq !== "" && maxUses !== 0) {
      let nbUsed = numval(values[section + "uses"]) + 1;
      if (nbUsed > maxUses) {
        text = "";
        alert = `Nombre d'utilisations par ${freq} atteint`;
        alertCSS = "fumble";
      } else {
        alert = `Utilisée ${nbUsed} fois`;
        alertCSS = "secondary";
      }
      setAttrs({ [`${section}uses`]: Math.min(nbUsed, maxUses) });
    }

    if (text === "")
      text = insertRolls(strval(values[section + "desc"]), { isNPC: true, companionOf });

    const chatMsg = rollTemplate({
      lsub: "Capacité" + actionType,
      rsub: capitalize(name),
      text,
      alert,
      alertclass: alertCSS
    });
    sendChatMsg(chatMsg);
  });
});

/**
 * Set NPC attack scores
 */
on("change:atkbase_pnj change:atkcac_pnj change:atktir_pnj change:atkmag_pnj", function() {
  getAttrs([ "atkbase_pnj", "atkcac_pnj", "atktir_pnj", "atkmag_pnj" ], function (values) {
    const base = numval(values.atkbase_pnj);
    const atkcac = numval(values.atkcac_pnj) * base;
    const atktir = numval(values.atktir_pnj) * base;
    const atkmag = numval(values.atkmag_pnj) * base;
    setAttrs({ atkcac, atktir, atkmag });
  });
});

/**
 * Set companion attributes
 * @param {Object} values - getAttrs() values object
 * @returns {void}
 */
function setCompanion(values) {
  const companionOf = strval(values.compagnon);
  if (companionOf === "")
    return;

  // build the list of values to retrieve
  let askValues = 
    `{{mounted=[[@{${companionOf}|en_selle}]] }} ` +
    `{{rider=[[@{${companionOf}|rang_cavalier}]] }} ` +
    `{{defowner=[[@{${companionOf}|def}]] }} `;
  SWData.COMPANIONS.forEach(attr => {
    let expr = strval(values[`comp_${attr}`]);
    if (expr === "")
      return;
    while (true) {
      const matching = expr.match(/\[.*?\]/);
      if (!matching)
        break;
      const [ matched ] = matching;
      const attribute = "@{" + companionOf + "|" + matched.split("[")[1].split("]")[0] + "}";
      expr = expr.replace(matched, attribute);
    }
    askValues += `{{${attr}=[[${expr}]]}} `;
  });

  // retrieve values & update attributes
  if (askValues) {
    startRoll("! " + askValues, values => {
      const updates = new Map();
      const mounted = boolval(values.results.mounted.result);
      const rider = intval(values.results.rider.result);
      const defOwner = intval(values.results.defowner.result);
      SWData.COMPANIONS.forEach(attr => {
        if (values.results[attr]) {
          const value = values.results[attr].result;
          if (attr === "pnjatk" && value === intval(values.pnjatk))
            return;
          updates.set(attr, value);
        }
      });
      if (mounted && rider >= 2 && defOwner > intval(updates.get("def")))
        updates.set("def", defOwner);
      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
      
      finishRoll(values.rollId);
    });
  }
}

/**
 * On change of companion attributes expression
 */
SWData.COMPANIONS.forEach(attr => {
  on(`change:compagnon change:comp_${attr}`, function() {
    getAttrs([ "compagnon", "pnjatk", `comp_${attr}` ], function(values) {
      setCompanion(values);
    });
  });
});

/**
 * On inserting PDF text statblock to import - clean it
 */
on("change:statblock", function() {
  getAttrs([ "statblock" ], function(values) {
    let text = strval(values.statblock);
    if (text === "")
      return;
    const stripped = [];
    text.split("\n").forEach(l => stripped.push(stripNonPrintable(l)));
    setAttrs({ statblock: stripped.join("\n")});
  });
});

/**
 * Search stats values in statblock text
 * @param {string} sbLine - line of text
 * @param {Map} npcAttrs - Map of attributes to update
 * @returns {Map} updated Map
 */
function importNPCStats(sbLine, npcAttrs) {
  SWData.PC.STATS.forEach(stat => {
    const short = shorten(stat);
    const rx = new RegExp(short.toUpperCase() + " (.)([0-9]*)(\\*)? ");
    const match = sbLine.match(rx);
    if (!match) 
      return;
    let [ sign, value, sup ] = match.slice(1);
    value = intval(value) * ((sign !== "+") ? -1 : 1);
    npcAttrs.set(short, value);
    sup = sup === "*" ? "S" : "0";
    npcAttrs.set(short + "_sup", sup);
  });
  return npcAttrs;
}

/**
 * Parse an attack from a statblock line
 * @param {string} sbLine - line of text
 * @param {Map} npcAttrs - Map of attributes to update
 * @returns {Map} updated Map 
 */
function importNPCAttack(sbLine, npcAttrs) {
  const [ latk, ratk ] = sbLine.split(" DM ");
  
  let name = "";
  let bonus = "";
  lmatch = latk.match(/(.*?) ([\+\-][0-9]*)/);
  if (lmatch) {
    [ name, bonus ] = lmatch.slice(1);
    bonus = intval(bonus);
  }

  let dm = "";
  let dmdiv = "";
  let [ dmexpr, special ] = ratk.split(" + ");
  if (dmexpr) {
    dmatch = dmexpr.match(/([0-9]*[dD][0-9]*)([\-\+]?[0-9]*)?/);
    if (dmatch) {
      [ dm, dmdiv ] = dmatch.slice(1);
    }
  }

  special = strval(special);
  if (special !== "")
    special = " + " + special;
  
  const rowId = rptAttr("npcarmes", "arme-", generateRowID());
  npcAttrs.set(rowId + "nom", name);
  npcAttrs.set(rowId + "roll", "1d20");
  npcAttrs.set(rowId + "atk", bonus);
  npcAttrs.set(rowId + "crit", "20");
  npcAttrs.set(rowId + "dm", dm);
  npcAttrs.set(rowId + "dmtype", "tranchants");
  npcAttrs.set(rowId + "dmdiv", intval(dmdiv));
  npcAttrs.set(rowId + "special", special);
  
  return npcAttrs;
}

/**
 * Parse statblock data from DRS JSON blob
 * @param {object} data - parsed JSON blob
 * @returns {Map<string,string|number>} Map object of attributes to update
 */
function jsonFromDRS(data) {
  
  const npcAttrs = new Map();
  
  // TODO
  
  return npcAttrs;
}

function statBlockFromDRS(statblock) {
  
  let npcAttrs = new Map();
  
  let parseAttacks = false;
  
  const abilities = [];
  let parseAbilities = false;
  let emptyLine = 0;

  (statblock + "\n").split("\n").forEach((sbLine, lineNum, sb) => {
    let match;

    // name
    if (lineNum === 0) {
      npcAttrs.set("character_name", sbLine);
      return;
    }
    
    // NC
    match = sbLine.match(/^NC[ ]+([0-9]+)( 1)?(\/2)?$/);
    if (match) {
      const [ nc, half1, half2 ] = match.slice(1);
      if (nc + half1 === "1/2")
        nc = "0.5";
      if (half1 + half2 === " 1/2")
        nc = intval(nc) + .5;
      npcAttrs.set("niveau", nc);
      return;
    }

    // creature type
    match = sbLine.toUpperCase().match(/CR[ÉE]ATURE[ ]+(NON[ ]+VIVANTE|HUMANO[ÏI]DE|V[ÉE]G[ÉE]TATIVE|VIVANTE)/);
    if (match) {
      const type = strval(match[1]);
      if (type !== "")
        npcAttrs.set("creature", "Créature " + type.toLowerCase());
      return;
    }
    
    // size
    match = sbLine.toLowerCase().match(/taille[ ]+(minuscule|tr[èe]s[ ]+petite|petite|moyenne|grande|[ée]norme|colossale)/);
    if (match) {
      const taille = strval(match[1]);
      if (taille !== "")
        npcAttrs.set("taille", taille);
      return;
    }

    match = sbLine.toUpperCase().match(/^(AGI|CON|FOR|PER|CHA|INT|VOL|DEF|PV|INIT)$/);
    if (match) {
      const attr = strval(match[1]).toLowerCase();
      const value = strval(sb[lineNum + 1]);
      
      // stat
      if (SWData.PC.STATS.map(s => shorten(s)).includes(attr)) {
        npcAttrs.set(attr + "_sup", value.endsWith("*") ? "S" : "0");
        npcAttrs.set(attr, intval(value.replace("*", "")));
        return;
      }

      // DEF
      if (attr === "def") {
        const [ def, defSup ] = value.replace(/\s+/g, " ").split(" ");
        npcAttrs.set("def", intval(def));
        npcAttrs.set("def_val", intval(def));
        if (defSup)
          npcAttrs.set("def_supval", intval(defSup.split("(")[1].split(")")[0]));
        return;
      }

      // PV
      if (attr === "pv") {
        const [ pv, rd, rdVal ] = value.replace(/\s+/g, " ").split(" ");
        npcAttrs.set("pv", intval(pv));
        npcAttrs.set("pv_max", intval(pv));
        if (rd === "(RD")
          npcAttrs.set("rd", intval(rdVal.split(")")[0]));
        return;
      }

      // INIT
      if (attr === "init") {
        npcAttrs.set("init", intval(value));
        return;
      }
    }
    
    if (sbLine.toLowerCase() === "attaques") {
      parseAttacks = true;
      return;
    }

    if (parseAbilities) {
      if (sbLine === "")
        emptyLine++;
      else
        return;
      switch (emptyLine) {
        case 1:
          const prior = sb[lineNum - 1];
          let name = prior;
          if ([ "G", "M", "A", "L"].includes(prior)) {
            name = sb[lineNum - 2] + " ("+ prior + ")";
          }
          abilities.push({ name });
          break;
        case 2:
          const desc = sb[lineNum - 1];
          abilities[abilities.length - 1] = { 
            name: abilities[abilities.length - 1].name,
            desc
          }
          emptyLine = 0;
          break;
      }
      return;
    }

    if (parseAttacks) {
      if (sbLine === "")
        return;
  
      if (!sbLine.includes(" DM ")) {
        parseAbilities = true;
        parseAttacks = false;
        return;
      }

      match = sbLine.match(/(.+?)([\+\-][0-9]+)[ ]+·[ ]+DM[ ]+([1-9][dD][0-9]+([\+\-][0-9]+)?)([ ]+\+[ ]+.+)?/);
      if (match) {
        let submatch;
        let [ name, bonus, dm, dmdiv, special ] = match.slice(1);
        if (dmdiv)
          dm = dm.replace(dmdiv, "");
        let range = "";
        submatch = name.match(/(.+?)\(([0-9]+[ ]+m)\)/);
        if (submatch)
          [ name, range ] = submatch.slice(1);
        let multi = "";
        submatch = name.match(/(.+?)\(([0-9]+[ ]+attaques)\)/);
        if (submatch)
          [ name, multi ] = submatch.slice(1);

        const rowId = rptAttr("npcarmes", "arme-", generateRowID());
        npcAttrs.set(rowId + "nom", name);
        if (multi !== "")
          npcAttrs.set(rowId + "multi", 1);
        npcAttrs.set(rowId + "roll", "1d20");
        npcAttrs.set(rowId + "atk", intval(bonus));
        npcAttrs.set(rowId + "crit", "20");
        npcAttrs.set(rowId + "dm", dm);
        npcAttrs.set(rowId + "dmtype", "tranchants");
        if (dmdiv)
          npcAttrs.set(rowId + "dmdiv", intval(dmdiv));
        if (range)
          npcAttrs.set(rowId + "portee", rangeWithUnits(range));
        if (special)
          npcAttrs.set(rowId + "special", special);
        return;
      }
    }

    // description
    if (lineNum === 1) {
      npcAttrs.set("pnj_desc", sbLine);
      return;
    }
  });

  abilities.forEach(ability => {
    const rowId = rptAttr("npcrolls", "npcroll-", generateRowID());
    npcAttrs.set(rowId + "name", ability.name);
    npcAttrs.set(rowId + "desc", ability.desc);
    const submatch = ability.desc.toLowerCase().match(/(une|deux|trois)[ ]+fois[ ]+par[ ]+(combat|jour)/);
    if (submatch) {
      const [ nb, freq ] = submatch.slice(1);
      const uses = [ "une", "deux", "trois" ].findIndex(n => n === nb);
      if (uses > -1 && freq) {
        npcAttrs.set(rowId + "max", uses + 1);
        npcAttrs.set(rowId + "freq", freq);
      }
    }
  });

  return npcAttrs;
}

/**
 * Parse statblock data from PDF text
 * @param {string} statblock - text pasted from PDF
 * @returns {Map<string,string|number>} Map object of attributes to update
 */
function statBlockFromPDF(statblock) {
  
  let npcAttrs = new Map();
  
  const abilities = [];
  let ability = "";

  let foundAttacks = false;
  let foundAbilities = false;

  statblock.split("\n").forEach((sbLine, lineNum) => {
    
    // attacks
    if (sbLine.includes(" DM ") && !foundAbilities) {
      npcAttrs = importNPCAttack(sbLine, npcAttrs);
      foundAttacks = true;
      return;
    }
    
    if (foundAttacks) {
      // abilities
      if (sbLine.toUpperCase() === sbLine) {
        foundAbilities = true;
        if (ability !== "") {
          const [ name, action, description ] = ability.split("~");
          abilities.push({ name, action, description });
          ability = "";
        }
        let action = "";
        const match = sbLine.match(/ \(([GMAL])\)/);
        if (match) {
          let matched;
          [ matched , action ] = match;
          sbLine = sbLine.replace(matched, "");
        }
        sbLine = sbLine.split(":")[0].trim().toLowerCase();
        ability = capitalize(sbLine) + "~" + action + "~";
      } else {
        ability += sbLine + " ";
      }
    } else {
      sbLine = sbLine.toUpperCase();
      let match;
      // name & nc
      if (lineNum === 0) {
        match = sbLine.match(/(.+)\|[ ]*NC[ ]+([0-9.,]+)/);
        if (match) {
          const [ , character_name, nc ] = match;
          npcAttrs.set("character_name", character_name);
          npcAttrs.set("niveau", nc);
        }
        return;
      }
      
      // creature type
      match = sbLine.match(/CRÉATURE[ ]+(NON[ ]+VIVANTE|HUMANOÏDE|VÉGÉTATIVE|VIVANTE)/);
      if (match) {
        const type = strval(match[1]);
        if (type !== "")
          npcAttrs.set("creature", "Créature " + type.toLowerCase());
      }

      // size
      match = sbLine.match(/TAILLE[ ]+(MINUSCULE|TRÈS[ ]+PETITE|PETITE|MOYENNE|GRANDE|ÉNORME|COLOSSALE)/);
      if (match) {
        const taille = strval(match[1]);
        if (taille !== "")
          npcAttrs.set("taille", taille.toLowerCase());
      }

      // défense
      match = sbLine.match(/(\(S\))?[ ]*DÉFENSE[ ]+([0-9]+)([ ]+\(([0-9]+)\))?/);
      if (!match)
        match = sbLine.match(/(\(S\))?[ ]*DEF[ ]+([0-9]+)([ ]\(([0-9]+)\))?/);
      if (match) {
        match = match.slice(1);
        if (match[0] === "(S)")
          match = match.slice(1);
        const [ def, defSup, defSupVal ] = match;
        npcAttrs.set("def", def);
        npcAttrs.set("def_val", def);
        if (defSup) {
          npcAttrs.set("def_supval", defSupVal);
        }
      }
      
      // pv
      match = sbLine.match(/(\(V\))?[ ]*POINTS[ ]+DE[ ]+VIGUEUR[ ]+([0-9]+)([ ]*\(RD[ ]*([0-9]+)\))?/);
      if (!match)
        match = sbLine.match(/(\(V\))?[ ]*PV[ ]+([0-9]+)([ ]*\(RD ([0-9]*)\))?/);
      if (match) {
        match = match.slice(1);
        if (match[0] === "(V)")
          match = match.slice(1);
        const [ pv, rd, rdValue ] = match;
        npcAttrs.set("pv", pv);
        npcAttrs.set("pv_max", pv);
        if (rd)
          npcAttrs.set("rd", rdValue);
      }

      // initiative
      match = sbLine.match(/(\(I\))?[ ]*INITIATIVE[ ]+([0-9]+)/);
      if (!match)
        match = sbLine.match(/(\(I\))?[ ]*INIT[\.]?[ ]*([0-9]+)/);
      if (match) {
        match = match.slice(1);
        if (match[0] === "(I)")
          match = match.slice(1);
        const [ init ] = match;
        npcAttrs.set("init", init);
      }

      npcAttrs = importNPCStats(sbLine, npcAttrs);
    }
  });
  if (ability !== "") {
    const [ name, action, description ] = ability.split("~");
    abilities.push({ name, action, description });
  }

  abilities.forEach(ability => {
    const rowId = rptAttr("npcrolls", "npcroll-", generateRowID());
    let name = strval(ability.name);
    name = name !== "" ? name.charAt(0).toUpperCase() + name.substring(1) : name;
    let description = strval(ability.description);
    description = description !== "" ? description.charAt(0).toUpperCase() + description.substring(1) : description;
    if (name !== "" && description !== "") {
      npcAttrs.set(rowId + "name", `${name}${ strval(ability.action) !== "" ? " (" + ability.action + ")" : "" }`);
      npcAttrs.set(rowId + "desc", description);
    }
  });

  return npcAttrs;
}

/**
 * On click of import NPC statblock button
 */
on("clicked:importsb-btn", function() {
  
  // remove olds
  removeRepeatingAll("npcarmes");
  removeRepeatingAll("npcrolls");

  // add new
  getAttrs(["statblock", "from_drs"], function (values) {
    
    const statblock = strval(values.statblock);
    if (statblock === "")
      return;
    
    let updates = new Map();

    try {
      const data = JSON.parse(statblock);
      updates = jsonFromDRS(data);
    } catch (error) {
      updates = boolval(values.from_drs)
      ? statBlockFromDRS(statblock)
      : statBlockFromPDF(statblock);
    }

    if (updates.size > 0) {
      updates.set("statblock", "");
      setAttrs(Object.fromEntries(updates), { silent: true });
    }
  });
});

/**
 * Display NPC attacks menu in chat
 */
on("clicked:npcatks_menu-btn", function () {
  attackRollsMenu("npc");
});

/**
 * Display NPC ability rolls menu in chat
 */
on("clicked:npcrolls_menu-btn", function () {
  abilityRollsMenu("npc");
});

/**
 * Display all NPC rolls menu
 */
on("clicked:npc_menus-btn", function () {
  allRollsMenu("npc");
});

// ====================
// SHEET INIT & UPDATES
// ====================

/**
 * Set/Unset Debug Mode
 * @param {string} debugMode - value of debug_mode attribute
 * @param {function():void} [callback=null] - debug callback
 */
function setDebugMode(debugMode, callback = null) {
  SWData.settings.debugMode = boolval(debugMode);
  clog(
    ` Running sheetworker... ${ SWData.settings.debugMode ? "DEBUG" : "PROD" } `,
    { 
      debug: false,
      textColor: "white",
      backColor: "brown"
    }
  );
  if (SWData.settings.debugMode && callback)
    callback();
}

function migrateCOF1Value(attr, oldVal) {
  let newVal = oldVal;

  switch(`${attr}=${oldVal}`) {
    case "atk=@{ATKCAC}":
    case "atk=@{ATKTIR}":
    case "atk=@{ATKMAG}":
      newVal = oldVal.slice(2, 8).toLowerCase();
      break;
    case "typeattaque=Naturel":
      newVal = "naturel";
      break;
    case "typeattaque=Arme 1 main":
    case "typeattaque=Arme 2 mains":
    case "typeattaque=Arme gauche":
      newVal = "main";
      break;
    case "typeattaque=Sortilege":
      newVal = "sort";
      break;
    case "typeattaque=Arme de jet":
      newVal = "jet";
      break;
    case "typedegats=tranchant":
    case "typedegats=contondant":
      newVal += "s";
      break;
    case "typedegats=percant":
      newVal = "perforants";
      break;
    case "dmcar=@{FOR}":
    case "dmcar=@{CON}":
    case "dmcar=@{INT}":
    case "dmcar=@{CHA}":
      newVal = "@{" + oldVal.slice(2, 5).toLowerCase() + "}";
      break;
    case "dmcar=@{DEX}":
      newVal = "@{agi}";
      break;
    case "dmcar=@{SAG}":
      newVal = "@{per}";
      break;
  }

  return newVal;
}

/**
 * Migrate sheet from COF1
 * @param {string} sheetType - type of sheet
 * @param {number} verCOF1 - COF1 version number
 * @returns {void}
 */
function migrateCOF1Sheet(sheetType, verCOF1) {
  if (sheetType !== SWData.SHEET_TYPE.PC)
    return;

  const section = "armes";
  getSectionIDs(section, atkIds => {
    const oldAtks = [];
    const oldAtkAttrs = [ 
      "label:", "nom:",
      "atk:", "atkdiv:", "crit:",
      "dmnbde:~", "dmde:~", "dmcar:bonus", "dmdiv:",
      "portee:",
      "spec:special",
      "typeattaque:atktype", "modificateurs:atkmods", "typedegats:dmtype", "options:"
    ];
    atkIds.forEach(id => {
      oldAtkAttrs.map(a => a.split(":")[0]).forEach(attr => {
        oldAtks.push(rptAttr(section, `arme${attr}`, id));
      });
    });

    const oldAttrs = [
      "profil", "sexe",
      "dex",
      "defarmureon", "defarmure", "defarmuremalus",
      "defbouclieron", "defbouclier", "defboucliermalus",
      "defcar",
      "casque_on", "casque_rd",
      "rds",
    ];
    getAttrs([ ...oldAttrs, ...oldAtks ], function(values) {
      const chatMsg = [];
      chatMsg.push(`title=Migration Fiche COF1`);
      chatMsg.push("subtitle=@{character_name}");
      
      const migrated = new Map();
  
      migrated.set("genre", strval(values.sexe));
  
      const profile = capitalize(strval(values.profil));
      let famille;
      for (const family of Object.keys(SWData.PC.PROFILES)) {
        if (SWData.PC.PROFILES[family].find(p => p.value === profile)) {
          famille = family;
        }
      }
      if (!famille) {
        switch (profile) {
          case "Invocateur":
            famille = "Mages";
            break;
          case "Psionique":
            famille = "Mystiques";
            break;
          case "Samouraï":
          case "Seigneur":
            famille = "Combattants";
            break;
        }
      }
      if (famille) {
        migrated.set("famille", famille);
        chatMsg.push(`Famille=${famille}`);
      }
  
      migrated.set("agi", intval(values.dex));
      chatMsg.push(`AGI=${ migrated.get("agi") }`);
  
      [ "armure", "bouclier" ].forEach(attribute => {
        migrated.set(attribute, intval(values[`def${attribute}`]));
        migrated.set(`${attribute}_eqp`, intval(values[`def${attribute}on`]));
        migrated.set(`${attribute}_malus`, intval(values[`def${attribute}malus`]));
        chatMsg.push(`${ capitalize(attribute) }=${ migrated.get(attribute) }`);
      });
      migrated.set("casque_eqp", intval(values.casque_on));
      migrated.set("casque", intval(values.casque_rd));
  
      migrated.set("rd", strval(values.rds));

      atkIds.forEach((id, ix) => {
        oldAtkAttrs.forEach(attr => {
          let [ oldAttr, newAttr ] = attr.split(":");
          if (newAttr === "~")
            return;
          if (!newAttr)
            newAttr = oldAttr;
          const oldValue = strval(values[rptAttr("armes", `arme${oldAttr}`,id)]);
          const newValue = migrateCOF1Value(oldAttr, oldValue);
          migrated.set(rptAttr(section, `arme-${newAttr}`,id), newValue);
          if (oldAttr === "nom")
            chatMsg.push(`Attaque n° ${ix + 1}=${oldValue}`);
        });
        const dm = strval(values[rptAttr("armes", "armedmnbde", id)], "1")+"d"+strval(values[rptAttr("armes", "armedmde", id)], "4");
        migrated.set(rptAttr(section, "arme-dm", id), dm);
      });
  
      migrated.set("version_max", "v" + verCOF1);

      if (migrated.size > 0) {
        setAttrs(Object.fromEntries(migrated));
        chatMsg.push(`Résultat=${migrated.size} attributs repris`);
      }
  
      chatMsg.push(`desc=Migration COF1 v${verCOF1} terminée`);
      sendChatMsg(chatMsg, { whisper: "gm", template: "custom" });
    });
  });
}

/**
 * Update migration log
 * @param {string} log - current migration log
 * @param {string} newVer - new version label
 * @param {string} text - migration text to add
 * @returns {string}
 */
function migrateLog(log, newVer, text) {
  text = `${new Date().toLocaleString() } - v${newVer}: ${text}`;
  return text + "\n" + log;
}

/**
 * Migrate to Version 1.3.0
 * @param {string} sheetType - type of sheet
 * @param {{ major: number, minor: number, patch: number }} curVer - semantic version parts
 * @returns {void}
 * 
 * Update xxx_base caracteristics attributes with xxx values
 */
function migrateSheetToV1_3(sheetType, curVer = { major: 1, minor: 2, patch: 0 }) {
  if (sheetType !== SWData.SHEET_TYPE.PC)
    return;
  
  getAttrs([ "migration", ...SWData.PC.STATS.map(s => shorten(s)) ], function(values) {
    let migration = strval(values.migration);
    delete values.migration;
    const updates = new Map();
    Object.keys(values).forEach(attr => {
      const base = `${attr}_base`;
      updates.set(base, intval(values[attr]));
      migration = migrateLog(migration, "1.3.0", `${base} = ${ updates.get(base) }`)
    });
    updates.set("migration", migration);
    setAttrs(Object.fromEntries(updates));
  });
}

/**
 * Migrate to Version 1.11.0
 * @param {string} sheetType - type of sheet
 * @param {{ major: number, minor: number, patch: number }} curVer - semantic version parts
 */
function migrateSheetToV1_11(sheetType, curVer = { major: 1, minor: 10, patch: 0 }) {
  const updates = new Map();

  if (sheetType === SWData.SHEET_TYPE.NPC) {
    updates.set("atkcac", 0);
    updates.set("atkmag", 0);
  }

  setAttrs(Object.fromEntries(updates));
}

/**
 * Migrate to Version 1.13.0
 * @param {string} sheetType - type of sheet
 * @param {{ major: number, minor: number, patch: number }} curVer - semantic version parts
 */
function migrateSheetToV1_13(sheetType, curVer = { major: 1, minor: 12, patch: 0 }) {
  const updates = new Map();

  if (sheetType === SWData.SHEET_TYPE.NPC) {
    updates.set("atktir", 0);
  }

  setAttrs(Object.fromEntries(updates));
}

/**
 * Apply sheet migrations
 * @param {string} sheetType - character sheet type
 * @param {object} curVer - current version
 * @returns {void}
 */
function migrateSheet(sheetType, curVer) {
  
  if (curVer.major === 1 && curVer.minor < 3)
    migrateSheetToV1_3(sheetType, curVer);

  if (curVer.major === 1 && curVer.minor < 11)
    migrateSheetToV1_11(sheetType, curVer);

  if (curVer.major === 1 && curVer.minor < 13)
    migrateSheetToV1_13(sheetType, curVer);
  
  return;
}

/**
 * Process character token
 * @param {Map} updates - Map of attributes to update
 * @param {object} values - attributes names/values pairs
 * @returns {Map} updated Map of attributes
 */
function getTokenURL(updates, values) {
  const url = strval(values.character_token);
  if (url !== "") {
    [ token_url ] = url.split("?");
    if (token_url)
      updates.set("token_url", token_url);
    else
      updates.set("token_dsp", "");
  }
  return updates;
}

/**
 * Rebuild all path info
 * @param {Map} updates - Map of attributes to update
 * @param {object} values - attributes names/values pairs
 * @returns {Map} updated Map of attributes
 */
function rebuildPathAll(updates, values) {
  const allRanks = seq(9).map(p => values[`rang_voie${p}`]);
  const allNames = seq(9).map(p => values[`voie${p}nom`]);
  updates.set("rangs_voies", allRanks.join(","));
  updates.set("noms_voies", allNames.join("|"));
  return updates;
}

/**
 * Load attack lists
 */
function loadAttackLists(section) {
  processAllAttacks(section, [ "atktype", "label", "nom", "2m" ], function(rowIds, allAttacks) {
    getAttrs([ "main_princ", "main_autre", "bouclier_eqp", ...allAttacks ], function(values) {
      let attackList = [];
      const mainHand = strval(values.main_princ);
      const otherHand = strval(values.main_autre);
      const shield = boolval(values.bouclier_eqp);
      rowIds.forEach(id => {
        const type = strval(values[rptAttr(section, "arme-atktype", id)]);
        if (type === "sort")
          return;
        const label = strval(values[rptAttr(section, "arme-label", id)], "999");
        const name = strval(values[rptAttr(section, "arme-nom", id)]);
        const twoHands = intval(values[rptAttr(section, "arme-2m", id)]);
        attackList.push({
          label: name,
          value: `${label}~${id}~${twoHands}`,
          selected: false,
        });
      });

      // main hand
      let mHandList = [
        { label: "Rien en main"   , value: "0", selected: false },
        ...attackList,
        { label: "Torche"         , value: "torche", selected: false },
        { label: "Autre"          , value: "autre", selected: false },
      ];
      mHandList = mHandList.map(option => {
        option.selected = false;
        if (option.value === mainHand)
          option.selected = true;
        return option;
      });
      populateListOptions({
        elemSelector: ".hand-main",
        optionsArray: mHandList,
      });

      // other hand
      let oHandList = [
        { label: "Rien en main"   , value: "0", selected: false },
        ...attackList,
        { label: "Bouclier"       , value: "bouclier", selected: false },
        { label: "Tenu à 2 mains" , value: "2m", selected: false },
        { label: "Torche"         , value: "torche", selected: false },
        { label: "Autre"          , value: "autre", selected: false },
      ]
      oHandList = oHandList.map(option => {
        option.selected = false;
        if (option.value === otherHand)
          option.selected = true;
        if (option.value === "bouclier" && shield)
          option.selected = true;
        return option;
      });
      populateListOptions({
        elemSelector: ".hand-other",
        optionsArray: oHandList
      });

    });
  });
}

/**
* Parse semantic version label
* @param {string} version
* @returns version object
*/
function parseSemVer(version) {
  version += ".0.0";
  if (version.toLowerCase().startsWith("v")) 
    version = version.slice(1);
  const [ major, minor, patch ] = version.split(".");
  return { 
    major: intval(major),
    minor: intval(minor),
    patch: intval(patch),
  };
}

/**
 * On opening the sheet - general updates
 */
on("sheet:opened", function() {
  getAttrs([
    "version", "verfdp",
    "debug_mode", "scriptVersion", "scriptVersion_max",
    "character_token",
    "sheet_type", "profil", "famille",
    "compagnon", "comp_def", "comp_pv_max", "comp_init", "comp_pnjatk",
    "pnjatk",
    "pc_subtab1",
    "cfg_shadow",
    ...nameSeq(9, "rang_voie#"),
    ...nameSeq(9, "voie#nom")
  ], function (values) {

    setDebugMode(values.debug_mode);

    const sheetType = strval(values.sheet_type);
    
    const verCOF1 = Number(values.version);
    if (!isNaN(verCOF1)) {
      migrateCOF1Sheet(sheetType, verCOF1);
      values.version = "1.1.0";
    }

    const newVer = parseSemVer(values.verfdp);
    const curVer = parseSemVer(values.version);
    if (
      curVer.major < newVer.major ||
      curVer.minor < newVer.minor ||
      curVer.patch < newVer.patch
    ) {
      migrateSheet(sheetType, curVer);
    }

    let updates = new Map();
    
    if (sheetType === SWData.SHEET_TYPE.PC && values.pc_subtab1 === "")
      updates.set("pc_subtab1", "attacks");

    updates = getTokenURL(updates, values);
    
    if (sheetType === SWData.SHEET_TYPE.PC) {
      const family = strval(values.famille);
      const profile = strval(values.profil);
      setProfilesList(family, profile);
      updates = rebuildPathAll(updates, values);
      rebuildBuffValues();
      loadAttackLists("armes");
    } else {
      loadAttackLists("npcarmes");
    }

    // Set companion attributes from master
    if (sheetType === SWData.SHEET_TYPE.NPC) {
      setCompanion(values);
    }

    if (hasMODScript(values)) {
      updates.set("script_title", `COFantasy2 v${ strval(values.scriptVersion_max) }`);
    } else {
      updates.set("script_title", "Le script MOD COFantasy2 n'est pas installé...");
    }
    updates.set("script_show", hasMODScript(values) ? "1" : "0");

    if (values.version !== values.verfdp)
      updates.set("version", values.verfdp);

    setAttrs(Object.fromEntries(updates));
  });
});

/**
 * Update attacks roll buttons > action buttons
 * @param {{section: string, button: string, npc: boolean}} options - settings object
 */
function updateActionButtons(options) {
  const { section, button, npc = false } = options;
  getSectionIDs(`repeating_${section}`, (rowIds) => {
    getAttrs([ "character_name", "sheet_type" ], function(values) {
      const charName = strval(values.character_name);
      if (charName === "")
        return;
      const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
      if (npc !== isNPC)
        return;
      const updates = new Map();
      rowIds.forEach(rowId => {
        const atkBtn = rptAttr(section, button, rowId);
        updates.set(atkBtn, `%{${charName}|${atkBtn}}`);
      });
      if (updates.size > 0)
        setAttrs(Object.fromEntries(updates));
    });
  });
}

/**
 * On opening sheet / changing name
 * - Update attacks roll buttons > action buttons
 */
on("sheet:opened change:character_name", function() {
  
  // PC repeating buttons
  updateActionButtons({ section: "armes", button: "attack-btn" });
  updateActionButtons({ section: "rolls", button: "roll-btn" });

  // NPC repeating buttons
  updateActionButtons({ section: "npcarmes", button: "npcatk-btn", npc: true });
  updateActionButtons({ section: "npcrolls", button: "npcroll-btn", npc: true });

  const allRanks = allPathRanks("rankOwned");
  getAttrs([ "character_name", ...allRanks ], function(values) {
    const charName = strval(values.character_name);
      if (charName === "")
        return;
    
    const updates = new Map([
      "checkup",
      "caract_menu",
      "caract_select",
      "main_princ",
      "main_autre",
      ...allRanks.filter(owned => boolval(values[owned]))
    ].map(b => [ `${b}-btn`, `%{${charName}|${b}-btn}` ]));

    setAttrs(Object.fromEntries(updates));
  });
});

/**
 * On changing luck points or status marker luck options
 * - Update status marker for luck, if any set
 */
on("change:pc change:tkmarker_pc_on change:tkmarker_pc", function() {
  getAttrs([ "sheet_type", "character_name", "tokenmod", "tkmarker_pc_on", "tkmarker_pc", "pc" ], function (values) {
    if (strval(values.sheet_type) === SWData.SHEET_TYPE.NPC)
      return;
    if (!boolval(values.tokenmod))
      return;
    let markerPC = strval(values.tkmarker_pc).trim();
    if (markerPC === "")
      return;
    markerPC = (boolval(values.tkmarker_pc_on) ? "" : "-") + markerPC;
    sendChatCmd(tokenMod(
      strval(values.character_name), 
      { statusmarkers: `${markerPC}:${ intval(values.pc) }` }
    ));
  });
});

/**
 * Update 
 * - noms_rangs attribute
 * - voies_rang(345) attributes
 */
function updateAbilityList() {
  const allRanksOwned = allPathRanks("rankOwned");
  const allRanks = [
    "profil", 
    "noms_voies", "rangs_voies", "noms_rangs",
    ...allRanksOwned,
    ...allPathRanks("rankName"),
    ...allPathRanks("rankProps"),
    ...nameSeq(9, abilityInfo().pathName)
  ];
  getAttrs(allRanks, function(values) {
    const abilityList = allRanksOwned
    .filter(owned => {
      const { rankOwned, rankProps } = abilityInfo(owned);
      return boolval(values[rankOwned]) || hasProp(strval(values[rankProps]), "epic");
    })
    .map(owned => {
      const { pathName, rankName } = abilityInfo(owned);
      return { id: owned, rank: cleanText(values[rankName]), path: cleanText(values[pathName]) };
    });
    const updates = {};
    seq(3, 3).forEach(rank => {
      const count = getPathsWithRank({ profile: strval(values.profil), minRank: rank}, values);
      updates[`voies_rang${rank}`] = count;
    });
    setAttrs({ ...updates, noms_rangs: JSON.stringify(abilityList) });
  });
}

on("sheet:opened "
  + changeEvent(allPathRanks("rankOwned")) 
  + changeEvent(allPathRanks("rankName"))
  + changeEvent(allPathRanks("rankProps"))
  + changeEvent(nameSeq(9, abilityInfo().pathName)), updateAbilityList);

/**
 * Sync pv <=> PVIG for token bars
 */
on("change:pv", function(eventInfo) {
  if (strval(eventInfo.sourceType) !== "player")
    return;
  
  getAttrs([ "pv", "dr" ], function(values) {
    const wounds = wounded(values);
    setAttrs({ 
      PVIG: intval(values.pv),
      dr: wounds.dr,
      condition_affaibli: wounds.condition_affaibli,
      condition_inconscient: wounds.condition_inconscient,
      pvstatus: wounds.pvstatus
    }, { silent: true });
  });
});

/**
 * Sync PVIG <=> pv for token bars
 */
on("change:pvig", function(eventInfo) {
  if (strval(eventInfo.sourceType) !== "player")
    return;

  getAttrs([ "PVIG", "dr" ], function(values) {
    const wounds = wounded({
      pv: intval(values.PVIG),
      dr: values.dr
    });
    setAttrs({
      pv: intval(values.PVIG),
      dr: wounds.dr,
      condition_affaibli: wounds.condition_affaibli,
      condition_inconscient: wounds.condition_inconscient,
      pvstatus: wounds.pvstatus
    }, { silent: true });
  });
});

/**
 * Sync pv_max <=> PVIG_max for token bars
 */
on("change:pv_max", function(eventInfo) {
  if (eventInfo.sourceType !== "player")
    return;

  getAttrs([ "pv_max" ], function(values) {
    setAttrs({ PVIG_max: intval(values.pv_max) }, { silent: true });
  });
});

/**
 * Sync PVIG_max <=> pv_max for token bars
 */
on("change:pvig_max", function(eventInfo) {
  if (eventInfo.sourceType !== "player")
    return;

  getAttrs([ "PVIG_max" ], function(values) {
    setAttrs({ pv_max: intval(values.PVIG_max) }, { silent: true });
  });
});

/**
 * On clicking token adjust buttons (TokenMod)
 */
on("clicked:token_min-btn clicked:token_max-btn clicked:token_siz-btn clicked:token_def-btn", function(eventInfo) {
  getAttrs([ "sheet_type", "character_name", "pm_max", "taille" ], function(values) {
    const bt = strval(eventInfo.triggerName.split("_")[1]);
    const resize = strval(({
      "min-btn": "0.9",
      "max-btn": "1.1",
      "siz-btn": "?{*Taille ?}",
    })[bt]);
    const isNPC = strval(values.sheet_type) === SWData.SHEET_TYPE.NPC;
    let props = {};
    if (resize !== "") {
      props = { scale: "*" + resize };
    } else {
      const tk = SWData.settings.tokens;
      Object.entries(tk[strval(values.sheet_type)]).forEach(([k, v]) => {
        if (v !== "pm" || intval(values.pm_max) > 0)
          props[k] = v;
      });
      if (isNPC) {
        let tokenSize;
        const size = strval(values.taille);
        if (size !== "") {
          tokenSize = ({
            "Minuscule": tk.size * 0.5, "Très petite": tk.size * 0.5,
            "Petite": tk.size, "Moyenne": tk.size,
            "Grande": tk.size * 2, "Énorme": tk.size * 3, "Colossale": tk.size * 4
          })[size] || 70;
        }
        props = { ...props, width: tokenSize, height: tokenSize };
      }
    }
    sendChatCmd(tokenMod(strval(values.character_name), props));
  });

});

// ======================
// CHARACTERMANCER EVENTS
// ======================

/**
 * Run charactermancer
 */
on("clicked:charmancer-btn", function() {
  startCharactermancer("main");
});

on("page:main", function() {
  deleteCharmancerData();
});

/**
 * Change standard array
 */
on("mancerchange:type", function (eventInfo) {
  const type = strval(eventInfo.newValue, "");
  setAttrs({ display: type });
});

on("mancerchange:peuple", function (eventInfo) {
  const people = strval(eventInfo.newValue, "");
  let peopleMods;
  switch (people) {
    case "Demi-elfe":
      peopleMods = "+1 PER ou CHA, -1 FOR ou CON";
      break;
    case "Demi-orc":
      peopleMods = "+1 FOR ou CON et -1 CHA ou INT";
      break;
    case "Elfe (haut)":
      peopleMods = "+1 INT ou CHA, -1 FOR";
      break;
    case "Elfe (sylvain)":
      peopleMods = "+1 AGI ou PER, -1 FOR";
      break;
    case "Gnome":
      peopleMods = "+1 en INT ou PER, -1 en FOR";
      break;
    case "Halfelin":
      peopleMods = "+1 AGI ou VOL, -1 FOR";
      break;
    case "Humain":
      peopleMods = "+1 à la plus faible carac.";
      break;
    case "Nain":
      peopleMods = "+1 en CON ou VOL, -1 en AGI";
      break;
  }
  if (peopleMods) 
    setCharmancerText({ "people-mods": peopleMods }); 
});

/**
 * Return stat final value
 * @param {string} stat - short stat name
 * @param {object} values - charmancer data object
 * @returns {number}
 */
function statValue(stat, values) {
  const statArrays = {
    "pol": [ 2, 2, 2, 1, 1, 0, -1 ],
    "exp": [ 3, 2, 1, 1, 0, 0, -1 ],
    "spe": [ 4, 2, 1, 0, 0, -1, -1 ]
  };
  const ix = intval(values[`${stat}_rb`]);
  const value = statArrays[strval(values.type, "exp")][ix];
  const mod = intval(values[`${stat}_mod`]);
  return (value + mod);
}

/**
 * Swap radio buttons values
 */
SWData.PC.STATS.map(stat => shorten(stat)).forEach(short => {
  const radioBtn = short + "_rb";
  const select = short + "_mod";
  on(`mancerchange:${radioBtn} mancerchange:${select}`, function (eventInfo) {
    const page = strval(eventInfo.currentStep);
    const values = getCharmancerData()[page].values;
    if (eventInfo.triggerName.endsWith("_rb")) {
      const index = intval(eventInfo.newValue);
      const others = SWData.PC.STATS.map(stat => shorten(stat) + "_rb").filter(stat => stat !== short + "_rb");
      const sameValue = others.find(a => intval(values[a]) === index);
      if (sameValue)
        setAttrs({ [sameValue]: eventInfo.previousValue }, { silent: true });
    }
    setCharmancerText({ [`${short}-val`]: statValue(short, values) }); 
  });
});

/**
 * Cancel charactermancer
 */
on("mancer:cancel", function() {
  deleteCharmancerData();
});

/**
 * Finish charactermancer
 */
on("mancerfinish:finish", function(mancerData) {
  const values = mancerData.data.main.values;

  const [ famille, profil ] = strval(values.famille_profil).split(":");
  const peuple = strval(values.peuple);

  const updates = ({ famille, profil, peuple });
  
  // stats
  const type = strval(values.type);
  if (type !== "") {
    SWData.PC.STATS.map(s => shorten(s)).forEach(stat => {
      updates[stat + "_base"] = statValue(stat, values);
    });
  }

  // paths & ranks
  const pathRank2 = intval(values.rank2);
  const voies = [
    strval(values.voie1),
    strval(values.voie2),
    strval(values.voie3)
  ];
  voies.forEach((voie, ix) => {
    if (voie === "")
      return;
    const path = ix +1;
    const attrs = importFromPDF(voie, path);
    attrs.forEach((value, attr) => {
      updates[attr] = value;
    });
    if (famille === "Mages" && pathRank2 === path) {
      updates[`v${path}r2`] = "1";
      updates[`v${path}r2_props`] = "initial";
    }
  });
  if (voies.filter(v => v !== "").length > 0) {
    abilityUsages();
  }

  // gear and attacks
  const baseGear = boolval(values.base_gear);
  const attacks = boolval(values.gear_atks);

  if (baseGear && attacks)
    updates["max_attack_label"] = "0";

  setAttrs(updates);

  if (baseGear) {
    removeRepeatingAll("equipement");
    if (attacks)
      removeRepeatingAll("armes");
    loadBaseGear(profil, attacks);
  }

  deleteCharmancerData();
  finishCharactermancer();
});

</script>
