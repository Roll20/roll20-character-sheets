<input type="hidden" name="attr_fiche" class="typeFiche" value="joueur" />

<div class="top">
	<div class="options">
		<label>
			<input type="checkbox" name="attr_options" value="1" />
			<span></span>
		</label>
		<input type="hidden" name="attr_options" />
		<div class="extend">
			<label>
				<select name="attr_prive">
					<option value="">Jets publics</option>
					<option value="/w gm ">Jets privés</option>
				</select>
			</label>
		</div>
	</div>
	<div class="identite">
		<label>
			<input type="text" name="attr_character_name" />
			<span>Personnage</span>
		</label>
		<label>
			<input type="text" name="attr_concept" />
			<span>Concept</span>
		</label>
		<label>
			<input type="text" name="attr_gardien_celeste" />
			<span>Gardien céleste</span>
		</label>
		<div class="autoex autoex24">
			<textarea name="attr_description" placeholder="Description"></textarea>
			<span name="attr_description"></span>
		</div>
	</div>

	<div class="bigRight">
		<div class="left">
			<label class="fiche">
				<input type="hidden" name="attr_fiche" value="joueur" />
				<input type="checkbox" name="attr_fiche" value="joueur" checked />
				<input type="checkbox" name="attr_fiche" value="loksyu" />
				<span></span>
			</label>
			
			<img src="https://raw.githubusercontent.com/Zakarik/roll20-character-sheets/CdE/Chroniques_De_L_Etrange/img/Logo_CdE.png" />
		</div>

		<div class="right">
			<div class="roll">
				<h1>Jet</h1>
				<div>
					<label>
						<span>Aspect</span>
						<select name="attr_aspect">
							<option value="" selected></option>
							<option value="Feu">Feu</option>
							<option value="Bois">Bois</option>
							<option value="Terre">Terre</option>
							<option value="Eau">Eau</option>
							<option value="Metal">Métal</option>
						</select>
					</label>
					<label>
						<span>Compétence / Ressource</span>
						<select name="attr_CR">
							<optgroup label="Compétences">
								<option value="" selected></option>
								<option value="Art">Art</option>
								<option value="Enquete">Enquête</option>
								<option value="Erudition">Erudition</option>
								<option value="Filouterie">Filouterie</option>
								<option value="Mondanites">Mondanités</option>
								<option value="Prouesse">Prouesse</option>
								<option value="Sciences">Sciences</option>
								<option value="Technologies">Technologies</option>
								<option value="KungFu">Kung-Fu</option>
								<option value="CombatADistance">Combat à distance</option>
								<option value="CinabreInterne">Cinabre Interne</option>
								<option value="Alchimie">Alchimie</option>
								<option value="MaitriseDeLaVoie">Maîtrise de la Voie</option>
								<option value="Exorcisme">Exorcisme</option>
								<option value="Geomancie">Géomancie</option>
							</optgroup>
							<optgroup label="Ressources">
								<option value="Materiel">Matériel</option>
								<option value="Renseignement">Renseignement</option>
								<option value="Influence">Influence</option>
							</optgroup>
						</select>
					</label>
				</div>
				<div class="bonus">
					<span>Bonus</span>
					<input type="number" name="attr_bonus" value="0" />
					<input type="hidden" name="attr_nAspect" value="" />
					<input type="hidden" name="attr_rollTotal" value="" />
					<input type="hidden" name="attr_roll" value="" />
					<button type="roll" name="roll_jet" value="@{prive} &{template:roll} {{nom=@{character_name}}} {{base=@{aspect}}} {{nBase=@{nAspect}}} @{roll}"></button>
				</div>
				<label class="button">
					<input type="checkbox" name="attr_specialite" value="1" />
					<span title="Utilisation de spécialité"></span>
				</label>
			</div>
		</div>
	</div>
</div>

<div class="middle">
	<div class="competences">
		<h1>Compétences</h1>
		<div>
			<input type="hidden" name="attr_expandArt" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandArt" value="1" checked />
				<span></span>
			</label>
			<h2>Art</h2>
			<input type="number" name="attr_scoreArt" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speArt"></textarea>
				<span name="attr_speArt"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandEnquete" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandEnquete" value="1" checked />
				<span></span>
			</label>
			<h2>Enquête</h2>
			<input type="number" name="attr_scoreEnquete" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speEnquete"></textarea>
				<span name="attr_speEnquete"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandErudition" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandErudition" value="1" checked />
				<span></span>
			</label>
			<h2>Érudition</h2>
			<input type="number" name="attr_scoreErudition" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speErudition"></textarea>
				<span name="attr_speErudition"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandFilouterie" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandFilouterie" value="1" checked />
				<span></span>
			</label>
			<h2>Filouterie</h2>
			<input type="number" name="attr_scoreFilouterie" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speFilouterie"></textarea>
				<span name="attr_speFilouterie"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandMondanites" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandMondanites" value="1" checked />
				<span></span>
			</label>
			<h2>Mondanités</h2>
			<input type="number" name="attr_scoreMondanites" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speMondanites"></textarea>
				<span name="attr_speMondanites"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandProuesse" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandProuesse" value="1" checked />
				<span></span>
			</label>
			<h2>Prouesse</h2>
			<input type="number" name="attr_scoreProuesse" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speProuesse"></textarea>
				<span name="attr_speProuesse"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandSciences" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandSciences" value="1" checked />
				<span></span>
			</label>
			<h2>Sciences</h2>
			<input type="number" name="attr_scoreSciences" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speSciences"></textarea>
				<span name="attr_speSciences"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandTechnologies" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandTechnologies" value="1" checked />
				<span></span>
			</label>
			<h2>Technologies</h2>
			<input type="number" name="attr_scoreTechnologies" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speTechnologies"></textarea>
				<span name="attr_speTechnologies"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandKungFu" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandKungFu" value="1" checked />
				<span></span>
			</label>
			<h2>Kung-fu</h2>
			<input type="number" name="attr_scoreKungFu" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speKung"></textarea>
				<span name="attr_speKung"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandCombatADistance" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandCombatADistance" value="1" checked />
				<span></span>
			</label>
			<h2>Combat à distance</h2>
			<input type="number" name="attr_scoreCombatADistance" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speCombatADistance"></textarea>
				<span name="attr_speCombatADistance"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandCinabreInterne" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandCinabreInterne" value="1" checked />
				<span></span>
			</label>
			<h2>Cinabre interne (Métal)</h2>
			<input type="number" name="attr_scoreCinabreInterne" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speCinabreInterne"></textarea>
				<span name="attr_speCinabreInterne"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandAlchimie" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandAlchimie" value="1" checked />
				<span></span>
			</label>
			<h2>Alchimie (Eau)</h2>
			<input type="number" name="attr_scoreAlchimie" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speAlchimie"></textarea>
				<span name="attr_speAlchimie"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandMaitriseDeLaVoie" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandMaitriseDeLaVoie" value="1" checked />
				<span></span>
			</label>
			<h2>Maîtrise de la voie (Terre)</h2>
			<input type="number" name="attr_scoreMaitriseDeLaVoie" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speMaitriseDeLaVoie"></textarea>
				<span name="attr_speMaitriseDeLaVoie"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandExorcisme" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandExorcisme" value="1" checked />
				<span></span>
			</label>
			<h2>Exorcisme (Feu)</h2>
			<input type="number" name="attr_scoreExorcisme" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speExorcisme"></textarea>
				<span name="attr_speExorcisme"></span>
			</div>
		</div>
		<div>
			<input type="hidden" name="attr_expandGeomancie" value="1" />
			<label class="expand">
				<input type="checkbox" name="attr_expandGeomancie" value="1" checked />
				<span></span>
			</label>
			<h2>Géomancie (Bois)</h2>
			<input type="number" name="attr_scoreGeomancie" value="0" />
			<div class="autoex autoex24 expand">
				<textarea name="attr_speGeomancie"></textarea>
				<span name="attr_speGeomancie"></span>
			</div>
		</div>
	</div>

	<div class="aspects">
		<h1>Aspects</h1>
		<input type="number" name="attr_feu" value="0" />
		<input type="number" name="attr_bois" value="0" />
		<input type="number" name="attr_terre" value="0" />
		<input type="number" name="attr_eau" value="0" />
		<input type="number" name="attr_metal" value="0" />
		<img src="https://raw.githubusercontent.com/Zakarik/roll20-character-sheets/CdE/Chroniques_De_L_Etrange/img/ng_hang.png" />
	</div>
</div>

<div class="bottom">
	<div class="RessSanhei">
		<div class="ressources">
			<h1>Ressources</h1>
			<div>
				<span>Dette</span>
			</div>
			<div>
				<label>
					<input type="text" name="attr_materiel" />
					<span>Materiel</span>
				</label>
				<input type="number" name="attr_scoreMateriel" value="0" />
				<input type="checkbox" name="attr_detteMateriel" value="1" />
			</div>
			<div>
				<label>
					<input type="text" name="attr_renseignement" />
					<span>Renseignement</span>
				</label>
				<input type="number" name="attr_scoreRenseignement" value="0" />
				<input type="checkbox" name="attr_detteRenseignement" value="1" />
			</div>
			<div>
				<label>
					<input type="text" name="attr_influence" />
					<span>Influence</span>
				</label>
				<input type="number" name="attr_scoreInfluence value="0" />
				<input type="checkbox" name="attr_detteInfluence" value="1" />
			</div>
		</div>
		
		<div class="sanhei">
			<h1>Sanhei</h1>
			<fieldset class="repeating_sanhei">
				<div class="autoex autoex24">
					<textarea name="attr_sanhei"></textarea>
					<span name="attr_sanhei"></span>
				</div>
			</fieldset>
		</div>
		
		<div class="artsMartiaux">
			<h1>Arts Martiaux</h1>
			<fieldset class="repeating_artsMartiaux">
				<div class="autoex autoex24">
					<textarea name="attr_artsMartiaux"></textarea>
					<span name="attr_artsMartiaux"></span>
				</div>
			</fieldset>
		</div>
		
		<div class="equipement">
			<h1>Équipement</h1>
			<fieldset class="repeating_equipement">
				<div class="autoex autoex24">
					<textarea name="attr_equipement"></textarea>
					<span name="attr_equipement"></span>
				</div>
			</fieldset>
		</div>
	</div>

	<div class="tresorsComp">
		<div class="tresor">
			<h1>Les Trois Trésors</h1>
			<h2>Hei</h2>
			<div>
				<h3>Essence</h3>
			</div>
			<div>
				<label>
					<span>Yang</span>
					<input type="number" name="attr_yang" value="0" />
				</label>
				<img src="https://raw.githubusercontent.com/Zakarik/roll20-character-sheets/CdE/Chroniques_De_L_Etrange/img/Yin-Yang.png" />
				<label>
					<span>Yin</span>
					<input type="number" name="attr_yin" value="0" />
				</label>
			</div>
			<div>
				<h2>San</h2>
				<h3>Santé mentale</h3>
				<span>Actuel</span>
				<span>Max</span>
				<div>
					<input type="number" name="attr_SM1" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SM1_max" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SM2" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SM2_max" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SM3" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SM3_max" value="0" />
				</div>
			</div>
			<div>
				<h2>Zing</h2>
				<h3>Santé physique</h3>
				<span>Actuel</span>
				<span>Max</span>
				<div>
					<input type="number" name="attr_SP1" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SP1_max" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SP2" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SP2_max" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SP3" value="0" />
				</div>
				<div>
					<input type="number" name="attr_SP3_max" value="0" />
				</div>
			</div>
		</div>
		<div class="comp">
			<h1>Composants & Ingrédients</h1>
			<div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp01"></textarea>
						<span name="attr_comp01"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp02"></textarea>
						<span name="attr_comp02"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp03"></textarea>
						<span name="attr_comp03"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp04"></textarea>
						<span name="attr_comp04"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp05"></textarea>
						<span name="attr_comp05"></span>
					</div>
				</div>
			</div>
			<div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp06"></textarea>
						<span name="attr_comp06"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp07"></textarea>
						<span name="attr_comp07"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp08"></textarea>
						<span name="attr_comp08"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp09"></textarea>
						<span name="attr_comp09"></span>
					</div>
				</div>
				<div>
					<span></span>
					<div class="autoex autoex24">
						<textarea name="attr_comp10"></textarea>
						<span name="attr_comp10"></span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="loksyu">
	<div class="left">
		<label class="fiche">
			<input type="hidden" name="attr_fiche" value="joueur" />
			<input type="checkbox" name="attr_fiche" value="joueur" checked />
			<input type="checkbox" name="attr_fiche" value="loksyu" />
			<span></span>
		</label>
		
		<img src="https://raw.githubusercontent.com/Zakarik/roll20-character-sheets/CdE/Chroniques_De_L_Etrange/img/Logo_CdE.png" />
	</div>
	<div class="gestionLoksyu">
		<input type="number" name="attr_loksyuYinFeu" class="loksyuYinFeu" value="0" />
		<input type="number" name="attr_loksyuYangFeu" class="loksyuYangFeu" value="0" />
		<input type="number" name="attr_loksyuYinBois" class="loksyuYinBois" value="0" />
		<input type="number" name="attr_loksyuYangBois" class="loksyuYangBois" value="0" />
		<input type="number" name="attr_loksyuYinTerre" class="loksyuYinTerre" value="0" />
		<input type="number" name="attr_loksyuYangTerre" class="loksyuYangTerre" value="0" />
		<input type="number" name="attr_loksyuYinEau" class="loksyuYinEau" value="0" />
		<input type="number" name="attr_loksyuYangEau" class="loksyuYangEau" value="0" />
		<input type="number" name="attr_loksyuYinMetal" class="loksyuYinMetal" value="0" />
		<input type="number" name="attr_loksyuYangMetal" class="loksyuYangMetal" value="0" />
	</div>
</div>

<rolltemplate class="sheet-rolltemplate-roll">
	<h1>{{nom}}</h1>
	<h2>Jet base : {{nBase}}</h2>
	<div class="{{base}}">
		{{#allprops() nom base nBase}}
			<div class="{{value}}">
				<span class="feu-yin" title="2">Yin Feu</span>
				<span class="feu-yang" title="7">Yang Feu</span>
				
				<span class="bois-yin" title="4">Yin Bois</span>
				<span class="bois-yang" title="9">Yang Bois</span>
				
				<span class="terre-yin" title="10">Yin Terre</span>
				<span class="terre-yang" title="5">Yang Terre</span>
				
				<span class="eau-yin" title="6">Yin Eau</span>
				<span class="eau-yang" title="1">Yang Eau</span>
				
				<span class="metal-yin" title="3">Yang Métal</span>
				<span class="metal-yang" title="8">Yang Métal</span>
			</div>
		{{/allprops() nom base nBase}}
	</div>
	<span class="success">Succès en vert.</span>
	<span class="desFastes">Dés-fastes en bleu.</span>
	<span class="desNefastes">Dés-néfastes en rouge.</span>
	<span class="Loksyu">Loksyu en noir.</span>
	<span class="TinJi">Tin Ji en en jaune.</span>
</rolltemplate>

<script type="text/worker">
	const CRList = ["Art", "Enquete", "Erudition", "Filouterie", "Mondanites", "Prouesse", "Sciences", "Technologies", "KungFu", "CombatADistance", "CinabreInterne", "Alchimie", "MaitriseDeLaVoie", "Exorcisme", "Geomancie", "Materiel", "Renseignement", "Influence"];
	
	_.each(CRList, function(competence, i)
	{
		
		on("change:aspect change:CR change:score"+competence+" change:feu change:bois change:terre change:eau change:metal change:bonus change:specialite sheet:opened", function() 
		{
			getAttrs(["aspect", "CR", "score"+competence+"", "feu", "bois", "terre", "eau", "metal", "bonus", "specialite"], function(value) 
			{
				const aspect = value["aspect"];
				const feu = parseInt(value["feu"], 10)||0;
				const bois = parseInt(value["bois"], 10)||0;
				const terre = parseInt(value["terre"], 10)||0;
				const eau = parseInt(value["eau"], 10)||0;
				const metal = parseInt(value["metal"], 10)||0;
				
				const compRess = value["CR"];
				const score = parseInt(value["score"+competence], 10)||0;
				
				const bonus = parseInt(value["bonus"], 10)||0;
				
				const specialite = parseInt(value["specialite"], 10)||0;
				
				var total = 0;
				var nomAspect = "";

				if(compRess == competence)
				{
					if(aspect == "Feu")
					{
						total += feu;
						nomAspect = "Feu";
					}
					
					if(aspect == "Bois")
					{
						total += bois;
						nomAspect = "Bois";
					}
					
					if(aspect == "Terre")
					{						
						total += terre;
						nomAspect = "Terre";
					}
					
					if(aspect == "Eau")
					{						
						total += eau;
						nomAspect = "Eau";
					}
					
					if(aspect == "Metal")
					{						
						total += metal;
						nomAspect = "Métal";
					}
					
					total += score;
					
					if(compRess == "Materiel" || compRess == "Renseignement" || compRess == "Influence")
						total += 1;
					else if(compRess != "Materiel" && compRess != "Renseignement" && compRess != "Influence")
						total += specialite;
					
					total += bonus;
					
					setAttrs({
						rollTotal: total
					});
				}
			});
		});
	});

	on("change:rollTotal change:SM2 change:SM2_max change:SM3 change:SM3_max change:SP2 change:SP2_max change:SP3 change:SM3_max", function() 
	{
		getAttrs(["rollTotal", "SM2", "SM2_max", "SM3", "SM3_max", "SP2", "SP2_max", "SP3", "SP3_max"], function(value) 
		{
			var total = parseInt(value["rollTotal"], 10)||0;
			
			const SM2 = parseInt(value["SM2"], 10)||0;
			const SM2M = parseInt(value["SM2_max"], 10)||0;
			
			const SM3 = parseInt(value["SM3"], 10)||0;
			const SM3M = parseInt(value["SM3_max"], 10)||0;
			
			const SP2 = parseInt(value["SP2"], 10)||0;
			const SP2M = parseInt(value["SP2_max"], 10)||0;
			
			const SP3 = parseInt(value["SP3"], 10)||0;
			const SP3M = parseInt(value["SP3_max"], 10)||0;
			
			var roll = "";
			
			if(SM2 < SM2M)
				total -= 1;
			if(SM3 < SM3M)
				total -= 1;
				
			if(SP2 < SP2M)
				total -= 1;
			if(SP3 < SP3M)
				total -= 1;

			for(i = 0;i < total;i++)
			{
				roll += "{{roll"+i+"=[[1D10]]}} ";
			}
	
			setAttrs({
				roll: roll
			});
		});
	});
</script>