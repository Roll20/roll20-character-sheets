<div class="sheet-container">
    <div class="sheet-section-main">
        <div class="sheet-header">
            <div>
                <img src="https://github.com/RoenMidnight/roll20-character-sheets/blob/3detvictory-new-sheet/3DeT_VICTORY/assets/3detlogo.png?raw=true" class="sheet-logo"/>
            </div>
            <div class="sheet-nome-pontos">
                <label>Nome:  </label><input class="sheet-right sheet-shorttext" type="text" name="attr_charactername"/>
                <label>Pontos:</label><input class="sheet-right sheet-shorttext" type="number" name="attr_points"/>
            </div>
        </div>

        <div class="sheet-dkarma">
            <label>Darma/Karma <input type="checkbox" name="attr_dkarma"></label>
        </div>
        <div class="sheet-body">            
            <div class="sheet-main-atributes">        
                <div name="attributes" class="sheet-section">
                    <div class="sheet-3colrow">
                        <div class="sheet-titulo">
                            <label>Atributos</label>
                        </div>
                        <div name="Atributos" class="sheet-attributes">
                            <div name="Poder" class="sheet-bold sheet-border">
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='d6-poder'>a</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='2d6-poder'>b</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='3d6-poder'>c</button>
                                
                                <label>Poder</label>
                                <div>
                                    <input type="number" name="attr_poder" class="sheet-main-attributes" min="0" value="0"/>
                                </div>
                            </div>
                            <div name="Habilidade" class="sheet-bold sheet-border">
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='d6-habilidade'>a</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='2d6-habilidade'>b</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='3d6-habilidade'>c</button>
                                
                                <label>Habilidade</label>
                                <div>
                                    <input type="number" name="attr_habilidade" class="sheet-main-attributes" min="0" value="0"/>
                                </div>
                            </div>
                            <div name="Resistencia" class="sheet-bold sheet-border">
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='d6-resistencia'>a</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='2d6-resistencia'>b</button>
                                <button type="action" name="act_rolld6" class="sheet-button-attribute sheet-d6" value='3d6-resistencia'>c</button>
                                
                                <label>Resistência</label>
                                <div>
                                    <input type="number" name="attr_resistencia" class="sheet-main-attributes"  min="0" value="0"/>
                                </div>
                            </div>                    
                        </div>
                    </div>
                </div>
                <div name="characterpoints" class="sheet-variate-section">
                    <div class="sheet-3colrow">
                        <div name="VidaMagia" class="sheet-attributes">
                            <div name="vida" class="sheet-bold">
                                <div class="sheet-variate-attributes">
                                    <label>Pontos de Ação</label>
                                    <input type="number" name="attr_acao" class="sheet-main-attributes" value="0"/>
                                    
                                    <label class="sheet-padding-atuais">Atuais</label>
                                    <input type="number" name="attr_acaoatual" class="sheet-main-attributes" value="0"/>                                    
                                </div>                                
                            </div>
                            <div name="magia" class="sheet-bold">
                                <div class="sheet-variate-attributes">
                                    <label>Pontos de Magia</label>
                                    <input type="number" name="attr_magia" class="sheet-main-attributes" value="0"/>  
                          
                                    <label class="sheet-padding-atuais">Atuais</label>
                                    <input type="number" name="attr_magiaatual" class="sheet-main-attributes" value="0"/>                                   
                                </div>
                            </div>
                            <div name="acao" class="sheet-bold">
                                <div class="sheet-variate-attributes">
                                    <label>Pontos de Vida</label>
                                    <input type="number" name="attr_vida" class="sheet-main-attributes" value="0"/>

                                    <label class="sheet-padding-atuais">Atuais</label>
                                    <input type="number" name="attr_vidaatual" class="sheet-main-attributes" value="0"/>    
                                </div>                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div name="characterfeatures" class="sheet-section-dvan">
                <div class="sheet-3colrow">                    
                    <div name="Vantagens" class="sheet-column-dvan">
                        <div class="sheet-titulo">
                            <label>Vantagens:</label>
                        </div>                        
                        <fieldset class="repeating_vantagens">
                            <div class="container-ability-power">
                                <button type="roll" name="roll_ability" class="buttonshowinfo" value="&{template:default}{{name=@{character_name}}}{{Vantagem=@{nameability}}}{{Descrição=@{abilitydescription}}}"></button>
                                <input name="attr_nameability" type="text" spellcheck="false" value=""/>
                                <input type="checkbox" class="hiddencheckbox">
                                <span class="hiddencheckboxcover">W</span>
                                <div class="extra">
                                    <textarea name="attr_abilitydescription"></textarea>
                                </div>
                            </div>
                        </fieldset>
                       
                    </div>
                    <div name="Desvantagens" class="sheet-column-dvan">
                        <div class="sheet-titulo">
                            <label>Desvantagens:</label>
                        </div>   
                        <fieldset class="repeating_desvantagens">
                            <div class="container-ability-power">
                                <button type="roll" name="roll_ability" class="buttonshowinfo" value="&{template:default}{{name=@{character_name}}}{{Desvantagem=@{nameability}}}{{Descrição=@{abilitydescription}}}"></button>
                                <input name="attr_nameability" type="text" spellcheck="false" value=""/>
                                <input type="checkbox" class="hiddencheckbox">
                                <span class="hiddencheckboxcover">W</span>
                                <div class="extra">
                                    <textarea name="attr_abilitydescription"></textarea>
                                </div>
                            </div>
                        </fieldset>
                    </div>                    
                </div>
            </div>
        </div>

        <div class="sheet-pertec">
            <div class="sheet-pericia">
                <div class="sheet-titulo">
                    <label>Perícias</label>
                </div>
                <div class="sheet-3colrow">
                    <div>
                        <label><input type="checkbox" name="attr_animais">Animais</label>
                        <label><input type="checkbox" name="attr_arte">Arte</label>
                        <label><input type="checkbox" name="attr_esporte">Esporte</label>
                    </div>
                    <div>
                        <label><input type="checkbox" name="attr_influencia">Influência</label>
                        <label><input type="checkbox" name="attr_luta">Luta</label>
                        <label><input type="checkbox" name="attr_manha">Manha</label>
                    </div>
                    <div>
                        <label><input type="checkbox" name="attr_maquinas">Máquinas</label>
                        <label><input type="checkbox" name="attr_medicina">Medicina</label>
                        <label><input type="checkbox" name="attr_mistica">Mística</label>
                    </div>
                    <div>
                        <label><input type="checkbox" name="attr_percepcao">Percepção</label>
                        <label><input type="checkbox" name="attr_saber">Saber</label>
                        <label><input type="checkbox" name="attr_sustento">Sustento</label>
                    </div>               
                </div>
            </div>
            <div class="sheet-tecnica">
                <div class="sheet-3colrow">  
                    <div class="sheet-titulo">
                        <label>Técnicas</label>
                    </div>
                    <div>
                        <fieldset class="repeating_spells">
                            <div class="container-single-spell">
                                <button type="roll" name="roll_spell" class="buttonspell" value="&{template:default}{{name=@{character_name}}}{{Nome=@{namespell}}}{{Requisito=@{spellrequisito}}}{{Alcance=@{spellalcance}}}{{Custo=@{spellcusto}}}{{Duração=@{spellduracao}}}{{Descrição=@{spelldescription}}}"></button>
                                <input name="attr_namespell" type="text" spellcheck="false" value=""/>
                                <input type="checkbox" class="hiddencheckbox">
                                <span class="hiddencheckboxcover">W</span>
                                <div class="extra">                               
                                    <span>Requisito</span>
                                    <input  class="singleline" name="attr_spellrequisito" type="text" spellcheck="false" value=""/>
                                    <span>Alcance</span>
                                    <input class="singleline" name="attr_spellalcance" type="text" spellcheck="false" value=""/>
                                    <span>Custo</span>
                                    <input class="singleline" name="attr_spellcusto" type="text" spellcheck="false" value=""/>
                                    <span>Duração</span>
                                    <input class="singleline" name="attr_spellduracao" type="text" spellcheck="false" value=""/>
                                    
                                    <span class="fullline">Descrição</span>
                                    <textarea class="fullline" name="attr_spelldescription"></textarea>
                                </div>
                            </div>
                        </fieldset>
                    </div>    
                </div>            
            </div>
        </div>

    </div>    
</div>

<rolltemplate class="sheet-rolltemplate-3det">
    <div class="sheet-rollbox-container">
        <div class="rollbox">
            <div class="roll-title">
                {{character}} 
            </div>
            <div class="roll-rolls">
                <label>Rolagem: {{roll}}</label>
            </div>
            <div class="roll-result">                
                <label>Resultado: {{computed::resultroll}}</label>
            </div>
        </div>
    </div>
</rolltemplate>

<script type="text/worker">
    on("clicked:rolld6", function(r){    
        let dado = r.htmlAttributes.value.split('-')[0];
        let atributo = r.htmlAttributes.value.split('-')[1];

        getAttrs(["charactername", atributo], function(v){ 
            startRoll(`&{template:3det} {{character=${v.charactername}}} {{roll=[[${dado}+${v[atributo]}]]}} {{resultroll=[[0]]}}`, diceroll => {
                console.log({diceroll})
                const dice = diceroll.results.roll.dice;
                const rolls = dice.join(' + ');
                const successes = dice.filter(d => d == 6);

                const sum_dice = dice.reduce((partialSum, a) => parseInt(partialSum) + parseInt(a), 0) + parseInt(v[atributo]);
                const critical = (successes.length * parseInt(v[atributo]));
                const result = parseInt(sum_dice) + parseInt(critical);    
                
                console.log(dice, rolls, successes)
                                                
                // in finishroll, you can save computed values - the hidden alternate values in your roll's keys.
                finishRoll(diceroll.rollId,{
                    resultroll: result
                });
            });        
        });
    });
</script>




