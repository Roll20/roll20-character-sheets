<!-- Dead of Night -->
<div class="sheet-don-ficha">
  <div class="sheet-columnas">

    <!-- COLUMNA IZQUIERDA -->
    <div class="sheet-col-izq">

      <!-- Nombre -->
      <div class="sheet-linea-doble">
        <label>Nombre de la víctima:</label>
        <input type="text" name="attr_character_name" class="sheet-nombre-personaje" />
      </div>

      <!-- Atributos -->
      <div class="sheet-atributos">
        <div class="attrs-2cols">

          <!-- LADO IZQUIERDO -->
          <div class="attrs-left">

            <!-- Identificar -->
            <div class="attr-item">
              <button type="roll" name="roll_identificar" class="attr-label"
                value="&{template:default} {{name=Identificar — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{identificar}]] + [[?{Modificador|0}]] ]]}}">
                Identificar
              </button>
              <input type="number" name="attr_identificar" min="1" max="9" value="5" />
            </div>
            <input type="text" name="attr_identificar_spec" class="spec" placeholder="Especialización (Identificar)" />

            <!-- Persuadir -->
            <div class="attr-item">
              <button type="roll" name="roll_persuadir" class="attr-label"
                value="&{template:default} {{name=Persuadir — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{persuadir}]] + [[?{Modificador|0}]] ]]}}">
                Persuadir
              </button>
              <input type="number" name="attr_persuadir" min="1" max="9" value="5" />
            </div>
            <input type="text" name="attr_persuadir_spec" class="spec" placeholder="Especialización (Persuadir)" />

            <!-- Perseguir -->
            <div class="attr-item">
              <button type="roll" name="roll_perseguir" class="attr-label"
                value="&{template:default} {{name=Perseguir — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{perseguir}]] + [[?{Modificador|0}]] ]]}}">
                Perseguir
              </button>
              <input type="number" name="attr_perseguir" min="1" max="9" value="5" />
            </div>
            <input type="text" name="attr_perseguir_spec" class="spec" placeholder="Especialización (Perseguir)" />

            <!-- Atacar -->
            <div class="attr-item">
              <button type="roll" name="roll_atacar" class="attr-label"
                value="&{template:default} {{name=Atacar — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{atacar}]] + [[?{Modificador|0}]] ]]}}">
                Atacar
              </button>
              <input type="number" name="attr_atacar" min="1" max="9" value="5" />
            </div>
            <input type="text" name="attr_atacar_spec" class="spec" placeholder="Especialización (Atacar)" />

          </div><!-- /attrs-left -->

          <!-- LADO DERECHO -->
          <div class="attrs-right">

            <!-- Ocultar -->
            <div class="attr-item">
              <button type="roll" name="roll_ocultar" class="attr-label"
                value="&{template:default} {{name=Ocultar — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{ocultar}]] + [[?{Modificador|0}]] ]]}}">
                Ocultar
              </button>
              <input type="number" name="attr_ocultar" min="1" max="9" value="5" readonly />
            </div>
            <input type="text" name="attr_ocultar_spec" class="spec" placeholder="Especialización (Ocultar)" />

            <!-- Disuadir -->
            <div class="attr-item">
              <button type="roll" name="roll_disuadir" class="attr-label"
                value="&{template:default} {{name=Disuadir — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{disuadir}]] + [[?{Modificador|0}]] ]]}}">
                Disuadir
              </button>
              <input type="number" name="attr_disuadir" min="1" max="9" value="5" readonly />
            </div>
            <input type="text" name="attr_disuadir_spec" class="spec" placeholder="Especialización (Disuadir)" />

            <!-- Escapar -->
            <div class="attr-item">
              <button type="roll" name="roll_escapar" class="attr-label"
                value="&{template:default} {{name=Escapar — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{escapar}]] + [[?{Modificador|0}]] ]]}}">
                Escapar
              </button>
              <input type="number" name="attr_escapar" min="1" max="9" value="5" readonly />
            </div>
            <input type="text" name="attr_escapar_spec" class="spec" placeholder="Especialización (Escapar)" />

            <!-- Proteger -->
            <div class="attr-item">
              <button type="roll" name="roll_proteger" class="attr-label"
                value="&{template:default} {{name=Proteger — @{character_name}}} {{Objetivo=[[?{Dificultad|15}]]}} {{Mod=[[?{Modificador|0}]]}} {{Tirada=[[ 2d10 + [[@{proteger}]] + [[?{Modificador|0}]] ]]}}">
                Proteger
              </button>
              <input type="number" name="attr_proteger" min="1" max="9" value="5" readonly />
            </div>
            <input type="text" name="attr_proteger_spec" class="spec" placeholder="Especialización (Proteger)" />

          </div><!-- /attrs-right -->

        </div><!-- /attrs-2cols -->
      </div><!-- /sheet-atributos -->

      <!-- Puntos de Supervivencia -->
      <div class="box box-ps">
        <div class="legend">Puntos de Supervivencia</div>
        <div class="ps-row">
          <button type="action" name="act_ps_minus" class="psbtn">−</button>
          <input type="number" name="attr_ps" value="5" min="0" />
          <button type="action" name="act_ps_plus" class="psbtn">+</button>
        </div>
      </div>

    </div><!-- /sheet-col-izq -->

    <!-- COLUMNA DERECHA -->
    <div class="sheet-col-der">

      <!-- LOGO DoN -->
      <div class="box-logo">
        <img class="don-logo" src="logo_don.png" alt="Dead of Night logo" />
      </div>

      <!-- Notas -->
      <div class="box box-notas">
        <div class="legend">Notas</div>
        <textarea name="attr_notas" placeholder="Notas de la aventura, pistas, heridas…"></textarea>
      </div>

      <!-- Malos hábitos -->
      <div class="box box-maloshabitos">
        <div class="legend">Malos hábitos</div>
        <fieldset class="repeating_maloshabitos">
          <input type="text" name="attr_malohabito" placeholder="Añade un mal hábito…" />
        </fieldset>
      </div>

    </div><!-- /sheet-col-der -->

  </div><!-- /sheet-columnas -->
<div class="sheet-credito">
  Ficha del juego Dead of Night adaptada a Roll20 por <a href="https://app.roll20.net/users/33210/jj" target="_blank">Dantés Jr</a>
</div>
</div><!-- /sheet-don-ficha -->

<!-- SHEETWORKERS -->
<script type="text/worker">
  // Pares que siempre suman 10 (el segundo se recalcula)
  const pairs = [
    ['identificar','ocultar'],
    ['persuadir','disuadir'],
    ['perseguir','escapar'],
    ['atacar','proteger']
  ];
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

  pairs.forEach(([a,b])=>{
    on(`change:${a}`, evt=>{
      const v = clamp(parseInt(evt.newValue)||0,1,9);
      setAttrs({[a]: v, [b]: clamp(10 - v,1,9)});
    });
  });

  // Botones de PS +/-
  on('clicked:ps_plus clicked:ps_minus', (e)=>{
    getAttrs(['ps'], v=>{
      let ps = parseInt(v.ps)||0;
      ps += (e.htmlAttributes.name==='act_ps_plus') ? 1 : -1;
      if(ps<0) ps=0;
      setAttrs({ps});
    });
  });
</script>
