



<rolltemplate class="sheet-rolltemplate-rmu">
  <div class='sheet-rolltemplate-rmurollbox'>
    <em>{{actor}} {{verb}} {{action}}:</em><br>
    Result:
    {{#rollLess() um 5}}
      {{rolll}} (= {{bonus}} + {{um}} - {{rollsub}})
      (Open Ended Low)
    {{/rollLess() um 5}}
    {{#^rollLess() um 5}}
      {{rollh}} (= {{bonus}} + {{um}})
    {{/^rollLess() um 5}}
    {{#rollTotal() um 33}}
      <br>Breakage check? (33)
    {{/rollTotal() um 33}}
    {{#rollTotal() um 77}}
      <br>Breakage check? (77)
    {{/rollTotal() um 77}}
    {{#rollTotal() um 66}}
      <br>Unusual event! (66)
    {{/rollTotal() um 66}}
   </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmumod">
  <div class='sheet-rolltemplate-rmurollbox'>
    <em>{{actor}} {{verb}} {{action}}:</em><br>
    Result:
    {{#rollLess() um 5}}
      {{rolll}} (= {{bonus}} + {{modifier}} + {{um}} - {{rollsub}})
      (Open Ended Low)
    {{/rollLess() um 5}}
    {{#^rollLess() um 5}}
      {{rollh}} (= {{bonus}} + {{modifier}} + {{um}})
    {{/^rollLess() um 5}}
    {{#rollTotal() um 33}}
      <br>Breakage check? (33)
    {{/rollTotal() um 33}}
    {{#rollTotal() um 77}}
      <br>Breakage check? (77)
    {{/rollTotal() um 77}}
    {{#rollTotal() um 66}}
      <br>Unusual event! (66)
    {{/rollTotal() um 66}}
   </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmuinit">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rmuinitbox'>
    {{actor}} rolls Initialive:<br>
      {{total}} = {{bonus}}&nbsp;[Bonus] + {{roll}}&nbsp;[Roll]
      {{#rollLess() maneuver 0}}
      + {{maneuver}}&nbsp;[Maneuver Penalty / 10]
      {{/rollLess() maneuver 0}}
  </div>
</rolltemplate>


<!--Name {{name}} Attack Roll {{attack}} {{critical}} {{location}} {{fluff}} {{result}}
    Name {{name}} Attack Roll {{attack}} Crit {{critical}} Loc {{computed::location}} 
    {{computed::fluff}} 
    {{result}}

    computed::injurystring is the injury enced string to send accross.



      {{#^rollTotal() maneuverpenalty 0}}
	{{maneuverpenalty}} [Maneuver&nbsp;Penalty]
      {{/^rollTotal() maneuverpenalty 0}}

-->
<rolltemplate class="sheet-rolltemplate-rmuattack">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rollattack'>
    <i>{{name}}</i> attacks <i>{{target}}</i> with a <i>{{weapon}}</i><br>

    <b>{{computed::attackresult}}!</b>
    <p style='padding-left:1em;text-indent:-1em;' class='hangingindent'>
      <b>{{computed::attackroll}}</b> =
      {{attackrollum}} [Roll] {{computed::attackmoddescription}}
    </p>
    {{#rollTotal() computed::ishit 1}}
      Hits {{computed::hitlocation}} for {{computed::damage}}<br>
      {{#rollTotal() computed::hascritical0 1}}
      Critical Roll {{computed::critical}}<br>
	<i>{{computed::critdescription0}}</i><br>
	{{computed::criteffect0}}<br>
      {{/rollTotal() computed::hascritical0 1}}
      {{#rollTotal() computed::hascritical1 1}}
	<i>{{computed::critdescription1}}</i><br>
	{{computed::criteffect1}}<br>
      {{/rollTotal() computed::hascritical1 1}}
      {{#rollTotal() computed::hascritical2 1}}
	<i>{{computed::critdescription2}}</i><br>
	{{computed::criteffect2}}<br>
      {{/rollTotal() computed::hascritical2 1}}

      {{#rollTotal() computed::hascritical3 1}}
	<i>{{computed::critdescription3}}</i><br>
	{{computed::criteffect3}}<br>
      {{/rollTotal() computed::hascritical3 1}}

      {{#rollTotal() computed::hascritical4 1}}
	<i>{{computed::critdescription4}}</i><br>
	{{computed::criteffect4}}<br>
      {{/rollTotal() computed::hascritical4 1}}

      {{#rollTotal() computed::hascritical5 1}}
	<i>{{computed::critdescription5}}</i><br>
	{{computed::criteffect5}}<br>
      {{/rollTotal() computed::hascritical5 1}}

      [Apply](~{{targetescaped}}|applyattackresult||{{computed::injurystring}})
    {{/rollTotal() computed::ishit 1}}
  </div>

</rolltemplate>

<!-- AP Message to the chat.  Via evil hackery
  Parms are 'who', ap (number of AP spent now), on what action
-->
<rolltemplate class="sheet-rolltemplate-rmuactionmsg">
  <div class='sheet-rolltemplate-rmumsg'>
    <i>{{who}}</i> spends {{ap}}&nbsp;AP on {{computed::action}}
      [End Turn](~{{computed::whoescaped}}|endturn||)
  </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-rmuactionload">
  <div class='sheet-rolltemplate-rmumsg'>
    <i>{{who}}</i> loads their weapon.
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmuactionunload">
  <div class='sheet-rolltemplate-rmumsg'>
    <i>{{who}}</i> weapon is no longer loaded.
  </div>
</rolltemplate>

<!-- Message for selecting a taget.
  Params we care about are:
    who
    targetname
-->
<rolltemplate class="sheet-rolltemplate-rmuattacktarget">
  <div class='sheet-rolltemplate-rmumsg'>
    <i>{{who}}</i> is now targetting <i>{{computed::targetname}}</i>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmutrackeradd">
  <div class='sheet-rolltemplate-rmumsg'>
    <i>{{whom}}</i> added to template.
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmuendurance">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-noboxes'>
    <i>{{name}}</i> rolls {{computed::firstroll}} {{computed::secondroll}}
    <br>
    <i>{{computed::message}}</i>
    {{#rollTotal() computed::hashitupdate 1}}
      <br>{{computed::hitupdate}}
    {{/rollTotal() computed::hashitupdate 1}}
    {{#rollTotal() computed::hasfatigueupdate 1}}
      <br>{{computed::fatigueupdate}}
    {{/rollTotal() computed::hasfatigueupdate 1}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmurr">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} rolled an {{computed::firstroll}} = {{computed::message}} for a {{type}} RR.
  </div>
</rolltemplate>

<!-- Simple Roll a critical result:
<-->
<rolltemplate class="sheet-rolltemplate-rmucritical">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} rolls a {{computed::degree}} {{computed::type}} critical => {{roll}}
    <br>

    <i>{{computed::critdescription0}}</i> <br>
    {{computed::criteffect0}} <br>
    {{#rollTotal() computed::hascritical1 1}}
      <i>{{computed::critdescription1}}</i><br>
      {{computed::criteffect1}}<br>
    {{/rollTotal() computed::hascritical1 1}}
    {{#rollTotal() computed::hascritical2 1}}
      <i>{{computed::critdescription2}}</i><br>
      {{computed::criteffect2}}<br>
    {{/rollTotal() computed::hascritical2 1}}
    Injury: {{computed::injurystring}}
  </div>
</rolltemplate>

<!-- Simple Lookup a critical result:
<-->
<rolltemplate class="sheet-rolltemplate-rmucriticallookup">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} looks up a {{computed::degree}} {{computed::type}} critical with value {{roll}}
    <br>

    <i>{{computed::critdescription0}}</i> <br>
    {{computed::criteffect0}} <br>
    {{#rollTotal() computed::hascritical1 1}}
      <i>{{computed::critdescription1}}</i><br>
      {{computed::criteffect1}}<br>
    {{/rollTotal() computed::hascritical1 1}}
    {{#rollTotal() computed::hascritical2 1}}
      <i>{{computed::critdescription2}}</i><br>
      {{computed::criteffect2}}<br>
    {{/rollTotal() computed::hascritical2 1}}
    Injury: {{computed::injurystring}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmufumble">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} rolls a {{computed::type}} fumble =&gt; {{computed::roll}}
    <br>

    <i>{{computed::rangemin}} - {{computed::rangemax}} : {{computed::result}}</i> 
  </div>
</rolltemplate>

<!-- Simple Lookup a critical result:
<-->
<rolltemplate class="sheet-rolltemplate-rmufumblelookup">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} looks up a {{computed::type}} fumble with value {{computed::roll}}
    <br>

    <i>{{computed::rangemin}} - {{computed::rangemax}} : {{computed::result}}</i> 
  </div>
</rolltemplate>

<!-- Message for resting/sleeping
  {{who}} {{rests}} for {{period}}
  {{result}}
-->
<rolltemplate class="sheet-rolltemplate-rmurest">
  <div class='sheet-rolltemplate-noboxes'>
    {{who}} {{rests}} for {{period}} {{unit}}.
    <br>
    {{computed::result}}
  </div>
</rolltemplate>


<rolltemplate class="sheet-rolltemplate-rmumessage">
  <div class='sheet-rolltemplate-noboxes'>
    {{computed::message}}
  </div>
</rolltemplate>

<!-- end of turn message -->
<rolltemplate class="sheet-rolltemplate-rmueotmessage">
  <div class='sheet-rolltemplate-noboxes'
       style=" box-shadow: 0px 5px 3px 0px rgba(0,0,0,0.45);">

    {{computed::message}}
  </div>
</rolltemplate>


<!-- Casting a spell
      <who> casts <Spell>
      Modifiers: <mods> = <modlog>
      Result: <total> = <d100> + <mods>
      <result>
      X has pp from pp
    -->
<rolltemplate class="sheet-rolltemplate-rmuspell">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rollattack'>
    {{who}} casts <i>{{computed::spell}}</i><br>
    <b>Result</b>: {{computed::total}} = {{computed::roll}} + {{mod}}<br>
    <p style='padding-left:1em;text-indent:-1em;' class='hangingindent'>
    Modifiers: {{mod}} = {{computed::modlog}}</p>
    {{computed::result}}<br>
    {{who}} now has {{computed::pp}} PP ({{computed::ppmsg}})
  </div>
</rolltemplate>

<!-- Recovery roll -->
<rolltemplate class="sheet-rolltemplate-rmurecovery">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rollattack'>
    {{who}} recovers from injury {{computed::description}}<br>
    <p style='padding-left:1em;text-indent:-1em;' class='hangingindent'>
    Modifiers: {{mod}} = {{computed::modlog}}</p>
    Result: {{computed::total}} = {{computed::roll}} + {{mod}}<br>
    {{computed::result}}<br>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmuskill">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rollattack'>
    {{computed::who}} rolls <i>{{computed::skill}}</i><br>
    <b>Result</b>: {{computed::total}} = {{computed::rollstr}} + {{computed::mod}}<br>
    <p style='padding-left:1em;text-indent:-1em;' class='hangingindent'>
    Modifiers: {{computed::mod}} = {{computed::modlog}}</p>
    <b>{{computed::result}}</b><br>
    {{#rollTotal() computed::hasextra 1}}
    <i>{{computed::extratext}}</i><br>
    {{/rollTotal() computed::hasextra 1}}
    {{computed::description}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rmustatroll">
  <div class='sheet-rolltemplate-rmurollbox sheet-rolltemplate-rollattack'>
    Stat roll! {{computed::powerlevel}}
    <div class='statroll'>
      <span>Stat</span><span>Pot</span><span>Temp</span><span>Spare</span>
      <span>Agility</span><span>{{computed::agilitypot}}</span><span>{{computed::agilitytemp}}</span>
		<span>{{computed::agilityspare}}</span>
      <span>Constitution</span><span>{{computed::constitutionpot}}</span><span>{{computed::constitutiontemp}}</span>
		<span>{{computed::constitutionspare}}</span>
      <span>Empathy</span><span>{{computed::empathypot}}</span><span>{{computed::empathytemp}}</span>
		<span>{{computed::empathyspare}}</span>
      <span>Intuition</span><span>{{computed::intuitionpot}}</span><span>{{computed::intuitiontemp}}</span>
		<span>{{computed::intuitionspare}}</span>
      <span>Memory</span><span>{{computed::memorypot}}</span><span>{{computed::memorytemp}}</span>
		<span>{{computed::memoryspare}}</span>
      <span>Presence</span><span>{{computed::presencepot}}</span><span>{{computed::presencetemp}}</span>
		<span>{{computed::presencespare}}</span>
      <span>Quickness</span><span>{{computed::quicknesspot}}</span><span>{{computed::quicknesstemp}}</span>
		<span>{{computed::quicknessspare}}</span>
      <span>Reasoning</span><span>{{computed::reasoningpot}}</span><span>{{computed::reasoningtemp}}</span>
		<span>{{computed::reasoningspare}}</span>
      <span>Self-Discipline</span><span>{{computed::selfdisciplinepot}}</span>
		<span>{{computed::selfdisciplinetemp}}</span>
		<span>{{computed::selfdisciplinespare}}</span>
      <span>Strength</span><span>{{computed::strengthpot}}</span><span>{{computed::strengthtemp}}</span>
		<span>{{computed::strengthspare}}</span>
    </div>
  </div>
</rolltemplate>


<!-- vim: set sw=2 sts=2 :-->





<charmancer class="sheet-charmancer-powerlevel">
<div>
  <h2>Power Level</h2>

<div>

<p>Choose the powerlevel for this character.  If you are not sure check with your GM.  The default level
in the game in "Superior".</p>

<p>Due to the intrusive nature of this change once selected it can't be changed.</p>

    <select name='comp_powerlevel' required="required">
      <option value>...</option>
      <option value='Average'>Average</option>
      <option value='Superior'>Superior</option>
      <option value='Heroic'>Heroic</option>
      <option value='Legendary'>Legendary</option>
      <option value='Epic'>Epic</option>
    </select>

</div>




  <button class="fancybutton" type="submit" value="race">Next (Race &amp; Culture)</button>
</div>
</charmancer>

<charmancer class="sheet-charmancer-race">
<div>
  <h2>Race and Culture</h2>

<div>

<div class='two-even-columns'>
  <div>
    <span class='fancytext'>Race</span>

    <select name='comp_race' required="required">
      <option value>Select...</option>
      <option value='custom~custom'>Custom</option>
    </select>

    <hr>

    <span class='fancytext'>Culture</span>

    <select name='comp_culture' required='required'>
      <option value>Select...</option>
    </select>

    <hr>

    <span class='fancytext'>Gender</span>

    <select name='comp_gender' required='required'>
      <option value>Select...</option>
      <option value="M">Male</option>
      <option value="F">Female</option>
    </select>
  </div>
  <div class='cm_info'>
    <div class="compendium-page race-info" accept='Rules:Race'></div>
  </div>

  <div class='choice custom-race-upload'>
    <textarea name='comp_customraceuploaddata'></textarea>
    <button type='action' name='act_uploadrace' class='fancybutton'>Upload</button>
    Message: <span class='uploadracemessage'></span>

    <p>Format for custom races is a JSON file, as documented 
      <a href='https://github.com/nashidau/RMU-Interchange/blob/main/Race.md'
	target='_blank'>https://github.com/nashidau/RMU-Interchange/blob/main/Race.md</a>
    </p>
  </div>

  <div style='display:none'>
    <input type='text' name='comp_customrace'>
  </div>

</div>

</div>



  <span class="choice race-no-save">
    <button class="fancybutton disabled" type="action" value="noaction">Next (Profession)</button>
  </span>
  <span class="choice race-save">
    <button class="fancybutton" type="submit" value="profession">Next (Profession)</button>
  </span>

</div>
</charmancer>

<charmancer class="sheet-charmancer-profession">
  <div>
    <div>
  <h2>Profession</h2>

  <span class='fancytext'>Profession</span>

  <select name="comp_profession" required="required">
      <option value>Select...</option>
      <option value='custom~custom'>Custom</option>
  </select>

  <div class='choice custom-profession-upload'>
    <textarea name='comp_customprofessionuploaddata'></textarea>
    <button type='action' name='act_uploadprofession' class='fancybutton'>Upload</button>
    Message: <span class='uploadprofessionmessage'></span>

    <p>Format for custom professions is a JSON file, as documented 
      <a href='https://github.com/nashidau/RMU-Interchange/blob/main/Profession.md'
	target='_blank'>https://github.com/nashidau/RMU-Interchange/blob/main/Profession.md</a>
    </p>
  </div>

  <hr>

</div>


    <button class="fancybutton" type="back" value="race">Back (Race &amp; Culture)</button>
    <span class="choice profession-no-save">
      <button class="fancybutton disabled" type="action" value="noaction">Next (Realm)</button>
    </span>
    <span class="choice profession-save">
      <button class="fancybutton" type="submit" value="realm">Next (Realm)</button>
    </span>
  </div>
</charmancer>

<charmancer class="sheet-charmancer-realm">
  <div>
    <div>
  <h2>Realm</h2>

  <div class="choice create-profession-realm-choose">
    <select name="comp_realm">
      <option value="essence">Essence</option>
      <option value="channeling">Channeling</option>
      <option value="mentalism">Mentalism</option>
    </select>
  </div>
  <div class="choice create-profession-realm-selected">
    <span class="create-profession-realm-realm">The Realm</span>
  </div>

</div>


    <button class="fancybutton" type="back" value="profession">Back (Profession)</button>
    <button class="fancybutton" type="submit" value="baselists">Next (Baselists)</button>
  </div>
</charmancer>

<charmancer class="sheet-charmancer-baselists">
<div>
<h2>Base Lists</h2>





<div class='cmbaselistlists choice'>
  <div class='cmbaselist0show choice'><span><input name='comp_cmbaselistselected0' id='cmbaselistselected0' type='checkbox' ></span><label for='cmbaselistselected0' class='inline' style='padding-left: 1em'><span class='cmbaselist0name'></span></label><input type='hidden' name='comp_cmbaselistname0'></div><div class='cmbaselist1show choice'><span><input name='comp_cmbaselistselected1' id='cmbaselistselected1' type='checkbox' ></span><label for='cmbaselistselected1' class='inline' style='padding-left: 1em'><span class='cmbaselist1name'></span></label><input type='hidden' name='comp_cmbaselistname1'></div><div class='cmbaselist2show choice'><span><input name='comp_cmbaselistselected2' id='cmbaselistselected2' type='checkbox' ></span><label for='cmbaselistselected2' class='inline' style='padding-left: 1em'><span class='cmbaselist2name'></span></label><input type='hidden' name='comp_cmbaselistname2'></div><div class='cmbaselist3show choice'><span><input name='comp_cmbaselistselected3' id='cmbaselistselected3' type='checkbox' ></span><label for='cmbaselistselected3' class='inline' style='padding-left: 1em'><span class='cmbaselist3name'></span></label><input type='hidden' name='comp_cmbaselistname3'></div><div class='cmbaselist4show choice'><span><input name='comp_cmbaselistselected4' id='cmbaselistselected4' type='checkbox' ></span><label for='cmbaselistselected4' class='inline' style='padding-left: 1em'><span class='cmbaselist4name'></span></label><input type='hidden' name='comp_cmbaselistname4'></div><div class='cmbaselist5show choice'><span><input name='comp_cmbaselistselected5' id='cmbaselistselected5' type='checkbox' ></span><label for='cmbaselistselected5' class='inline' style='padding-left: 1em'><span class='cmbaselist5name'></span></label><input type='hidden' name='comp_cmbaselistname5'></div><div class='cmbaselist6show choice'><span><input name='comp_cmbaselistselected6' id='cmbaselistselected6' type='checkbox' ></span><label for='cmbaselistselected6' class='inline' style='padding-left: 1em'><span class='cmbaselist6name'></span></label><input type='hidden' name='comp_cmbaselistname6'></div><div class='cmbaselist7show choice'><span><input name='comp_cmbaselistselected7' id='cmbaselistselected7' type='checkbox' ></span><label for='cmbaselistselected7' class='inline' style='padding-left: 1em'><span class='cmbaselist7name'></span></label><input type='hidden' name='comp_cmbaselistname7'></div><div class='cmbaselist8show choice'><span><input name='comp_cmbaselistselected8' id='cmbaselistselected8' type='checkbox' ></span><label for='cmbaselistselected8' class='inline' style='padding-left: 1em'><span class='cmbaselist8name'></span></label><input type='hidden' name='comp_cmbaselistname8'></div><div class='cmbaselist9show choice'><span><input name='comp_cmbaselistselected9' id='cmbaselistselected9' type='checkbox' ></span><label for='cmbaselistselected9' class='inline' style='padding-left: 1em'><span class='cmbaselist9name'></span></label><input type='hidden' name='comp_cmbaselistname9'></div><div class='cmbaselist10show choice'><span><input name='comp_cmbaselistselected10' id='cmbaselistselected10' type='checkbox' ></span><label for='cmbaselistselected10' class='inline' style='padding-left: 1em'><span class='cmbaselist10name'></span></label><input type='hidden' name='comp_cmbaselistname10'></div><div class='cmbaselist11show choice'><span><input name='comp_cmbaselistselected11' id='cmbaselistselected11' type='checkbox' ></span><label for='cmbaselistselected11' class='inline' style='padding-left: 1em'><span class='cmbaselist11name'></span></label><input type='hidden' name='comp_cmbaselistname11'></div><div class='cmbaselist12show choice'><span><input name='comp_cmbaselistselected12' id='cmbaselistselected12' type='checkbox' ></span><label for='cmbaselistselected12' class='inline' style='padding-left: 1em'><span class='cmbaselist12name'></span></label><input type='hidden' name='comp_cmbaselistname12'></div><div class='cmbaselist13show choice'><span><input name='comp_cmbaselistselected13' id='cmbaselistselected13' type='checkbox' ></span><label for='cmbaselistselected13' class='inline' style='padding-left: 1em'><span class='cmbaselist13name'></span></label><input type='hidden' name='comp_cmbaselistname13'></div><div class='cmbaselist14show choice'><span><input name='comp_cmbaselistselected14' id='cmbaselistselected14' type='checkbox' ></span><label for='cmbaselistselected14' class='inline' style='padding-left: 1em'><span class='cmbaselist14name'></span></label><input type='hidden' name='comp_cmbaselistname14'></div><div class='cmbaselist15show choice'><span><input name='comp_cmbaselistselected15' id='cmbaselistselected15' type='checkbox' ></span><label for='cmbaselistselected15' class='inline' style='padding-left: 1em'><span class='cmbaselist15name'></span></label><input type='hidden' name='comp_cmbaselistname15'></div><div class='cmbaselist16show choice'><span><input name='comp_cmbaselistselected16' id='cmbaselistselected16' type='checkbox' ></span><label for='cmbaselistselected16' class='inline' style='padding-left: 1em'><span class='cmbaselist16name'></span></label><input type='hidden' name='comp_cmbaselistname16'></div><div class='cmbaselist17show choice'><span><input name='comp_cmbaselistselected17' id='cmbaselistselected17' type='checkbox' ></span><label for='cmbaselistselected17' class='inline' style='padding-left: 1em'><span class='cmbaselist17name'></span></label><input type='hidden' name='comp_cmbaselistname17'></div><div class='cmbaselist18show choice'><span><input name='comp_cmbaselistselected18' id='cmbaselistselected18' type='checkbox' ></span><label for='cmbaselistselected18' class='inline' style='padding-left: 1em'><span class='cmbaselist18name'></span></label><input type='hidden' name='comp_cmbaselistname18'></div><div class='cmbaselist19show choice'><span><input name='comp_cmbaselistselected19' id='cmbaselistselected19' type='checkbox' ></span><label for='cmbaselistselected19' class='inline' style='padding-left: 1em'><span class='cmbaselist19name'></span></label><input type='hidden' name='comp_cmbaselistname19'></div><div class='cmbaselist20show choice'><span><input name='comp_cmbaselistselected20' id='cmbaselistselected20' type='checkbox' ></span><label for='cmbaselistselected20' class='inline' style='padding-left: 1em'><span class='cmbaselist20name'></span></label><input type='hidden' name='comp_cmbaselistname20'></div>

Lists Selected <input type='number' name='comp_cmbaselistcount'> / 6

</div>

<div class='cmbaselistfixed choice'>
  Your chosen profession has six base lists.<br>
  
  <span class='cmbaselist0show choice'><span class='cmbaselist0name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname0'></span><span class='cmbaselist1show choice'><span class='cmbaselist1name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname1'></span><span class='cmbaselist2show choice'><span class='cmbaselist2name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname2'></span><span class='cmbaselist3show choice'><span class='cmbaselist3name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname3'></span><span class='cmbaselist4show choice'><span class='cmbaselist4name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname4'></span><span class='cmbaselist5show choice'><span class='cmbaselist5name'>List Name</span><br><input type='hidden' name='comp_cmbaselistname5'></span>

</div>



<div class='cmbaselistsnolists choice'>
  Your chosen profession has no base lists.
</div>
  


<button class="fancybutton" type="back" value="profession">Back (Profession)</button>
<span class="choice baselistnosave">
  <button class="fancybutton disabled " type="action" value="noaction">Next (Stats)</button>
</span>
<span class="choice baselistsave">
  <button class="fancybutton " type="action" name="act_baselistsdone">Next (Stats)</button>
</span>
<span class="choice baselistsalwaysallow">
  <button class="fancybutton " type="submit" value="stats">Next (Stats)</button>
</span>
</div>
</charmancer>

<charmancer class="sheet-charmancer-stats">
<div>

<h2>Statistics</h2>

<button type="action" class='fancybutton' name="act_rollstats">Roll Stats</button>
<input type='hidden' name="comp_rollstatcount">

<div class='two-even-columns'>
<div>
    <div class='create_stat'>
      <span class='stat_names'>
	<span class='stat_name' data-i18n='Stat Name'><b>Stat Name</b></span>
	<span class='stat_abbr' data-i18n='Abbr'><b>Abbr</b></span>
      </span>
      <span class='stat_value_potential'><b>Pot</b></span>
      <span class='stat_value_temporary'><b>Temp</b></span>
      <span class='stat_value_spare'><b>Spare</b></span>
    </div>
    <div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='agility'>agility</span> <span class='stat_abbr' data-i18n='ag'>ag</span></span>
 <input name='comp_stat_agility_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_agility' class='cm_small_number' readonly> <input name='comp_stat_agility_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='constitution'>constitution</span> <span class='stat_abbr' data-i18n='co'>co</span></span>
 <input name='comp_stat_constitution_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_constitution' class='cm_small_number' readonly> <input name='comp_stat_constitution_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='empathy'>empathy</span> <span class='stat_abbr' data-i18n='em'>em</span></span>
 <input name='comp_stat_empathy_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_empathy' class='cm_small_number' readonly> <input name='comp_stat_empathy_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='intuition'>intuition</span> <span class='stat_abbr' data-i18n='in'>in</span></span>
 <input name='comp_stat_intuition_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_intuition' class='cm_small_number' readonly> <input name='comp_stat_intuition_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='memory'>memory</span> <span class='stat_abbr' data-i18n='me'>me</span></span>
 <input name='comp_stat_memory_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_memory' class='cm_small_number' readonly> <input name='comp_stat_memory_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='presence'>presence</span> <span class='stat_abbr' data-i18n='pr'>pr</span></span>
 <input name='comp_stat_presence_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_presence' class='cm_small_number' readonly> <input name='comp_stat_presence_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='quickness'>quickness</span> <span class='stat_abbr' data-i18n='qu'>qu</span></span>
 <input name='comp_stat_quickness_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_quickness' class='cm_small_number' readonly> <input name='comp_stat_quickness_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='reasoning'>reasoning</span> <span class='stat_abbr' data-i18n='re'>re</span></span>
 <input name='comp_stat_reasoning_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_reasoning' class='cm_small_number' readonly> <input name='comp_stat_reasoning_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='selfdiscipline'>selfdiscipline</span> <span class='stat_abbr' data-i18n='sd'>sd</span></span>
 <input name='comp_stat_selfdiscipline_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_selfdiscipline' class='cm_small_number' readonly> <input name='comp_stat_selfdiscipline_value_spare' class='cm_small_number' readonly></div>
<div class='create_stat'>
<span class='stat_names'> <span class='stat_name' data-i18n='strength'>strength</span> <span class='stat_abbr' data-i18n='st'>st</span></span>
 <input name='comp_stat_strength_potential' class='stat_value_potential cm_small_number' readonly> <input name='comp_stat_strength' class='cm_small_number' readonly> <input name='comp_stat_strength_value_spare' class='cm_small_number' readonly></div>

</div>
<div>

<h3>Option 1</h3>
  <select name='comp_cmstatoption_1' class='smallselect' required>
    <option value=''>Select...</option>
    <option value='raiseaverage'>Raise to Average</option>
    <option value='raise90'>Raise to 90</option>
    <option value='raise85'>Raise to 85</option>
    <option value='statgain'>Two stat gain rolls</option>
  </select>

  <div class='choice stats_option_raiseaverage_1'>
    Raise <select name='comp_statraise1' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
 to average
  </div>
 <div class='choice stats_option_raise90_1'>
      <div class='choice stats_option_raise90_single'>
	Set
	<span class='stats_option_raise90_statname'></span> to 90
      </div>
      <div class='choice stats_option_raise90_many'>
	Set
	<select name='comp_stats_raise90_many_list_1'
	    class='stats_option_raise90_many_list smallselect'></select>
	to 90
      </div>
  </div>
 <div class='choice stats_option_raise85_1'>
      <div class='choice stats_option_raise85_single'>
	Set <span class='stats_option_raise85_statname'></span> to 85.
      </div>
      <div class='choice stats_option_raise85_many'>
	Set
	<select name='comp_stats_raise85_many_list_1'
	    class='stats_option_raise85_many_list smallselect'></select>
	to 85.
      </div>
  </div>
 <div class='choice stats_option_statgain_1'>
    Two statgains.

      <select name='comp_statgain1a' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>


      <select name='comp_statgain1b' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>

  </div>


<h3>Option 2</h3>
  <select name='comp_cmstatoption_2' class='smallselect' required>
    <option value=''>Select...</option>
    <option value='raiseaverage'>Raise to Average</option>
    <option value='raise90'>Raise to 90</option>
    <option value='raise85'>Raise to 85</option>
    <option value='statgain'>Two stat gain rolls</option>
  </select>



  <div class='choice stats_option_raiseaverage_2'>
    Raise <select name='comp_statraise2' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
 to average
  </div>
 <div class='choice stats_option_raise90_2'>
      <div class='choice stats_option_raise90_single'>
	Set <span class='stats_option_raise90_statname'></span> to 90
      </div>
      <div class='choice stats_option_raise90_many'>
	Set <select name='comp_stats_raise90_many_list_2' required
	  class='stats_option_raise90_many_list smallselect'></select> to 90
      </div>
  </div>
 <div class='choice stats_option_raise85_2'>
      <div class='choice stats_option_raise85_single'>
	Set <span class='stats_option_raise85_statname'></span> to 85
      </div>
      <div class='choice stats_option_raise85_many'>
	Set <select name='comp_stats_raise85_many_list_2' required
	class='stats_option_raise85_many_list smallselect'></select> to 85
      </div>
  </div>
 <div class='choice stats_option_statgain_2'>
    Two statgains.
      <select name='comp_statgain2a' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>

      <select name='comp_statgain2b' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>

  </div>

<h3>Swap Stats</h3>

<em>Swap One</em> Swap
  <select name='comp_swapa1' class='smallselect' required><option value=''>Select...</option>
<option value='No swap~none'>No swap</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
 
  <span class='choice stats_show_statswap1'>
    &amp;
    <select name='comp_swapa2' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
.
  </span>
<br>
<em>Swap Two</em> Swap
  <select name='comp_swapb1' class='smallselect' required><option value=''>Select...</option>
<option value='No swap~none'>No swap</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
 
  <span class='choice stats_show_statswap2'>
    &amp;
    <select name='comp_swapb2' class='smallselect' required><option value=''>Select...</option>
<option value='Agility~agility'>Agility</option>
<option value='Constitution~constitution'>Constitution</option>
<option value='Empathy~empathy'>Empathy</option>
<option value='Intuition~intuition'>Intuition</option>
<option value='Memory~memory'>Memory</option>
<option value='Presence~presence'>Presence</option>
<option value='Quickness~quickness'>Quickness</option>
<option value='Reasoning~reasoning'>Reasoning</option>
<option value='Self Discipline~selfdiscipline'>Self Discipline</option>
<option value='Strength~strength'>Strength</option>
</select>
.
  </span>



</div>
</div> <!-- columns -->





<button class="fancybutton" type="back" value="baselists">Back (Baselists)</button>
<button class="fancybutton" type="submit" value="knacks">Next (Knacks)</button>
</div>
</charmancer>

<charmancer class="sheet-charmancer-knacks">
<div>
<section id='knacks' class='tab-panel'>

  <div class='two-even-columns'>
	  <div>
	  <h2>Professional Skills</h2>
      <div class='profession_skill_group'>
     <select name='comp_knack_select_0' class='knack_select_0'>
     </select>
    <input type='checkbox' id='pbonus_select_0' name='comp_pbonus_select_0'>
    <label for='pbonus_select_0' class='plainlabel'><span class='pbonus_name_0'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_1' class='knack_select_1'>
     </select>
    <input type='checkbox' id='pbonus_select_1' name='comp_pbonus_select_1'>
    <label for='pbonus_select_1' class='plainlabel'><span class='pbonus_name_1'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_2' class='knack_select_2'>
     </select>
    <input type='checkbox' id='pbonus_select_2' name='comp_pbonus_select_2'>
    <label for='pbonus_select_2' class='plainlabel'><span class='pbonus_name_2'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_3' class='knack_select_3'>
     </select>
    <input type='checkbox' id='pbonus_select_3' name='comp_pbonus_select_3'>
    <label for='pbonus_select_3' class='plainlabel'><span class='pbonus_name_3'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_4' class='knack_select_4'>
     </select>
    <input type='checkbox' id='pbonus_select_4' name='comp_pbonus_select_4'>
    <label for='pbonus_select_4' class='plainlabel'><span class='pbonus_name_4'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_5' class='knack_select_5'>
     </select>
    <input type='checkbox' id='pbonus_select_5' name='comp_pbonus_select_5'>
    <label for='pbonus_select_5' class='plainlabel'><span class='pbonus_name_5'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_6' class='knack_select_6'>
     </select>
    <input type='checkbox' id='pbonus_select_6' name='comp_pbonus_select_6'>
    <label for='pbonus_select_6' class='plainlabel'><span class='pbonus_name_6'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_7' class='knack_select_7'>
     </select>
    <input type='checkbox' id='pbonus_select_7' name='comp_pbonus_select_7'>
    <label for='pbonus_select_7' class='plainlabel'><span class='pbonus_name_7'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_8' class='knack_select_8'>
     </select>
    <input type='checkbox' id='pbonus_select_8' name='comp_pbonus_select_8'>
    <label for='pbonus_select_8' class='plainlabel'><span class='pbonus_name_8'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_9' class='knack_select_9'>
     </select>
    <input type='checkbox' id='pbonus_select_9' name='comp_pbonus_select_9'>
    <label for='pbonus_select_9' class='plainlabel'><span class='pbonus_name_9'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_10' class='knack_select_10'>
     </select>
    <input type='checkbox' id='pbonus_select_10' name='comp_pbonus_select_10'>
    <label for='pbonus_select_10' class='plainlabel'><span class='pbonus_name_10'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_11' class='knack_select_11'>
     </select>
    <input type='checkbox' id='pbonus_select_11' name='comp_pbonus_select_11'>
    <label for='pbonus_select_11' class='plainlabel'><span class='pbonus_name_11'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_12' class='knack_select_12'>
     </select>
    <input type='checkbox' id='pbonus_select_12' name='comp_pbonus_select_12'>
    <label for='pbonus_select_12' class='plainlabel'><span class='pbonus_name_12'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_13' class='knack_select_13'>
     </select>
    <input type='checkbox' id='pbonus_select_13' name='comp_pbonus_select_13'>
    <label for='pbonus_select_13' class='plainlabel'><span class='pbonus_name_13'></span></label>
  </div>
  <div class='profession_skill_group'>
     <select name='comp_knack_select_14' class='knack_select_14'>
     </select>
    <input type='checkbox' id='pbonus_select_14' name='comp_pbonus_select_14'>
    <label for='pbonus_select_14' class='plainlabel'><span class='pbonus_name_14'></span></label>
  </div>


	Knack Total: <span class='create_knack_total'>?</span>/
	  <span class='create_knack_powerlevel_total'></span><br>
	Professions bonuses: <span class='create_pbonus_total'>?</span>/10<br>

	</div>
	<div>

	<h2>Weapon Skills</h2>
	<div class='prop_pair'>
	<span class='fancytext'>Primary</span>
	  <select name='comp_primary_weapon_select' data-i18n-dynamic>
	      <option value='~meleeweaponsgroup' selected>Melee Weapons</option>
	      <option value='~rangedweaponsgroup'>Ranged Weapons</option>
	      <option value='~unarmedgroup'>Unarmed</option>
	      <option value='~shieldgroup'>Shields</option>
	  </select>
	</div>
	<div class='prop_pair'>
	<span class='fancytext'>Secondary</span>
	  <select name='comp_secondary_weapon_select' class='secondary_weapon_select'
	  data-i18n-dynamic>

	  </select>
	</div>
	<div class='prop_pair'>
	<span class='fancytext'>Tertiary</span>
	  <select name='comp_tertiary_weapon_select' class='tertiary_weapon_select'
	  data-i18n-dynamic>
	  </select>
	</div>
	<div class='prop_pair'>

	<span class='fancytext'>Quaternary</span>
	  <span class='quaternary_weapon_display' data-i18n-dynamic>Shields</span>
	</div>

	</div>
	</div> 

	</section>




<button class="fancybutton" type="back" value="stats">Back (Stats)</button>
<span class="choice knacknosave">
  <button class="fancybutton disabled" type="submit" value="culture">Next (Culture Ranks)</button>
</span>
<span class="choice knacksave">
  <button class="fancybutton" type="submit" value="culture">Next (Culture Ranks)</button>
</span>
</div>
</charmancer>

<charmancer class="sheet-charmancer-culture">
<div>
<h2>Culture Ranks</h2>



    <div class='choice create_culture_animalhandling_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='animalhandling'>X</span><input name='comp_animalhandling_name' ></span><span class='prop_value culture_select_group create_culture_animalhandling_ranks'></span></div></div>

    <div class='choice create_culture_riding_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='riding'>X</span><input name='comp_riding_name' ></span><span class='prop_value culture_select_group create_culture_riding_ranks'></span></div></div>

    <div class='choice create_culture_perception_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='perception'>To translatte</span><span class='prop_value culture_select_group create_culture_perception_ranks'></span></div></div>

    <div class='choice create_culture_tracking_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='tracking'>To translatte</span><span class='prop_value culture_select_group create_culture_tracking_ranks'></span></div></div>

    <div class='choice create_culture_maneuveringinarmor_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='maneuveringinarmor'>To translatte</span><span class='prop_value culture_select_group create_culture_maneuveringinarmor_ranks'></span></div></div>

    <div class='choice create_culture_bodydevelopment_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='bodydevelopment'>To translatte</span><span class='prop_value culture_select_group create_culture_bodydevelopment_ranks'></span></div></div>

    <div class='choice create_culture_weighttraining_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='weighttraining'>To translatte</span><span class='prop_value culture_select_group create_culture_weighttraining_ranks'></span></div></div>

    <div class='choice create_culture_attunement_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='attunement'>To translatte</span><span class='prop_value culture_select_group create_culture_attunement_ranks'></span></div></div>

    <div class='choice create_culture_unarmed_show'><div class='prop_pair'><select name='comp_create_cultureunarmed_select' class='create_cultureunarmed culture_select_group prop_prop'><option value='strikes' data-i18n='strikes'>Strikes</option><option value='sweepsthrows' data-i18n='sweepsthrows'>Sweeps & Throws</option><option value='wrestling' data-i18n='wrestling'>Wrestling</option><option value='beak' data-i18n='beak'>Beak</option><option value='bite' data-i18n='bite'>Bite</option><option value='claw' data-i18n='claw'>Claw</option><option value='horn' data-i18n='horn'>Horn</option><option value='ram' data-i18n='ram'>Ram</option><option value='stinger' data-i18n='stinger'>Stinger</option><option value='trample' data-i18n='trample'>Trample</option></select>
<span class='culture_select_group prop_value create_culture_unarmed_ranks'></span></div></div>

    <div class='choice create_culture_meleeweapons_show'><div class='prop_pair'><select name='comp_create_culturemeleeweapons_select' class='create_culturemeleeweapons culture_select_group prop_prop'><option value='blade' data-i18n='blade'>Blade</option><option value='chain' data-i18n='chain'>Chain</option><option value='hafted' data-i18n='hafted'>Hafted</option><option value='greaterblade' data-i18n='greaterblade'>Greater Blade</option><option value='greaterchain' data-i18n='greaterchain'>Greater Chain</option><option value='greaterhafter' data-i18n='greaterhafter'>Greater Hafted</option><option value='polearm' data-i18n='polearm'>Pole Arm</option><option value='meleeexotic' data-i18n='meleeexotic'>Exotic</option></select>
<span class='culture_select_group prop_value create_culture_meleeweapons_ranks'></span></div></div>

    <div class='choice create_culture_rangedweapons_show'><div class='prop_pair'><select name='comp_create_culturerangedweapons_select' class='create_culturerangedweapons culture_select_group prop_prop'><option value='bow' data-i18n='bow'>Bow</option><option value='crossbow' data-i18n='crossbow'>Crossbow</option><option value='sling' data-i18n='sling'>Sling</option><option value='thrown' data-i18n='thrown'>Thrown</option><option value='rangedexotic' data-i18n='rangedexotic'>Exotic</option></select>
<span class='culture_select_group prop_value create_culture_rangedweapons_ranks'></span></div></div>

    <div class='choice create_culture_compositionperf1_show'><div class='prop_pair'><select name='comp_create_culture_compositionperf1' class='culture_select_group prop_prop'><option value='illusioncrafting' data-i18n='illusioncrafting'>Illusion Crafting</option><option value='musicalcomposition' data-i18n='musicalcomposition'>Musical Composition</option><option value='writing' data-i18n='writing'>Writing</option><option value='acting' data-i18n='acting'>Acting</option><option value='music' data-i18n='music'>Music</option><option value='stagemagic' data-i18n='stagemagic'>Stage Magic</option></select>
<span class='culture_select_group prop_value create_culture_compositionperf1_ranks'></span><input name='comp_compositionperf1_name' class='choice create_culture_compositionperf1_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_compositionperf2_show'><div class='prop_pair'><select name='comp_create_culture_compositionperf2' class='culture_select_group prop_prop'><option value='illusioncrafting' data-i18n='illusioncrafting'>Illusion Crafting</option><option value='musicalcomposition' data-i18n='musicalcomposition'>Musical Composition</option><option value='writing' data-i18n='writing'>Writing</option><option value='acting' data-i18n='acting'>Acting</option><option value='music' data-i18n='music'>Music</option><option value='stagemagic' data-i18n='stagemagic'>Stage Magic</option></select>
<span class='culture_select_group prop_value create_culture_compositionperf2_ranks'></span><input name='comp_compositionperf2_name' class='choice create_culture_compositionperf2_spec_show' value='Specialisation'></div></div>


    <div class='choice create_culture_craftingvocation1_show'><div class='prop_pair'><select name='comp_create_culture_craftingvocation1' class='culture_select_group prop_prop'><option value='culinary' data-i18n='culinary'>Culinary</option><option value='drawingpainting' data-i18n='drawingpainting'>Drawing/Painting</option><option value='fabriccraft' data-i18n='fabriccraft'>Fabric Craft</option><option value='leathercraft' data-i18n='leathercraft'>Leathercraft</option><option value='metalcraft' data-i18n='metalcraft'>Metalcraft</option><option value='stonecraft' data-i18n='stonecraft'>Stonecraft</option><option value='woodcraft' data-i18n='woodcraft'>Woodcraft</option><option value='administration' data-i18n='administration'>Administration</option><option value='service' data-i18n='service'>Service</option><option value='trade' data-i18n='trade'>Trade</option></select>
<span class='culture_select_group prop_value create_culture_craftingvocation1_ranks'></span><input name='comp_craftingvocation1_name' class='choice create_culture_craftingvocation1_spec_show' value='Specialisation'></div></div>
<div class='choice create_culture_craftingvocation2_show'><div class='prop_pair'><select name='comp_create_culture_craftingvocation2' class='culture_select_group prop_prop'><option value='culinary' data-i18n='culinary'>Culinary</option><option value='drawingpainting' data-i18n='drawingpainting'>Drawing/Painting</option><option value='fabriccraft' data-i18n='fabriccraft'>Fabric Craft</option><option value='leathercraft' data-i18n='leathercraft'>Leathercraft</option><option value='metalcraft' data-i18n='metalcraft'>Metalcraft</option><option value='stonecraft' data-i18n='stonecraft'>Stonecraft</option><option value='woodcraft' data-i18n='woodcraft'>Woodcraft</option><option value='administration' data-i18n='administration'>Administration</option><option value='service' data-i18n='service'>Service</option><option value='trade' data-i18n='trade'>Trade</option></select>
<span class='culture_select_group prop_value create_culture_craftingvocation2_ranks'></span><input name='comp_craftingvocation2_name' class='choice create_culture_craftingvocation2_spec_show' value='Specialisation'></div></div>
<div class='choice create_culture_craftingvocation3_show'><div class='prop_pair'><select name='comp_create_culture_craftingvocation3' class='culture_select_group prop_prop'><option value='culinary' data-i18n='culinary'>Culinary</option><option value='drawingpainting' data-i18n='drawingpainting'>Drawing/Painting</option><option value='fabriccraft' data-i18n='fabriccraft'>Fabric Craft</option><option value='leathercraft' data-i18n='leathercraft'>Leathercraft</option><option value='metalcraft' data-i18n='metalcraft'>Metalcraft</option><option value='stonecraft' data-i18n='stonecraft'>Stonecraft</option><option value='woodcraft' data-i18n='woodcraft'>Woodcraft</option><option value='administration' data-i18n='administration'>Administration</option><option value='service' data-i18n='service'>Service</option><option value='trade' data-i18n='trade'>Trade</option></select>
<span class='culture_select_group prop_value create_culture_craftingvocation3_ranks'></span><input name='comp_craftingvocation3_name' class='choice create_culture_craftingvocation3_spec_show' value='Specialisation'></div></div>
<div class='choice create_culture_craftingvocation4_show'><div class='prop_pair'><select name='comp_create_culture_craftingvocation4' class='culture_select_group prop_prop'><option value='culinary' data-i18n='culinary'>Culinary</option><option value='drawingpainting' data-i18n='drawingpainting'>Drawing/Painting</option><option value='fabriccraft' data-i18n='fabriccraft'>Fabric Craft</option><option value='leathercraft' data-i18n='leathercraft'>Leathercraft</option><option value='metalcraft' data-i18n='metalcraft'>Metalcraft</option><option value='stonecraft' data-i18n='stonecraft'>Stonecraft</option><option value='woodcraft' data-i18n='woodcraft'>Woodcraft</option><option value='administration' data-i18n='administration'>Administration</option><option value='service' data-i18n='service'>Service</option><option value='trade' data-i18n='trade'>Trade</option></select>
<span class='culture_select_group prop_value create_culture_craftingvocation4_ranks'></span><input name='comp_craftingvocation4_name' class='choice create_culture_craftingvocation4_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_navigation_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='navigation'>To translatte</span><span class='prop_value culture_select_group create_culture_navigation_ranks'></span></div></div>

    <div class='choice create_culture_piloting_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='piloting'>X</span><input name='comp_piloting_name' ></span><span class='prop_value culture_select_group create_culture_piloting_ranks'></span></div></div>

    <div class='choice create_culture_survival_show'><div class='prop_pair'><select name='comp_create_culturesurvival_select' class='create_culturesurvival culture_select_group prop_prop'><option value='survivialalpine' data-i18n='survivialalpine'>Alpine (A)</option><option value='survivialoceans' data-i18n='survivialoceans'>Oceans (O)</option><option value='survivialunderground' data-i18n='survivialunderground'>Underground (U)</option><option value='survivialicecaps' data-i18n='survivialicecaps'>Ice Caps (I)</option><option value='survivialtundra' data-i18n='survivialtundra'>Tundra (T)</option><option value='survivialboreal' data-i18n='survivialboreal'>Boreal Forest (B)</option><option value='survivialshrublands' data-i18n='survivialshrublands'>Desert Shrublands (X)</option><option value='survivialprairies' data-i18n='survivialprairies'>Prairies & Steppes (P)</option><option value='survivialtemperate' data-i18n='survivialtemperate'>Temperate Forests (F)</option><option value='survivialhotdeserts' data-i18n='survivialhotdeserts'>Hot Deserts (D)</option><option value='survivialsavannas' data-i18n='survivialsavannas'>Savannas (S)</option><option value='survivialtropical' data-i18n='survivialtropical'>Tropical Forest (J)</option><option value='survivialurban' data-i18n='survivialurban'>Urban (C)</option><option value='survivialxeno' data-i18n='survivialxeno'>Xeno</option></select>
<span class='culture_select_group prop_value create_culture_survival_ranks'></span></div></div>

    <div class='choice create_culture_acrobatics_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='acrobatics'>To translatte</span><span class='prop_value culture_select_group create_culture_acrobatics_ranks'></span></div></div>

    <div class='choice create_culture_jumping_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='jumping'>To translatte</span><span class='prop_value culture_select_group create_culture_jumping_ranks'></span></div></div>

    <div class='choice create_culture_regionown_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='regionown'>X</span><input name='comp_regionown_name' ></span><span class='prop_value culture_select_group create_culture_regionown_ranks'></span></div></div>

    <div class='choice create_culture_regionneighbour_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='regionneighbour'>X</span><input name='comp_regionneighbour_name' ></span><span class='prop_value culture_select_group create_culture_regionneighbour_ranks'></span></div></div>

    <div class='choice create_culture_religionphilosophy_show'><div class='prop_pair'><span class='prop_prop'><span class='culture_select_group' data-i18n='religionphilosophy'>X</span><input name='comp_religionphilosophy_name' ></span><span class='prop_value culture_select_group create_culture_religionphilosophy_ranks'></span></div></div>

    <div class='choice create_culture_lores1_show'><div class='prop_pair'><select name='comp_create_culture_lores1' class='culture_select_group prop_prop'><option value='creatureloreartificial' data-i18n='creatureloreartificial'>Artificial Creature: Creature Lore</option><option value='creatureloredemon' data-i18n='creatureloredemon'>Demon: Creature Lore</option><option value='creatureloredragon' data-i18n='creatureloredragon'>Dragon: Creature Lore</option><option value='creatureloreelemental' data-i18n='creatureloreelemental'>Elemental: Creature Lore</option><option value='creatureloreextraplaner' data-i18n='creatureloreextraplaner'>Extra-planer: Creature Lore</option><option value='creaturelorefaerie' data-i18n='creaturelorefaerie'>Faerie: Creature Lore</option><option value='creatureloreundead' data-i18n='creatureloreundead'>Undead: Creature Lore</option><option value='historiclore' data-i18n='historiclore'>Historic Lore</option><option value='language' data-i18n='language'>Language</option><option value='materialslorebone' data-i18n='materialslorebone'>Bone/Horn: Materials Lore</option><option value='materialslorefabric' data-i18n='materialslorefabric'>Fabrics: Materials Lore</option><option value='materialsloreleather' data-i18n='materialsloreleather'>Leather: Materials Lore</option><option value='materialsloremetal' data-i18n='materialsloremetal'>Metal: Materials Lore</option><option value='materialslorestone' data-i18n='materialslorestone'>Stone: Materials Lore</option><option value='materialslorewood' data-i18n='materialslorewood'>Wood: Materials Lore</option><option value='raciallore' data-i18n='raciallore'>Racial Lore</option><option value='regionlore' data-i18n='regionlore'>Region Lore</option><option value='religionphilosophy' data-i18n='religionphilosophy'>Religion/Philosophy</option><option value='spelllore' data-i18n='spelllore'>Spell Lore</option></select>
<span class='culture_select_group prop_value create_culture_lores1_ranks'></span><input name='comp_lores1_name' class='choice create_culture_lores1_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_lores2_show'><div class='prop_pair'><select name='comp_create_culture_lores2' class='culture_select_group prop_prop'><option value='creatureloreartificial' data-i18n='creatureloreartificial'>Artificial Creature: Creature Lore</option><option value='creatureloredemon' data-i18n='creatureloredemon'>Demon: Creature Lore</option><option value='creatureloredragon' data-i18n='creatureloredragon'>Dragon: Creature Lore</option><option value='creatureloreelemental' data-i18n='creatureloreelemental'>Elemental: Creature Lore</option><option value='creatureloreextraplaner' data-i18n='creatureloreextraplaner'>Extra-planer: Creature Lore</option><option value='creaturelorefaerie' data-i18n='creaturelorefaerie'>Faerie: Creature Lore</option><option value='creatureloreundead' data-i18n='creatureloreundead'>Undead: Creature Lore</option><option value='historiclore' data-i18n='historiclore'>Historic Lore</option><option value='language' data-i18n='language'>Language</option><option value='materialslorebone' data-i18n='materialslorebone'>Bone/Horn: Materials Lore</option><option value='materialslorefabric' data-i18n='materialslorefabric'>Fabrics: Materials Lore</option><option value='materialsloreleather' data-i18n='materialsloreleather'>Leather: Materials Lore</option><option value='materialsloremetal' data-i18n='materialsloremetal'>Metal: Materials Lore</option><option value='materialslorestone' data-i18n='materialslorestone'>Stone: Materials Lore</option><option value='materialslorewood' data-i18n='materialslorewood'>Wood: Materials Lore</option><option value='raciallore' data-i18n='raciallore'>Racial Lore</option><option value='regionlore' data-i18n='regionlore'>Region Lore</option><option value='religionphilosophy' data-i18n='religionphilosophy'>Religion/Philosophy</option><option value='spelllore' data-i18n='spelllore'>Spell Lore</option></select>
<span class='culture_select_group prop_value create_culture_lores2_ranks'></span><input name='comp_lores2_name' class='choice create_culture_lores2_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_lores3_show'><div class='prop_pair'><select name='comp_create_culture_lores3' class='culture_select_group prop_prop'><option value='creatureloreartificial' data-i18n='creatureloreartificial'>Artificial Creature: Creature Lore</option><option value='creatureloredemon' data-i18n='creatureloredemon'>Demon: Creature Lore</option><option value='creatureloredragon' data-i18n='creatureloredragon'>Dragon: Creature Lore</option><option value='creatureloreelemental' data-i18n='creatureloreelemental'>Elemental: Creature Lore</option><option value='creatureloreextraplaner' data-i18n='creatureloreextraplaner'>Extra-planer: Creature Lore</option><option value='creaturelorefaerie' data-i18n='creaturelorefaerie'>Faerie: Creature Lore</option><option value='creatureloreundead' data-i18n='creatureloreundead'>Undead: Creature Lore</option><option value='historiclore' data-i18n='historiclore'>Historic Lore</option><option value='language' data-i18n='language'>Language</option><option value='materialslorebone' data-i18n='materialslorebone'>Bone/Horn: Materials Lore</option><option value='materialslorefabric' data-i18n='materialslorefabric'>Fabrics: Materials Lore</option><option value='materialsloreleather' data-i18n='materialsloreleather'>Leather: Materials Lore</option><option value='materialsloremetal' data-i18n='materialsloremetal'>Metal: Materials Lore</option><option value='materialslorestone' data-i18n='materialslorestone'>Stone: Materials Lore</option><option value='materialslorewood' data-i18n='materialslorewood'>Wood: Materials Lore</option><option value='raciallore' data-i18n='raciallore'>Racial Lore</option><option value='regionlore' data-i18n='regionlore'>Region Lore</option><option value='religionphilosophy' data-i18n='religionphilosophy'>Religion/Philosophy</option><option value='spelllore' data-i18n='spelllore'>Spell Lore</option></select>
<span class='culture_select_group prop_value create_culture_lores3_ranks'></span><input name='comp_lores3_name' class='choice create_culture_lores3_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_lores4_show'><div class='prop_pair'><select name='comp_create_culture_lores4' class='culture_select_group prop_prop'><option value='creatureloreartificial' data-i18n='creatureloreartificial'>Artificial Creature: Creature Lore</option><option value='creatureloredemon' data-i18n='creatureloredemon'>Demon: Creature Lore</option><option value='creatureloredragon' data-i18n='creatureloredragon'>Dragon: Creature Lore</option><option value='creatureloreelemental' data-i18n='creatureloreelemental'>Elemental: Creature Lore</option><option value='creatureloreextraplaner' data-i18n='creatureloreextraplaner'>Extra-planer: Creature Lore</option><option value='creaturelorefaerie' data-i18n='creaturelorefaerie'>Faerie: Creature Lore</option><option value='creatureloreundead' data-i18n='creatureloreundead'>Undead: Creature Lore</option><option value='historiclore' data-i18n='historiclore'>Historic Lore</option><option value='language' data-i18n='language'>Language</option><option value='materialslorebone' data-i18n='materialslorebone'>Bone/Horn: Materials Lore</option><option value='materialslorefabric' data-i18n='materialslorefabric'>Fabrics: Materials Lore</option><option value='materialsloreleather' data-i18n='materialsloreleather'>Leather: Materials Lore</option><option value='materialsloremetal' data-i18n='materialsloremetal'>Metal: Materials Lore</option><option value='materialslorestone' data-i18n='materialslorestone'>Stone: Materials Lore</option><option value='materialslorewood' data-i18n='materialslorewood'>Wood: Materials Lore</option><option value='raciallore' data-i18n='raciallore'>Racial Lore</option><option value='regionlore' data-i18n='regionlore'>Region Lore</option><option value='religionphilosophy' data-i18n='religionphilosophy'>Religion/Philosophy</option><option value='spelllore' data-i18n='spelllore'>Spell Lore</option></select>
<span class='culture_select_group prop_value create_culture_lores4_ranks'></span><input name='comp_lores4_name' class='choice create_culture_lores4_spec_show' value='Specialisation'></div></div>

    <div class='choice create_culture_herbalism_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='herbalism'>To translatte</span><span class='prop_value culture_select_group create_culture_herbalism_ranks'></span></div></div>

    <div class='choice create_culture_medicine_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='medicine'>To translatte</span><span class='prop_value culture_select_group create_culture_medicine_ranks'></span></div></div>

    <div class='choice create_culture_meditation_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='meditation'>To translatte</span><span class='prop_value culture_select_group create_culture_meditation_ranks'></span></div></div>

    <div class='choice create_culture_poisonmastery_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='poisonmastery'>To translatte</span><span class='prop_value culture_select_group create_culture_poisonmastery_ranks'></span></div></div>

    <div class='choice create_culture_climbing_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='climbing'>To translatte</span><span class='prop_value culture_select_group create_culture_climbing_ranks'></span></div></div>

    <div class='choice create_culture_flying_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='flying'>To translatte</span><span class='prop_value culture_select_group create_culture_flying_ranks'></span></div></div>

    <div class='choice create_culture_running_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='running'>To translatte</span><span class='prop_value culture_select_group create_culture_running_ranks'></span></div></div>

    <div class='choice create_culture_swimming_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='swimming'>To translatte</span><span class='prop_value culture_select_group create_culture_swimming_ranks'></span></div></div>

    <div class='choice create_culture_influence_show'><div class='prop_pair'><select name='comp_create_cultureinfluence_select' class='create_cultureinfluence culture_select_group prop_prop'><option value='charm' data-i18n='charm'>Charm</option><option value='duping' data-i18n='duping'>Duping</option><option value='intimidation' data-i18n='intimidation'>Intimidation</option></select>
<span class='culture_select_group prop_value create_culture_influence_ranks'></span></div></div>

    <div class='choice create_culture_socialawareness_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='socialawareness'>To translatte</span><span class='prop_value culture_select_group create_culture_socialawareness_ranks'></span></div></div>

    <div class='choice create_culture_trading_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='trading'>To translatte</span><span class='prop_value culture_select_group create_culture_trading_ranks'></span></div></div>

    <div class='choice create_culture_concealment_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='concealment'>To translatte</span><span class='prop_value culture_select_group create_culture_concealment_ranks'></span></div></div>

    <div class='choice create_culture_stalking_show'><div class='prop_pair'><span class='prop_prop culture_select_group' data-i18n='stalking'>To translatte</span><span class='prop_value culture_select_group create_culture_stalking_ranks'></span></div></div>



    

<button class="fancybutton" type="back" value="knacks">Back (Knacks)</button>
<button class="fancybutton" type="submit" value="languages">Next (Languages)</button>
</div>
</charmancer>

<charmancer class="sheet-charmancer-languages">
<div>
<h2>Language Ranks</h2>


    <div class='prop_pair'><span class='prop_prop'><input type='text' name='comp_create_culture_languages_lang1name' value='Language (Native)'></span><div class='prop_value'>S<input type='number' name='comp_create_culture_languages_lang1s'>/ W <input type='number' name='comp_create_culture_languages_lang1w'></div>
</div>
<div class='prop_pair'><span class='prop_prop'><input type='text' name='comp_create_culture_languages_lang2name' value='Language 2'></span><div class='prop_value'>S<input type='number'  name='comp_create_culture_languages_lang2s'>/ W <input type='number' name='comp_create_culture_languages_lang2w'></div>
</div>
<div class='prop_pair'><span class='prop_prop'><input type='text' name='comp_create_culture_languages_lang3name' value='Language 3'></span><div class='prop_value'>S<input type='number'  name='comp_create_culture_languages_lang3s'>/ W <input type='number' name='comp_create_culture_languages_lang3w'></div>
</div>
<div class='prop_pair'><span class='prop_prop'><input type='text' name='comp_create_culture_languages_lang4name' value='Language 4'></span><div class='prop_value'>S<input type='number'  name='comp_create_culture_languages_lang4s'>/ W <input type='number' name='comp_create_culture_languages_lang4w'></div>
</div>


	  <b>Language Total</b>: 
	  <span class='create_language_spent'></span> 
	    / 
	  <span class='create_language_available'></span> 

      <br>

  

<button class="fancybutton" type="back" value="culture">Back (Culture Ranks)</button>
<button class="fancybutton" type="finish" value="newcharacter">Finish</button>
</div>
</charmancer>

<charmancer class="sheet-charmancer-levelup">
  <div>
  <button type='action' class='fancybutton' name='act_removesaved'>Clear Saved</button>

  <h2>Level Up</h2>

<div class='sticktop'>
  DP Spent: <span class='levelupdp'>0</span>
  
  Dp Available:
  <span class='dpinfo'></span>

  Current Level: <span class='current_level'></span> &rarr; <span class='new_level'></span>

  <!-- hide these -->
  <div style='display:none'> Next Level: <input name='comp_current_level'> <input name='comp_new_level'></div>
</div>

<div class='tabset'>
  <input type='radio' name='tabsetlevelup' id='levelupstats' checked>
    <label for='levelupstats'>Stats</label>
  <input type='radio' name='tabsetlevelup' id='levelupskills'>
    <label for='levelupskills'>Skills</label>
  <input type='radio' name='tabsetlevelup' id='levelupspells'>
    <label for='levelupspells'>Spells</label>
  <input type='radio' name='tabsetlevelup' id='leveluptalents'>
    <label for='leveluptalents'>Talents</label>
  <input type='radio' name='tabsetlevelup' id='leveluptrainingpackage'>
    <label for='leveluptrainingpackage'>Training Packages</label>

  <div class='tab-panels'>

    <div class='tab-panel'>
      <h2>Statistics</h2>

      
      <div class='choice levelup_statgain_free'>
	
	Free Stat Gain 1:
	  <select name='comp_statgain1' class='select' required>
	    <option value=''>Select...</option>
	  </select>
      <br>
	Free Stat Gain 2:
	  <select name='comp_statgain2' class='select' required>
	    <option value=''>Select...</option>
	  </select>
      </div>

      Additional stat gains (4&nbsp;DP each)<br>

      <div class='extra_statgains'></div>

      <button type='action' class='fancybutton fancybuttoninline' name='act_extrastatgain_add'
	>Extra Stat Gain</button>


    </div>
    <div class='tab-panel'>
      <h2>Skills</h2>
        <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='animal'></span>
      <span class='category_cost'><span class='cmcategory-animal-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillanimalhandling' data-i18n='animalhandling'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='animal' data-skill='animalhandling' data-specname='Animal'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillriding' data-i18n='riding'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='animal' data-skill='riding' data-specname='Mount'>Add Specialization</button>
</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='awareness'></span>
      <span class='category_cost'><span class='cmcategory-awareness-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillperceptionranks' class='smallselect'></select>
  <span class='skillname cmskillperception' data-i18n='perception'></span>
(<i>Current ranks: <span class='cmskillcur_perception_ranks'>-</span>, Bonus: <span class='cmskillcur_perception_bonus'>-</span>, Uses: <span class='cmskillcur_perception_usecount'>-</span>/<span class='cmskillcur_perception_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilltrackingranks' class='smallselect'></select>
  <span class='skillname cmskilltracking' data-i18n='tracking'></span>
(<i>Current ranks: <span class='cmskillcur_tracking_ranks'>-</span>, Bonus: <span class='cmskillcur_tracking_bonus'>-</span>, Uses: <span class='cmskillcur_tracking_usecount'>-</span>/<span class='cmskillcur_tracking_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='battleexpertise'></span>
      <span class='category_cost'><span class='cmcategory-battleexpertise-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillbattlestyle' data-i18n='battlestyle'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='battleexpertise' data-skill='battlestyle' data-specname='Style'>Add Specialization</button>
</div>
<div class='cmskill'>
 <select name='comp_cmskillmaneuveringinarmorranks' class='smallselect'></select>
  <span class='skillname cmskillmaneuveringinarmor' data-i18n='maneuveringinarmor'></span>
(<i>Current ranks: <span class='cmskillcur_maneuveringinarmor_ranks'>-</span>, Bonus: <span class='cmskillcur_maneuveringinarmor_bonus'>-</span>, Uses: <span class='cmskillcur_maneuveringinarmor_usecount'>-</span>/<span class='cmskillcur_maneuveringinarmor_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmountedcombatranks' class='smallselect'></select>
  <span class='skillname cmskillmountedcombat' data-i18n='mountedcombat'></span>
(<i>Current ranks: <span class='cmskillcur_mountedcombat_ranks'>-</span>, Bonus: <span class='cmskillcur_mountedcombat_bonus'>-</span>, Uses: <span class='cmskillcur_mountedcombat_usecount'>-</span>/<span class='cmskillcur_mountedcombat_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillprotectranks' class='smallselect'></select>
  <span class='skillname cmskillprotect' data-i18n='protect'></span>
(<i>Current ranks: <span class='cmskillcur_protect_ranks'>-</span>, Bonus: <span class='cmskillcur_protect_bonus'>-</span>, Uses: <span class='cmskillcur_protect_usecount'>-</span>/<span class='cmskillcur_protect_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillrestrictedquartersranks' class='smallselect'></select>
  <span class='skillname cmskillrestrictedquarters' data-i18n='restrictedquarters'></span>
(<i>Current ranks: <span class='cmskillcur_restrictedquarters_ranks'>-</span>, Bonus: <span class='cmskillcur_restrictedquarters_bonus'>-</span>, Uses: <span class='cmskillcur_restrictedquarters_usecount'>-</span>/<span class='cmskillcur_restrictedquarters_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillsubduingranks' class='smallselect'></select>
  <span class='skillname cmskillsubduing' data-i18n='subduing'></span>
(<i>Current ranks: <span class='cmskillcur_subduing_ranks'>-</span>, Bonus: <span class='cmskillcur_subduing_bonus'>-</span>, Uses: <span class='cmskillcur_subduing_usecount'>-</span>/<span class='cmskillcur_subduing_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='bodydiscipline'></span>
      <span class='category_cost'><span class='cmcategory-bodydiscipline-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskilladrenaldefenseranks' class='smallselect'></select>
  <span class='skillname cmskilladrenaldefense' data-i18n='adrenaldefense'></span>
(<i>Current ranks: <span class='cmskillcur_adrenaldefense_ranks'>-</span>, Bonus: <span class='cmskillcur_adrenaldefense_bonus'>-</span>, Uses: <span class='cmskillcur_adrenaldefense_usecount'>-</span>/<span class='cmskillcur_adrenaldefense_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilladrenalfocusranks' class='smallselect'></select>
  <span class='skillname cmskilladrenalfocus' data-i18n='adrenalfocus'></span>
(<i>Current ranks: <span class='cmskillcur_adrenalfocus_ranks'>-</span>, Bonus: <span class='cmskillcur_adrenalfocus_bonus'>-</span>, Uses: <span class='cmskillcur_adrenalfocus_usecount'>-</span>/<span class='cmskillcur_adrenalfocus_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilladrenalspeedranks' class='smallselect'></select>
  <span class='skillname cmskilladrenalspeed' data-i18n='adrenalspeed'></span>
(<i>Current ranks: <span class='cmskillcur_adrenalspeed_ranks'>-</span>, Bonus: <span class='cmskillcur_adrenalspeed_bonus'>-</span>, Uses: <span class='cmskillcur_adrenalspeed_usecount'>-</span>/<span class='cmskillcur_adrenalspeed_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilladrenalstrengthranks' class='smallselect'></select>
  <span class='skillname cmskilladrenalstrength' data-i18n='adrenalstrength'></span>
(<i>Current ranks: <span class='cmskillcur_adrenalstrength_ranks'>-</span>, Bonus: <span class='cmskillcur_adrenalstrength_bonus'>-</span>, Uses: <span class='cmskillcur_adrenalstrength_usecount'>-</span>/<span class='cmskillcur_adrenalstrength_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskilldisciplinestyle' data-i18n='disciplinestyle'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='bodydiscipline' data-skill='disciplinestyle' data-specname='Style'>Add Specialization</button>
</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='brawn'></span>
      <span class='category_cost'><span class='cmcategory-brawn-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillbodydevelopmentranks' class='smallselect'></select>
  <span class='skillname cmskillbodydevelopment' data-i18n='bodydevelopment'></span>
(<i>Current ranks: <span class='cmskillcur_bodydevelopment_ranks'>-</span>, Bonus: <span class='cmskillcur_bodydevelopment_bonus'>-</span>, Uses: <span class='cmskillcur_bodydevelopment_usecount'>-</span>/<span class='cmskillcur_bodydevelopment_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillfortituderanks' class='smallselect'></select>
  <span class='skillname cmskillfortitude' data-i18n='fortitude'></span>
(<i>Current ranks: <span class='cmskillcur_fortitude_ranks'>-</span>, Bonus: <span class='cmskillcur_fortitude_bonus'>-</span>, Uses: <span class='cmskillcur_fortitude_usecount'>-</span>/<span class='cmskillcur_fortitude_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillweighttrainingranks' class='smallselect'></select>
  <span class='skillname cmskillweighttraining' data-i18n='weighttraining'></span>
(<i>Current ranks: <span class='cmskillcur_weighttraining_ranks'>-</span>, Bonus: <span class='cmskillcur_weighttraining_bonus'>-</span>, Uses: <span class='cmskillcur_weighttraining_usecount'>-</span>/<span class='cmskillcur_weighttraining_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='combatexpertise'></span>
      <span class='category_cost'><span class='cmcategory-combatexpertise-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillblindfightingranks' class='smallselect'></select>
  <span class='skillname cmskillblindfighting' data-i18n='blindfighting'></span>
(<i>Current ranks: <span class='cmskillcur_blindfighting_ranks'>-</span>, Bonus: <span class='cmskillcur_blindfighting_bonus'>-</span>, Uses: <span class='cmskillcur_blindfighting_usecount'>-</span>/<span class='cmskillcur_blindfighting_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskillcombatstyle' data-i18n='combatstyle'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='combatexpertise' data-skill='combatstyle' data-specname='Style'>Add Specialization</button>
</div>
<div class='cmskill'>
 <select name='comp_cmskilldisarmranks' class='smallselect'></select>
  <span class='skillname cmskilldisarm' data-i18n='disarm'></span>
(<i>Current ranks: <span class='cmskillcur_disarm_ranks'>-</span>, Bonus: <span class='cmskillcur_disarm_bonus'>-</span>, Uses: <span class='cmskillcur_disarm_usecount'>-</span>/<span class='cmskillcur_disarm_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillfootworkranks' class='smallselect'></select>
  <span class='skillname cmskillfootwork' data-i18n='footwork'></span>
(<i>Current ranks: <span class='cmskillcur_footwork_ranks'>-</span>, Bonus: <span class='cmskillcur_footwork_bonus'>-</span>, Uses: <span class='cmskillcur_footwork_usecount'>-</span>/<span class='cmskillcur_footwork_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmultipleattacksranks' class='smallselect'></select>
  <span class='skillname cmskillmultipleattacks' data-i18n='multipleattacks'></span>
(<i>Current ranks: <span class='cmskillcur_multipleattacks_ranks'>-</span>, Bonus: <span class='cmskillcur_multipleattacks_bonus'>-</span>, Uses: <span class='cmskillcur_multipleattacks_usecount'>-</span>/<span class='cmskillcur_multipleattacks_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillreversestrikeranks' class='smallselect'></select>
  <span class='skillname cmskillreversestrike' data-i18n='reversestrike'></span>
(<i>Current ranks: <span class='cmskillcur_reversestrike_ranks'>-</span>, Bonus: <span class='cmskillcur_reversestrike_bonus'>-</span>, Uses: <span class='cmskillcur_reversestrike_usecount'>-</span>/<span class='cmskillcur_reversestrike_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='combattraining'></span>
      <span class='category_cost'><span class='cmcategory-combattraining-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillmeleeweapons' data-i18n='meleeweapons'></span>
      <span class='category_cost'><span class='cmcategory-meleeweapons-cost'>?</span></span>
<div class='cmspecialization'>
 <select name='comp_cmskillbladeranks' class='smallselect'></select>
  <span class='skillname' data-i18n='blade'></span>
(<i>Current ranks: <span class='cmskillcur_blade_ranks'>-</span>, Bonus: <span class='cmskillcur_blade_bonus'>-</span>, Uses: <span class='cmskillcur_blade_usecount'>-</span>/<span class='cmskillcur_blade_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillchainranks' class='smallselect'></select>
  <span class='skillname' data-i18n='chain'></span>
(<i>Current ranks: <span class='cmskillcur_chain_ranks'>-</span>, Bonus: <span class='cmskillcur_chain_bonus'>-</span>, Uses: <span class='cmskillcur_chain_usecount'>-</span>/<span class='cmskillcur_chain_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillhaftedranks' class='smallselect'></select>
  <span class='skillname' data-i18n='hafted'></span>
(<i>Current ranks: <span class='cmskillcur_hafted_ranks'>-</span>, Bonus: <span class='cmskillcur_hafted_bonus'>-</span>, Uses: <span class='cmskillcur_hafted_usecount'>-</span>/<span class='cmskillcur_hafted_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillgreaterbladeranks' class='smallselect'></select>
  <span class='skillname' data-i18n='greaterblade'></span>
(<i>Current ranks: <span class='cmskillcur_greaterblade_ranks'>-</span>, Bonus: <span class='cmskillcur_greaterblade_bonus'>-</span>, Uses: <span class='cmskillcur_greaterblade_usecount'>-</span>/<span class='cmskillcur_greaterblade_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillgreaterchainranks' class='smallselect'></select>
  <span class='skillname' data-i18n='greaterchain'></span>
(<i>Current ranks: <span class='cmskillcur_greaterchain_ranks'>-</span>, Bonus: <span class='cmskillcur_greaterchain_bonus'>-</span>, Uses: <span class='cmskillcur_greaterchain_usecount'>-</span>/<span class='cmskillcur_greaterchain_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillgreaterhafterranks' class='smallselect'></select>
  <span class='skillname' data-i18n='greaterhafter'></span>
(<i>Current ranks: <span class='cmskillcur_greaterhafter_ranks'>-</span>, Bonus: <span class='cmskillcur_greaterhafter_bonus'>-</span>, Uses: <span class='cmskillcur_greaterhafter_usecount'>-</span>/<span class='cmskillcur_greaterhafter_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillpolearmranks' class='smallselect'></select>
  <span class='skillname' data-i18n='polearm'></span>
(<i>Current ranks: <span class='cmskillcur_polearm_ranks'>-</span>, Bonus: <span class='cmskillcur_polearm_bonus'>-</span>, Uses: <span class='cmskillcur_polearm_usecount'>-</span>/<span class='cmskillcur_polearm_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmeleeexoticranks' class='smallselect'></select>
  <span class='skillname' data-i18n='meleeexotic'></span>
(<i>Current ranks: <span class='cmskillcur_meleeexotic_ranks'>-</span>, Bonus: <span class='cmskillcur_meleeexotic_bonus'>-</span>, Uses: <span class='cmskillcur_meleeexotic_usecount'>-</span>/<span class='cmskillcur_meleeexotic_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
  <span class='skillname cmskillrangedweapons' data-i18n='rangedweapons'></span>
      <span class='category_cost'><span class='cmcategory-rangedweapons-cost'>?</span></span>
<div class='cmspecialization'>
 <select name='comp_cmskillbowranks' class='smallselect'></select>
  <span class='skillname' data-i18n='bow'></span>
(<i>Current ranks: <span class='cmskillcur_bow_ranks'>-</span>, Bonus: <span class='cmskillcur_bow_bonus'>-</span>, Uses: <span class='cmskillcur_bow_usecount'>-</span>/<span class='cmskillcur_bow_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcrossbowranks' class='smallselect'></select>
  <span class='skillname' data-i18n='crossbow'></span>
(<i>Current ranks: <span class='cmskillcur_crossbow_ranks'>-</span>, Bonus: <span class='cmskillcur_crossbow_bonus'>-</span>, Uses: <span class='cmskillcur_crossbow_usecount'>-</span>/<span class='cmskillcur_crossbow_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillslingranks' class='smallselect'></select>
  <span class='skillname' data-i18n='sling'></span>
(<i>Current ranks: <span class='cmskillcur_sling_ranks'>-</span>, Bonus: <span class='cmskillcur_sling_bonus'>-</span>, Uses: <span class='cmskillcur_sling_usecount'>-</span>/<span class='cmskillcur_sling_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillthrownranks' class='smallselect'></select>
  <span class='skillname' data-i18n='thrown'></span>
(<i>Current ranks: <span class='cmskillcur_thrown_ranks'>-</span>, Bonus: <span class='cmskillcur_thrown_bonus'>-</span>, Uses: <span class='cmskillcur_thrown_usecount'>-</span>/<span class='cmskillcur_thrown_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillrangedexoticranks' class='smallselect'></select>
  <span class='skillname' data-i18n='rangedexotic'></span>
(<i>Current ranks: <span class='cmskillcur_rangedexotic_ranks'>-</span>, Bonus: <span class='cmskillcur_rangedexotic_bonus'>-</span>, Uses: <span class='cmskillcur_rangedexotic_usecount'>-</span>/<span class='cmskillcur_rangedexotic_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
 <select name='comp_cmskillshieldranks' class='smallselect'></select>
  <span class='skillname cmskillshield' data-i18n='shield'></span>
      <span class='category_cost'><span class='cmcategory-shield-cost'>?</span></span>
(<i>Current ranks: <span class='cmskillcur_shield_ranks'>-</span>, Bonus: <span class='cmskillcur_shield_bonus'>-</span>, Uses: <span class='cmskillcur_shield_usecount'>-</span>/<span class='cmskillcur_shield_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskillunarmed' data-i18n='unarmed'></span>
      <span class='category_cost'><span class='cmcategory-unarmed-cost'>?</span></span>
<div class='cmspecialization'>
 <select name='comp_cmskillstrikesranks' class='smallselect'></select>
  <span class='skillname' data-i18n='strikes'></span>
(<i>Current ranks: <span class='cmskillcur_strikes_ranks'>-</span>, Bonus: <span class='cmskillcur_strikes_bonus'>-</span>, Uses: <span class='cmskillcur_strikes_usecount'>-</span>/<span class='cmskillcur_strikes_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsweepsthrowsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='sweepsthrows'></span>
(<i>Current ranks: <span class='cmskillcur_sweepsthrows_ranks'>-</span>, Bonus: <span class='cmskillcur_sweepsthrows_bonus'>-</span>, Uses: <span class='cmskillcur_sweepsthrows_usecount'>-</span>/<span class='cmskillcur_sweepsthrows_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillwrestlingranks' class='smallselect'></select>
  <span class='skillname' data-i18n='wrestling'></span>
(<i>Current ranks: <span class='cmskillcur_wrestling_ranks'>-</span>, Bonus: <span class='cmskillcur_wrestling_bonus'>-</span>, Uses: <span class='cmskillcur_wrestling_usecount'>-</span>/<span class='cmskillcur_wrestling_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillbeakranks' class='smallselect'></select>
  <span class='skillname' data-i18n='beak'></span>
(<i>Current ranks: <span class='cmskillcur_beak_ranks'>-</span>, Bonus: <span class='cmskillcur_beak_bonus'>-</span>, Uses: <span class='cmskillcur_beak_usecount'>-</span>/<span class='cmskillcur_beak_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillbiteranks' class='smallselect'></select>
  <span class='skillname' data-i18n='bite'></span>
(<i>Current ranks: <span class='cmskillcur_bite_ranks'>-</span>, Bonus: <span class='cmskillcur_bite_bonus'>-</span>, Uses: <span class='cmskillcur_bite_usecount'>-</span>/<span class='cmskillcur_bite_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillclawranks' class='smallselect'></select>
  <span class='skillname' data-i18n='claw'></span>
(<i>Current ranks: <span class='cmskillcur_claw_ranks'>-</span>, Bonus: <span class='cmskillcur_claw_bonus'>-</span>, Uses: <span class='cmskillcur_claw_usecount'>-</span>/<span class='cmskillcur_claw_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillhornranks' class='smallselect'></select>
  <span class='skillname' data-i18n='horn'></span>
(<i>Current ranks: <span class='cmskillcur_horn_ranks'>-</span>, Bonus: <span class='cmskillcur_horn_bonus'>-</span>, Uses: <span class='cmskillcur_horn_usecount'>-</span>/<span class='cmskillcur_horn_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillramranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ram'></span>
(<i>Current ranks: <span class='cmskillcur_ram_ranks'>-</span>, Bonus: <span class='cmskillcur_ram_bonus'>-</span>, Uses: <span class='cmskillcur_ram_usecount'>-</span>/<span class='cmskillcur_ram_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillstingerranks' class='smallselect'></select>
  <span class='skillname' data-i18n='stinger'></span>
(<i>Current ranks: <span class='cmskillcur_stinger_ranks'>-</span>, Bonus: <span class='cmskillcur_stinger_bonus'>-</span>, Uses: <span class='cmskillcur_stinger_usecount'>-</span>/<span class='cmskillcur_stinger_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskilltrampleranks' class='smallselect'></select>
  <span class='skillname' data-i18n='trample'></span>
(<i>Current ranks: <span class='cmskillcur_trample_ranks'>-</span>, Bonus: <span class='cmskillcur_trample_bonus'>-</span>, Uses: <span class='cmskillcur_trample_usecount'>-</span>/<span class='cmskillcur_trample_usecounttotal'>-</span>)</i></div>
</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='composition'></span>
      <span class='category_cost'><span class='cmcategory-composition-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillillusioncraftingranks' class='smallselect'></select>
  <span class='skillname cmskillillusioncrafting' data-i18n='illusioncrafting'></span>
(<i>Current ranks: <span class='cmskillcur_illusioncrafting_ranks'>-</span>, Bonus: <span class='cmskillcur_illusioncrafting_bonus'>-</span>, Uses: <span class='cmskillcur_illusioncrafting_usecount'>-</span>/<span class='cmskillcur_illusioncrafting_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmusicalcompositionranks' class='smallselect'></select>
  <span class='skillname cmskillmusicalcomposition' data-i18n='musicalcomposition'></span>
(<i>Current ranks: <span class='cmskillcur_musicalcomposition_ranks'>-</span>, Bonus: <span class='cmskillcur_musicalcomposition_bonus'>-</span>, Uses: <span class='cmskillcur_musicalcomposition_usecount'>-</span>/<span class='cmskillcur_musicalcomposition_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillwritingranks' class='smallselect'></select>
  <span class='skillname cmskillwriting' data-i18n='writing'></span>
(<i>Current ranks: <span class='cmskillcur_writing_ranks'>-</span>, Bonus: <span class='cmskillcur_writing_bonus'>-</span>, Uses: <span class='cmskillcur_writing_usecount'>-</span>/<span class='cmskillcur_writing_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='crafting'></span>
      <span class='category_cost'><span class='cmcategory-crafting-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillculinaryranks' class='smallselect'></select>
  <span class='skillname cmskillculinary' data-i18n='culinary'></span>
(<i>Current ranks: <span class='cmskillcur_culinary_ranks'>-</span>, Bonus: <span class='cmskillcur_culinary_bonus'>-</span>, Uses: <span class='cmskillcur_culinary_usecount'>-</span>/<span class='cmskillcur_culinary_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilldrawingpaintingranks' class='smallselect'></select>
  <span class='skillname cmskilldrawingpainting' data-i18n='drawingpainting'></span>
(<i>Current ranks: <span class='cmskillcur_drawingpainting_ranks'>-</span>, Bonus: <span class='cmskillcur_drawingpainting_bonus'>-</span>, Uses: <span class='cmskillcur_drawingpainting_usecount'>-</span>/<span class='cmskillcur_drawingpainting_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillfabriccraftranks' class='smallselect'></select>
  <span class='skillname cmskillfabriccraft' data-i18n='fabriccraft'></span>
(<i>Current ranks: <span class='cmskillcur_fabriccraft_ranks'>-</span>, Bonus: <span class='cmskillcur_fabriccraft_bonus'>-</span>, Uses: <span class='cmskillcur_fabriccraft_usecount'>-</span>/<span class='cmskillcur_fabriccraft_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillleathercraftranks' class='smallselect'></select>
  <span class='skillname cmskillleathercraft' data-i18n='leathercraft'></span>
(<i>Current ranks: <span class='cmskillcur_leathercraft_ranks'>-</span>, Bonus: <span class='cmskillcur_leathercraft_bonus'>-</span>, Uses: <span class='cmskillcur_leathercraft_usecount'>-</span>/<span class='cmskillcur_leathercraft_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmetalcraftranks' class='smallselect'></select>
  <span class='skillname cmskillmetalcraft' data-i18n='metalcraft'></span>
(<i>Current ranks: <span class='cmskillcur_metalcraft_ranks'>-</span>, Bonus: <span class='cmskillcur_metalcraft_bonus'>-</span>, Uses: <span class='cmskillcur_metalcraft_usecount'>-</span>/<span class='cmskillcur_metalcraft_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillstonecraftranks' class='smallselect'></select>
  <span class='skillname cmskillstonecraft' data-i18n='stonecraft'></span>
(<i>Current ranks: <span class='cmskillcur_stonecraft_ranks'>-</span>, Bonus: <span class='cmskillcur_stonecraft_bonus'>-</span>, Uses: <span class='cmskillcur_stonecraft_usecount'>-</span>/<span class='cmskillcur_stonecraft_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillwoodcraftranks' class='smallselect'></select>
  <span class='skillname cmskillwoodcraft' data-i18n='woodcraft'></span>
(<i>Current ranks: <span class='cmskillcur_woodcraft_ranks'>-</span>, Bonus: <span class='cmskillcur_woodcraft_bonus'>-</span>, Uses: <span class='cmskillcur_woodcraft_usecount'>-</span>/<span class='cmskillcur_woodcraft_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='delving'></span>
      <span class='category_cost'><span class='cmcategory-delving-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillattunementranks' class='smallselect'></select>
  <span class='skillname cmskillattunement' data-i18n='attunement'></span>
(<i>Current ranks: <span class='cmskillcur_attunement_ranks'>-</span>, Bonus: <span class='cmskillcur_attunement_bonus'>-</span>, Uses: <span class='cmskillcur_attunement_usecount'>-</span>/<span class='cmskillcur_attunement_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillrunesranks' class='smallselect'></select>
  <span class='skillname cmskillrunes' data-i18n='runes'></span>
(<i>Current ranks: <span class='cmskillcur_runes_ranks'>-</span>, Bonus: <span class='cmskillcur_runes_bonus'>-</span>, Uses: <span class='cmskillcur_runes_usecount'>-</span>/<span class='cmskillcur_runes_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='environmental'></span>
      <span class='category_cost'><span class='cmcategory-environmental-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillnavigationranks' class='smallselect'></select>
  <span class='skillname cmskillnavigation' data-i18n='navigation'></span>
(<i>Current ranks: <span class='cmskillcur_navigation_ranks'>-</span>, Bonus: <span class='cmskillcur_navigation_bonus'>-</span>, Uses: <span class='cmskillcur_navigation_usecount'>-</span>/<span class='cmskillcur_navigation_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskillpiloting' data-i18n='piloting'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='environmental' data-skill='piloting' data-specname='Vehicle'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillsurvival' data-i18n='survival'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialalpineranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialalpine'></span>
(<i>Current ranks: <span class='cmskillcur_survivialalpine_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialalpine_bonus'>-</span>, Uses: <span class='cmskillcur_survivialalpine_usecount'>-</span>/<span class='cmskillcur_survivialalpine_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialoceansranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialoceans'></span>
(<i>Current ranks: <span class='cmskillcur_survivialoceans_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialoceans_bonus'>-</span>, Uses: <span class='cmskillcur_survivialoceans_usecount'>-</span>/<span class='cmskillcur_survivialoceans_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialundergroundranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialunderground'></span>
(<i>Current ranks: <span class='cmskillcur_survivialunderground_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialunderground_bonus'>-</span>, Uses: <span class='cmskillcur_survivialunderground_usecount'>-</span>/<span class='cmskillcur_survivialunderground_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialicecapsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialicecaps'></span>
(<i>Current ranks: <span class='cmskillcur_survivialicecaps_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialicecaps_bonus'>-</span>, Uses: <span class='cmskillcur_survivialicecaps_usecount'>-</span>/<span class='cmskillcur_survivialicecaps_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialtundraranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialtundra'></span>
(<i>Current ranks: <span class='cmskillcur_survivialtundra_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialtundra_bonus'>-</span>, Uses: <span class='cmskillcur_survivialtundra_usecount'>-</span>/<span class='cmskillcur_survivialtundra_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialborealranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialboreal'></span>
(<i>Current ranks: <span class='cmskillcur_survivialboreal_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialboreal_bonus'>-</span>, Uses: <span class='cmskillcur_survivialboreal_usecount'>-</span>/<span class='cmskillcur_survivialboreal_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialshrublandsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialshrublands'></span>
(<i>Current ranks: <span class='cmskillcur_survivialshrublands_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialshrublands_bonus'>-</span>, Uses: <span class='cmskillcur_survivialshrublands_usecount'>-</span>/<span class='cmskillcur_survivialshrublands_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialprairiesranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialprairies'></span>
(<i>Current ranks: <span class='cmskillcur_survivialprairies_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialprairies_bonus'>-</span>, Uses: <span class='cmskillcur_survivialprairies_usecount'>-</span>/<span class='cmskillcur_survivialprairies_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialtemperateranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialtemperate'></span>
(<i>Current ranks: <span class='cmskillcur_survivialtemperate_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialtemperate_bonus'>-</span>, Uses: <span class='cmskillcur_survivialtemperate_usecount'>-</span>/<span class='cmskillcur_survivialtemperate_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialhotdesertsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialhotdeserts'></span>
(<i>Current ranks: <span class='cmskillcur_survivialhotdeserts_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialhotdeserts_bonus'>-</span>, Uses: <span class='cmskillcur_survivialhotdeserts_usecount'>-</span>/<span class='cmskillcur_survivialhotdeserts_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialsavannasranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialsavannas'></span>
(<i>Current ranks: <span class='cmskillcur_survivialsavannas_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialsavannas_bonus'>-</span>, Uses: <span class='cmskillcur_survivialsavannas_usecount'>-</span>/<span class='cmskillcur_survivialsavannas_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialtropicalranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialtropical'></span>
(<i>Current ranks: <span class='cmskillcur_survivialtropical_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialtropical_bonus'>-</span>, Uses: <span class='cmskillcur_survivialtropical_usecount'>-</span>/<span class='cmskillcur_survivialtropical_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialurbanranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialurban'></span>
(<i>Current ranks: <span class='cmskillcur_survivialurban_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialurban_bonus'>-</span>, Uses: <span class='cmskillcur_survivialurban_usecount'>-</span>/<span class='cmskillcur_survivialurban_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsurvivialxenoranks' class='smallselect'></select>
  <span class='skillname' data-i18n='survivialxeno'></span>
(<i>Current ranks: <span class='cmskillcur_survivialxeno_ranks'>-</span>, Bonus: <span class='cmskillcur_survivialxeno_bonus'>-</span>, Uses: <span class='cmskillcur_survivialxeno_usecount'>-</span>/<span class='cmskillcur_survivialxeno_usecounttotal'>-</span>)</i></div>
</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='gymnastic'></span>
      <span class='category_cost'><span class='cmcategory-gymnastic-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillacrobaticsranks' class='smallselect'></select>
  <span class='skillname cmskillacrobatics' data-i18n='acrobatics'></span>
(<i>Current ranks: <span class='cmskillcur_acrobatics_ranks'>-</span>, Bonus: <span class='cmskillcur_acrobatics_bonus'>-</span>, Uses: <span class='cmskillcur_acrobatics_usecount'>-</span>/<span class='cmskillcur_acrobatics_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillcontortionsranks' class='smallselect'></select>
  <span class='skillname cmskillcontortions' data-i18n='contortions'></span>
(<i>Current ranks: <span class='cmskillcur_contortions_ranks'>-</span>, Bonus: <span class='cmskillcur_contortions_bonus'>-</span>, Uses: <span class='cmskillcur_contortions_usecount'>-</span>/<span class='cmskillcur_contortions_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilljumpingranks' class='smallselect'></select>
  <span class='skillname cmskilljumping' data-i18n='jumping'></span>
(<i>Current ranks: <span class='cmskillcur_jumping_ranks'>-</span>, Bonus: <span class='cmskillcur_jumping_bonus'>-</span>, Uses: <span class='cmskillcur_jumping_usecount'>-</span>/<span class='cmskillcur_jumping_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='lore'></span>
      <span class='category_cost'><span class='cmcategory-lore-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillcreaturelore' data-i18n='creaturelore'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloreartificialranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloreartificial'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloreartificial_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloreartificial_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloreartificial_usecount'>-</span>/<span class='cmskillcur_creatureloreartificial_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloredemonranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloredemon'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloredemon_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloredemon_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloredemon_usecount'>-</span>/<span class='cmskillcur_creatureloredemon_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloredragonranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloredragon'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloredragon_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloredragon_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloredragon_usecount'>-</span>/<span class='cmskillcur_creatureloredragon_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloreelementalranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloreelemental'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloreelemental_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloreelemental_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloreelemental_usecount'>-</span>/<span class='cmskillcur_creatureloreelemental_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloreextraplanerranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloreextraplaner'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloreextraplaner_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloreextraplaner_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloreextraplaner_usecount'>-</span>/<span class='cmskillcur_creatureloreextraplaner_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreaturelorefaerieranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creaturelorefaerie'></span>
(<i>Current ranks: <span class='cmskillcur_creaturelorefaerie_ranks'>-</span>, Bonus: <span class='cmskillcur_creaturelorefaerie_bonus'>-</span>, Uses: <span class='cmskillcur_creaturelorefaerie_usecount'>-</span>/<span class='cmskillcur_creaturelorefaerie_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreatureloreundeadranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creatureloreundead'></span>
(<i>Current ranks: <span class='cmskillcur_creatureloreundead_ranks'>-</span>, Bonus: <span class='cmskillcur_creatureloreundead_bonus'>-</span>, Uses: <span class='cmskillcur_creatureloreundead_usecount'>-</span>/<span class='cmskillcur_creatureloreundead_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
  <span class='skillname cmskillhistoriclore' data-i18n='historiclore'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='lore' data-skill='historiclore' data-specname='Period'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskilllanguage' data-i18n='language'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='lore' data-skill='language' data-specname='Language'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillmaterialslore' data-i18n='materialslore'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialsloreboneranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialslorebone'></span>
(<i>Current ranks: <span class='cmskillcur_materialslorebone_ranks'>-</span>, Bonus: <span class='cmskillcur_materialslorebone_bonus'>-</span>, Uses: <span class='cmskillcur_materialslorebone_usecount'>-</span>/<span class='cmskillcur_materialslorebone_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialslorefabricranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialslorefabric'></span>
(<i>Current ranks: <span class='cmskillcur_materialslorefabric_ranks'>-</span>, Bonus: <span class='cmskillcur_materialslorefabric_bonus'>-</span>, Uses: <span class='cmskillcur_materialslorefabric_usecount'>-</span>/<span class='cmskillcur_materialslorefabric_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialsloreleatherranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialsloreleather'></span>
(<i>Current ranks: <span class='cmskillcur_materialsloreleather_ranks'>-</span>, Bonus: <span class='cmskillcur_materialsloreleather_bonus'>-</span>, Uses: <span class='cmskillcur_materialsloreleather_usecount'>-</span>/<span class='cmskillcur_materialsloreleather_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialsloremetalranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialsloremetal'></span>
(<i>Current ranks: <span class='cmskillcur_materialsloremetal_ranks'>-</span>, Bonus: <span class='cmskillcur_materialsloremetal_bonus'>-</span>, Uses: <span class='cmskillcur_materialsloremetal_usecount'>-</span>/<span class='cmskillcur_materialsloremetal_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialslorestoneranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialslorestone'></span>
(<i>Current ranks: <span class='cmskillcur_materialslorestone_ranks'>-</span>, Bonus: <span class='cmskillcur_materialslorestone_bonus'>-</span>, Uses: <span class='cmskillcur_materialslorestone_usecount'>-</span>/<span class='cmskillcur_materialslorestone_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillmaterialslorewoodranks' class='smallselect'></select>
  <span class='skillname' data-i18n='materialslorewood'></span>
(<i>Current ranks: <span class='cmskillcur_materialslorewood_ranks'>-</span>, Bonus: <span class='cmskillcur_materialslorewood_bonus'>-</span>, Uses: <span class='cmskillcur_materialslorewood_usecount'>-</span>/<span class='cmskillcur_materialslorewood_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
  <span class='skillname cmskillraciallore' data-i18n='raciallore'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='lore' data-skill='raciallore' data-specname='Racial Group'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillregionlore' data-i18n='regionlore'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='lore' data-skill='regionlore' data-specname='Region'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillreligionphilosophy' data-i18n='religionphilosophy'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='lore' data-skill='religionphilosophy' data-specname='Religion'>Add Specialization</button>
</div>
<div class='cmskill'>
 <select name='comp_cmskillspellloreranks' class='smallselect'></select>
  <span class='skillname cmskillspelllore' data-i18n='spelllore'></span>
(<i>Current ranks: <span class='cmskillcur_spelllore_ranks'>-</span>, Bonus: <span class='cmskillcur_spelllore_bonus'>-</span>, Uses: <span class='cmskillcur_spelllore_usecount'>-</span>/<span class='cmskillcur_spelllore_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='magicalexpertise'></span>
      <span class='category_cost'><span class='cmcategory-magicalexpertise-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillgrace' data-i18n='grace'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='magicalexpertise' data-skill='grace' data-specname='List'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillspelltrickery' data-i18n='spelltrickery'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='magicalexpertise' data-skill='spelltrickery' data-specname='List'>Add Specialization</button>
</div>
<div class='cmskill'>
 <select name='comp_cmskilltranscendenceranks' class='smallselect'></select>
  <span class='skillname cmskilltranscendence' data-i18n='transcendence'></span>
(<i>Current ranks: <span class='cmskillcur_transcendence_ranks'>-</span>, Bonus: <span class='cmskillcur_transcendence_bonus'>-</span>, Uses: <span class='cmskillcur_transcendence_usecount'>-</span>/<span class='cmskillcur_transcendence_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='medical'></span>
      <span class='category_cost'><span class='cmcategory-medical-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillherbalismranks' class='smallselect'></select>
  <span class='skillname cmskillherbalism' data-i18n='herbalism'></span>
(<i>Current ranks: <span class='cmskillcur_herbalism_ranks'>-</span>, Bonus: <span class='cmskillcur_herbalism_bonus'>-</span>, Uses: <span class='cmskillcur_herbalism_usecount'>-</span>/<span class='cmskillcur_herbalism_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmedicineranks' class='smallselect'></select>
  <span class='skillname cmskillmedicine' data-i18n='medicine'></span>
(<i>Current ranks: <span class='cmskillcur_medicine_ranks'>-</span>, Bonus: <span class='cmskillcur_medicine_bonus'>-</span>, Uses: <span class='cmskillcur_medicine_usecount'>-</span>/<span class='cmskillcur_medicine_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillpoisonmasteryranks' class='smallselect'></select>
  <span class='skillname cmskillpoisonmastery' data-i18n='poisonmastery'></span>
(<i>Current ranks: <span class='cmskillcur_poisonmastery_ranks'>-</span>, Bonus: <span class='cmskillcur_poisonmastery_bonus'>-</span>, Uses: <span class='cmskillcur_poisonmastery_usecount'>-</span>/<span class='cmskillcur_poisonmastery_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='mentaldiscipline'></span>
      <span class='category_cost'><span class='cmcategory-mentaldiscipline-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillcontrollycanthropyranks' class='smallselect'></select>
  <span class='skillname cmskillcontrollycanthropy' data-i18n='controllycanthropy'></span>
(<i>Current ranks: <span class='cmskillcur_controllycanthropy_ranks'>-</span>, Bonus: <span class='cmskillcur_controllycanthropy_bonus'>-</span>, Uses: <span class='cmskillcur_controllycanthropy_usecount'>-</span>/<span class='cmskillcur_controllycanthropy_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmeditationranks' class='smallselect'></select>
  <span class='skillname cmskillmeditation' data-i18n='meditation'></span>
(<i>Current ranks: <span class='cmskillcur_meditation_ranks'>-</span>, Bonus: <span class='cmskillcur_meditation_bonus'>-</span>, Uses: <span class='cmskillcur_meditation_usecount'>-</span>/<span class='cmskillcur_meditation_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmentalfocusranks' class='smallselect'></select>
  <span class='skillname cmskillmentalfocus' data-i18n='mentalfocus'></span>
(<i>Current ranks: <span class='cmskillcur_mentalfocus_ranks'>-</span>, Bonus: <span class='cmskillcur_mentalfocus_bonus'>-</span>, Uses: <span class='cmskillcur_mentalfocus_usecount'>-</span>/<span class='cmskillcur_mentalfocus_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='movement'></span>
      <span class='category_cost'><span class='cmcategory-movement-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillclimbingranks' class='smallselect'></select>
  <span class='skillname cmskillclimbing' data-i18n='climbing'></span>
(<i>Current ranks: <span class='cmskillcur_climbing_ranks'>-</span>, Bonus: <span class='cmskillcur_climbing_bonus'>-</span>, Uses: <span class='cmskillcur_climbing_usecount'>-</span>/<span class='cmskillcur_climbing_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillflyingranks' class='smallselect'></select>
  <span class='skillname cmskillflying' data-i18n='flying'></span>
(<i>Current ranks: <span class='cmskillcur_flying_ranks'>-</span>, Bonus: <span class='cmskillcur_flying_bonus'>-</span>, Uses: <span class='cmskillcur_flying_usecount'>-</span>/<span class='cmskillcur_flying_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillrunningranks' class='smallselect'></select>
  <span class='skillname cmskillrunning' data-i18n='running'></span>
(<i>Current ranks: <span class='cmskillcur_running_ranks'>-</span>, Bonus: <span class='cmskillcur_running_bonus'>-</span>, Uses: <span class='cmskillcur_running_usecount'>-</span>/<span class='cmskillcur_running_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillswimmingranks' class='smallselect'></select>
  <span class='skillname cmskillswimming' data-i18n='swimming'></span>
(<i>Current ranks: <span class='cmskillcur_swimming_ranks'>-</span>, Bonus: <span class='cmskillcur_swimming_bonus'>-</span>, Uses: <span class='cmskillcur_swimming_usecount'>-</span>/<span class='cmskillcur_swimming_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='performanceart'></span>
      <span class='category_cost'><span class='cmcategory-performanceart-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillactingranks' class='smallselect'></select>
  <span class='skillname cmskillacting' data-i18n='acting'></span>
(<i>Current ranks: <span class='cmskillcur_acting_ranks'>-</span>, Bonus: <span class='cmskillcur_acting_bonus'>-</span>, Uses: <span class='cmskillcur_acting_usecount'>-</span>/<span class='cmskillcur_acting_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskillmusic' data-i18n='music'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='performanceart' data-skill='music' data-specname='Instrument'>Add Specialization</button>
</div>
<div class='cmskill'>
 <select name='comp_cmskillstagemagicranks' class='smallselect'></select>
  <span class='skillname cmskillstagemagic' data-i18n='stagemagic'></span>
(<i>Current ranks: <span class='cmskillcur_stagemagic_ranks'>-</span>, Bonus: <span class='cmskillcur_stagemagic_bonus'>-</span>, Uses: <span class='cmskillcur_stagemagic_usecount'>-</span>/<span class='cmskillcur_stagemagic_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='powermanipulation'></span>
      <span class='category_cost'><span class='cmcategory-powermanipulation-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillchannelingranks' class='smallselect'></select>
  <span class='skillname cmskillchanneling' data-i18n='channeling'></span>
(<i>Current ranks: <span class='cmskillcur_channeling_ranks'>-</span>, Bonus: <span class='cmskillcur_channeling_bonus'>-</span>, Uses: <span class='cmskillcur_channeling_usecount'>-</span>/<span class='cmskillcur_channeling_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskilldirectedspell' data-i18n='directedspell'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillelementalboltsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='elementalbolts'></span>
(<i>Current ranks: <span class='cmskillcur_elementalbolts_ranks'>-</span>, Bonus: <span class='cmskillcur_elementalbolts_bonus'>-</span>, Uses: <span class='cmskillcur_elementalbolts_usecount'>-</span>/<span class='cmskillcur_elementalbolts_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillillusionaryattacksranks' class='smallselect'></select>
  <span class='skillname' data-i18n='illusionaryattacks'></span>
(<i>Current ranks: <span class='cmskillcur_illusionaryattacks_ranks'>-</span>, Bonus: <span class='cmskillcur_illusionaryattacks_bonus'>-</span>, Uses: <span class='cmskillcur_illusionaryattacks_usecount'>-</span>/<span class='cmskillcur_illusionaryattacks_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillhurlingranks' class='smallselect'></select>
  <span class='skillname' data-i18n='hurling'></span>
(<i>Current ranks: <span class='cmskillcur_hurling_ranks'>-</span>, Bonus: <span class='cmskillcur_hurling_bonus'>-</span>, Uses: <span class='cmskillcur_hurling_usecount'>-</span>/<span class='cmskillcur_hurling_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
 <select name='comp_cmskillpowerdevelopmentranks' class='smallselect'></select>
  <span class='skillname cmskillpowerdevelopment' data-i18n='powerdevelopment'></span>
(<i>Current ranks: <span class='cmskillcur_powerdevelopment_ranks'>-</span>, Bonus: <span class='cmskillcur_powerdevelopment_bonus'>-</span>, Uses: <span class='cmskillcur_powerdevelopment_usecount'>-</span>/<span class='cmskillcur_powerdevelopment_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillpowerprojectionranks' class='smallselect'></select>
  <span class='skillname cmskillpowerprojection' data-i18n='powerprojection'></span>
(<i>Current ranks: <span class='cmskillcur_powerprojection_ranks'>-</span>, Bonus: <span class='cmskillcur_powerprojection_bonus'>-</span>, Uses: <span class='cmskillcur_powerprojection_usecount'>-</span>/<span class='cmskillcur_powerprojection_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='science'></span>
      <span class='category_cost'><span class='cmcategory-science-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskillarchitectureranks' class='smallselect'></select>
  <span class='skillname cmskillarchitecture' data-i18n='architecture'></span>
(<i>Current ranks: <span class='cmskillcur_architecture_ranks'>-</span>, Bonus: <span class='cmskillcur_architecture_bonus'>-</span>, Uses: <span class='cmskillcur_architecture_usecount'>-</span>/<span class='cmskillcur_architecture_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillastronomyranks' class='smallselect'></select>
  <span class='skillname cmskillastronomy' data-i18n='astronomy'></span>
(<i>Current ranks: <span class='cmskillcur_astronomy_ranks'>-</span>, Bonus: <span class='cmskillcur_astronomy_bonus'>-</span>, Uses: <span class='cmskillcur_astronomy_usecount'>-</span>/<span class='cmskillcur_astronomy_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillengineeringranks' class='smallselect'></select>
  <span class='skillname cmskillengineering' data-i18n='engineering'></span>
(<i>Current ranks: <span class='cmskillcur_engineering_ranks'>-</span>, Bonus: <span class='cmskillcur_engineering_bonus'>-</span>, Uses: <span class='cmskillcur_engineering_usecount'>-</span>/<span class='cmskillcur_engineering_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillmathematicsranks' class='smallselect'></select>
  <span class='skillname cmskillmathematics' data-i18n='mathematics'></span>
(<i>Current ranks: <span class='cmskillcur_mathematics_ranks'>-</span>, Bonus: <span class='cmskillcur_mathematics_bonus'>-</span>, Uses: <span class='cmskillcur_mathematics_usecount'>-</span>/<span class='cmskillcur_mathematics_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='social'></span>
      <span class='category_cost'><span class='cmcategory-social-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillinfluence' data-i18n='influence'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillcharmranks' class='smallselect'></select>
  <span class='skillname' data-i18n='charm'></span>
(<i>Current ranks: <span class='cmskillcur_charm_ranks'>-</span>, Bonus: <span class='cmskillcur_charm_bonus'>-</span>, Uses: <span class='cmskillcur_charm_usecount'>-</span>/<span class='cmskillcur_charm_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskilldupingranks' class='smallselect'></select>
  <span class='skillname' data-i18n='duping'></span>
(<i>Current ranks: <span class='cmskillcur_duping_ranks'>-</span>, Bonus: <span class='cmskillcur_duping_bonus'>-</span>, Uses: <span class='cmskillcur_duping_usecount'>-</span>/<span class='cmskillcur_duping_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillintimidationranks' class='smallselect'></select>
  <span class='skillname' data-i18n='intimidation'></span>
(<i>Current ranks: <span class='cmskillcur_intimidation_ranks'>-</span>, Bonus: <span class='cmskillcur_intimidation_bonus'>-</span>, Uses: <span class='cmskillcur_intimidation_usecount'>-</span>/<span class='cmskillcur_intimidation_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
 <select name='comp_cmskillleadershipranks' class='smallselect'></select>
  <span class='skillname cmskillleadership' data-i18n='leadership'></span>
(<i>Current ranks: <span class='cmskillcur_leadership_ranks'>-</span>, Bonus: <span class='cmskillcur_leadership_bonus'>-</span>, Uses: <span class='cmskillcur_leadership_usecount'>-</span>/<span class='cmskillcur_leadership_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillsocialawarenessranks' class='smallselect'></select>
  <span class='skillname cmskillsocialawareness' data-i18n='socialawareness'></span>
(<i>Current ranks: <span class='cmskillcur_socialawareness_ranks'>-</span>, Bonus: <span class='cmskillcur_socialawareness_bonus'>-</span>, Uses: <span class='cmskillcur_socialawareness_usecount'>-</span>/<span class='cmskillcur_socialawareness_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilltradingranks' class='smallselect'></select>
  <span class='skillname cmskilltrading' data-i18n='trading'></span>
(<i>Current ranks: <span class='cmskillcur_trading_ranks'>-</span>, Bonus: <span class='cmskillcur_trading_bonus'>-</span>, Uses: <span class='cmskillcur_trading_usecount'>-</span>/<span class='cmskillcur_trading_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='spellcasting'></span>
      <span class='category_cost'><span class='cmcategory-spellcasting-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillmagicalritual' data-i18n='magicalritual'></span>
      <span class='category_cost'><span class='cmcategory-magicalritual-cost'>?</span></span>
<div class='cmspecialization'>
 <select name='comp_cmskillalterationranks' class='smallselect'></select>
  <span class='skillname' data-i18n='alteration'></span>
(<i>Current ranks: <span class='cmskillcur_alteration_ranks'>-</span>, Bonus: <span class='cmskillcur_alteration_bonus'>-</span>, Uses: <span class='cmskillcur_alteration_usecount'>-</span>/<span class='cmskillcur_alteration_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillcreationranks' class='smallselect'></select>
  <span class='skillname' data-i18n='creation'></span>
(<i>Current ranks: <span class='cmskillcur_creation_ranks'>-</span>, Bonus: <span class='cmskillcur_creation_bonus'>-</span>, Uses: <span class='cmskillcur_creation_usecount'>-</span>/<span class='cmskillcur_creation_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskilldefensiveranks' class='smallselect'></select>
  <span class='skillname' data-i18n='defensive'></span>
(<i>Current ranks: <span class='cmskillcur_defensive_ranks'>-</span>, Bonus: <span class='cmskillcur_defensive_bonus'>-</span>, Uses: <span class='cmskillcur_defensive_usecount'>-</span>/<span class='cmskillcur_defensive_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskilldestructionranks' class='smallselect'></select>
  <span class='skillname' data-i18n='destruction'></span>
(<i>Current ranks: <span class='cmskillcur_destruction_ranks'>-</span>, Bonus: <span class='cmskillcur_destruction_bonus'>-</span>, Uses: <span class='cmskillcur_destruction_usecount'>-</span>/<span class='cmskillcur_destruction_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillelementalranks' class='smallselect'></select>
  <span class='skillname' data-i18n='elemental'></span>
(<i>Current ranks: <span class='cmskillcur_elemental_ranks'>-</span>, Bonus: <span class='cmskillcur_elemental_bonus'>-</span>, Uses: <span class='cmskillcur_elemental_usecount'>-</span>/<span class='cmskillcur_elemental_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillhealingranks' class='smallselect'></select>
  <span class='skillname' data-i18n='healing'></span>
(<i>Current ranks: <span class='cmskillcur_healing_ranks'>-</span>, Bonus: <span class='cmskillcur_healing_bonus'>-</span>, Uses: <span class='cmskillcur_healing_usecount'>-</span>/<span class='cmskillcur_healing_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillinformationalranks' class='smallselect'></select>
  <span class='skillname' data-i18n='informational'></span>
(<i>Current ranks: <span class='cmskillcur_informational_ranks'>-</span>, Bonus: <span class='cmskillcur_informational_bonus'>-</span>, Uses: <span class='cmskillcur_informational_usecount'>-</span>/<span class='cmskillcur_informational_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillsummoningtransportationranks' class='smallselect'></select>
  <span class='skillname' data-i18n='summoningtransportation'></span>
(<i>Current ranks: <span class='cmskillcur_summoningtransportation_ranks'>-</span>, Bonus: <span class='cmskillcur_summoningtransportation_bonus'>-</span>, Uses: <span class='cmskillcur_summoningtransportation_usecount'>-</span>/<span class='cmskillcur_summoningtransportation_usecounttotal'>-</span>)</i></div>
</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='subterfuge'></span>
      <span class='category_cost'><span class='cmcategory-subterfuge-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskillambush' data-i18n='ambush'></span>
<div class='cmspecialization'>
 <select name='comp_cmskillambushdirectedspellsranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ambushdirectedspells'></span>
(<i>Current ranks: <span class='cmskillcur_ambushdirectedspells_ranks'>-</span>, Bonus: <span class='cmskillcur_ambushdirectedspells_bonus'>-</span>, Uses: <span class='cmskillcur_ambushdirectedspells_usecount'>-</span>/<span class='cmskillcur_ambushdirectedspells_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillambushmeleeranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ambushmelee'></span>
(<i>Current ranks: <span class='cmskillcur_ambushmelee_ranks'>-</span>, Bonus: <span class='cmskillcur_ambushmelee_bonus'>-</span>, Uses: <span class='cmskillcur_ambushmelee_usecount'>-</span>/<span class='cmskillcur_ambushmelee_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillambushrangedranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ambushranged'></span>
(<i>Current ranks: <span class='cmskillcur_ambushranged_ranks'>-</span>, Bonus: <span class='cmskillcur_ambushranged_bonus'>-</span>, Uses: <span class='cmskillcur_ambushranged_usecount'>-</span>/<span class='cmskillcur_ambushranged_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillambushshieldranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ambushshield'></span>
(<i>Current ranks: <span class='cmskillcur_ambushshield_ranks'>-</span>, Bonus: <span class='cmskillcur_ambushshield_bonus'>-</span>, Uses: <span class='cmskillcur_ambushshield_usecount'>-</span>/<span class='cmskillcur_ambushshield_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillambushunarmedranks' class='smallselect'></select>
  <span class='skillname' data-i18n='ambushunarmed'></span>
(<i>Current ranks: <span class='cmskillcur_ambushunarmed_ranks'>-</span>, Bonus: <span class='cmskillcur_ambushunarmed_bonus'>-</span>, Uses: <span class='cmskillcur_ambushunarmed_usecount'>-</span>/<span class='cmskillcur_ambushunarmed_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
 <select name='comp_cmskillconcealmentranks' class='smallselect'></select>
  <span class='skillname cmskillconcealment' data-i18n='concealment'></span>
(<i>Current ranks: <span class='cmskillcur_concealment_ranks'>-</span>, Bonus: <span class='cmskillcur_concealment_bonus'>-</span>, Uses: <span class='cmskillcur_concealment_usecount'>-</span>/<span class='cmskillcur_concealment_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskillstalkingranks' class='smallselect'></select>
  <span class='skillname cmskillstalking' data-i18n='stalking'></span>
(<i>Current ranks: <span class='cmskillcur_stalking_ranks'>-</span>, Bonus: <span class='cmskillcur_stalking_bonus'>-</span>, Uses: <span class='cmskillcur_stalking_usecount'>-</span>/<span class='cmskillcur_stalking_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
 <select name='comp_cmskilltrickeryranks' class='smallselect'></select>
  <span class='skillname cmskilltrickery' data-i18n='trickery'></span>
(<i>Current ranks: <span class='cmskillcur_trickery_ranks'>-</span>, Bonus: <span class='cmskillcur_trickery_bonus'>-</span>, Uses: <span class='cmskillcur_trickery_usecount'>-</span>/<span class='cmskillcur_trickery_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='technical'></span>
      <span class='category_cost'><span class='cmcategory-technical-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
 <select name='comp_cmskilllocksranks' class='smallselect'></select>
  <span class='skillname cmskilllocks' data-i18n='locks'></span>
(<i>Current ranks: <span class='cmskillcur_locks_ranks'>-</span>, Bonus: <span class='cmskillcur_locks_bonus'>-</span>, Uses: <span class='cmskillcur_locks_usecount'>-</span>/<span class='cmskillcur_locks_usecounttotal'>-</span></i>)</div>
<div class='cmskill'>
  <span class='skillname cmskillmechanics' data-i18n='mechanics'></span>
<div class='cmspecialization'>
 <select name='comp_cmskilloperationranks' class='smallselect'></select>
  <span class='skillname' data-i18n='operation'></span>
(<i>Current ranks: <span class='cmskillcur_operation_ranks'>-</span>, Bonus: <span class='cmskillcur_operation_bonus'>-</span>, Uses: <span class='cmskillcur_operation_usecount'>-</span>/<span class='cmskillcur_operation_usecounttotal'>-</span>)</i></div>
<div class='cmspecialization'>
 <select name='comp_cmskillrepairconstructionranks' class='smallselect'></select>
  <span class='skillname' data-i18n='repairconstruction'></span>
(<i>Current ranks: <span class='cmskillcur_repairconstruction_ranks'>-</span>, Bonus: <span class='cmskillcur_repairconstruction_bonus'>-</span>, Uses: <span class='cmskillcur_repairconstruction_usecount'>-</span>/<span class='cmskillcur_repairconstruction_usecounttotal'>-</span>)</i></div>
</div>
<div class='cmskill'>
 <select name='comp_cmskilltrapsranks' class='smallselect'></select>
  <span class='skillname cmskilltraps' data-i18n='traps'></span>
(<i>Current ranks: <span class='cmskillcur_traps_ranks'>-</span>, Bonus: <span class='cmskillcur_traps_bonus'>-</span>, Uses: <span class='cmskillcur_traps_usecount'>-</span>/<span class='cmskillcur_traps_usecounttotal'>-</span></i>)</div>
  </div>
  </div>
  <div class='cmcategory'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='vocation'></span>
      <span class='category_cost'><span class='cmcategory-vocation-cost'>?</span></span>
    </div>
  <div class='category_skills'>
<div class='cmskill'>
  <span class='skillname cmskilladministration' data-i18n='administration'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='vocation' data-skill='administration' data-specname='Administration'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskillservice' data-i18n='service'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='vocation' data-skill='service' data-specname='Service'>Add Specialization</button>
</div>
<div class='cmskill'>
  <span class='skillname cmskilltrade' data-i18n='trade'></span>
   <button type='action' name='act_specialization_add' class='fancybutton fancybuttoninline' data-cat='vocation' data-skill='trade' data-specname='Trade'>Add Specialization</button>
</div>
  </div>
  </div>

    </div>
    <div class='tab-panel'>
      <h2>Spells</h2>
      <div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellownbase'></span><span class='category_cost'><span class='cmcategory-spellownbase-cost'>??</span></span><span class='cmspelllistspellownbase'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellopen'></span><span class='category_cost'><span class='cmcategory-spellopen-cost'>??</span></span><span class='cmspelllistspellopen'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellclosed'></span><span class='category_cost'><span class='cmcategory-spellclosed-cost'>??</span></span><span class='cmspelllistspellclosed'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellotherbaseownrealm'></span><span class='category_cost'><span class='cmcategory-spellotherbaseownrealm-cost'>??</span></span><span class='cmspelllistspellotherbaseownrealm'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellopenother'></span><span class='category_cost'><span class='cmcategory-spellopenother-cost'>??</span></span><span class='cmspelllistspellopenother'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellclosedother'></span><span class='category_cost'><span class='cmcategory-spellclosedother-cost'>??</span></span><span class='cmspelllistspellclosedother'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='spellotherbaseother'></span><span class='category_cost'><span class='cmcategory-spellotherbaseother-cost'>??</span></span><span class='cmspelllistspellotherbaseother'></span></div></div><div class='cmcategory'><div class='category_head'><span class='spelllisttype' data-i18n='arcane'></span><span class='category_cost'><span class='cmcategory-arcane-cost'>??</span></span><span class='cmspelllistarcane'></span></div></div>nil
    </div>

    <div class='tab-panel'>
      <h2>Talents</h2>

      <button type='action' class='fancybuttoninline fancybutton' name='act_talent_add'>Purchase Talent</button>

      <div class='added_talents'></div>

    </div>


    <div class='tab-panel'>
      <h2>Training Packages</h2>

      <button type='action' class='fancybutton' name='act_dump_summary'>Dump Summary</button>

      <div class='tplist'></div>
    </div>


   
  </div>
</div>



  <button class="fancybutton" type="submit" value="levelupreview">Review</button>
  </div>
</charmancer>

<charmancer class="sheet-charmancer-levelupreview">
  <div>
     <h2>Level Up</h2>

<h3>Stat Gains</h3>

<div class='sheet-hack'>
  <div class='levelupreviewstatgains'> </div>
</div>

<h3>Skills</h3>

<div class='sheet-hack'>
  <div class='levelupreviewskills'> </div>
</div>

<h3>Spell Lists</h3>

<div class='sheet-hack'>
  <div class='levelupreviewspelllists'> </div>
</div>

<h3>Talents</h3>

<div class='sheet-hack'>
  <div class='levelupreviewtalents'> </div>
</div>




    <button class="fancybutton" type="back" value="levelup">Back (Level Up)</button>
    <button class="fancybutton" type="finish" value="levelup">Finish</button>
  </div>
</charmancer>




<charmancer class="sheet-charmancer-leveluprefesh">
  <div>
    <h1>Reloading...</h1>
  </div>
</charmancer>

<charmancer class="sheet-charmancer-final">
<div>
  <h2>Saving Character...</h2>

  <div class='choice message-save-profession'>Saving Profession Data</div>
  <div class='choice message-save-race'>Saving Race Data</div>
  <div class='choice message-save-culture'>Saving Culture Data</div>
  <div class='choice message-save-stats'>Saving Stats</div>
  <div class='choice message-save-knacks'>Saving Knacks and Profession Bonus</div>
  <div class='choice message-save-cultureranks'>Saving Culture Ranks</div>
  <div class='choice message-save-updateskills'>Updating Skills</div>
  <div class='choice message-save-updatefrontpage'>Updating Derived values</div>
  <div class='choice message-save-done'>Done</div>
</div>
</charmancer>



<charmancer class="sheet-repeating-specialization">
  <div class='cmspecialization'>
    <select name='comp_cmskillranks' required></select>
    <input name='comp_specname'>
    <input name='comp_sheetprefix' type='hidden'>
    <i class='skillinfo'></i> 
  </div>
</charmancer>


<charmancer class="sheet-repeating-statgain">
  <div class='cmstatgain'>
    Stat Gain (4DP)
    <select name='comp_name' class='select' required>
      <option value=''>Select...</option>
    </select>
    <button type='action' class='fancybuttoninline fancybutton' name='act_removeextrastatgame'>
    <span style="font-family:Pictos;">#</span>
    </button>
  </div>
</charmancer>




<charmancer class="sheet-repeating-spelllist">
  <div class='cmspelllist'>
    <select name='comp_cmranks'></select>
    <span name='comp_listname' class='comp_listname'></span>
    <input name='comp_listname' class='displayonly' readonly='readonly'>
    <input name='comp_listranks' type='text' class='small_number displayonly' readonly='readonly'>
  </div>
</charmancer>


<charmancer class="sheet-repeating-talent">
  <div class='cmtalent'>
    <select name='comp_talent'></select>
    <span class='choice talent_tier_show talent_inline'>
      <select name='comp_tier'></select>
    </span>
    <span class='choice talent_choice_show talent_inline'>
      <select name='comp_choice'></select>
    </span>
    <button type='action' style="float:right" name='act_deletetalent'>Remove</button>
    <br>

    <b>Cost: <span class='talent_cost'></span></b><br>
    <span class='talent_description'></span>
  </div>
</charmancer>

<charmancer class="sheet-repeating-levelupreviewlistitem">
  <span style="padding-left: 1em;" class='text'></span>
</charmancer>

<charmancer class="sheet-repeating-tpitem">
  <div>
    <p><b><span class='tpname'></span></b></p>

    <div style='display: grid;grid-template-columns: 2em 1fr'>
      <span name='comp_tphas0' class='tphas0'></span>
	    <span name='comp_tpskill0' class='tpskill0'></span>
      <span name='comp_tphas1' class='tphas1'></span>
	    <span name='comp_tpskill1' class='tpskill1'></span>
      <span name='comp_tphas2' class='tphas2'></span>
	    <span name='comp_tpskill2' class='tpskill2'></span>
      <span name='comp_tphas3' class='tphas3'></span>
	    <span name='comp_tpskill3' class='tpskill3'></span>
      <span name='comp_tphas4' class='tphas4'></span>
	    <span name='comp_tpskill4' class='tpskill4'></span>
      <span name='comp_tphas5' class='tphas5'></span>
	    <span name='comp_tpskill5' class='tpskill5'></span>
      <span name='comp_tphas6' class='tphas6'></span>
	    <span name='comp_tpskill6' class='tpskill6'></span>
      <span name='comp_tphas7' class='tphas7'></span>
	    <span name='comp_tpskill7' class='tpskill7'></span>
    </div>
  </div>
</charmancer>





<div class='rmusheet compendium-drop-target creature Creature'>
    
    <input name="attr_drop_name" type="hidden" accept="Name">
    <input name="attr_drop_category" type="hidden" accept="Category">
    <input name="attr_drop_data" type="hidden" accept="data">
    <input name='attr_drop_creature' type='hidden' accept='Creature'>



<input type='hidden'  class="sheet-toggle-skillchange" name="attr_toggleskillchange" value='false'>
<div class='overlay-skillchange'>
  <div class='skillchange'>

    <h2>Ranks</h2>

    <p>Change <span name='attr_specialization_change_skill'>Skill</span> to
	<input type='text' name='attr_specialization_change_name'>
    <hr>

    <button type='action' class='fancybutton' name='act_specializationsave'>Save</button>
    <button type='action' class='fancybutton' name='act_specializationcancel'>Cancel</button>
    </div>
</div>

<input type='checkbox' class='toggle' name='attr_toggletalentshow'>
<div class='overlay toggler'>
  <div class='editbox'>
    <h2>Add Talent</h2>

    <div style='display: grid; grid-template-columns: 10em 1fr'>
      <b>Name</b><input type='text' name='attr_talentaddname'>
      <b>Description</b><input type='text' name='attr_talentadddescription'>
    </div>

    <button type='action' class='fancybutton' name='act_talentaddsave'>Save</button>
    <button type='action' class='fancybutton' name='act_talentaddhide'>Cancel</button>
  </div>
</div>

<input type='checkbox' class='toggle' name='attr_togglejournaladdshow'>
<div class='overlay toggler'>
  <div class='editbox'>
    <h2>Add Journal Entry</h2>

    <div style='display: grid; grid-template-columns: 1fr 1fr'>
      
      <b>In Game Date</b><input type='text' name='attr_journaladdingamedate'>
      <b>Session Date</b><input type='text' name='attr_journaladdsessiondate'>
      <b>Title</b><input type='text' name='attr_journaladdtitle'>
      <b>Description</b><input type='text' name='attr_journaladddescription'>
      <b>XP</b><input type='number' name='attr_journaladdxp'>
    </div>

    <div class='buttonbar'>
      <button type='action' class='fancybutton' name='act_journaladdsave'>Save</button>
      <button type='action' class='fancybutton' name='act_journaladdcancel'>Cancel</button>
    </div>
  </div>
</div>

<input type='checkbox' class='toggle' name='attr_togglesleepinjuriesuntreatedshow'>
<div class='overlay toggler'>
  <div class='editbox'>
    <h2>Unable to Sleep</h2>

    <p><span name='attr_sleepinjuriesuntreatedmessage'></span></p>

    <div class='buttonbar'>
      <button type='action' class='fancybutton' name='act_statussleepcancel'>Ok</button>
    </div>
  </div>
</div>

<input type='checkbox' class='toggle' name='attr_togglesleepshow'>
<div class='overlay toggler'>
  <div class='editbox'>
    <h2>Sleep &amp; Rest</h2>

    <p>&nbsp;</p>

    <div style='display: grid; grid-template-columns: 1fr 1fr'>
      
      <b>Length:</b>
        <select name='attr_statussleephours'>
          <option value='1'>1 Hours</option><option value='2'>2 Hours</option><option value='3'>3 Hours</option><option value='4'>4 Hours</option><option value='5'>5 Hours</option><option value='6'>6 Hours</option><option value='7'>7 Hours</option><option value='8'>8 Hours</option><option value='9'>9 Hours</option><option value='10'>10 Hours</option><option value='11'>11 Hours</option><option value='12'>12 Hours</option><option value='13'>13 Hours</option><option value='14'>14 Hours</option><option value='15'>15 Hours</option><option value='16'>16 Hours</option><option value='17'>17 Hours</option><option value='18'>18 Hours</option><option value='19'>19 Hours</option><option value='20'>20 Hours</option><option value='21'>21 Hours</option><option value='22'>22 Hours</option><option value='23'>23 Hours</option><option value='24'>24 Hours</option>
        </select>

      <b>Full Rest:</b>
      <select class='fancyselect' name='attr_statussleepfullrest'>
          <option value="off">No</option>
          <option value="on">Yes (x2 Recovery)</option>
      </select>



      <span><b>Create Journal Entry</b></span>
      <span>
        <select class='fancyselect' name='attr_statussleepcreatejournal'>
          <option value="off">No</option>
          <option value="on">Yes</option>
        </select>
      </span>

      <input type='checkbox' class='toggle' name='attr_statussleepcreatejournal'>
      <div class='toggler subbox' style='width: 100%; grid-column: span 2;'>
        <div style='display: grid; grid-template-columns: 1fr 1fr'>
         <b class="toggler">In Game Date</b>
         <input class='toggler' type='text' name='attr_journaladdingamedate'>
         <b class="toggler">Session Date</b>
         <input class='toggler' type='text' name='attr_journaladdsessiondate'>
         <b class="toggler">Note</b>
         <input class='toggler' type='text' name='attr_statussleepjournalnote'>
        </div>
      </div>

    </div>

    <button type='action' class='fancybutton' name='act_statussleepsave'>Sleep</button>
    <button type='action' class='fancybutton' name='act_statussleepcancel'>Cancel</button>
  </div>
</div>



<input type='hidden'  class="toggle-editbox glass3d" name="attr_toggleeditbox" value='false'>
<div class='overlay-editbox'>
  <div class='editbox'>

    <h2>
      <input type='hidden' class='edit-name-toggle' name='attr_edit_caneditname'>
      <span name='attr_edit_title' class='noedit'>Edit</span>
      <input type='hidden' class='edit-name-toggle' name='attr_edit_caneditname'>
      <input type='text' class='doedit' name='attr_edit_title'>
    </h2>

    <div class='tabset'>
      <input type='radio' name='editbox' id='edittab1' checked>
	<label for='edittab1'>
        <span name='attr_editfirstname'>First</span></label>
      <input type='radio' name='editbox' id='edittab2'>
	<label for='edittab2'>
        <span name='attr_editsecondname'>Second</span></label>
      <input type='radio' name='editbox' id='edittab3'>
	<label for='edittab3'>
        <span name='attr_editthirdname'>Third</span></label>

      <div class='tab-panels'>
        <section id='editbox1' class='tab-panel'><h2><span name='attr_editfirstname'>first</span></h2><input type='hidden' name='attr_editfirstfield'><fieldset class='repeating_editfirst'><select name='attr_type'><option value='value'>Value (Adds or subtracts)</option><option value='message'>Message</option><option value='absolute'>Absolute (This value)</option></select><input type='text' name='attr_name'><input type='number' name='attr_number'></fieldset></section><section id='editbox2' class='tab-panel'><h2><span name='attr_editsecondname'>second</span></h2><input type='hidden' name='attr_editsecondfield'><fieldset class='repeating_editsecond'><select name='attr_type'><option value='value'>Value (Adds or subtracts)</option><option value='message'>Message</option><option value='absolute'>Absolute (This value)</option></select><input type='text' name='attr_name'><input type='number' name='attr_number'></fieldset></section><section id='editbox3' class='tab-panel'><h2><span name='attr_editthirdname'>third</span></h2><input type='hidden' name='attr_editthirdfield'><fieldset class='repeating_editthird'><select name='attr_type'><option value='value'>Value (Adds or subtracts)</option><option value='message'>Message</option><option value='absolute'>Absolute (This value)</option></select><input type='text' name='attr_name'><input type='number' name='attr_number'></fieldset></section>
      </div> 

      <input type='checkbox'  class="toggle" name="attr_edit_candelete">
      <button type='action' class='fancybutton fancywarning toggler' name='act_edit_skill_delete'>Delete</button>
      <button type='action' class='fancybutton' name='act_edit_skill_save'>Save</button>
      <button type='action' class='fancybutton' name='act_edit_skill_cancel'>Cancel</button>
    </div> 
  </div> 
</div>

<input type='checkbox'  class='toggle' name='attr_togglenpcupload'>
<div class='overlay toggler'>
  <div class='editbox'>
    <h2>Upload NPC</h2>

    <p>Upload an NPC or Creature from an NPC or creature generator.  Note this <em>replaces</em> this current
    character.  Don't do it on your PC sheet.</p>

    <p>Paste the JSON file belown and click <em>Upload NPC</em></p>
    <textarea name='attr_customlistupload'></textarea>
    <button type='action' name='act_uploadnpccancel' class='fancybutton'>Cancel</button>
    <button type='action' name='act_uploadspelllist' class='fancybutton'>Upload</button>
    Message: <span name='attr_uploadspelllistmessage'></span>
  </div>
</div>




<input type='hidden' name='attr_sheetselect' class='sheetselect'>
<div class='creaturesheet'>

<div style='float:right'>
  <select name='attr_whispertype' class='fancyselect'>
    <option value=''>Public</option>
    <option value='/w gm'>GM Only</option>
  </select>
</div>

<div style='float:right'>
  Power Level:
  <select name='attr_powerlevel' class='fancyselect'>
    <option value='average'>Average</option>
    <!--
    <option value='superior'>Superior</option>
    <option value='heroic'>Heroic</option>
    <option value='legendary'>Legendary</option>
    <option value='epic'>Epic</option>-->
  </select>
  <span style='margin:1ex'></span>
</div>


<h1 class='creaturetitle'><span name='attr_character_name'>Creature</span></h1>

<br style='clear: both'>

<div class='creature-multicolumn'>
<div class='creaturestats pcframebox'>
  <span class='creatureheading'>Stats</span>

  <div class='creaturegrid5'>
  <span>Ag</span><span>Co</span><span>Em</span><span>In</span><span>Me</span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_ag'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_ag'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_co'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_co'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_em'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_em'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_in'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_in'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_me'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_me'></span><span>Pr</span><span>Qu</span><span>Re</span><span>SD</span><span>St</span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_pr'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_pr'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_qu'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_qu'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_re'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_re'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_sd'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_sd'></span><span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_st'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_st'></span>
  </div>

</div>

<div class='creaturedefenses pcframebox'>
  <span class='creatureheading'>Defenses</span>

  <span>Level</span> 
  <span style="display: flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_level'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_level'></span>

  <span>AT (DB)</span>
  <span class='edittogglegroup'>
    <input type='checkbox' class='edittoggle'>
    <span class='edittext'>
      <span name='attr_at'></span>
      (<span name='attr_db'></span>)
    </span>
    <span class='editactive'>
      <select class='fancyselect' name='attr_at'>
        <option value='1'>AT 1</option><option value='2'>AT 2</option><option value='3'>AT 3</option><option value='4'>AT 4</option><option value='5'>AT 5</option><option value='6'>AT 6</option><option value='7'>AT 7</option><option value='8'>AT 8</option><option value='9'>AT 9</option><option value='10'>AT 10</option>
      </select>
      Base DB: <input type='number' name='attr_db_base'>
    </span>
  </span>

  <span>Crit Reduction</span>
  <span>
    <span name='attr_critreduction'></span>
    <span name='attr_critresist'></span>
    <span name='attr_critimmune'></span>
  </span>
  <span>Size</span>
  <span name='attr_size'></span>
  <span>Hits (Scaled)</span>
  <span class='edittogglegroup'>
    <input type='checkbox' class='edittoggle'>
    <span class='edittext'>
      <span name='attr_hits'></span>
      (<span name='attr_scaledhits'></span>)
    </span>
    <span class='editactive'>
      <input type='number' name='attr_hits'>
    </span>
  </span>
  <span>PP</span>
  <span name='attr_pp_max'></span>
  
  <span>Initiative</span>
  <span>
    <span name='attr_initiative'></span>
    <button type='action' name='act_rollinitiative' class='editbutton rollbutton'><span class='diced10'>0</span></button>
  </span>


</div>

<div class='creaturerrs pcframebox'>
  <span class='creatureheading'>RRs</span>
   <span>Arcane</span> <span><span name='attr_rr_arcane_bonus'></span>
                            <button type='action' data-rr='arcane' data-rrpretty='Arcane' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
          </span>
    <span>Channeling</span> <span><span name='attr_rr_channeling_bonus'></span>
                            <button type='action' data-rr='channeling' data-rrpretty='Channeling' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
                            </span>
    <span>Essence</span> <span><span name='attr_rr_essence_bonus'></span>
                            <button type='action' data-rr='essence' data-rrpretty='Essence' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
                            </span>
    <span>Mentalism</span> <span><span name='attr_rr_mentalism_bonus'></span>
                            <button type='action' data-rr='mentalism' data-rrpretty='Mentalism' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
                            </span>
    <span>Physical</span> <span><span name='attr_rr_physical_bonus'></span>
                            <button type='action' data-rr='physical' data-rrpretty='Physical' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
                            </span>
    <span>Fear</span>     <span><span name='attr_rr_fear_bonus'></span>
                            <button type='action' data-rr='fear' data-rrpretty='Fear' class='editbutton rollbutton'
                                name='act_rrroll'><span class="diced10">0</span></button>
                            </span>
</div>


<div>
    <div class='foe fancybox'>

      <span style='grid-column: span 1'>
        Target:
      </span>
      <span name='attr_target_name' style='grid-column: span 2'></span>
      <span>
        <button type='action' name='act_rmuattackgettarget'
                  class='rollbutton fancybutton fancybuttoninline'>Select</button>
        <button type='action' name='act_rmuattacktargetrefresh'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">1</span></button>
        <button type='action' name='act_rmuattacktargetdelete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>

      <span class='foe_target_db'>
        DB
      </span>
      <input type='number' name='attr_target_db'>
      <span class='foe_target_at'>
        AT
      </span>
      <input type='text' style='width: 100%' name='attr_target_at' 
  	pattern="\d|10|((\d,|10,){3}(\d|10))"
        title='Use AT of target (1-10) or 4 ATs separated by commas'>
      <span>Size</span>
      <select style='width:100%' class='fancyselect' name='attr_target_size'>
        <option value="1">Miniscule</option>
        <option value="2">Diminutive</option>
        <option value="3">Tiny</option>
        <option value="4">Small</option>
        <option value="5">Medium</option>
        <option value="6">Big</option>
        <option value="7">Large</option>
        <option value="8">Huge</option>
        <option value="9">Gigantic</option>
        <option value="10">Enormous</option>
        <option value="11">Immense</option>
        <option value="12">Behemoth</option>
        <option value="13">Leviathan</option>
      </select>
      <span>Crit. Red.</span>
      <select style='width:100%' class='fancyselect' name='attr_target_crit'>
        <option value="0">None</option>
        <option value="1">I</option>
        <option value="2">II</option>
        <option value="3">III</option>
      </select>
    </div>




</div>

<div class='creatureattacks pcframebox'>
  <span class='creatureheading'>Attacks</span><br>

  <span>Parry <input type='number' name='attr_parrymod' min='0' step='1'></span>
  <span>Mod <input type='number' name='attr_othermod' step='1'></span>

  <!--  -->
  <fieldset class='repeating_creatureattack'>
    <span style='display:flex"'>
      <input type='checkbox' class='edittoggle'>
      <span class='edittext'> 
        <span name='attr_ob'></span>
        <span name='attr_attacksizedisplay'></span>
        <span name='attr_attackname'></span>
        <span name='attr_notes'></span>

        <input type='hidden' name='attr_attackersize'>
        <button type='action' class='fancybutton' name='act_creaturemakeattack'>Attack!</button>
      </span>
      
      <span class='editactive'>
        <input type='number' name='attr_ob'>
        <select class='fancyselect' name='attr_attacksize'>
          <option value="1">Miniscule</option>
          <option value="2">Diminutive</option>
          <option value="3">Tiny</option>
          <option value="4">Small</option>
          <option value="5">Medium</option>
          <option value="6">Big</option>
          <option value="7">Large</option>
          <option value="8">Huge</option>
          <option value="9">Gigantic</option>
          <option value="10">Enormous</option>
          <option value="11">Immense</option>
          <option value="12">Behemoth</option>
          <option value="13">Leviathan</option>
        </select>
        <select class='fancyselect' name='attr_type'>
        <option value='ss'>Short Sword</option><option value='fbo'>Fire Bolt</option><option value='qs'>Quarterstaff</option><option value='sw'>Sweep</option><option value='rw'>Arming Sword</option><option value='ibo'>Ice bolt</option><option value='ts'>Two Handed Sword</option><option value='ro'>Thrown Rock</option><option value='hf'>Heavy Flail</option><option value='wi'>Whip</option><option value='any'>Arming Sword</option><option value='si'>Stinger</option><option value='cr'>Crush</option><option value='lbo'>Ligtning Bolt</option><option value='lc'>Light Crossbow</option><option value='ra'>Ram</option><option value='gr'>Grapple</option><option value='ta'>Thrown Hand Axe</option><option value='bx'>Battle Axe</option><option value='tr'>Trample</option><option value='ma'>Mace</option><option value='we'>Arming Sword</option><option value='tc'>Two Handed Club</option><option value='ja'>Javelin</option><option value='hx'>Hand Axe</option><option value='lba'>Lightning Ball</option><option value='wm'>War Mattock</option><option value='fa'>Falchion</option><option value='tx'>Two Handed Axe</option><option value='bi'>Bite</option><option value='all'>Arming Sword</option><option value='ebo'>Earth Ball</option><option value='px'>Pole Axe</option><option value='da'>Dagger</option><option value='cba'>Cold Ball</option><option value='un'>Unarmed Strike</option><option value='rp'>Rapier</option><option value='sp'>Spear</option><option value='tp'>Thrown Spear</option><option value='tw'>War Hammer</option><option value='sl'>Sling</option><option value='cl'>Claw</option><option value='hc'>Heavy Crossbow</option><option value='wbo'>Water Bolt</option><option value='bs'>Broadsword</option><option value='as'>Arming Sword</option><option value='sc'>Scimitar</option><option value='ho'>Horn</option><option value='sb'>Bow, Short</option><option value='rt'>Thrown Rock</option><option value='fba'>Fire ball</option><option value='td'>Thrown Dagger</option><option value='cu'>Club</option><option value='bo'>Bola</option><option value='lb'>Bow, Long</option><option value='sh'>Shield Bash</option><option value='handcrossbow'>Hand Crossbow</option><option value='be'>Beak</option><option value='ls'>Long Sword</option>
        </select>
          

      </span>
    </span>

  </fieldset>

</div>

<div class='creaturemove pcframebox'>
  <span class='creatureheading'>Movement</span>

  <fieldset class='repeating_creaturemove'>
    <span name='attr_type'></span>
    (Max <span name='attr_pace'></span>)
    <span><span name='attr_bmr'></span>'/rnd</span>
 </fieldset>

</div>

<div class='creatureactions pcframebox'>
  <span class='creatureheading'>Actions</span>

  




  
  <div class='actionblock grid4' style='position:relative'>
    <div class='span2'>
      <select name='attr_actionselect' class='fancyselect'>
        <option value='melee'>Melee</option>
        <option value='missile'>Missile</option>
        <option value='spell'>Spell</option>
        <option value='perception'>Perception</option>
        <option value='eat'>Eat</option>
        <option value='stand'>Stand</option>
        <option value='pickup'>Pickup Item</option> 
        <option value='mount'>Mount</option> 
        <option value='dismount'>Dismount</option> 
        <option value='stringbow'>String Bow</option> 
        <option value='loadlight'>Load Light Xbow</option> 
        <option value='loadheavy'>Load Heavy Xbox</option> 
        <option value='fulldodge'>Full Dodge</option> 
        <option value='fullblock'>Full Block</option> 
        <option value='picklock '>Pick Lock</option> 
        <option value='other'>Other</option>
      </select>
    </div>

    <!-- Now the checkboxes -->
    <div class='span2'>
      <input type='checkbox' name='attr_aptracktoggleloaded' class='toggle'>
      <span class='toggler'>
        Loaded: <input name='attr_aptrack_loaded' class='toggler' type='checkbox'>
      </span>
      <div class='xtoggler'>
        <div class='aptrackerbox'><input checked='checked' class='aptrack reset' type='radio' name='attr_aptrackcreature' value='0'><input type='checkbox' name='attr_aptracktoggle1' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='1'><input type='checkbox' name='attr_aptracktoggle2' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='2'><input type='checkbox' name='attr_aptracktoggle3' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='3'><input type='checkbox' name='attr_aptracktoggle4' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='4'><input type='checkbox' name='attr_aptracktoggle5' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='5'><input type='checkbox' name='attr_aptracktoggle6' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='6'><input type='checkbox' name='attr_aptracktoggle7' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='7'><input type='checkbox' name='attr_aptracktoggle8' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='8'><input type='checkbox' name='attr_aptracktoggle9' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='9'><input type='checkbox' name='attr_aptracktoggle10' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='10'><input type='checkbox' name='attr_aptracktoggle11' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='11'><input type='checkbox' name='attr_aptracktoggle12' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='12'><input type='checkbox' name='attr_aptracktoggle13' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='13'><input type='checkbox' name='attr_aptracktoggle14' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='14'><input type='checkbox' name='attr_aptracktoggle15' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='15'><input type='checkbox' name='attr_aptracktoggle16' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='16'><input type='checkbox' name='attr_aptracktoggle17' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='17'><input type='checkbox' name='attr_aptracktoggle18' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='18'><input type='checkbox' name='attr_aptracktoggle19' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='19'><input type='checkbox' name='attr_aptracktoggle20' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrackcreature' value='20'></div>

      </div>

    </div>

    <div class='double'>Concentration</div> 

    <div>
      <input name='attr_aptrack_concentration' type='checkbox'>
      
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev1'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev2'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev3'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <!--
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev4'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span> -->
    </div>

    <div class='span2'>Free Used
      <input name='attr_aptrack_freeused' type='checkbox'>
    </div>
    <div>AP/Phase</div>
    <div>
      <select name='attr_actionapperphase' style='width:100%' class='fancyselect'>
        <option value='1'>1AP</option>
        <option value='2'>2AP</option>
        <option value='4'>4AP</option>
      </select>
    </div>
    <div>Round <span name='attr_currentphasedisplay'></span></div>
    <div><button type='action' name='act_endphase' class='fancybutton fancybuttoninline'>End</button></div>
  </div> <!-- div.actionblock -->
<!--
  <div class='grid4'>
    <div>Defense</div>
    <div style='grid-column: span 2'>
      <select name='attr_activedefense' class='fancyselect' style='width:90%;'>
        <option value='passive'>Passive</option>
        <option value='partialblock'>Partial Block</option>
        <option value='partialdodge'>Partial Dodge</option>
        <option value='fullblock'>Full Block</option>
        <option value='fulldodge'>Full Dodge</option>
      </select>
    </div>
    <div>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
        <span name='attr_activedb_info' class='stat_info'></span>
      </span>
      DB <span name='attr_activedb'></span>
    </div>
  </div>
-->



  Defense <select name='attr_creaturedefense' class='creaturedefense fancyselect'></select>
</div>

<div class='creaturestatus pcframebox'>
  <span class='creatureheading'>Status</span>

  

    <div class='prop_pair'>
      <span>Status</span>
      <span>
        <span name='attr_statusmessage'>Okay</span>
      </span>
    </div>


    
    <input type='hidden' name='attr_statusstagger' class='hidenext'>
    <div class='prop_pair'>
      <span>Staggered</span>
      <span>
        <span name='attr_statusstagger'>0</span> AP
      </span>
    </div>
    <input type='hidden' name='attr_statusstun75' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -75</span>
      <span><span name='attr_statusstun75info'>0</span> Rounds
        <button type='action' name='act_statusstun75delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>

    </div>
    <input type='hidden' name='attr_statusstun50' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -50</span>
      <span><span name='attr_statusstun50info'>0</span> Rounds
        <button type='action' name='act_statusstun50delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>
    </div>
    <input type='hidden' name='attr_statusstun25' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -25</span>
      <span><span name='attr_statusstun25info'>0</span> Rounds
        <button type='action' name='act_statusstun25delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>
    </div>

    <div class='prop_pair'>
      <span>
        <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_hp_info' class='stat_info'></span> 
        <b>Hits (HP)</b>
      </span>
      <span>
        <input type='number' name='attr_hp'> / <span name='attr_hp_max'></span><br>
      </span>
      <span></span>
      <div>
        
        <input type="hidden" class="bar-value" name="attr_hp_percent" value="100">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>
    </div>

    <input type='hidden' name='attr_hppenalty' class='hidenext'>
    <div class='prop_pair'>
      <span>Hits Penalty:</span>
        <span name='attr_hppenalty'></span>
    </div>

    <input type='hidden' name='attr_bleeding' class='hidenext'>
    <div class='prop_pair'>
      <span>Bleed</span>
      <span>
        <span name='attr_bleeding'></span> / round
        <button type='action' class='fancybuttoninline fancybutton' name='act_deletebleed'>
          <span style="font-family:Pictos;">#</span></button>
      </span>

    </div>

    <div class='prop_pair'>
      <span>Injury Penalty:</span>
      <span>
        <input type='number' name='attr_injurypenalty'>
        <button type='action' class='fancybuttoninline fancybutton' name='act_refreshinjurypenalty'>
          <span style="font-family:Pictos;">1</span></button>
      </span>
    </div>

    
    <div class='prop_pair'>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_endurance_info' class='stat_info'></span> 
        Endurance:
      </span>
      <span>
        <button type='action' class='rollbutton fancybutton fancybuttoninline' name='act_enduranceroll'>
          <span class='diced10'>0</span>
          <span name='attr_endurance'></span>
          </button>
      </span>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_mentalendurance_info' class='stat_info'></span>
        Mental Endurance:
      </span>
      <span>
      <button type='action' class='rollbutton fancybutton fancybuttoninline' name='act_mentalfatigueroll'>
          <span class='diced10'>0</span>
          <span name='attr_mentalendurance'></span>
      </button>
      </span>

      <span>Fatigue:</span>
      <span> <input type='number' name='attr_fatigue'></span>
    </div>

    <div class='prop_pair'>
      <span>Status Penalty:</span>
      <span name='attr_statuspenalty'></span>
    </div>


     <div class='prop_pair'>
      <span>Total Penalty:</span>
      <div>
        <span name='attr_allpenalties'></span><br>
        <div>
          
          <input type="hidden" class="bar-value" name="attr_statuspercent" value="100">
          <div class="bar-track"> <div class="bar-progress"></div> </div>
        </div>
      </div>
    </div>



    <hr>

    <div class='prop_pair'>
      <span><b>PP</b></span>
      <span>
        <input type='number' name='attr_pp'> /
        <span name='attr_pp_max'></span>
      </span>
      <span></span>
      <div>
        
        <input type="hidden" class="bar-value" name="attr_pp_percent" value="100">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>

    </div>

    <div class='prop_pair'>
      <span>
        <button type='action' name='act_rollinitiative' class='fancybutton'>Initative
          <span name='attr_initiative'></span>
        </button>
        <!-- span class='iconwrap'><span class='prop_prop_plain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></span></span-->
      </span>
      <span class='prop_value'>
        <button name='act_newcombat' type='action' class='fancybuttoninline fancybutton'>
            New Combat</button>
      </span>
    </div>






      <button class='fancybuttoninline fancybutton' type='action' name='act_rollfumble'>
          <span style="font-family:Pictos Three;">l</span>Table Roll</button>

</div>

<div class='creatureskills pcframebox'>
  <span class='creatureheading'>Skills</span>
  <fieldset class='repeating_creatureskill'>
    <span class='textnowrap'>
      <button type='action' class='editbutton rollbutton'
                                  name='act_creatureskillroll'>
        <span name='attr_name'></span>
      </button>
      <button type='action' class='editbutton rollbutton'
                                  name='act_creatureskillrollmod'>
        <span name='attr_bonus'></span>
      </button>
    </span>
  </fieldset>
</div>


<div class='creatureskills pcframebox'>
  <span class='creatureheading'>Talents</span>
  <fieldset class='repeating_creaturetalent'>
    <b><span name='attr_group'></span></b>
    <span name='attr_talent'></span><br>
  </fieldset>
</div>

<div class='creaturehacks pcframebox'>
  <span class='creatureheading'>Injuries</span>

  <p>Apply an injury.<br>
  <b>H</b>its, <b>P</b>enalty, <b>F</b>atigue, <b>B</b>leed, <b>S</b>taggered,
  p<b>R</b>one, <b>K</b>nockback, <b>G</b>rappled, Q/W/E Stun 25/50/75,
  <b>L</b>ocation (1 head, 2, chest, 3 arms, 4 leg) and side (<b>O</b>) (1 Left, 2 right).
  <b>Z</b> ends.
  </p>

  <input type='text' name='attr_hackinjury'>
  <button type='action' name='act_applyinjuryhack' class='fancybutton'>Apply Injury</button>
</div>

<div class='creaturespells pcframebox'>
  <span class='creatureheading'>Spells</span>
  <fieldset class='repeating_creaturespell'>
    <span name='attr_name'></span>
    <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button>
    <button type='action' class='editbutton rollbutton' name='act_creatureskillroll'>
      (<span name='attr_scr'></span>)
      <span name='attr_ranks'></span>
      <span class="diced10">0</span>
    </button>
  </fieldset>
</div>

<div class='creaturenotes pcframebox'>
  <span class='creatureheading'>Notes</span>

</div>

<hr>

</div> 
</div> 



<input type='hidden' name='attr_sheetselect' class='sheetselect'>
<div class='trackersheet'>

  <h1>Oh my god; it's a tracker!</h1>
  
  <button type='action' name='act_trackedreturntocharacter' class='fancybutton'>Revert to Character</button>

  <!-- Toolbar -->
  <div class='fancybox'>
    <button type='action' name='act_trackeraddcreature' class='fancybutton'>Add</button>
    <!--
    <button type='action' name='act_trackerrefreshall' class='fancybutton disabled'>Refresh All</button>
    -->
    <select class='fancyselect' name="attr_apperphase"> 
      <option value="1">1 AP/Phase</option>
      <option value="2">2 AP/Phase</option>
      <option value="4">4 AP/Phase</option>
    </select>
    <button type='action' name='act_trackerrollinitiative' class='fancybutton'>Initiative</button>
  </div>


  <div class='tracked'>

  </div>

<fieldset class='repeating_trackercharacter'>
  <div class="pcframebox">
    <img alt="Token" class='avatar' name="attr_character_token">
    <span name="attr_character_name"></span>
    <span name="attr_hp"></span>
    <span name="attr_hp_max"></span>
    <div>
        <input type="hidden" class="bar-value" name="attr_hp_percent" value="0">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>
    <span name="attr_pp"></span>
    <span name="attr_pp_max"></span>
    <div>
        <input type="hidden" class="bar-value" name="attr_pp_percent" value="0">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>

        
<select name="attr_actionselect" class="fancyselect">
        <option value="melee">Melee</option>
        <option value="missile">Missile</option>
        <option value="spell">Spell</option>
        <option value="perception">Perception</option>
        <option value="eat">Eat</option>
        <option value="stand">Stand</option>
        <option value="pickup">Pickup Item</option> 
        <option value="mount">Mount</option> 
        <option value="dismount">Dismount</option> 
        <option value="stringbow">String Bow</option> 
        <option value="loadlight">Load Light Xbow</option> 
        <option value="loadheavy">Load Heavy Xbox</option> 
        <option value="fulldodge">Full Dodge</option> 
        <option value="fullblock">Full Block</option> 
        <option value="picklock ">Pick Lock</option> 
        <option value="other">Other</option>
      </select>

        <button type='action' name='act_deletetracked' class='fancybutton fancybuttoninline'>
          <span style="font-family:Pictos;">#</span>
        </button>

        Chan <span name='attr_rr_channeling_bonus'></span>;
        Ess <span name='attr_rr_essence_bonus'></span>;
        Ment <span name='attr_rr_mentalism_bonus'></span>;
        Arcane <span name='attr_rr_arcane_bonus'></span>;
        Fear<span name='attr_rr_fear_bonus'></span>; 
        Phys <span name='attr_rr_physical_bonus'></span>;


        AT (DB) <span name="attr_at"></span><span name="attr_activedb"></span>


        Parry <span name="attr_parry_mod"></span>
        Other <span name="attr_other_mod"></span>
        DB Mod <span name="attr_dbmod"></span>

        Last Init: <span name='attr_lastinitiative'></span>

  </div>
</fieldset>


  <fieldset class='repeating_trackercharacterX'>
    <div class='trackedcharacter pcframebox'>
      <div class='trackedname span2'>
        <span name='attr_trackedname'></span>
        <span name='attr_tokenid'></span>
        <span name='attr_characterid'></span>
        <button type='action' name='act_deletetracked' class='fancybutton fancybuttoninline'>
          <span style="font-family:Pictos;">#</span>
        </button>
        <button type='action' name='act_trackedrefresh'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">1</span>
        </button>
      </div>
  
      <div class='span2'>
        <select name='attr_trackedaction' class='fancyselect'>
          <option value='melee'>Melee</option>
          <option value='missile'>Missile</option>
          <option value='spell'>Spell</option>
          <option value='perception'>Perception</option>
          <option value='eat'>Eat</option>
          <option value='stand'>Stand</option>
        </select>
   
        <input name='attr_trackedap' value='1' type='radio'>
        <input name='attr_trackedap' value='2' type='radio'>
        <input name='attr_trackedap' value='3' type='radio'>
        <input name='attr_trackedap' value='4' type='radio'>

        Free <input name='attr_trackedfreeaction' type='checkbox'>
        Conc <input name='attr_trackedconcentration' type='checkbox'>
      </div>

      <div class='span2'>
        <span>
          <span name='attr_trackedmove0name'></span>
          <span name='attr_trackedmove0pace'></span>
          <span name='attr_trackedmove0rate'></span>
        </span>
        <span>
          <span name='attr_trackedmove1name'></span>
          <span name='attr_trackedmove1pace'></span>
          <span name='attr_trackedmove1rate'></span>
        </span>
        <span>
          <span name='attr_trackedmove2name'></span>
          <span name='attr_trackedmove2pace'></span>
          <span name='attr_trackedmove2rate'></span>
        </span>
        <span>
          <span name='attr_trackedmove3name'></span>
          <span name='attr_trackedmove3pace'></span>
          <span name='attr_trackedmove3rate'></span>
        </span>
      </div>

      <div class='span3'>
        <select name='attr_trackedattack' class='fancyselect'>
          <option value='s'>55Mcl</option>
        </select>

        Parry: <input type='number' name='attr_trackedparrymod' min='0' step='1'> 
        Mod: <input type='number' name='attr_trackedothermod' step='1'> 
      
        <button type='action' name='act_trackeddoattack' class='fancybuttoninline fancybutton'>
          Attack!
        </button>
      </div>

      <div class='span1'>
        <button type='action' name='act_selecttarget'>Target</button>
        <span name='attr_target_name'>X</span>
        <span name='attr_target_name'>X</span>
        <span name='attr_target_at'>X</span>
        <span name='attr_target_db'>X</span>
        <span name='attr_target_size'>X</span>
        <span name='attr_target_crit'>X</span>
      </div>

      <div class='span1'>
        <span name='attr_trackedstatusmessage'></span>
      </div>

      <!-- Skills -->
      <div class='span4'>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill0skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill1skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill2skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill3skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill4skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill5skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill6skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill7skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill8skillname'></span> </button>
        <button class='textbutton' name='act_trackerrollskill' type='action'>
          <span name='attr_trackedskill9skillname'></span> </button>
      </div>

      <div class='span2'>
        Chan <span name='attr_rr_channeling_bonus'></span>;
        Ess <span name='attr_rr_essence_bonus'></span>;
        Ment <span name='attr_rr_mentalism_bonus'></span>;
        Fear<span name='attr_rr_fear_bonus'></span>; 
        Phys <span name='attr_rr_physical_bonus'></span>;
      </div>

      <div class='spanall'>
        <span>
          <input type='text' name='attr_trackednotes' class='trackednotes'> 
        </span>
      </div>
    </div>
  </fieldset>


</div>

<!---->





    <input type='hidden' name='attr_attackaddshow' class='attackaddshow'>
    <div class='attackadd overlay'>
      <div class="attackaddcontent skillchange">
       
      <div><b>Attack Name</b></div> <input type='text' name='attr_attackaddname'>
      <div><b>Attack Skill</b></div>
        <select name='attr_attackaddskill' class='fancyselect'>
          <option value="beak">Beak</option>
          <option value="bite">Bite</option>
          <option value="blade">Blade</option>
          <option value="bow">Bow</option>
          <option value="chain">Chain</option>
          <option value="claw">Claw</option>
          <option value="crossbow">Crossbow</option>
          <option value="elementalbolts">Elemental Bolts</option>
          <option value="meleeexotic">Exotic (Melee)</option>
          <option value="rangedexotic">Exotic (Ranged)</option>
          <option value="greaterblade">Greater Blade</option>
          <option value="greaterchain">Greater Chain</option>
          <option value="greaterhafter">Greater Hafted</option>
          <option value="hafted">Hafted</option>
          <option value="horn">Horn</option>
          <option value="illusionaryattacks">Illusionary Attacks</option>
          <option value="none">None</option>
          <option value="polearm">Pole Arm</option>
          <option value="ram">Ram</option>
          <option value="shield">Shield</option>
          <option value="sling">Sling</option>
          <option value="stinger">Stinger</option>
          <option value="strikes">Strikes</option>
          <option value="sweepsthrows">Sweeps &amp; Throws</option>
          <option value="trample">Trample</option>
          <option value="thrown">Thrown</option>
          <option value="wrestling">Wrestling</option>
          <option value="hurling">Hurling</option>
        </select>
      <div><b>Table</b></div>
        <select name="attr_attackaddtable" class='fancyselect'>
          <option value="Arming Sword">Arming Sword</option>
          <option value="Ball, Cold">Ball, Cold</option>
          <option value="Ball, Fire">Ball, Fire</option>
          <option value="Ball, Lightning">Ball, Lightning</option>
          <option value="Battle Axe">Battle Axe</option>
          <option value="Beak">Beak</option>
          <option value="Bite">Bite</option>
          <option value="Bola">Bola</option>
          <option value="Bolt, Fire">Bolt, Fire</option>
          <option value="Bolt, Ice">Bolt, Ice</option>
          <option value="Bolt, Lightning">Bolt, Lightning</option>
          <option value="Bolt, Shock">Bolt, Shock</option>
          <option value="Bolt, Water">Bolt, Water</option>
          <option value="Bow, Long">Bow, Long</option>
          <option value="Bow, Short">Bow, Short</option>
          <option value="Broadsword">Broadsword</option>
          <option value="Claw">Claw</option>
          <option value="Club">Club</option>
          <option value="Crossbow">Crossbow</option>
          <option value="Crush">Crush</option>
          <option value="Dagger">Dagger</option>
          <option value="Falchion">Falchion</option>
          <option value="Fighting Stick">Fighting Stick</option>
          <option value="Flail">Flail</option>
          <option value="Grapple">Grapple</option>
          <option value="Horn">Horn</option>
          <option value="Mace">Mace</option>
          <option value="Ram">Ram</option>
          <option value="Rapier">Rapier</option>
          <option value="Rock">Rock</option>
          <option value="Scimitar">Scimitar</option>
          <option value="Shield">Shield</option>
          <option value="Sling">Sling</option>
          <option value="Spear">Spear</option>
          <option value="Stinger">Stinger</option>
          <option value="Trample">Trample</option>
          <option value="Unarmed Strike">Unarmed Strike</option>
          <option value="Unarmed Sweeps">Unarmed Sweeps</option>
          <option value="War Hammer">War Hammer</option>
          <option value="Whip">Whip</option>
        </select>
      <div><b>Size</b></div>
        <select name="attr_attackaddsize" class='fancyselect'>
          <option value="1">Miniscule</option>
          <option value="2">Diminutive</option>
          <option value="3">Tiny</option>
          <option value="4">Small</option>
          <option value="5">Medium</option>
          <option value="6">Big</option>
          <option value="7">Large</option>
          <option value="8">Huge</option>
          <option value="9">Gigantic</option>
          <option value="10">Enormous</option>
        </select>
      <div><b>Type</b></div>
        <select name='attr_attackaddtype' class='fancyselect'>
          <option value='melee'>Melee</option>
          <option value='ranged'>Ranged</option>
          <option value='directed'>Directed Spell</option>
          <option value='other'>Other (No AP tracking)</option>
        </select>
      <div><b>Two Handed</b></div>
        <select name='attr_attackaddhands' class='fancyselect'>
          <option value='one'>One hand</option>
          <option value='two'>Two hand</option>
        </select>
      <div><b>After attack</b></div>
        <select name='attr_attackaddafter' class='fancyselect'>
          <option value='nothing'>Do Nothing</option>
          <option value='clearap'>Clear AP</option>
          <option value='endturn'>Clear AP &amp; End Turn</option>
        </select>
      <div><b>Fumble</b></div><input type='number' name='attr_attackaddfumble'>
      <div><b>Modifier</b></div>
      <input type='number' name='attr_attackaddmodifier'>
      <div><b>Range Increment</b> (0 for none)</div>
      <input type='number' name='attr_attackaddri'>
      <div><b>Strength</b></div>
        <input type='number' name='attr_attackaddstrength'>
      <div><b>Critical Adjust</b></div>
        <select name="attr_attackaddcritadjust" class='fancyselect'>
          <option value="-2">2 Smaller (-2)</option>
          <option value="1">1 Smaller (-1)</option>
          <option value="0">Normal</option>
          <option value="1">1 Larger (+1)</option>
          <option value="2">2 Larger (+2)</option>
        </select>

      <div><b>Material</b></div>
<label class='plainlabel'><input type='checkbox' name='attr_attackaddmaterialc'>Crystalline (c)</label><label class='plainlabel'><input type='checkbox' name='attr_attackaddmaterialw'>Wood (w)</label><label class='plainlabel'><input type='checkbox' name='attr_attackaddmaterials'>Silver (s)</label><label class='plainlabel'><input type='checkbox' name='attr_attackaddmateriali'>Raw Iron (i)</label><label class='plainlabel'><input type='checkbox' name='attr_attackaddmaterialm'>Magic (m)</label>

    <div>
      <label class='plainlabel'>
        <input type='checkbox' name='attr_attackaddadditionalcritical'>
        <b>Additional Critical</b>
      </label>
    </div> 

    
      <div><!-- Empty --></div>
      <input type='checkbox' class='toggle' name='attr_attackaddadditionalcritical'>
        <div class='toggler'>&nbsp;&nbsp;Critical Type</div>
      <input type='checkbox' class='toggle' name='attr_attackaddadditionalcritical'>
        <div class='toggler'>
          <select name='attr_attackaddadditionalcriticaltype' class='fancyselect'>
            <option value='A'>Acid</option>
            <option value='B'>Subdual</option>
            <option value='G'>Grapple</option>
            <option value='H'>Heat</option>
            <option value='I'>Impact</option>
            <option value='K'>Krush</option>
            <option value='L'>Electricity</option>
            <option value='M'>Steam</option>
            <option value='O'>Cold</option>
            <option value='P'>Puncture</option>
            <option value='S'>Slash</option>
            <option value='T'>Strikes</option>
            <option value='U'>Unbalance</option>
            <option value='W'>Sweeps</option>
            <option value='Y'>Holy</option>
          </select>
        </div>
      <input type='checkbox' class='toggle' name='attr_attackaddadditionalcritical'>
        <div class='toggler'>&nbsp;&nbsp;Degree</div>
      <input type='checkbox' class='toggle' name='attr_attackaddadditionalcritical'>
        <div class='toggler'>
          <select name='attr_attackaddadditionalcriticalseverity' class='fancyselect'>
            <option value='0'>Same</option>
            <option value='-1'>1 Less</option>
            <option value='-2'>2 Less</option>
            <option value='1'>1 Greater</option>
            <option value='2'>2 Greater</option>
          </select>
        </div>
      <div style='grid-column: span 2'><span name='attr_attackaddmessage' data-i18n-dynamic></span></div>


      <button class='fancybuttoninline fancybutton' type='action' name='act_attackaddsave'>
        <span name='attr_attackaddaction'></span>
      </button>
      <button class='fancybuttoninline fancybutton' type='action' name='act_attackaddcancel'>Cancel</button>
      </div>
    </div>


    <input type='checkbox' name='attr_attackrollcritshow' class='attackrollcritshow toggle'>
    <div class='attackrollcrit overlay toggler'>
      <div class="attackaddcontent skillchange">
      <h2 class='span2'>Roll Crit/Fumble</h2>

      <span>Lookup or Roll</span>
      <label><input type='checkbox' name='attr_attackrollcritlookup' class='attackrollcritlookup'>&nbsp;Lookup</label>

      <div><b>What to roll?</b></div>
      <select class='fancyselectnatural' name='attr_attackrollwhat'>
        <option value='attacktable'>Attack Table</option>
        <option value='crittable'>Critical Table</option>
        <option value='spellfail'>Spell Failure</option>
        <option value='weaponfumble'>Weapon/Attack Fumble</option>
      </select>

      <!-- Some space to the info field -->
      <span>&nbsp;</span> <span>&nbsp;</span>
     <!-- 
      <input type="checkbox" name='attr_attackrollfumbletoggle' class='attackrollfumbleshow'>
      <input type="checkbox" name='attr_attackrollspellfailtoggle' class='attackrollspellfailshow'>
      <input type="checkbox" name='attr_attackrollcriticaltoggle' class='attackrollcriticalshow'>
      <input type="checkbox" name='attr_attackrollcriticallookuptoggle' class='attackrollcriticallookupshow'>
      <input type="checkbox" name='attr_attackrollattacktabletoggle' class='attackrollattacktableshow'>
      <input type="checkbox" name='attr_attackrollfumblelookuptoggle' class='attackrollfumblelookupshow'>
      <input type="checkbox" name='attr_attackrollfumblenotlookuptoggle' class='attackrollfumblenotlookupshow'>
      <span></span>

      <input type="checkbox" name='attr_attackrollroll' class='attackrollrollshow'>
      <input type="checkbox" name='attr_attackrolllookup' class='attackrolllookupshow'>
-->

      <input type="hidden" name='attr_attackrollfumbletoggle' class='attackrollfumbleshow'>
      <input type="hidden" name='attr_attackrollspellfailtoggle' class='attackrollspellfailshow'>
      <input type="hidden" name='attr_attackrollcriticaltoggle' class='attackrollcriticalshow'>
      <input type="hidden" name='attr_attackrollcriticallookuptoggle' class='attackrollcriticallookupshow'>
      <input type="hidden" name='attr_attackrollattacktabletoggle' class='attackrollattacktableshow'>
      <input type="hidden" name='attr_attackrollfumblelookuptoggle' class='attackrollfumblelookupshow'>
      <input type="hidden" name='attr_attackrollfumblenotlookuptoggle' class='attackrollfumblenotlookupshow'>
      <input type="hidden" name='attr_attackrollroll' class='attackrollrollshow'>
      <input type="hidden" name='attr_attackrolllookup' class='attackrolllookupshow'>


      <span class='attackrollfumbletoggle'><b>Weapon Type</b></span>
      <select class='fancyselectnatural attackrollfumbletoggle' name='attr_attackrollfumbletypetype'>
        <option value="1-Handed Melee">1-Handed Melee</option>
        <option value="2-Handed Melee">2-Handed Melee</option>
        <option value="Animals">Animals</option>
        <option value="Bows">Bows</option>
        <option value="Elemental Balls">Elemental Balls/Cones</option>
        <option value="Elemental Bolts">Elemental Bolts</option>
        <option value="Mounted Arms">Mounted Arms</option>
        <option value="Unarmed">Unarmed</option>
        <option value="Slings">Slings</option>
        <option value="Thrown">Thrown</option>
      </select>

      <span class='attackrollfumblelookuptoggle'><b>Lookup Value</b></span>
      <input type='number' class='attackrollfumblelookuptoggle' name='attr_attackrollfumblelookupvalue'>

      <span class='attackrollfumblenotlookuptoggle'><b>Modifier</b></span>
      <input type='number' class='attackrollfumblenotlookuptoggle' name='attr_attackrollfumblemod'>

      <span class='attackrollspellfailtoggle'><b>Spell Type</b></span>
      <select class='fancyselectnatural attackrollspellfailtoggle' name="attr_attackrollspellfailure">
        <option value="chanelem">Channeling: Elemental</option>
        <option value="chanforce">Channeling: Force</option>
        <option value="chaninfo">Channeling: Information</option>
        <option value="chanutlity">Channeling: Utility</option>

        <option value="esselem">Essence: Elemental</option>
        <option value="essforce">Essence: Force</option>
        <option value="essinfo">Essence: Information</option>
        <option value="essutlity">Essence: Utility</option>

        <option value="mentelem">Mentalism: Elemental</option>
        <option value="mentforce">Mentalism: Force</option>
        <option value="mentinfo">Mentalism: Information</option>
        <option value="mentutlity">Mentalism: Utility</option>
      </select>

      <span class='attackrollcriticaltoggle'><b>Critical Type</b></span>
      <select class='fancyselectnatural attackrollcriticaltoggle' name="attr_attackrollcriticaltype">
        <option value="A">Acid</option>
        <option value="B">Subdual</option>
        <option value="G">Grapple</option>
        <option value="H">Heat</option>
        <option value="I">Impact</option>
        <option value="K">Krush</option>
        <option value="L">Electricity</option>
        <option value="M">Steam</option>
        <option value="O">Cold</option>
        <option value="P">Puncture</option>
        <option value="S">Slash</option>
        <option value="T">Strikes</option>
        <option value="U">Unbalance</option>
        <option value="W">Sweeps</option>
        <option value="Y">Holy</option>
      </select>

      <span class='attackrollcriticaltoggle'><b>Severity</b></span>
      <select class='fancyselectnatural attackrollcriticaltoggle' name='attr_attackrollcriticalsev'>
        <option value="0">A</option>
        <option value="1">B</option>
        <option value="2">C</option>
        <option value="3">D</option>
        <option value="4">E</option>
        <option value="5">F</option>
        <option value="6">G</option>
        <option value="7">H</option>
        <option value="8">I</option>
        <option value="9">J</option>
        <option value="-1">Z (A - 1)</option>
        <option value="-2">Y (A - 2)</option>
      </select>

      <span class='attackrollcriticallookuptoggle'><b>Lookup Value</b></span>
      <input type='number' class='attackrollcriticallookuptoggle' name='attr_attackrollcriticalnumber'>
      
      <span class='attackrollattacktabletoggle'><b>Attack Table</b></span>
      <select class='fancyselectnatural attackrollattacktabletoggle' name='attr_attackrollattacktable'>
        <option value="Arming Sword">Arming Sword</option>
        <option value="Ball, Cold">Ball, Cold</option>
        <option value="Battle Axe">Battle Axe</option>
        <option value="Beak">Beak</option>
        <option value="Bite">Bite</option>
        <option value="Bola">Bola</option>
        <option value="Bow, Short">Bow, Short</option>
        <option value="Broadsword">Broadsword</option>
        <option value="Claw">Claw</option>
        <option value="Club">Club</option>
        <option value="Ball, Cold">Ball, Cold</option>
        <option value="Ball, Fire">Ball, Fire</option>
        <option value="Ball, Lightning">Ball, Lightning</option>
        <option value="Bolt, Fire">Bolt, Fire</option>
        <option value="Bolt, Lightning">Bolt, Lightning</option>
        <option value="Bolt, Shock">Bolt, Shock</option>
        <option value="Bolt, Water">Bolt, Water</option>
        <option value="Crossbow">Crossbow</option>
        <option value="Crush">Crush</option>
        <option value="Dagger">Dagger</option>
        <option value="Falchion">Falchion</option>
        <option value="Fighting Stick">Fighting Stick</option>
        <option value="Flail">Flail</option>
        <option value="Grapple">Grapple</option>
        <option value="Horn">Horn</option>
        <option value="Bolt, Ice">Bolt, Ice</option>
        <option value="Bow, Long">Bow, Long</option>
        <option value="Mace">Mace</option>
        <option value="Ram">Ram</option>
        <option value="Rapier">Rapier</option>
        <option value="Rock">Rock</option>
        <option value="Scimitar">Scimitar</option>
        <option value="Shield">Shield</option>
        <option value="Sling">Sling</option>
        <option value="Spear">Spear</option>
        <option value="Stinger">Stinger</option>
        <option value="Trample">Trample</option>
        <option value="Unarmed Strike">Unarmed Strike</option>
        <option value="Unarmed Sweeps">Unarmed Sweeps</option>
        <option value="War Hammer">War Hammer</option>
      </select>

      <span>&nbsp;</span> <span>&nbsp;</span>

      <button class='fancybuttoninline fancybutton fancywarning' type='action' name='act_attackrollfumblecancel'>Cancel</button>
      <button class='fancybuttoninline fancybutton attackroll attackrollroll' type='action' name='act_attackrolldoroll'>
          <span class='diced10'>0</span>&nbsp;Roll!</button>
      <button class='fancybuttoninline fancybutton fancycompliment attackrolllookup' type='action' name='act_attackrolldoroll'>
          <span style="font-family:Pictos;">s</span>&nbsp;Lookup!</button>
      </div> <!-- end of content -->
    </div>
    <!-- end of attackrollcrit overlay -->




<input type='hidden' name='attr_sheetselect' class='sheetselect'>
<div class='playercharactersheet'>


<input type='checkbox' name='attr_flag_cmancer_show' class='toggle'>
<span class='toggler'>
<button type='action' name='act_showcharmancer' class='fancybutton'>Charactermancer</button>
<button type='action' name='act_uploadnpcstart' class='fancybutton'>Upload NPC</button>
<button type='action' name='act_trackerinit' class='fancybutton'>Creature Tracker</button>
</span>
<input type='checkbox' name='attr_flag_levelup_show' class='toggle'>
<button type='action' name='act_showbuyskills' class='toggler fancybutton'>Level Up</button>


<div style='float:right'>
  <select name='attr_whispertype' class='fancyselect'>
    <option value=''>Public</option>
    <option value='/w gm'>GM Only</option>
  </select>
</div>



<div class='tabset'>
  <input type='radio' name='tabset2' id='maintab1' checked><label for='maintab1'>Stats</label>
  <input type='radio' name='tabset2' id='maintab2'><label for='maintab2'>Skills</label>
  <input type='radio' name='tabset2' id='maintab3'><label for='maintab3'>Spells</label>
  <input type='radio' name='tabset2' id='maintab4'><label for='maintab4'>Stuff</label>
  <input type='radio' name='tabset2' id='maintab5'><label for='maintab5'>Scratch</label>
  <input type='radio' name='tabset2' id='maintab6'><label for='maintab6'>
    <span style="font-family:Pictos;">y</span></label>

  <div class='tab-panels'>
    <section id='stats' class='tab-panel'>
       <div class="sheet-3colrow">
          <div class="rmusheet-column">
            <div class='pcframebox' style='z-index: 699'>
              <h2>Statistics</h2>
              <div id="stats_pane" class="stats_pane">
                <div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='agility' data-statabbr='Ag' data-display='Agility'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_agility_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='agility'>agility</span><span class='stat_abbr' data-i18n='ag'>ag</span></span>
<span class='stat_value' name='attr_agility'></span><span class='stat_attr' name='attr_ag'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='constitution' data-statabbr='Co' data-display='Constitution'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_constitution_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='constitution'>constitution</span><span class='stat_abbr' data-i18n='co'>co</span></span>
<span class='stat_value' name='attr_constitution'></span><span class='stat_attr' name='attr_co'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='empathy' data-statabbr='Em' data-display='Empathy'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_empathy_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='empathy'>empathy</span><span class='stat_abbr' data-i18n='em'>em</span></span>
<span class='stat_value' name='attr_empathy'></span><span class='stat_attr' name='attr_em'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='intuition' data-statabbr='In' data-display='Intuition'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_intuition_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='intuition'>intuition</span><span class='stat_abbr' data-i18n='in'>in</span></span>
<span class='stat_value' name='attr_intuition'></span><span class='stat_attr' name='attr_in'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='memory' data-statabbr='Me' data-display='Memory'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_memory_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='memory'>memory</span><span class='stat_abbr' data-i18n='me'>me</span></span>
<span class='stat_value' name='attr_memory'></span><span class='stat_attr' name='attr_me'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='presence' data-statabbr='Pr' data-display='Presence'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_presence_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='presence'>presence</span><span class='stat_abbr' data-i18n='pr'>pr</span></span>
<span class='stat_value' name='attr_presence'></span><span class='stat_attr' name='attr_pr'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='quickness' data-statabbr='Qu' data-display='Quickness'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_quickness_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='quickness'>quickness</span><span class='stat_abbr' data-i18n='qu'>qu</span></span>
<span class='stat_value' name='attr_quickness'></span><span class='stat_attr' name='attr_qu'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='reasoning' data-statabbr='Re' data-display='Reasoning'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_reasoning_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='reasoning'>reasoning</span><span class='stat_abbr' data-i18n='re'>re</span></span>
<span class='stat_value' name='attr_reasoning'></span><span class='stat_attr' name='attr_re'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='selfdiscipline' data-statabbr='SD' data-display='Self Discipline'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_selfdiscipline_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='selfdiscipline'>selfdiscipline</span><span class='stat_abbr' data-i18n='sd'>sd</span></span>
<span class='stat_value' name='attr_selfdiscipline'></span><span class='stat_attr' name='attr_sd'></span></div>
<div class='stat'><span class='stat_names'> <button type='action' name='act_edit_stat' class='editbutton' data-stat='strength' data-statabbr='St' data-display='Strength'><span style='position:relative'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_strength_info' class='stat_info'></span>
</span></button><span class='stat_name' data-i18n='strength'>strength</span><span class='stat_abbr' data-i18n='st'>st</span></span>
<span class='stat_value' name='attr_strength'></span><span class='stat_attr' name='attr_st'></span></div>

              <div class='stat'>
              <span class='stat_names'>
              <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>  <span name='attr_will_info' class='stat_info'></span>
              <i>Will</i>
              </span>
              <span><!-- No stat --></span>
              <span class='stat_attr' name='attr_will'></span>
              </div>
              </div>
            </div> <!-- pcframebox zindex 699 -->

   <div class='pcframebox' style='z-index: 698'>
<div class='prop_pair'><span class='prop_prop_plain'>Power Level</span><span class='prop_value' name='attr_powerlevel'></span><span class='prop_prop_plain'>Profession</span><span class='prop_value' name='attr_profession'></span><span class='prop_prop_plain'>Race</span><span class='prop_value' name='attr_race'></span><span class='prop_prop_plain'>Culture</span><span class='prop_value' name='attr_culture'></span><span class='prop_prop_plain'>Level</span><span class='prop_value' name='attr_display_level'></span><span class='prop_prop_plain'>EP</span>        <span class='prop_value'>
          <input type='checkbox' name='attr_option_journalledxp' class='toggle'>
          <span class='toggler'>
            <span name='attr_xp'></span>
            <button type='action' name='act_journalxprefresh'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">1</span></button>
            <button class='fancybuttoninline fancybutton' type='action' name='act_journaladdshow'>
              <span style='font-family:Pictos;'>&</span>
            </button>
          </span>
          <span class='toggleroff' style="width:80%">
            <input type='number' name='attr_xp' style="width:100%">
          </span>
        </span>
      <span class='prop_prop_plain'>Fate Points</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_fatepoints'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_fatepoints'></span><span class='prop_prop_plain'>Tap Addiction</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_tapaddiction'></span><input class='editactive' type='number' style='flex:1;min-width:100px;' name='attr_tapaddiction'></span><span class='prop_prop_plain'>Realm</span><span class='prop_value' name='attr_realm'></span><span class='prop_prop_plain'>Religion</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_religion'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_religion'></span><span class='prop_prop_plain'>Age</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_age'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_age'></span><span class='prop_prop_plain'>Skin</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_skin'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_skin'></span><span class='prop_prop_plain'>Eyes</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_eyes'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_eyes'></span><span class='prop_prop_plain'>Hair</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_hair'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_hair'></span><span class='prop_prop_plain'>Gender</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_gender'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_gender'></span><span class='prop_prop_plain'>Build</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_build'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_build'></span><span class='prop_prop_plain'>Height</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_height'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_height'></span><span class='prop_prop_plain'>Weight</span><span class='prop_value' style="display:flex"><input type='checkbox' class='edittoggle'><span class='edittext' name='attr_weight'></span><input class='editactive' type='text' style='flex:1;min-width:100px;' name='attr_weight'></span><span class='iconwrap'><span class='prop_prop_plain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_weightallowance_info'></span>Weight allowance</span></span>
<span class='prop_value' name='attr_weightallowance'></span><span class='prop_prop_plain'>Carried</span><span class='prop_value' name='attr_total_weight'></span><span class='prop_prop_plain'>Load (%)</span><span class='prop_value' name='attr_load'></span><span class='prop_prop_plain'>Max Pace</span><span class='prop_value' name='attr_maxpace'></span><span class='prop_prop_plain'>Enc Penalty</span><span class='prop_value' name='attr_encumberance_penalty'></span><span class='iconwrap'><span class='prop_prop_plain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_bmr_info'></span>Base Move (BMR)</span></span>
<span class='prop_value' name='attr_bmr'></span><span class='prop_prop_plain'>Size</span><span class='prop_value' name='attr_size'></span><span class='prop_prop_plain'>Recovery Multiplier</span><span class='prop_value' name='attr_recovery_multiplier'></span><span class='prop_pair_heading'>Feats of Strength</span><span class='prop_prop_plain'>Routine</span><span class='prop_value' name='attr_strfeat_routine'></span><span class='prop_prop_plain'>Easy</span><span class='prop_value' name='attr_strfeat_easy'></span><span class='prop_prop_plain'>Light</span><span class='prop_value' name='attr_strfeat_light'></span><span class='prop_prop_plain'>Medium</span><span class='prop_value' name='attr_strfeat_medium'></span><span class='prop_prop_plain'>Hard</span><span class='prop_value' name='attr_strfeat_hard'></span><span class='prop_prop_plain'>Very Hard</span><span class='prop_value' name='attr_strfeat_veryhard'></span><span class='prop_prop_plain'>Ext. Hard</span><span class='prop_value' name='attr_strfeat_exthard'></span><span class='prop_prop_plain'>Sheer Folly</span><span class='prop_value' name='attr_strfeat_sheerfolly'></span><span class='prop_prop_plain'>Absurd</span><span class='prop_value' name='attr_strfeat_absurd'></span><span class='prop_prop_plain'>Nigh Impossible</span><span class='prop_value' name='attr_strfeat_nighimpossible'></span>
    </div> <!-- pcframebox zindex 698 -->

    </div>

   </div> <!-- rmusheet-column -->


<div class="rmusheet-column">

  <div class='pcframebox' style='z-index: 697'>
    <h2>Actions</h2>

   




  
  <div class='actionblock grid4' style='position:relative'>
    <div class='span2'>
      <select name='attr_actionselect' class='fancyselect'>
        <option value='melee'>Melee</option>
        <option value='missile'>Missile</option>
        <option value='spell'>Spell</option>
        <option value='perception'>Perception</option>
        <option value='eat'>Eat</option>
        <option value='stand'>Stand</option>
        <option value='pickup'>Pickup Item</option> 
        <option value='mount'>Mount</option> 
        <option value='dismount'>Dismount</option> 
        <option value='stringbow'>String Bow</option> 
        <option value='loadlight'>Load Light Xbow</option> 
        <option value='loadheavy'>Load Heavy Xbox</option> 
        <option value='fulldodge'>Full Dodge</option> 
        <option value='fullblock'>Full Block</option> 
        <option value='picklock '>Pick Lock</option> 
        <option value='other'>Other</option>
      </select>
    </div>

    <!-- Now the checkboxes -->
    <div class='span2'>
      <input type='checkbox' name='attr_aptracktoggleloaded' class='toggle'>
      <span class='toggler'>
        Loaded: <input name='attr_aptrack_loaded' class='toggler' type='checkbox'>
      </span>
      <div class='xtoggler'>
        <div class='aptrackerbox'><input checked='checked' class='aptrack reset' type='radio' name='attr_aptrack' value='0'><input type='checkbox' name='attr_aptracktoggle1' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='1'><input type='checkbox' name='attr_aptracktoggle2' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='2'><input type='checkbox' name='attr_aptracktoggle3' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='3'><input type='checkbox' name='attr_aptracktoggle4' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='4'><input type='checkbox' name='attr_aptracktoggle5' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='5'><input type='checkbox' name='attr_aptracktoggle6' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='6'><input type='checkbox' name='attr_aptracktoggle7' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='7'><input type='checkbox' name='attr_aptracktoggle8' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='8'><input type='checkbox' name='attr_aptracktoggle9' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='9'><input type='checkbox' name='attr_aptracktoggle10' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='10'><input type='checkbox' name='attr_aptracktoggle11' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='11'><input type='checkbox' name='attr_aptracktoggle12' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='12'><input type='checkbox' name='attr_aptracktoggle13' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='13'><input type='checkbox' name='attr_aptracktoggle14' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='14'><input type='checkbox' name='attr_aptracktoggle15' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='15'><input type='checkbox' name='attr_aptracktoggle16' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='16'><input type='checkbox' name='attr_aptracktoggle17' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='17'><input type='checkbox' name='attr_aptracktoggle18' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='18'><input type='checkbox' name='attr_aptracktoggle19' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='19'><input type='checkbox' name='attr_aptracktoggle20' class='toggle'><input class='aptrack toggler' type='radio' name='attr_aptrack' value='20'></div>

      </div>

    </div>

    <div class='double'>Concentration</div> 

    <div>
      <input name='attr_aptrack_concentration' type='checkbox'>
      
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev1'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev2'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev3'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span>
      <!--
      <span>
        <input type='checkbox' class='toggle' name='attr_aptrack_concentration_prev4'>
        <span class='toggler'>&#9679;</span>
        <span class='toggleroff'>&#9676;</span>
      </span> -->
    </div>

    <div class='span2'>Free Used
      <input name='attr_aptrack_freeused' type='checkbox'>
    </div>
    <div>AP/Phase</div>
    <div>
      <select name='attr_actionapperphase' style='width:100%' class='fancyselect'>
        <option value='1'>1AP</option>
        <option value='2'>2AP</option>
        <option value='4'>4AP</option>
      </select>
    </div>
    <div>Round <span name='attr_currentphasedisplay'></span></div>
    <div><button type='action' name='act_endphase' class='fancybutton fancybuttoninline'>End</button></div>
  </div> <!-- div.actionblock -->

  <div class='grid4'>
    <div>Defense</div>
    <div style='grid-column: span 2'>
      <select name='attr_activedefense' class='fancyselect' style='width:90%;'>
        <option value='passive'>Passive</option>
        <option value='partialblock'>Partial Block</option>
        <option value='partialdodge'>Partial Dodge</option>
        <option value='fullblock'>Full Block</option>
        <option value='fulldodge'>Full Dodge</option>
      </select>
    </div>
    <div>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
        <span name='attr_activedb_info' class='stat_info'></span>
      </span>
      DB <span name='attr_activedb'></span>
    </div>
  </div>



  </div> <!-- pcframebox zindex 697 -->

  <div class='pcframebox' style='z-index: 696'>
    <h2>Status</h2>

    

    <div class='prop_pair'>
      <span>Status</span>
      <span>
        <span name='attr_statusmessage'>Okay</span>
      </span>
    </div>


    
    <input type='hidden' name='attr_statusstagger' class='hidenext'>
    <div class='prop_pair'>
      <span>Staggered</span>
      <span>
        <span name='attr_statusstagger'>0</span> AP
      </span>
    </div>
    <input type='hidden' name='attr_statusstun75' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -75</span>
      <span><span name='attr_statusstun75info'>0</span> Rounds
        <button type='action' name='act_statusstun75delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>

    </div>
    <input type='hidden' name='attr_statusstun50' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -50</span>
      <span><span name='attr_statusstun50info'>0</span> Rounds
        <button type='action' name='act_statusstun50delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>
    </div>
    <input type='hidden' name='attr_statusstun25' class='hidenext'>
    <div class='prop_pair'>
      <span>Stun -25</span>
      <span><span name='attr_statusstun25info'>0</span> Rounds
        <button type='action' name='act_statusstun25delete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>
    </div>

    <div class='prop_pair'>
      <span>
        <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_hp_info' class='stat_info'></span> 
        <b>Hits (HP)</b>
      </span>
      <span>
        <input type='number' name='attr_hp'> / <span name='attr_hp_max'></span><br>
      </span>
      <span></span>
      <div>
        
        <input type="hidden" class="bar-value" name="attr_hp_percent" value="100">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>
    </div>

    <input type='hidden' name='attr_hppenalty' class='hidenext'>
    <div class='prop_pair'>
      <span>Hits Penalty:</span>
        <span name='attr_hppenalty'></span>
    </div>

    <input type='hidden' name='attr_bleeding' class='hidenext'>
    <div class='prop_pair'>
      <span>Bleed</span>
      <span>
        <span name='attr_bleeding'></span> / round
        <button type='action' class='fancybuttoninline fancybutton' name='act_deletebleed'>
          <span style="font-family:Pictos;">#</span></button>
      </span>

    </div>

    <div class='prop_pair'>
      <span>Injury Penalty:</span>
      <span>
        <input type='number' name='attr_injurypenalty'>
        <button type='action' class='fancybuttoninline fancybutton' name='act_refreshinjurypenalty'>
          <span style="font-family:Pictos;">1</span></button>
      </span>
    </div>

    
    <div class='prop_pair'>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_endurance_info' class='stat_info'></span> 
        Endurance:
      </span>
      <span>
        <button type='action' class='rollbutton fancybutton fancybuttoninline' name='act_enduranceroll'>
          <span class='diced10'>0</span>
          <span name='attr_endurance'></span>
          </button>
      </span>
      <span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span> <span name='attr_mentalendurance_info' class='stat_info'></span>
        Mental Endurance:
      </span>
      <span>
      <button type='action' class='rollbutton fancybutton fancybuttoninline' name='act_mentalfatigueroll'>
          <span class='diced10'>0</span>
          <span name='attr_mentalendurance'></span>
      </button>
      </span>

      <span>Fatigue:</span>
      <span> <input type='number' name='attr_fatigue'></span>
    </div>

    <div class='prop_pair'>
      <span>Status Penalty:</span>
      <span name='attr_statuspenalty'></span>
    </div>


     <div class='prop_pair'>
      <span>Total Penalty:</span>
      <div>
        <span name='attr_allpenalties'></span><br>
        <div>
          
          <input type="hidden" class="bar-value" name="attr_statuspercent" value="100">
          <div class="bar-track"> <div class="bar-progress"></div> </div>
        </div>
      </div>
    </div>



    <hr>

    <div class='prop_pair'>
      <span><b>PP</b></span>
      <span>
        <input type='number' name='attr_pp'> /
        <span name='attr_pp_max'></span>
      </span>
      <span></span>
      <div>
        
        <input type="hidden" class="bar-value" name="attr_pp_percent" value="100">
        <div class="bar-track"> <div class="bar-progress"></div> </div>
      </div>

    </div>

    <div class='prop_pair'>
      <span>
        <button type='action' name='act_rollinitiative' class='fancybutton'>Initative
          <span name='attr_initiative'></span>
        </button>
        <!-- span class='iconwrap'><span class='prop_prop_plain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></span></span-->
      </span>
      <span class='prop_value'>
        <button name='act_newcombat' type='action' class='fancybuttoninline fancybutton'>
            New Combat</button>
      </span>
    </div>






  </div> <!-- pcframebox zindex 696 -->

  <div class='pcframebox' style='z-index: 695'>

    <button type='action' name='act_statusrest'
        class='rollbutton fancybutton fancybuttoninline'>Rest</button>

    <button type='action' name='act_statussleep'
        class='rollbutton fancybutton fancybuttoninline'>Sleep</button>

    <!--
    <button type='action' name='act_statussleep'
        class='rollbutton fancybutton fancybuttoninline'>Wait</button>
    -->

  </div> <!-- pcframebox zindex 695 -->

  <div class='pcframebox' style='z-index: 694'>

    <h2>Attacks</h2>

    
  
      <div class='foe fancybox'>

      <span style='grid-column: span 1'>
        Target:
      </span>
      <span name='attr_target_name' style='grid-column: span 2'></span>
      <span>
        <button type='action' name='act_rmuattackgettarget'
                  class='rollbutton fancybutton fancybuttoninline'>Select</button>
        <button type='action' name='act_rmuattacktargetrefresh'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">1</span></button>
        <button type='action' name='act_rmuattacktargetdelete'
                  class='rollbutton fancybutton fancybuttoninline'>
              <span style="font-family:Pictos;">#</span></button>
      </span>

      <span class='foe_target_db'>
        DB
      </span>
      <input type='number' name='attr_target_db'>
      <span class='foe_target_at'>
        AT
      </span>
      <input type='text' style='width: 100%' name='attr_target_at' 
  	pattern="\d|10|((\d,|10,){3}(\d|10))"
        title='Use AT of target (1-10) or 4 ATs separated by commas'>
      <span>Size</span>
      <select style='width:100%' class='fancyselect' name='attr_target_size'>
        <option value="1">Miniscule</option>
        <option value="2">Diminutive</option>
        <option value="3">Tiny</option>
        <option value="4">Small</option>
        <option value="5">Medium</option>
        <option value="6">Big</option>
        <option value="7">Large</option>
        <option value="8">Huge</option>
        <option value="9">Gigantic</option>
        <option value="10">Enormous</option>
        <option value="11">Immense</option>
        <option value="12">Behemoth</option>
        <option value="13">Leviathan</option>
      </select>
      <span>Crit. Red.</span>
      <select style='width:100%' class='fancyselect' name='attr_target_crit'>
        <option value="0">None</option>
        <option value="1">I</option>
        <option value="2">II</option>
        <option value="3">III</option>
      </select>
    </div>





    <button class='fancybuttoninline fancybutton' type='action' name='act_attackadd'>
          <span style="font-family:Pictos;">&</span></button>
    <button class='fancybuttoninline fancybutton' type='action' name='act_rollfumble'>
          <span style="font-family:Pictos Three;">l</span>Table Roll</button>

    <input type='checkbox' name='attr_attackuseap' id='attackuseap'>
      <label style='display:inline' for='attackuseap'>Use AP?</label>

    <br>
    <!-- other mods go here -->
    <div class='smallattrs'>
      <span>Parry</span>
        <span><input type='number' name='attr_parrymod' min="0" step="1"></span>
      <span class='span2'><label for='restrictedparrytoggle' class='plainlabel'>Restricted?</label>
        <input type='checkbox' name='attr_restrictedparry' id='restrictedparrytoggle'>
      </span>
      <span>Attack Mod</span>
        <span><input type='number' name='attr_othermod' step='1'></span>
      <span>DB Mod</span>
        <span><input type='number' name='attr_dbmod' step='1'></span>
      <!--
      <span>Called Shot</span>
      <span class='span2'>
        <select name='calledshot' class='fancyselect'>
          <option value='none'>None</option>
          <option value='head'>Head</option>
          <option value='larm'>Left Arm</option>
          <option value='rarm'>Right Arm</option>
          <option value='chest'>Chest</option>
          <option value='abdoment'>Abdomen</option>
          <option value='lleg'>Left Leg</option>
          <option value='rleg'>Right Leg</option>
        </select>
      </span>
      -->
    </div>

    <div class='attacks'>
	<span class='attack_name' name='attr_attackname'><b>Attack</b></span>
	<span class='attack_ranks' name='attr_attackranks'><b>Rank</b></span>
	<span class='attack_bonus' name='attr_attackbonus'><b>OB</b></span>
    </div>

    <fieldset class='repeating_attack'>
	<div class='attacks'>
	    
	    <span class='attack_name' name='attr_attackname'></span>
	    <span class='attack_ranks' name='attr_attackranks'></span>
	    <span class='attack_bonus' name='attr_attackbonus'></span>
	    
	    <span>Table: <span class='attack_table' name='attr_attacktable'></span></span>
	    <span class='attack_size' name='attr_attacksize'></span>
	    <span name='attr_materialgroup'></span>
	    
	    <span>Range Increment: <span class='attack_ri' name='attr_attackri'></span></span>
	    <span>Fmbl <span class='attack_fumble' name='attr_attackfumble'></span></span>
	    <span>Str: <span class='attack_str' name='attr_attackstr'></span></span>
            <input type='hidden' name='attr_attackmin'>
            <input type='hidden' name='attr_attackmax'>
            <input type='hidden' name='attr_attackdata'>
            <button type='action' name='act_rmuattackroll'
                class='rollbutton fancybutton fancybuttoninline'>Attack
            </button>
            <div>
            </div>
            <div>
            <button type='action' class='fancybuttoninline fancybutton' name='act_editattack'
               ><span style="font-family:Pictos;">p</span>
               </button>
            <button type='action' class='fancybuttoninline fancybutton' name='act_deleteattack'
               ><span style="font-family:Pictos;">#</span>
              </button>
            </div>
	</div>
    </fieldset>

 



    <hr>
  </div> <!-- pcframebox zindex 694 -->

</div> <!-- rmusheet-column -->

<div class='rmusheet-column'>
  <div class='pcframebox' style='z-index: 693'>

   <h2>Defense</h2>

     <b>AT</b><br>
     <div class='prop_pair'>
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_at_head_info' class='stat_info'></span>
	    Head</span>
	    <span class='prop_value' name='attr_at_head'></span>
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_at_torso_info' class='stat_info'></span>
	    Torso</span>
	    <span class='prop_value' name='attr_at_torso'></span>
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_at_arms_info' class='stat_info'></span>
	    Arms</span>
	    <span class='prop_value' name='attr_at_arms'></span> 
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_at_legs_info' class='stat_info'></span>
	    Legs</span>
	    <span class='prop_value' name='attr_at_legs'></span> 
    </div>

    <b>Defensive Bonus</b>

    <div class='prop_pair'>
	<span class='prop_prop_plan'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_info' class='stat_info'></span>
            Base DB</span>
	    <span class='prop_value' name='attr_db_qu'></span>
	<span class='prop_prop_plain'>Shield</span>
	    <span class='prop_value'>
		<span name='attr_db_shield'></span>
		(<span  name='attr_db_shield_attacks'></span> attacks)</span>
	<span class='prop_prop_plain'><b>Dodge</b></span>
	    <span class='prop_value'>Melee / Missile</span>
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_passivedodge_info' class='stat_info'></span>
	    Passive Dodge</span>
	    <span class='prop_value'>
		<span name='attr_db_passivedodge'></span> /
		<span name='attr_db_passivedodgemissile'></span>
	    </span>
	<span class='prop_prop_plain'>
	    <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_partialdodge_info' class='stat_info'></span>
	    Partial Dodge (C)</span>
	    <span class='prop_value'>
		<span name='attr_db_partialdodge'></span> /
		<span name='attr_db_partialdodgemissile'></span>
	    </span>
	<span class='prop_prop_plain'>
            <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_fulldodge_info' class='stat_info'></span>
	    Full Dodge (4 AP)</span>
	    <span class='prop_value'>
		<span name='attr_db_fulldodge'></span> /
		<span name='attr_db_fulldodgemissile'></span>
	    </span>
	<span class='prop_prop_plain'>
	    <b>Block</b></span>
	    <span class='prop_value'></span>
	<span class='prop_prop_plain'>
            <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_passiveblock_info' class='stat_info'></span>
	    Passive Block</span>
	    <span class='prop_value' name='attr_db_passiveblock'></span>
	<span class='prop_prop_plain'>
            <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_partialblock_info' class='stat_info'></span>
	    Partial Block (C)</span>
	    <span class='prop_value' name='attr_db_partialblock'></span>
	<span class='prop_prop_plain'>
            <span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span>
	    <span name='attr_db_fullblock_info' class='stat_info'></span>
	    Full Block (4 AP)</span>
	    <span class='prop_value' name='attr_db_fullblock'></span>
      </div>
    </div> <!-- pcframebox zindex 693 -->

    <div class='pcframebox' style='z-index: 692'>

     <h2>RRs</h2>

     

<div class='rrs'>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_arcane_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='arcane'>arcane</span><span data-i18n='em/in/pr' class='rr_stat'>em/in/pr</span></span></span><span class='rr_bonus'><button type='action' data-rr='arcane' data-rrpretty='Arcane' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_arcane_bonus'>0</span></button>
<button type='action' data-rr='arcane' data-rrpretty='Arcane' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_arcanesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_channeling_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='channeling'>channeling</span><span data-i18n='in' class='rr_stat'>in</span></span></span><span class='rr_bonus'><button type='action' data-rr='channeling' data-rrpretty='Channeling' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_channeling_bonus'>0</span></button>
<button type='action' data-rr='channeling' data-rrpretty='Channeling' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_channelingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_essence_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='essence'>essence</span><span data-i18n='em' class='rr_stat'>em</span></span></span><span class='rr_bonus'><button type='action' data-rr='essence' data-rrpretty='Essence' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_essence_bonus'>0</span></button>
<button type='action' data-rr='essence' data-rrpretty='Essence' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_essencesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_mentalism_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='mentalism'>mentalism</span><span data-i18n='pr' class='rr_stat'>pr</span></span></span><span class='rr_bonus'><button type='action' data-rr='mentalism' data-rrpretty='Mentalism' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_mentalism_bonus'>0</span></button>
<button type='action' data-rr='mentalism' data-rrpretty='Mentalism' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_mentalismsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_physical_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='physical'>physical</span><span data-i18n='co' class='rr_stat'>co</span></span></span><span class='rr_bonus'><button type='action' data-rr='physical' data-rrpretty='Physical' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_physical_bonus'>0</span></button>
<button type='action' data-rr='physical' data-rrpretty='Physical' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_physicalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  <div class='rr'>
<span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span name='attr_rr_fear_info' class='stat_info rr_info'>0</span>
    <span class='rr_name'><span data-i18n='fear'>fear</span><span data-i18n='sd' class='rr_stat'>sd</span></span></span><span class='rr_bonus'><button type='action' data-rr='fear' data-rrpretty='Fear' class='editbutton rollbutton' name='act_rrroll'><span name='attr_rr_fear_bonus'>0</span></button>
<button type='action' data-rr='fear' data-rrpretty='Fear' class='editbutton rollbutton' name='act_rrrollmod'><span class="diced10">0</span></button></span>   </div>
<fieldset class='repeating_fearsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>

</div>



    </div> <!-- pcframebox zindex 692 -->



    <div class='pcframebox' style='z-index: 691'>
    <h2>Favorite Skills</h2>

    <div class='favorite_group'>
      <fieldset class='repeating_favorite'>
          <div class='skill'>
              <span><input style='width: 100%' type='text' name='attr_favskill'></span>
              <div class='skill_ranks'>
                  <span name='attr_ranks'></span>
              </div>
              <div class='skill_bonus'>
                  <button type='action' class='editbutton rollbutton' name='act_rollskilldirect'>
                    <span name='attr_bonus'></span>
                  </button>
              </div>
              <button type='action' class='editbutton rollbutton' name='act_rollskillmod'>
                <span class="diced10">0</span>
              </button>
         </div>
      </fieldset>
    </div>

    </div> <!-- pcframebox zindex 691 -->

    <div class='pcframebox' style='z-index: 690'>


    <h2>Talents</h2>

    <input type='hidden' name='attr_edit_talent_toggle' class='edit_control_toggle'>
    <fieldset class='repeating_talent'>
	<div>
	    <span class='talent_name' name='attr_talentname'></span>
		Tier <span name='attr_tier'></span>
		<span name='attr_choice'></span><br>
	    Source: <span name='attr_source'></span><br>
	    Description:
		<span name='attr_description'></span>
	</div>
    </fieldset>

    <button type='action' class='fancybutton' name='act_talentaddstart'>Add Talent</button>
    </div> <!-- pcframebox zindex 690 -->

</div> <!-- rmusheet-column -->

</div> <!--sheetspan -->
</section>
<section id='skills' class='tab-panel'>
    <div class="skillspane">

    <!-- Inventory/Encumberance/Armor based one -->
    <div style='float: right'>
      Manuever Penalty: <span name='attr_maneuver_penalty'></span>
    </div>

    <h2>Skills</h2>

    <div class='skilllist'>
          <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='animal'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='em'>em</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_animalhandling_info'></span></span>
      <span class='skillname'>Animal Handling<input type='hidden' name='attr_animalhandling_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='animalhandling'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_animalhandling_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='animalhandling' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_animalhandling_bonus'></span></button></div>
<button type='action' data-skill='animalhandling' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_animalhandlingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationanimalhandling'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='animalhandling'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='animalhandling' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_riding_info'></span></span>
      <span class='skillname'>Riding<input type='hidden' name='attr_riding_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='riding'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_riding_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='riding' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_riding_bonus'></span></button></div>
<button type='action' data-skill='riding' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ridingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationriding'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='riding'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='riding' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='awareness'></span>
      <span class='skill_stat'><span data-i18n='in'>in</span> + <span data-i18n='re'>re</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='perception'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_perception_info'></span>
Uses (Lvl/Total) <span name='attr_perception_usecount'></span> / <span name='attr_perception_usecounttotal'></span></span></span>
      <span class='skillname'>Perception<input type='hidden' name='attr_perception_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_perception_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='perception' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_perception_bonus'></span></button></div>
<button type='action' data-skill='perception' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_perceptionsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='tracking'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_tracking_info'></span>
Uses (Lvl/Total) <span name='attr_tracking_usecount'></span> / <span name='attr_tracking_usecounttotal'></span></span></span>
      <span class='skillname'>Tracking<input type='hidden' name='attr_tracking_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_tracking_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='tracking' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_tracking_bonus'></span></button></div>
<button type='action' data-skill='tracking' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_trackingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='battleexpertise'></span>
    </div>
  <div class='category_skills'>
<input type='checkbox' class='toggle' name='attr_usecc'><div class='skill toggler'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_battlestyle_info'></span></span>
      <span class='skillname'>Battle Styles<input type='hidden' name='attr_battlestyle_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='battlestyle'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_battlestyle_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='battlestyle' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_battlestyle_bonus'></span></button></div>
<button type='action' data-skill='battlestyle' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_battlestylesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationbattlestyle'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='battlestyle'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='battlestyle' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='maneuveringinarmor'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_maneuveringinarmor_info'></span>
Uses (Lvl/Total) <span name='attr_maneuveringinarmor_usecount'></span> / <span name='attr_maneuveringinarmor_usecounttotal'></span></span></span>
      <span class='skillname'>Maneuvering in Armor<input type='hidden' name='attr_maneuveringinarmor_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_maneuveringinarmor_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='maneuveringinarmor' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_maneuveringinarmor_bonus'></span></button></div>
<button type='action' data-skill='maneuveringinarmor' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_maneuveringinarmorsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='mountedcombat'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_mountedcombat_info'></span>
Uses (Lvl/Total) <span name='attr_mountedcombat_usecount'></span> / <span name='attr_mountedcombat_usecounttotal'></span></span></span>
      <span class='skillname'>Mounted Combat<input type='hidden' name='attr_mountedcombat_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_mountedcombat_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='mountedcombat' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_mountedcombat_bonus'></span></button></div>
<button type='action' data-skill='mountedcombat' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_mountedcombatsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='protect'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_protect_info'></span>
Uses (Lvl/Total) <span name='attr_protect_usecount'></span> / <span name='attr_protect_usecounttotal'></span></span></span>
      <span class='skillname'>Protect<input type='hidden' name='attr_protect_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_protect_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='protect' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_protect_bonus'></span></button></div>
<button type='action' data-skill='protect' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_protectsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='restrictedquarters'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_restrictedquarters_info'></span>
Uses (Lvl/Total) <span name='attr_restrictedquarters_usecount'></span> / <span name='attr_restrictedquarters_usecounttotal'></span></span></span>
      <span class='skillname'>Restricted Quarters<input type='hidden' name='attr_restrictedquarters_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_restrictedquarters_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='restrictedquarters' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_restrictedquarters_bonus'></span></button></div>
<button type='action' data-skill='restrictedquarters' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_restrictedquarterssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='subduing'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_subduing_info'></span>
Uses (Lvl/Total) <span name='attr_subduing_usecount'></span> / <span name='attr_subduing_usecounttotal'></span></span></span>
      <span class='skillname'>Subduing<input type='hidden' name='attr_subduing_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_subduing_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='subduing' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_subduing_bonus'></span></button></div>
<button type='action' data-skill='subduing' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_subduingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='bodydiscipline'></span>
      <span class='skill_stat'><span data-i18n='co'>co</span> + <span data-i18n='sd'>sd</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='adrenaldefense'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_adrenaldefense_info'></span>
Uses (Lvl/Total) <span name='attr_adrenaldefense_usecount'></span> / <span name='attr_adrenaldefense_usecounttotal'></span></span></span>
      <span class='skillname'>Adrenal Defense<input type='hidden' name='attr_adrenaldefense_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_adrenaldefense_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='adrenaldefense' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_adrenaldefense_bonus'></span></button></div>
<button type='action' data-skill='adrenaldefense' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_adrenaldefensesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='adrenalfocus'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_adrenalfocus_info'></span>
Uses (Lvl/Total) <span name='attr_adrenalfocus_usecount'></span> / <span name='attr_adrenalfocus_usecounttotal'></span></span></span>
      <span class='skillname'>Adrenal Focus<input type='hidden' name='attr_adrenalfocus_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_adrenalfocus_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='adrenalfocus' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_adrenalfocus_bonus'></span></button></div>
<button type='action' data-skill='adrenalfocus' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_adrenalfocussubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='adrenalspeed'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_adrenalspeed_info'></span>
Uses (Lvl/Total) <span name='attr_adrenalspeed_usecount'></span> / <span name='attr_adrenalspeed_usecounttotal'></span></span></span>
      <span class='skillname'>Adrenal Speed<input type='hidden' name='attr_adrenalspeed_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='qu'>qu</span></span>
<div class='skill_ranks'><span name='attr_adrenalspeed_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='adrenalspeed' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_adrenalspeed_bonus'></span></button></div>
<button type='action' data-skill='adrenalspeed' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_adrenalspeedsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='adrenalstrength'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_adrenalstrength_info'></span>
Uses (Lvl/Total) <span name='attr_adrenalstrength_usecount'></span> / <span name='attr_adrenalstrength_usecounttotal'></span></span></span>
      <span class='skillname'>Adrenal Strength<input type='hidden' name='attr_adrenalstrength_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_adrenalstrength_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='adrenalstrength' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_adrenalstrength_bonus'></span></button></div>
<button type='action' data-skill='adrenalstrength' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_adrenalstrengthsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<input type='checkbox' class='toggle' name='attr_usecc'><div class='skill toggler'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_disciplinestyle_info'></span></span>
      <span class='skillname'>Discipline Styles<input type='hidden' name='attr_disciplinestyle_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='disciplinestyle'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_disciplinestyle_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='disciplinestyle' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_disciplinestyle_bonus'></span></button></div>
<button type='action' data-skill='disciplinestyle' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_disciplinestylesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationdisciplinestyle'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='disciplinestyle'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='disciplinestyle' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='brawn'></span>
      <span class='skill_stat'><span data-i18n='co'>co</span> + <span data-i18n='sd'>sd</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='bodydevelopment'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_bodydevelopment_info'></span>
Uses (Lvl/Total) <span name='attr_bodydevelopment_usecount'></span> / <span name='attr_bodydevelopment_usecounttotal'></span></span></span>
      <span class='skillname'>Body Development<input type='hidden' name='attr_bodydevelopment_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_bodydevelopment_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='bodydevelopment' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bodydevelopment_bonus'></span></button></div>
<button type='action' data-skill='bodydevelopment' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_bodydevelopmentsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='fortitude'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_fortitude_info'></span>
Uses (Lvl/Total) <span name='attr_fortitude_usecount'></span> / <span name='attr_fortitude_usecounttotal'></span></span></span>
      <span class='skillname'>Fortitude<input type='hidden' name='attr_fortitude_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_fortitude_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='fortitude' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_fortitude_bonus'></span></button></div>
<button type='action' data-skill='fortitude' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_fortitudesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='weighttraining'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_weighttraining_info'></span>
Uses (Lvl/Total) <span name='attr_weighttraining_usecount'></span> / <span name='attr_weighttraining_usecounttotal'></span></span></span>
      <span class='skillname'>Weight-training<input type='hidden' name='attr_weighttraining_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_weighttraining_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='weighttraining' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_weighttraining_bonus'></span></button></div>
<button type='action' data-skill='weighttraining' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_weighttrainingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='combatexpertise'></span>
    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='blindfighting'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_blindfighting_info'></span>
Uses (Lvl/Total) <span name='attr_blindfighting_usecount'></span> / <span name='attr_blindfighting_usecounttotal'></span></span></span>
      <span class='skillname'>Blind Fighting<input type='hidden' name='attr_blindfighting_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_blindfighting_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='blindfighting' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_blindfighting_bonus'></span></button></div>
<button type='action' data-skill='blindfighting' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_blindfightingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<input type='checkbox' class='toggle' name='attr_usecc'><div class='skill toggler'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_combatstyle_info'></span></span>
      <span class='skillname'>Combat Styles<input type='hidden' name='attr_combatstyle_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='combatstyle'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_combatstyle_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='combatstyle' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_combatstyle_bonus'></span></button></div>
<button type='action' data-skill='combatstyle' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_combatstylesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationcombatstyle'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='combatstyle'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='combatstyle' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='disarm'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_disarm_info'></span>
Uses (Lvl/Total) <span name='attr_disarm_usecount'></span> / <span name='attr_disarm_usecounttotal'></span></span></span>
      <span class='skillname'>Disarm<input type='hidden' name='attr_disarm_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_disarm_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='disarm' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_disarm_bonus'></span></button></div>
<button type='action' data-skill='disarm' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_disarmsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='footwork'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_footwork_info'></span>
Uses (Lvl/Total) <span name='attr_footwork_usecount'></span> / <span name='attr_footwork_usecounttotal'></span></span></span>
      <span class='skillname'>Footwork<input type='hidden' name='attr_footwork_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_footwork_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='footwork' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_footwork_bonus'></span></button></div>
<button type='action' data-skill='footwork' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_footworksubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='multipleattacks'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_multipleattacks_info'></span>
Uses (Lvl/Total) <span name='attr_multipleattacks_usecount'></span> / <span name='attr_multipleattacks_usecounttotal'></span></span></span>
      <span class='skillname'>Multiple Attacks<input type='hidden' name='attr_multipleattacks_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_multipleattacks_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='multipleattacks' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_multipleattacks_bonus'></span></button></div>
<button type='action' data-skill='multipleattacks' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_multipleattackssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='reversestrike'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_reversestrike_info'></span>
Uses (Lvl/Total) <span name='attr_reversestrike_usecount'></span> / <span name='attr_reversestrike_usecounttotal'></span></span></span>
      <span class='skillname'>Reverse Strike<input type='hidden' name='attr_reversestrike_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_reversestrike_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='reversestrike' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_reversestrike_bonus'></span></button></div>
<button type='action' data-skill='reversestrike' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_reversestrikesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='combattraining'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='st'>st</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_meleeweapons_info'></span></span>
      <span class='skillname'>Melee Weapons<input type='hidden' name='attr_meleeweapons_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_meleeweapons_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='meleeweapons' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_meleeweapons_bonus'></span></button></div>
</div>
<fieldset class='repeating_meleeweaponssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='blade'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_blade_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='blade'>Blade</span></span>
<div class='skill_ranks'><span name='attr_blade_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='blade' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_blade_bonus'></span>
</button></div><button type='action' data-skill='blade' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_bladesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='chain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_chain_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='chain'>Chain</span></span>
<div class='skill_ranks'><span name='attr_chain_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='chain' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_chain_bonus'></span>
</button></div><button type='action' data-skill='chain' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_chainsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='hafted'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_hafted_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='hafted'>Hafted</span></span>
<div class='skill_ranks'><span name='attr_hafted_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='hafted' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_hafted_bonus'></span>
</button></div><button type='action' data-skill='hafted' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_haftedsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='greaterblade'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_greaterblade_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='greaterblade'>Greater Blade</span></span>
<div class='skill_ranks'><span name='attr_greaterblade_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='greaterblade' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_greaterblade_bonus'></span>
</button></div><button type='action' data-skill='greaterblade' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_greaterbladesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='greaterchain'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_greaterchain_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='greaterchain'>Greater Chain</span></span>
<div class='skill_ranks'><span name='attr_greaterchain_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='greaterchain' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_greaterchain_bonus'></span>
</button></div><button type='action' data-skill='greaterchain' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_greaterchainsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='greaterhafter'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_greaterhafter_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='greaterhafter'>Greater Hafted</span></span>
<div class='skill_ranks'><span name='attr_greaterhafter_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='greaterhafter' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_greaterhafter_bonus'></span>
</button></div><button type='action' data-skill='greaterhafter' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_greaterhaftersubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='polearm'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_polearm_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='polearm'>Pole Arm</span></span>
<div class='skill_ranks'><span name='attr_polearm_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='polearm' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_polearm_bonus'></span>
</button></div><button type='action' data-skill='polearm' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_polearmsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='meleeexotic'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_meleeexotic_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='meleeexotic'>Exotic</span></span>
<div class='skill_ranks'><span name='attr_meleeexotic_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='meleeexotic' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_meleeexotic_bonus'></span>
</button></div><button type='action' data-skill='meleeexotic' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_meleeexoticsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_rangedweapons_info'></span></span>
      <span class='skillname'>Ranged Weapons<input type='hidden' name='attr_rangedweapons_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_rangedweapons_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='rangedweapons' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_rangedweapons_bonus'></span></button></div>
</div>
<fieldset class='repeating_rangedweaponssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='bow'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_bow_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='bow'>Bow</span></span>
<div class='skill_ranks'><span name='attr_bow_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='bow' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bow_bonus'></span>
</button></div><button type='action' data-skill='bow' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_bowsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='crossbow'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_crossbow_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='crossbow'>Crossbow</span></span>
<div class='skill_ranks'><span name='attr_crossbow_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='crossbow' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_crossbow_bonus'></span>
</button></div><button type='action' data-skill='crossbow' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_crossbowsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='sling'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_sling_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='sling'>Sling</span></span>
<div class='skill_ranks'><span name='attr_sling_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='sling' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_sling_bonus'></span>
</button></div><button type='action' data-skill='sling' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_slingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='thrown'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_thrown_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='thrown'>Thrown</span></span>
<div class='skill_ranks'><span name='attr_thrown_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='thrown' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_thrown_bonus'></span>
</button></div><button type='action' data-skill='thrown' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_thrownsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='rangedexotic'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_rangedexotic_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='rangedexotic'>Exotic</span></span>
<div class='skill_ranks'><span name='attr_rangedexotic_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='rangedexotic' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_rangedexotic_bonus'></span>
</button></div><button type='action' data-skill='rangedexotic' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_rangedexoticsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='shield'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_shield_info'></span>
Uses (Lvl/Total) <span name='attr_shield_usecount'></span> / <span name='attr_shield_usecounttotal'></span></span></span>
      <span class='skillname'>Shield<input type='hidden' name='attr_shield_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_shield_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='shield' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_shield_bonus'></span></button></div>
<button type='action' data-skill='shield' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_shieldsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_unarmed_info'></span></span>
      <span class='skillname'>Unarmed<input type='hidden' name='attr_unarmed_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_unarmed_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='unarmed' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_unarmed_bonus'></span></button></div>
</div>
<fieldset class='repeating_unarmedsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='strikes'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_strikes_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='strikes'>Strikes</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_strikes_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='strikes' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_strikes_bonus'></span>
</button></div><button type='action' data-skill='strikes' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_strikessubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='sweepsthrows'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_sweepsthrows_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='sweepsthrows'>Sweeps & Throws</span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_sweepsthrows_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='sweepsthrows' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_sweepsthrows_bonus'></span>
</button></div><button type='action' data-skill='sweepsthrows' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_sweepsthrowssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='wrestling'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_wrestling_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='wrestling'>Wrestling</span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_wrestling_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='wrestling' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_wrestling_bonus'></span>
</button></div><button type='action' data-skill='wrestling' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_wrestlingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='beak'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_beak_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='beak'>Beak</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_beak_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='beak' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_beak_bonus'></span>
</button></div><button type='action' data-skill='beak' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_beaksubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='bite'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_bite_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='bite'>Bite</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_bite_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='bite' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bite_bonus'></span>
</button></div><button type='action' data-skill='bite' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_bitesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='claw'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_claw_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='claw'>Claw</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_claw_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='claw' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_claw_bonus'></span>
</button></div><button type='action' data-skill='claw' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_clawsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='horn'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_horn_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='horn'>Horn</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_horn_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='horn' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_horn_bonus'></span>
</button></div><button type='action' data-skill='horn' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_hornsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ram'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ram_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ram'>Ram</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_ram_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ram' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ram_bonus'></span>
</button></div><button type='action' data-skill='ram' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ramsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='stinger'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_stinger_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='stinger'>Stinger</span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_stinger_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='stinger' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_stinger_bonus'></span>
</button></div><button type='action' data-skill='stinger' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_stingersubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='trample'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_trample_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='trample'>Trample</span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_trample_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='trample' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_trample_bonus'></span>
</button></div><button type='action' data-skill='trample' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_tramplesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='composition'></span>
      <span class='skill_stat'><span data-i18n='em'>em</span> + <span data-i18n='in'>in</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='illusioncrafting'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_illusioncrafting_info'></span>
Uses (Lvl/Total) <span name='attr_illusioncrafting_usecount'></span> / <span name='attr_illusioncrafting_usecounttotal'></span></span></span>
      <span class='skillname'>Illusion Crafting<input type='hidden' name='attr_illusioncrafting_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_illusioncrafting_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='illusioncrafting' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_illusioncrafting_bonus'></span></button></div>
<button type='action' data-skill='illusioncrafting' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_illusioncraftingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='musicalcomposition'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_musicalcomposition_info'></span>
Uses (Lvl/Total) <span name='attr_musicalcomposition_usecount'></span> / <span name='attr_musicalcomposition_usecounttotal'></span></span></span>
      <span class='skillname'>Musical Composition<input type='hidden' name='attr_musicalcomposition_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_musicalcomposition_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='musicalcomposition' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_musicalcomposition_bonus'></span></button></div>
<button type='action' data-skill='musicalcomposition' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_musicalcompositionsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='writing'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_writing_info'></span>
Uses (Lvl/Total) <span name='attr_writing_usecount'></span> / <span name='attr_writing_usecounttotal'></span></span></span>
      <span class='skillname'>Writing<input type='hidden' name='attr_writing_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_writing_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='writing' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_writing_bonus'></span></button></div>
<button type='action' data-skill='writing' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_writingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='crafting'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='me'>me</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='culinary'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_culinary_info'></span>
Uses (Lvl/Total) <span name='attr_culinary_usecount'></span> / <span name='attr_culinary_usecounttotal'></span></span></span>
      <span class='skillname'>Culinary<input type='hidden' name='attr_culinary_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_culinary_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='culinary' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_culinary_bonus'></span></button></div>
<button type='action' data-skill='culinary' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_culinarysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='drawingpainting'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_drawingpainting_info'></span>
Uses (Lvl/Total) <span name='attr_drawingpainting_usecount'></span> / <span name='attr_drawingpainting_usecounttotal'></span></span></span>
      <span class='skillname'>Drawing/Painting<input type='hidden' name='attr_drawingpainting_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_drawingpainting_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='drawingpainting' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_drawingpainting_bonus'></span></button></div>
<button type='action' data-skill='drawingpainting' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_drawingpaintingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='fabriccraft'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_fabriccraft_info'></span>
Uses (Lvl/Total) <span name='attr_fabriccraft_usecount'></span> / <span name='attr_fabriccraft_usecounttotal'></span></span></span>
      <span class='skillname'>Fabric Craft<input type='hidden' name='attr_fabriccraft_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_fabriccraft_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='fabriccraft' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_fabriccraft_bonus'></span></button></div>
<button type='action' data-skill='fabriccraft' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_fabriccraftsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='leathercraft'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_leathercraft_info'></span>
Uses (Lvl/Total) <span name='attr_leathercraft_usecount'></span> / <span name='attr_leathercraft_usecounttotal'></span></span></span>
      <span class='skillname'>Leathercraft<input type='hidden' name='attr_leathercraft_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_leathercraft_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='leathercraft' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_leathercraft_bonus'></span></button></div>
<button type='action' data-skill='leathercraft' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_leathercraftsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='metalcraft'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_metalcraft_info'></span>
Uses (Lvl/Total) <span name='attr_metalcraft_usecount'></span> / <span name='attr_metalcraft_usecounttotal'></span></span></span>
      <span class='skillname'>Metalcraft<input type='hidden' name='attr_metalcraft_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_metalcraft_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='metalcraft' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_metalcraft_bonus'></span></button></div>
<button type='action' data-skill='metalcraft' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_metalcraftsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='stonecraft'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_stonecraft_info'></span>
Uses (Lvl/Total) <span name='attr_stonecraft_usecount'></span> / <span name='attr_stonecraft_usecounttotal'></span></span></span>
      <span class='skillname'>Stonecraft<input type='hidden' name='attr_stonecraft_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_stonecraft_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='stonecraft' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_stonecraft_bonus'></span></button></div>
<button type='action' data-skill='stonecraft' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_stonecraftsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='woodcraft'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_woodcraft_info'></span>
Uses (Lvl/Total) <span name='attr_woodcraft_usecount'></span> / <span name='attr_woodcraft_usecounttotal'></span></span></span>
      <span class='skillname'>Woodcraft<input type='hidden' name='attr_woodcraft_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_woodcraft_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='woodcraft' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_woodcraft_bonus'></span></button></div>
<button type='action' data-skill='woodcraft' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_woodcraftsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='delving'></span>
      <span class='skill_stat'><span data-i18n='em'>em</span> + <span data-i18n='in'>in</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='attunement'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_attunement_info'></span>
Uses (Lvl/Total) <span name='attr_attunement_usecount'></span> / <span name='attr_attunement_usecounttotal'></span></span></span>
      <span class='skillname'>Attunement<input type='hidden' name='attr_attunement_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_attunement_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='attunement' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_attunement_bonus'></span></button></div>
<button type='action' data-skill='attunement' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_attunementsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='runes'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_runes_info'></span>
Uses (Lvl/Total) <span name='attr_runes_usecount'></span> / <span name='attr_runes_usecounttotal'></span></span></span>
      <span class='skillname'>Runes<input type='hidden' name='attr_runes_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_runes_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='runes' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_runes_bonus'></span></button></div>
<button type='action' data-skill='runes' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_runessubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='environmental'></span>
      <span class='skill_stat'><span data-i18n='in'>in</span> + <span data-i18n='me'>me</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='navigation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_navigation_info'></span>
Uses (Lvl/Total) <span name='attr_navigation_usecount'></span> / <span name='attr_navigation_usecounttotal'></span></span></span>
      <span class='skillname'>Navigation<input type='hidden' name='attr_navigation_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_navigation_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='navigation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_navigation_bonus'></span></button></div>
<button type='action' data-skill='navigation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_navigationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_piloting_info'></span></span>
      <span class='skillname'>Piloting<input type='hidden' name='attr_piloting_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='piloting'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_piloting_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='piloting' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_piloting_bonus'></span></button></div>
<button type='action' data-skill='piloting' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_pilotingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationpiloting'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='piloting'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='piloting' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_survival_info'></span></span>
      <span class='skillname'>Survival<input type='hidden' name='attr_survival_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_survival_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='survival' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_survival_bonus'></span></button></div>
</div>
<fieldset class='repeating_survivalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialalpine'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialalpine_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialalpine'>Alpine (A)</span></span>
<div class='skill_ranks'><span name='attr_survivialalpine_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialalpine' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialalpine_bonus'></span>
</button></div><button type='action' data-skill='survivialalpine' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialalpinesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialoceans'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialoceans_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialoceans'>Oceans (O)</span></span>
<div class='skill_ranks'><span name='attr_survivialoceans_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialoceans' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialoceans_bonus'></span>
</button></div><button type='action' data-skill='survivialoceans' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialoceanssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialunderground'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialunderground_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialunderground'>Underground (U)</span></span>
<div class='skill_ranks'><span name='attr_survivialunderground_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialunderground' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialunderground_bonus'></span>
</button></div><button type='action' data-skill='survivialunderground' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialundergroundsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialicecaps'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialicecaps_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialicecaps'>Ice Caps (I)</span></span>
<div class='skill_ranks'><span name='attr_survivialicecaps_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialicecaps' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialicecaps_bonus'></span>
</button></div><button type='action' data-skill='survivialicecaps' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialicecapssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialtundra'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialtundra_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialtundra'>Tundra (T)</span></span>
<div class='skill_ranks'><span name='attr_survivialtundra_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialtundra' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialtundra_bonus'></span>
</button></div><button type='action' data-skill='survivialtundra' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialtundrasubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialboreal'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialboreal_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialboreal'>Boreal Forest (B)</span></span>
<div class='skill_ranks'><span name='attr_survivialboreal_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialboreal' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialboreal_bonus'></span>
</button></div><button type='action' data-skill='survivialboreal' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialborealsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialshrublands'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialshrublands_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialshrublands'>Desert Shrublands (X)</span></span>
<div class='skill_ranks'><span name='attr_survivialshrublands_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialshrublands' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialshrublands_bonus'></span>
</button></div><button type='action' data-skill='survivialshrublands' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialshrublandssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialprairies'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialprairies_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialprairies'>Prairies & Steppes (P)</span></span>
<div class='skill_ranks'><span name='attr_survivialprairies_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialprairies' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialprairies_bonus'></span>
</button></div><button type='action' data-skill='survivialprairies' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialprairiessubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialtemperate'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialtemperate_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialtemperate'>Temperate Forests (F)</span></span>
<div class='skill_ranks'><span name='attr_survivialtemperate_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialtemperate' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialtemperate_bonus'></span>
</button></div><button type='action' data-skill='survivialtemperate' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialtemperatesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialhotdeserts'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialhotdeserts_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialhotdeserts'>Hot Deserts (D)</span></span>
<div class='skill_ranks'><span name='attr_survivialhotdeserts_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialhotdeserts' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialhotdeserts_bonus'></span>
</button></div><button type='action' data-skill='survivialhotdeserts' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialhotdesertssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialsavannas'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialsavannas_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialsavannas'>Savannas (S)</span></span>
<div class='skill_ranks'><span name='attr_survivialsavannas_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialsavannas' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialsavannas_bonus'></span>
</button></div><button type='action' data-skill='survivialsavannas' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialsavannassubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialtropical'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialtropical_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialtropical'>Tropical Forest (J)</span></span>
<div class='skill_ranks'><span name='attr_survivialtropical_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialtropical' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialtropical_bonus'></span>
</button></div><button type='action' data-skill='survivialtropical' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialtropicalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialurban'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialurban_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialurban'>Urban (C)</span></span>
<div class='skill_ranks'><span name='attr_survivialurban_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialurban' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialurban_bonus'></span>
</button></div><button type='action' data-skill='survivialurban' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialurbansubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='survivialxeno'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_survivialxeno_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='survivialxeno'>Xeno</span></span>
<div class='skill_ranks'><span name='attr_survivialxeno_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='survivialxeno' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_survivialxeno_bonus'></span>
</button></div><button type='action' data-skill='survivialxeno' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_survivialxenosubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='gymnastic'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='qu'>qu</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='acrobatics'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_acrobatics_info'></span>
Uses (Lvl/Total) <span name='attr_acrobatics_usecount'></span> / <span name='attr_acrobatics_usecounttotal'></span></span></span>
      <span class='skillname'>Acrobatics<input type='hidden' name='attr_acrobatics_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_acrobatics_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='acrobatics' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_acrobatics_bonus'></span></button></div>
<button type='action' data-skill='acrobatics' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_acrobaticssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='contortions'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_contortions_info'></span>
Uses (Lvl/Total) <span name='attr_contortions_usecount'></span> / <span name='attr_contortions_usecounttotal'></span></span></span>
      <span class='skillname'>Contortions<input type='hidden' name='attr_contortions_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_contortions_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='contortions' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_contortions_bonus'></span></button></div>
<button type='action' data-skill='contortions' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_contortionssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='jumping'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_jumping_info'></span>
Uses (Lvl/Total) <span name='attr_jumping_usecount'></span> / <span name='attr_jumping_usecounttotal'></span></span></span>
      <span class='skillname'>Jumping<input type='hidden' name='attr_jumping_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='st'>st</span></span>
<div class='skill_ranks'><span name='attr_jumping_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='jumping' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_jumping_bonus'></span></button></div>
<button type='action' data-skill='jumping' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_jumpingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='lore'></span>
      <span class='skill_stat'><span data-i18n='me'>me</span> + <span data-i18n='me'>me</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_creaturelore_info'></span></span>
      <span class='skillname'>Creature Lore<input type='hidden' name='attr_creaturelore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_creaturelore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='creaturelore' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_creaturelore_bonus'></span></button></div>
</div>
<fieldset class='repeating_creatureloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloreartificial'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloreartificial_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloreartificial'>Artificial Creature</span></span>
<div class='skill_ranks'><span name='attr_creatureloreartificial_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloreartificial' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloreartificial_bonus'></span>
</button></div><button type='action' data-skill='creatureloreartificial' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloreartificialsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloredemon'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloredemon_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloredemon'>Demon</span></span>
<div class='skill_ranks'><span name='attr_creatureloredemon_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloredemon' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloredemon_bonus'></span>
</button></div><button type='action' data-skill='creatureloredemon' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloredemonsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloredragon'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloredragon_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloredragon'>Dragon</span></span>
<div class='skill_ranks'><span name='attr_creatureloredragon_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloredragon' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloredragon_bonus'></span>
</button></div><button type='action' data-skill='creatureloredragon' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloredragonsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloreelemental'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloreelemental_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloreelemental'>Elemental</span></span>
<div class='skill_ranks'><span name='attr_creatureloreelemental_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloreelemental' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloreelemental_bonus'></span>
</button></div><button type='action' data-skill='creatureloreelemental' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloreelementalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloreextraplaner'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloreextraplaner_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloreextraplaner'>Extra-planer</span></span>
<div class='skill_ranks'><span name='attr_creatureloreextraplaner_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloreextraplaner' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloreextraplaner_bonus'></span>
</button></div><button type='action' data-skill='creatureloreextraplaner' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloreextraplanersubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creaturelorefaerie'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creaturelorefaerie_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creaturelorefaerie'>Faerie</span></span>
<div class='skill_ranks'><span name='attr_creaturelorefaerie_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creaturelorefaerie' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creaturelorefaerie_bonus'></span>
</button></div><button type='action' data-skill='creaturelorefaerie' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creaturelorefaeriesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creatureloreundead'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creatureloreundead_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creatureloreundead'>Undead</span></span>
<div class='skill_ranks'><span name='attr_creatureloreundead_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creatureloreundead' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creatureloreundead_bonus'></span>
</button></div><button type='action' data-skill='creatureloreundead' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creatureloreundeadsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_historiclore_info'></span></span>
      <span class='skillname'>Historic Lore<input type='hidden' name='attr_historiclore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='historiclore'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_historiclore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='historiclore' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_historiclore_bonus'></span></button></div>
<button type='action' data-skill='historiclore' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_historicloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationhistoriclore'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='historiclore'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='historiclore' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_language_info'></span></span>
      <span class='skillname'>Language<input type='hidden' name='attr_language_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='language'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_language_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='language' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_language_bonus'></span></button></div>
<button type='action' data-skill='language' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_languagesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationlanguage'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='language'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='language' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_materialslore_info'></span></span>
      <span class='skillname'>Materials Lore<input type='hidden' name='attr_materialslore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_materialslore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='materialslore' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_materialslore_bonus'></span></button></div>
</div>
<fieldset class='repeating_materialsloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialslorebone'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialslorebone_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialslorebone'>Bone/Horn</span></span>
<div class='skill_ranks'><span name='attr_materialslorebone_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialslorebone' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialslorebone_bonus'></span>
</button></div><button type='action' data-skill='materialslorebone' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialslorebonesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialslorefabric'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialslorefabric_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialslorefabric'>Fabrics</span></span>
<div class='skill_ranks'><span name='attr_materialslorefabric_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialslorefabric' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialslorefabric_bonus'></span>
</button></div><button type='action' data-skill='materialslorefabric' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialslorefabricsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialsloreleather'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialsloreleather_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialsloreleather'>Leather</span></span>
<div class='skill_ranks'><span name='attr_materialsloreleather_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialsloreleather' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialsloreleather_bonus'></span>
</button></div><button type='action' data-skill='materialsloreleather' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialsloreleathersubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialsloremetal'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialsloremetal_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialsloremetal'>Metal</span></span>
<div class='skill_ranks'><span name='attr_materialsloremetal_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialsloremetal' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialsloremetal_bonus'></span>
</button></div><button type='action' data-skill='materialsloremetal' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialsloremetalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialslorestone'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialslorestone_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialslorestone'>Stone</span></span>
<div class='skill_ranks'><span name='attr_materialslorestone_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialslorestone' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialslorestone_bonus'></span>
</button></div><button type='action' data-skill='materialslorestone' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialslorestonesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='materialslorewood'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_materialslorewood_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='materialslorewood'>Wood</span></span>
<div class='skill_ranks'><span name='attr_materialslorewood_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='materialslorewood' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_materialslorewood_bonus'></span>
</button></div><button type='action' data-skill='materialslorewood' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_materialslorewoodsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_raciallore_info'></span></span>
      <span class='skillname'>Racial Lore<input type='hidden' name='attr_raciallore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='raciallore'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_raciallore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='raciallore' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_raciallore_bonus'></span></button></div>
<button type='action' data-skill='raciallore' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_racialloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationraciallore'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='raciallore'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='raciallore' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_regionlore_info'></span></span>
      <span class='skillname'>Region Lore<input type='hidden' name='attr_regionlore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='regionlore'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_regionlore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='regionlore' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_regionlore_bonus'></span></button></div>
<button type='action' data-skill='regionlore' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_regionloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationregionlore'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='regionlore'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='regionlore' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_religionphilosophy_info'></span></span>
      <span class='skillname'>Religion/Philosophy<input type='hidden' name='attr_religionphilosophy_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='religionphilosophy'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_religionphilosophy_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='religionphilosophy' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_religionphilosophy_bonus'></span></button></div>
<button type='action' data-skill='religionphilosophy' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_religionphilosophysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationreligionphilosophy'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='religionphilosophy'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='religionphilosophy' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='spelllore'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_spelllore_info'></span>
Uses (Lvl/Total) <span name='attr_spelllore_usecount'></span> / <span name='attr_spelllore_usecounttotal'></span></span></span>
      <span class='skillname'>Spell Lore<input type='hidden' name='attr_spelllore_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_spelllore_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='spelllore' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_spelllore_bonus'></span></button></div>
<button type='action' data-skill='spelllore' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_spellloresubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='magicalexpertise'></span>
    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_grace_info'></span></span>
      <span class='skillname'>Grace<input type='hidden' name='attr_grace_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='grace'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_grace_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='grace' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_grace_bonus'></span></button></div>
<button type='action' data-skill='grace' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_gracesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationgrace'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='grace'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='grace' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_spelltrickery_info'></span></span>
      <span class='skillname'>Spell Trickery<input type='hidden' name='attr_spelltrickery_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='spelltrickery'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_spelltrickery_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='spelltrickery' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_spelltrickery_bonus'></span></button></div>
<button type='action' data-skill='spelltrickery' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_spelltrickerysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationspelltrickery'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='spelltrickery'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='spelltrickery' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='transcendence'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_transcendence_info'></span>
Uses (Lvl/Total) <span name='attr_transcendence_usecount'></span> / <span name='attr_transcendence_usecounttotal'></span></span></span>
      <span class='skillname'>Transcendence<input type='hidden' name='attr_transcendence_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span></span>
<div class='skill_ranks'><span name='attr_transcendence_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='transcendence' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_transcendence_bonus'></span></button></div>
<button type='action' data-skill='transcendence' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_transcendencesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='medical'></span>
      <span class='skill_stat'><span data-i18n='in'>in</span> + <span data-i18n='me'>me</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='herbalism'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_herbalism_info'></span>
Uses (Lvl/Total) <span name='attr_herbalism_usecount'></span> / <span name='attr_herbalism_usecounttotal'></span></span></span>
      <span class='skillname'>Herbalism<input type='hidden' name='attr_herbalism_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_herbalism_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='herbalism' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_herbalism_bonus'></span></button></div>
<button type='action' data-skill='herbalism' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_herbalismsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='medicine'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_medicine_info'></span>
Uses (Lvl/Total) <span name='attr_medicine_usecount'></span> / <span name='attr_medicine_usecounttotal'></span></span></span>
      <span class='skillname'>Medicine<input type='hidden' name='attr_medicine_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_medicine_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='medicine' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_medicine_bonus'></span></button></div>
<button type='action' data-skill='medicine' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_medicinesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='poisonmastery'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_poisonmastery_info'></span>
Uses (Lvl/Total) <span name='attr_poisonmastery_usecount'></span> / <span name='attr_poisonmastery_usecounttotal'></span></span></span>
      <span class='skillname'>Poison Mastery<input type='hidden' name='attr_poisonmastery_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_poisonmastery_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='poisonmastery' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_poisonmastery_bonus'></span></button></div>
<button type='action' data-skill='poisonmastery' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_poisonmasterysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='mentaldiscipline'></span>
      <span class='skill_stat'><span data-i18n='pr'>pr</span> + <span data-i18n='sd'>sd</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='controllycanthropy'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_controllycanthropy_info'></span>
Uses (Lvl/Total) <span name='attr_controllycanthropy_usecount'></span> / <span name='attr_controllycanthropy_usecounttotal'></span></span></span>
      <span class='skillname'>Control Lycanthropy<input type='hidden' name='attr_controllycanthropy_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_controllycanthropy_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='controllycanthropy' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_controllycanthropy_bonus'></span></button></div>
<button type='action' data-skill='controllycanthropy' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_controllycanthropysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='meditation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_meditation_info'></span>
Uses (Lvl/Total) <span name='attr_meditation_usecount'></span> / <span name='attr_meditation_usecounttotal'></span></span></span>
      <span class='skillname'>Meditation<input type='hidden' name='attr_meditation_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_meditation_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='meditation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_meditation_bonus'></span></button></div>
<button type='action' data-skill='meditation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_meditationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='mentalfocus'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_mentalfocus_info'></span>
Uses (Lvl/Total) <span name='attr_mentalfocus_usecount'></span> / <span name='attr_mentalfocus_usecounttotal'></span></span></span>
      <span class='skillname'>Mental Focus<input type='hidden' name='attr_mentalfocus_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_mentalfocus_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='mentalfocus' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_mentalfocus_bonus'></span></button></div>
<button type='action' data-skill='mentalfocus' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_mentalfocussubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='movement'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='st'>st</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='climbing'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_climbing_info'></span>
Uses (Lvl/Total) <span name='attr_climbing_usecount'></span> / <span name='attr_climbing_usecounttotal'></span></span></span>
      <span class='skillname'>Climbing<input type='hidden' name='attr_climbing_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_climbing_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='climbing' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_climbing_bonus'></span></button></div>
<button type='action' data-skill='climbing' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_climbingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='flying'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_flying_info'></span>
Uses (Lvl/Total) <span name='attr_flying_usecount'></span> / <span name='attr_flying_usecounttotal'></span></span></span>
      <span class='skillname'>Flying<input type='hidden' name='attr_flying_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_flying_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='flying' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_flying_bonus'></span></button></div>
<button type='action' data-skill='flying' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_flyingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='running'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_running_info'></span>
Uses (Lvl/Total) <span name='attr_running_usecount'></span> / <span name='attr_running_usecounttotal'></span></span></span>
      <span class='skillname'>Running<input type='hidden' name='attr_running_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_running_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='running' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_running_bonus'></span></button></div>
<button type='action' data-skill='running' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_runningsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='swimming'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_swimming_info'></span>
Uses (Lvl/Total) <span name='attr_swimming_usecount'></span> / <span name='attr_swimming_usecounttotal'></span></span></span>
      <span class='skillname'>Swimming<input type='hidden' name='attr_swimming_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_swimming_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='swimming' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_swimming_bonus'></span></button></div>
<button type='action' data-skill='swimming' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_swimmingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='performanceart'></span>
      <span class='skill_stat'><span data-i18n='em'>em</span> + <span data-i18n='pr'>pr</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='acting'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_acting_info'></span>
Uses (Lvl/Total) <span name='attr_acting_usecount'></span> / <span name='attr_acting_usecounttotal'></span></span></span>
      <span class='skillname'>Acting<input type='hidden' name='attr_acting_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='me'>me</span></span>
<div class='skill_ranks'><span name='attr_acting_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='acting' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_acting_bonus'></span></button></div>
<button type='action' data-skill='acting' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_actingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_music_info'></span></span>
      <span class='skillname'>Music<input type='hidden' name='attr_music_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='me'>me</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='music'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_music_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='music' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_music_bonus'></span></button></div>
<button type='action' data-skill='music' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_musicsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationmusic'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='music'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='music' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='stagemagic'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_stagemagic_info'></span>
Uses (Lvl/Total) <span name='attr_stagemagic_usecount'></span> / <span name='attr_stagemagic_usecounttotal'></span></span></span>
      <span class='skillname'>Stage Magic<input type='hidden' name='attr_stagemagic_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_stagemagic_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='stagemagic' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_stagemagic_bonus'></span></button></div>
<button type='action' data-skill='stagemagic' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_stagemagicsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='powermanipulation'></span>
      <span class='skill_stat'><span data-i18n='rs'>rs</span> + <span data-i18n='rs'>rs</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='channeling'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_channeling_info'></span>
Uses (Lvl/Total) <span name='attr_channeling_usecount'></span> / <span name='attr_channeling_usecounttotal'></span></span></span>
      <span class='skillname'>Channeling<input type='hidden' name='attr_channeling_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_channeling_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='channeling' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_channeling_bonus'></span></button></div>
<button type='action' data-skill='channeling' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_channelingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_directedspell_info'></span></span>
      <span class='skillname'>Directed Spell<input type='hidden' name='attr_directedspell_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_directedspell_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='directedspell' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_directedspell_bonus'></span></button></div>
</div>
<fieldset class='repeating_directedspellsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='elementalbolts'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_elementalbolts_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='elementalbolts'>Elemental Bolts</span></span>
<div class='skill_ranks'><span name='attr_elementalbolts_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='elementalbolts' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_elementalbolts_bonus'></span>
</button></div><button type='action' data-skill='elementalbolts' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_elementalboltssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='illusionaryattacks'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_illusionaryattacks_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='illusionaryattacks'>Illusionary Attacks</span></span>
<div class='skill_ranks'><span name='attr_illusionaryattacks_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='illusionaryattacks' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_illusionaryattacks_bonus'></span>
</button></div><button type='action' data-skill='illusionaryattacks' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_illusionaryattackssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='hurling'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_hurling_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='hurling'>Hurling</span></span>
<div class='skill_ranks'><span name='attr_hurling_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='hurling' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_hurling_bonus'></span>
</button></div><button type='action' data-skill='hurling' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_hurlingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='powerdevelopment'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_powerdevelopment_info'></span>
Uses (Lvl/Total) <span name='attr_powerdevelopment_usecount'></span> / <span name='attr_powerdevelopment_usecounttotal'></span></span></span>
      <span class='skillname'>Power Development<input type='hidden' name='attr_powerdevelopment_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='co'>co</span></span>
<div class='skill_ranks'><span name='attr_powerdevelopment_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='powerdevelopment' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_powerdevelopment_bonus'></span></button></div>
<button type='action' data-skill='powerdevelopment' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_powerdevelopmentsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='powerprojection'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_powerprojection_info'></span>
Uses (Lvl/Total) <span name='attr_powerprojection_usecount'></span> / <span name='attr_powerprojection_usecounttotal'></span></span></span>
      <span class='skillname'>Power Projection<input type='hidden' name='attr_powerprojection_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='sd'>sd</span></span>
<div class='skill_ranks'><span name='attr_powerprojection_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='powerprojection' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_powerprojection_bonus'></span></button></div>
<button type='action' data-skill='powerprojection' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_powerprojectionsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='science'></span>
      <span class='skill_stat'><span data-i18n='me'>me</span> + <span data-i18n='re'>re</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='architecture'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_architecture_info'></span>
Uses (Lvl/Total) <span name='attr_architecture_usecount'></span> / <span name='attr_architecture_usecounttotal'></span></span></span>
      <span class='skillname'>Architecture<input type='hidden' name='attr_architecture_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_architecture_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='architecture' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_architecture_bonus'></span></button></div>
<button type='action' data-skill='architecture' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_architecturesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='astronomy'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_astronomy_info'></span>
Uses (Lvl/Total) <span name='attr_astronomy_usecount'></span> / <span name='attr_astronomy_usecounttotal'></span></span></span>
      <span class='skillname'>Astronomy<input type='hidden' name='attr_astronomy_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_astronomy_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='astronomy' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_astronomy_bonus'></span></button></div>
<button type='action' data-skill='astronomy' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_astronomysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='engineering'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_engineering_info'></span>
Uses (Lvl/Total) <span name='attr_engineering_usecount'></span> / <span name='attr_engineering_usecounttotal'></span></span></span>
      <span class='skillname'>Engineering<input type='hidden' name='attr_engineering_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_engineering_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='engineering' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_engineering_bonus'></span></button></div>
<button type='action' data-skill='engineering' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_engineeringsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='mathematics'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_mathematics_info'></span>
Uses (Lvl/Total) <span name='attr_mathematics_usecount'></span> / <span name='attr_mathematics_usecounttotal'></span></span></span>
      <span class='skillname'>Mathematics<input type='hidden' name='attr_mathematics_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span></span>
<div class='skill_ranks'><span name='attr_mathematics_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='mathematics' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_mathematics_bonus'></span></button></div>
<button type='action' data-skill='mathematics' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_mathematicssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='social'></span>
      <span class='skill_stat'><span data-i18n='em'>em</span> + <span data-i18n='in'>in</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_influence_info'></span></span>
      <span class='skillname'>Influence<input type='hidden' name='attr_influence_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_influence_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='influence' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_influence_bonus'></span></button></div>
</div>
<fieldset class='repeating_influencesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='charm'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_charm_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='charm'>Charm</span></span>
<div class='skill_ranks'><span name='attr_charm_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='charm' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_charm_bonus'></span>
</button></div><button type='action' data-skill='charm' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_charmsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='duping'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_duping_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='duping'>Duping</span></span>
<div class='skill_ranks'><span name='attr_duping_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='duping' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_duping_bonus'></span>
</button></div><button type='action' data-skill='duping' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_dupingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='intimidation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_intimidation_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='intimidation'>Intimidation</span></span>
<div class='skill_ranks'><span name='attr_intimidation_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='intimidation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_intimidation_bonus'></span>
</button></div><button type='action' data-skill='intimidation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_intimidationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='leadership'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_leadership_info'></span>
Uses (Lvl/Total) <span name='attr_leadership_usecount'></span> / <span name='attr_leadership_usecounttotal'></span></span></span>
      <span class='skillname'>Leadership<input type='hidden' name='attr_leadership_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_leadership_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='leadership' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_leadership_bonus'></span></button></div>
<button type='action' data-skill='leadership' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_leadershipsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='socialawareness'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_socialawareness_info'></span>
Uses (Lvl/Total) <span name='attr_socialawareness_usecount'></span> / <span name='attr_socialawareness_usecounttotal'></span></span></span>
      <span class='skillname'>Social Awareness<input type='hidden' name='attr_socialawareness_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='em'>em</span></span>
<div class='skill_ranks'><span name='attr_socialawareness_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='socialawareness' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_socialawareness_bonus'></span></button></div>
<button type='action' data-skill='socialawareness' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_socialawarenesssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='trading'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_trading_info'></span>
Uses (Lvl/Total) <span name='attr_trading_usecount'></span> / <span name='attr_trading_usecounttotal'></span></span></span>
      <span class='skillname'>Trading<input type='hidden' name='attr_trading_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span></span>
<div class='skill_ranks'><span name='attr_trading_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='trading' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_trading_bonus'></span></button></div>
<button type='action' data-skill='trading' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_tradingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='spellcasting'></span>
      <span class='skill_stat'><span data-i18n='rs'>rs</span> + <span data-i18n='rs'>rs</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_magicalritual_info'></span></span>
      <span class='skillname'>Magical Ritual<input type='hidden' name='attr_magicalritual_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='me'>me</span></span>
<div class='skill_ranks'><span name='attr_magicalritual_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='magicalritual' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_magicalritual_bonus'></span></button></div>
</div>
<fieldset class='repeating_magicalritualsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='alteration'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_alteration_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='alteration'>Alteration</span></span>
<div class='skill_ranks'><span name='attr_alteration_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='alteration' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_alteration_bonus'></span>
</button></div><button type='action' data-skill='alteration' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_alterationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='creation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_creation_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='creation'>Creation</span></span>
<div class='skill_ranks'><span name='attr_creation_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='creation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_creation_bonus'></span>
</button></div><button type='action' data-skill='creation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_creationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='defensive'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_defensive_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='defensive'>Defensive</span></span>
<div class='skill_ranks'><span name='attr_defensive_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='defensive' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_defensive_bonus'></span>
</button></div><button type='action' data-skill='defensive' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_defensivesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='destruction'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_destruction_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='destruction'>Destruction</span></span>
<div class='skill_ranks'><span name='attr_destruction_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='destruction' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_destruction_bonus'></span>
</button></div><button type='action' data-skill='destruction' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_destructionsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='elemental'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_elemental_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='elemental'>Elemental</span></span>
<div class='skill_ranks'><span name='attr_elemental_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='elemental' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_elemental_bonus'></span>
</button></div><button type='action' data-skill='elemental' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_elementalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='healing'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_healing_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='healing'>Healing</span></span>
<div class='skill_ranks'><span name='attr_healing_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='healing' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_healing_bonus'></span>
</button></div><button type='action' data-skill='healing' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_healingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='informational'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_informational_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='informational'>Informational</span></span>
<div class='skill_ranks'><span name='attr_informational_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='informational' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_informational_bonus'></span>
</button></div><button type='action' data-skill='informational' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_informationalsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='summoningtransportation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_summoningtransportation_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='summoningtransportation'>Summoning & Transportation</span></span>
<div class='skill_ranks'><span name='attr_summoningtransportation_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='summoningtransportation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_summoningtransportation_bonus'></span>
</button></div><button type='action' data-skill='summoningtransportation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_summoningtransportationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='subterfuge'></span>
      <span class='skill_stat'><span data-i18n='ag'>ag</span> + <span data-i18n='sd'>sd</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_ambush_info'></span></span>
      <span class='skillname'>Ambush<input type='hidden' name='attr_ambush_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_ambush_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='ambush' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_ambush_bonus'></span></button></div>
</div>
<fieldset class='repeating_ambushsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ambushdirectedspells'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ambushdirectedspells_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ambushdirectedspells'>Directed Spells </span></span>
<div class='skill_ranks'><span name='attr_ambushdirectedspells_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ambushdirectedspells' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ambushdirectedspells_bonus'></span>
</button></div><button type='action' data-skill='ambushdirectedspells' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ambushdirectedspellssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ambushmelee'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ambushmelee_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ambushmelee'>Melee</span></span>
<div class='skill_ranks'><span name='attr_ambushmelee_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ambushmelee' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ambushmelee_bonus'></span>
</button></div><button type='action' data-skill='ambushmelee' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ambushmeleesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ambushranged'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ambushranged_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ambushranged'>Ranged</span></span>
<div class='skill_ranks'><span name='attr_ambushranged_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ambushranged' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ambushranged_bonus'></span>
</button></div><button type='action' data-skill='ambushranged' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ambushrangedsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ambushshield'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ambushshield_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ambushshield'>Shield</span></span>
<div class='skill_ranks'><span name='attr_ambushshield_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ambushshield' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ambushshield_bonus'></span>
</button></div><button type='action' data-skill='ambushshield' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ambushshieldsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='ambushunarmed'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_ambushunarmed_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='ambushunarmed'>Unarmed</span></span>
<div class='skill_ranks'><span name='attr_ambushunarmed_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='ambushunarmed' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_ambushunarmed_bonus'></span>
</button></div><button type='action' data-skill='ambushunarmed' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_ambushunarmedsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='concealment'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_concealment_info'></span>
Uses (Lvl/Total) <span name='attr_concealment_usecount'></span> / <span name='attr_concealment_usecounttotal'></span></span></span>
      <span class='skillname'>Concealment<input type='hidden' name='attr_concealment_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_concealment_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='concealment' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_concealment_bonus'></span></button></div>
<button type='action' data-skill='concealment' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_concealmentsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='stalking'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_stalking_info'></span>
Uses (Lvl/Total) <span name='attr_stalking_usecount'></span> / <span name='attr_stalking_usecounttotal'></span></span></span>
      <span class='skillname'>Stalking<input type='hidden' name='attr_stalking_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_stalking_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='stalking' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_stalking_bonus'></span></button></div>
<button type='action' data-skill='stalking' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_stalkingsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='trickery'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_trickery_info'></span>
Uses (Lvl/Total) <span name='attr_trickery_usecount'></span> / <span name='attr_trickery_usecounttotal'></span></span></span>
      <span class='skillname'>Trickery<input type='hidden' name='attr_trickery_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='in'>in</span></span>
<div class='skill_ranks'><span name='attr_trickery_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='trickery' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_trickery_bonus'></span></button></div>
<button type='action' data-skill='trickery' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_trickerysubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='technical'></span>
      <span class='skill_stat'><span data-i18n='in'>in</span> + <span data-i18n='re'>re</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='locks'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_locks_info'></span>
Uses (Lvl/Total) <span name='attr_locks_usecount'></span> / <span name='attr_locks_usecounttotal'></span></span></span>
      <span class='skillname'>Locks<input type='hidden' name='attr_locks_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_locks_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='locks' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_locks_bonus'></span></button></div>
<button type='action' data-skill='locks' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_lockssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_mechanics_info'></span></span>
      <span class='skillname'>Mechanics<input type='hidden' name='attr_mechanics_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='me'>me</span></span>
<div class='skill_ranks'><span name='attr_mechanics_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='mechanics' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_mechanics_bonus'></span></button></div>
</div>
<fieldset class='repeating_mechanicssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='operation'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_operation_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='operation'>Operation</span></span>
<div class='skill_ranks'><span name='attr_operation_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='operation' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_operation_bonus'></span>
</button></div><button type='action' data-skill='operation' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_operationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill_specialization'>
<span class='specialization_group' style='position: relative'><button type='action' name='act_edit_skill' class='editbutton icon' style='padding-left: 0.7em' data-skill='repairconstruction'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_repairconstruction_info'></span>
<span name='specialization_name' class='specialization_name' data-i18n='repairconstruction'>Repair & Construction</span></span>
<div class='skill_ranks'><span name='attr_repairconstruction_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='repairconstruction' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_repairconstruction_bonus'></span>
</button></div><button type='action' data-skill='repairconstruction' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_repairconstructionsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<div class='skill'><span><span class='iconwrap'><button type='action' name='act_edit_skill' class='editbutton icon' data-skill='traps'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info'><span name='attr_traps_info'></span>
Uses (Lvl/Total) <span name='attr_traps_usecount'></span> / <span name='attr_traps_usecounttotal'></span></span></span>
      <span class='skillname'>Traps<input type='hidden' name='attr_traps_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='ag'>ag</span></span>
<div class='skill_ranks'><span name='attr_traps_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='traps' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_traps_bonus'></span></button></div>
<button type='action' data-skill='traps' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_trapssubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
  </div>
  </div>
  <div class='category'>
    <div class='category_head'>
      <span class='categoryname' data-i18n='vocation'></span>
      <span class='skill_stat'><span data-i18n='em'>em</span> + <span data-i18n='me'>me</span></span>    </div>
  <div class='category_skills'>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_administration_info'></span></span>
      <span class='skillname'>Administration<input type='hidden' name='attr_administration_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='administration'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_administration_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='administration' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_administration_bonus'></span></button></div>
<button type='action' data-skill='administration' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_administrationsubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationadministration'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='administration'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='administration' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_service_info'></span></span>
      <span class='skillname'>Service<input type='hidden' name='attr_service_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='pr'>pr</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='service'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_service_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='service' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_service_bonus'></span></button></div>
<button type='action' data-skill='service' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_servicesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationservice'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='service'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='service' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
<div class='skill'><span><span class='iconwrap'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_trade_info'></span></span>
      <span class='skillname'>Trade<input type='hidden' name='attr_trade_pbonus' class='hidenext'><span>&nbsp;&bull;</span></span><span class='skill_stat' data-i18n='re'>re</span><button type='action' name='act_add_specialization' class='editbutton' style='padding-left: 0.7em' data-skill='trade'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
</span>
<div class='skill_ranks'><span name='attr_trade_ranks'></span></div>
<div class='skill_bonus'><button type='action' data-skill='trade' class='editbutton rollbutton skill_bonus_specialization' name='act_rollskilldirect'><span name='attr_trade_bonus'></span></button></div>
<button type='action' data-skill='trade' class='editbutton rollbutton ' name='act_rollskilldirectmod'><span class='diced10'>0</span></button></div>
<fieldset class='repeating_tradesubskill'><div class='skill_subskill'><span><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span><span class='skill_info' name='attr_info'></span><span class='subskill_name' name='attr_name'></span></span><div class='skill_bonus subskill_bonus'><span name='attr_bonus'></span></div></div></fieldset>
<fieldset class='repeating_specializationtrade'>
<div class='skill_specialization'>
<span class='specialization_group'><button type='action' name='act_editskillspecialization' class='editbutton icon' style='padding-left: 0.7em' data-skill='trade'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
<span name='attr_name'></span></span>
<div class='skill_ranks'><span name='attr_ranks'></span></div><div class='skill_bonus'><button type='action' data-skill='trade' class='editbutton rollbutton ' name='act_rollskilldirect'><span name='attr_bonus'></span></button></div>
<button type='action' class='editbutton rollbuttons' name='act_rollskilldirect'><span class='diced10'>0</span><input type='hidden' name='attr_bonus'><input type='hidden' name='attr_name'></button></div> </fieldset>
  </div>
  </div>

    </div>
</div>

<!-- space so you can see the popup -->

</section>

<section id='spells' class='tab-panel'>
    <h2>Spells</h2>

    <select name='attr_castingsubtle' class='fancyselect'>
      <option value='visible'>Visible</option>
      <option value='subtle'>Subtle</option>
    </select>

    <select name='attr_castingvoice' class='fancyselect'>
      <option value='novoice'>No Voice</option>
      <option value='whisper'>Whisper</option>
      <option value='normal'>Normal</option>
      <option value='shout'>Shout</option>
    </select>

    <select name='attr_castinghands' class='fancyselect'>
      <option value='nohand'>No Hands</option>
      <option value='onehand'>One Hand</option>
      <option value='twohands'>Two Hands</option>
    </select>

    <select name='attr_castingpreprounds' class='fancyselect'>
      <option value='0'>No Prep</option>
      <option value='1'>One Round Prep</option>
      <option value='2'>Two Rounds Prep</option>
    </select>

    Other Mod: <input type='number' class='small_number' name='attr_castingmiscmod'>

    <input type='checkbox' name='attr_castinguseap' id='castinguseap'>
      
      <!--label for='castinguseap'>Use AP</label--> Use AP
      (<span name='attr_apspellmirror'>X</span> AP).

    (Modifier: <span name='attr_castingmod'>0</span>)

      <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellownbase'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellownbase' data-spelllistdisplay='Base'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellownbase'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellownbase'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellopen'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellopen' data-spelllistdisplay='Open'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellopen'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellopen'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellclosed'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellclosed' data-spelllistdisplay='Closed'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellclosed'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellclosed'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellotherbaseownrealm'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellotherbaseownrealm' data-spelllistdisplay='Other Base (Own Realm)'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellotherbaseownrealm'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellotherbaseownrealm'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellopenother'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellopenother' data-spelllistdisplay='Open (Other Realm)'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellopenother'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellopenother'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellclosedother'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellclosedother' data-spelllistdisplay='Closed (Other Realm)'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellclosedother'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellclosedother'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='spellotherbaseother'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='spellotherbaseother' data-spelllistdisplay='Other Base (Other Realm)'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistspellotherbaseother'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='spellotherbaseother'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>
  <div class='spellgroup'>
    <div class='spellgroupheading'>
      <span class='spelllisttype' data-i18n='arcane'></span>
       <span>#</span><span>SCR</span><span>Mastery</span>
      <button type='action' name='act_add_spelllist' class='editbutton' style='padding-left: 0.7em' data-spelllisttype='arcane' data-spelllistdisplay='Arcane'><span class="icon" style="font-family: 'Pictos'; color: rgb(150,150,150);">&</span></button>
    </div>
  <div class='spelllists'>
<input type='hidden' name='attr_edit_spell_toggle' class='edit_control_toggle'>   <fieldset class='repeating_spelllistarcane'>
      <div class='spelllist'>
         <div class='spellinfo'>
          <div class='spellname'>
 <button type='action' name='act_editspelllist' class='icon editbutton' style='padding-left: 0.7em'><span class="icon" style="font-family: 'Pictos Custom'; color: rgb(150,150,150);">y</span></button>
<span class='skill_info' name='attr_info'></span>
          <span name='attr_name'></span>          <button type='compendium' name='attr_name' class='inlinecompendium editbutton'></button><input type='hidden' name='attr_trickery' class='hidenext'><i>(Trickery <span name='attr_trickery'></span>)</i>&nbsp;
<input type='hidden' name='attr_grace' class='hidenext'><i>(Grace <span name='attr_grace'></span>)</i>          </div>          <div class='spellranks'><span name='attr_ranks'></span></div>          <div class='spellscr'><span name='attr_scr'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{scr} ]] - [[ 1d100!>96]] ]] {{bonus=@{scr} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=casts a spell from }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_scr'></button></div>
          <div class='spellmastery'><span name='attr_spellmastery'></span><button type="roll" class="editbutton rollbutton " name="dicerolls" value="&{template:rmu} [[ [[ [[ 1d100!>96 ]] + @{spellmastery} ]] - [[ 1d100!>96]] ]] {{bonus=@{spellmastery} }} {{um=$[[0]]}} {{rollh=$[[1]]}} {{rollsub=$[[2]]}} {{rolll=$[[3]]}} {{action=@{name}}} {{verb=masters the magic of }}{{actor=@{character_name}}} }}"><input type='hidden' name='attr_name'><input type='hidden' name='attr_spellmastery'></button></div>
        </div>
<input type='hidden' name='attr_group' value='arcane'><input type='hidden' name='attr_grace' value='0'><input type='hidden' name='attr_trickery' value='0'><div class='knownspells'>
<button class='castspell' type='action' name='act_castspell1'><span name='attr_spell1'></span><input type='hidden' name='attr_type1'><input type='hidden' name='attr_name1'><input type='hidden' name='attr_nopp1'><input type='hidden' name='attr_instant1'></button>
<button class='castspell' type='action' name='act_castspell2'><span name='attr_spell2'></span><input type='hidden' name='attr_type2'><input type='hidden' name='attr_name2'><input type='hidden' name='attr_nopp2'><input type='hidden' name='attr_instant2'></button>
<button class='castspell' type='action' name='act_castspell3'><span name='attr_spell3'></span><input type='hidden' name='attr_type3'><input type='hidden' name='attr_name3'><input type='hidden' name='attr_nopp3'><input type='hidden' name='attr_instant3'></button>
<button class='castspell' type='action' name='act_castspell4'><span name='attr_spell4'></span><input type='hidden' name='attr_type4'><input type='hidden' name='attr_name4'><input type='hidden' name='attr_nopp4'><input type='hidden' name='attr_instant4'></button>
<button class='castspell' type='action' name='act_castspell5'><span name='attr_spell5'></span><input type='hidden' name='attr_type5'><input type='hidden' name='attr_name5'><input type='hidden' name='attr_nopp5'><input type='hidden' name='attr_instant5'></button>
<button class='castspell' type='action' name='act_castspell6'><span name='attr_spell6'></span><input type='hidden' name='attr_type6'><input type='hidden' name='attr_name6'><input type='hidden' name='attr_nopp6'><input type='hidden' name='attr_instant6'></button>
<button class='castspell' type='action' name='act_castspell7'><span name='attr_spell7'></span><input type='hidden' name='attr_type7'><input type='hidden' name='attr_name7'><input type='hidden' name='attr_nopp7'><input type='hidden' name='attr_instant7'></button>
<button class='castspell' type='action' name='act_castspell8'><span name='attr_spell8'></span><input type='hidden' name='attr_type8'><input type='hidden' name='attr_name8'><input type='hidden' name='attr_nopp8'><input type='hidden' name='attr_instant8'></button>
<button class='castspell' type='action' name='act_castspell9'><span name='attr_spell9'></span><input type='hidden' name='attr_type9'><input type='hidden' name='attr_name9'><input type='hidden' name='attr_nopp9'><input type='hidden' name='attr_instant9'></button>
<button class='castspell' type='action' name='act_castspell10'><span name='attr_spell10'></span><input type='hidden' name='attr_type10'><input type='hidden' name='attr_name10'><input type='hidden' name='attr_nopp10'><input type='hidden' name='attr_instant10'></button>
<button class='castspell' type='action' name='act_castspell11'><span name='attr_spell11'></span><input type='hidden' name='attr_type11'><input type='hidden' name='attr_name11'><input type='hidden' name='attr_nopp11'><input type='hidden' name='attr_instant11'></button>
<button class='castspell' type='action' name='act_castspell12'><span name='attr_spell12'></span><input type='hidden' name='attr_type12'><input type='hidden' name='attr_name12'><input type='hidden' name='attr_nopp12'><input type='hidden' name='attr_instant12'></button>
<button class='castspell' type='action' name='act_castspell13'><span name='attr_spell13'></span><input type='hidden' name='attr_type13'><input type='hidden' name='attr_name13'><input type='hidden' name='attr_nopp13'><input type='hidden' name='attr_instant13'></button>
<button class='castspell' type='action' name='act_castspell14'><span name='attr_spell14'></span><input type='hidden' name='attr_type14'><input type='hidden' name='attr_name14'><input type='hidden' name='attr_nopp14'><input type='hidden' name='attr_instant14'></button>
<button class='castspell' type='action' name='act_castspell15'><span name='attr_spell15'></span><input type='hidden' name='attr_type15'><input type='hidden' name='attr_name15'><input type='hidden' name='attr_nopp15'><input type='hidden' name='attr_instant15'></button>
<button class='castspell' type='action' name='act_castspell16'><span name='attr_spell16'></span><input type='hidden' name='attr_type16'><input type='hidden' name='attr_name16'><input type='hidden' name='attr_nopp16'><input type='hidden' name='attr_instant16'></button>
<button class='castspell' type='action' name='act_castspell17'><span name='attr_spell17'></span><input type='hidden' name='attr_type17'><input type='hidden' name='attr_name17'><input type='hidden' name='attr_nopp17'><input type='hidden' name='attr_instant17'></button>
<button class='castspell' type='action' name='act_castspell18'><span name='attr_spell18'></span><input type='hidden' name='attr_type18'><input type='hidden' name='attr_name18'><input type='hidden' name='attr_nopp18'><input type='hidden' name='attr_instant18'></button>
<button class='castspell' type='action' name='act_castspell19'><span name='attr_spell19'></span><input type='hidden' name='attr_type19'><input type='hidden' name='attr_name19'><input type='hidden' name='attr_nopp19'><input type='hidden' name='attr_instant19'></button>
<button class='castspell' type='action' name='act_castspell20'><span name='attr_spell20'></span><input type='hidden' name='attr_type20'><input type='hidden' name='attr_name20'><input type='hidden' name='attr_nopp20'><input type='hidden' name='attr_instant20'></button>
<button class='castspell' type='action' name='act_castspell25'><span name='attr_spell25'></span><input type='hidden' name='attr_type25'><input type='hidden' name='attr_name25'><input type='hidden' name='attr_nopp25'><input type='hidden' name='attr_instant25'></button>
<button class='castspell' type='action' name='act_castspell30'><span name='attr_spell30'></span><input type='hidden' name='attr_type30'><input type='hidden' name='attr_name30'><input type='hidden' name='attr_nopp30'><input type='hidden' name='attr_instant30'></button>
<button class='castspell' type='action' name='act_castspell35'><span name='attr_spell35'></span><input type='hidden' name='attr_type35'><input type='hidden' name='attr_name35'><input type='hidden' name='attr_nopp35'><input type='hidden' name='attr_instant35'></button>
<button class='castspell' type='action' name='act_castspell40'><span name='attr_spell40'></span><input type='hidden' name='attr_type40'><input type='hidden' name='attr_name40'><input type='hidden' name='attr_nopp40'><input type='hidden' name='attr_instant40'></button>
<button class='castspell' type='action' name='act_castspell45'><span name='attr_spell45'></span><input type='hidden' name='attr_type45'><input type='hidden' name='attr_name45'><input type='hidden' name='attr_nopp45'><input type='hidden' name='attr_instant45'></button>
<button class='castspell' type='action' name='act_castspell50'><span name='attr_spell50'></span><input type='hidden' name='attr_type50'><input type='hidden' name='attr_name50'><input type='hidden' name='attr_nopp50'><input type='hidden' name='attr_instant50'></button>
<button class='castspell' type='action' name='act_castspell55'><span name='attr_spell55'></span><input type='hidden' name='attr_type55'><input type='hidden' name='attr_name55'><input type='hidden' name='attr_nopp55'><input type='hidden' name='attr_instant55'></button>
<button class='castspell' type='action' name='act_castspell60'><span name='attr_spell60'></span><input type='hidden' name='attr_type60'><input type='hidden' name='attr_name60'><input type='hidden' name='attr_nopp60'><input type='hidden' name='attr_instant60'></button>
<button class='castspell' type='action' name='act_castspell65'><span name='attr_spell65'></span><input type='hidden' name='attr_type65'><input type='hidden' name='attr_name65'><input type='hidden' name='attr_nopp65'><input type='hidden' name='attr_instant65'></button>
<button class='castspell' type='action' name='act_castspell70'><span name='attr_spell70'></span><input type='hidden' name='attr_type70'><input type='hidden' name='attr_name70'><input type='hidden' name='attr_nopp70'><input type='hidden' name='attr_instant70'></button>
<button class='castspell' type='action' name='act_castspell75'><span name='attr_spell75'></span><input type='hidden' name='attr_type75'><input type='hidden' name='attr_name75'><input type='hidden' name='attr_nopp75'><input type='hidden' name='attr_instant75'></button>
<button class='castspell' type='action' name='act_castspell80'><span name='attr_spell80'></span><input type='hidden' name='attr_type80'><input type='hidden' name='attr_name80'><input type='hidden' name='attr_nopp80'><input type='hidden' name='attr_instant80'></button>
<button class='castspell' type='action' name='act_castspell85'><span name='attr_spell85'></span><input type='hidden' name='attr_type85'><input type='hidden' name='attr_name85'><input type='hidden' name='attr_nopp85'><input type='hidden' name='attr_instant85'></button>
<button class='castspell' type='action' name='act_castspell90'><span name='attr_spell90'></span><input type='hidden' name='attr_type90'><input type='hidden' name='attr_name90'><input type='hidden' name='attr_nopp90'><input type='hidden' name='attr_instant90'></button>
</div>
      </div>
    </fieldset>
  </div>
  </div>


</section>

<section id='stuff' class='tab-panel'>
    <h2>Stuff</h2>

    
    <p><b>Money:</b>
	Gold: <input class='small_number' type='number' name='attr_money_gp'>
	Silver: <input class='small_number' type='number' name='attr_money_sp'>
	Bronze: <input class='small_number' type='number' name='attr_money_bp'>
	Copper: <input class='small_number' type='number' name='attr_money_cp'>
	<button type='action' class='fancybutton' name='act_money_level'>Consolidate</button>
    </p>

    <h3>Carried</h3>

    <div class='inventory inventorytitle'>
        <span></span>
	<span>Equipped</span>
	<span>Item</span>
	<span>Weight</span>
	<span>Count</span>
    </div>

    <fieldset class='repeating_stuff'>
	<div class='inventory'>
            <input type='checkbox' class='accordian'> 
	    <input type='checkbox' name='attr_itemequipped'>
	    <span name='attr_itemname'></span>
	    <span name='attr_itemweight'></span>
	    <input type='number' class='small_number' name='attr_itemcount'>
            <span>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itemcarrytopack'>Pack</button>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itemcarrytostore'>Store</button>

              <button type='action' class='fancybuttoninline fancybutton' name='act_edititem'
               ><span style="font-family:Pictos;">p</span></button>
              <button type='action' class='fancybuttoninline fancybutton' name='act_deleteitem'
               ><span style="font-family:Pictos;">#</span>
              </button>
            </span>
            <div class='accordiantoggle' style='grid-column: span 6'>
	      <!--span name='attr_itemsystem'></span-->
		<span name='attr_itemnotes'></span>
            </div>
	</div>
    </fieldset>

    <div>
      <div>Total Weight: <span name='attr_total_weight'></span></div>
      <div>Weight Allowance: <span name='attr_weightallowance'></span></div>
      <input type='hidden' name='attr_encumberance_penalty' class='hidenext'>
        <div>Encumberance Penalty: <span name='attr_encumberance_penalty'></span></div>
      <input type='hidden' name='attr_perception_penalty' class='hidenext'>
        <div>Perception Penalty: <span name='attr_perception_penalty'></span></div>
      <input type='hidden' name='attr_ranged_penalty' class='hidenext'>
        <div>Ranged Penalty: <span name='attr_ranged_penalty'></span></div>
      <div>Spell Casting Armor Enc% <span name='attr_armorenc'></span></div>
      <div>Spell Casting Metal Armor Enc% <span name='attr_armorencmetal'></span></div>
    </div>

   <h3>Backpack</h3>
  <label>Pack carried? <input type='checkbox' name='attr_packcarried'></label>

   <div class='inventory inventorytitle'>
        <span></span>
        <span></span>
	<span>Item</span>
	<span>Weight</span>
	<span>Count</span>
    </div>
  

   <fieldset class='repeating_stuffpack'>
	<div class='inventory'>
            <input type='checkbox' class='accordian'> 
	    <span></span>
	    <span name='attr_itemname'></span>
	    <span name='attr_itemweight'></span>
	    <input type='number' class='small_number' name='attr_itemcount'>
            <span>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itempacktocarry'>Carry</button>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itempacktostore'>Store</button>
              <button type='action' class='fancybuttoninline fancybutton' name='act_deleteitem'
                 ><span style="font-family:Pictos;">#</span> </button>
            </span>
            <div class='accordiantoggle' style='grid-column: span 6'>
              <span name='attr_itemnotes'></span>
            </div>

	</div>
    </fieldset>

    <p>Backpack Weight: <span name='attr_packweight'></span><br>
    </p>

    <h3>Home / Storage</h3>

   <div class='inventory inventorytitle'>
        <span></span>
        <span></span>
	<span>Item</span>
	<span>Weight</span>
	<span>Count</span>
   </div>
  

   <fieldset class='repeating_stuffstore'>
	<div class='inventory'>
            <input type='checkbox' class='accordian'> 
	    <span></span>
	    <span name='attr_itemname'></span>
	    <span name='attr_itemweight'></span>
	    <input type='number' class='small_number' name='attr_itemcount'>
            <span>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itemstoretocarry'>Carry</button>
              <button type='action' class='fancybuttoninline fancybutton' name='act_itemstoretopack'>Pack</button>
            <button type='action' class='fancybuttoninline fancybutton' name='act_deleteitem'
               ><span style="font-family:Pictos;">#</span> </button>
            </span>
            <div class='accordiantoggle' style='grid-column: span 6'>
              <span name='attr_itemnotes'></span>
            </div>
	</div>
    </fieldset>




    <button type='action' class='fancybutton' name='act_inventoryadd'>Add Item</button>

  <!-- -->
  <input type='hidden' name='attr_inventoryaddshow' class='inventoryaddshow'>
  <div class='inventoryadd overlay'>
    <div class='inventoryaddcontent skillchange'>

    <span><b>Item Name</b></span>
    <input type='text' name='attr_inventoryaddname'>

    <span><b>Item Weight</b></span>
    <span>
      <input type='number' name='attr_inventoryaddweight'>
      (Enc% for Armor)
    </span>

    <span><b>Item Notes</b></span>
    <input type='text' name='attr_inventoryaddnotes'>

    <span><b>Item Strength</b></span>
    <input type='number' name='attr_inventoryaddstrength'>

    <span><b>Item Type</b></span>
    <select name='attr_inventoryaddtype' class='inventoryaddtype fancyselect'>
      <option value='Equipment'>Equipment</option>
      <option value='Armor'>Armor</option>
      <option value='Weapon'>Weapon</option>
      <option value='Shield'>Shield</option>
    </select>
    
    <input type='hidden' name='attr_inventoryaddarmortoggle' class='inventoryarmorshow'> 
    <input type='hidden' name='attr_inventoryaddshieldtoggle' class='inventoryshieldshow'> 
    <input type='hidden' name='attr_inventoryaddweapontoggle' class='inventoryweaponshow'>

    <span class='inventoryarmortoggle'><b>Armor Location</b></span>
    <select name='attr_inventoryaddarmorsubtype' class='inventoryarmortoggle fancyselect'>
      <option value='Full'>Full</option>
      <option value='Set'>Set (All but Helmet)</option>
      <option value='Vambraces'>Vambraces</option>
      <option value='Greaves'>Greaves</option>
      <option value='Torso'>Torso</option>
      <option value='Helmet'>Helmet</option>
    </select>
    <span class='inventoryarmortoggle'><b>Armor Type (AT)</b></span>
    <select name='attr_inventoryaddarmorat' class='inventoryarmortoggle fancyselect'>
      <option value='1'>1</option>
      <option value='2'>2</option>
      <option value='3'>3</option>
      <option value='4'>4</option>
      <option value='5'>5</option>
      <option value='6'>6</option>
      <option value='7'>7</option>
      <option value='8'>8</option>
      <option value='9'>9</option>
      <option value='10'>10</option>
    </select>
    <span  class='inventoryarmortoggle'><b>DB Bonus</b></span>
    <input type='number' name='attr_inventoryaddarmordbbonus'  class='inventoryarmortoggle'>
    <span  class='inventoryarmortoggle'><b>Material</b></span>
    <select name='attr_inventoryaddarmormaterial' class='inventoryarmortoggle fancyselect'>
      <option value='cloth'>Cloth</option>
      <option value='leather'>Leather</option>
      <option value='metal'>Metal</option>
    </select>


    
    <span class='inventoryshieldtoggle'><b>Number of Attacks</b></span>
    <input type='number' name='attr_inventoryaddshieldattacks'   class='inventoryshieldtoggle'>
    <span  class='inventoryshieldtoggle'><b>DB Bonus</b></span>
    <input type='number' name='attr_inventoryaddshielddb'  class='inventoryshieldtoggle'>

    
    <span  class='inventoryweapontoggle'><b>OB Bonus</b></span>
    <input type='number' name='attr_inventoryaddweaponobbonus'  class='inventoryweapontoggle'>

    <span class='inventoryweapontoggle'><b>Attack Skill</b></span>
    <select name='attr_inventoryaddweaponskill' class='fancyselect inventoryweapontoggle'>
      <option value="beak">Beak</option>
      <option value="bite">Bite</option>
      <option value="blade">Blade</option>
      <option value="bow">Bow</option>
      <option value="chain">Chain</option>
      <option value="claw">Claw</option>
      <option value="crossbow">Crossbow</option>
      <option value="elementalbolts">Elemental Bolts</option>
      <option value="meleeexotic">Exotic (Melee)</option>
      <option value="rangedexotic">Exotic (Ranged)</option>
      <option value="greaterblade">Greater Blade</option>
      <option value="greaterchain">Greater Chain</option>
      <option value="greaterhafter">Greater Hafted</option>
      <option value="hafted">Hafted</option>
      <option value="horn">Horn</option>
      <option value="illusionaryattacks">Illusionary Attacks</option>
      <option value="none">None</option>
      <option value="polearm">Pole Arm</option>
      <option value="ram">Ram</option>
      <option value="shield">Shield</option>
      <option value="sling">Sling</option>
      <option value="stinger">Stinger</option>
      <option value="strikes">Strikes</option>
      <option value="sweepsthrows">Sweeps &amp; Throws</option>
      <option value="trample">Trample</option>
      <option value="thrown">Thrown</option>
      <option value="wrestling">Wrestling</option>
      <option value="hurling">Hurling</option>
    </select>

    <span class='inventoryweapontoggle'><b>Attack Table</b></span>
    <select class='inventoryweapontoggle fancyselect' name='attr_inventoryaddweaponattacktable'>
      <option value="Arming Sword">Arming Sword</option>
      <option value="Ball, Cold">Ball, Cold</option>
      <option value="Ball, Fire">Ball, Fire</option>
      <option value="Ball, Lightning">Ball, Lightning</option>
      <option value="Battle Axe">Battle Axe</option>
      <option value="Beak">Beak</option>
      <option value="Bite">Bite</option>
      <option value="Bola">Bola</option>
      <option value="Bolt, Fire">Bolt, Fire</option>
      <option value="Bolt, Ice">Bolt, Ice</option>
      <option value="Bolt, Lightning">Bolt, Lightning</option>
      <option value="Bolt, Shock">Bolt, Shock</option>
      <option value="Bolt, Water">Bolt, Water</option>
      <option value="Bow, Long">Bow, Long</option>
      <option value="Bow, Short">Bow, Short</option>
      <option value="Broadsword">Broadsword</option>
      <option value="Claw">Claw</option>
      <option value="Club">Club</option>
      <option value="Crossbow">Crossbow</option>
      <option value="Crush">Crush</option>
      <option value="Dagger">Dagger</option>
      <option value="Falchion">Falchion</option>
      <option value="Fighting Stick">Fighting Stick</option>
      <option value="Flail">Flail</option>
      <option value="Grapple">Grapple</option>
      <option value="Horn">Horn</option>
      <option value="Mace">Mace</option>
      <option value="Ram">Ram</option>
      <option value="Rapier">Rapier</option>
      <option value="Rock">Rock</option>
      <option value="Scimitar">Scimitar</option>
      <option value="Shield">Shield</option>
      <option value="Sling">Sling</option>
      <option value="Spear">Spear</option>
      <option value="Stinger">Stinger</option>
      <option value="Trample">Trample</option>
      <option value="Unarmed Strike">Unarmed Strike</option>
      <option value="Unarmed Sweeps">Unarmed Sweeps</option>
      <option value="War Hammer">War Hammer</option>
      <option value="Whip">Whip</option>
    </select>

    <span class='inventoryweapontoggle'><b>Attack Size Mod</b></span>
    <select class='inventoryweapontoggle fancyselect' name='attr_inventoryaddweaponattacksize'>
      <option value='-1'>1 Smaller</option>
      <option value='0'>Normal</option>
      <option value='1'>1 Larger</option>
    </select>

    <span class='inventoryweapontoggle'><b>Weapon Material</b></span>
    <span class='inventoryweapontoggle'><label class='plainlabel'><input type='checkbox' name='attr_inventoryaddweaponmaterialc'>Crystalline (c)</label></span><span class='inventoryweapontoggle'><label class='plainlabel'><input type='checkbox' name='attr_inventoryaddweaponmaterialw'>Wood (w)</label></span><span class='inventoryweapontoggle'><label class='plainlabel'><input type='checkbox' name='attr_inventoryaddweaponmaterials'>Silver (s)</label></span><span class='inventoryweapontoggle'><label class='plainlabel'><input type='checkbox' name='attr_inventoryaddweaponmateriali'>Raw Iron (i)</label></span><span class='inventoryweapontoggle'><label class='plainlabel'><input type='checkbox' name='attr_inventoryaddweaponmaterialm'>Magic (m)</label></span>

    <span style='grid-column: span 2' name='attr_inventoryaddmessage'></span>


      <button class='fancybuttoninline fancybutton' type='action' name='act_inventoryaddsave'>Add</button>
      <button class='fancybuttoninline fancybutton' type='action' name='act_inventoryaddcancel'>Cancel</button>
    </div>
  </div>



</section>

<section id='scratch' class='tab-panel'>
    <h2>Scratch Notes</h2>

    <textarea name='attr_notes'></textarea>

    <h2>Journal</h2>

    
    <button class='fancybuttoninline fancybutton' type='action' name='act_journaladdshow'>
            <span style='font-family:Pictos;'>&</span> Add Entry</button>

      <!-- Scrollable div -->
    <div class='scrolldivvertical simpleframebox'>

        <fieldset class='repeating_journalentry'>
          <span name='attr_ingamedate'></span>
          (<span name='attr_sessiondate'></span>)
          <b><span name='attr_title'></span></b> <br>

          <span name='attr_description'></span>
          <i>XP:<span name='attr_xp'></span></i>
    </fieldset>




    </div>

    <h2>Injuries</h2>

    <fieldset class='repeating_specificinjury'>
      <div class='specificinjury'>
      Summary: <span name='attr_summary'></span> <br>
      Bleed: <span name='attr_bleed'></span>
        | Penalty: <span name='attr_penalty'></span>
        | Severity <span name='attr_severity'></span>
        | Location: <span name='attr_location'></span>
        | Recovery (/day): <span name='attr_dailyrecovery'></span> <br>
      Type: <select name='attr_type' class='fancyselect'>
          <option value='unknown'>Unknown</option>
          <option value='bone'>Bone</option>
          <option value='cutsburn'>Cuts &amp; Burns</option>
          <option value='muscle'>Muscle/Tendon</option>
          <option value='organ'>Organ</option>
          <option value='poison'>Poison/Disease</option>
          <option value='tissue'>Skin/Tissue</option>
        </select>
      Treatment: <select name='attr_treatment' class='fancyselect'>
          <option value='new'>New</option>
          <option value='untreated'>Untreated</option>
          <option value='medicine'>Medicine</option>
          <option value='medicineabsolute'>Medicine (Absolute Success)</option>
          <option value='magic'>Magic or Medicine + Herbalism</option>
          <option value='magicherbalism'>Magic and Herbalism</option>
        </select>
      <button type='action' class='fancybutton fancybuttoninline' name='act_recoveryroll'>Recovery Roll</button>
      <button type='action' class='fancybuttoninline fancybutton' name='act_deleteitem'
               ><span style="font-family:Pictos;">#</span></button>
      </div>
    </fieldset>


</section>


<section id='settings' class='tab-panel'>
    <h2>Settings</h2>

    <h3>Last Error</h3>

    <p>Count: <span name='attr_errorcount'></span></p>

    <p>Last errors reported:</p>
      <ul>
        <li><span name='attr_lasterror1'></span></li>
        <li><span name='attr_lasterror2'></span></li>
        <li><span name='attr_lasterror3'></span></li>
      </ul>

    <p><b>Options:</b><br>
      Token Markers (<span style="font-family: monospace;">option_usetokenmarkers</span>): <span name='attr_option_usetokenmarkers'>(default)</span><br>
      Use FX (<span style="font-family: monospace;">option_usefx</span>): <span name='attr_option_usefx'>(default)</span><br>
      DB Quickness Multiplier (<span style="font-family: monospace;">option_dbqumultiplier</span>): <span name='attr_option_dbqumultiplier'>(default)</span><br>
      Dodge Running Bonus (<span style="font-family: monospace;">option_dodgerunningbonus</span>): <span name='attr_option_dodgerunningbonus'>(default)</span><br>
      XP Progression Markers (<span style="font-family: monospace;">option_xpprogression</span>): <span name='attr_option_xpprogression'>(default)</span><br>
      Fixed RR Target (50 + 2 * level)
          (<span style="font-family: monospace;">option_fixedrrbase</span>): <span name='attr_option_fixedrrbase'>(default)</span><br>
      Journalled XP (<span style="font-family: monospace;">option_journalledxp</span>):
           <span name='attr_option_journalledxp'>?</span>.<br> 
      Allow OverCasting without preperation round
          (<span style="font-family: monospace;">option_allownoprepovercast</span>):
          <select name="attr_option_allownoprepovercast" class="fancyselect">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>

    <h3>Recalculate</h3>

    <p>You should never need these, but if something doesn't look right, it may help.</p>

<button type='action' name='act_updateskills' class='fancybutton'>Skills</button>
<button type='action' name='act_updatederived' class='fancybutton'>Front Page</button>
<button type='action' name='act_updateattacks' class='fancybutton'>Attacks</button>
<button type='action' name='act_editspells' class='fancybutton'>Edit Spells</button>
<button type='action' name='act_edittalents' class='fancybutton'>Edit Talents</button>
<button type='action' name='act_resetworkers' class='fancybutton'>Reset Workers</button>
<button type='action' name='act_npcgenerate' class='fancybutton'>NPC Generate</button>

<input type='text' name='attr_npcstring'>

<hr>

<h3>Injuries</h3>

<p>Apply an injury.  Format is an Uppercase letter, followed by a number.  Letters
are H hits, P penalty (positive number only),F fatigue (again, positive), B bleed,
S staggered R pRone, K Knocked back, G grappled %, Q/W/E Stun 25/50/77,
X breakage roll, D death (n rounds),
Location (1 head, 2, chest, 3 arms, 4 leg) and O side (1 Left, 2 right).  For
bleed and penalties you need side and  location.  A Z ends the list.<p>

<input type='text' name='attr_hackinjury'>
<button type='action' name='act_applyinjuryhack' class='fancybutton'>Apply Injury</button>

<hr>

<h3>Tokens</h3>

<p>Active Token ID: <input type="text" name="attr_activetokenid"> |
Target Character ID: <input type="text" name="attr_target_characterid"> |
Target Listeners: <input type="text" name="attr_target_listeners"> |
Tracker <span name='attr_trackerid'></span>
Tracker Prefix <span name='attr_trackerprefix'></span>
</p>

<hr>

<h3>Custom Spell List</h3>

<p>Upload a custom spell list to your character.

<textarea name='attr_customlistupload'></textarea>
<button type='action' name='act_uploadspelllist' class='fancybutton'>Upload</button>
Message: <span name='attr_uploadspelllistmessage'></span>

<hr>

<p>Rerun the initial charactermancer.  Warning this will break your character.
This is not for usual use. </p>

<button type='action' name='act_showcharmancer' class='toggler fancybutton'>Charactermancer</button>


<p>This are the magic buttons to apply attack results and end turn.  Clicking should do little.
</p>
<button type="action" name="act_applyattackresult"></button>
<button type="action" name="act_endturn"></button>

<!-- The magic JS for this is in tracker/tokenactions.js.gvz -->
<!--
<button type="roll" class='tokenaction' name="roll_elvis" value="@{elvis_action}">Elvis</button>
<input type="hidden" name="attr_elvis_action">
<button type="action" style="-toby-display:none;" name="act_elvis-action">Zelvis</button>
-->

<!-- Roll20 displays these in reverse order.  Because of course they do -->
<!--
<button type='roll' class='tokenaction' value='/r d100' name='roll_Attack Primary' title='Elvisxxxx'>Primary Attack</button>
<button type='roll' class='tokenaction' value='@{selected|attack_secondary}' name='roll_Attack Secondary'>Secondary Attack</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_AP:Melee'>AP: Melee</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_AP:Missile'>AP: Missile</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_AP:Clear'>AP: Clear</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_AP:Spell'>AP: Spell</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_AP:Peception'>AP: Peception</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_Ap:Concentration'>Ap: Concentration</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_Ap:Free Action'>Ap: Free Action</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_Ap:Status'>Ap: Status</button>
<button type='roll' class='tokenaction' value='/r d100' name='roll_EndTurn'>End Turn</button>
-->
<button type="roll" class='tokenaction' name="roll_Attack Primary" value="@{Attack Primary_action}">Attack Primary</button>
<input type="hidden" name="attr_Attack Primary_action">
<button type="action" style="-toby-display:none;" name="act_Attack Primary-action">Attack Primary</button>
<button type="roll" class='tokenaction' name="roll_Attack Secondary" value="@{Attack Secondary_action}">Attack Secondary</button>
<input type="hidden" name="attr_Attack Secondary_action">
<button type="action" style="-toby-display:none;" name="act_Attack Secondary-action">Attack Secondary</button>
<button type="roll" class='tokenaction' name="roll_ap➙melee" value="@{ap➙melee_action}">AP Missile</button>
<input type="hidden" name="attr_ap➙melee_action">
<button type="action" style="-toby-display:none;" name="act_ap➙melee-action">AP Missile</button>
<button type="roll" class='tokenaction' name="roll_ap➙missile" value="@{ap➙missile_action}">AP Missile</button>
<input type="hidden" name="attr_ap➙missile_action">
<button type="action" style="-toby-display:none;" name="act_ap➙missile-action">AP Missile</button>
<button type="roll" class='tokenaction' name="roll_ap➙clear" value="@{ap➙clear_action}">AP Clear</button>
<input type="hidden" name="attr_ap➙clear_action">
<button type="action" style="-toby-display:none;" name="act_ap➙clear-action">AP Clear</button>
<button type="roll" class='tokenaction' name="roll_ap➙spell" value="@{ap➙spell_action}">AP Spell</button>
<input type="hidden" name="attr_ap➙spell_action">
<button type="action" style="-toby-display:none;" name="act_ap➙spell-action">AP Spell</button>
<button type="roll" class='tokenaction' name="roll_ap➙perception" value="@{ap➙perception_action}">AP Perception</button>
<input type="hidden" name="attr_ap➙perception_action">
<button type="action" style="-toby-display:none;" name="act_ap➙perception-action">AP Perception</button>
<button type="roll" class='tokenaction' name="roll_ap➙concentration" value="@{ap➙concentration_action}">AP Concentration</button>
<input type="hidden" name="attr_ap➙concentration_action">
<button type="action" style="-toby-display:none;" name="act_ap➙concentration-action">AP Concentration</button>
<button type="roll" class='tokenaction' name="roll_ap➙free" value="@{ap➙free_action}">AP Free</button>
<input type="hidden" name="attr_ap➙free_action">
<button type="action" style="-toby-display:none;" name="act_ap➙free-action">AP Free</button>
<button type="roll" class='tokenaction' name="roll_ap➙Status" value="@{ap➙Status_action}">AP Statuss</button>
<input type="hidden" name="attr_ap➙Status_action">
<button type="action" style="-toby-display:none;" name="act_ap➙Status-action">AP Statuss</button>
<button type="roll" class='tokenaction' name="roll_End Turn" value="@{End Turn_action}">End Turn</button>
<input type="hidden" name="attr_End Turn_action">
<button type="action" style="-toby-display:none;" name="act_End Turn-action">End Turn</button>
<button type="roll" class='tokenaction' name="roll_initiative" value="@{initiative_action}">initiative</button>
<input type="hidden" name="attr_initiative_action">
<button type="action" style="-toby-display:none;" name="act_initiative-action">initiative</button>
<button type="roll" class='tokenaction' name="roll_target" value="@{target_action}">target</button>
<input type="hidden" name="attr_target_action">
<button type="action" style="-toby-display:none;" name="act_target-action">target</button>


<hr>

<input type='text' name='attr_chatcommand'>
<button type='action' name='act_sendtochat'>Send to Chat</button>

<hr>

  <fieldset class='repeating_statrollcount'>Stat Rolls:
      <span name='attr_statrollcount'>X</span>
  </fieldset>

<hr>

Bug reports to nashidau on Discord or the #roll20 channel on the
<a href='https://discord.gg/ewAMrjkvVa'>ICE Discord</a>.

<hr>

Sheet Version: <span name='attr_version'></span>

<br>

Revision bd680cf8d34be84dc8dbebb09ccac98380a3450a


<hr>

</section>

</div>
</div>
</div> 

<script type="text/worker">

let lastmessages = {
  lasterror1: "",
  lasterror2: "",
  lasterror3: "",
}
let errorcount = 0;


function rmuerror(message) {
    let msg = []
    console.log("**** ERROR: ")
    for (var i = 0; i < arguments.length; i++) {
	console.log('>', arguments[i]);
        msg.push(arguments[i]);
    }
    errorcount ++;
    lastmessages.lasterror3 = lastmessages.lasterror2;
    lastmessages.lasterror2 = lastmessages.lasterror1;
    lastmessages.lasterror1 = msg.join(" ");
    lastmessages.errorcount = errorcount;
    console.log(lastmessages);
  //  setAttrs(lastmessages);
}

function rmuwarn(message) {
    console.log("** Warning: ")
    for (var i = 0; i < arguments.length; i++) {
	console.log('>', arguments[i]);
    }
}

// Something character related is wrong
// Should surface to the user.
function cherror(message) {
    console.log("*** Character Error");
    for (var i = 0; i < arguments.length; i++) {
	console.log('>', arguments[i]);
    }
}


function parseIntDefault(str, def) {
  if (typeof(str) == 'number') {
    if (Number.isInteger(str)) {
      return str;
    }
    return Math.floor(str);
  }
  let rv = parseInt(str);
  if (Number.isNaN(rv)) {
    return def;
  }
  return rv;
}

function parseNumberDefault(str, def) {
  if (typeof(str) == 'number') {
    return str;
  }
  let rv = Number.parseFloat(str);
  if (Number.isNaN(rv)) {
    return def;
  }
  return rv;
}

function mid3(a, b, c) {
    // Checking for b
    if ((a < b && b < c) || (c < b && b < a)) {
        return b;
    }
    // Checking for a
    else if ((b < a && a < c) || (c < a && a < b)) {
        return a;
    }
    return c;
}








const categories = [ 
  { display: 'Animal', 
    aname: 'animal', 
    zerominimum: false,
    stats: [ 'ag','em'],
    skills: [
      { display: 'Animal Handling',
        aname: 'animalhandling',
        category: 'animal',
        stat: 'pr',
		dynamicspecializations: 'Animal',
      },
      { display: 'Riding',
        aname: 'riding',
        category: 'animal',
        stat: 'pr',
		dynamicspecializations: 'Mount',
      },
    ]
  },
  { display: 'Awareness', 
    aname: 'awareness', 
    zerominimum: false,
    stats: [ 'in','re'],
    skills: [
      { display: 'Perception',
        aname: 'perception',
        category: 'awareness',
        stat: 'sd',
      },
      { display: 'Tracking',
        aname: 'tracking',
        category: 'awareness',
        stat: 'sd',
      },
    ]
  },
  { display: 'Battle Expertise', 
    aname: 'battleexpertise', 
    zerominimum: true,
    skills: [
      { display: 'Battle Styles',
        aname: 'battlestyle',
        category: 'battleexpertise',
	 expertise: true,
		dynamicspecializations: 'Style',
      },
      { display: 'Maneuvering in Armor',
        aname: 'maneuveringinarmor',
        category: 'battleexpertise',
	 expertise: true,
      },
      { display: 'Mounted Combat',
        aname: 'mountedcombat',
        category: 'battleexpertise',
	 expertise: true,
      },
      { display: 'Protect',
        aname: 'protect',
        category: 'battleexpertise',
	 expertise: true,
      },
      { display: 'Restricted Quarters',
        aname: 'restrictedquarters',
        category: 'battleexpertise',
	 expertise: true,
      },
      { display: 'Subduing',
        aname: 'subduing',
        category: 'battleexpertise',
	 expertise: true,
      },
    ]
  },
  { display: 'Body Discipline', 
    aname: 'bodydiscipline', 
    zerominimum: false,
    stats: [ 'co','sd'],
    skills: [
      { display: 'Adrenal Defense',
        aname: 'adrenaldefense',
        category: 'bodydiscipline',
        stat: 'ag',
      },
      { display: 'Adrenal Focus',
        aname: 'adrenalfocus',
        category: 'bodydiscipline',
        stat: 'sd',
      },
      { display: 'Adrenal Speed',
        aname: 'adrenalspeed',
        category: 'bodydiscipline',
        stat: 'qu',
      },
      { display: 'Adrenal Strength',
        aname: 'adrenalstrength',
        category: 'bodydiscipline',
        stat: 'st',
      },
      { display: 'Discipline Styles',
        aname: 'disciplinestyle',
        category: 'bodydiscipline',
	 expertise: true,
		dynamicspecializations: 'Style',
      },
    ]
  },
  { display: 'Brawn', 
    aname: 'brawn', 
    zerominimum: false,
    stats: [ 'co','sd'],
    skills: [
      { display: 'Body Development',
        aname: 'bodydevelopment',
        category: 'brawn',
        stat: 'co',
      },
      { display: 'Fortitude',
        aname: 'fortitude',
        category: 'brawn',
        stat: 'sd',
      },
      { display: 'Weight-training',
        aname: 'weighttraining',
        category: 'brawn',
        stat: 'st',
      },
    ]
  },
  { display: 'Combat Expertise', 
    aname: 'combatexpertise', 
    zerominimum: true,
    skills: [
      { display: 'Blind Fighting',
        aname: 'blindfighting',
        category: 'combatexpertise',
	 expertise: true,
      },
      { display: 'Combat Styles',
        aname: 'combatstyle',
        category: 'combatexpertise',
	 expertise: true,
		dynamicspecializations: 'Style',
      },
      { display: 'Disarm',
        aname: 'disarm',
        category: 'combatexpertise',
	 expertise: true,
      },
      { display: 'Footwork',
        aname: 'footwork',
        category: 'combatexpertise',
	 expertise: true,
      },
      { display: 'Multiple Attacks',
        aname: 'multipleattacks',
        category: 'combatexpertise',
	 expertise: true,
      },
      { display: 'Reverse Strike',
        aname: 'reversestrike',
        category: 'combatexpertise',
	 expertise: true,
      },
    ]
  },
  { display: 'Combat Training', 
    aname: 'combattraining', 
    zerominimum: false,
    stats: [ 'ag','st'],
    skills: [
      { display: 'Melee Weapons',
        aname: 'meleeweapons',
        category: 'combattraining',
        stat: 'st',
		specializations: [
		  { display: 'Blade', aname: 'blade', fulldisplay: 'Melee Weapons: Blade' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Chain', aname: 'chain', fulldisplay: 'Melee Weapons: Chain' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Hafted', aname: 'hafted', fulldisplay: 'Melee Weapons: Hafted' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Greater Blade', aname: 'greaterblade', fulldisplay: 'Melee Weapons: Greater Blade' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Greater Chain', aname: 'greaterchain', fulldisplay: 'Melee Weapons: Greater Chain' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Greater Hafted', aname: 'greaterhafter', fulldisplay: 'Melee Weapons: Greater Hafted' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Pole Arm', aname: 'polearm', fulldisplay: 'Melee Weapons: Pole Arm' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		  { display: 'Exotic', aname: 'meleeexotic', fulldisplay: 'Melee Weapons: Exotic' , category: 'combattraining' 
, specializationof: 'meleeweapons'
},
		],
      },
      { display: 'Ranged Weapons',
        aname: 'rangedweapons',
        category: 'combattraining',
        stat: 'ag',
		specializations: [
		  { display: 'Bow', aname: 'bow', fulldisplay: 'Ranged Weapons: Bow' , category: 'combattraining' 
, specializationof: 'rangedweapons'
},
		  { display: 'Crossbow', aname: 'crossbow', fulldisplay: 'Ranged Weapons: Crossbow' , category: 'combattraining' 
, specializationof: 'rangedweapons'
},
		  { display: 'Sling', aname: 'sling', fulldisplay: 'Ranged Weapons: Sling' , category: 'combattraining' 
, specializationof: 'rangedweapons'
},
		  { display: 'Thrown', aname: 'thrown', fulldisplay: 'Ranged Weapons: Thrown' , category: 'combattraining' 
, specializationof: 'rangedweapons'
},
		  { display: 'Exotic', aname: 'rangedexotic', fulldisplay: 'Ranged Weapons: Exotic' , category: 'combattraining' 
, specializationof: 'rangedweapons'
},
		],
      },
      { display: 'Shield',
        aname: 'shield',
        category: 'combattraining',
        stat: 'st',
      },
      { display: 'Unarmed',
        aname: 'unarmed',
        category: 'combattraining',
		specializations: [
		  { display: 'Strikes', aname: 'strikes', stat: 'st', fulldisplay: 'Unarmed: Strikes' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Sweeps & Throws', aname: 'sweepsthrows', stat: 'ag', fulldisplay: 'Unarmed: Sweeps & Throws' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Wrestling', aname: 'wrestling', stat: 'ag', fulldisplay: 'Unarmed: Wrestling' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Beak', aname: 'beak', stat: 'st', fulldisplay: 'Unarmed: Beak' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Bite', aname: 'bite', stat: 'st', fulldisplay: 'Unarmed: Bite' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Claw', aname: 'claw', stat: 'st', fulldisplay: 'Unarmed: Claw' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Horn', aname: 'horn', stat: 'st', fulldisplay: 'Unarmed: Horn' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Ram', aname: 'ram', stat: 'st', fulldisplay: 'Unarmed: Ram' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Stinger', aname: 'stinger', stat: 'ag', fulldisplay: 'Unarmed: Stinger' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		  { display: 'Trample', aname: 'trample', stat: 'st', fulldisplay: 'Unarmed: Trample' , category: 'combattraining' 
, specializationof: 'unarmed'
},
		],
      },
    ]
  },
  { display: 'Composition', 
    aname: 'composition', 
    zerominimum: false,
    stats: [ 'em','in'],
    skills: [
      { display: 'Illusion Crafting',
        aname: 'illusioncrafting',
        category: 'composition',
        stat: 'pr',
      },
      { display: 'Musical Composition',
        aname: 'musicalcomposition',
        category: 'composition',
        stat: 'pr',
      },
      { display: 'Writing',
        aname: 'writing',
        category: 'composition',
        stat: 're',
      },
    ]
  },
  { display: 'Crafting', 
    aname: 'crafting', 
    zerominimum: false,
    stats: [ 'ag','me'],
    skills: [
      { display: 'Culinary',
        aname: 'culinary',
        category: 'crafting',
        stat: 'sd',
      },
      { display: 'Drawing/Painting',
        aname: 'drawingpainting',
        category: 'crafting',
        stat: 'in',
      },
      { display: 'Fabric Craft',
        aname: 'fabriccraft',
        category: 'crafting',
        stat: 'sd',
      },
      { display: 'Leathercraft',
        aname: 'leathercraft',
        category: 'crafting',
        stat: 'sd',
      },
      { display: 'Metalcraft',
        aname: 'metalcraft',
        category: 'crafting',
        stat: 'st',
      },
      { display: 'Stonecraft',
        aname: 'stonecraft',
        category: 'crafting',
        stat: 'st',
      },
      { display: 'Woodcraft',
        aname: 'woodcraft',
        category: 'crafting',
        stat: 'sd',
      },
    ]
  },
  { display: 'Delving', 
    aname: 'delving', 
    zerominimum: false,
    stats: [ 'em','in'],
    skills: [
      { display: 'Attunement',
        aname: 'attunement',
        category: 'delving',
        stat: 'pr',
      },
      { display: 'Runes',
        aname: 'runes',
        category: 'delving',
        stat: 'pr',
      },
    ]
  },
  { display: 'Environmental', 
    aname: 'environmental', 
    zerominimum: false,
    stats: [ 'in','me'],
    skills: [
      { display: 'Navigation',
        aname: 'navigation',
        category: 'environmental',
        stat: 're',
      },
      { display: 'Piloting',
        aname: 'piloting',
        category: 'environmental',
        stat: 'ag',
		dynamicspecializations: 'Vehicle',
      },
      { display: 'Survival',
        aname: 'survival',
        category: 'environmental',
        stat: 're',
		specializations: [
		  { display: 'Alpine (A)', aname: 'survivialalpine', fulldisplay: 'Survival: Alpine (A)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Oceans (O)', aname: 'survivialoceans', fulldisplay: 'Survival: Oceans (O)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Underground (U)', aname: 'survivialunderground', fulldisplay: 'Survival: Underground (U)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Ice Caps (I)', aname: 'survivialicecaps', fulldisplay: 'Survival: Ice Caps (I)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Tundra (T)', aname: 'survivialtundra', fulldisplay: 'Survival: Tundra (T)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Boreal Forest (B)', aname: 'survivialboreal', fulldisplay: 'Survival: Boreal Forest (B)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Desert Shrublands (X)', aname: 'survivialshrublands', fulldisplay: 'Survival: Desert Shrublands (X)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Prairies & Steppes (P)', aname: 'survivialprairies', fulldisplay: 'Survival: Prairies & Steppes (P)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Temperate Forests (F)', aname: 'survivialtemperate', fulldisplay: 'Survival: Temperate Forests (F)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Hot Deserts (D)', aname: 'survivialhotdeserts', fulldisplay: 'Survival: Hot Deserts (D)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Savannas (S)', aname: 'survivialsavannas', fulldisplay: 'Survival: Savannas (S)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Tropical Forest (J)', aname: 'survivialtropical', fulldisplay: 'Survival: Tropical Forest (J)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Urban (C)', aname: 'survivialurban', fulldisplay: 'Survival: Urban (C)' , category: 'environmental' 
, specializationof: 'survival'
},
		  { display: 'Xeno', aname: 'survivialxeno', fulldisplay: 'Survival: Xeno' , category: 'environmental' 
, specializationof: 'survival'
},
		],
      },
    ]
  },
  { display: 'Gymnastic', 
    aname: 'gymnastic', 
    zerominimum: false,
    stats: [ 'ag','qu'],
    skills: [
      { display: 'Acrobatics',
        aname: 'acrobatics',
        category: 'gymnastic',
        stat: 'st',
      },
      { display: 'Contortions',
        aname: 'contortions',
        category: 'gymnastic',
        stat: 'sd',
      },
      { display: 'Jumping',
        aname: 'jumping',
        category: 'gymnastic',
        stat: 'st',
      },
    ]
  },
  { display: 'Lore', 
    aname: 'lore', 
    zerominimum: false,
    stats: [ 'me','me'],
    skills: [
      { display: 'Creature Lore',
        aname: 'creaturelore',
        category: 'lore',
        stat: 're',
		specializations: [
		  { display: 'Artificial Creature', aname: 'creatureloreartificial', fulldisplay: 'Creature Lore: Artificial Creature' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Demon', aname: 'creatureloredemon', fulldisplay: 'Creature Lore: Demon' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Dragon', aname: 'creatureloredragon', fulldisplay: 'Creature Lore: Dragon' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Elemental', aname: 'creatureloreelemental', fulldisplay: 'Creature Lore: Elemental' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Extra-planer', aname: 'creatureloreextraplaner', fulldisplay: 'Creature Lore: Extra-planer' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Faerie', aname: 'creaturelorefaerie', fulldisplay: 'Creature Lore: Faerie' , category: 'lore' 
, specializationof: 'creaturelore'
},
		  { display: 'Undead', aname: 'creatureloreundead', fulldisplay: 'Creature Lore: Undead' , category: 'lore' 
, specializationof: 'creaturelore'
},
		],
      },
      { display: 'Historic Lore',
        aname: 'historiclore',
        category: 'lore',
        stat: 're',
		dynamicspecializations: 'Period',
      },
      { display: 'Language',
        aname: 'language',
        category: 'lore',
        stat: 're',
		dynamicspecializations: 'Language',
      },
      { display: 'Materials Lore',
        aname: 'materialslore',
        category: 'lore',
        stat: 're',
		specializations: [
		  { display: 'Bone/Horn', aname: 'materialslorebone', fulldisplay: 'Materials Lore: Bone/Horn' , category: 'lore' 
, specializationof: 'materialslore'
},
		  { display: 'Fabrics', aname: 'materialslorefabric', fulldisplay: 'Materials Lore: Fabrics' , category: 'lore' 
, specializationof: 'materialslore'
},
		  { display: 'Leather', aname: 'materialsloreleather', fulldisplay: 'Materials Lore: Leather' , category: 'lore' 
, specializationof: 'materialslore'
},
		  { display: 'Metal', aname: 'materialsloremetal', fulldisplay: 'Materials Lore: Metal' , category: 'lore' 
, specializationof: 'materialslore'
},
		  { display: 'Stone', aname: 'materialslorestone', fulldisplay: 'Materials Lore: Stone' , category: 'lore' 
, specializationof: 'materialslore'
},
		  { display: 'Wood', aname: 'materialslorewood', fulldisplay: 'Materials Lore: Wood' , category: 'lore' 
, specializationof: 'materialslore'
},
		],
      },
      { display: 'Racial Lore',
        aname: 'raciallore',
        category: 'lore',
        stat: 're',
		dynamicspecializations: 'Racial Group',
      },
      { display: 'Region Lore',
        aname: 'regionlore',
        category: 'lore',
        stat: 're',
		dynamicspecializations: 'Region',
      },
      { display: 'Religion/Philosophy',
        aname: 'religionphilosophy',
        category: 'lore',
        stat: 're',
		dynamicspecializations: 'Religion',
      },
      { display: 'Spell Lore',
        aname: 'spelllore',
        category: 'lore',
        stat: 'in',
      },
    ]
  },
  { display: 'Magical Expertise', 
    aname: 'magicalexpertise', 
    zerominimum: true,
    skills: [
      { display: 'Grace',
        aname: 'grace',
        category: 'magicalexpertise',
	 expertise: true,
		dynamicspecializations: 'List',
      },
      { display: 'Spell Trickery',
        aname: 'spelltrickery',
        category: 'magicalexpertise',
	 expertise: true,
		dynamicspecializations: 'List',
      },
      { display: 'Transcendence',
        aname: 'transcendence',
        category: 'magicalexpertise',
	 expertise: true,
      },
    ]
  },
  { display: 'Medical', 
    aname: 'medical', 
    zerominimum: false,
    stats: [ 'in','me'],
    skills: [
      { display: 'Herbalism',
        aname: 'herbalism',
        category: 'medical',
        stat: 're',
      },
      { display: 'Medicine',
        aname: 'medicine',
        category: 'medical',
        stat: 're',
      },
      { display: 'Poison Mastery',
        aname: 'poisonmastery',
        category: 'medical',
        stat: 're',
      },
    ]
  },
  { display: 'Mental Discipline', 
    aname: 'mentaldiscipline', 
    zerominimum: false,
    stats: [ 'pr','sd'],
    skills: [
      { display: 'Control Lycanthropy',
        aname: 'controllycanthropy',
        category: 'mentaldiscipline',
        stat: 'sd',
      },
      { display: 'Meditation',
        aname: 'meditation',
        category: 'mentaldiscipline',
        stat: 'sd',
      },
      { display: 'Mental Focus',
        aname: 'mentalfocus',
        category: 'mentaldiscipline',
        stat: 'sd',
      },
    ]
  },
  { display: 'Movement', 
    aname: 'movement', 
    zerominimum: false,
    stats: [ 'ag','st'],
    skills: [
      { display: 'Climbing',
        aname: 'climbing',
        category: 'movement',
        stat: 'co',
      },
      { display: 'Flying',
        aname: 'flying',
        category: 'movement',
        stat: 'co',
      },
      { display: 'Running',
        aname: 'running',
        category: 'movement',
        stat: 'co',
      },
      { display: 'Swimming',
        aname: 'swimming',
        category: 'movement',
        stat: 'co',
      },
    ]
  },
  { display: 'Performance Art', 
    aname: 'performanceart', 
    zerominimum: false,
    stats: [ 'em','pr'],
    skills: [
      { display: 'Acting',
        aname: 'acting',
        category: 'performanceart',
        stat: 'me',
      },
      { display: 'Music',
        aname: 'music',
        category: 'performanceart',
        stat: 'me',
		dynamicspecializations: 'Instrument',
      },
      { display: 'Stage Magic',
        aname: 'stagemagic',
        category: 'performanceart',
        stat: 'ag',
      },
    ]
  },
  { display: 'Power Manipulation', 
    aname: 'powermanipulation', 
    zerominimum: false,
    stats: [ 'rs','rs'],
    skills: [
      { display: 'Channeling',
        aname: 'channeling',
        category: 'powermanipulation',
        stat: 'sd',
      },
      { display: 'Directed Spell',
        aname: 'directedspell',
        category: 'powermanipulation',
        stat: 'ag',
		specializations: [
		  { display: 'Elemental Bolts', aname: 'elementalbolts', fulldisplay: 'Directed Spell: Elemental Bolts' , category: 'powermanipulation' 
, specializationof: 'directedspell'
},
		  { display: 'Illusionary Attacks', aname: 'illusionaryattacks', fulldisplay: 'Directed Spell: Illusionary Attacks' , category: 'powermanipulation' 
, specializationof: 'directedspell'
},
		  { display: 'Hurling', aname: 'hurling', fulldisplay: 'Directed Spell: Hurling' , category: 'powermanipulation' 
, specializationof: 'directedspell'
},
		],
      },
      { display: 'Power Development',
        aname: 'powerdevelopment',
        category: 'powermanipulation',
        stat: 'co',
      },
      { display: 'Power Projection',
        aname: 'powerprojection',
        category: 'powermanipulation',
        stat: 'sd',
      },
    ]
  },
  { display: 'Science', 
    aname: 'science', 
    zerominimum: false,
    stats: [ 'me','re'],
    skills: [
      { display: 'Architecture',
        aname: 'architecture',
        category: 'science',
        stat: 're',
      },
      { display: 'Astronomy',
        aname: 'astronomy',
        category: 'science',
        stat: 're',
      },
      { display: 'Engineering',
        aname: 'engineering',
        category: 'science',
        stat: 're',
      },
      { display: 'Mathematics',
        aname: 'mathematics',
        category: 'science',
        stat: 're',
      },
    ]
  },
  { display: 'Social', 
    aname: 'social', 
    zerominimum: false,
    stats: [ 'em','in'],
    skills: [
      { display: 'Influence',
        aname: 'influence',
        category: 'social',
        stat: 'pr',
		specializations: [
		  { display: 'Charm', aname: 'charm', fulldisplay: 'Influence: Charm' , category: 'social' 
, specializationof: 'influence'
},
		  { display: 'Duping', aname: 'duping', fulldisplay: 'Influence: Duping' , category: 'social' 
, specializationof: 'influence'
},
		  { display: 'Intimidation', aname: 'intimidation', fulldisplay: 'Influence: Intimidation' , category: 'social' 
, specializationof: 'influence'
},
		],
      },
      { display: 'Leadership',
        aname: 'leadership',
        category: 'social',
        stat: 'pr',
      },
      { display: 'Social Awareness',
        aname: 'socialawareness',
        category: 'social',
        stat: 'em',
      },
      { display: 'Trading',
        aname: 'trading',
        category: 'social',
        stat: 'pr',
      },
    ]
  },
  { display: 'Spellcasting', 
    aname: 'spellcasting', 
    zerominimum: false,
    stats: [ 'rs','rs'],
    skills: [
      { display: 'Magical Ritual',
        aname: 'magicalritual',
        category: 'spellcasting',
        stat: 'me',
		specializations: [
		  { display: 'Alteration', aname: 'alteration', fulldisplay: 'Magical Ritual: Alteration' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Creation', aname: 'creation', fulldisplay: 'Magical Ritual: Creation' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Defensive', aname: 'defensive', fulldisplay: 'Magical Ritual: Defensive' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Destruction', aname: 'destruction', fulldisplay: 'Magical Ritual: Destruction' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Elemental', aname: 'elemental', fulldisplay: 'Magical Ritual: Elemental' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Healing', aname: 'healing', fulldisplay: 'Magical Ritual: Healing' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Informational', aname: 'informational', fulldisplay: 'Magical Ritual: Informational' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		  { display: 'Summoning & Transportation', aname: 'summoningtransportation', fulldisplay: 'Magical Ritual: Summoning & Transportation' , category: 'spellcasting' 
, specializationof: 'magicalritual'
},
		],
      },
      { display: 'Open',
        aname: 'open',
        category: 'spellcasting',
        stat: 'me',
		spellgroup: 'true',
      },
      { display: 'Closed',
        aname: 'closed',
        category: 'spellcasting',
        stat: 'me',
		spellgroup: 'true',
      },
      { display: 'Base',
        aname: 'base',
        category: 'spellcasting',
        stat: 'me',
		spellgroup: 'true',
      },
      { display: 'Arcane',
        aname: 'arcane',
        category: 'spellcasting',
        stat: 'me',
		spellgroup: 'true',
      },
      { display: 'Restricted',
        aname: 'restricted',
        category: 'spellcasting',
        stat: 'me',
		spellgroup: 'true',
      },
    ]
  },
  { display: 'Subterfuge', 
    aname: 'subterfuge', 
    zerominimum: false,
    stats: [ 'ag','sd'],
    skills: [
      { display: 'Ambush',
        aname: 'ambush',
        category: 'subterfuge',
        stat: 'in',
		specializations: [
		  { display: 'Directed Spells ', aname: 'ambushdirectedspells', fulldisplay: 'Ambush: Directed Spells ' , category: 'subterfuge' 
, specializationof: 'ambush'
},
		  { display: 'Melee', aname: 'ambushmelee', fulldisplay: 'Ambush: Melee' , category: 'subterfuge' 
, specializationof: 'ambush'
},
		  { display: 'Ranged', aname: 'ambushranged', fulldisplay: 'Ambush: Ranged' , category: 'subterfuge' 
, specializationof: 'ambush'
},
		  { display: 'Shield', aname: 'ambushshield', fulldisplay: 'Ambush: Shield' , category: 'subterfuge' 
, specializationof: 'ambush'
},
		  { display: 'Unarmed', aname: 'ambushunarmed', fulldisplay: 'Ambush: Unarmed' , category: 'subterfuge' 
, specializationof: 'ambush'
},
		],
      },
      { display: 'Concealment',
        aname: 'concealment',
        category: 'subterfuge',
        stat: 'in',
      },
      { display: 'Stalking',
        aname: 'stalking',
        category: 'subterfuge',
        stat: 'in',
      },
      { display: 'Trickery',
        aname: 'trickery',
        category: 'subterfuge',
        stat: 'in',
      },
    ]
  },
  { display: 'Technical', 
    aname: 'technical', 
    zerominimum: false,
    stats: [ 'in','re'],
    skills: [
      { display: 'Locks',
        aname: 'locks',
        category: 'technical',
        stat: 'ag',
      },
      { display: 'Mechanics',
        aname: 'mechanics',
        category: 'technical',
        stat: 'me',
		specializations: [
		  { display: 'Operation', aname: 'operation', fulldisplay: 'Mechanics: Operation' , category: 'technical' 
, specializationof: 'mechanics'
},
		  { display: 'Repair & Construction', aname: 'repairconstruction', fulldisplay: 'Mechanics: Repair & Construction' , category: 'technical' 
, specializationof: 'mechanics'
},
		],
      },
      { display: 'Traps',
        aname: 'traps',
        category: 'technical',
        stat: 'ag',
      },
    ]
  },
  { display: 'Vocation', 
    aname: 'vocation', 
    zerominimum: false,
    stats: [ 'em','me'],
    skills: [
      { display: 'Administration',
        aname: 'administration',
        category: 'vocation',
        stat: 're',
		dynamicspecializations: 'Administration',
      },
      { display: 'Service',
        aname: 'service',
        category: 'vocation',
        stat: 'pr',
		dynamicspecializations: 'Service',
      },
      { display: 'Trade',
        aname: 'trade',
        category: 'vocation',
        stat: 're',
		dynamicspecializations: 'Trade',
      },
    ]
  },

]

/**/
RMUCosts = {}
RMUCosts.costs = {}

// Clear the costs.  Just delete the table
RMUCosts.reset = function() {
  RMUCosts.costs = {};
  return true;
}


RMUCosts.update = function(key, cost, ranks) {
  if (cost == 0) {
    delete RMUCosts.costs[key];
    return true;
  }
  let blob = { cost: cost, ranks: ranks };

  RMUCosts.costs[key] = blob;
}

RMUCosts.getTotalCost = function() {
  let total = 0;

  for (const key in RMUCosts.costs) {
    total += RMUCosts.costs[key].cost;
  }
  return total;
}

/**/





function F(num) {
  if (typeof(num) != 'number') {
    rmuerror("F got passed a ", typeof(num), num);
    return '   ';
  }
  return num.toString().padStart(3, ' ')
}

/**
 * Returns the bonus for a particular name in a misctr
 */
function miscBonusGet(miscstr, name) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	return 0;
    }
    const misc = JSON.parse(miscstr);
    for (let obj of misc) {
	if (obj.name == name) {
	    return obj.value;
	}
    }

    return 0;
}

function miscBonusSet(miscstr, name, value) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	miscstr = '[]';
    }
    let misc = JSON.parse(miscstr);
    let found = false
    for (const obj of misc) {
	if (obj.name == name) {
	    obj.value = parseInt(value);
	    found = true;
	}
    }
   
    if (!found) {
	const obj = {
	    name: name,
	    value: parseInt(value)
	};
	misc.push(obj)
    }
    return JSON.stringify(misc);
}

function miscMessageAdd(miscstr, message) {
    let misc = JSON.parse(miscstr);
    miscRawMessage(misc, message);
    return JSON.stringify(misc);
}

function miscBonusRemove(miscstr, name) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	return '';
    }
    let misc = JSON.parse(miscstr);
    misc = misc.filter(function(item) {
	    return item.name !== name
    });
    return JSON.stringify(misc);
}

// Any item that matches the filter will be remmoebed
function miscBonusRemoveFilter(miscstr, fn) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	return '';
    }
    let misc = JSON.parse(miscstr);
    misc = misc.filter(fn);
    return JSON.stringify(misc);
}

function miscBonusTotal(miscstr, prefix = '') {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	return [0, ""];
    }
    const misc = JSON.parse(miscstr);
    let log = "";
    let total = 0;
    for (const obj of misc) {
	if (obj.hasOwnProperty('absolute')) {
	    log += `${prefix}Set to ${obj.absolute}  ${obj.name}\n`;
	    total = parseInt(obj.absolute);
	} else if (obj.hasOwnProperty('value')) {
	    let value = parseIntDefault(obj.value, 0);
	    log += `${prefix}${F(value)}   ${obj.name}\n`;
	    total += value;
	} else if (obj.hasOwnProperty('message')) {
	    log += `${prefix}${obj.message}\n`;
	} else {
	    console.log("Misc has unknown type", obj, miscstr);
	}
    }
    return [total, log]
}

function miscBonusTotalFlat(miscstr) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	return [0, ""];
    }
    const misc = JSON.parse(miscstr);
    let log = "";
    let total = 0;
    for (const obj of misc) {
	if (obj.hasOwnProperty('absolute')) {
	    // FIXME: These don't belong here.
	    log += `Set to ${obj.absolute}  ${obj.name}\n`;
	    total = parseInt(obj.absolute);
	} else if (obj.hasOwnProperty('value')) {
	    let value = parseIntDefault(obj.value, 0);
	    if (value < 0) {
		// Negatives print their own sign
		log += ` ${value}&nbsp;[${obj.name}]`;
	    } else {
		log += ` +${value}&nbsp;[${obj.name}]`;
	    }
	    total += value;
	} else if (obj.hasOwnProperty('message')) {
	    // Skipped
	} else {
	    rmuerror("Misc has unknown type", obj, miscstr);
	}
    }
    return [total, log]
}

function miscBonusHighest(miscstr, lowest) {
    if (typeof(miscstr) !== 'string' || miscstr === '') {
	return [lowest, ''];
    }
    const misc = JSON.parse(miscstr);
    let highest = lowest;
    let hstr = '';
    for (const obj of misc) {
	if (obj.absolue || obj.value) {
	    const val = obj.absolue || obj.value;
	    if (val > highest) {
		highest = val;
		hstr = obj.name;
	    }
	}
    }
    return [highest, hstr]
}

// Finds a message with the appropriate prefix.
function miscMessagePrefix(miscstr, prefix) {
    if (typeof(miscstr) !== 'string' || miscstr === '') {
	return false;
    }
    const misc = JSON.parse(miscstr);
    return miscRawMessagePrefix(misc, prefix);
}

// Finds a bonus with the appropriate prefix
// Returns {} ->
function miscBonusPrefix(miscstr, prefix) {
    if (typeof(miscstr) !== 'string' || miscstr === '') {
	return {};
    }
    const misc = JSON.parse(miscstr);
    return miscRawBonusPrefix(misc, prefix);
}

function miscAttrSet(attr, name, value) {
    let toget = attr;
    if (!attr.endsWith("_misc")) {
	rmuerror("Use of default _misc on miscAttrSet ", attr, name, value);
	toget = attr + "_misc";
    }
    getAttrsPending([toget], (ev) => {
	const str = ev[toget];
	const newstr = miscBonusSet(str, name, value);
	setAttrsPending({[toget]: newstr});
    });
}

function miscAttrRemove(attr, name) {
    let toget = attr;
    if (!attr.endsWith("_misc")) {
	rmuerror("Use of default _misc on miscAttrRemove ", attr, name, value);
	toget = attr + "_misc";
    }
    getAttrsPending([toget], (ev) => {
	const str = ev[toget];
	const newstr = miscBonusRemove(str, name);
	setAttrsPending({[toget]: newstr});
    });
}

function miscAttrMessageAdd(attr, message) {
    let toget = attr;
    if (!attr.endsWith("_misc")) {
	toget = attr + "_misc";
    }
    getAttrsPending([toget], (ev) => {
	const str = ev[toget];
	const newstr = miscMessageAdd(str, message);
	setAttrsPending({[toget]: newstr});
    });
}

function miscRawNew() {
    return []
}

function miscRawAppend(misc, name, value) {
    const obj = {
	name: name,
	value: parseInt(value)
    }
    misc.push(obj);
    return misc
}

function miscRawSetAbsolute(misc, name, absolute) {
    misc.push({name: name, absolute}); 
    return misc
}

function miscRawMessage(misc, message) {
    misc.push({ message: message });
    return misc
}

// Finds a message with the appropriate prefix.
function miscRawMessagePrefix(misc, prefix) {
    for (const obj of misc) {
	if (obj.message && typeof(obj.message) === 'string' &&
		obj.message.startsWith(prefix)) {
	    // Return it
	    return obj.message
	}
    }
    return false;
}

// Finds a message with the appropriate prefix.
function miscRawBonusPrefix(misc, prefix) {
    for (const obj of misc) {
	if (obj.name && typeof(obj.name) === 'string' &&
		obj.name.startsWith(prefix)) {
	    // Return it
	    return obj
	}
    }
    return {};
}

function miscRawToString(misc) {
    return JSON.stringify(misc)
}

function miscRawGetFromString(miscstr) {
    if (typeof(miscstr) != 'string' || miscstr == '') {
	miscstr = '[]';
    }
    return JSON.parse(miscstr);
}

// vim: set sw=4 sts=4 syn=javascript :

/**
 * Real simple async library for set and get Attributes.
 *
 */

// Number of nested async calls we are in.
let rmuasync = 0;
// Set to true while in an async call.
// Cleared just before we call a handler.
let rmuasyncnested = false;
let rmuasyncprev = "";
let pendingList = []

function asyncSetNest(func, args) {
  if (rmuasyncnested) {
    rmuerror("Got a second async call Was:", rmuasyncprev, "new:", func, args);
  }
  rmuasyncprev = func + args;
  rmuasyncnested = true;
}

function getAttrsPending(attrs, func) {
  asyncSetNest("getAttrsPending", attrs);
  rmuasync ++;
  if (typeof(func) != 'function') {
    rmuerror("getAttrsPending needs a function", attrs, func);
    rmuasync --;
    checkPending();
    return;
  }
  getAttrs(attrs, (ev) => {
      rmuasyncnested = false;
      func(ev);
      rmuasync --;
      checkPending();
  });
}

function setAttrsPending(attrs, func) {
  asyncSetNest("setAttrsPending", attrs);
  rmuasync ++;
  for (const x in attrs) {
    if (typeof(attrs[x]) != 'string' && typeof(attrs[x]) != 'number' &&
	typeof(attrs[x]) != 'boolean') {
      rmuerror(`Set Attrs: ${x} is not a valid value`, typeof(attrs[x]), attrs[x], attrs);
    }
  }

  setAttrs(attrs, (ev) => {
      rmuasyncnested = false;
      if (func) func(ev);
      rmuasync --;
      checkPending();
  });
}

function getCompendiumPagePending(str, func) {
  asyncSetNest("getCompendiumPagePending", str);
  rmuasync ++;
  getCompendiumPage(str, (ev) => {
      rmuasyncnested = false;
      if (func) func(ev);
      rmuasync --;
      checkPending();
  });
}

function getCompendiumQueryPending(str, func) {
  asyncSetNest("getCompendiumQueryPending", str);
  rmuasync ++;
  getCompendiumQuery(str, (ev) => {
      rmuasyncnested = false;
      if (func) func(ev);
      rmuasync --;
      checkPending();
  });
}

function getSectionIDsPending(section, func) {
    if (!func) return;

    asyncSetNest("getSectionIDsPending", section);
    rmuasync ++;
    getSectionIDs(section, idarray => {
	rmuasyncnested = false;
	func(idarray);
	rmuasync --;
	checkPending();
    });
}

function getSectionIDsListPending(sections, func) {
  const res = [];
  let waiting = 1; // Start at one to force something
  rmuasync ++;

  sections.forEach((section) => {
    waiting ++;
    getSectionIDs(section, (ids) => {
      for (id of ids) {
	res.push(section + "_" + id)
      }
      waiting --;
      if (waiting == 0) { waiting = -99; func(res); rmuasync --; checkPending();  }
    });
  });
  waiting --;
  if (waiting == 0) { waiting = -99; func(res); rmuasync --; checkPending(); }
}

function getSectionIDsOrdered(sectionName, callback) {
  'use strict';
  getAttrs([`_reporder_${sectionName}`], function (v) {
    getSectionIDs(sectionName, function (idArray) {
      let reporderArray = v[`_reporder_${sectionName}`] ? v[`_reporder_${sectionName}`].toLowerCase().split(',') : [],
        ids = [...new Set(reporderArray.filter(x => idArray.includes(x)).concat(idArray))];
      callback(ids);
    });
  });
};


function addRepeatingSectionPending(a, b, c, func) {
  if (!func) {
    rmuerror("addRepeatingSectionPending needs a function:", a, b, c, func);
    return
  };
  asyncSetNest("addRepeatingSectionPending", a);
  rmuasync ++;
  addRepeatingSection(a,b,c,(secid) => {
      rmuasyncnested = false;
      func(secid);
      rmuasync --;
      checkPending();
  });
}

function forEachSkillPending(eachSkillCb, donefn) {
  rmuasync ++;
  asyncSetNest("forEachSkillPending", eachSkillCb, donefn);
  RMUSkills.forEachSkill((a,b,c) => {
      eachSkillCb(a,b,c);
    },
    () => {
      rmuasyncnested = false;
      if (donefn) { donefn();}
      rmuasync --;
      checkPending();
    }
  );
}


function addPendingFunction(name, func) {
  if (!func || typeof(func) != "function"){
    rmuerror(`unable to save nil function (${name} -> ${typeof(func)})`);
    return;
  }
  const item = {
      name: name,
      cb: func
  };
  pendingList.push(item);
}

/* Same as addPendingFunction, but inserts at head of queue.
   This is a bit of smell */
function addPendingFunctionNext(name, func) {
  if (!func || typeof(func) != "function"){
    rmuerror(`unable to save nil function (${name} -> ${typeof(func)})`);
    return;
  }
  const item = {
      name: name,
      cb: func
  };
  pendingList.unshift(item);
}

let asyncTimeout = false;

function pendingTimeout(item) {
  rmuerror("Timeout on ", item.name, item);
  // Force progress
  checkPending();
}

function checkPending() {
  if (asyncTimeout) {
    clearTimeout(asyncTimeout);
    asyncTimeout = false;
  }

  if (rmuasync < 0){
    rmuerror("Negative async count: Reseting");
    rmuasync = 0;
  }

  while (rmuasync == 0 && pendingList.length > 0) {
    pendingInfo();
    // Take it off first, just in case someone does something weird
    const item = pendingList.shift();
    if (asyncTimeout) {
      clearTimeout(asyncTimeout);
    }
    asyncTimeout = setTimeout(checkPending, 500, item);

    console.log(`>> Calling pending ${item.name}`, item);
    try {
      item.cb();
    } catch (e) {
      rmuerror("Exception from ", item.name, e);
      console.log(`Async stat: ${rmuasync}`);
      // Reset the state.
      rmuasync = 0;
    }
  }
}

function pendingInfo(verbose = false) {
  console.log(`Pending level is ${rmuasync} with ${pendingList.length} queued: Nested ${rmuasyncnested}`);
  if (verbose && pendingList.length > 0) {
    pendingList.forEach((item) => {
      console.log(`   ${item.name}`);
    });
  }
  return pendingList.length;
}

function pendingReset(verbose = true) {
  if (verbose) {
    console.log("Pending reset");
  }
  if (rmuasync) {
    if (verbose) {
      console.log(`Pending reset: ${rmuasync} with ${pendingList.length} queued`);
    }
    rmuasync = 0;
    rmuasyncnested = false;
    pendingList = [];
  }
}

function onCheck(str, func) {
  if (typeof(str) != 'string') {
    rmuerror("Calling on with not a string", str);
    return -1;
  }
  if (typeof(func) != 'function') {
    rmuerror("Calling on with not a functio", str, func);
    return -1;
  }
  const items = str.split(/ +/);
  for (item of items) {
    // Each should have at least one :
    if (item != '' && !item.includes(":")) {
      rmuerror(`${item} doesn't have a colon from ${str}`);
    }
    // Must match one of these:
    if (!item.match(/^(change|clicked|page|mancerchange|mancerfinish|remove|sheet):(repeating_[^:]*:)?[^:]*$/)) {
      rmuerror(`${item} doesn't seem right`);
    }
  }
  on(str, func);
}

/** Sets the character ID and returns the current one.*/
function setActiveCharacterId(id) {
  const ocid = getActiveCharacterId();
  const data = {
    id: '0',
    type: 'setActiveCharacter',
    data: id,
  };
  if (self.dispatchEvent) {
    const event = new CustomEvent('message');
    event.data = data;
    self.dispatchEvent(event);
  }
  else {
    self.onmessage({ data });
  }
  return ocid;
}

function asCharacter(id, func) {
  const origid = setActiveCharacterId(id);
  const rv = func()
  setActiveCharacterId(origid);
  return rv;
}


function rmuSetAttrsRemote(characterid, attrs, done) {
  // FIXME: Validate the damn args
  const myid = setActiveCharacterId(characterid);
  if (myid == characterid) {
    rmuerror("Set active and current character to the same", characterid);
  }
  rmuSetAttrs(attrs, done);
  setActiveCharacterId(myid);
}

function rmuGetAttrsRemote(characterid, attrs, done) {
  // FIXME: Validate the damn args
  const myid = setActiveCharacterId(characterid);
  if (myid == characterid) {
    rmuerror("Set active and current character to the same", characterid);
  }
  rmuGetAttrs(attrs, done);
  setActiveCharacterId(myid);
}


onCheck("clicked:resetworkers", () => {
  pendingReset();
});



/**/

const knownproperties = {
  // Character properties
  character_name : { type : "string", readonly: true },
  level : { type: "number", derived : true },
  pp : { type : "number" },
  pp_max : { type : "number" },
  realm : { type : "string" },
  scr_misc : { type : "misc" },
  hp: { type: "number" },
  hp_max: { type: "number" },
  hp_misc: { type: "misc" },
  hits: { type: "number" }, 
  activetokenid: { type: "string" },

  // Skills: FIXME: Should autogen this list
  transcendence_bonus : { type : "number", derived: true },
  powerdevelopment_bonus: { type: "number", derived: true },
  bodydevelopment_bonus : { type: "number", derived: true },

  // From the rest/sleep time: Two fields, read only.
  statussleephours : { type: "number", readonly: true },
  statussleepfullrest: { type: "onoff", readonly: true },
  togglesleepshow: { type: "string", values: ["on", "off" ] },

  // What is this?
  castingmiscmod : { type: "number", derived: true },

  powerlevel: { type: "string" },


  // Magic/Spellcasting
  castingvoice: { type: "string" },
  castingpreprounds: { type: "number" },
  castingsubtle: { type: "string" },
  castinghands: { type: "string" },
  pp_multiplier : { type: "number" },

  // AP
  castinguseap: { type: "string" },
  aptrack: { type: "number" },
  actionselect: { type: "string" },

  // Equipment related
  armorencmetal: { type: "number" },
  armorenc: { type: "number" },

  // Maneuver Penalty / Status penalty
  statuspenalty: { type: "number" },
  statuseffect: { type: "string" },

  // Options
  option_fixedrrbase: { type: "string" },
  option_allownoprepovercast: { type: "string" },
  option_usefx: { type: "string" },

  // Roll20 Meta Stuff
  selectedcharacterid: { type: "string" },
  target_listeners: { type: "string" },
};

function validateAttributes(attrs) {
  if (Array.isArray(attrs)) {
    return validateGetAttributes(attrs)
  }

  let erred = false;
  Object.keys(attrs).forEach(key => {
    if (key.startsWith("repeating")) return;
    const value = attrs[key]
    if (knownproperties[key]) {
      const prop = knownproperties[key];
      if (typeof(value) != prop.type) {
	rmuerror("rmuSafe: Property type is not valid (expected, got)",
		key, prop.type, typeof(value), value);
	erred = true
      }
    } else {
      rmuerror("rmuSafe: Unknown property", key)
      erred = true;
    }
  })
  return !erred;
}

function validateGetAttributes(attrs) {
  let erred = false;
  for (const key of attrs) {
    if (key.startsWith("repeating")) continue;
    if (!knownproperties[key]) {
      rmuerror(`rmuSafe: Unknown property in get: ${key}`);
      erred = true
    }
  }
  return !erred;
}


function rmuGetAttrsPending(toget, handler) {
  validateAttributes(toget);
  
  return getAttrsPending(toget,handler);
}

function rmuSetAttrsPending(toset, handler) {
  validateAttributes(toset);

  return setAttrsPending(toset, handler);
}

function VrmuSetAttrs(arg, fn) {
  console.log(arg);
  return rmuSetAttrs(arg, fn);
}

function rmuGetAttrs(toget, handler) {
  //validateAttributes(toget);
  
  return getAttrs(toget,handler);
}

function rmuSetAttrs(toset, handler) {
  //validateAttributes(toset);

  return setAttrs(toset, handler);
}


/**/


let RMURaces = {};

(function () {
  // Set data from a Compendium race.
  // Set RMU.md for the compendium data format
  // This function sets lots of misc fields; so we fetch them first,
  // then try and update them.
  RMURaces.raceSet = function(raceName, racedata) {
    console.log("Starting setting race");
    console.log(racedata)

    getAttrsPending([
	"ag_misc", "co_misc", "em_misc", "in_misc", "me_misc",
	"pr_misc", "qu_misc", "re_misc", "sd_misc", "st_misc",
        "rr_channeling_misc", "rr_essence_misc", "rr_mentalim_misc",
        "rr_fear_misc", "rr_physical_misc",
        "endurance_misc", "hp_misc",
	"bmr_misc", "dp_misc"
      ], (miscdata) => {

	const updates = {};
	const rstr = `Racial (${raceName})`;

	let doMiscSet = function (key, value) {
	  updates[key] = miscBonusSet(miscdata[key], rstr, value);
	}


	// data-stats
	for (stat in racedata["data-stats"])  {
	    // get the shortname
	  const sname = RMUStats.getStatAbbrFromName(stat)
	  doMiscSet(sname + "_misc", racedata['data-stats'][stat]);
	}

	for (rr in racedata["data-rrs"]) {
	  const rrl = rr.toLowerCase();
	  doMiscSet(`rr_${rrl}_misc`, racedata["data-rrs"][rr]);
	}

	{
	  const health = racedata['data-health'];
	  doMiscSet("endurance_misc", health.Endurance || 0);
	  doMiscSet("hp_misc", health["Base Hits"]);
	  // FIXME setAttr correct call
	  updates.recovery_multiplier = health["Recovery Mult"];
      }

      {
	const size = racedata['data-size'];
	updates.weight = size['Weight (M)'];
	updates.height = size['Height (M)'];
	updates.size = size['Size'];

	if (size.Stride) {
	  doMiscSet("bmr_misc", size.Stride)
	  addPendingFunction("RaceSet Size: Update BMR", frontpage.updateBMR);
	}
      }

      // bonus dp
      {
	const bonusdp = racedata['Bonus DP'];
	if (bonusdp) {
	  doMiscSet("dp_misc", bonusdp);
	}
      } 

      // Talents
      {
	const talents = racedata['data-RacialTalents'] || racedata['data-Talents'];
	for (const talent in talents) {
	  RMUTalents.addByName(talents[talent].Talent, 
	    talents[talent].Tier || 1,
	    talents[talent].Choice,
	    rstr);
	}
      }

      setAttrsPending(updates);

      console.log("Race setting done", updates);
    });
  }

})();



/** vim: set sw=2 sts=2 : */



function VrmuSetAttrs(arg, fn) {
  console.log(arg);
  return rmuSetAttrs(arg, fn);
}

function rmuSetAttrs(arg, fn) {
 // Validate it makes sense
  for (a in arg) {
    const t = typeof(arg[a]);
    if (t != 'string' && t != 'number' && t != 'boolean') {
      rmuerror("Passing arg", a, "type", t, "value", arg[a]);
    }
  }
  setAttrs(arg, fn)
}



function VpopulateListOptions(update) {
  console.log(update);
  populateListOptions(update)
}

let RMUSkills = {};



const skillrollresults = {
  general: {
    absolutefailure: 'Not only do you utterly fail, but you manage to make the situation worse. ' +
	      ' You are an embarrassment to yourself.',
    failure: "  You fail the maneuver and must pay the consequences. Hopefully this wasn't a life or death situation.",
    partialsuccess :"If this maneuver is something you can partially succeed at then you do so. Otherwise the maneuver fails. Too bad.",
    success: "The attempt succeeds and you pat yourself on the back for a job well done. Congratulations!",
    absolutesuccess : "You succeed in the best way possible, and impress everyone who sees you.",
    unusualevent: 'There is an unexpected side effect to your maneuver. ',
  },
  animal : {
    absolutefailure: "Your confidence breaks at a crucial moment and the animal seizes " +
	  "the moment to lash out (attacking at +30) before bolting in a random direction.",
    failure : "Perhaps it is your impatient manner, perhaps it is your over-abrupt movements, perhaps your smelly cologne, but the animal is unimpressed and uninfluenced.",
    unusualevent : "The animal recognizes you not as a master but in some other role such as offspring, parent, or mate.  It attempts to protect and feed, follow and imitate, or woo and placate you which may be helpful or problematic, depending on the suc/cesss of your maneuver.",
    partialsuccess : "For a momentyou think the animal is receptive to your guidance, but a suddent distraction breaks the moment.  You may try again at +10 if appropriate.",
    success : "Whispering Calming Words while projecting a sure and confident demeanot, you have the animal's attention and coorperation.  Do not waste the opportunity.",
    absolutesuccess : "Your insight into this animal's nature has won you its lasting respect.  You will receive +30 to any future Animal maneuvers versus this target (until an Absolute Failure is achieved).",
  },
    awareness: {
       absolutefailure : "You glean enormous amounts of information about your target…all of it is wrong.  You utterly believe what you perceive and are sure it is correct.",
       failure: "Attempting to emulate the perceptive abilties of an eggplant, you notice nothing useful.  There is a great future waiting for you as an art critic.",
       unusualevent: "Your surroundings trigger a flashback to an event in your past and consumes your attention for three rounds while you relive the experience.  You may immediately make a Lore maneuver to recall something previously missed but important to the story.  Your maneuver resolves after.",
       partialsuccess: "Your interest is piqued, but you glean minimal information.  You may try again in 6 rounds at +10 if appropriate.",
       success: "Following your instincts you focus your attention, allowing your finely tuned perception to reveal that which you seek.",
       absolutesuccess: "Elementary my dear boy!  You identify with casual ease the target or information you seek, along with contextual information not obvious to a lesser eye.",
       },
  bodydiscipline : {
    absolutefailure: "What were you thinking?  Your feeble attempt to focus creates a mental block that hinders your future attempts, giving you a -25 to this skill until an Absolute Success is achieved.",
     failure: "You fail to summon your inner focus necessary for this feat, and receive no benefit or effects from your attempt.  Thanks for playing.",
     unusualevent : "As you begin to summon your focus, you notice an unfamilliar darkness within yourself.  You enter a cleansing trance that lasts for an entire round.  If you succeed in your maneuver, treat as an Absolute Success.  If you fail, treat as an Absolute Failure.",
     partialsuccess : "You are distracted at a critical moment but receive half the normal benefit.  Or, if not in combat, you may abort and try again at +10.  Try switching to decaf.",
     success : "You are a paragon of self-control and receive full benefits of the maneuver for 1 round for every 20 you succeeded by (1 round for 101-120, 2 rounds for 121-140, etc), doubled for Adrenal Defense.",
       absolutesuccess : "Wow!  You not only succeed but you have tapped into a resevoir of strength within yourself.  As Success but you receive double benefits for the first round.",
  },
  composition: {
    absolutefailure: "You artists types!  In a fit of anger you destroy any work you have already accomplished.  Your emotions get the better of you and you are at -25 to this sill until an Absolute Success is achieved.",
   failure: "Whatever is locked in your head remains so.  You find yourself utterly unable to transfer your concept to the medium.  Perhaps another day with yield improvements.",
   unusualevent: " Your interpretation is a profound departure from your normal style, from any style in fact.  People will be unable to understand it and only leave confused.  In a few days of contemplation they will see it as either the brilliant (success) or bad (failure) piece that it was.",
   partialsuccess: " Your temer flares as your attempts fall short of your expectations.  Whie your work has merit, you have not effectively grasped your own intent.",
   success: " Twas nothing!  You have once again demonstrated your ample genius to all with te ability to see.  If only the whole world were not blind compared to you.",
   absolutesuccess: " Ahh, Bach!  The masterstroke of your piece falls into place with the surety of perfection.  This piece will make your reputation, if not your fortune.  Who says you have to die to be great?",
   },
  crafting : {
    absolutefailure:  "You fail miserably but you are so oblivious you are convinced you have succeeded admirably.  Your new misguided approach give you -25 to this skill until an Absolute Success is achieved.",
    failure : "Your skills have deserted you.  You waste your effort and create some extra work for yourself.  You may attempt to salvage the crafting materials with a crafting maneuver with an additional penalty of -25.",
    unusualevent : "You have a grat idea for your craftwork and, after an arduous effort, you realize the work.  The result is a unique built-in feature that either hinders the work (if aFailure) or makes it more desirable and useful (if Success).",
    partialsuccess : "You know what you want to accomplish but it just keeps falling short.  Your work is functional but deficient with an increased chance of breakage (-10 Strenth).",
    success : "You hands are sure and your work is precise and artful.  Your work comes out exactly as you intended and there are no surprises along the way.",
    absolutesuccess : "Your diligence is rewarded with your latest masterwork!  Everyone else can see the remarkable quality of your work, and your abilities will be more highly regarded than ever.  Item has +10 Strength.",
  },
  delving : {
    absolutefailure: "You not only fail to attune, you manage to deattune yourself to any items you have already attuned to.  You may attempt to reattuneto those items at -20.",
    failure: "You fail to match auras with the item and a period of contemplation is in order.  You may not try again until you have developed another rank in Attunement.",
    unusualevent : "You glimpse a series of visions associated with the item's past over 3 rounds during which time you are in an unwakeable trance.  When you emerge from the trance you will know about the item's past, even if you've not successfully attuned to it.",
    partialsuccess : "You learn one ability of the item but you cannot use it.  You may try again to attune after a good night's sleep.",
    success : "You learn and make use one ability of the item.  You may make a maneuver at +20 to gain more knowledge.  If you fail you cannot try again for 24 hours.",
    absolutesuccess : "You harmonize your aura with that of the item smoothly, learning all abilities of the item, which are now available for your use.  If only success looked as impressive as you feel about yourself.",
  },
  runes : {
absolutefailure : "You accidentally cast the Rune (targetting yourself) upon trying to disipher it.  Lear to read without mumbling to yourself.",
failure : "It is all gibberish to you.  Until you improve your understanding (develop another rank in Runes), you may not try again.",
unusualevent : "Yes!  Those marks are more than a spell, they contain a secret message!  Resolve the maneuver as normal.  It then takes you 1-10 hours of study (taken at your first opportunity) to conclude that you were mistaken…or were you?  (psst, GM…insert plot hook here).",
partialsuccess : "You learn the idenity of the spell inscribed in the Rune, but cannot cast it.  You may try again after a good night's sleep but another Partial Success is treated as a Failure.",
success : "Your mystical senses are at your beck.  You understand the Rune, identify the spell, and may cast it.  Life is good when things turn out like this.",
absolutesuccess : "You are a master of the written arts.  Ass Success, but you also notice any unsual features of the Rune (or the material it is inscribed on), if any.  You will become legendary, as songs are sung of your legendary abilities!",
},
  gymnastic: { 
absolutefailure : "In your zeal, you have forgotten to warm up, severly pull a major muscle (-25), and are stunned for two rounds.  Good job buddy!",
failure : "You freeze at a critical moment failing your maneuver.  If appropriate, you ma make an additional roll to abort your maneuver.  Otherwise, take your chances.",
unusualevent : "Regardless of your success or failure, you manage to make yourself look completely foolish.  If no one was watching, you're lucky.  Otherwise you will never hear the end of the jokes and stories about it.  Surely there's some way to make up for it, or make everyone forget.",
partialsuccess : "Everything was going so well, but you cannot seem to follow through, and it takes longer.  If appropriate make an additional maneuver at +10.  Otherwise you fail.",
success : "Fancy footwork, my friend!  You complete the maneuver completely as expected and in fine form, and barely break a sweat.  Must be the shoes.",
absolutesuccess : "You skip a light fandango, turn cartwheels 'cross the floor and complete the maneuver with the kind of precision and grace you have always dreaed about.  Onlookers gawk and you make the impossible look easy.",
	},
  lore	: {
absolutefailure : "What's all this?  You irretrievably confule yourself and cannot possibly recall this information without at least 12 hours to refamiliarize yourself with the topic.",
failure : "Hmm, nope.  Nothing springs to mind.  Perhaps if you were to spend another six hours studying the matter…",
unusualevent : "Great Horny Toads!  You've been using that work for years and suddenly realized you were pronouncing it completely wrong!  You whoop and gurgle happily, rolling your mouth around the new sound...why is everyone staring at you?",
partialsuccess : "You recall some details of the subject but nothing specific.  Stew on this for an hour or so and something might come to you.  (roll again in 1 hour)",
success : "Ah, of course!  A simple fact, of course, right on the tip of your tongue.  You recall all the relevant details about the subject.",
absolutesuccess : "With a nonchalant air, you relate the details of the topic from memory, including relevant quotations and analysis by authorities on the subject.  Now who's the savant around here?",
},
  medical : {
absolutefailure : "The herb is not only ruined, it has become slightly toxic.  If treating a patient, you manage to make things worse, increasing any injury penalty by -10.",
failure : "The herb or poison and your pride are ruined.  If treating a patient, the recovery roll is made at -100 (as if they received no care).",
unusualevent : "Your preperation of the herb or poison has altered its properties in a way that may be useful (on a Success) or not (on a Failure).  If treating a patient, in addition to success or failure treating the condition, you've improved or worsened tha different condition by +/-10.",
partialsuccess : "The herb or poison  is half as potent.  If treating a patient, your misguided care provides minimal improvement.  The Recovery roll is made at a modified -25.",
success : "The herb or poison is ready!  If treating a patient, you are alert enough to catch problems as they arise and they should recover normally (+0 recovery roll).",
absolutesuccess : "The herb or poison has doubled potency.  If treating a patient, you know exactly what to do and they respond miraculously to your care (add +25 to the recovery roll).",
},
 mentaldiscipline : {
absolutefailure : "You are assailed by doubts and distractions.  Your feeble attempt at focus creates a mental block that hinders your future attempts giving you a -25 to this skill until an Absolute Success is achieved.",
failure : "You call forth your discipline and…  what was that noise?  Sorry, trying to focus here.  Why won't that itch go away?  Your effort is insufficient to get past the distractions.",
unusualevent : "Carefully you follow the path of thought before realizing it is seemingly unrelated to your task.  If you succeed at your maneuver, the unexpected insite is treated as an Absolute Success.  If you fail, it has led you far astray to an Absolute Failure.",
partialsuccess : "Your discipline is assailed by distractions and you find it difficult to focus.  You receive half the usual benefit or may try again next round with a +10 modification.",
success : "Summoning all your training, you concentrate on your breathing and empty your mind permitting yourself to focus completely on the task at hand.",
absolutesuccess : "You slip easily into a state of perfect focus, easily putting aside all distractions and doubts.  You receive 2x normal benefits and +10 on subsequent rolls to maintain this state.",
	},
      performanceart : {
absolutefailure : "Horrors!  In what is most certainly the worst performance of your career, you manage to offend everyone in your audience giving you -25 to this skill until an Absolute Success is achieved.",
failure : "A lackluster performance leaves your audience yawning.  The snores drown out the feeble applause.  Maybe you should join the circus.",
unusualevent : "Unbeknownst to you, two rival factions were in the audience and you have given offense to one of them.  You find yourself embroiled in their raging dispute overshadowing how your performance actually was.  Some days it just doesn't pay to get out of bed.",
partialsuccess : "Not bad.  Not good but not bad.  You hold the attention of the audience but a few key blunders spoil an otherwise satisfactory performance.",
success : "Bravo!  Your performance is a success and the enthusiastic response of your audience warms your old performer's heart.",
absolutesuccess : "You have surpassed yourself and your audience mobs you for autographs, bits of string from your outfit, and kisses.  What will you do for an encore?  It is best not to keep your audience waitin.",
},
	
powerprojection : {
absolutefailure : "Your reach has exceeded your grasp.  Treat as a Failure and additionally roll  on the Spell Failure table Force column and add the number of hits taken.",
failure : "You have lost this projection which bruises your body as well as your ego.  Take Hits equal to both sides' PP total in the projection.",
unusualevent : "Your projection inadvertently causes a magical vacuum which flares up briefly and sucks additional power form both participants.  Each participant must immediately expend another 1 PP which is added to the projection pool.",
partialsuccess : "You almost lose hold of your projection but may recover if you immediately add an additional PP this round.",
success : "Only a slight squint of concentration betrays the effort involved in keeping up the projection and you keep control this round.",
absolutesuccess : "The ease with which you control the projection surprises even you.  You do not need to contribute any PP the following round in order to continue.  Are you wearing a pointy hat?",
},
science	: {
absolutefailure : "Pitiful.  You not only fail to produce accurate results, you produce wrong results.  You cannot discover where you made your mistake and get  -25 to this skill until an Absolute Success is achieved.",
failure : "You fail to grasp the problem and any time you have spent is waisted.  You may not attempt again until you have reflected on this and 24 hours has passed.",
unusualevent : "Good heavens!  In the course of your analysis you have stumbled across a hitherto unrealized theorem!  Abandoning your current task for several minutes you follow this line of reasoning instead of your original task. The world must be told of your revelation.",
partialsuccess : "Persistence yields results.  So persis.  You may try the maneuver again (requirign the normal time) and get +10 to the roll.",
success : "You have blinded them with science!  You have arrived at what you are sure is the right answer.  No, it's right.  Almost certainly right.",
absolutesuccess : "Brilliant!  Your seldom-appreciated genius rises to heretofore unforseen levels.  In half the time normally required, you manage to hold a command of the material that gives you +10 on your next analysis.",
	
	},
influence : {
absolutefailure : "Your clumsy attempts at manipulation are transparent to all, including the target who reacts accordingly.  Future attempts to influence this target automatically fail until an Absolute Success is achieved.",
failure : "You fail to influence your target in the least.  Your target may make a social Awareness maneuver to notice your attempt.",
unusualevent : "Your slick manner and glib tongue are utterly fascinating to your target.  With Success, he will become your biggest fan to the point of annoyance.  With Failure, he names you his arch-nemesis.  Either way, you will really need to get rid of this person.",
partialsuccess : "You were doing great until you got impatient.  You cut to the chase too soon and your target is wary.  If appropriate, roll again next round with a -10.",
success : "Oh ye of the silver tongue.  You smooth-talk your target into tractability and get the desired result.",
absolutesuccess : "You must have been an incubus in a former life.  In any case, you have your target wrapped around your little finger and receive +30 to any future Influence attempts versus this target (until an Absolute Failure is achieved).",
	},
technical : {
absolutefailure : "You manage to ruin a tool of your trade through carelessness and frustration, and get -25 to all future uses of this skill until an absolute Success is achieved.  Is this your idea of fun?",
failure : "Your attempt fails utterly and your are dejected.  If this is a trap, there is a 20% chance it will activate affecting you.  You may not try this problem again for 24 hours.",
unusualevent : "As you are working on it, the mechanism activates but incompletely.  You have both hands occupied in the mechanism and if you let go with either hand, it will activate or otherwise damage you.  Hopefully you brought a friend…",
partialsuccess : "Unusual complications haeve arisen.  Nothing you can't handle but it's going to take you some extra time.  You may attempt to finish your work at -10.",
success : "You perform the task with admirable skill.  Now quit patting yourself on the back and get back to work.",
absolutesuccess : "Your subtle technical mastery is reflecting in your remarkable success.  You may perform this specific maneuver at +20 (not cumulative) until you receive an Absolute Failure.",

}
};


function lookupSkillResult(skill, skillinfo, umroll, total) {
  let result = "";
  let description = "";
  let category = 'general'; // Defaults to the general

  if (skillrollresults[skill]) {
    category = skill;  // Done; great;
  } else {
    // Try a few things to get the skill info
    if (!skillinfo) { skillinfo = RMUSkills.getSkillByName(skill); }
    if (!skillinfo) { skillinfo = RMUSkills.getSkillByDisplayName(skill); }
    if (!skillinfo && skill.includes(":")) {
      skillinfo = RMUSkills.getSkillByDisplayName(skill.substring(0, skill.indexOf(":")));
    }
    if (skillinfo) {
      if (skillinfo.specializationof && skillrollresults[skillinfo.specializationof]) {
	category = skillinfo.specializationof;
      } else if (skillrollresults[skillinfo.category]) {
	category = skillinfo.category;
      }
    }
  }

  if (umroll == 66) {
    result = 'Unusual Event - ';
    description = skillrollresults[category].unusualevent + " ";
  } 
  if (total < 1) {
    result += 'Absolute Failure';
    description += skillrollresults[category].absolutefailure;
  } else if (total < 76) {
    result += "Failure";
    description += skillrollresults[category].failure;
  } else if (total < 101) {
    result += 'Partial Success';
    description += skillrollresults[category].partialsuccess;
  } else if (total < 176) {
    result += "Success";
    description += skillrollresults[category].success;
  } else {
    result += "Absolute Success";
    description += skillrollresults[category].absolutesuccess;
  }
  return { result : result, description: description};
  }





(function() {
    // Persistent cache of stat values.
    var statCache_ = {}
    // FIXME: Pull these from the array
    // FIXME: Move to RMU stats
    // Useful for getting all stats at once.
    const statnames = ["ag", "co", "em", "in", "me", "pr", "qu", "re", "sd", "st"];
    const statfullnames = ["agility", "constitution", "empathy", "intuition", "memory", "presence",
	"quickness", "reasoning", "selfdiscipline", "strength"];
    const statfullnamesmisc = statfullnames.map(name => name + "_misc");
    const statnamesmisc = statnames.map(name => name + "_misc");
    // How to indent the rank bonuses
    const rankIndent = '     ';
    RMUSkills.statnames = statnames;
    RMUSkills.statfullnames = statfullnames;


    let getSkillByDisplayNameCache_ = false;
    let getSkillByAnameCache_ = false;

    function buildSkillCaches(cats) {
      let cache = {};
      let anamecache = {}
      for (let c = 0; c < cats.length ; c ++){
	for (let s = 0 ; s < cats[c].skills.length ; s ++){
	  let tr = getTranslationByKey(cats[c].skills[s].aname);
	  cache[tr] = cats[c].skills[s];
	  cache[cats[c].skills[s].aname] = cats[c].skills[s];
	  anamecache[cats[c].skills[s].aname] = cats[c].skills[s];
	  if (cats[c].skills[s].specializations) {
	    const spz = cats[c].skills[s].specializations;
	    for (let z = 0; z < spz.length  ; z ++) {
	      let trz = getTranslationByKey(spz[z].aname);
	      let trzk = `${tr}: ${trz}`;
	      let trzk2 = `${tr}:${trz}`;
	      cache[trzk] = spz[z];
	      cache[trzk2] = spz[z];
	      cache[spz[z].aname] = spz[z];
	      anamecache[spz[z].aname] = spz[z];
	    }
	  }
	}
      }
      getSkillByDisplayNameCache_ = cache;
      getSkillByAnameCache_ = anamecache;
    }

    /**
     * Gets a skill by it's translated display names.
     * The first time this is called in a session it builds an
     * index table to make future lookups a lot faster.
     */
    function getSkillByDisplayName(skillname) {
      if (!getSkillByDisplayNameCache_) {
	buildSkillCaches(categories);
      }
      return getSkillByDisplayNameCache_[skillname]
    }
    RMUSkills.getSkillByDisplayName = getSkillByDisplayName;

    /** Gets a skill by it's aname
     */
    function getSkillByName(skillaname) {
      if (!getSkillByAnameCache_) {
	buildSkillCaches(categories);
      }
      return getSkillByAnameCache_[skillaname]
    }
    RMUSkills.getSkillByName = getSkillByName;

    /**
     * Gets a category by it's translated display names.
     * The first time this is called in a session it builds an
     * index table to make future lookups a lot faster.
     */
    let getCatByDisplayNameCache_ = false;
    function getCatByDisplayName(skillname) {
      if (!getCatByDisplayNameCache_) {
	let cache = {};
	for (let c = 0; c < categories.length ; c ++){
	  let tr = categories[c].display;
	  cache[tr] = categories[c]
	}
	getCatByDisplayNameCache_ = cache;
      }
      return getCatByDisplayNameCache_[skillname]
    }
    RMUSkills.getCatByDisplayName = getCatByDisplayName;

    let getCatByDisplayNameCacheNoTrans_ = false;
    function getCatByDisplayNameNoTrans(skillname) {
      if (!getCatByDisplayNameCacheNoTrans_) {
	let cache = {};
	for (const c of categories) {
	  cache[c.display] = c
	}
	getCatByDisplayNameCacheNoTrans_ = cache;
      }
      return getCatByDisplayNameCacheNoTrans_[skillname]
    }
    RMUSkills.getCatByDisplayNameNoTrans = getCatByDisplayNameNoTrans;

    const rankbonustable = [
      /*     0 */ -25,
      /*  1-10 */   5,  10, 15, 20, 25, 30, 35, 40, 45, 50,
      /* 11-20 */  53, 56, 59, 62, 65, 68, 71, 74, 77, 80,
      /* 21-30 */  82, 84, 86, 88, 90, 92, 94, 96, 98, 100,
    ]

    function rmuGetSkillBonus(ranks, expertise = false) {
      let bonus = -25;
      if (expertise) {
	bonus = 0;
      }
      if (ranks == 0) return bonus;
      if (ranks < 30) {
	bonus = rankbonustable[ranks];
      } else {
	bonus = 100 + ranks - 30;
      }
      return bonus;
    }
    RMUSkills.getSkillBonus = rmuGetSkillBonus;

    function updateStatCache(donefn) {
      getAttrsPending(statnames, (res) => {
	statnames.forEach((st) => {
	  statCache_[st] = parseInt(res[st]) || 0;
	});
	getAttrsPending(["realm"], realm => {
	  let rtemp = "unknown";
	  if (realm.realm){
	    rtemp = realm.realm.toLowerCase();
	  } else {
	    rmuerror("No realm in update Stat cache.");
	  }
	  if (rtemp == 'essence') {
	    statCache_.rs = statCache_.em;
	  } else if (rtemp == 'channeling') {
	    statCache_.rs = statCache_.in;
	  } else if (rtemp == 'mentalism') {
	    statCache_.rs = statCache_.pr;
	  } else if (rtemp == 'essence/mentalism') {
	    statCache_.rs = Math.min(statCache_.em, statCache_.pr);
	  } else if (rtemp == 'channeling/mentalism') {
	    statCache_.rs = Math.min(statCache_.in, statCache_.pr);
	  } else if (rtemp == 'channeling/essence') {
	    statCache_.rs = Math.min(statCache_.in, statCache_.em);
	  } else if (rtemp == 'arcane') {
	    statCache_.rs = Math.min(statCache_.em, statCache_.in, statCache_.pr);
	  } else {
	    console.log("No realm found", rtemp, realm);
	    statCache_.rs = statCache_.em;
	  }
	  console.log(statCache_);
	  // FIXME: Should make this prettier
	  miscAttrSet("scr_misc", "Realm Stat", statCache_.rs);
	  if (donefn && typeof(donefn) === 'function') {
	    donefn();
	  }
	});
      });
      addPendingFunction("Update stats from stat cache", RMUStats.updateStats);
      checkPending();
    }
    RMUSkills.updateStatCache = updateStatCache;

    RMUSkills.getStat = function(name) {
      return  statCache_[name]
    }

    on("clicked:updateskills", function(){
	updateAllSkills();
    });


    // Handler for updating a single stat
    // So when a 'strength' changes, update the bonus
    onCheck(statfullnames.map(stat => "change:" + stat).join(" "), (ev) => {
	const val = parseInt(ev.newValue) || 0;
	const stat = getStatFromAName(ev.triggerName);
	let logmessage = stat.display + ":\n";
	logmessage += "  Temporary value: " + val + "\n";
	let update = {}
	let statBonus = RMUStats.getStatBonus(val);
	logmessage += "  Stat Bonus: " + val + "\n";
	update[stat.abbr] = statBonus;
	logmessage += "Total Bonus: " + statBonus;
	update[stat.aname + "_info"] = logmessage;
	// Update local cache
	statCache_[stat.abbr] = statBonus;
	//setAttrs(update);
    });

    function updateAllSkills() {
      updateStatCache(() => {
	  /* Get the stat bonuses */
	  categories.forEach((cat) => { updateCategory(cat, statCache_)});
	  let gracebonus = {};
	  let trickerybonus = {};
	  addPendingFunction("Update Grace & Trickery", () => prepareGraceTrickery(gracebonus, trickerybonus));
	  addPendingFunction("Update Spells", () => {
	    updateSpells(gracebonus, trickerybonus)
	  });
	  addPendingFunction("Update favorites", RMUSkills.updateFavorites);
	});
    }
    RMUSkills.updateAllSkills = updateAllSkills;

    function updateCategory(cat, stats) {
      let bonus = 0;
      let log = "";
      if (cat.stats) {
	bonus = stats[cat.stats[0]] + stats[cat.stats[1]];
	log += `${bonus} Category Bonus\n`;
	let statname1 = getStatNameFromAbbr(cat.stats[0]);
	log += `${rankIndent}${stats[cat.stats[0]]} ${statname1}\n`;
	let statname2 = getStatNameFromAbbr(cat.stats[1]);
	log += `${rankIndent}${stats[cat.stats[1]]} ${statname2}\n`;
      }
      if (cat.skills) {
	cat.skills.forEach((skill) => { updateSkill(skill, bonus, log) })
      }
    }

    RMUSkills.updateSingleCategory = function(catname) {
      const cat = getCatByDisplayName(catname)
      if (!cat) {
	rmuerror("Unable to find category", catname);
	return;
      }
      updateCategory(cat, statCache_);
    }

    // Returns an object
    //    rankbonus: Rank bonus
    //    ranks: Number of ranks
    //	  log: string to append to log
    //    specializationbonus:
    //	  specializationranks: (Effective specialisation ranks)
    function getSkillRanksBonus(ranksMisc, pbonus, isExpertise) {
      const rv = {}

      // So we need to know if there is a specialisation.
      const hasSpecialization = miscMessagePrefix(ranksMisc, "Specialization:")

      // If there is, we need to subtrack one rank from the normal
      // ranks when calculating and then multiply that by 50.
      let [ranks, rlog] = miscBonusTotal(ranksMisc, rankIndent);
      let sstring = "";
      if (hasSpecialization) {
	ranks --;
	sstring = " - Specialized"
      }
      const rankbonus = rmuGetSkillBonus(ranks, isExpertise);
      let bonus = rankbonus;
      let log = `${F(bonus)} Rank bonus (${ranks} Ranks${sstring})\n`
      log += rlog;

      if (pbonus > 0) {
	const effectiveranks = (ranks > 30) ? 30 : ranks;
	const pbonusbonus = effectiveranks * pbonus;
	bonus += pbonusbonus;
	if (pbonus == 1) {
	  log += `${effectiveranks} proficiency bonus\n`;
	} else {
	  log += `${effectiveranks * pbonus} proficiency bonus (${effectiveranks} ranks * ${pbonus})\n`;
	}
      }
      rv.ranks = ranks;
      rv.rankbonus = bonus;

      if (hasSpecialization) {
	let specranks = Math.round(ranks * 1.5);
	const specrankbonus = rmuGetSkillBonus(specranks, isExpertise);
	let specbonus = specrankbonus;
	log = `${F(specbonus)} Specialised bonus (${specranks})\n`
	if (pbonus > 0) {
	  const effectiveranks = (specranks > 30) ? 30 : specranks;
	  const pbonusbonus = effectiveranks * pbonus;
	  specbonus += pbonusbonus;
	  if (pbonus == 1) {
	    log += `${effectiveranks} proficiency bonus\n`;
	  } else {
	    log += `${effectiveranks * pbonus} proficiency bonus (${effectiveranks} ranks * ${pbonus})\n`;
	  }
	}

	rv.specializedranks = specranks;
	rv.specializedbonus = specbonus;
      }


      rv.log = log;
      return rv;
    }
    RMUSkills.getSkillRanksBonus = getSkillRanksBonus;

    function updateSkill(skill, catbonus, catlog) {
      const aname = skill.aname;
      getAttrs([aname + "_ranks_misc", aname + "_pbonus", aname + "_misc", aname + "_ranks"], (attrs) => {
	updates = {};
	let bonus = 0;
	let log = skill.display + ":\n";

	bonus += catbonus;
	log += catlog;

	if (skill.stat) {
	  bonus += statCache_[skill.stat];
	  let statname = getStatNameFromAbbr(skill.stat);
	  log += `${statCache_[skill.stat]} ${statname}\n`;
	}

	// Get misc bonuses
	let [miscbonus, mlog] = miscBonusTotal(attrs[aname + "_misc"]);
	bonus += miscbonus;
	log += mlog;

	// Get pbonus
	const pbonus = parseIntDefault(attrs[aname + "_pbonus"], 0);

	// So now we need to look at specializations
	if (skill.specializations) {
	  addPendingFunction("Update specialisations", () => { updateSpecializations(skill, pbonus, bonus, log); });
	} else if (skill.dynamicspecializations) {
	  addPendingFunction("Update Dynamic", () => { updateDynamicSpecializations(skill, pbonus, bonus, log); });
	} else {
	  const bonuses = RMUSkills.getSkillRanksBonus(attrs[aname + '_ranks_misc'],
		      pbonus, skill.expertise || false);
	  log += bonuses.log;

	  if (bonuses.ranks != 0) {
	    updates[aname + "_ranks"] = bonuses.ranks;
	  } else if (attrs[aname + "_ranks"] && attrs[name + "_ranks"] != "")  {
	    updates[aname + "_ranks"] = " "; // So there is something there; so set space
	  }
	  updates[aname + "_bonus"] = bonus +  bonuses.rankbonus;
	}
	// Always update the info field.
	updates[aname + "_info"] = log;

	setAttrs(updates);
      });
    }
    RMUSkills.testUpdateSkill = updateSkill;

    // Calculate the bonus for a specialized skill.
    /// Returns [bonus, ranks, log]
    function calculateSpecBonus(skill, rankmisc, skillmisc, stat, pbonus, catbonus, log) {
      let slog = log;
      const [ranks, rlog] = miscBonusTotal(rankmisc, rankIndent)
      let bonus = catbonus;
      bonus += rmuGetSkillBonus(ranks, skill.expertise);
      slog += `${rmuGetSkillBonus(ranks, skill.expertise)} Rank bonus (${ranks} Ranks)\n`;
      slog += rlog;

      if (stat) {
	bonus += statCache_[stat];
	// FIXME: Use translated name
	slog += `${statCache_[stat]} stat bonus\n`;
      }

      if (pbonus && pbonus > 0) {
	const effectiveranks = (ranks > 30) ? 30 : ranks;
	const pbonusbonus = effectiveranks * pbonus;
	bonus += pbonusbonus;
	if (pbonus == 1) {
	  slog += `${effectiveranks} proficiency bonus\n`;
	} else {
	  slog += `${effectiveranks * pbonus} proficiency bonus (${effectiveranks} ranks * ${pbonus})\n`;
	}
      }

      let [miscbonus, mlog] = miscBonusTotal(skillmisc);
      bonus += miscbonus;
      slog += mlog;

      return [bonus, ranks, slog];
    }

    // My best bonus updates are little different.
    // FIXME: This is the thing that generates all the errors.
    function updateSpecializations(skill, pbonus, catbonus, log) {
      let bestbonus = -200; // Assume no one can get worse than this
      let bestranks = 0;
      skill.specializations.forEach((spec) => {
	  const aname = spec.aname;
	  // FIXME: This could be optimised to do in one call for all skills
	  addPendingFunction("Skill Specialisation: " + skill.aname, () => {
	    getAttrsPending([aname + "_ranks_misc", aname + "_misc", aname + "_ranks", "spcials"], (attrs) => {
		let [bonus, ranks, slog] = calculateSpecBonus(skill, attrs[aname + '_ranks_misc'],
		  attrs[aname + '_misc'], spec.stat, pbonus, catbonus, log);
		let update = {[aname + "_bonus"]: bonus, [aname + "_info"]: slog};
		if (ranks != 0) {
		  update[aname + "_ranks"] = ranks;
		} else if (attrs[aname + "_ranks"] && attrs[name + "_ranks"] != "")  {
		  update[aname + "_ranks"] = " "; // So there is something there; we set space
		}
		if (ranks == 0 && bonus > bestbonus) {
		  bestbonus = bonus;
		} else if ((bonus - 25) > bestbonus) {
		  bestbonus = bonus - 25;
		}
		setAttrsPending(update);
	    });
	  });
      });
      addPendingFunction("Specialisation Similar skill for " + skill.aname, () => {
	  if (bestbonus > -200) {
-           setAttrs({[skill.aname + '_bonus']: bestbonus});
	  }
      });
    }

    // Updates the specialiszation, and calculates the bonus for the unspecialised skill.
    // I assume all skills in a catefory are similar, so you get -25 off the
    // best one, or just the unspoecilased skill otherwise
    // eg  Riding:Llama 34, Riding:Horse 22 -> Riding 11 (=34-25).
    // eg2 No skill just gives rank bonus:  -25
    // FIXME: this call could be done in one async call.
    //  Get everything then just loop throush, then the set.
    function updateDynamicSpecializations(skill, pbonus, catbonus, log) {
      let bestbonus = catbonus;
      let bestlog = ""
      addPendingFunction(`Update Specialisation for ${skill.display}`, () => {
	  let largest = 0;
	  let name = "No skill";

	  bestbonus -= 25;
	  setAttrsPending({[`${skill.aname}_bonus`]: bestbonus})
      });

      getSectionIDsPending(`repeating_specialization${skill.aname}`,
        (idarray) => {
            for (const id of idarray) {
                const basename = `repeating_specialization${skill.aname}_${id}`
                let toget = []
                toget.push(basename + "_ranks_misc");
                toget.push(basename + "_misc");
                toget.push(basename + "_ranks");
                getAttrsPending(toget,
                    (attrs) => {
                        let [bonus, ranks, slog] = calculateSpecBonus(skill,
                                attrs[basename + '_ranks_misc'],
                                attrs[basename + '_misc'], false, pbonus, catbonus, log);
			if (bonus > bestbonus) {
			  bestbonus = bonus;
			  bestlog = slog;
			}

                        let update = {[basename + "_bonus"]: bonus, [basename + "_info"]: slog};
			if (ranks != 0) {
			  update[basename + "_ranks"] = ranks;
			} else if (attrs[basename + "_ranks"] && attrs[basename + "_ranks"] != "")  {
			  update[basename + "_ranks"] = " "; // So there is something there; so set space
			}
                        setAttrsPending(update);
                });
            }
    });
}




    function getDefaultSpecializationName(skillname, index) {
      let skill = getSkillByName(skillname);
      if (!skill) return 'Default Name';
      if (!skill.dynamicspecializations) return 'Default Name';
      return skill.dynamicspecializations + ' ' + String.fromCharCode(65 + index);
    }

    on('clicked:specializationsave', ev => {
      getAttrs(['specialization_change_aname', 'specialization_change_index',
	       'specialization_change_name'], data => {
	let key = data['specialization_change_aname'] + 'specialization' +
	data['specialization_change_index'] + '_name';
	setAttrs({ [key] : data.specialization_change_name, 'toggleskillchange': 'false' });
      });
    })
    on('clicked:specializationcancel', ev => {
      setAttrs({'toggleskillchange': 'false' });
    });



  // Called once for each skill and specialization.
  // Not called for skills with specializations.
  // Each is called with skill structure and then the category
  // If the skill is a specialisation, a third argument is present - the
  // actual 'skill'
  function forEachSkill(func, donefn) {
    let catcount = categories.length

    categories.forEach(cat => {
	catForEachSkill(cat, func, () => {
	  catcount --;
	  if (catcount == 0) {
	    if (donefn && typeof(donefn) == "function") {
	      donefn();
	    }
	  }
	});
    });
  }
  RMUSkills.forEachSkill = forEachSkill;
  function catForEachSkill(cat, func, donefn) {
    let outstanding = 1;
    cat.skills.forEach(skill => {
        if (skill.specializations) {
            skill.specializations.forEach(
                subskill => {
                    func(subskill, cat, skill);
                }
            );
	} else if (skill.dynamicspecializations) {
	    outstanding ++;
            getSectionIDs(`repeating_specialization${skill.aname}`,
                idarray => {
                    for (const id of idarray) {
                        // Create a fake skill
                        let subskill = { aname: `repeating_specialization${skill.aname}_${id}` };
                        func(subskill, cat, skill)
                    }
		    outstanding --;
		    if (outstanding == 0 && donefn) {
		      donefn();
		    }
                }
	      );
	} else {
            // Normal skill - the non special case ;-)
            func(skill, cat);
	}
    });
    outstanding --;
    if (outstanding == 0 && donefn) {
      donefn();
    }
  }

  RMUSkills.catForEachSkill = catForEachSkill;


})();



onCheck('change:repeating_favorite:favskill', (ev) => {
    const basename = ev.sourceAttribute.replace("_favskill","");
    RMUSkills.updateFavoriteSkill(ev.newValue, basename);
});

RMUSkills.updateFavoriteSKillsDefault = function(attrname) {
      setAttrs({[`${attrname}_ranks`]: '?', [`${attrname}_bonus`]: '?'});
      return;

}

RMUSkills.updateFavoriteSkillSpecialisation = function(skillname, attrname) {
  const splitindex = skillname.search(/:/);
  if (splitindex == -1) {
    return RMUSkills.updateFavoriteSKillsDefault(attrname);
  }
  const specskill = skillname.substring(0, splitindex);
  const specialisation = skillname.substring(splitindex + 1).trim();
  const skill =  RMUSkills.getSkillByDisplayName(specskill);
  if (!skill) {
    console.log("Can't find skill", specskill)
    return RMUSkills.updateFavoriteSKillsDefault(attrname);
  }
  if (!skill.dynamicspecializations) {
    console.log("Not a dynamic skill... giveup");
    return RMUSkills.updateFavoriteSKillsDefault(attrname);
  }
  const prefix = `repeating_specialization${skill.aname}`;
  getSectionIDs(prefix, (idarray) => {
      let toget = [];
      for (const id of idarray) {
	  toget.push(`${prefix}_${id}_ranks`);
	  toget.push(`${prefix}_${id}_bonus`);
	  toget.push(`${prefix}_${id}_name`);
      }
      getAttrs(toget, (skills) => {
	for (const id of idarray) {
	  const name = skills[`${prefix}_${id}_name`] || "";
	  const ntrim = name.trim();
	  if (ntrim === specialisation) {
	    setAttrs({
		  [`${attrname}_ranks`]: skills[`${prefix}_${id}_ranks`] || '-',
		  [`${attrname}_bonus`]: skills[`${prefix}_${id}_bonus`]});
	    return; // Done
	  }
	}
      });
  });
}

RMUSkills.startSkillRoll = function(prefix, usemod = false) {
  getAttrs([
	  prefix + '_name', prefix + '_favskill', prefix + '_bonus',
	  'character_name', 'statuspenalty',
	  'statuseffect'],
      (cdata) => {
	    const simplified = {};
	    simplified.aname = prefix;
	    for (let key of Object.keys(cdata)) {
		const nk = key.replace(prefix + '_', '')
		if (nk == 'favskill') {
		  simplified.name = cdata[key];
		} else {
		  simplified[nk] = cdata[key];
		}
	    }
	    if (!simplified.name) {
	      // Look it up by aname -> use the prefix
	      const skill = RMUSkills.getSkillByName(prefix);
	      if (skill) {
		simplified.name = skill.fulldisplay ? skill.fulldisplay : skill.display;
		cdata.skillinfo = skill;
	      }
	    }
	    if (!simplified.name) {
	      rmuerror(`Could not get skill name for ${prefix}`);
	      simplified.name = "Skill";
	    }
	    // So now we have name & bonus
	    RMUSkills.handleSkillRoll(simplified, usemod)
  });

  // Used the skill!
  RMUSkills.uses(prefix);
}


RMUSkills.handleSkillRoll = function(cdata, usemod) {
  if (cdata.statuseffect && cdata.statuseffect == 'staggered') {
    sendMessage(`${cdata.character_name} is staggered, cannot act`);
    return;
  }

  let mod = parseIntDefault(cdata.bonus, 0);
  // Always add / show skill bonus
  let mlog = `${mod}&nbsp;[Skill&nbsp;Bonus]`

  {
    const manp = parseIntDefault(cdata.statuspenalty, 0);
    if (manp < 0) {
      mlog += ` ${manp}&nbsp;[Status&nbsp;Penalty]`;
      mod += manp;
    }
  }
  {
    const spen = parseIntDefault(cdata.statuseffect, 0);
    if (spen < 0) {
      mlog += ` ${spen}&nbsp;[Stun]`;
      mod += spen;
    }
  }

  let additionalmodstr = "";
  if (usemod) {
    additionalmodstr = "[[ ?{Modifier|0} ]] {\{modifier=$[[2]]}} "
  }

  startRoll("@{whispertype} &{template:rmuskill} [[ 1d100!>96 ]] [[ 1d100!>96 ]] " +
	  additionalmodstr +
	  "{\{roll=$[[0]]}} " +
	  "{\{oeroll=$[[1]]}} " +
	  "{\{pmod=$[[2]]}} " +
	  "{\{who=[[0]]}} " +
	  "{\{rollstr=[[0]]}} " +
	  `{\{mod=[[0]]}} ` +
	  "{\{modlog=[[0]]}} " +
	  "{\{total=[[0]]}} " +
	  "{\{success=[[0]]}} " +
	  "{\{result=[[0]]}} " +
	  "{\{hasextra=[[0]]}} " +
	  "{\{extratext=[[0]]}} " +
	  "{\{description=[[0]]}} " +
	  "{\{skill=[[0]]}} ",
      (roll) => {
	let mainroll = roll.results.roll.result;
	let mainrollstr = roll.results.roll.dice.join(' + ');
	if (mainroll > 95) {
	  // Was OEH
	  mainrollstr += ' [OEH Roll]';
	} else if (mainroll < 6) {
	  mainroll -= roll.results.oeroll.result
	  mainrollstr += ' - (' + roll.results.oeroll.dice.join(' + ') + ')';
	  mainrollstr += ' [OEL Roll]';
	} else {
	  mainrollstr += ' [Roll]';
	}

	if (usemod) {
	  let pmod = parseIntDefault(roll.results.pmod.result, 0);
	  mod += pmod;
	  // Replace the first ] (after skill bonus) with this string.
	  let plus = pmod < 0 ? '' : '+';
	  mlog = mlog.replace(']', `] ${plus}${pmod}&nbsp;[Other&nbsp;Modifier]`);
	}

	let total = mainroll + mod;

	let lookupname = cdata.aname;
	if (cdata.aname.startsWith('repeating')) {
	  // Probably creature
	  lookupname = cdata.name;
	}
	let {result, description} = lookupSkillResult(lookupname, cdata.skillinfo, mainroll, total);

	let hasextra = 0;
	let extratext = '';
	if (mainroll == 33 || mainroll == 77) {
	  hasextra = 1;
	  extratext = `UM${mainroll}: Check for breakage`;
	}

	finishRoll(roll.rollId, {
	      who: cdata.character_name,
	      skill: cdata.name,
	      rollstr: mainrollstr,
	      mod: mod,
	      modlog: mlog,
	      total: total,
	      result: result,
	      description: description,
	      hasextra: hasextra,
	      extratext: extratext
	});


  });

}

onCheck("clicked:rollskilldirect", (ev) => {
  const basename = ev.htmlAttributes['data-skill'];
  RMUSkills.startSkillRoll(basename);
});

onCheck("clicked:rollskilldirectmod", (ev) => {
  const basename = ev.htmlAttributes['data-skill'];
  RMUSkills.startSkillRoll(basename, true);
});

onCheck("clicked:repeating_favorite:rollskilldirect", (ev) => {
    const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
    RMUSkills.startSkillRoll(basename);
});

onCheck("clicked:repeating_favorite:rollskillmod", (ev) => {
    const basename = ev.sourceAttribute.replace(/_rollskillmod\d*$/, "");
    RMUSkills.startSkillRoll(basename, true);
});

 onCheck(`clicked:repeating_specializationanimalhandling:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationanimalhandling:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationriding:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationriding:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationbattlestyle:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationbattlestyle:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationdisciplinestyle:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationdisciplinestyle:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationcombatstyle:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationcombatstyle:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationpiloting:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationpiloting:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationhistoriclore:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationhistoriclore:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationlanguage:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationlanguage:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationraciallore:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationraciallore:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationregionlore:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationregionlore:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationreligionphilosophy:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationreligionphilosophy:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationgrace:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationgrace:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationspelltrickery:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationspelltrickery:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationmusic:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationmusic:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationadministration:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationadministration:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationservice:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationservice:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    }); onCheck(`clicked:repeating_specializationtrade:rollskilldirect`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename);
    });
    onCheck(`clicked:repeating_specializationtrade:rollskilldirectmod`, (ev) => {
      const basename = ev.sourceAttribute.replace(/_rollskilldirect\d*$/, "");
      RMUSkills.startSkillRoll(basename, true);
    });

RMUSkills.updateFavoriteSkill = function(skillname, basename) {
    const skill = RMUSkills.getSkillByDisplayName(skillname);
    if (!skill) {
      return RMUSkills.updateFavoriteSkillSpecialisation(skillname, basename);
    }
    let toget = [`${skill.aname}_ranks`, `${skill.aname}_bonus`];
    getAttrs(toget, (attrs) => {
	setAttrs({
	    [`${basename}_ranks`]: attrs[`${skill.aname}_ranks`] || '-',
	    [`${basename}_bonus`]: attrs[`${skill.aname}_bonus`]});
    });
}

RMUSkills.updateFavorites = function() {
  getSectionIDsPending('repeating_favorite', (ids) => {
      let toget = []
      ids.forEach(id => {
	  toget.push(`repeating_favorite_${id}_favskill`);
      });
      getAttrsPending(toget, (stuff) => {
	  ids.forEach(id => {
	      const skillname = stuff[`repeating_favorite_${id}_favskill`];
	      const basename = `repeating_favorite_${id}`;
	      RMUSkills.updateFavoriteSkill(skillname, basename);
	  });
      });

  });
}

onCheck("clicked:repeating_creatureskill:creatureskillroll", (ev) => {
    const basename = ev.sourceAttribute.replace(/_creatureskillroll$/, "");
    RMUSkills.startSkillRoll(basename, false);
});

onCheck("clicked:repeating_creatureskill:creatureskillrollmod", (ev) => {
    const basename = ev.sourceAttribute.replace(/_creatureskillrollmod$/, "");
    RMUSkills.startSkillRoll(basename, true);
});










/**/

RMUSkills.uses = function(name, specialisation = false) {
  if (!name || typeof(name) != 'string') {
    rmuerror("skills/usBad type of name for uses", name, typeof(name));
    return;
  }
  if (specialisation) return RMUSkills.usesspecialisation(name, specialisation);

  //
  if (name.match(/^[a-z]*$/)) {
    const usename = name + '_usecount';
    const usenameg = name + '_usecounttotal';
    getAttrs([usename, usenameg], (data) => {
	data[usename] = data[usename] ? data[usename] + 1 : 1;
	data[usenameg] = data[usenameg] ? data[usenameg] + 1 : data[usename];
	setAttrs(data);
    });
  }
}


RMUSkills.usesspecialisation = function(name, specialisation) {
  // get the ids
  // get the name and the ids
  // update the count
  getSectionIDs(`repeating_specialization${name}`, (ids) => {
      let toget = []
      ids.forEach(id => {
	toget.push(`repeating_specialization${name}_${id}_name`);
	toget.push(`repeating_specialization${name}_${id}_usecount`);
	toget.push(`repeating_specialization${name}_${id}_usecounttotal`);
      });
      getAttrs(toget, (data) => {
	  for (id of ids) {
	    if (data[`repeating_specialization${name}_${id}_name`] == specialisation) {
	      const usecount = `repeating_specialization${name}_${id}_usecount`;
	      const usecountt = `repeating_specialization${name}_${id}_usecounttotal`;
	      out = {}
	      out[usecount] = data[usecount] ? data[usecount] + 1 : 1;
	      out[usecountt] = data[usecountt] ? data[usecountt] + 1 : out[usecount];
	      setAttrs(out)
	      return;
	    }
	  }
	  // Did not find it; create it
	  const rowid = generateRowID();
	  setAttrs({
	      [`repeating_specialization${name}_${rowid}_name`]: specialisation,
	      [`repeating_specialization${name}_${rowid}_usecount`]: 1,
	      [`repeating_specialization${name}_${rowid}_usecounttotal`]: 1,
	  });

      });
  });
}

/*  */
RMUSkills.usesClear = function() {
  // Clear all the non-specialised ones
  toclear = {}
  RMUSkills.forEachSkill((subskill, cat, skill) => {
      toclear[`${subskill.aname}_usecount`] = 0;
    },
    () => {
      console.log("to clear done", toclear);
      setAttrs(toclear);
    }
  );
}





// listranks is the currently known lists, indexed by list name.  Value is ranks (int)
function _spellDoQuery(prevranks, listtype, filter, subtarget, cost, listranks) {
  const costarray = generateCostArray(cost);

  getCompendiumQueryPending(`Category:SpellList ${listtype}`, (lists) => {
      // So on error we get 1 element and it has an expansion set to 0.
      // That seems the best way to detect and error
      if (!lists || lists[0].expansion == 0) {
	rmuerror("_spellDoQuery: Empty list data", listtype, subtarget);
	return;
      }

      // Looping though the lists we got.
      for (let list of lists) {
	// Filter is currently on ListType - this filtesr out healer/layhealer
	if (filter && filter.length > 0) {
	  if (list.data.ListType == filter) {
	    continue;
	  }
	}

	addRepeatingSection(`cmspelllistspell${subtarget}`, 'spelllist', `${subtarget}spelllist`,
	  (sectionname) => {
	      cmPopulateListOptions(`${sectionname}_cmranks`, costarray,
		  prevranks[list.name] || costarray[0]);
	      setAttrs({[`${sectionname}_listname`]: list.name,
		  [`${sectionname}_listranks`]: listranks[list.name]?.ranks || '-'});
	    });
      }
  });
}


// Base lists are different to other lists.  No matter what we only show 6.
// So do the query to get the base lists.  Then we get the characters selected
// base lists and display that.
function _spellDoBaseListQuery(selectedbase, cost, previousranks) {
  const costarray = generateCostArray(cost);

  if (selectedbase.length == 0) {
    return;
  }

  for (let name in selectedbase) {
    let details = selectedbase[name];
    if (!details.prefix.match(/^repeating_spelllistspellownbase_/)) {
      continue;
    }

    addRepeatingSection("cmspelllistspellownbase", 'spelllist', "ownbasespelllist",
	(sectionname) => {
		cmPopulateListOptions(`${sectionname}_cmranks`, costarray,
		     previousranks[name] || costarray[0]);
		setAttrsPending({[`${sectionname}_listname`]: name,
		    [`${sectionname}_listranks`]: details.ranks || '-'});
    });
  }
}



// Initialise the spell lists in the Charactermancer
// listranks is a dictionary of ranks indexed by the spell list name
function initSpellListsCM(savedlists, profession, realm, costs, listranks) {
  const cmdata = getCharmancerData();
  const lu = cmdata?.levelup;

  // Set the costs cmcategory-spellownbase-cost
  setCharmancerText({
      "cmcategory-spellownbase-cost": costs.Base,
      "cmcategory-spellopen-cost": costs.Open,
      "cmcategory-spellclosed-cost": costs.Closed,
      "cmcategory-spellotherbaseownrealm-cost": costs.Restricted
      });

  console.log("prevous / savedlist", lu, savedlists);
  const previousranks = {};
  if (lu && savedlists && savedlists.length > 0) {
    // So we loop through; get each's visble name and then set the ranks based on that
    savedlists.forEach(listid => {
      const listranks = lu.values[listid + '_cmranks'];
      if (listranks && !listranks.endsWith("0:0")) {
	const listname = lu.values[listid + '_listname'];
	previousranks[listname] = listranks;
      }
    });
  }

  console.log("Pensing for base");
  addPendingFunction("Base lists",()=> {
    _spellDoBaseListQuery(listranks, costs.Base, previousranks);
  });

  if (realm.indexOf('/') > -1) { 
    // Hybrid: Two realms
    realms = realm.split('/');
    addPendingFunction("Hybrid realm 1 open lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realms[0]} Open*`, '', 'open', costs.Open, listranks );
    });
    addPendingFunction("Hybrid realm 2 open lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realms[1]} Open*`, '', 'open', costs.Open, listranks );
    });
    addPendingFunction("Hybrid realm 1 closed lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realms[0]} Closed*`, '', 'closed',
	    costs['Closed'], listranks);
    });
    addPendingFunction("Hybrid realm 1 closed lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realms[1]} Closed*`, '', 'closed',
	    costs['Closed'], listranks);
    });
    addPendingFunction("Hybrid realm 1 other base lists",()=> {
      _spellDoQuery(previousranks, `Realm:${realms[0]} Subtype:Base`, `${profession} Base`,
	    'otherbaseownrealm', costs.Restricted, listranks);
    });
    addPendingFunction("Hybrid realm 2 other base lists",()=> {
      _spellDoQuery(previousranks, `Realm:${realms[1]} Subtype:Base`, `${profession} Base`,
	    'otherbaseownrealm', costs.Restricted, listranks);
    });
  } else {
    addPendingFunction("Open lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realm} Open*`, '', 'open', costs['Open'], listranks );
    });
    addPendingFunction("Closed lists",()=> {
      _spellDoQuery(previousranks, `ListType:*${realm} Closed*`, '', 'closed', costs['Closed'], listranks);
    });
    addPendingFunction("Other base lists",()=> {
      _spellDoQuery(previousranks, `Realm:${realm} Subtype:Base`, `${profession} Base`,
	      'otherbaseownrealm', costs.Restricted, listranks);
    });
  }
}


onCheck("mancerchange:repeating_closedspelllist", changeSkillPurchase);
onCheck("mancerchange:repeating_openspelllist", changeSkillPurchase);
onCheck("mancerchange:repeating_ownbasespelllist", changeSkillPurchase);
onCheck("mancerchange:repeating_otherbaseownrealmspelllist", changeSkillPurchase);

function prepareGraceTrickery(gracebonus, trickerybonus) {

  getSectionIDsPending(`repeating_specializationgrace`, (graceids) => {
      let toget = []
      getSectionIDsPending(`repeating_specializationspelltrickery`, (trickeryids) => {
	  for (const id of trickeryids) {
	    const basename = `repeating_specializationspelltrickery_${id}`
	    toget.push(basename + "_bonus");
	    toget.push(basename + "_name");
	  }
	  for (const id of graceids) {
	    const basename = `repeating_specializationgrace_${id}`
	    toget.push(basename + "_bonus");
	    toget.push(basename + "_name");
	  }
	  getAttrsPending(toget, (perks) => {
	      for (const id of graceids) {
		const basename = `repeating_specializationgrace_${id}`
		if (perks[basename + "_name"]) {
		  gracebonus[perks[basename + "_name"]] = perks[basename + "_bonus"]
		}
	      }
	      for (const id of trickeryids) {
		const basename = `repeating_specializationspelltrickery_${id}`
		if (perks[basename + "_name"]) {
		  trickerybonus[perks[basename + "_name"]] = perks[basename + "_bonus"]
		}
	      }
	      console.log("Trickery & Grace", trickerybonus, gracebonus);
	  });
      });
  });
}


// For spells we neeed:
//  - Ranks
//  - Spellcasting bonus
//  - Spellmastery bonus
//  - Known spells.
function updateSpellCategory(spellgroup, bonus, gracebonus, trickerybonus) {

  getAttrsPending(["customspelllists"], (ev) => {
    let customlists = ev.customspelllists || {};
    

  getSectionIDsPending(`repeating_spelllistspell${spellgroup}`, (ids) => {
      for (const id of ids) {
	  const basename = `repeating_spelllistspell${spellgroup}_${id}`;
	  let toget = []
	  toget.push(basename + '_ranks_misc');
	  toget.push(basename + '_misc');
	  toget.push(basename + '_name');
	  toget.push('scr_misc');
	  getAttrsPending(toget, (attrs) => {
	      const name = attrs[`${basename}_name`];
	      const [scrbonus, slog] = miscBonusTotal(attrs.scr_misc);
	      const [ranks, rlog] = miscBonusTotal(attrs[basename + '_ranks_misc']);
	      let scrlog = slog + rlog + `${bonus}   Spell Type bonus\n`
	      let realmstat = RMUSkills.getStat('rs');
	      
	      
	      let mastery = realmstat + realmstat + RMUSkills.getStat('me') +
		  RMUSkills.getSkillBonus(ranks);
	      setAttrsPending({
		    [`${basename}_ranks`]: ranks,
		    [`${basename}_listname`]: name,
		    [`${basename}_scr`]: scrbonus + ranks + bonus,
		    [`${basename}_info`]: scrlog,
		    [`${basename}_spellmastery`]: mastery,
		    [`${basename}_grace`]: gracebonus[name] || 0,
		    [`${basename}_trickery`]: trickerybonus[name] || 0,
	      });
	      getCompendiumPage(`SpellList:${name}`, (spelllist) => {
		  let buttons = [];
		  let list = ""
		  try {
		    list = JSON.parse(spelllist.data['data-spell']);
		  } catch (e) {
		    console.log("No spell list data; trying custom", e, customlists, name);
		    if (customlists[name]) {
		      list = customlists[name]['data-spell']
		      console.log(list);
		    }
		  }
		  for (const spell of list) {
		    if (spell.level <= ranks) {
		      // Know it
		      let name = spell.name;
		      if (spell.instant) {
		        name += '*';
		      }
		      if (spell.nopp) {
		        name += '•';
		      }
		      const aoe = spell.aoe || '-';
		      const duration = spell.duration || '-';
		      const range = spell.range || '-';
		      const type = spell.type || '-';


		      buttons[`${basename}_spell${spell.level}`] = `${spell.level}) ${name} (${aoe}, ` +
			    `${duration}, ${range}, ${type})`
		      buttons[`${basename}_type${spell.level}`] = type;
		      buttons[`${basename}_name${spell.level}`] = name;
		      buttons[`${basename}_nopp${spell.level}`] = spell.nopp ? 'true' : 'false';
		      buttons[`${basename}_instant${spell.level}`] = spell.instant ? 'true' : 'false';
		    } else {
		      // Force empty names for higher items.
		      buttons[`${basename}_spell${spell.level}`] = "";
		    }
		  }
		  
		  setAttrs(buttons);
	      });
	  });
      };
    });
  });
}

// FIXME : Hybrids need own values
const subtlepenalties = {
  "channeling": {
    E: -40, F: -25, I:  -5, U: -15, A: 0,
    nohand: -20, onehand: 0, twohands: 5,
    novoice: -15, whisper: -5,normal: 0, shout: 10,
    armorenc: 0, metalenc: 3,
    helmetlight: 0, helmetmedium: 0, helmetheavy: 0,
  },
  "essence":    {
    E: -60, F: -50, I: -10, U: -30, A: 0,
    nohand: -40, onehand: -10, twohands: 0,
    novoice: -25, whisper: -10, normal: 0, shout: 5,
    armorenc: 4, metalenc: 4,
    helmetlight: 0, helmetmedium: 0, helmetheavy: 0,
  },
  "mentalism" : {
    E: -30, F: -20, I:   0, U:  -5, A: 0,
    nohand: 0, onehand: 0, twohands: 0,
    novoice: 0, whisper: 0, normal: 0, shout: 0,
    armorenc: 0, metalenc: 0,
    helmetlight: -25, helmetmedium: -50, helmetheavy: -75,
  },
  "essment":    {
    E: -60, F: -50, I: -10, U: -30, A: 0,
    nohand: -40, onehand: -10, twohands: 0,
    novoice: -25, whisper: -10, normal: 0, shout: 0, // mystics get screwed here
    armorenc: 4, metalenc: 4,
    helmetlight: -25, helmetmedium: -50, helmetheavy: -75,
  },
  "chaness":    {
    E: -60, F: -50, I: -10, U: -30, A: 0,
    nohand: -40, onehand: -10, twohands: 0,
    novoice: -25, whisper: -10, normal: 0, shout: 5,
    armorenc: 4, metalenc: 4,
    helmetlight: 0, helmetmedium: 0, helmetheavy: 0,
  },
  "chanment": {
    E: -40, F: -25, I:  -5, U: -15, A: 0,
    nohand: -20, onehand: 0, twohands: 0,
    novoice: -15, whisper: -5,normal: 0, shout: 0,
    armorenc: 0, metalenc: 3,
    helmetlight: -25, helmetmedium: -50, helmetheavy: -75,
  },
  "arcane": {
    E: -80, F: -40, I:  -10, U: -20, A: 0,
    nohand: -40, onehand: -10, twohands: 0,
    novoice: -20, whisper: -10,normal: 0, shout: 10,
    armorenc: 2, metalenc: 3,
    helmetlight: 0, helmetmedium: 0, helmetheavy: 0,

  },
};

const handNames = { nohand: "No Hands", onehand: "One Hand", twohands: "Two Hands" };
const voiceNames = { novoice : "Silent", whisper: "Whisper", normal: "Normal Voice", shout: "Shouting" };

/*
 * Returns an object containing string and penalty/bonus.
 * 
 * We first get all the penalties.  Then apply spell trickery.
 * Then all the bonuses.
 *
 *
 * { msg: 'some string', modifier: -33 }
 */

function getSubtlePenalty(realm, type, trickery, subtle, voice, hands, enc, metalenc, transcend,
	    listname) {
  let penalty = 0;
  let log = '';
  let usedtrickery = false;

  if (realm == 'essencementalism' || realm == 'Essence/Mentalism') {
    realm = 'essment';
  } else if (realm == 'channelingessence' || realm == 'Channeling/Essence') {
    realm = 'chaness';
  } else if (realm == 'Channeling/Mentalism' || realm == 'channelingmentalism') {
    realm = 'chanment';
  } else if (realm == 'Essence' || realm == 'essence') {
    realm = 'essence';
  } else if (realm == 'Channeling' || realm == 'channeling') { 
    realm = 'channeling';
  } else if (realm == 'Mentalism' || realm == 'mentalism') {
    realm = 'mentalism';
  } else if (realm == 'Arcane' || realm == 'arcane') {
    realm = 'arcane';
  } else {
    rmuerror("Unknown realm:", realm);
    realm = 'essence';
  }

  // So first... get all the penalties... 
  const pentable = subtlepenalties[realm];
  if (!pentable) {
    rmuerror(`Counld not modifiers for realm ${realm}`);
    return { msg: `Error finding realm '${realm}'`, modifier: 0 };
  }

  if (subtle == 'subtle') {
    type = type.substring(0, 1);
    penalty = pentable[type];
    log += ` ${pentable[type]}&nbsp;[Subtle ${type}]`; 
    usedtrickery = true;
  }
  // Hands
  if (pentable[hands] < 0) {
    penalty += pentable[hands];
    log += ` ${pentable[hands]}&nbsp;[${handNames[hands]}]`;
    usedtrickery = true;
      
  }
  // Voice
  if (pentable[voice] < 0) {
    penalty += pentable[voice];
    log += ` ${pentable[voice]}&nbsp;[${voiceNames[voice]}]`;
    usedtrickery = true;
  }

  if (penalty < 0 && trickery > 0) {
    penalty += trickery;
    log += ` +${trickery}&nbsp;[Trickery]`;
    if (penalty > 0) {
      penalty = 0;
      log += ` (Capped at 0)`;
    }
  }

  if (usedtrickery && listname != "") {
    RMUSkills.uses("spelltrickery", listname);
  }

  // Armor and Transcendance
  if ((enc || metalenc) && (pentable.armorenc || pentable.metalenc)) {
    // Enc is all encumberance from armor, Metalenc is jsut hte metal bit.
    RMUSkills.uses("transcendence");
    let epen = 0;
    if ((pentable.armorenc == pentable.metalenc) || (enc == metalenc)) {
      // Easy case: Metal and non metal the same - Essence basically
      // Ignore metal as enc encompases both
      epen += enc * pentable.metalenc;
      log += ` -${epen}&nbsp;[${enc} Enc% * ${pentable.metalenc}]`;
    } else {
      let encdelta = enc - metalenc;
      epen += encdelta * pentable.armorenc;
      log += ` -${epen}&nbsp;[(${enc} - ${metalenc} Non-metal Enc% * ${pentable.armorenc}]`;
      epen += metalenc * pentable.metalenc;
      log += ` -${metalenc * pentable.metalenc}&nbsp;[${metalenc} Metal Enc% * ${pentable.metalenc}]`;
    }
    // Now apply transcendance
    if (transcend && epen > 0) {
      if (transcend >= epen) {
	log += ` +${epen}&nbsp;[Transcendance ${transcend} (Capped)]`;
	epen = 0;
      } else {
	epen -= transcend;
	log += ` +${transcend}&nbsp;[Transcendance]`;
      }
    }
    penalty -= epen;
  }

  // Now add hands & voice if a bonus
  if (pentable[hands] > 0) {
    penalty += pentable[hands];
    log += ` +${pentable[hands]} [${handNames[hands]}]`;
  }
  if (pentable[voice] > 0) {
    penalty += pentable[voice];
    log += ` +${pentable[voice]} [${voiceNames[voice]}]`;
  }
  
  return { msg: log, modifier: penalty };
}


/** FIXME:
 * This is pretty generic
 */
function sendMessage(msg) {
  // FIXME: CHeck for braces
  startRoll('&{template:rmumessage}{\{message=[[1d1]]}}', roll => {
    finishRoll(roll.rollId, { message: msg });
  });
}

function sendEOTMessage(msg) {
  // FIXME: CHeck for braces
  startRoll('&{template:rmueotmessage}{\{message=[[1d1]]}}', roll => {
    finishRoll(roll.rollId, { message: msg });
  });
}

/***/
function spellGenerateMesssage(spelltype, result, casterlevel) {
  let response = ''
  let target = result + 2 * casterlevel;
  switch (spelltype) {
  case 'F': case 'Fm':
    response = `Spell is cast.  Target RR is ${target}.`
    break;
  case 'I': case 'Im':
    response = `Spell is cast.  ` +
	`RR ${target + 50} to resist. ` +
	`RR ${target + 25} knows source (not spell) ` +
	`RR result ${target} for hunch.  `;
    break;
  default:
    response = 'Spell is cast.';
    break;
  }
  return response;
}

/**
 * Generate a list of events;
 * One for every level for 0-20, then event 5 after that up to 90 (hello treasure law).
 */
let spellcastevents = [];
["ownbase", "open", "closed", "otherbaseownrealm", "openother",
  "closedother", "otherbaseother", "arcane"].forEach((listtype) => {
    for (let i = 1 ; i <= 20 ; i ++) {
      spellcastevents.push(`clicked:repeating_spelllistspell${listtype}:castspell${i}`);
    }
    for (let i = 25 ; i <= 90 ; i += 5) {
      spellcastevents.push(`clicked:repeating_spelllistspell${listtype}:castspell${i}`);
    }
  }
);


onCheck(spellcastevents.join(" "), (ev) => {
    // get the numbe from the end
    const level = parseInt(ev.sourceAttribute.match(/\d+$/)[0]);

    const basename = ev.sourceAttribute.replace(/_castspell\d*$/, "");
    getAttrs([`${basename}_type${level}`, `${basename}_name${level}`, `${basename}_spell${level}`,
	`${basename}_nopp${level}`, `${basename}_instant${level}`,
	`${basename}_ranks`, `${basename}_listname`,
	'pp', 'realm', 'character_name', 'scr_misc',
	// Trickery and grace are per list
	`${basename}_trickery`, `${basename}_grace`, `${basename}_group`,
	// Transcendance is global
	'transcendence_bonus', 'level', 'castingmiscmod',
	'armorencmetal', 'armorenc',
	'castingvoice', 'castingpreprounds', 'castingsubtle', 'castinghands',
	// AP
	'castinguseap', 'aptrack', 'actionselect',
	// Maneuver Penalty
	'statuspenalty', 'statuseffect',
	// Which RR targets am I using
	'option_fixedrrbase', 'option_allownoprepovercast'
	],
      (spelldata) => {
	console.log("Casting a spell", spelldata);

	// Extract stuff to sane names:
	const type = spelldata[`${basename}_type${level}`];
	const ranks = spelldata[`${basename}_ranks`] || 0;
	const name = spelldata[`${basename}_name${level}`];
	const listname = spelldata[`${basename}_listname`] || "";
	const nopp = spelldata[`${basename}_nopp${level}`] == 'true' ? true : false;
	const instant = spelldata[`${basename}_instant${level}`] == 'true' ? true : false;
	const caster = spelldata.character_name; 
	const casterlevel = spelldata.level;
	const preprounds = Math.min(parseIntDefault(spelldata.castingpreprounds, 0), 2);
	const group = spelldata[`${basename}_group`];
	const trickery = spelldata[`${basename}_trickery`];
	const grace = Math.max(parseIntDefault(spelldata[`${basename}_grace`], 0), 0);
	const statuseffect = spelldata.statuseffect || 0;
	const usefixedrr = spelldata.option_fixedrrbase || 'no';
	const allowovercast = spelldata.option_allownoprepovercast || 'no';

	let mod = 0; // Total spell mod;
	let mlog = ''

	let pp = parseIntDefault(spelldata['pp'], 0);

	if (statuseffect == 'staggered') {
	  sendMessage(`${caster} is staggered; Unable to cast spells`);
	  return;
	}

	// First; check for PP
	if (!nopp && level > pp) {
	  sendMessage(`${caster} unable to cast ${name}; insufficient PP: Have ${pp} PP, Need ${level} PP`);
	  return;
	}

	if (allowovercast === 'no' && casterlevel < level && preprounds == 0 && instant == false) {
	  // Overcast; strictly requires prep round
	  sendMessage(`${caster} unable to over-cast non-install spell ${name}; Must spend at least 1 round preparing`);
	  return;
	}

	// Check for AP early.
	if (spelldata.castinguseap == 'on' && instant == false) {
	  if (spelldata.actionselect != 'spell') {
	    sendMessage(`${caster} must use Spell Action`);
	    return;
	  }
	  let ap = parseIntDefault(spelldata.aptrack, 4);
	  if (ap < 2) {
	    sendMessage(`${caster} must spend at least 2 AP to cast a spell`);
	    return;
	  }
	  if (ap == 2) {
	    mlog += '-50&nbsp;[Fast&nbsp;Cast&nbsp;2AP]';
	    mod += -50;
	  } else if (ap == 3) {
	    mlog += '-25&nbsp;[Fast&nbsp;Cast&nbsp;3AP]';
	    mod += -25;
	  }
	}

	// Lets work out subtle first:
	{

	  const subtle = getSubtlePenalty(spelldata.realm, type, trickery,
		  spelldata.castingsubtle, spelldata.castingvoice, spelldata.castinghands,
		  spelldata.armorenc || 0, spelldata.armorencmetal || 0,
		  spelldata.transcendence_bonus || 0, listname);
	  mlog += subtle.msg;
	  mod += subtle.modifier;
	  console.log(subtle);
	}

	{
	  const manp = parseIntDefault(spelldata.statuspenalty, 0);
	  if (manp < 0) {
	    mlog += ` ${manp}&nbsp;[Status&nbsp;Penalty]`;
	    mod += manp;
	  }
	}

	{
	  const spen = parseIntDefault(spelldata.statuseffect, 0);
	  if (spen < 0) {
	    mlog += ` ${spen}&nbsp;[Stun]`;
	    mod += spen;
	  }
	}

	{
	  const miscmod = parseIntDefault(spelldata.castingmiscmod, 0);
	  if (miscmod) {
	    mod += miscmod;
	    if (miscmod > 0) {
	      mlog += ` +${miscmod}&nbsp;[Other&nbsp;modifier]`;
	    } else {
	      mlog += ` ${miscmod}&nbsp;[Other&nbsp;modifier]`;
	    }
	  }
	}

	if (preprounds > 0) {
	  mod += preprounds * 10;
	  mlog += ` +(${preprounds}&nbsp;*&nbsp;10)&nbsp;[Prep]`;
	}

	if (casterlevel < level) {
	  if (listname.length != "") {
	    RMUSkills.uses("grace", listname);
	  }
	  const overcast = level - casterlevel;
	  const overpenalty = overcast * 20;

	  if (grace > overpenalty) {
	    mlog += ` -0&nbsp;[Overcast ${overcast} levels (${overpenalty} + ${grace} Grace (0 capped))]`;
	  } else if (grace > 0) {
	    const modified = overpenalty - grace;
	    mlog += ` -${modified}&nbsp;[Overcast ${overcast} levels (${overpenalty} + ${grace} Grace)]`
	    mod -= modified;
	  } else {
	    // FIXME: add grace here
	    mlog += ` -${overpenalty}&nbsp;(Overcast ${overcast} levels * 20)`
	    mod -= overpenalty;
	  }
	}
	
	mod += ranks;
	mlog += ` +${ranks}&nbsp;[Ranks]`;

	if (group == 'spellownbase') {
	  mod += 5;
	  mlog += ' +5&nbsp;[Base&nbsp;List]';
	} else if (group == 'spellopen') {
	  mlog += ' +0&nbsp;[Open&nbsp;List]';
	} else if (group == 'spellclosed') {
	  mod += -5;
	  mlog += ' -5&nbsp;[Closed&nbsp;List]';
	} else {
	  mod += -10;
	  mlog += ' -10&nbsp;[Other&nbsp;List]';
	}

	const scrbonus = miscBonusTotalFlat(spelldata.scr_misc);
	mod += scrbonus[0];
	mlog+= scrbonus[1];

	startRoll("@{whispertype} &{template:rmuspell} " +
	      "[[ 1d100!>96 ]] [[ 1d100!>96 ]] " +
	      "{\{roll=$[[0]]}} " +
	      "{\{oeroll=$[[1]]}} " +
	      `{\{who=${spelldata.character_name}}} ` +
	      `{\{mod=${mod}}} ` +
	      `{\{spell=[[0]]}} ` +
	      `{\{modlog=[[0]]}} ` +
	      `{\{total=[[0]]}} ` +
	      `{\{result=[[0]]}} ` +
	      "{\{ppmsg=[[0]]}} " +
	      `{\{pp=[[0]]}}`, (roll) => {
	    let totalroll = roll.results.roll.result;
	    let totalrollstr = roll.results.roll.dice.join(' + ');
	    //roll.results.roll.dice
	    if (totalroll < 6) {
	      // OE: Oops
	      totalroll -= roll.results.oeroll.result;
	      totalrollstr = `${totalrollstr} - (${roll.results.oeroll.dice.join(' + ')})`;
	    }
	    total = totalroll + mod;
	    let result = "Unknown";
	    let ppmsg = '';
	    if (total > 0) {
	      if (usefixedrr === 'fixed') {
		result = spellGenerateMesssage(type,50,casterlevel);
	      } else {
		result = spellGenerateMesssage(type,total,casterlevel);
	      }
	      if (nopp) {
		ppmsg = 'No PP cost';
	      } else {
		ppmsg = `${level} PP`;
		pp -= level;
		RMUSkills.uses('powerdevelopment');
	      }
	      // FIXME: Should check for type to display RR message or directed skill roll
	    } else if (total == 0) {
	      result = "Spell just fizzles.  Carry on.";
	      ppmsg = "No PP";
	    } else {
	      result = "Spell fails.  Roll spell failure";
	      ppmsg = "As per fail roll";
	      // FIXME: Should roll for spell failure.  Or offer button to do same
	    }

	    finishRoll(roll.rollId, {
		spell: name,
		modlog: mlog, 
		total: total,
		roll: totalrollstr,
		pp: pp,
		ppmsg: ppmsg,
		result: result,
	    });
	    setAttrs({pp: pp});
	});
    });
});

/*

  for (const group of ['ownbase', 'open', 'closed']) {
    getSectionIDsPending(`repeating_spelllistspell${group}`, (ids) => {
      let toget = [];
      for (id of ids) {
	const basename = `repeating_spelllistspell${group}_${id}`;
	toget.push(`${basename}_ranks_misc`);
	toget.push(`${basename}_name`);
	getAttrsPending(toget, (spells) => {
	  console.log(spells);
	});
      }	
    });
  }
})*/

function updateSpells(grace, trickery) {
  // For each category, get the repeating children and do the calculation
  // FIXME: From an array somewher
  updateSpellCategory('ownbase', 5, grace, trickery)
updateSpellCategory('open', 0, grace, trickery)
updateSpellCategory('closed', -5, grace, trickery)
updateSpellCategory('otherbaseownrealm', -10, grace, trickery)
updateSpellCategory('openother', -10, grace, trickery)
updateSpellCategory('closedother', -10, grace, trickery)
updateSpellCategory('otherbaseother', -10, grace, trickery)
updateSpellCategory('arcane', -10, grace, trickery)

}

onCheck("clicked:editspells", (_) => {
    getAttrs(["edit_spell_toggle"], (ev) => {
	let nv = 'on';
	if (ev.edit_spell_toggle == 'on') {
	  nv = 'off';
	}
	setAttrs({edit_spell_toggle: nv});
    });
});

/* so there are 
   - subtle mods (offset by trickery - per list)
   - equip mods (Offset by transcendance - global)
   - overcast mods (offset by grace - per list)

   To calculate I need the type of the spell, the spell list, the spell level

  */

onCheck("change:castingvoice change:castingpreprounds change:castingsubtle change:castinghands", (ev) => {
    // Something changed: So we get all the stuff we need, and then calculate the modifier.
    getAttrs(["castingvoice", "castingpreprounds", "castingsubtle", "castinghands", "realm"], (mods) => {
	let mod = 0;
	let preprounds = parseIntDefault(mods.castingpreprounds, 0);
	if (preprounds > 2) {
	  preprounds = 2;
	} else if (preprounds < 1) {
	  preprounds = 0;
	}
	mod = preprounds * 10;
	setAttrs({castingmod: mod});
		
    });
});


onCheck("clicked:repeating_creaturespell:creatureskillroll", (ev) => {
    const basename = ev.sourceAttribute.replace(/_creatureskillroll$/, "");
    getAttrs([basename + "_name", basename + "_scr", 'character_name',
	    'statuspenalty', 'statuseffect'], (cdata) => {
	console.log(cdata)
	const toroll = {}
	toroll.name = cdata[basename + "_name"];
	toroll.bonus = cdata[basename + "_scr"];
	toroll.character_name = cdata.character_name;
	toroll.statuspenalty = cdata.statuspenalty;
	toroll.statuseffect = cdata.statuseffect;
	console.log("toroll", toroll);
	creatureSpellRoll(toroll);
    });
});

function creatureSpellRoll(cdata) {
  startRoll("@{whispertype} &{template:rmu} " +
      `[[ [[ [[ 1d100!>96 ]] + ${cdata.bonus} ]] - [[ 1d100!>96 ]] ]] ` +
      `{\{bonus=${cdata.bonus}}} ` + 
      "{\{um=$[[0]]}} " +
      "{\{rollh=$[[1]]}} " +
      "{\{rollsub=$[[2]]}} " +
      "{\{rolll=$[[2]]}} " +
      `{\{action=${cdata.name}}} ` +
      `{\{verb=casts a spell from }} ` +
      `{\{actor=${cdata.character_name}}}`, (roll) => {
	  finishRoll(roll.rollId, {})
    })
}


onCheck("clicked:uploadspelllist", (ev) => {
    setAttrs({uploadspelllistmessage: "Uploading..."});
    getAttrs(['customlistupload'], (liststr) => {
      console.log(liststr);
      let newlist = {}
      try {
	newlist = JSON.parse(liststr.customlistupload)
	console.log("new list is ", newlist);
      } catch (error) {
	setAttrs({uploadspelllistmessage: error});
	console.log(error);
	return;
      }
      if (!newlist.Name) {
	setAttrs({uploadspelllistmessage: "List must have name"});
	console.log({uploadspelllistmessage: "List must have name"});
	return;
      }
      if (newlist.Category && newlist.Category == 'Creature') {
	console.log("Doing creature");
	setAttrs({uploadspelllistmessage: "Creature..."});
	return creature.newCreature(newlist.Name, newlist);
      }
      console.log("has name");
      getAttrs(["customspelllists"], listsjson => {
	if (!listsjson.customspelllists) {
	  listsjson.customspelllists = {};
	}
	const customlists = listsjson.customspelllists
	console.log("current lsits is " ,customlists);
	customlists[newlist.Name] = newlist;
	rmuSetAttrs({"customspelllists":customlists, "uploadspelllistmessage": `${newlist.Name} uploaded`});
      });
    });
});

/**
 * Spell failure roll.
 *
 * Param is the short name:  4 letter realm, followed by type 
 */
const spellfailureinfo = [
  { aname: "chanelem", realm: "Channeling", type: "Elemental", display:  "Channeling Elemental", },
  { aname: "chanforce", realm: "Channeling", type: "Force", display:  "Channeling Force" },
  { aname: "chaninfo", realm: "Channeling", type: "Informantional", display:  "Channeling Information" },
  { aname: "chanutlity", realm: "Channeling", type: "Utility", display:  "Channeling Utility" },
  { aname: "esselem", realm: "Essence", type: "Elemental", display:  "Essence Elemental" },
  { aname: "essforce", realm: "Essence", type: "Force", display:  "Essence Force" },
  { aname: "essinfo", realm: "Essence", type: "Informational", display:  "Essence Information" },
  { aname: "essutlity", realm: "Essence", type: "Utility", display:  "Essence Utility" },
  { aname: "mentelem", realm: "Mentalism", type: "Elemental", display:  "Mentalism Elemental" },
  { aname: "mentforce", realm: "Mentalism", type: "Force", display:  "Mentalism Force" },
  { aname: "mentinfo", realm: "Mentalism", type: "Informational", display:  "Mentalism Information" },
  { aname: "mentutlity", realm: "Mentalism", type: "Utility", display:  "Mentalism Utility" },
];
function spellFailureRoll(type, mod, lookup) {
  console.log(type, mod, lookup);
  for (info of spellfailureinfo) {
    if (type === info.aname) {
      // found
      console.log("FFF");
      return spellFailureFromInfo(info, mod, lookup);
    }
  }
  rmuerror(`Tried to do a spell failure for ${type}, could not be found`)
}

/**
 * Main worder function.
 */
function spellFailureFromInfo(info, modifier, lookup) {
  if (!info) { return false; }
  if (typeof(lookup) != 'boolean') { return false; }
  if (typeof(modifier) != 'number') { return false; }

  console.log(info, modifier, lookup);

  let template = "rmufumble";
  let theroll = '1d100';
  if (lookup) {
    template = "rmufumblelookup";
    theroll = modifier || 1;
    if (theroll > 350) {
      theroll = 350;
    } else if (theroll < 1) {
      theroll = 1;
    }
  } else {
    if (modifier) {
      theroll += ' + ' + modifier;
    }
  }

  const rollstring = `@{whispertype} &{template:${template}}` +
      "{\{who=@{character_name}}}" +
      `{\{roll=[[${theroll}]]}}` +
      "{\{type=[[0]]}}" +
      "{\{rangemin=[[0]]}}" +
      "{\{rangemax=[[0]]}}" +
      "{\{result=[[0]]}}";
  startRoll(rollstring, roll => {
      dospellfailureompendiumlookup(info.realm, info.type, parseIntDefault(roll.results.roll.result, 1),
	  (result) => {
	      result.type = info.display;
	      finishRoll(roll.rollId, result);
	  }
      );
  });
  return true;
}



/**/


rrs = (function() {
console.log("RRs init\n");
  let exports = {}

  let rrs = {
  /**/ arcane: { display: 'Arcane', aname: 'arcane', stat: 'em/in/pr' },
 channeling: { display: 'Channeling', aname: 'channeling', stat: 'in' },
 channelingessence: { display: 'Channeling/Essence', aname: 'channelingessence', stat: 'in/em' },
 channelingmentalism: { display: 'Channeling/Mentalism', aname: 'channelingmentalism', stat: 'in/pr' },
 essence: { display: 'Essence', aname: 'essence', stat: 'em' },
 essencementalism: { display: 'Essence/Mentalism', aname: 'essencementalism', stat: 'em/pr' },
 mentalism: { display: 'Mentalism', aname: 'mentalism', stat: 'pr' },
 physical: { display: 'Physical', aname: 'physical', stat: 'co' },
 fear: { display: 'Fear', aname: 'fear', stat: 'sd' },
/**/
  };

  function getRealmFromDisplay(display) {
    for (rr in rrs) {
      if (rrs[rr].display == display || rrs[rr].aname == display) {
	return rrs[rr]
      }
    }
    return 0
  }
  exports.getRealmFromDisplay = getRealmFromDisplay;

  on("change:level change:realm change:em change:in change:pr change:co change:sd", () => {
    updateAllRR()
   });

  /* */
  function isOwnRealm(realm, chrealm) {
    rinfo = getRealmFromDisplay(chrealm);
    if (!rinfo) {
      rmuerror(`Unable to find realm in isOwnRealm:  realm ${realm} chrealm ${chrealm}`)
      return false;
    }
    
    if (rinfo.aname == realm){
      return true;
    } else if (rinfo.aname.includes(realm)) {
      return true;
    } else {
      return false;
    }
  }
  exports.isOwnRealm = isOwnRealm;

  function updateAllRR() {
    getAttrs(['sheetselect', 'em', 'in', 'pr', 'sd', 'co', 
	  'rr_arcane_misc', 'rr_channeling_misc', 'rr_mentalism_misc', 'rr_essence_misc',
	  'rr_physical_misc', 'rr_fear_misc', 'level', 'realm'], (values) => {
      if (values.sheetselect == 'creaturesheet') {
	return;
      }
      const updates = {};
      updateRR(rrs.arcane, values, updates);
      updateRR(rrs.channeling, values, updates);
      updateRR(rrs.essence, values, updates);
      updateRR(rrs.mentalism, values, updates);
      updateRR(rrs.fear, values, updates);
      updateRR(rrs.physical, values, updates);
      setAttrs(updates);
    });
  }
  exports.updateAllRR = updateAllRR

  function updateRR(realm, values, updates) {
      let log = "";
      let bonus = -1000;
      let stats = realm.stat.split('/')
      
      if (stats.len == 1) {
	// Single item (not arcane most likely)
	bonus = parseInt(values[realm.stat]) || 0;
	log += `${values[realm.stat]} ${getTranslationByKey(realm.stat)} Bonus\n`;
      } else {
	// FOr now we take the _highest_ for Arcane
	let sublog = ""; 

	for (stat of stats) {
	  if (values[stat] > bonus) {
	    bonus = values[stat];
	  }
	  sublog += `    ${values[stat]} ${stat} Bonus\n`;
	}
	log += `${bonus} Best Realm Stat Bonus\n` + sublog;
      }
      let [miscbonus, mlog] = miscBonusTotal(values['rr_' + realm.aname + '_misc']);
      bonus += miscbonus
      log += mlog;
      let level = parseInt(values.level) || 0;
      bonus += level * 2;
      log += `${level *2} Twice Level\n`;
      if (isOwnRealm(realm.aname, values.realm)) {
	bonus += 10;
	log += "10  Own realm\n";
      }

      updates['rr_' + realm.aname + '_bonus'] = bonus
      updates['rr_' + realm.aname + '_info'] = log;
  }

  exports.testUpdateRR = updateRR

  // From our roll template:
  //  firstroll is the OEH
  //  secondroll is for OEL
  // 66 is nothing for RRs
  function rrRoll(roll) {
    let rrroll = parseInt(roll.results.firstroll.result);
    let log = "(";
    if (rrroll < 6) {
      log += `${rrroll} - (`;
      rrroll -= parseInt(roll.results.secondroll.result);
      log += roll.results.secondroll.dice.join(' + ');
      log += ')'
    } else {
      log += roll.results.firstroll.dice.join(' + ');
    }
    log += ')&nbsp;[Roll]'

    let bonus = parseInt(roll.results.rrbonus.result);
    log += ` + ${bonus}&nbsp;[Bonus]`;
    rrroll += bonus;

    if (roll.results.mod) {
      let mod = parseInt(roll.results.mod.result);
      log += ` + ${mod}&nbsp;[Modifier]`;
      rrroll += mod;
    }

    finishRoll(roll.rollId, { firstroll:  rrroll, message: log });
  }

  function rrStartRoll(ev, usemod) {
     const type = ev.htmlAttributes['data-rr']
     const pretty = ev.htmlAttributes['data-rrpretty']
     const modstr = (usemod) ? "[[ ?{Modifier|0} ]] {\{mod=$[[4]]}} " : "";
     startRoll("@{whispertype} &{template:rmurr} " +
	`[[ [[ 1d100!>96 ]] + [[ 1d100!>96 ]] + [[ @{rr_${type}_bonus} ]] ]] ` +
	modstr +
	"{\{firstroll=$[[0]]}} " +
	"{\{secondroll=$[[1]]}} " +
	"{\{rrbonus=$[[2]]}} " +
	"{\{message=$[[2]]}} " +
	"{\{who=@{character_name}}} " +
	`{\{type=${pretty}}} ` +
	`{\{rrbonus=@{rr_${type}_bonus}}}`, rrRoll);
  }

    // Time for an RR roll.
    onCheck("clicked:rrroll", (ev) => {
	rrStartRoll(ev, false);
    });

    // An RR roll with a modifier.
    onCheck("clicked:rrrollmod", (ev) => {
       rrStartRoll(ev, true);
    });


  exports.rrs = rrs;
   return exports;
})();

/**/

/**/

const xp_ose2k_table = [0, 1, 2000, 4000, 8000, 16000, 32000, 64000, 120000];
const xp_ose1k_table = [0, 1, 1000, 2000, 4000,  8000, 16000, 32000, 60000];
const xp_rmss_table = [0,    10000,  20000,  30000,  40000,  50000,
			     70000,  90000, 110000, 130000, 150000,
			    180000, 210000, 240000, 270000, 300000,
			    340000, 380000, 420000, 460000, 500000];

function xptablelookup(xp, table) {
  for (let i = 0 ; i < table.length ; i ++) {
    if (xp < table[i]){
      return i - 1;
    }
  }
  return -1
}

function xpcalculateOSE2k(xp) {
  if (xp >= 120000) {
    return Math.floor(xp / 120000) + 7;
  }
  return xptablelookup(xp, xp_ose2k_table);
}

function xpcalculateOSE1k(xp) {
  if (xp >= 60000) {
    return Math.floor(xp / 60000) + 7;
  }
  return xptablelookup(xp, xp_ose1k_table);
}

function xpcalculateRMSS(xp) {
  if (xp >= 500000) {
    // More then half a million; 50k per level
    return Math.floor(xp/ 50000) + 10;
  }
  return xptablelookup(xp, xp_rmss_table);
    return 99; 
}

// If adding more, don't forget to update create.js.gvz
const xpfuncs = {
  rmu: (xp) => { return Math.floor(xp/ 10000) },
  milestone: (xp) => { return xp },
  rmss: xpcalculateRMSS,
  ose2k: xpcalculateOSE2k,
  ose1k: xpcalculateOSE1k,
}

onCheck("change:xp", () => {
    getAttrs(["xp", "option_xpprogression"], (ev) => {
      let progression = ev.option_xpprogression
      if (!xpfuncs[progression]) {
	progression = "rmu";
	setAttrs({"option_xpprogression": "rmu"})
      }
      let xp = +ev.xp;
      if (typeof(xp) != 'number' || xp <= 0) {
	xp = 0;
      }
      let xplevel = xpfuncs[progression](xp);
      setAttrs({"xplevel": xplevel}); 
    });
});


onCheck("change:xplevel change:level", (ev) => {
    getAttrsPending(["level", "xplevel", "dp_misc", "dp_used_misc"], (ev) => {
	setAttrsPending({"display_level": `${ev.level} (${ev.xplevel})`});
	const lvl = parseInt(ev.level);
	const xlvl = parseInt(ev.xplevel);
	if (lvl != xlvl) {
	  setAttrs({"flag_levelup_show": 'on',
		  "flag_cmancer_show": 0})
	} else {
	  setAttrs({"flag_levelup_show": 0})
	}
    });
});


onCheck("clicked:showlevelup", (ev) => {
  startCharactermancer("levelup"); 
});

/**/
onCheck("clicked:removesaved", () => {
  console.log("request cleaR");
  startRoll("!{\{template:default}}{\{ask=![[?{Are You Want to Clear All Data?|No,0|Yes,1}]]}}",
      question => {
	const query = question.results.ask.result;
	if (query) {
	  console.log("About to clear");
	  // This is an amazing sequence
	  changeCharmancerPage('leveluprefesh', () => {
	    console.log("Moved to refresh page");
	    deleteCharmancerData(['levelup'], () => {
	      console.log("levelup data cleared");
	      changeCharmancerPage('levelup', () => {
		console.log("Back to levelup");
	      });
	    });
	  });
	}
      });
});

/** CLick on the add extra talent button */
function addExtraTalent(ev) {
  addRepeatingSection('added_talents', 'talent', (id) => {
    setCharmancerOptions(`${id}_talent`, "Category:Talent");
  });
}

function removeTalent(ev) {
  RMUCosts.update(ev.sourceSection, 0, 0);
  {
    let dpspent = RMUCosts.getTotalCost();
    setCharmancerText({"levelupdp": `${dpspent} DP`});
  }
  clearRepeatingSectionById([ev.sourceSection], console.log)
}


onCheck("mancerchange:repeating_cmskill", changeSkillPurchase);

onCheck("mancerchange:repeating_talent_talent", changeTalentPurchase);
onCheck("mancerchange:repeating_talent_tier", changeTalentPurchaseTier);

onCheck("clicked:talent_add", addExtraTalent);
onCheck("clicked:repeating_talent", removeTalent);

// Generate our set of skill purchase events
onCheck("mancerchange:repeating_cmskill_animalhandling_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_riding_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillperceptionranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltrackingranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_battlestyle_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaneuveringinarmorranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmountedcombatranks", changeSkillPurchase);
onCheck("mancerchange:cmskillprotectranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrestrictedquartersranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsubduingranks", changeSkillPurchase);
onCheck("mancerchange:cmskilladrenaldefenseranks", changeSkillPurchase);
onCheck("mancerchange:cmskilladrenalfocusranks", changeSkillPurchase);
onCheck("mancerchange:cmskilladrenalspeedranks", changeSkillPurchase);
onCheck("mancerchange:cmskilladrenalstrengthranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_disciplinestyle_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbodydevelopmentranks", changeSkillPurchase);
onCheck("mancerchange:cmskillfortituderanks", changeSkillPurchase);
onCheck("mancerchange:cmskillweighttrainingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillblindfightingranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_combatstyle_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskilldisarmranks", changeSkillPurchase);
onCheck("mancerchange:cmskillfootworkranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmultipleattacksranks", changeSkillPurchase);
onCheck("mancerchange:cmskillreversestrikeranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbladeranks", changeSkillPurchase);
onCheck("mancerchange:cmskillchainranks", changeSkillPurchase);
onCheck("mancerchange:cmskillhaftedranks", changeSkillPurchase);
onCheck("mancerchange:cmskillgreaterbladeranks", changeSkillPurchase);
onCheck("mancerchange:cmskillgreaterchainranks", changeSkillPurchase);
onCheck("mancerchange:cmskillgreaterhafterranks", changeSkillPurchase);
onCheck("mancerchange:cmskillpolearmranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmeleeexoticranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbowranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcrossbowranks", changeSkillPurchase);
onCheck("mancerchange:cmskillslingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillthrownranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrangedexoticranks", changeSkillPurchase);
onCheck("mancerchange:cmskillshieldranks", changeSkillPurchase);
onCheck("mancerchange:cmskillstrikesranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsweepsthrowsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillwrestlingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbeakranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbiteranks", changeSkillPurchase);
onCheck("mancerchange:cmskillclawranks", changeSkillPurchase);
onCheck("mancerchange:cmskillhornranks", changeSkillPurchase);
onCheck("mancerchange:cmskillramranks", changeSkillPurchase);
onCheck("mancerchange:cmskillstingerranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltrampleranks", changeSkillPurchase);
onCheck("mancerchange:cmskillillusioncraftingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmusicalcompositionranks", changeSkillPurchase);
onCheck("mancerchange:cmskillwritingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillculinaryranks", changeSkillPurchase);
onCheck("mancerchange:cmskilldrawingpaintingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillfabriccraftranks", changeSkillPurchase);
onCheck("mancerchange:cmskillleathercraftranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmetalcraftranks", changeSkillPurchase);
onCheck("mancerchange:cmskillstonecraftranks", changeSkillPurchase);
onCheck("mancerchange:cmskillwoodcraftranks", changeSkillPurchase);
onCheck("mancerchange:cmskillattunementranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrunesranks", changeSkillPurchase);
onCheck("mancerchange:cmskillnavigationranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_piloting_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialalpineranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialoceansranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialundergroundranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialicecapsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialtundraranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialborealranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialshrublandsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialprairiesranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialtemperateranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialhotdesertsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialsavannasranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialtropicalranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialurbanranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsurvivialxenoranks", changeSkillPurchase);
onCheck("mancerchange:cmskillacrobaticsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcontortionsranks", changeSkillPurchase);
onCheck("mancerchange:cmskilljumpingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloreartificialranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloredemonranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloredragonranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloreelementalranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloreextraplanerranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreaturelorefaerieranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreatureloreundeadranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_historiclore_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_language_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialsloreboneranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialslorefabricranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialsloreleatherranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialsloremetalranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialslorestoneranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmaterialslorewoodranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_raciallore_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_regionlore_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_religionphilosophy_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillspellloreranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_grace_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_spelltrickery_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltranscendenceranks", changeSkillPurchase);
onCheck("mancerchange:cmskillherbalismranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmedicineranks", changeSkillPurchase);
onCheck("mancerchange:cmskillpoisonmasteryranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcontrollycanthropyranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmeditationranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmentalfocusranks", changeSkillPurchase);
onCheck("mancerchange:cmskillclimbingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillflyingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrunningranks", changeSkillPurchase);
onCheck("mancerchange:cmskillswimmingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillactingranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_music_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:cmskillstagemagicranks", changeSkillPurchase);
onCheck("mancerchange:cmskillchannelingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillelementalboltsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillillusionaryattacksranks", changeSkillPurchase);
onCheck("mancerchange:cmskillhurlingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillpowerdevelopmentranks", changeSkillPurchase);
onCheck("mancerchange:cmskillpowerprojectionranks", changeSkillPurchase);
onCheck("mancerchange:cmskillarchitectureranks", changeSkillPurchase);
onCheck("mancerchange:cmskillastronomyranks", changeSkillPurchase);
onCheck("mancerchange:cmskillengineeringranks", changeSkillPurchase);
onCheck("mancerchange:cmskillmathematicsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcharmranks", changeSkillPurchase);
onCheck("mancerchange:cmskilldupingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillintimidationranks", changeSkillPurchase);
onCheck("mancerchange:cmskillleadershipranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsocialawarenessranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltradingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillalterationranks", changeSkillPurchase);
onCheck("mancerchange:cmskillcreationranks", changeSkillPurchase);
onCheck("mancerchange:cmskilldefensiveranks", changeSkillPurchase);
onCheck("mancerchange:cmskilldestructionranks", changeSkillPurchase);
onCheck("mancerchange:cmskillelementalranks", changeSkillPurchase);
onCheck("mancerchange:cmskillhealingranks", changeSkillPurchase);
onCheck("mancerchange:cmskillinformationalranks", changeSkillPurchase);
onCheck("mancerchange:cmskillsummoningtransportationranks", changeSkillPurchase);
onCheck("mancerchange:cmskillopenranks", changeSkillPurchase);
onCheck("mancerchange:cmskillclosedranks", changeSkillPurchase);
onCheck("mancerchange:cmskillbaseranks", changeSkillPurchase);
onCheck("mancerchange:cmskillarcaneranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrestrictedranks", changeSkillPurchase);
onCheck("mancerchange:cmskillambushdirectedspellsranks", changeSkillPurchase);
onCheck("mancerchange:cmskillambushmeleeranks", changeSkillPurchase);
onCheck("mancerchange:cmskillambushrangedranks", changeSkillPurchase);
onCheck("mancerchange:cmskillambushshieldranks", changeSkillPurchase);
onCheck("mancerchange:cmskillambushunarmedranks", changeSkillPurchase);
onCheck("mancerchange:cmskillconcealmentranks", changeSkillPurchase);
onCheck("mancerchange:cmskillstalkingranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltrickeryranks", changeSkillPurchase);
onCheck("mancerchange:cmskilllocksranks", changeSkillPurchase);
onCheck("mancerchange:cmskilloperationranks", changeSkillPurchase);
onCheck("mancerchange:cmskillrepairconstructionranks", changeSkillPurchase);
onCheck("mancerchange:cmskilltrapsranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_administration_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_service_specializations_cmskillranks", changeSkillPurchase);
onCheck("mancerchange:repeating_cmskill_trade_specializations_cmskillranks", changeSkillPurchase);



onCheck("clicked:specialization_add", (ev) => {
    const skill = ev.htmlAttributes["data-skill"];
    const catname = ev.htmlAttributes["data-cat"];
    const specname = ev.htmlAttributes["data-specname"];
    const data = getCharmancerData();
    console.log(data, data?.profession, data?.profession?.values, data?.profession?.values?.profession);
    const profession = cleanCompendiumName(data.profession.values.profession);
    const costs = getCostsFromData(profession);
    const costarray = generateCostArray(costs[catname]);
    addRepeatingSection(`cmskill${skill}`,
	'specialization',
	`cmskill_${skill}_specializations`,
	(sectionname) => {
	  cmPopulateListOptions(sectionname + '_cmskillranks', costarray);
	  setAttrs({ [`${sectionname}_specname`] : `${specname} ${specid}` });
	  specid ++;
    });
});




let dpspent = 0;

/* */
function changeSkillPurchase(ev) {
  let dp = 0;

  if (ev.newValue == ev.sourceAttribute) {
    // Some wacky empty data thing - ignore it.
    return;
  }
  // Spell lists names trigger events... because of course they do.
  // Just ignore them.  I wish I could poke at the types or something.
  if (ev.sourceAttribute.endsWith("_listname") ||
	ev.sourceAttribute.endsWith("_listranks")) {
    return;
  }

  let [ranks, costs] = optionDecodeIntPair(ev.newValue);

  RMUCosts.update(ev.sourceAttribute, costs, ranks);
  dpspent = RMUCosts.getTotalCost();
  setCharmancerText({"levelupdp": `${dpspent} DP`});
}

/**/
function changeTalentPurchase(ev) {
  const basename = ev.sourceSection;
  getCompendiumPage(ev.newValue, (tdata) => {
      const tiers = parseIntDefault(tdata.data.Tiers, 1);
      const cost = parseIntDefault(tdata.data.Cost, 0);
      const costpertier = parseIntDefault(tdata.data['Cost per Tier'], cost);
      console.log("change talent purchase", tiers, cost, costpertier, tdata);
      let list = []
      if (tiers > 1) {
	showChoices([`${basename} .talent_tier_show`])
	let total = cost;
	list.push(`Tier 1: ${total} dp~${total}`);
	for (let i = 2 ; i <= tiers ; i ++) {
	  total += costpertier;
	  list.push(`Tier ${i}: ${total} dp~${total}`);
	}
      } else {
	hideChoices([`${basename} .talent_tier_show`]);
	list.push(`Tier 1: ${cost} dp~${cost}`);
      }
      setCharmancerOptions(`${basename}_tier`, list);

      let selectList = RMUTalents.getSelectList(tdata)
      setCharmancerOptions(`${basename}_choice`, selectList);

      RMUCosts.update(basename, cost, 1);
      let dpspent = RMUCosts.getTotalCost();
      setCharmancerText({"levelupdp": `${dpspent} DP`});

      setCharmancerText({[`${basename} .talent_cost`]: cost,
			 [`${basename} .talent_description`]: tdata.data.Description,
			 "levelupdp": `${dpspent} DP`});
  });
}

function changeTalentPurchaseTier(ev) {
   // Workaround for the Roll20 API change that added expansion ids to
   // strings randomly.
  const str = ev.newValue?.replace(/\?expansion=\d*$/, "") || "";
  let cost = parseIntDefault(str.split("~")[1], -111) || -111;
  if (cost == -111) {
    rmuerror("Unable to extract cost from ", ev.newValue, str);
    cost = 0;
  }
  RMUCosts.update(ev.sourceSection, cost, 1);
  {
    let dpspent = RMUCosts.getTotalCost();
    setCharmancerText({"levelupdp": `${dpspent} DP`});
  }
}

const forStatGains = [
  "agility_misc",  "agility_pot_misc",
  "constitution_misc",  "constitution_pot_misc",
  "empathy_misc",  "empathy_pot_misc",
  "intuition_misc",  "intuition_pot_misc",
  "memory_misc",  "memory_pot_misc",
  "presence_misc",  "presence_pot_misc",
  "quickness_misc",  "quickness_pot_misc",
  "reasoning_misc",  "reasoning_pot_misc",
  "selfdiscipline_misc",  "selfdiscipline_pot_misc",
  "strength_misc",  "strength_pot_misc"
];
const stats = [ "agility", "constitution", "empathy", "intuition", "memory", "presence",
    "quickness", "reasoning", "selfdiscipline", "strength" ];

function updateStatgainList(targetnames) {
  let updates = [];

  // Not pending; just trigger indepedantly
  getAttrs(forStatGains, (sts) => {
      for (const st of stats) {
	const temp = miscBonusTotal(sts[`${st}_misc`])[0];
	const pot = miscBonusTotal(sts[`${st}_pot_misc`])[0];
	const display = getTranslationByKey(st)

	updates.push(`${display} (Temporary ${temp} / Potential : ${pot})~${st}`);
	if (typeof(targetnames) == 'string') {
	  setCharmancerOptions(targetnames, updates)
	} else {
	  for (const t of targetnames) {
	    setCharmancerOptions(t, updates);
	  }
	}
      }
  });
}

onCheck("clicked:extrastatgain_add", (ev) => {
    // FIXME: not costing DP
    // addRepeatingSection(target-class, class-to-add, newname, fn(sectioname))
    addRepeatingSection('extra_statgains', 'statgain', (name) => {
	updateStatgainList(name + "_name");
	RMUCosts.update(name, 4, 1);
	let dpspent = RMUCosts.getTotalCost();
	setCharmancerText({"levelupdp": `${dpspent} DP`});
    });
});

function removeExtraStatGain(ev) {
  RMUCosts.update(ev.sourceSection, 0, 0);
  {
    let dpspent = RMUCosts.getTotalCost();
    setCharmancerText({"levelupdp": `${dpspent} DP`});
  }
  clearRepeatingSectionById([ev.sourceSection]);
}

onCheck("clicked:repeating_statgain", removeExtraStatGain);

onCheck("page:levelup", levelUpStart);
onCheck("page:levelupreview", levelUpReview);

/**
 * For all specialised skills, get the name and ranks of the skills.
 *
 * Stored in results; each specialised skill is a list of the skill name and ranks
 *
 * results = { "riding": [prefix:'sss', category:animal, aname: 'riding', name:"Horse",ranks:7,bonus:44] .. };
 */
function getSpecialisedSkillRanks(results) {
  const sections = [];
  const skilltocat = {}

  categories.forEach((cat) => {
      cat.skills.forEach((skill) => {
	  if (!skill.dynamicspecializations) return;
	  let prefix = `repeating_specialization${skill.aname}`
	  skilltocat[skill.aname] = cat;
	  sections.push(prefix);
      });
  });

  getSectionIDsListPending(sections, (prefixes) => {
      const toget = [];
      prefixes.forEach(prefix => {
	  toget.push(prefix + "_name");
	  toget.push(prefix + "_ranks");
	  toget.push(prefix + "_bonus");
	  toget.push(prefix + "_usecount");
	  toget.push(prefix + "_usecounttotal");
      });
      getAttrsPending(toget, (attrs) => {
	  for (prefix of prefixes) {
	      let matches = prefix.match(/^repeating_specialization([^_]*)/);
	      let skill = matches[1] || "Error";
	      item = {
		  aname: skill,
		  category: skilltocat[skill].aname,
		  name: attrs[prefix + "_name"],
		  ranks: attrs[prefix + "_ranks"] || 0,
		  bonus: attrs[prefix + "_bonus"] || 0,
		  usecount: attrs[prefix + "_usecount"] || 0,
		  usecounttotal: attrs[prefix + "_usecounttotal"] || 0,
		  prefix: prefix,
	      };
	      if (!results[skill]) {
		results[skill] = [];
	      }
	      results[skill].push(item)
	  }
      });
  });
}

/**
 * Gets the ranks that the character currently has in spell lists.
 *
 Returns in results (async)
 Organ Arcana : {ranks: 2, prefix: 'repeating_spelllistspellotherbaseownrealm_-ozihd609zzaws1qrpev'}
Sense Molding : {ranks: 12, prefix: 'repeating_spelllistspellownbase_-ovjjkh0a4-zn4izjdcw'}
*/
function getSpellListRanks(results) {
  const spelltypes = [
      'repeating_spelllistspellownbase',
      'repeating_spelllistspellopen',
      'repeating_spelllistspellclosed',
      'repeating_spelllistspellotherbaseownrealm'];
  getSectionIDsListPending(spelltypes, (listids) => {
      let listtofetch = []
      for (list of listids) {
	listtofetch.push(list + '_name');
	listtofetch.push(list + '_ranks');
      }
      getAttrsPending(listtofetch, (listdata) => {
	for (list of listids) {
	  let name = listdata[list + "_name"];
	  results[name] = {
	    ranks: listdata[list + "_ranks"],
	    prefix: list,
	  };
	}
      });
  });
}

/**
 * Remember; data.levelup may be nil
 */
function levelUpStart(_) {
    console.log("********** Level up start **********");
    pendingInfo();
    RMUCosts.reset();
    const data = getCharmancerData();
    console.log(data);

    let previous_level = parseIntDefault(data.levelup?.values?.current_level, 0);

    addPendingFunction("LevelUp: Get Fundamentals", () => {
	getAttrsPending(["level", "xp", "xplevel", "dp_misc", "dp_used_misc"], (ev) => {
	    // If we are at any level but 0, we get 2 free statgains.
	    const level = parseIntDefault(ev.level, 0);
	    if (level > 0){
	      showChoices(["levelup_statgain_free"]);
	      // Create the list of options dynamically so we can add temp / pot
	      // FIXME: This si not pending
	      updateStatgainList(['comp_statgain1', 'comp_statgain2']);
	    }

	    // New level
	    const newlevel = level + 1;

	    // Now the DP pain:
	    const dpmisc = miscBonusTotal(ev.dp_misc || "")[0];
	    const dpreceived = newlevel * 60 + dpmisc;
	    const dpspent = miscBonusTotal(ev.dp_used_misc || "")[0];
	    /**/
	    const dpavil = Math.min(85, dpreceived - dpspent);

	    setAttrs({"current_level": level, "new_level": newlevel});
	    console.log({"current_level": level, "new_level": newlevel});
	    setCharmancerText({"dpinfo": `${dpavil} ` +
		`(= Total received ${dpreceived} ` +
		    ` (Level ${newlevel} * 60) + ` +
		    `Other ${dpmisc}) - Previously spent ${dpspent} (Max of 85 per level)`,
		  'current_level': level, 'new_level': newlevel})

	});
    });

    let costs = {};

    addPendingFunction("LevelUp: fetch costs", () => {
      const toget = [];
      categories.forEach(cat => {
	toget.push(cat.aname + '_cost');
      });
      toget.push('magicalritual_cost', 'spellownbase_cost', 'spellopen_cost',
		'spallclosed_cost', 'spellrestricted_cost', 'spellarcane_cost');
      toget.push('meleeweapons_cost', 'rangedweapons_cost', 'unarmed_cost',
	  'shield_cost');
      getAttrsPending(toget, (results) => {
	  // Strip the costs of each key
	  for (const [key, cost] of Object.entries(results)) {
	    costs[key.replace(/_cost/, "")] = cost;
	  }
      });
    });

    // Global scope; as the other is a pending funtion.
    let savedskills = [];
    let savedspelllists = [];
    let savedtalents = [];
    let savedstatgains = [];

    addPendingFunction("LevelUp: Display Costs", () => {
	// So we need to get the profession & Costs
	dpspent = 0;

	let catupdates = {}
	for (const cat in costs) {
	  catupdates['cmcategory-' + cat + '-cost'] = costs[cat];
	}
	catupdates['cmcategory-combattraining-cost'] = '-';
	catupdates['cmcategory-spellcasting-cost'] = '-';
	setCharmancerText(catupdates);

	// Update each of the cost fields and the selectors.
	RMUSkills.forEachSkill((skill, cat, pskill) => {
	    if (skill.spellgroup) {
	      return;
	    }
	    const skillname = pskill ? pskill.aname : skill.aname;
	    const costarray = generateCostArray(costs[cat.aname] ?? costs[skillname]);
	    if (costarray.length == 0) {
	      rmuerror("Could not generate costs", pskill, pskill.aname, skill.aname);
	      return;
	    }
	    cmPopulateListOptions('cmskill' + skill.aname + 'ranks', costarray); 
	});
    });

    const specialisedranks = {}
    addPendingFunction('Levelup: Get specialised skill ranks', () => {
	getSpecialisedSkillRanks(specialisedranks); 
    });

    addPendingFunction("Levelup: Get previous purchases", () => {
	// On load I should check the list of repeating sections and add
	// them
	if (data?.levelup?.repeating) {
	  for (const index in data.levelup.repeating) {
	    // Need to extract the skillname so I can call addRepeating again
	    const prefix = data.levelup.repeating[index];
	    // See if it's spell list.
	    if (prefix.includes("spelllist")) {
	      savedspelllists.push(prefix);
	      continue;
	    }
	    if (prefix.endsWith("_talent")) {
	      savedtalents.push(prefix);
	      continue;
	    }
	    if (prefix.endsWith("_statgain")) {
	      savedstatgains.push(prefix);
	      continue;
	    }
	    if (prefix.endsWith("_specializations")) {
	      savedskills.push(prefix);
	      continue;
	    }
	  }
	}
    });

    addPendingFunction('Levelup: Create specialisations from ranks', () => {
	for (const skillname in specialisedranks) {
	  const specials = specialisedranks[skillname];
	  specials.forEach(skill => {
	      addRepeatingSection(`cmskill${skill.aname}`, 'specialization', `cmskill_${skill.aname}_specializations`,
		  (sectionname) => {
		      const costarray = generateCostArray(costs[skill.category]);
		      const sname = `${sectionname}_specname`;
		      const rname = `${sectionname}_cmskillranks`;
		      const prefix = `${sectionname}_sheetprefix`;

		      cmPopulateListOptions(rname, costarray, 0)
		      setAttrs({[sname]: skill.name, [prefix] : skill.prefix});
		      let uses = skill.usecount || '-';
		      let usestotal = skill.usecounttotal || '-';
		      let ranks = skill.ranks || '-';

		      setCharmancerText({[`${sectionname} .skillinfo`] :
			    `Current ranks: ${ranks}  Bonus: ${skill.bonus} ` +
			      `Uses: ${uses}/${usestotal}`});

	      });
	  });
	} 
    });

    addPendingFunction('Talents add', () => {
      const data = getCharmancerData();
      console.log("data.level.values.current_level");
      if (previous_level !=  parseIntDefault(data.levelup?.values?.current_level, 0)) {
	return;
      }
      for (obj of savedtalents) {
	addRepeatingSection('added_talents', 'talent', (id) => {
	    setCharmancerOptions(`${id}_talent`, "Category:Talent",
		{ selected: data?.levelup?.data[obj] });
	});
      }
    });

   
    const listRanks = {};
    addPendingFunction('Levelup: Get spell Ranks', () => {
	getSpellListRanks(listRanks); 
    });

    addPendingFunction("Levelup: DEBUGGG@!", () => {
	console.log("Debug point!");
    });


    addPendingFunction('Levelup: Spell List add', () => {
	console.log("List Ranks is ", listRanks);

	const data = getCharmancerData();
	// FIXME: Already got the damn costws - don't need to get them again
	getAttrsPending(["realm", "profession", "spellownbase_cost", 
	  "spellopen_cost", "spellclosed_cost", "spellrestricted_cost",
	  "spellarcane_cost"], (info) => {
	    const costs = {
		Base: info.spellownbase_cost,
		Open: info.spellopen_cost,
		Closed: info.spellclosed_cost,
		Restricted: info.spellrestricted_cost,
		Arcane: info.spellarcane_cost,
	    }
	    initSpellListsCM(
		savedspelllists,
		info.profession,
		info.realm,
		costs,
		listRanks);
	});
    });

    addPendingFunction('Stat gains add',  () => {
	for (obj of savedstatgains) {
	  addRepeatingSection('extra_statgains', 'statgain', (name) => {
	      updateStatgainList(name + "_name");
	      RMUCosts.update(name, 4, 1);
	  });
	}
    });

    addPendingFunction('Levelup: Get ranks/bonus', () => {
	const toget = [];
	categories.forEach(cat => {
	  cat.skills.forEach(skill => {
	    if (skill.dynamicspecializations){
	      return;
	    }
	    if (skill.specializations) {
	      skill.specializations.forEach(spec => {
		toget.push(spec.aname + '_ranks');
		toget.push(spec.aname + '_bonus');
		toget.push(skill.aname + '_usecount');
	      });
	    } else {
	      toget.push(skill.aname + '_ranks');
	      toget.push(skill.aname + '_bonus');
	      toget.push(skill.aname + '_usecount');
	    }
	  });
	});
	getAttrsPending(toget, values => {
	  let updates = {}
	  for (const key in values) {
	    updates['cmskillcur_' + key] = values[key];
	  }
	  setCharmancerText(updates);
	});
    });
        // Specialisations; get existing ones and ones from cultures page
    addPendingFunction('Levelup Init Done', () => {
	console.log("****** Finished levelup function *****");});
    pendingInfo();
    checkPending();
}

/** Returns an object of the form:
  { "statabbr" : { "name": "stat", "count": N } } */
function countStatGains(cmdata, newlevel) {
  console.log("Count stat gains", cmdata, newlevel)
  const values = cmdata.levelup.values;
  console.log("values", values);
  let sgs = [];
  if (newlevel > 1) {
    // the static stat gains
    sgs.push(optionDecode(values.statgain1));
    sgs.push(optionDecode(values.statgain2));
    console.log(sgs);
  }
  // Loaded stats gains: "repeating_-NuKyptdKgIo0GHZBX4k_statgain"
  // in data.levelup.repeating,
  for (let item in values) {
    if (item.match(/repeating_.*_statgain_name/)) {
      console.log("Match", item)
      sgs.push(optionDecode(values[item]));
    }
  }

  // count elements
  let sgcount = {};
  sgs.forEach(sg => {
      if (sgcount[sg]) {
	sgcount[sg].count += 1;
      } else {
	console.log("Adding", sgcount, sg)
	sgcount[sg] = {
	  "name": sg,
	  "count": 1,
	}
      }
  });

  return sgcount;
}

onCheck("mancerfinish:levelup", (ev) => {
  const data = ev.data;
  console.log("***** Levelup Finish *****");
  console.log(data);
  pendingInfo();
  var levelstr = "Unknown";
  var newlevel = -1;

  addPendingFunction("LevelupFinish: Get current level", () => {
      getAttrsPending(["level"], (ev) => {
	  const level = parseIntDefault(ev.level, 0);
	  newlevel = level + 1;
	  levelstr = `Level ${newlevel}`; 
	  console.log("Get level", ev.level, newlevel, levelstr);
      });
  });

  // Stats
  addPendingFunction("LevelupFinish: Statgains", () => {
    let sgcount = countStatGains(getCharmancerData(), newlevel);

    for (sg in sgcount) {
      RMUStats.doStatGain(sg, sgcount[sg].count, levelstr);
    }
  });

  // Skills
  addPendingFunction("LevelupFinish: Skills", () => {
      const values = data.levelup.values;
      console.log("values", values);
      for (const purchase in values) {
	if (purchase.endsWith("_specname")) {
	  // It's the name of a specialisation; skip it and get it with 
	  // the ranks
	  continue;
	}
	// Errors and TP stuff: Ignore
	if (purchase.startsWith("lasterror")) {
	  continue;
	}
	if (purchase.startsWith("tp")) {
	  continue;
	}

	if (purchase.includes("_talent_")) {
	  continue;
	}
	if (purchase.endsWith("_skillrankscombo")) {
	  continue;
	}

	if (purchase.includes("spelllist")) {
	  // Spell list, skip it - get cmranks & listname at once.
	  continue;
	}
	if (purchase.endsWith("_sheetprefix")) {
	  // Handled later
	  continue;
	}
	if (purchase === "current_level" || purchase === "new_level") {
	  continue;
	}

	const [ranks, cost] = optionDecodeIntPair(values[purchase]);
	if (!ranks || ranks < 1) {
	  continue;
	}

	if (purchase.startsWith("repeating")) {
	  const namekey = purchase.replace(/_cmskillranks$/, "_specname");
	  const prefixkey = purchase.replace(/_cmskillranks$/, "_sheetprefix");
	  const name = values[namekey];
	  let prefix = values[prefixkey];
	  if (!prefix) {
	    let rowid = generateRowID();
	    let skillname = purchase.match(/_cmskill_([^_]*)/)
	    prefix = `repeating_specialization${skillname[1]}_${rowid}`
	  }
	  const skillattr = `${prefix}_ranks_misc`;
	  const skillname = `${prefix}_name`;
	  setAttrs({[skillname]: name}); 
	  miscAttrSet(skillattr, levelstr, ranks);
	} else {
	  // Skill is encoded as 'cmskill<name>ranks'
	  const skill = purchase.replace(/^cmskill(.*)ranks$/, '$1_ranks_misc');
	  miscAttrSet(skill, levelstr, ranks);
	}
      }
    });

    // THis is duplicated (exactly) from the start of level up.  I should make it a function
    // or something,
    const listRanks = {};
    {
      const spellRanks = {}
      const listIdsToGet = [];
      addPendingFunction('LevelupFinish: Get Ranks for spells', () => {
	// So two pieces here.  Get all the lists with ranks.  Put in an array indexed
	// by spell name. 
	// FIXME: This is in RMUSkills.lua, should sync
	const spelltypes = ['spellownbase', 'spellopen', 'spellclosed', 'spellotherbaseownrealm'];
	spelltypes.forEach(spelltype => {
	    getSectionIDsPending('spelllist' + spelltype, (ids) => {
	       ids.forEach(id => {
		   listIdsToGet.push('repeating_spelllist' + spelltype + '_' + id + '_name');
		   listIdsToGet.push('repeating_spelllist' + spelltype + '_' + id + '_ranks');
	       });
	    });
	});
      });
      // Immediataly after the prior; now get the damn things
      addPendingFunction("Levelup: Do the damn fetch", () => {
	  getAttrsPending(listIdsToGet, (nr) => {
	      // find all the _name and get the ranks from that.
	      for (nameid in nr) {
		if (!nameid.endsWith("_name")) {
		  continue;
		}
		const ranksid = nameid.replace(/_name$/, "_ranks");
		const prefix = nameid.replace(/_name$/, "");
		// So we grabbed the name, now get the basename 

		listRanks[nr[nameid]] = {
		    ranks: nr[ranksid],
		    prefix: prefix
		}
	      }
	  });
      });
    }

  // Spells; General form is:
  //repeating_-Nmw397npvJdj6tIubKP_closedspelllist_listname : "luminous elements"
  //repeating_-Nmw397q2DPZOTRTrdIQ_closedspelllist_cmranks : "0 Ranks~0:0"
  // So we skip the listname and process the cmranks
  addPendingFunction("LevelupFinish: Spells", () => {
      const values = data.levelup.values;
      for (const purchase in values) {
	if (!purchase.includes("spelllist")) {
	  // Skip non-spelllists
	  continue;
	}
	if (!purchase.endsWith("_cmranks")) {
	  // Not ranks, just skip it
	  continue;
	}
	const [ranks, cost] = optionDecodeIntPair(values[purchase]);
	if (!ranks || ranks < 1) {
	  continue;
	}
	const matches = purchase.match(/^repeating_([^_]*)_([^_]*)spelllist.*$/);
	const id = matches[1];
	const spellgroup = matches[2];
	const name = values[`repeating_${id}_${spellgroup}spelllist_listname`];

	// Look up the name in the listRanks earlier.  If so we use that - otherwise
	// generate a new list.
	if (listRanks[name]) {
	  // Found it.
	  const info = listRanks[name];
	  const spellattr = `${info.prefix}_ranks_misc`;
	  miscAttrSet(spellattr, levelstr, ranks);
	} else {
	  // generate ID and send it
	  const rowid = generateRowID();
	  const spellattr = `repeating_spelllistspell${spellgroup}_${rowid}_ranks_misc`;
	  const spellname = `repeating_spelllistspell${spellgroup}_${rowid}_name`;
	  setAttrs({[spellname]: name}); 
	  miscAttrSet(spellattr, levelstr, ranks);
	}
      }
  });


  addPendingFunction("LevelupFinish: Talents", () => {
      const values = data.levelup.values;
      for (const purchase in values) {
	if (!purchase.endsWith("_talent")) {
	  // Skip non-talents
	  continue;
	}
	const fullname = values[purchase];
	const splitname = fullname.match(/^Talent:([^?]*)?/)
	const shortname = splitname[1];
	const prefix = purchase.match(/^(.*)_talent/)[1];
	const tierstr = values[`${prefix}_tier`] || "Tier 1";
	const tier = tierstr.match(/^Tier (\d\d*)/)[1]
	const choice = values[`${prefix}_choice`];
	RMUTalents.addByName(shortname, tier, choice || "", levelstr);
      }
  });

  addPendingFunction("LevelupFinish: Save DP / New Level", () => {
      setAttrsPending({"level": newlevel});
  });
  addPendingFunction("LevelupFinish: Save DP Used", () => {
      miscAttrSet("dp_used_misc", levelstr, dpspent);
  });

  addPendingFunction("LevelupFinish: update all skills", RMUSkills.updateAllSkills);
  addPendingFunction("LevelupFinish: Set HP/PP", () => {
    getAttrsPending(["bodydevelopment_bonus", "powerdevelopment_bonus"], (data) => {
      updates = {}
      if (data.bodydevelopment_bonus) {
	updates.hp = data.bodydevelopment_bonus;
	updates.hp_max = data.bodydevelopment_bonus;
      }
      if (data.powerdevelopment_bonus) {
	let pp = Math.max(0, data.powerdevelopment_bonus);
	updates.pp = pp;
	updates.pp_max = pp;
      }
      setAttrsPending(updates);
    });
  });
  addPendingFunction("LevelupFinish: Clear Uses count", RMUSkills.usesClear);
  addPendingFunction("LevelupFinish: Front page", updateFrontPage);
  addPendingFunction("LevelupFinish: Finish cmancer (roll20)", finishCharactermancer)
  pendingInfo();
  checkPending();

});

// This is what the repeint data looks like
// repeating_-ONfZbUn0r8QihyBIw0B_cmskill_animalhandling_specializations_cmskillranks
//: "2 Ranks (8 DP)~2:8"
//repeating_-ONfZbUn0r8QihyBIw0B_cmskill_animalhandling_specializations_sheetprefix
//: 
//"repeating_specializationanimalhandling_-onfza8fbvc98-xqdnct"
//repeating_-ONfZbUn0r8QihyBIw0B_cmskill_animalhandling_specializations_specname
//: 
//"Cow Wrangling"o
// cmdata.levelup.values

function levelUpReview() {
  const cmdata = getCharmancerData();
  let newlevel = cmdata.levelup.values.current_level + 1;
  levelstr = `Level ${newlevel}`; 

  const levelup = getLevelUpSummary(cmdata);
  console.log("level up summary", levelup);

  for (const statgain in levelup.statgains) {
    const sg = getTranslationByKey(statgain)
    addRepeatingSection('levelupreviewstatgains', 'levelupreviewlistitem', (id) => {
	const str = `${sg} (x${levelup.statgains[statgain].count})`;
	setCharmancerText({[`${id} .text`]: str});
    });
  }


  for (let skill in levelup.skills) {
    const developed = levelup.skills[skill]
    let transskill = getTranslationByKey(skill)
    if (Array.isArray(developed)) {
      // deved is an array of each specialisation
      for (const obj of developed) {
	addRepeatingSection('levelupreviewskills', 'levelupreviewlistitem', (id) => {
	    const skillmsg = `${transskill}: ${obj.specialisation} &rarr; +${obj.ranks} Ranks`;
	    setCharmancerText({[`${id} .text`]: skillmsg });
	    });
      }
    } else {
      addRepeatingSection('levelupreviewskills', 'levelupreviewlistitem', (id) => {
	setCharmancerText({[`${id} .text`]: `${transskill}: +${developed.ranks} Ranks`});
      });
    }
  }

  const grouptopretty = { 
    ownbase: "Own Base",
    open: "Open",
    closed: "Closed",
    otherbaseownrealm: "Other Base (Own Realm)",
    openother: "Open Other Realm",
    closedother: "Closed Other Realm",
    otherbaseother: "Other Base Other Realm",
    arcane: "Arcane"
  }
  for (let spell in levelup.spelllists) {
    const list = levelup.spelllists[spell];
    let pretty = grouptopretty[list.group] || list.group;
    addRepeatingSection('levelupreviewspelllists', 'levelupreviewlistitem', (id) => {
	setCharmancerText({[`${id} .text`]: `${list.list} (${pretty}): ${list.ranks} Ranks`});
    });
  }

  for (let tindex in levelup.talents) {
    const talent = levelup.talents[tindex];
    addRepeatingSection('levelupreviewtalents', 'levelupreviewlistitem', (id) => {
	setCharmancerText({[`${id} .text`]: `${talent.talent} (Tier ${talent.tier})`});
    });
  }



  return;
}




/**/
function getLevelUpSummary(cmdata) {
  const level = cmdata.levelup.values.current_level + 1;

  const result = {}
  result.skills = {}
  result.spelllists = []
  result.talents = []
  result.statgains = countStatGains(cmdata, level);

  const values = cmdata.levelup.values;
  for (const purchase in values) {
    // Name of a specialisation - ignore
    if (purchase.endsWith("_specname") ||
	purchase.endsWith("_skillrankscombo") ||
	purchase.endsWith("_sheetprefix")) {
      continue;
    }
    if (purchase.includes("_talent_")) {
      if (purchase.endsWith("_talent")) {
	// The main thing: (Need to remove the "Talent" and "?expansion"
	const matches = /^(?:Talent:)([^?]*)/.exec(values[purchase]);
	const name = matches[1];
	const tierstr = values[purchase.replace(/_talent$/, "_tier")];
	let tier = 1
	if (tierstr) {
	  tier = /Tier (\d*):/.exec(tierstr)[1];
	}
	result.talents.push({talent: name, tier: tier});	
      }

    // Spell Lists
    } else if (purchase.includes("spelllist")) {
      // skip if not ranks
      if (purchase.endsWith("_listranks") || purchase.endsWith("_listname")) {
	continue;
      }
      console.log("List", purchase);
      const [ranks, cost] = optionDecodeIntPair(values[purchase]);
      if (ranks == 0) {
	continue;
      }
      // List name: 
      const namekey = purchase.replace(/_cmranks/, "_listname");
      const list = values[namekey];
      const groupmatch = purchase.match(/_([a-zA-Z]*)spelllist_cmranks/);
      let group = "Unknown";
      if (groupmatch && groupmatch[1]) {
	group = groupmatch[1];
      }
      result.spelllists.push({list: list, ranks: ranks, group: group})

    } else if (purchase.startsWith("tp")) {
      console.log("Traing Package Purchase");
    } else if (purchase.startsWith("lasterror")) {
      /// Ignore
    } else if (purchase.startsWith("errorcount")) {
      /// Ignore
    } else {
      const value = values[purchase];
      if (typeof(value) != "string") {
	continue;
      }
      const [ranks, cost] = optionDecodeIntPair(values[purchase]);
      if (!ranks || ranks < 1) {
	continue;
      }
      // So we have repeating or non-repeating: handle non -repeating first
      if (purchase.startsWith("repeating")) {
	// What is the name
	const namekey = purchase.replace(/_cmskillranks$/, "_specname");
	const name = values[namekey];
	// Prefix on the sheet
	const prefixkey = purchase.replace(/_cmskillranks$/, "_sheetprefix");
	let prefix = values[prefixkey];
	let skillname = purchase.match(/_cmskill_([^_]*)/)[1];
	  // FIXME: Is this right?  Why here?
	if (!prefix) {
	  // New skill, generate the prefix
	  let rowid = generateRowID();
	  prefix = `repeating_specialization${skillname}_${rowid}`
	}
	// Saved as array of object: { specialisation: X, ranks: N, prefix: gIbErIsH ]
	if (!result.skills[skillname]) {
	  result.skills[skillname] = [];
	}
	result.skills[skillname].push({ specialisation: name,
	      prefix: prefix, ranks: ranks})
      } else if (purchase.startsWith("cmskill")) {
	// Skill is encoded as 'cmskill<name>ranks'
	console.log("Saving: ", purchase);
	const skill = purchase.match(/^cmskill(.*)ranks$/)[1];
	if (!result.skills[skill]) {
	  result.skills[skill] = {}
	}
	result.skills[skill].ranks = ranks;
      } else {
	console.log("Ignoring not a skill: ", purchase);
      }

    }
    
  }



  return result
}

// Returns and object with:
//  name: Name of the TP
//  fulfilled: N (where N is the number fulfilled
//  percent: X (N/M %)
//  skills: [ { skill: X, ranks: N, fulfilled: true/false } ]
function getTPreport(levelupsummary, tp) {
  const report = {};
  report.skills = [];

  const developed = levelupsummary.skills;
  let fulfilled = 0
  let total = 0

  report.name = tp.name;
  for (req of tp.requires) {
    const skillreport = {}
    report.skills.push(skillreport)
    skillreport.skill = req.skill;
    skillreport.category = req.category;
    skillreport.display = req.name;
    skillreport.ranks = req.ranks;
    skillreport.fulfilled = false; // Assume for now

    console.log("Requirement", req);
    total ++;
    if (req.category) {
      let filter = false;
      if (req.skill && req.skill.startsWith("!")) {
	filter = req.skill.substring(1,999);
      }
      // Category match
      const cat = RMUSkills.getCatByDisplayName(req.category);
      if (!cat) { continue; }
      skillreport.note = `${cat.display} not ${filter}`;
      for (skill of cat.skills) {
	if (developed[skill.aname] && developed[skill.aname].ranks >= req.ranks) {
	  // We may have a +negative+ filter in the skill field
	  if (filter && skill.display == filter) {
	    console.log("Skipping filtered skill");
	    continue;
	  }
	  fulfilled ++;
	  skillreport.skill = skill.aname
	  skillreport.display = skill.display
	  skillreport.fulfilled = true;
	  break;
	}
      }
    } else {
      console.log(req.skill, developed[req.skill])
      if (developed[req.skill]) {
	const ds = developed[req.skill];
	if (ds.ranks >= req.ranks) {
	  console.log("Fulfilled requirement");
	  fulfilled ++;
	  skillreport.fulfilled = true
	}
      }
    }
  }

  report.fulfilled = fulfilled;
  report.percent = Math.floor((fulfilled / total) * 100);

  return report;
}


onCheck("clicked:dump_summary", () => {
  let levelup = getLevelUpSummary(getCharmancerData());
  console.log("Levelup summary", levelup);
  getCompendiumQuery("Category:TrainingPackage", (tps) => {
    console.log(tps);
    if (!tps) {
      console.log("No TPs found");
      return;
    }

    for (let i = 0 ; i < tps.length ; i ++) {
      let tp = tps[i];
      addRepeatingSection("tplist", 'tpitem', 'tpx', (prefix) => {
	console.log("tp.name", tp.name, typeof(tp.data.requires), tp.data.requires);
	// So lets work out how much we have of this one:
	let requires = JSON.parse(tp.data.requires)
	let meets = 0
	let needed = requires.length
	const updates = {};
	for (let i = 0 ; i < needed ; i ++) {
	  const require = requires[i];
	  if (require.skill) {
	    updates[`${prefix} .tpskill${i}`] = require.skill
	    if (levelup.skills[require.skill]) {
	      updates[`${prefix} .tphas${i}`] = '+';
	    } else {
	      updates[`${prefix} .tphas${i}`] = '-';
	    }
	  }
	}
	updates[`${prefix} .tpname`] = tp.name;
	setCharmancerText(updates);
	console.log("Set TP", updates);
      });
    }
  });

  console.log("Level Up Summary", levelup);
});











RMUStats = {}

RMUStats.statnames = ["ag", "co", "em", "in", "me", "pr", "qu", "re", "sd", "st"];
RMUStats.statfullnames = ["agility", "constitution", "empathy", "intuition", "memory", "presence",
  "quickness", "reasoning", "selfdiscipline", "strength"];
RMUStats.statIsWill = {empathy: true, intuition: true, memory: true,
	    presence: true, reasoning: true, selfdiscipline: true};
RMUStats.statfullnamesmisc = RMUStats.statfullnames.map(name => name + "_misc");
RMUStats.statfullnamespotentialsmisc = RMUStats.statfullnames.map(name => name + "_pot_misc");
RMUStats.statnamesmisc = RMUStats.statnames.map(name => name + "_misc");
// Both the fullnames and misc names together.
RMUStats.allstatmisc = RMUStats.statfullnamesmisc.concat(RMUStats.statnamesmisc,
							RMUStats.statfullnamespotentialsmisc);

    
RMUStats.getStatBonus = function(value) {
  const bonuses = [
    /* 0-9 */ -99,  -15, -14, -13, -12, -11, -10, -9, -9, -8,
    /* 10-19 */ -8, -8,  -7,  -7,  -7,  -6,  -6,  -6, -6, -6,
    /* 20-9 */ -5,  -5,  -5,  -5,  -4,  -4,  -4,  -4, -4, -4,
    /* 30-9 */ -3,  -3,  -3,  -3,  -3,  -3,  -2,  -2, -2, -2,
    /* 40-9 */ -2,  -2,  -1,  -1,  -1,  -1,  -1,  -1, 0,  0,
    /* 50-9 */ 0,   0,   0,   0,   1,   1,   1,   1,  1,  1,
    /* 60-9 */ 2,   2,   2,   2,   2,   2,   3,   3,  3,  3,
    /* 70-9 */ 3,   3,   4,   4,   4,   4,   4,   4,  5,  5,
    /* 80-9 */ 5,   5,   5,   5,   6,   6,   6,   7,  7,  7,
    /* 80-9 */ 8,   8,   8,   9,   9,   10,  11,  12, 13, 14,
    /* 100 */ +15,
  ];
  if (value < 0 || value > 100) {
    return -1;
  }
  return bonuses[value];
}

RMUStats.statgainroll = function(temp, pot) {
  let range = 0;
  let mod = 0;
  if (temp <= 6) {
    range = 3;
    mod = -1;
  } else if (temp <= 8) {
    range = 3;
  } else if (temp <= 18) {
    range = 6;
  } else if (temp <= 81) {
    range = 10;
  } else if (temp <= 90) {
    range = 6;
  } else if (temp <= 92) {
    range = 3;
  } else if (temp <= 99) {
    range = 3;
    mod = -1;
  }

  let gain = dX(range) + mod;
  if (temp + gain > pot){
    gain = pot - temp;
  }
  return gain;
}


const StatInfo = [
  { display: "Agility", aname: "agility", abbr: "Ag", attr: "ag", will: false },
  { display: "Constitution", aname: "constitution", abbr: "Co", attr: "co", will: false },
  { display: "Empathy", aname: "empathy", abbr: "Em", attr: "em", will: true },
  { display: "Intuition", aname: "intuition", abbr: "In", attr: "in", will: true },
  { display: "Memory", aname: "memory", abbr: "Me", attr: "me", will: true },
  { display: "Presence", aname: "presence", abbr: "Pr", attr: "pr", will: true },
  { display: "Quickness", aname: "quickness", abbr: "Qu", attr: "qu", will: false },
  { display: "Reasoning", aname: "reasoning", abbr: "Re", attr: "re", will: true },
  { display: "Self Discipline", aname: "selfdiscipline", abbr: "SD", attr: "sd", will: true },
  { display: "Strength", aname: "strength", abbr: "St", attr: "st", will: false },

]

function getStatNameFromAbbr(abbr) {
    if (abbr == 'rs') {
	return "Realm Stat";
    }
    for (let i = 0 ; i < StatInfo.length ; i ++) {
	if (StatInfo[i].attr == abbr.toLowerCase()){
	    // Use the translated version
	    return getTranslationByKey(StatInfo[i].aname);
	}
    }
    console.log("Could not find stat "  + abbr);
    return null;
}




// Super async - takes name of stat.  Respects pending
//  Shoukd be the fullname 'constitution'.
//  Does not update bonuses.
RMUStats.doStatGain = function(statname, count, message) {
  if (count < 1) {
    rmuerror("Invalid count for statgain", statname, count, message);
    return;
  }
  // need to gett:
  //   - stat misc
  getAttrsPending([`${statname}_misc`, `${statname}_pot_misc`], (stats) => {
      let tempraw = miscRawGetFromString(stats[`${statname}_misc`]);
      let temp = miscBonusTotal(stats[`${statname}_misc`])[0];
      const pot = miscBonusTotal(stats[`${statname}_pot_misc`])[0];
      for (let i = 0 ; i < count ; i ++) {
	let gain = RMUStats.statgainroll(temp, pot);
	let thismessage = message;
	if (count > 1) {
	  thismessage = `${message} ${i + 1}`;
	}
	tempraw = miscRawAppend(tempraw, thismessage, gain);
	temp += gain;
      }
      setAttrsPending({[`${statname}_misc`]: miscRawToString(tempraw)});
  });
}

/*

 Only considers elements starting with stat_
 and ignores any ending with _potential or _spare
 */
RMUStats.updateStatOption = function(stats) {
  var highestval = 0;
  var highest = [];
  var secondhighestval = 0;
  var secondhighest = [];

  for (const st in stats) {
    if (!st.startsWith("stat_")) {
      continue;
    }
    if (st.endsWith("_potential") || st.endsWith("_spare")) {
      continue;
    }
    const statval = parseIntDefault(stats[st], -1);
    if (statval > highestval) {
      // Save highest as second
      secondhighest = highest;
      secondhighestval = highestval;
      // reset highest
      highest = [];
      highest.push(st);
      highestval = statval;
    } else if (highestval == statval) {
      highest.push(st);
    } else if (statval > secondhighestval) {
      secondhighest = [];
      secondhighest.push(st)
	secondhighestval = statval;
    } else if (statval == secondhighestval)  {
      secondhighest.push(st);
    }
  }

  highest = highest.map((item) => item.replace("stat_", ""));
  secondhighest = secondhighest.map((item) => item.replace("stat_", ""));

  return { highest: highest, secondhighest: secondhighest };
}

/**
 * Save the stats into a misc for thec chararter.
 * 
 */
RMUStats.createStatsFinalize = function(cmdata) {
  const statsdata = cmdata.stats.values;
  let toUpdate = {}
  const statfullnames = RMUSkills.statfullnames;

  // Each stat is by key; object with temp, pot and spare
  svals = {};

  for (const stname of statfullnames) {
    let obj = {}
    obj.temp = parseIntDefault(statsdata[`stat_${stname}`],0);
    obj.pot = parseIntDefault(statsdata[`stat_${stname}_potential`], 0);
    obj.spare = parseIntDefault(statsdata[`stat_${stname}_value_spare`], 0);
    obj.misc = miscRawNew();
    miscRawSetAbsolute(obj.misc, `Temp ${obj.temp}, Pot ${obj.pot}`, obj.temp);
    obj.log = [];
    obj.log.push(`Rolled ${obj.pot}/${obj.temp}/${obj.spare}`);
    svals[stname] = obj;
  }

  for (let suffix = 1  ; suffix < 3 ; suffix ++) {
    const opt = statsdata[`cmstatoption_${suffix}`];
    console.log(`${suffix} is ${opt}`);
    switch (opt){
      case 'raiseaverage': {
	console.log("raise average", statsdata);
        const str = optionDecode(statsdata[`statraise${suffix}`]);
	let st = svals[str];
	st.temp = 56;
	st.pot = 78;
	miscRawSetAbsolute(st.misc, `Raise to average (Pot ${st.pot})`, st.temp);
	break;
      }
      case 'raise90': 
      {
	console.log(`Option ${suffix} raise 90`, statsdata);
	const str90 = optionDecode(statsdata[`stats_raise90_many_list_${suffix}`]);
	let st = svals[str90];
	st.temp = 90;
	st.pot = Math.max(Math.min(st.pot + 10, 90), 100);
	miscRawSetAbsolute(st.misc, `Raise highest to ${st.temp} (Pot ${st.pot})`, st.temp);
	console.log(`Raise ${str90} to 90`);
	break;
      }
      case 'raise85':
      {
	console.log(`Option ${suffix} raise 85`, statsdata);
	const str85 = optionDecode(statsdata[`stats_raise85_many_list_${suffix}`]);
	console.log('raising ', str85);
	let st = svals[str85];
	st.temp = 85;
	st.pot = Math.max(Math.min(st.pot + 10, 85), 100);
	miscRawSetAbsolute(st.misc, `Raise highest to ${st.temp} (Pot ${st.pot})`, st.temp);
	break;
      }
      case 'statgain':
      {
	console.log("stat gain", statsdata);
	const stg1 = optionDecode(statsdata[`statgain${suffix}a`]);
	let st1 = svals[stg1]; 
	const g1 = RMUStats.statgainroll(st1.temp, st1.pot);
	st1.temp += g1;
	miscRawAppend(st1.misc, `Creation stat gain - ${suffix} A`, g1);

	const stg2 = optionDecode(statsdata[`statgain${suffix}b`]);
	let st2 = svals[stg2]; 
	const g2 = RMUStats.statgainroll(st2.temp, st2.pot);
	st2.temp += g2;
	miscRawAppend(st2.misc, `Creation stat gain - ${suffix} B`, g2);
	break;
       }
    }
  }
  

  {

    const swapa = optionDecode(statsdata.swapa1);
    const swapb = optionDecode(statsdata.swapa2 || "none~none");
    if (swapa != 'none' && swapa != swapb) {
      const tmp = svals[swapa];
      svals[swapa] = svals[swapb];
      svals[swapb] = tmp;
      miscRawMessage(svals[swapa].misc, `Swap ${swapa} ${swapb}`);
    }
  }

  {
    const swapa = optionDecode(statsdata.swapb1);
    const swapb = optionDecode(statsdata.swapb2 || "none~none");
    if (swapa != 'none' && swapa != swapb) {
      const tmp = svals[swapa];
      svals[swapa] = svals[swapb];
      svals[swapb] = tmp;
      // FIXME: Translation
      miscRawMessage(svals[swapa].misc, `Swap ${swapa} ${swapb}`);
    }
  }


  for (const stname of statfullnames) {
    const stat = svals[stname];
    // Create a an object for the potential:
    toUpdate[`${stname}_pot_misc`] = miscBonusSet('', "Creation", stat.pot);
    toUpdate[stname] = stat.temp;
    toUpdate[`${stname}_misc`] = miscRawToString(stat.misc);
    console.log(stname, stat.temp, stat.pot, stat.log);
    // FIXME: Save the log message
  }
  console.log("stats", toUpdate);

  return toUpdate;
}


RMUStats.updateStats = function() {
  console.log('Update all stats');
  console.log(RMUStats.allstatmisc)
  let toUpdate = [];
  let willbonus = 0;
  let willLog = "";
  // For each stat; work out the the temp.
  // Then work out the bonus
  getAttrsPending(RMUStats.allstatmisc, results => {
      for (let i = 0 ; i < RMUStats.statfullnames.length ; i ++) {
	const fullname = RMUStats.statfullnames[i];
	const fullnamedisplay = getTranslationByKey(fullname);
	const abbr = RMUStats.statnames[i];
	const abbrdisplay = getTranslationByKey(abbr);
	let [temp,tlog] = miscBonusTotal(results[fullname + '_misc'], '    ');
	if (temp == 0 && !results[fullname + '_misc']) {
	  temp = 50;
	  tlog = '   50 Default';
	}
	const [pot, plog] = miscBonusTotal(results[fullname + '_pot_misc'], '    ');
	let log = `${fullnamedisplay} (${abbrdisplay}):\n`
	log += `Temporary ${temp}\n`;
	log += tlog


	// Stat bonus
	let statBonus = RMUStats.getStatBonus(temp);
	log += `${statBonus} Stat Bonus\n`;

	// Misc bonuses if any
	const [miscBonus, mlog] = miscBonusTotal(results[abbr + '_misc'])
	log += mlog

	let total = miscBonus + statBonus;
	log += `${total} Total Bonus\n\n`;

	log += `[Potential:  ${pot}\n` + plog + ']';

	toUpdate[abbr] = total;
	toUpdate[`${fullname}`] = temp;
	toUpdate[`${fullname}_info`] = log;

	// Update will
	if (RMUStats.statIsWill[fullname]) {
	  willLog += `${F(total)} ${fullnamedisplay}\n`;
	  willbonus += total;
	}
      }

      willLog += `${F(willbonus)} Total`;
      toUpdate.will = willbonus;
      toUpdate.will_info = willLog;

      setAttrsPending(toUpdate);
      console.log('Update all stats Done');
  });
}


RMUStats.statMap_ = {
  "agility": "ag",
  "constitution": "co",
  "empathy": "em",
  "intuition": "in",
  "memory": "me",
  "presence": "pr",
  "quickness" : "qu",
  "reasoning": "re",
  "selfdiscipline": "sd",
  "strength" : "st"
};
RMUStats.getStatAbbrFromName = function(name) {
  const namelower = name.toLowerCase()
  const nameSpace = namelower.replace(" ","");
  return RMUStats.statMap_[nameSpace];
}





var RMUTalents = function() {
    let x = {};

    x.applyTalentBonus = function (talentObj, tier, choice, source) {
      // Just add the bonus field to the appropriate misc field
      console.log("Apply Bonus", talentObj, source);
      // So we need to find the field - lets see if it's a skill
      let target = "";
      {
	const skill = RMUSkills.getSkillByDisplayName(choice);
	console.log('skill lookup', choice, skill)
	if (skill) {
	  target = skill.aname;
	}
      }
      // FIXME: other fall backs
      const misc = target + "_misc";
      const bonus = tier * talentObj.data.bonus;
      console.log(misc, talentObj.name + " - " + source, bonus);
      miscAttrSet(misc, talentObj.name + " - " + source, bonus);
    }

    // Handle Description Talents
    x.applyTalentDescription = function (t,T,c,s) {
      console.log("Description handled automatically... ignored");
    }

    // Handle the fun of subkskill talents.  Each of these are special
    // cases to other skills.  Perception when related to hearing for instance.
    x.applyTalentSubskill = function(talentObj, tier, choice, source) {
      console.log("Subskill talent", talentObj, tier, choice, source);
      const targets = talentObj.data.subtype.split(/\s*,\s*/);
      for (targetname of targets) {
	console.log("Looking up", targetname);
	let target = "";
	{
	  const skill = RMUSkills.getSkillByDisplayName(targetname);
	  console.log('skill lookup', targetname, skill)
	    if (skill) {
	      target = skill.aname;
	    } else {
	      target = talentObj.data.subtype;
	    }
	}
	// So we know where we are targetting: Lets jsut add the straight bonus
	const bonus = tier * parseIntDefault(talentObj.data.bonus,0);
	const id = generateRowID();
	console.log("xxx", bonus, id, target)
	  const basename = `repeating_${target}subskill_${id}`;
	console.log("basename", basename);
	setAttrsPending({[`${basename}_name`]: talentObj.data.attribute,
	    [`${basename}_bonus`]: bonus});

	console.log({[`${basename}_name`]: talentObj.data.attribute,
	    [`${basename}_bonus`]: bonus});
	// FIXME: trigger the misc
      }
    }

    x.applyTalentNotImplemented = function (t, T, c, s) {
      console.log("Unimplemented talent type", t)
    }

    x.selectTalentStat = function() {
      return RMUStats.statfullnames;
    }

    // Apply funcs apply the talent to the charactre
    // Select generate a list of options for the talent.
    //	Params for both is the the talent Obiect
    //  selet returns list
    x.talentFuncs = {
      "bonus": { apply: x.applyTalentBonus, select: x.selectTalentBonus },
      "description": { apply:  x.applyTalentDescription, },
      "subskill": { apply:  x.applyTalentSubskill, },
      "stat": { apply:  x.applyTalentNotImplemented, select: x.selectTalentStat },
      "special": { apply:  x.applyTalentNotImplemented, },
      "rr": { apply:  x.applyTalentNotImplemented, },
      "melee": { apply:  x.applyTalentNotImplemented, },
      "ranged": { apply:  x.applyTalentNotImplemented, },
      "spelllist": { apply:  x.applyTalentNotImplemented, }
    };

    x.getSelectList = function(talentObj) {
      if (x.talentFuncs[talentObj?.data?.type]?.select) {
	return x.talentFuncs[talentObj.data.type].select(talentObj);
      }
      rmuerror("No select function for ", talentObj.data.type, talentObj);
    }
 
    x.addTalent = function(talentObj, tier, choice, source) {
      console.log("Add Talent", talentObj, tier, choice, source);
      // So we use the generate ID function for this.
      // We don't have a generic place to save the talents
      const id = generateRowID();
      const basename = `repeating_talent_${id}`;
      setAttrsPending({[`${basename}_talentname`] : talentObj.name,
	      [`${basename}_description`] : talentObj.data.Description,
	      [`${basename}_tier`] : tier,
	      [`${basename}_source`] : source});

      tier = parseIntDefault(tier, 1);

      console.log(`Looking for '${talentObj.data.type} in `, x.applyFuncs);

      if (x?.talentFuncs[talentObj?.data?.type]?.apply) {
	x.talentFuncs[talentObj.data.type].apply(talentObj, tier, choice, source);
      } else {
	rmuerror("Unknown talent type:", talentObj.data.type, talentObj);
      }
    }

    x.addByName = function(talentName, tier, choice, source) {
      console.log("talent add by name: ", talentName, source);
      getCompendiumPagePending(`Talent:${talentName}`, (ev) => {
	  // FIXME: Check for errors
	  if (ev.expansion == 0) {
	    rmuerror("Talent lookup failed:", talentName, source, ev);
	    return;
	  }
	  console.log("Talent lookup success:", talentName, source, ev);
	  x.addTalent(ev, tier, choice, source);
      });
    }

    return x;
}();

onCheck("clicked:edittalents", (_) => {
    console.log("edit talent clicked");
    getAttrs(["edit_talent_toggle"], (ev) => {
	let nv = 'on';
	if (ev.edit_talent_toggle == 'on') {
	  nv = 'off';
	}
	setAttrs({edit_talent_toggle: nv});
    });
});

onCheck('clicked:talentaddstart', (_) => {
  setAttrs({toggletalentshow: 'on'});
});

onCheck('clicked:talentaddcancel', (_) => {
  setAttrs({toggletalentshow: 'off'});
});

onCheck('clicked:talentaddsave', (_) => {
  getAttrs(['talentaddname', 'talentadddescription'], (ev) => {
      if (!ev.talentaddname || ev.talentaddname.length < 1 ||
	  !ev.talentadddescription || ev.talentadddescription.length < 1) {
	rmuerror("Unable to add talent");
	return;
      }
      let obj = {}
      obj.data = {}
      obj.data.type = 'description';
      obj.name = ev.talentaddname;
      obj.data.Description = ev.talentadddescription;
      RMUTalents.addTalent(obj, 1, "", "Manual");
      setAttrs({toggletalentshow: 'off'});
  });

})






/**/

let knack_total = 0;
let pbonus_total = 0;

const powerlevels = {
  Average:  { kancks: 0,  reroll: 0,  temp: 51, pot: 76 },
  Superior: { knacks: 10, reroll: 11, temp: 56, pot: 78 },
  Heroic: { knacks: 20, reroll: 21,  temp: 61, pot: 81 },
  Legendary: { knacks: 30, reroll: 31, temp: 66, pot: 83 },
  Epic: { knacks: 40, reroll: 41,  temp: 71, pot: 86 },
};

/**
  * Target is the class to target.
  * items is a list of values.
  */
function cmPopulateListOptions(target, items, selected) {
  if (selected) {
    setCharmancerOptions(target, items, { selected: selected });
  } else {
    setCharmancerOptions(target, items);
  }
}

const knack_select_all = Array.from({length: 15}).map((_,i) => 'knack_select_' + i);

onCheck("clicked:showcharmancer", (ev) => {
  // Launchers sheet-charmancer-powerlevel
  startCharactermancer("powerlevel");

  // Get current knack and pbonus values
  pbonus_total = 0;
  knack_total = 0;
  getAttrs(Array.from({length: 15}).map((_,i) => "pbonus_select_" + i), (ev) => {
      let pbs = Object.keys(ev);
      pbs.forEach(key => {
	  if (ev[key] == 'on') {
	  pbonus_total += 1;
	  }
	  });
      });
  getAttrs(Array.from({length: 15}).map((_,i) => "knack_select_" + i), (ev) => {
      let knacks = Object.keys(ev);
      knacks.forEach(key => {
	  knack_total += parseInt(ev[key]) || 0;
	  });
	});

});

onCheck("clicked:showbuyskills", (ev) => {
  startCharactermancer("levelup");
});

function updateStatOptions() {
  const cmdata = getCharmancerData();
  const statupdate = RMUStats.updateStatOption(cmdata.stats.values);
  const highest = statupdate.highest.map((stat) => optionEncode(stat));
  const secondhighest = statupdate.secondhighest.map((stat) => optionEncode(stat));

  // Show all the things; so I can update them.  Hide them
  // during the call
  showChoices(["stats_option_raise90_many", "stats_option_raise85_many",
	"stats_option_raise90_single","stats_option_raise85_many"])

  // Highest is always riase 90.   Others are for 85 basically.
  cmPopulateListOptions("stats_raise90_many_list_1", highest);
  cmPopulateListOptions("stats_raise90_many_list_2", highest);
  if (highest.length > 1) {
    // Multiple options; set both 90 & 85 to that option
    showChoices(["stats_option_raise90_many", "stats_option_raise85_many"])
    hideChoices(["stats_option_raise90_single", "stats_option_raise85_single"]);
    cmPopulateListOptions("stats_raise85_many_list_1", highest);
    cmPopulateListOptions("stats_raise85_many_list_2", highest);
  } else {
    // Single highest; set the text for that (by class)
    setCharmancerText({stats_option_raise90_statname:
	  getTranslationByKey(statupdate.highest[0])})
    hideChoices(["stats_option_raise90_many"])
    showChoices(["stats_option_raise90_single"]);
    // deal with 85
    setCharmancerText({stats_option_raise85_statname:
	  getTranslationByKey(statupdate.secondhighest[0])})
    cmPopulateListOptions("stats_raise85_many_list_1", secondhighest);
    cmPopulateListOptions("stats_raise85_many_list_2", secondhighest);
    if (secondhighest.length > 1) {
      hideChoices(["stats_option_raise85_single"]);
      showChoices(["stats_option_raise85_many"]);
    } else {
      hideChoices(["stats_option_raise85_many"]);
      showChoices(["stats_option_raise85_single"]);
    }

  }
}

onCheck("page:race", () => {
  const cmdata = getCharmancerData();
  setCharmancerOptions("race", "Category:Race", cmdata?.race?.values?.race);
  setCharmancerOptions("culture", "Category:Culture", cmdata?.race?.values?.culture);
});

/* Select of the Race page.
  Need to handle custom selection.
*/
onCheck("mancerchange:race", (ev) => {
    if (!ev.newValue) {
      // Someone selected 'select...'.  Sigh
      showChoices(['race-no-save']);
      hideChoices(['race-no-save']);
    }

    if (ev.newValue == 'custom~custom') {
      showChoices(['custom-race-upload']);
      validateRaceProgress();
      return;
    }

    hideChoices(['custom-race-upload']);

    // Get compendium page so it gets saved for later
    getCompendiumPage(ev.newValue, (pdata) => { } );
    changeCompendiumPage('race-info', ev.newValue);

    validateRaceProgress();

});
onCheck("mancerchange:culture", (ev) => {
    // Get compendium page so it gets saved for later
    getCompendiumPage(ev.newValue, (pdata) => { } );
    changeCompendiumPage('race-info', ev.newValue);
    validateRaceProgress();
});
onCheck("mancerchange:gender", () => {
    validateRaceProgress(); 
});


// Validate if the 
function validateRaceProgress() {
  const cmdata = getCharmancerData();
  console.log(cmdata);
  const racepage = cmdata.race.values;

  // We can move on if
  //  - Race selected
  //  - Culture selected
  //  - Gender selected
  // If Race is custom, then we need to check we have a validated race
  let canProgress = true;

  if (!racepage.gender) {
    canProgress = false;
  } else if (racepage.gender != 'M' && racepage.gender != 'F') {
    canProgress = false;
  }

  // How about culture
  if (!racepage.culture) {
    canProgress = false;
  }

  // So we need a race or a custom rave
  if (!racepage.race) {
    canProgress = false;
  } else if (racepage.race == 'custom~custom') {
    if (!racepage.customrace) {
      canProgress = false;
    }
  }

  if (canProgress) {
    hideChoices(["race-no-save"]);
    showChoices(["race-save"]);
  } else {
    showChoices(["race-no-save"]);
    hideChoices(["race-save"]);
  }
}

onCheck("clicked:uploadrace", () => {
  const cmdata = getCharmancerData();
  const str = cmdata.race.values.customraceuploaddata;
  cmdata.race.data.customrace = false;
  let race = {};
  try {
    race = JSON.parse(str);
  } catch (e) {
    setCharmancerText({"uploadracemessage": `Error parsing json string: ${e.message}`});
    console.log(str);
    rmuerror({"uploadracemessage": `Error parsing json string: ${e.message}`});
    return;
  }

  // So check for the fields we need
  let result = validaterace(race)
  console.log("parse race", result);
  if (result.valid !== true) {
    setCharmancerText({"uploadracemessage": result.message});
    return;
  }
  console.log("Seeting succss");

  setCharmancerText({"uploadracemessage": `${race.name} updated successfully`});

  // Save a copy as the string
  setAttrs({customrace: str});

  setCharmancerText({"uploadracemessage": "Upload successful" });

  validateRaceProgress();
      
  return;
});

const racerequiredfields = [
  { name: "Name", type: "string" },
  { name: "content", type: "string" },
  { name: "Bonus DP", type: "number" },
  { group: "data-health",  name: "Base Hits", type: "number" },
  { group: "data-health",  name: "Recovery Mult", type: "string" },
  { group: "data-health",  name: "Endurance", type: "number" },
  { group: "data-rrs",  name: "Mentalism", type: "number", optional: true },
  { group: "data-rrs",  name: "Physical", type: "number", optional: true },
  { group: "data-rrs",  name: "Fear", type: "number", optional: true },
  { group: "data-rrs",  name: "Essence", type: "number", optional: true },
  { group: "data-rrs",  name: "Channeling", type: "number", optional: true },
  { group: "data-stats",  name: "Reasoning", type: "number", optional: true },
  { group: "data-stats",  name: "Agility", type: "number", optional: true },
  { group: "data-stats",  name: "Strength", type: "number", optional: true },
  { group: "data-stats",  name: "Memory", type: "number", optional: true },
  { group: "data-stats",  name: "Self Discipline", type: "number", optional: true },
  { group: "data-stats",  name: "Empathy", type: "number", optional: true },
  { group: "data-stats",  name: "Intuition", type: "number", optional: true },
  { group: "data-stats",  name: "Quickness", type: "number", optional: true },
  { group: "data-stats",  name: "Presence", type: "number", optional: true },
  { group: "data-stats",  name: "Constitution", type: "number", optional: true },
  { group: "data-size",  name: "Stride", type: "number" },
  { group: "data-size",  name: "Height (M)", type: "number" },
  { group: "data-size",  name: "Height (F)", type: "number" },
  { group: "data-size",  name: "Weight (M)", type: "number" },
  { group: "data-size",  name: "Weight (F)", type: "number" },
  { group: "data-size",  name: "Size", type: "string" },
  { group: "data-size",  name: "Variance", type: "number" },
];



function validaterace(prof) {
  const emsg = function(msg) { return { valid: false, message: msg };  };

  for (test of racerequiredfields) {
    let block = prof
    if (test.group) {
      block = prof[test.group];
    }
    if (block[test.name] != null) {
      // It's here... chaeck type
      if (typeof(block[test.name]) == test.type) {
	// Great
      } else {
	return emsg(`Type of ${test.name} wrong.  Expect ${test.type}, ` +
	    `got ${typeof(block[test.name])} (Value: ${block[test.name]}`);
      }
    } else if (test.optional) {
      // Optional, don't care
    } else {
      return emsg(`Missing field ${test.name}`);
    }
  }
  return { valid: true };
}


onCheck("page:profession", () => {
  const cmdata = getCharmancerData();
  setCharmancerOptions("profession", "Category:Profession",
       cmdata?.profession?.values?.profession);
  showChoices(["profession-no-save"]);
  setCharmancerText({"uploadprofessionmessage": " " });
});

onCheck("mancerchange:profession", (ev) => {

    if (!ev.newValue) {
      // Selected "select..."; pick something
      showChoices(["profession-no-save"])
      hideChoices(["profession-save"]);
      return;
    }

    if (ev.newValue == 'custom~custom') {
      console.log("Custom selected")
      showChoices(["custom-profession-upload"]);
      return;
    }

    getCompendiumPage(ev.newValue);
    showChoices(["profession-save"]);
    hideChoices(["custom-profession-upload", "profession-no-save"]);
    
});


function validateprofession(prof) {
 

  return true;
}

/**/
function cmProfessionRealmGet(cmdata) {
  return cmProfessionGet(cmdata).Realm;
}

function cmProfessionGet(cmdata) {
  const profname = cmdata.profession.values.profession
  if (profname === "custom~custom") {
    const str = cmdata.profession.values.customprofessionuploaddata;
    return JSON.parse(str);
  } else {
    return cmdata.profession.data.profession;
  }
}

onCheck("clicked:uploadprofession", () => {
  const cmdata = getCharmancerData();
  const str = cmdata.profession.values.customprofessionuploaddata;
  let prof = {};
  try {
    prof = JSON.parse(str);
  } catch (e) {
    setCharmancerText({"uploadprofessionmessage": `Error parsing json string: ${e.message}`});
    console.log(str);
    rmuerror({"uploadprofessionmessage": `Error parsing json string: ${e.message}`});
    return;
  }

  // So check for the fields we need
  if (validateprofession(prof) != true) {
    setCharmancerText({"uploadprofessionmessage": `Profession is invalid`});
    return;
  }

  console.log("pre save custom", cmdata);
  cmdata.profession.data.profession = prof;
  console.log("post save custom", cmdata);

  showChoices(["profession-save"]);
  hideChoices(["profession-no-save"]);
  setCharmancerText({"uploadprofessionmessage": "Upload successful" });
      
  return;
});


onCheck("page:realm", () => {
    const cmdata = getCharmancerData();
    realm = cmProfessionRealmGet(cmdata);
    console.log(realm, cmdata);

    if (!realm || realm == "None") {
      // Make selector visible
      showChoices(["create-profession-realm-choose"]);
      hideChoices(["create-profession-realm-selected"]);
    } else {
      showChoices(["create-profession-realm-selected"]);
      hideChoices(["create-profession-realm-choose"]);
	  // FIXME: No translation needed - it's a human readble value
      setCharmancerText({"create-profession-realm-realm": realm});
    }
});




  
onCheck("page:baselists", () => {
  const cmdata = getCharmancerData();
  const profession =  cleanCompendiumName(cmdata?.profession?.values?.profession);
  getCompendiumQuery(`Category:SpellList ListType:${profession} Base`, (lists) => {
    if (!lists || lists[0].expansion == 0) {
      // No spell lists
      showChoices(['cmbaselistsnolists', 'baselistsalwaysallow'])
      hideChoices(['cmbaselistlists', 'cmbaselistfixed', 'baselistsave', 'baselistnosave']);
      return;
    }

    const textupdates = {};
    const hideupdates = [];
    const showupdates = [];
    const attrupdates = {};
    hideupdates.push('cmbaselistsnolists');
    if (lists.length == 6) {
      showupdates.push('cmbaselistfixed');
      hideupdates.push('cmbaselistlists', 'baselistsalwaysallow', 'baselistsave', 'baselistnosave');
      // Select the first 6 automatically and move on.
      for (let i = 0 ; i < 6 ; i ++) {
	attrupdates['cmbaselistselected' + i] = 'on';
      }
    } else {
      showupdates.push('cmbaselistlists', 'baselistsave');
      hideupdates.push('cmbaselistfixed', 'baselistnosave', 'baselistsalwaysallow');
    }
    let i = 0; 
    // sort the list
    lists.sort((a,b) => { return a.name.localeCompare(b.name);});
    // Insert it
    for (i = 0 ; i < lists.length ; i ++) {
      let list = lists[i];
      textupdates[`cmbaselist${i}name`] = list.name;
      showupdates.push(`cmbaselist${i}show`);
      attrupdates['cmbaselistname' + i] = list.name;
    }
    if (i > 20) {
      rmuerror("Too many base lists for this profession", profession);
      i = 20;
    }
    for ( ; i < 20 ; i ++) {
      hideupdates.push(`cmbaselist${i}show`);
      attrupdates['cmbaselistselected' + i] = 'off';
    }
    setCharmancerText(textupdates);
    showChoices(showupdates);
    console.log("hide", hideupdates, "show", showupdates, "ee", attrupdates);
    hideChoices(hideupdates);
    setAttrs(attrupdates);
  });
});

function createBaseListsCount(cmdata) {
  const values = cmdata.baselists.values;
  let count = 0;
  for (let i = 0 ; i < 21 ; i ++) {
    const value = values['cmbaselistselected' + i];
    count += (value == 'on') ? 1 : 0;
  }
  return count;
}

/* On the baselists selection page, someone selected or cleared a selector
 * for a baselist.  Update the count and show or hide the next button based
 * on the the value (ie 6) */
onCheck(Array.from({length: 21}).map((_,i) => "mancerchange:cmbaselistselected" + i).join(' '), (_) => {
    // Get them all and count
    const cmdata = getCharmancerData();
    const count = createBaseListsCount(cmdata);
    const updates = {}
    if (count == 6) {
      showChoices(["baselistsave"]);
      hideChoices(["baselistnosave"]);
    } else {
      hideChoices(["baselistsave"]);
      showChoices(["baselistnosave"]);
    }
    updates.cmbaselistcount = count;
    setAttrs(updates);
});

onCheck("clicked:baselistsdone", () => {
    const count = createBaseListsCount(getCharmancerData()); 
    if (count == 6) {
      changeCharmancerPage("stats");
    }
});

function createSaveBaseLists() {
  const cmdata = getCharmancerData();
  const values = cmdata.baselists.values;
  const updates = {};
  for (let i = 0 ; i < 21 ; i ++) {
    const value = values['cmbaselistselected' + i];
    if (value == 'on') {
      const rowid = generateRowID();
      updates[`repeating_spelllistspellownbase_${rowid}_name`] = values['cmbaselistname' + i];
    }
  }
  console.log(updates);
  setAttrsPending(updates);
}

onCheck("page:stats", () => {
  const cmdata = getCharmancerData();
  console.log("stats page");
  console.log(cmdata);

  if (cmdata?.stats?.values?.stat_agility) {
    updateStatOptions();
  }
});

// Use the system functions to roll stats openly, not
// using JS
function systemRollStats(min, powerlevel) {
  if (!min) {
    min = 0;
  }

  const statstrs = [];
  for (let i = 0 ; i < 10; i ++) {
    statstrs.push(`{\{${RMUStats.statfullnames[i]}pot=$[[${3 * i}]]}}`)
    statstrs.push(`{\{${RMUStats.statfullnames[i]}temp=$[[${3 * i + 1}]]}}`)
    statstrs.push(`{\{${RMUStats.statfullnames[i]}spare=$[[${3 * i + 2}]]}}`)
  }

  const roll_string = "&{template:rmustatroll} " +
      //" [[ 1d100r<${min} ]] ".repeat(30) +
      `[[ 1d100r<${min} ]]`.repeat(30) +
      statstrs.join('') + '{\{powerlevel=[[0]]}}';
  console.log(roll_string);
  startRoll(roll_string, roll => {
    const rollupdates = {};
    const sheetupdates = {}
    RMUStats.statfullnames.forEach((stat) => {
      let pot = roll.results[stat + 'pot'].result
      let temp = roll.results[stat + 'temp'].result
      let spare = roll.results[stat + 'spare'].result
      console.log(stat, pot, temp, spare,roll.results);

      // Find smallest
      if (pot < spare) {
	[pot, spare] = [spare, pot];
      }
      if (temp < spare) {
	[temp, spare] = [spare, temp];
      }
      if (temp > pot) {
	[temp, pot] = [pot, temp];
      }
  
      rollupdates[stat + 'pot'] = pot;
      rollupdates[stat + 'temp'] = temp;
      rollupdates[stat + 'spare'] = spare;
      sheetupdates["stat_" + stat + "_potential"]  = pot;
      sheetupdates["stat_" + stat]  = temp;
      sheetupdates["stat_" + stat + "_value_spare"]  = spare;
    }); 
    if (powerlevel) {
      rollupdates.powerlevel = `${powerlevel} Power Level (reroll < ${min})`;
    } else {
      rollupdates.powerlevel = `Power Level reroll < ${min}`;
    }
    finishRoll(roll.rollId, rollupdates);
    addPendingFunction("Rollstats updated stats", updateStatOptions);
    setAttrsPending(sheetupdates);
  });
}

onCheck("clicked:rollstats", function(ev) {
  // Should be from charactermancer.
  const data = getCharmancerData();
  console.log(data.powerlevel);
  const powerlevel = data.powerlevel.values.powerlevel;
  let reroll = 11;
  // FIXME: use the table at the top
  switch (powerlevel) {
    case 'Average': reroll = 0; break;
    case 'Superior': reroll = 11; break;
    case 'Heroic': reroll = 21; break;
    case 'Legendary': reroll = 31; break;
    case 'Epic': reroll = 41; break;
  }
  rollStatsIncrement(data);
  systemRollStats(reroll, powerlevel);
});

function rollStatsIncrement(cmdata) {
  let count = cmdata.stats.values.rollstatcount || 0;
  count ++;
  setAttrs({rollstatcount: count});
}


onCheck("mancerchange:cmstatoption_1 mancerchange:cmstatoption_2", (ev) => {
    const sel = ev.newValue;
    const source = ev.sourceAttribute;
    const index = source.match(/\d/);

    hideChoices([`stats_option_raiseaverage_${index}`, `stats_option_raise90_${index}`, `stats_option_raise85_${index}`,
      `stats_option_statgain_${index}`]);
    const news = `stats_option_${sel}_${index}`;
    showChoices([news]);
});

onCheck("mancerchange:swapa1", (ev) => {
    const sel = ev?.newValue;
    if (!sel || !sel.endsWith("none")) {
      // Show
      showChoices(['stats_show_statswap1'])
    } else {
      hideChoices(['stats_show_statswap1'])
    }
});
onCheck("mancerchange:swapb1", (ev) => {
    const sel = ev?.newValue;
    if (!sel || !sel.endsWith("none")) {
      // Show
      showChoices(['stats_show_statswap2'])
    } else {
      hideChoices(['stats_show_statswap2'])
    }
});



function createWarning(message) {
  setAttrs({create_message:message});
}

function createKnacksFinalize() {
  // FIXME: This is wrong: Should not use CurrentProfession
  getAttrs(knack_select_all, knacks => {
      for (let i = 0 ; i < 15 ; i ++) {
      let value = parseInt(knacks['knack_select_' + i]) || 0;
      if (value < 1) continue;
      const skill = currentProfession_.skills[i];
      miscAttrSet(skill + "_misc" , "Knack", value);
      }
  });
}

function stripWeaponGroupName(name) {
  return name.replace('group', '');
}

// So the skills are combattraining1, combattraining2 etc
function createWeaponsFinalize(profession, p, s, t, q) {
  let costs = getCosts(profession);
  let update = {}

  let pcost = costs["combattraining1_cost"];
  update[stripWeaponGroupName(p) + "_cost"] = pcost;

  let scost = costs["combattraining2_cost"];
  update[stripWeaponGroupName(s) + "_cost"] = scost;

  let tcost = costs["combattraining3_cost"];
  update[stripWeaponGroupName(t) + "_cost"] = tcost;

  let qcost = costs["combattraining4_cost"];
  update[stripWeaponGroupName(q) + "_cost"] = qcost;

  setAttrs(update);
}

function knackupdatetotals() {
    const cmdata = getCharmancerData();
    const values = cmdata.knacks.values;
    let knackvalue = 0;
    let pbonuscount = 0;
    for (let i = 0 ; i < 15 ; i ++) {
      knackvalue += parseIntDefault(values['knack_select_' + i], 0);
      pbonuscount += (values['pbonus_select_' + i] == 'on') ? 1 : 0;
    }
    setCharmancerText({create_knack_total: knackvalue,
	    create_pbonus_total: pbonuscount});

    const targetknacks = powerlevels[cmdata.powerlevel.values.powerlevel].knacks;

    if (pbonuscount == 10 && knackvalue == targetknacks) {
      showChoices(["knacksave"]);
      hideChoices(["knacknosave"]);
    } else {
      showChoices(["knacknosave"]);
      hideChoices(["knacksave"]);
    }

}

onCheck(Array.from({length: 15 }).map((_,i) => "mancerchange:knack_select_" + i).join(" "),
      knackupdatetotals);
onCheck(Array.from({length: 15 }).map((_,i) => "mancerchange:pbonus_select_" + i).join(" "),
      knackupdatetotals);




function optionEncode(aname) {
  return getTranslationByKey(aname) + '~' + aname;
}

function optionDecode(dirty) {
  // Workaround for the Roll20 API change that added expansion ids to
  // strings randomly.
  const str = dirty.replace(/\?expansion=\d*$/, "");
  if (!str.includes("~")) {
    console.log("optionDecode doesn't have a ~: ", str);
    return str;
  }
  return str.split("~")[1];
}

function optionDecodeDefault(str, fallback) {
  if (!str) {
    return fallback;
  }
  return optionDecode(str);
}

function optionDecodeInt(str) {
  return parseIntDefault(optionDecodeMaybe(str), 0);
}

// Returns array of 'ranks' & 'cost'
function optionDecodeIntPair(str) {
  let pairstr = optionDecode(str);
  let items = pairstr.split(":");
  return items.map(x => parseInt(x, 10));
}

function optionDecodeMaybe(str) {
  if (!str || !str.includes("~")) {
    return str;
  }
 // Workaround for the Roll20 API change that added expansion ids to
  // strings randomly.
  const str2 = str?.replace(/\?expansion=\d*$/, "");
  return str2.split("~")[1];
}

const weaponGroups = ['meleeweaponsgroup','rangedweaponsgroup','unarmedgroup','shieldgroup'];

function updateSecondary(values) {
  let prim = optionDecodeDefault(values.primary_weapon_select, "meleeweaponsgroup");
  let sec = optionDecodeDefault(values.secondary_weapon_select, "rangedweaponsgroup");
  let trt = optionDecodeDefault(values.tertiary_weapon_select, "unarmedweaponsgroup");
  let supdate = { elemSelector: '#secondary_weapon_select', optionsArray : [] };
  // create our options array
  let options = []
  // Insert into the array each group which is not the primar
  weaponGroups.forEach(g => {
      if (prim == g) {
	// Same as the primary; don't add it
	return;
      }
      // Create item; don't set selected yet
      options.push(optionEncode(g));
  });

  // Now we need to select one, and only element
  let selected = false;
  options.every(o => {
      if (o == trt) return true;
      selected = o;
      return false;
  });
  cmPopulateListOptions("secondary_weapon_select",options, selected);
}
function updateTertiary(values) {
  let prim = optionDecodeDefault(values.primary_weapon_select, "meleeweaponsgroup");
  let sec = optionDecodeDefault(values.secondary_weapon_select, "rangedweaponsgroup");
  let trt = optionDecodeDefault(values.tertiary_weapon_select, "unarmedweaponsgroup");
  let options = []
  weaponGroups.forEach(g => {
      if (prim == g || sec == g) {
	return;
      }
      options.push(optionEncode(g));
  });

  // Now select one and only one element
  let selected = false;
  options.every(o => {
      if (o.value == trt) return true;
      selected = o;
      return false;
  });

  cmPopulateListOptions("tertiary_weapon_select", options, selected);
}


function updateQuaternary(values) {
  let prim = optionDecodeDefault(values.primary_weapon_select, "meleeweaponsgroup");
  let sec = optionDecodeDefault(values.secondary_weapon_select, "rangedweaponsgroup");
  let trt = optionDecodeDefault(values.tertiary_weapon_select, "unarmedweaponsgroup");
  weaponGroups.every(g => {
      if (g == prim) return true;
      if (g == sec) return true;
      if (g == trt) return true;
      setCharmancerText({quaternary_weapon_display:getTranslationByKey(g)});
      return false;
  });
}

onCheck("mancerchange:primary_weapon_select", (ev) => {
    const data = getCharmancerData();
    const values = data.knacks.values;
    updateSecondary(values);
    updateTertiary(values);
    updateQuaternary(values);
});

onCheck("mancerchange:secondary_weapon_select", (ev) => {
    const data = getCharmancerData();
    const values = data.knacks.values;
    updateTertiary(values);
    updateQuaternary(values);
});
onCheck("mancerchange:tertiary_weapon_select", (ev) => {
  // FIXME; this trigers when I change it in the cmancer -
  // I should look for that event and not do anything.
    const data = getCharmancerData();
    const values = data.knacks.values;
    updateQuaternary(values);
});


// Charactermancer Knacks & Weapon category selection
// We update the list of skills for knacks & proficiency bonuses
// and then update the list of primary/secondary.. weapon skills.
// The former was saved on the profession selection page (profession)
// The later is saved here; but may be empty.
onCheck("page:knacks", (ev) => {
  // Get the data object.
  const cmdata = getCharmancerData();

  // Power level to set the total of knacks etc
  const powerlevel = powerlevels[cmdata.powerlevel.values.powerlevel];
  console.log("knacks: read powerlevel", powerlevel)
  // update the total on the list
  setCharmancerText({create_knack_powerlevel_total: powerlevel.knacks});

  // set the size of the dropdown
  {
    let options = [];
    for (let i = 0 ; i <= powerlevel.knacks / 2 ; i ++) {
      options.push(`${i}~${i}`);
    }
    for (let i = 0 ; i < 15 ; i ++) {
      setCharmancerOptions(`knack_select_${i}`, options);
    }
  }

  const professiondata = cmProfessionGet(cmdata);

  // load the items
  let update = {}
  let pbonus = professiondata["data-knacks"];
  for (let i = 0 ; i < pbonus.length ; i ++) {
    
    update["pbonus_name_" + i] = getTranslationByKey(pbonus[i].knack) || pbonus[i].knack;
  }
  setCharmancerText(update);

  // Have we loaded preferences before?
  let localdata = cmdata?.knacks?.values;
  if (!localdata || !cmdata.knacks?.values?.secondary_weapon_select){
    if (!localdata) {
      localdata = {};
    }
    localdata.primary_weapon_select = "~meleeweaponsgroup";
    localdata.secondary_weapon_select = "~rangedweaponsgroup";
    localdata.tertiary_weapon_select = "~unarmedgroup";
    localdata.quaternary_weapon_display = "~shieldgroup";
  }
  updateSecondary(localdata);
  updateTertiary(localdata);
  updateQuaternary(localdata);

  knackupdatetotals();
});


function generateCostArray(coststring) {
  if (!coststring) {
    rmuerror("generateCostArray: Costs string empty");
    return [];
  }
  const costs = coststring.split('/');
  let cost1 = parseInt(costs[0]);
  let cost2 = parseInt(costs[1]);
  let costpair = cost1 + cost2
  let ar = []
  ar.push("0 Ranks~0:0");
  ar.push(`1 Rank (${cost1} DP)~1:${cost1}`);
  ar.push(`2 Ranks (${costpair} DP)~2:${costpair}`);
  return ar;
}


function arrayItemRemove(array, item) {
  const index = array.indexOf(item);
  if (index == -1) {
    return array;
  }
  array.splice(index, 1);

  return array;
}


function getCostsFromData() {
  const cmdata = getCharmancerData();
  // This is versioned - after upload I can kill the verison
  var costs = {};
  if (cmdata.profession.data.profession['data-skillCost']) {
    costs = cmdata.profession.data.profession['data-skillCost'];
  } else {
    costs = cmdata.profession.data.profession; // Just in the top level urgh
  }
  // Now do the display to aname mapping
  let acosts = {}
  for (display in costs) {
    if (display == 'Realm' || display.startsWith('data')) {
      continue;
    }
    acosts[RMUSkills.getCatByDisplayName(display)?.aname] = costs[display];
  }
  acosts.magicalritual = cmdata.profession.data.profession['data-Spellcasting']['Magic Ritual'];
  return acosts;
}


function getWeaponCosts(profdata, specialisations) {
  let weapons = ['meleeweapons', 'rangedweapons', 'unarmed', 'shield']
  const costs = {}

  const primary = stripWeaponGroupName(optionDecodeMaybe(specialisations.primary_weapon_select));
  const secondary = stripWeaponGroupName(optionDecodeMaybe(specialisations.secondary_weapon_select));
  const tertiary = stripWeaponGroupName(optionDecodeMaybe(specialisations.tertiary_weapon_select));
  console.log(primary, secondary, tertiary)

  arrayItemRemove(weapons, primary);
  arrayItemRemove(weapons, secondary);
  arrayItemRemove(weapons, tertiary);
  // Whatever is left is the quaternary option
  const quad = weapons[0];

  const tcosts = profdata['data-CombatTraining'];
  if (!tcosts) {
    rmuerror("No profession Combat training costs")
    return nil
  }
  costs[primary] = tcosts['Combat Training 1'];
  costs[secondary] = tcosts['Combat Training 2'];
  costs[tertiary] = tcosts['Combat Training 3'];
  costs[quad] = tcosts['Combat Training 4'];

  return costs;
}

/**/


// Some lores are specialised, some are not.  try and handle both.
/*
onCheck("mancerchange:create_culture_lores1 mancerchange:create_culture_lores2 " +
    "mancerchange:create_culture_lores3", "mancerchange:create_culture_lores4",
  (ev) => {
    const skill = RMUSkills.getSkillByName(ev.newValue);
    if (!skill) {
      rmuskill("Unable tp get skill", ev.newValue, ev);
      return;
    }
    const target = [ev.triggerName + "_spec_show"];
    if (skill.dynamicspecializations) {
      console.log("show", target)
      showChoices(target);
    } else {
      console.log("hide:", target)
      hideChoices(target);
    }
});*/

var specid = 1;

function cleanCompendiumName(str) {
  return str.replace(/[^:]*:/, "").replace(/\?.*/, "");
}

function saveCostData(pdata, kdata) {
  const updates = {};
  console.log("save cost data:", pdata, kdata);
  {
    const scosts = pdata['data-skillCost'];
    for (const [group, cost] of Object.entries(scosts)) {
      // Costs from compendium are not localised.
      updates[RMUSkills.getCatByDisplayNameNoTrans(group)?.aname + "_cost"] = cost;
    }
  }
  {
    const mcosts = pdata['data-Spellcasting'];
    updates.magicalritual_cost = mcosts['Magic Ritual'];
    updates.spellownbase_cost = mcosts['Base'];
    updates.spellopen_cost = mcosts['Open'];
    updates.spellclosed_cost = mcosts['Closed'];
    updates.spellrestricted_cost = mcosts['Restricted'];
    updates.spellarcane_cost = mcosts['Arcane'];
  }
  {
    const wcosts = getWeaponCosts(pdata, kdata);
    for (const [group, cost] of Object.entries(wcosts)){
      updates[`${group}_cost`] = cost;
    }
  }
  updates.costdatasaved = true;
  console.log(updates);
  setAttrsPending(updates);
}

/**/
onCheck("mancerfinish:newcharacter", (ev) => {
    const data = ev.data;
    console.log("***** Charactermancer Finish *****");
    console.log(data);
    {
      const pcount = pendingInfo();
      if (pcount > 0) {
	pendingReset();
      }
    }

    // Profession first;
    addPendingFunction("CMFinish: Profession data", () => {
      showChoices(["message-save-profession"]);
      const profession = cmProfessionGet(getCharmancerData());

      var realm = profession.Realm;
      if (realm == 'None') {
	realm = cleanCompendiumName(data.realm.values.realm);
      }
      saveCostData(profession, data.knacks.values);
      var profname = profession.Name || cleanCompendiumName(data.profession.values.profession);
      getAttrsPending(["option_xpprogression"], (xp) => {
	  let startxp = 10000;
	  if (xp.option_xpprogression) {
	    switch (xp.option_xpprogression) {
	    case "rmu" : startxp = 10000; break;
	    case "rmss" : startxp = 10000; break;
	    case "milestone" : startxp = 1; break;
	    case "ose1k" : startxp = 1; break;
	    case "ose2k" : startxp = 1; break;
	    }
	  }
	  setAttrsPending({profession: profname,
	      realm: realm,
	      powerlevel: data.powerlevel.values.powerlevel,
	      xp: startxp,
	      level: 0});
      });
    });
    // Race
    addPendingFunction("CMFinish: race data", () => {
      console.log("Set race data", data);
      showChoices(["message-save-race"]);
      if (data.race.values.race == 'custom~custom') {
	console.log(data.race.values.customrace);
	const racedata = JSON.parse(data.race.values.customrace);
	console.log("parsed", racedata);
	setAttrs({race: racedata.Name + " (Custom)", critreduction: 0});
	RMURaces.raceSet(racedata.Name, racedata);
      } else { 
       const racename = cleanCompendiumName(data.race.values.race)
	setAttrs({race: racename, critreduction: 0});
	RMURaces.raceSet(racename, data.race.data.race);
      }
    })

    addPendingFunction("CMFinish: Generate Height and Weight", () => {
	const gender = cleanCompendiumName(data.race.values.gender)
	generateHeightWeight(data.race.data.race, gender);
	setAttrs({gender: gender}); // Nothing depends - just send it
    });

    // Culture
    addPendingFunction("CMFinish: Culture data", () =>{
	showChoices(["message-save-culture"]);
	const culture = cleanCompendiumName(data.race.values.culture);

	setAttrsPending({culture: culture});
    });

    // Stats
    addPendingFunction("CMFinish: Stat data", () => {
	showChoices(["message-save-stats"]);
	const update = RMUStats.createStatsFinalize(data)
	setAttrsPending(update)
	{
	  // Not pending as it's not read by anything at all
	  setAttrs({[`repeating_statrollcount_${generateRowID()}_statrollcount`]: data.stats.values.rollstatcount});
	}
    });
    addPendingFunction("CMFinish: Stat cache", RMUSkills.updateStatCache);

    // Knacks
    addPendingFunction("CMFinish: Knacks", () => {
	const cmdata = getCharmancerData();
	const profinfo = cmProfessionGet(cmdata);
	const values = cmdata.knacks.values;
	const skills = profinfo["data-knacks"];
	const updates = {}
	for (let i = 0 ; i < skills.length ; i ++) {
	  // knack_select_${i} or pbonus_select_${i}
	  const knack = parseIntDefault(values[`knack_select_${i}`], 0);
	  if (knack > 0){
	    // FIXME: Should fetch and set together.
	    // races.js has a good example
	    miscAttrSet(skills[i].knack + "_misc", "Knack", knack);
	  }
	  if (values[`pbonus_select_${i}`] == 'on') {
	    updates[`${skills[i].knack}_pbonus`] = 1;
	  }
	}
	setAttrsPending(updates);
    });

    // Culture Development
    addPendingFunction("CMFinish: Culture ranks", () => {
	RMUCultures.createCultureFinalize(
	    cleanCompendiumName(data.race.values.culture),
	    getCharmancerData());
    });

    // FIXME The specranks in cultures could use this
    function addLanguage(culture, name, ranks) {
      const rid = generateRowID();
      const gid = `repeating_specializationlanguage_${rid}`
      miscAttrSet(`${gid}_ranks_misc`, culture, ranks);
      setAttrsPending({[`${gid}_name`]: name});
    }

    addPendingFunction("CMFinish: Culture Language Ranks", () => {
	lr = getCharmancerData().languages.values;
	const culture = cleanCompendiumName(getCharmancerData().race.values.culture);
	const prefix = `create_culture_languages_lang`
	for (let i = 1 ; i <= 4 ; i ++) {
	  const wr = parseIntDefault(lr[`${prefix}${i}w`], 0);
	  const sr = parseIntDefault(lr[`${prefix}${i}s`], 0);
	  let name = lr[`${prefix}${i}name`];
	  if (!name || typeof(name) != 'string' || name.length < 1) {
	    if (i == 1) {
	      name = 'Language (Native)';
	    } else {
	      name = `Language #${i}`;
	    }
	  }
	  if (sr > 0) {
	    addLanguage(culture, `${name} - S`, sr);
	  }
	  if (wr > 0) {
	    addLanguage(culture, `${name} - W`, wr);
	  }
	}
    });

    addPendingFunction("CMFinish: Save base lists", createSaveBaseLists);

    addPendingFunction("CMFinish: update all skills", RMUSkills.updateAllSkills);
    addPendingFunction("CMFinish: Front page", updateFrontPage);

    addPendingFunction("CMFinish: Set PP and HP to some initial values", () => {
	getAttrsPending(['pp', 'hp_max', 'pp_max'], (v) => {
	    const update = {}
	    update.pp = v.pp_max || 0;
	    update.hp = v.hp_max || 0;
	    update.injurypenalty = 0;
	    update.hppenalty = 0;
	    update.fatigue = 0;
	    VrmuSetAttrs(update);
	});
    });
    addPendingFunction("CMFinish: Set character created flag", () => {
	setAttrsPending({charactercreated: 'true', flag_cmancer_show: '0'});
    });
    addPendingFunction("CMFinish: Finish cmancer (roll20)", finishCharactermancer)
    addPendingFunction("CMFinish: Log all done", () => { console.log("All done") })
    pendingInfo();
    checkPending();
});






console.log("cultures loaded");
let RMUCultures = {}



RMUCultures.selectedSkillInfo = {
  animalhandling : "specranks",
  riding : "specranks",
  perception : "ranks",
  tracking: "ranks",
  maneuveringinarmor: "ranks",
  bodydevelopment: "ranks",
  weighttraining: "ranks",
  unarmed: "choose",
  meleeweapons: "choose",
  rangedweapons: "choose",
  compositionperf: "select",
  craftingvocation: "select",
  navigation: "ranks",
  piloting: "specranks",
  survival: "choose",
  acrobatics: "ranks",
  jumping: "ranks",
  languages: "languages",
  regionown: "specranks",
  regionneighbour: "specranks",
  religionphilosophy: "specranks",
  lores: "select",
  herbalism: "ranks",
  medicine: "ranks",
  climbing: "ranks",
  running: "ranks",
  swimming: "ranks",
  influence: "choose",
  socialawareness: "ranks",
  trading:"ranks",
  concealment: "ranks",
  stalking: "ranks",
}

RMUCultures.cultureSkillsOrder = [
  "animalhandling",
  "riding",
  "perception",
  "tracking",
  "maneuveringinarmor",
  "bodydevelopment",
  "weighttraining",
  "unarmed",
  "meleeweapons",
  "rangedweapons",
  "compositionperf",
  "craftingvocation",
  "navigation",
  "piloting",
  "survival",
  "acrobatics",
  "jumping",
  "languages",
  "regionown",
  "regionneighbour",
  "religionphilosophy",
  "lores",
  "herbalism",
  "medicine",
  "climbing",
  "running",
  "swimming",
  "influence",
  "socialawareness",
  "trading",
  "concealment",
  "stalking",
]

RMUCultures.getCulture = function(name) {
  return RMUCultures.cultures[name];
}


/** Event for charactermancer selecting culture
 */
onCheck("page:culture", (ev) => {
    // Get the data object.
    const data = getCharmancerData(); 

    // get the culture
    const culture = data.race.data.culture['data-skills'];
    console.log("The culture ranks", culture);

    // Build a named index
    let skills = {}
    culture.forEach((sk) => {
	skills[sk.skill] = sk.ranks;
    });

    let showList = [];
    let attrs = {}

    // Loop through in the select skill order
    RMUCultures.cultureSkillsOrder.forEach((name) => {
      const ranks = skills[name];
      if (!ranks) {
	return;
      }
      const prefix = 'create_culture_' + name;
      const selectedInfo = RMUCultures.selectedSkillInfo[name];
      if (selectedInfo == 'ranks' || selectedInfo == 'choose' || selectedInfo == 'specranks' ||
	  selectedInfo == 'languages') {
	// Easy; just ranks
	showList.push(prefix + "_show");
	attrs[prefix + '_ranks'] = ranks;
	// FIXME: Languages need to use setAttrs
      } else if (selectedInfo == 'select') {
	showList.push(prefix + "1_show");
	attrs[prefix + '1_ranks'] = Math.min(2, ranks);
	if (ranks > 2) {
	  showList.push(prefix + "2_show");
	  attrs[prefix + '2_ranks'] = Math.min(2, ranks - 2);
	}
	if (ranks > 4) {
	  showList.push(prefix + "3_show");
	  attrs[prefix + '3_ranks'] = Math.min(2, ranks - 4);
	} 
	if (ranks > 6) {
	  showList.push(prefix + "4_show");
	  attrs[prefix + '4_ranks'] = Math.min(2, ranks - 6);
	}
      } else {
	console.log("Unable to find type for culture skill");
      }

    });

    setCharmancerText(attrs);
    showChoices(showList);

    //	- does it need a selection?

    //	- show specialisation options if so,
    //	- otherwise add to generic list
});


RMUCultures.nlangchoices = 4;

RMUCultures.langchoicesnames = Array.from({length: RMUCultures.nlangchoices * 2}, (v, i) =>{
      return (i % 2) ?
      "create_culture_languages_lang" + (Math.floor(i/2) + 1) + "s" :
      "create_culture_languages_lang" + (Math.floor(i/2) + 1) + "w"});


function langranksselected(donefn) {
  getAttrs(RMUCultures.langchoicesnames, donefn)
}

RMUCultures.getLanguageRanksSum = function (values) {
  let total = 0;
  for (const ranks in values) {
    if (ranks.startsWith('create_culture_languages') && !ranks.endsWith("_spend")) {
      total += parseInt(values[ranks]) || 0;
    }
  }
  return total;
}

function langranksselectedtotal(donefn) {
  const cmdata = getCharmancerData();
  let total = RMUCultures.getLanguageRanksSum(cmdata.languages.values);
  donefn(total);
}


const changes = Array.from(RMUCultures.langchoicesnames,
    (v, i)=>{ return "mancerchange:" + v }).join(" ");
onCheck(changes, (event) => {
  langranksselectedtotal((total)=> {
    setCharmancerText({"create_language_spent": total});
  });
});


onCheck("mancerchange:create_culture_lores1 mancerchange:create_culture_lores2 " +
"mancerchange:create_culture_lores3 mancerchange:create_culture_lores4 " +
"mancerchange:create_culture_craftingvocation1 mancerchange:create_culture_craftingvocation2 " +
"mancerchange:create_culture_craftingvocation3 mancerchange:create_culture_craftingvocation4", (ev) => {
    console.log("change: ", ev);
    const selected = ev.newValue;
    const skill = RMUSkills.getSkillByName(selected);
    if (!skill) {
      rmuerror("Unable to find skill", selected);
      return;
    }
    if (skill.dynamicspecializations) {
      showChoices([`${ev.sourceAttribute}_spec_show`]);
    } else {
      hideChoices([`${ev.sourceAttribute}_spec_show`]);
    }
});





RMUCultures.handleSelect = function(culturename, name, selected, specialisation, ranks) {
  //console.log("&&&& Handle Select", culturename, name, selected, specialisation, ranks);
  const skill = RMUSkills.getSkillByName(selected);
  if (!skill) {
    rmuerror("Unable to find skill:", selected, "handleSelect", culturename,name, selected, specialisation, ranks);
    return;
  } else if (skill.dynamicspecializations) {
    const rid = generateRowID();
    const prefix = `repeating_specialization${selected}_${rid}_`;
    setAttrsPending({[`${prefix}name`]: specialisation});
    miscAttrSet(`${prefix}ranks_misc`, culturename, ranks);
  } else {
    miscAttrSet(`${selected}_ranks_misc`, culturename, Math.min(2, ranks));
  }
}



/**/

onCheck("page:languages", (_) => {
    const cmdata = getCharmancerData();

    const culture = cmdata.race.data.culture['data-skills'];
    // Find languages
    let ranks = 0;
    culture.forEach((sk) => {
	if (sk.skill == 'languages')  {
	  ranks = parseInt(sk.ranks);
	}
    });
    
    if (ranks == 0) {
      rmuerror("Unable to find language ranks", culture);
      return;
    }

    setCharmancerText({"create_language_available": ranks});
});


RMUCultures.createCultureFinalize = function (culturename, cmdata) {
  console.log("Saving culture ranks");
  console.log("Culture is ", culturename);
  const culture = cmdata.race.data.culture['data-skills'];
  // Build a named index
  let skills = {}
  culture.forEach((sk) => {
      skills[sk.skill] = sk.ranks;
  });
  
  const savedCultureName = `Culture (${culturename})`;
  RMUCultures.cultureSkillsOrder.forEach((name) => {
    const ranks = skills[name];
    if (!ranks) {
      // No ranks, nothing to do.
      return;
    }
    const selectedInfo = RMUCultures.selectedSkillInfo[name];
    console.log(selectedInfo, name);
    // If it's just ranks we can apply immediately
    if (selectedInfo == 'ranks') {
      miscAttrSet(name + '_ranks_misc', savedCultureName, ranks);
    } else if (selectedInfo == 'specranks')   {
      //so add the new specialisation; get the name or a default
      let givenname = cmdata.culture.values[`${name}_name`];
      if (!givenname) {
	if (name == 'regionown') {
	  givenname = "Own Region";
	} else if (name == 'NieghbourRegion') {
	  givenname = "Neighbouring Region";
	} else {
	  givenname = "Skill";
	}
      }
      const rid = generateRowID();

      // Special case:
      //  regionown, regionneighbour need to become regionlore
      if (name == 'regionown' || name == 'regionneighbour') {
	name = 'regionlore';
      }
      const prefix = `repeating_specialization${name}_${rid}_`
      setAttrsPending({[`${prefix}name`]: givenname});
      miscAttrSet(`${prefix}ranks_misc`, culturename, ranks);
    } else if (selectedInfo == 'choose')   {
      /// So select is 'undefined'
      // Get the selection
      console.log("choose", name, cmdata.culture.values);
      console.log("looking for ", `create_culture${name}_select`);
      let select = cmdata.culture.values[`create_culture${name}_select`]
      console.log(`${select}_ranks_misc`, savedCultureName, ranks);
      miscAttrSet(`${select}_ranks_misc`, savedCultureName, ranks);
    } else if (selectedInfo == 'select')   {
      // Up 8 if the bloody things (lores and the like)
      const selname = cmdata.culture.values[`create_culture_${name}1`];
      RMUCultures.handleSelect(savedCultureName, name, selname,
	   cmdata.culture.values[`${name}1_name`], Math.min(2, ranks));
      if (ranks > 2) {
	const selname = cmdata.culture.values[`create_culture_${name}2`];
	RMUCultures.handleSelect(savedCultureName, name, selname,
	    cmdata.culture.values[`${name}2_name`], Math.min(2, ranks - 2));
      }
      if (ranks > 4) {
	const selname = cmdata.culture.values[`create_culture_${name}3`];
	RMUCultures.handleSelect(savedCultureName, name, selname,
	      cmdata.culture.values[`${name}3_name`], Math.min(2, ranks - 4));
      }
      if (ranks > 6) {
	const selname = cmdata.culture.values[`create_culture_${name}4`];
	RMUCultures.handleSelect(savedCultureName, name, selname,
	      cmdata.culture.values[`${name}4_name`], Math.min(2, ranks - 6));
      }
    } else if (selectedInfo == 'languages')   {
      // languages
      console.log("WARNING: Did not save ", name,culturename);
    } else {
      console.log("WARNING: Did not save ", name, culturename);
    }
  });

  pendingInfo();
  console.log("Culture ranks done");
}


console.log("done cultures");



// - Maybe call this Movement

// Update all the crud on the frontpage of the charcter sheet.  
//
// Most of this should only need updating adter a notable change; like levling update.

// 
//   character.
/*
•Base Movement Rate is equal to 20'/round modified by half Quickness bonus (round up) and a stride modifier based on race (or height if the Individual Stride option is used).
•Skill Bonuses are summed from stat bonuses, rank bonuses from training, professional bonuses, knacks, and special modifiers such as talents.
•Hits are equal to the Base Hits for the character’s race, plus the Body Development skill bonus. For Small characters, multiply this total by 0.75. For Big characters, multiply it by 1.5. For characters who are sizes other than Small, Medium, and Big, see Table 9-4a.
•Defensive Bonus is equal to 3x the Quickness stat bonus.
•Endurance is equal to the Body Development skill bonus plus the endurance modifier for the charac- ter’s race.
•Encumbrance is given as a percentage of body weight. Add total equipment weight as a percent- age and any armor encumbrance (see Section 5.4 for more information).
•Equipment is purchased by the character with start- ing money (see Chapter 6 for equipment costs and suggestions for starting money depending on the tone of the campaign).
•Initiative bonus is equal to the character’s Quick- ness stat bonus.
•Power Points are equal to the character’s Power Development skill bonus.
*/

/*
	    { "Weight allowance", "weightallow" }, -- 15% weight+ 2 * st
	    { "Carried", "carried" }, -- carried weight 
	    { "Enc Penalty", "encpenalty" }, -- enc% - Wt Allowance
	    { "Max Pace", "maxpace" }, -- table 5-3
	    { "Maneuver Penalty", "manpenalty" }, -- enc penglty = armor penlty
	    -- More misc stuff
	    { "Base Move (BMR)", "bmr" },   20'round + ceil(Qu/2) + race.stride
	    { "Initiative", "initiative" },
	    { "Power", "pp" },	PP 
	    { "Size", "size" }, Race

*/

frontpage = {}

/* Weight allowance is here.  Encumberance and the maneuver penalty is
   in inventory. */
frontpage.updateWeightAllowance = function () {
  getAttrsPending(["st", "weight"], (ev) => {
      let st = parseIntDefault(ev.st, -10);
      let st2 = st * 2;
      let weight = parseIntDefault(ev.weight, 100);

      let pcent = 15 + st2;
      let wa = Math.floor(weight * pcent / 100);
      if (wa < 0) wa = 0;
      let info = `Weight Allowance\n` +
	    `${weight} Weight\n` +
	    `${pcent}%  (15 + 2st)% of Weight\n` +
	    `    ${weight} Weight\n` +
	    `    ${st2}  Twice Strength\n` +
	    `= ${wa}  Weight Allowance (Min 0)\n`;

      setAttrsPending({weightallowance: wa, weightallowance_info: info});
  });
}
onCheck("change:st change:weight", frontpage.updateWeightAllowance);

frontpage.updateMaxPace = function () { console.log("update Max pace Not Implemented") }
frontpage.updateBMR = function () {
  console.log("Update BMR");
  getAttrsPending(["bmr_misc", "qu"], (ev) => {
    let log = F(20) + " Starting movement\n";
    let [total, mlog] = miscBonusTotal(ev.bmr_misc, "");
    log += mlog;
    let qb = Math.floor(parseIntDefault(ev.qu, 0) / 2);
    total += qb + 20;
    log += `${F(qb)}  Quickness / 2\n`
    log += `${T(total)} Total Movement`
    setAttrsPending({bmr: total, bmr_info: log});
  });
}

frontpage.updateInit = function () { 
  // FIXME: Not taking into accoutn MM penalty
  // Initiative is 2d10 + Qu - 1/10 penalty
  getAttrsPending(["qu"], (ev) => {
      setAttrsPending({initiative: ev.qu});
  });
}
onCheck("change:qu", frontpage.updateInit);

frontpage.updateFeatsOfStrength = function () {
  const feats = [
    { name: 'strfeat_routine', percent: 20, bonus: 30 },
    { name: 'strfeat_easy', percent: 30, bonus: 20 },
    { name: 'strfeat_light', percent: 40, bonus: 10 },
    { name: 'strfeat_medium', percent: 50, bonus: 0 },
    { name: 'strfeat_hard', percent: 70, bonus: -10 },
    { name: 'strfeat_veryhard', percent: 100, bonus: -20 },
    { name: 'strfeat_exthard', percent: 150, bonus: -30 },
    { name: 'strfeat_sheerfolly', percent: 200, bonus: -50 },
    { name: 'strfeat_absurd', percent: 300, bonus: -70 },
    { name: 'strfeat_nighimpossible', percent: 400, bonus: -100 },
  ]


  getAttrsPending(["weighttraining_bonus", "weight"], (data) => {
    const weight = parseIntDefault(data.weight, -100);
    const weightbonus = parseIntDefault(data.weighttraining_bonus, -100);
    const updates = {}

    for (var i = 0 ; i < feats.length ; i ++) {
      const thisfeat = feats[i];
      const bonus = thisfeat.bonus + weightbonus;
      const limit = Math.floor(thisfeat.percent * weight / 100);
      const str = `${bonus} (${limit} lbs)`;
      updates[thisfeat.name] = str;
    }
    setAttrsPending(updates);
  });
}

function F(num) {
  if (typeof(num) != 'number') {
    rmuerror("F got passed a ", typeof(num), num);
    return '   ';
  }
  return num.toString().padStart(3, ' ')
}

function T(num) { // total
  if (typeof(num) != 'number') {
    rmuerror("T got passed a ", typeof(num), num);
    return '   ';
  }
  return num.toString().padStart(3, ' ')
}

frontpage.updateDB = function () {
  console.log("db update");
  addPendingFunction("Update DB", () => {
  getAttrsPending(["qu", "db_misc", "running_bonus", "running_ranks",
		  "shield_bonus", "shield_ranks", "dbmod",
		  "shield_type_bonus", "shield_type_nattacks",
		  "encumberance_penalty",
		  "option_dbqumultiplier", "option_dodgerunningbonus"], (ev) => {
    console.log("DB Update", ev);
    var updates = {};
  
    // First check for our two options and set
    const optionqumiltiplier = parseIntDefault(ev.option_dbqumultiplier, 3)
    // True if set and set to 'ranks'
    const optiondodgeranks = (ev.option_dodgerunningbonus && ev.option_dodgerunningbonus == 'ranks') ?
	true : false;

    const db_extra = miscBonusTotal(ev.db_misc || "")[0];
    const dbmiscmod = parseIntDefault(ev.dbmod, 0);
    const basedb = +ev.qu * optionqumiltiplier + db_extra + dbmiscmod;
    updates.db_base = basedb;
    const encump = parseIntDefault(ev.encumberance_penalty, 0);
    updates.db_qu = basedb;

    updates.db_info = `${F(ev.qu) * optionqumiltiplier}  Quickness * ${optionqumiltiplier}\n` +
	  `${F(dbmiscmod)}  DB Misc Mod\n` +
	  `${F(db_extra)}  DB Extta\n` +
	  `${T(basedb)}  Base DB`;


    
    const runningranks = parseIntDefault(ev.running_ranks, 0);
    const passivedodgebonus = Math.min(Math.max(0, runningranks + encump), 50)
    const passivedodgebonusmissile = Math.min(Math.floor(passivedodgebonus / 2), 50);

    const shield_ranks = Math.max(0, parseIntDefault(ev.shield_ranks, 0));
    const shielddb = parseIntDefault(ev.shield_type_bonus, 0);
    const passiveblockbonus = Math.min(50, shielddb + shield_ranks)

    updates.db_passivedodge = basedb + passivedodgebonus;
    updates.db_passivedodgemissile = basedb + passivedodgebonusmissile;
    {
      const pd2 = Math.floor(passivedodgebonus / 2);
      updates.db_passivedodge_info = "Passive Dodge\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(passivedodgebonus)} Passive Dodge (Max 50)\n` +
				     `    ${F(runningranks)} Running Ranks\n` +
				     `    ${F(encump)} Encumberance penalty\n` +
				     `${F(updates.db_passivedodge)}\n\n` +
				     "Passive Dodge vs Missile\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(passivedodgebonusmissile)} Passive Dodge ½ (Max 50)\n` +
				     `    ${F(runningranks)} Running Ranks\n` +
				     `    ${F(encump)} Encumberance penalty\n` +
				     `${T(updates.db_passivedodgemissile)}`;
    }

    const running_bonus = (optiondodgeranks) ? 
		RMUSkills.getSkillBonus(runningranks, false) :
		+ev.running_bonus;
    {
      const partial_dodge_bonus = Math.max(0, Math.floor(running_bonus / 2 + encump));
      const partial_dodge_bonus_missile = Math.floor(partial_dodge_bonus / 2);
      updates.db_partialdodge = basedb + partial_dodge_bonus;
      updates.db_partialdodgemissile = basedb + Math.floor(partial_dodge_bonus / 2);
      updates.db_partialdodge_info = "Partial Dodge\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(partial_dodge_bonus)} Partial Dodge Bonus x ½\n` +
				     `    ${F(running_bonus)} Running Bonus\n` +
				     `    ${F(encump)} Encumberance penalty\n` +
				     `${T(updates.db_partialdodge)}  Total\n\n` +
				     "Partial Dodge vs Missile\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(partial_dodge_bonus_missile)} Partial Dodge Bonus x ¼\n` +
				     `    ${F(running_bonus)} Running Bonus\n` +
				     `    ${F(encump)} Encumberance penalty\n` +
				     `${T(updates.db_partialdodge)} Total`;

    }

    {
      const full_dodge_bonus = Math.max(0, running_bonus + encump);
      const full_dodge_bonus2 = Math.floor(full_dodge_bonus / 2);
      updates.db_fulldodge = basedb + Math.max(0, running_bonus + encump);
      updates.db_fulldodgemissile = basedb +
	      Math.floor(Math.max(0, running_bonus + encump) / 2);
      updates.db_fulldodge_info = "Full Dodge\n" +
				  `${F(basedb)} Base DB\n` +
				  `${F(full_dodge_bonus)} Dodge Bonus\n` +
				  `    ${F(running_bonus)} Running Bonus\n` +
				  `    ${F(encump)} Encumberance penalty\n` +
				  `${T(updates.db_fulldodge)}  Total\n\n` +
				  "Full Dodge vs Missile\n" +
				  `${F(basedb)} Base DB\n` +
				  `${F(full_dodge_bonus2)} Full Dodge Bonus x ½\n` +
				  `    ${F(running_bonus)} Running Bonus x ½\n` +
				  `    ${F(encump)} Encumberance penalty\n` +
				  `${T(updates.db_fulldodgemissile)} Total`;
    }

    updates.db_shield = basedb + shielddb;
    updates.db_shield_attacks = (ev.shield_type_nattacks > 0) ?
	  ev.shield_type_nattacks : "-";

    
    {
      updates.db_passiveblock = basedb + passiveblockbonus;
      updates.db_passiveblock_info = "Passive Block\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(shielddb)} Shield DB\n` +
				     `${F(shield_ranks)} Shield Ranks`; 
    }
    const shield_bonus = parseIntDefault(ev.shield_bonus, 0);
    {
      const sb2 = Math.floor(shield_bonus / 2);
      updates.db_partialblock = basedb + shielddb + runningranks + 
		  Math.round(Math.max(0, sb2) / 2) + passivedodgebonus;
      console.log("Partial block", updates.db_partialblock, basedb, shielddb, runningranks,
	   Math.round(Math.max(0, sb2) / 2), passivedodgebonus);
      updates.db_partialblock_info = "Partial Block\n" +
				     `${F(basedb)} Base DB\n` +
				     `${F(runningranks)} Passive dodge\n` +
				     `${F(shielddb)} Shield DB\n` +
				     `${F(sb2)} Shield bonus x ½ (min 0)\n` +
				     `${F(passivedodgebonus)} Passive Dodge`;
    }

    {
      updates.db_fullblock = basedb + shielddb + runningranks + Math.max(0, shield_bonus) + passivedodgebonus;
      updates.db_fullblock_info = "Full Block\n" +
				  `${F(basedb)} Base DB\n` +
				  `${F(runningranks)} Passive dodge\n` +
				  `${F(shielddb)} Shield DB\n` +
				  `${F(shield_bonus)} Shield bonus (min 0)\n` +
				  `${F(passivedodgebonus)} Passive Dodge`;
    }

    {
      updates.db_flatfooted = 0;
      updates.db_flatfooted_info = "Flatfooted";
    }
    {
      updates.db_surprised = 0;
      updates.db_surprised_info = "Surprised";
    }

    setAttrsPending(updates);
  })
  });

  addPendingFunction("Update Defense Mode", updateCurrentDefenseMode);
  pendingInfo();
  checkPending();
}
onCheck("change:qu change:db_misc change:running_bonus change:running_ranks " +
  "change:shield_bonus change:shield_ranks change:shield_type_bonus " +
  "change:encumberance_penalty change:dbmod", frontpage.updateDB);


onCheck("change:weighttraining_bonus change:weight", (ev) => {
  console.log("weight training change");
    addPendingFunction("Derived: Update feats of strength", frontpage.updateFeatsOfStrength);
    checkPending();
});

onCheck("change:st", (ev) => {
    addPendingFunction("Derived: Weight Allowance", frontpage.updateWeightAllowance);
    checkPending();
});

onCheck("change:qu change:bmr_misc", (ev) => {
    addPendingFunction("Derived: Update BMR", frontpage.updateBMR);
    checkPending();
});


function updateFrontPage() {
  pendingInfo();
  addPendingFunction("Update frontpage.updateWeightAllowance();",   frontpage.updateWeightAllowance);
  addPendingFunction("Update frontpage.updateMaxPace();",   frontpage.updateMaxPace);
  addPendingFunction("Update frontpage.updateBMR();",   frontpage.updateBMR);
  addPendingFunction("Update frontpage.updateInit();",   frontpage.updateInit);
  addPendingFunction("Update frontpage.updateFeatsOfStrength();",   frontpage.updateFeatsOfStrength);
  addPendingFunction("Update frontpage.updateDB();",   frontpage.updateDB);
  addPendingFunction("Update RMUInventory.updateEquipped();",   RMUInventory.updateEquipped);
  checkPending();
}
onCheck("clicked:updatederived", updateFrontPage);

/**
 * Given a race structure, generate the height and weight for
 * a member of that race
 */
function generateHeightWeight(race, gender) {
  if (!race) { rmuerror("Must supply race"); return false; }
  if (!race['data-size']) { rmuerror("Race has no data/size"); }
  const rsize = race['data-size'];
  if (!rsize['Height (M)']) { rmuerror("Race has no M height"); }
  if (!rsize['Height (F)']) { rmuerror("Race has no F height"); }
  if (!rsize['Weight (M)']) { rmuerror("Race has no M weight"); }
  if (!rsize['Weight (F)']) { rmuerror("Race has no F weight"); }
  // FIXME: Once the variance is updated; fix this.
  const variance = 4;
    
  if (!rsize.Size) { rmuerror("Must have a size"); return false; }
  if (!rsize.Stride) { rmuerror("Must have a stride"); return false; }

  let updates = [];

  // Height variance
  let hv = 0;
  if (rsize.Size == 'S') {
    hv = dX(10) - 5;
  } else if (rsize.Size == 'M'){
    hv = dX(10) + dX(10) - 11;
  } else {
    hv = dX(10) + dX(10) + dX(10) - 16;
  }

  // Work out build and the build variance
  const br = dX(10);
  let bv = 0;
  if (br < 4) {
    updates.build = "Light";
    bv = -dX(10) - dX(10) - dX(10);
  } else if (br < 8) {
    updates.build = "Medium";
    bv = dX(10) + dX(10) - 11;
  } else {
    updates.build = "Heavy";
    bv = dX(10) + dX(10) + dX(10);
  }

  let height = 0;
  let weight = 0;
  if (gender.substring(0, 1).toLowerCase() == 'm') {
    height = parseInt(rsize['Height (M)']);
    weight = parseInt(rsize['Weight (M)']);
  } else {
    height = parseInt(rsize['Height (F)']);
    weight = parseInt(rsize['Weight (F)']);
  }
  let vheight = height + hv;
  let vweight = weight + hv * variance;
  vweight = Math.floor(vweight * (1 + (bv / 100)));

  updates.weight = vweight;
  updates.height = vheight;

  // Individual stride (based on height variance)
  let istride = Math.floor(hv / 6);

  getAttrsPending(["bmr_misc"], (ev) => {
      let bmr = ev.bmr_misc || [];
      bmr = miscBonusSet(bmr, "Individual Stride", istride);
      setAttrsPending({"bmr_misc": bmr});
  });


  updates.height_info = 
    "Height and Weight:\n" +
    `Racial Height: ${height}\n` +
    `Variance roll: ${hv}\n` +
    `Final Height: ${vheight}\n` +
    `Racial Weight: ${weight}\n` + 
    `Build is ${updates.build} (${bv}%)\n` +
    `Final Weight: ${vheight}\n` +
    `Raacial Stride ${rsize['Stride']}`

  setAttrsPending(updates);
}


/* vim: set sw=2 sts=2 syn=javascript : */

// Items have the following fields - only
// P is the prefix
//  P_itemname, itemweight, itemcount, itemsystem, itemmaterial, itemnotes, \

// External methods go here
let RMUInventory = {}

RMUInventory.itemfields = [ "itemname", "itemweight", "itemcount", "itemsystem", 
    "itemmaterial", "itemnotes", "itemequipped"];


{ // Scope the whole file: Use let/const only ;-)

   RMUInventory.itemDrop = function (name, datastr) {
      console.log("Item drop in inventory");
      const data = JSON.parse(datastr);
      // Add slot:
      const rowid = generateRowID();
      const prefix = `repeating_stuff_${rowid}`;

      let material = false;

      // Old Data has Enc% seperate.
      // Remove this one the sheet version 4
      let weight = data.Weight;

      if (data['Enc%']) {
	weight = data['Enc%'];
	// It's armor and RMU Core... so we guess if metal
	material = data.material || 'metal';
      }

      const update = {
 	[`${prefix}_itemname`]: name,
	[`${prefix}_itemweight`]: weight,
	[`${prefix}_itemcount`]: 1,
	[`${prefix}_itemsystem`]: datastr,
      }
      if (material) {
	update[`${prefix}_itemmaterial`] = material;
      }
      if (data['data-description']) {
	update[`${prefix}_itemnotes`] = data['data-description'];
      } else if (data.Notes) {
	update[`${prefix}_itemnotes`] = data.Notes;
      }

      VrmuSetAttrs(update);
   }

  // Returns as { multiplier, maxpace }
  RMUInventory.getMaxPace = function(load) {
    if (load > 90) {
      // What the hell are you doing
      return { multiplier: 0.5, maxpace: "Crawl" };
    } else if (load > 60) {
      return { multiplier: 1, maxpace: "Walk" };
    } else if (load > 45) {
      return { multiplier: 2, maxpace: "Jog" };
    } else if (load > 30) {
      return { multiplier: 3, maxpace: "Run" };
    } else if (load > 15) {
      return { multiplier: 4, maxpace: "Sprint" };
    } else {
      return { multiplier: 5, maxpace: "Dash" };
    }
  }


  /* Stuff we care about for Weight / Encumberance purposes
     - weight
     - count
     - system
     - equipped

     Based on gear we need to calculate our weightcarried.

     From this:
      - deadload -> % of carried based on gear
      - totalload -> % carried including inventory
      - maxpace -> based on totalload
      - encumberance_penalty

   */
  const events = [ "itemweight", "itemcount", "itemsystem", "itemequipped" ];
  const weight_event_list =  events.map(
      (str) => `change:repeating_stuff:${str}`).join(" ");

  RMUInventory.updateEncumberance = function() {
    getSectionIDsPending("repeating_stuff", ids => {
      let toget = ['weightallowance', 'weight', 'packcarried'];
      ids.forEach(id => {
	  toget.push(`repeating_stuff_${id}_itemweight`);
	  toget.push(`repeating_stuff_${id}_itemcount`);
	  toget.push(`repeating_stuff_${id}_itemequipped`);
	  toget.push(`repeating_stuff_${id}_itemmaterial`);
      });
      getSectionIDsPending('repeating_stuffpack', pids => {
	// Metal and equipped don't matter for pack stuff
	pids.forEach(pid => {
	      toget.push(`repeating_stuffpack_${pid}_itemweight`);
	      toget.push(`repeating_stuffpack_${pid}_itemcount`);
	});
	getAttrsPending(toget, (stuff) => {
	  let carried = 0;
	  let chweight = parseIntDefault(stuff.weight, 200);
	  let chwa = parseIntDefault(stuff.weightallowance, 0);
	  let enc = 0;
	  let encmetal = 0;
	  ids.forEach(id => {
	      const weightstr = stuff[`repeating_stuff_${id}_itemweight`] || "";
	      const equipped = stuff[`repeating_stuff_${id}_itemequipped`] || "";
	      let weight = 0;
	      if (typeof(weightstr) == 'string' && weightstr.endsWith('%')) {
		let weightp = parseIntDefault(weightstr.match(/\d+/)[0],0);
		weight = Math.floor(weightp * chweight / 100);
		if (equipped == 'on') {
		  enc += weightp;
		  if (stuff[`repeating_stuff_${id}_itemmaterial`] == 'metal') {
		    encmetal += weightp;
		  }
		}
	      } else {
		weight = parseNumberDefault(weightstr, 0);
	      }
	      const count = parseIntDefault(stuff[`repeating_stuff_${id}_itemcount`], 1);
	      carried += weight * count;
	  });
	  let packcarried = 0;
	  pids.forEach(pid => {
	      const weightstr = stuff[`repeating_stuffpack_${pid}_itemweight`] || "";
	      let weight = 0;
	      if (typeof(weightstr) == 'string' && weightstr.endsWith('%')) {
		let weightp = parseIntDefault(weightstr.match(/\d+/)[0],0);
		weight = Math.floor(weightp * chweight / 100);
	      } else {
		weight = parseNumberDefault(weightstr, 0);
	      }
	      const count = parseIntDefault(stuff[`repeating_stuffpack_${pid}_itemcount`], 1);
	      packcarried += weight * count;
	  });

	  let updates = {};

	  updates.packweight = packcarried;

	  if (stuff.packcarried == 'on') {
	    carried += packcarried;
	  }

	  // Now round
	  carried = Math.floor(carried);

	  // Start with load -> % carried based wieght.  No modifiers
	  updates.load = Math.floor((carried / chweight) * 100);
	  console.log(`Carried: ${carried} Chwieght ${chweight} Load ${updates.load}`);
	  // Get our Max Pace
	  const pace = RMUInventory.getMaxPace(updates.load);
	  updates.maxpace = pace.maxpace;
	  updates.armorenc = enc;
	  updates.armorencmetal = encmetal;
	  updates.total_weight = carried;

	  // Adjust weight based on carried weight
	  {
	    // Effective carried: Weight - Weight allowance
	    let efcarried = carried;
	    if (chwa > 0) {
	      efcarried -= chwa;
	    }
	    console.log(`Carried ef carrief ${efcarried} CHWeight: ${chwa} Carried ${carried}`);

	    if (efcarried <= 0) {
	      updates.encumberance_penalty = 0;
	    } else {
	      updates.encumberance_penalty = - Math.floor(efcarried / chweight * 100);
	    }
	  }
	  setAttrsPending(updates);
	});
      });
    });
  }

  /* Triggered when the weight of something changed  */
  onCheck(weight_event_list + " change:st", (ev) => {
      addPendingFunction("Weight change: Update encumberance", RMUInventory.updateEncumberance);
      checkPending();
  });

  /* Something was deleted */
  onCheck("remove:repeating_stuff", function(_) {
      console.log("Something was removed; update all");
      pendingInfo(); 
      addPendingFunction("Inventory: Remove Item: Update Encumberance",
		RMUInventory.updateEncumberance);
      addPendingFunction("Inventory: Remove Item: Update Equipped",
		RMUInventory.updateEquipped);
      checkPending();
  });

  /** Get a list of all the known attacks.
   * Then get the 'source' field for all of them.
   * If the source is 'inventory' delete it.
   *
   * Pending Safe
   */
  RMUInventory.deleteCreatedAttacks = function() {
    getSectionIDsPending('repeating_attack', (ids) => {
	let items = []
	ids.forEach((id) => {
	    items.push(`repeating_attack_${id}_attacksource`)

	});
	getAttrsPending(items, todelete => {
	    for (source in todelete) {
	      if (todelete[source] == 'inventory') {
		removeRepeatingRow(source.replace("_attacksource", ""))
	      }
	    }
	});
    });
  }

  /**
   * Get all the equipped equipment and if it's Armor or Weapons add it
   * to the front page of the character sheet.
   *
   * Pending sage
   */
  RMUInventory.addSpecialEquipment = function() {
    getSectionIDsPending(`repeating_stuff`, ids => {
	let percept = 0;
	let rangedpenalty = 0;
	let maneuver_penalty = 0;
	let toget = ['base_at_misc', 'perception_misc', 'db_misc'];
	ids.forEach(id => {
	    toget.push(`repeating_stuff_${id}_itemname`);
	    toget.push(`repeating_stuff_${id}_itemequipped`);
	    toget.push(`repeating_stuff_${id}_itemsystem`);
	});

	let armordb = 0;
	let armordbname = "None";
	let pp_multiplier = 1; // Default multiplier

	getAttrsPending(toget, (stuff) => {
	    let updates = {};
	    updates.db_misc = miscBonusRemoveFilter(stuff.db_misc, (item) => {
		return !item.name.startsWith("Armor DB Bonus (");
	    });

	    let atinfo = miscBonusHighest(stuff.base_at_misc || "", 1);
	    // Set default AT to base_at everywhere.
	    updates.at_head = updates.at_torso = updates.at_legs =
	    updates.at_arms = atinfo[0];
	    updates.at_head_info = updates.at_torso_info = updates.at_legs_info =
		  updates.at_arms_info = atinfo[1] ? atinfo[1] : "Natural";

	    updates.shield_type_bonus = 0;
	    updates.shield_type_nattacks = '-';
	    ids.forEach(id => {
		// Equipped come up as 'on'.  Not equipped as 0.
		const equipped = stuff[`repeating_stuff_${id}_itemequipped`];
		if (equipped !== 'on') {
		  return;
		}
		const name = stuff[`repeating_stuff_${id}_itemname`];
		let json = {}
		try {
		  const sys = stuff[`repeating_stuff_${id}_itemsystem`];
		  if (sys && typeof(sys) == 'string') {
		    json = JSON.parse(sys);
		  }
		} catch (e) {
		  rmuerror("Parsing object JSON", e);
		  return;
		}
		console.log(json);
		// Look for magic fields:
		//  - AT
		//  - attack table
		//  - ppmultiplier
		if (json.AT) {
		  let db = parseIntDefault(json.DB, 0);
		  switch (json.Subtype) {
		    case 'Helmet':
		      updates.at_head = json.AT;
		      updates.at_head_info = name;
		      break;
		    case 'Torso':
		      updates.at_torso = json.AT; 
		      updates.at_torso_info = name;
		      if (db && db > armordb) {
			armordb = db;
			armordbname = name;
		      }
		      break;
		    case 'Vambraces':
		      updates.at_arms = json.AT;
		      updates.at_arms_info = name;
		      break;
		    case 'Greaves':
		      updates.at_legs = json.AT;
		      updates.at_legs_info = name;
		      break;
		    case 'Set':
		      updates.at_torso = json.AT;
		      updates.at_legs = json.AT;
		      updates.at_arms = json.AT;
		      if (db && db > armordb) {
			armordb = db;
			armordbname = name;
		      }
		      updates.at_torso_info = updates.at_legs_info = updates.at_arms_info = name;
		      break;
		    default:
		      updates.at_head = json.AT;
		      updates.at_torso = json.AT;
		      updates.at_legs = json.AT;
		      updates.at_arms = json.AT;
		      if (db && db > armordb) {
			armordb = db;
			armordbname = name;
		      }
		      updates.at_head_info = updates.at_torso_info = updates.at_legs_info =
			  updates.at_arms_info = name;
		  }
		}
		if (json['DB Bonus']) {
		  updates.shield_type_bonus = json['DB Bonus'];
		  updates.shield_type_nattacks = json['Attacks Blocked'];
		}
		if (json['Attack Table']) {
		  RMUInventory.updateWeapon(name, json);
		}
		if (json['PP Multiplier']) {
		  let newmul = parseNumberDefault(json['PP Multiplier'])
		  if (newmul > pp_multiplier) {
		    pp_multiplier = newmul;
		  }
		}
		percept += parseIntDefault(json['Perception Penalty'], 0);
		rangedpenalty += parseIntDefault(json['Ranged Penalty'], 0);
		maneuver_penalty += parseIntDefault(json['Maneuver Penalty'], 0);
	    });

	    // Adjust due to perception penalty
	    updates.db_misc = miscBonusSet(updates.db_misc, `Armor DB Bonus (${armordbname})`, armordb);
	    updates.perception_misc = miscBonusSet(stuff.perception_misc,
		    "Armor Perception Penalty", percept);
	    updates.perception_penalty = percept;
	    updates.ranged_penalty = rangedpenalty;
	    updates.maneuver_penalty = maneuver_penalty;
	    updates.pp_multiplier = pp_multiplier;

	    console.log("equipment update", updates);
	    setAttrsPending(updates, () => {
		RMUSkills.updateSingleCategory("Awareness");
		frontpage.updateDB();
	    });
	});
    });
  }
   
  // Someone changed a system relaed thing; or equpped something
  RMUInventory.updateEquipped = function() {
    console.log("Update equipped");
    pendingInfo();
    addPendingFunction("Delete created attacks", RMUInventory.deleteCreatedAttacks);
    addPendingFunction("Add Special Equipment", RMUInventory.addSpecialEquipment);
    addPendingFunction("Update bonuses for Attacks", attacks.updateAttackBonuses);
    checkPending();
  }

  onCheck("change:repeating_stuff:itemcount", (ev) => {
    console.log(ev);
    

    const nv = parseInt(ev.newValue, 10);
    if (Number.isNaN(nv) || nv < 1) {
      // reject, revert back
      let ov = parseInt(ev.oldValue, 10);
      if (Number.isNaN(ov) || ov < 1) {
	ov = 1;
      }
      addPendingFunction("Reset Item count to a valid value", () => {
      setAttrsPending({[ev.sourceAttribute]: ov});
      });
    }
    addPendingFunction("Inventory:ItemCount Change: Encumberance update", 
	  RMUInventory.updateEncumberance);
    checkPending()   
  });


  onCheck("change:repeating_stuff:itemsystem change:repeating_stuff:itemequipped", (ev) => {
     pendingInfo(); 
     addPendingFunction("Inventory: Item equipped toggle", RMUInventory.updateEquipped);
     checkPending();
  });

  onCheck("clicked:money_level", (_) => {
      getAttrs(["money_gp", "money_sp", "money_bp", "money_cp"], (money) => {
	let gp = parseIntDefault(money.money_gp, 0);
	let sp = parseIntDefault(money.money_sp, 0);
	let bp = parseIntDefault(money.money_bp, 0);
	let cp = parseIntDefault(money.money_cp, 0);
	let carry = Math.floor(cp / 10)
	bp += carry;
	cp = cp % 10;

	carry = Math.floor(bp / 10)
	sp += carry;
	bp = bp % 10;

	carry = Math.floor(sp / 10)
	gp += carry;
	sp = sp % 10;

	// Nothing beyond gp
	setAttrs({money_gp: gp, money_sp: sp, money_bp: bp, money_cp: cp});
      });
  })

  RMUInventory.findAttackSkill = function(display, weapon) {
    for (prefix of ["", "Melee Weapons:", "Ranged Weapons:", "Unarmed"]) {
      let skillobj = RMUSkills.getSkillByDisplayName(prefix + display);
      if (skillobj) {
	return skillobj;
      }
    }

    rmuerror(`Inventory item ${weapon} subtype ${display} is unknown`);
    return null;
  }

  
  RMUInventory.updateWeapon = function(name, json) {
    const rowid = generateRowID();
    const prefix = `repeating_attack_${rowid}`;
    let skill = "";
    if (json['Attack Skill']) {
      skill = json['Attack Skill'];
    } else if (json.Subtype) {
      let skillobj = RMUInventory.findAttackSkill(json.Subtype, name);
      if (!skillobj) {
	return;
      }
      skill = skillobj.aname;
    }

    // FIXME: Assuming medium size here... that's like totally wrong
    let size = 'M'; 
    if (json.Size) {
      let delta = +(json.Size);
      if (delta > 0) {
	size = 'B';
      } else if (delta < 0) {
	size = 'S';
      }
    }

    const materialgroup = json.WeaponMaterialGroup ? json.WeaponMaterialGroup : '';

    // Range is either 'short' or 'RI'
    const range = json['RI'] || json['short'] || '-';

    // Get ahead of the updates of OBs and the like
    addPendingFunctionNext("Add attack " + name, () => {
      getCompendiumPagePending("AttackTable:" + json['Attack Table'], (cdata) => {
	  if (!cdata.data['data-attack']) {
	    rmuerror("Data attack missing in ", json['Attack Table']);
	    return;
	  }
	  let min = cdata.data.min.match(/\d+/)[0] || 0;
	  let max = cdata.data.max.match(/\d+/)[0] || 0;
	  let attack_table = cdata.data['data-attack'] || "";
	  let attacktype = 'melee';
	  if (cdata.RI && parseIntDefault(cdata.RI, 0) > 0) {
	    attacktype = 'ranged';
	  }
	  setAttrsPending({
	      [`${prefix}_attackname`]: name,
	      [`${prefix}_attacksize`]:  size,
	      [`${prefix}_attacktable`]: json['Attack Table'],
	      [`${prefix}_attackdata`]: attack_table,
	      [`${prefix}_attackmin`]: min,
	      [`${prefix}_attackmax`]: max,
	      [`${prefix}_attackstr`]: json['Strength'],
	      [`${prefix}_attackbasefumble`]: parseIntDefault(json.Fumble, 10),
	      [`${prefix}_attacksource`]: 'inventory',
	      [`${prefix}_attackskill`]: skill,
	      [`${prefix}_atackri`]: range,
	      [`${prefix}_materialgroup`] : materialgroup,
	      [`${prefix}_attackmodifier`]: parseIntDefault(json.OB, 0),
	      });
	});
      });
  }

  // FIXME: Should add a are you sure button
  onCheck('clicked:repeating_stuff:deleteitem', (ev) => {
      const basename = ev.sourceAttribute.replace("_deleteitem", "");
      removeRepeatingRow(basename);
      RMUInventory.updateEncumberance();
      RMUInventory.updateEquipped();
  });
  onCheck('clicked:repeating_stuffpack:deleteitem', (ev) => {
      const basename = ev.sourceAttribute.replace("_deleteitem", "");
      removeRepeatingRow(basename);
      RMUInventory.updateEncumberance();
      RMUInventory.updateEquipped();
  });
  onCheck('clicked:repeating_stuffstore:deleteitem', (ev) => {
      const basename = ev.sourceAttribute.replace("_deleteitem", "");
      removeRepeatingRow(basename);
  });


  RMUInventory.moveItem = function(from, to, done) {
    console.log("Moving from ", from, "to", to);
    const fromprops = RMUInventory.itemfields.map((f) => from + '_' + f);

    // Get all the old properties
    getAttrs(fromprops, (props) => {
      const updates = {};
      // rename
      for (const [key, value] of Object.entries(props)) {
	const nk = key.replace(from, to);
	updates[nk] = value;
      }
      // save
      setAttrs(updates, () => {
	removeRepeatingRow(from);
	if (done) {
	  done();
	}
      });
    });
  }

  onCheck('clicked:repeating_stuff:itemcarrytopack', (ev) => {
      const basename = ev.sourceAttribute.replace("_itemcarrytopack", "");
      const targetname = "repeating_stuffpack_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, () => {
	  RMUInventory.updateEncumberance();
	  RMUInventory.updateEquipped();
      });
  });
  onCheck('clicked:repeating_stuff:itemcarrytostore', (ev) => {
      const basename = ev.sourceAttribute.replace("_itemcarrytostore", "");
      const targetname = "repeating_stuffstore_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, () => {
	  RMUInventory.updateEncumberance();
	  RMUInventory.updateEquipped();
      });
  });
  onCheck('clicked:repeating_stuffpack:itempacktocarry', (ev) => {
      const basename = ev.sourceAttribute.replace("_itempacktocarry", "");
      const targetname = "repeating_stuff_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, () => {
	  // Carried. so may be equipped
	  RMUInventory.updateEncumberance();
	  RMUInventory.updateEquipped();
      });
  });
  onCheck('clicked:repeating_stuffpack:itempacktostore', (ev) => {
      const basename = ev.sourceAttribute.replace("_itempacktostore", "");
      const targetname = "repeating_stuffstore_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, RMUInventory.updateEncumberance);
  });
  onCheck('clicked:repeating_stuffstore:itemstoretocarry', (ev) => {
      const basename = ev.sourceAttribute.replace("_itemstoretocarry", "");
      const targetname = "repeating_stuff_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, () => {
	  RMUInventory.updateEncumberance();
	  RMUInventory.updateEquipped();
      });
  });
  onCheck('clicked:repeating_stuffstore:itemstoretopack', (ev) => {
      const basename = ev.sourceAttribute.replace("_itemstoretopack", "");
      const targetname = "repeating_stuffpack_" + generateRowID();
      RMUInventory.moveItem(basename, targetname, RMUInventory.updateEncumberance);
  });
  onCheck('change:packcarried',  RMUInventory.updateEncumberance);

  onCheck('clicked:inventoryadd', (_) => {
      setAttrs({inventoryaddshow : "on",  inventoryaddmessage : "", inventoryaddsaveid : ""});
  });

  onCheck("clicked:inventoryaddcancel", (_) =>  {
      setAttrs({"inventoryaddshow" : "off" });
  });
    
     
  onCheck("change:inventoryaddtype", (ev) => {
    console,log("Change inventory add type", ev);
    // Hide all the old stuff
    const updates = {
      inventoryaddarmortoggle: false,
      inventoryaddshieldtoggle: false,
      inventoryaddweapontoggle: false,
    };
    if (ev.newValue == 'Armor') {
      updates.inventoryaddarmortoggle = 'on';
    } else if (ev.newValue == 'Weapon') {
      updates.inventoryaddweapontoggle = 'on';
    } else if (ev.newValue == 'Shield') {
      updates.inventoryaddshieldtoggle = 'on';
    }
    setAttrs(updates);
  });

  const invaddattrs = [
    "inventoryaddname", "inventoryaddweight", "inventoryaddnotes",
    "inventoryaddtype",
    "inventoryaddarmorsubtype", "inventoryaddarmorat",
    "inventoryaddarmordbbonus", "inventoryaddarmormaterial",
    "inventoryaddshieldattacks", "inventoryaddshielddb",
    "inventoryaddweaponmaterialc", "inventoryaddweaponmaterialw",
    "inventoryaddweaponmateriali", "inventoryaddweaponmaterialm",
    "inventoryaddweaponmaterials", "inventoryaddweaponobbonus",
    "inventoryaddweaponattacksize", "inventoryaddweaponattacktable",
    "inventoryaddweaponskill",
    "inventoryaddsaveid", "inventoryaddstrength"
  ];

  onCheck("clicked:inventoryaddsave", (_) =>  {
      getAttrs(invaddattrs, (ia) => {
	  let update = {}
	  if (!ia.inventoryaddname || ia.inventoryaddname.length < 1) {
	    setAttrs({"inventoryaddmessage": "Need name of inventory item"});
	    return;
	  }
	  let system = {}
	  update.name = ia.inventoryaddname;
	  update.weight = parseIntDefault(ia.inventoryaddweight, 0);
	  system.Strength = parseIntDefault(ia.inventoryaddstrength, 0);
	  update.notes = ia.inventoryaddnotes || "";
	  update.count = 1;
	  update.type = ia.inventoryaddtype;
	  if (update.type == 'Armor') {
	    system.Subtype = ia.inventoryaddarmorsubtype;
	    system.AT = ia.inventoryaddarmorat;
	    const db = parseIntDefault(ia.inventoryaddarmordbbonus, 0);
	    if (db != 0) {
	      system.DB = ia.inventoryaddarmordbbonus;
	    }
	    // If Armor need to make a %
	    update.weight = `${update.weight}%`;
	    update.material = ia.inventoryaddarmormaterial;
	  } else if (update.type == 'Shield') {
	    system['Attacks Blocked'] = ia.inventoryaddshieldattacks;
	    system['DB Bonus'] = ia.inventoryaddshielddb;
	  } else if (update.type == 'Weapon') {
	    let mtype = []
	    if (ia.inventoryaddweaponmaterialc == 'on') mtype.push('c');
	    if (ia.inventoryaddweaponmaterialw == 'on') mtype.push('w');
	    if (ia.inventoryaddweaponmateriali == 'on') mtype.push('i');
	    if (ia.inventoryaddweaponmaterials == 'on') mtype.push('s');
	    if (ia.inventoryaddweaponmaterialm == 'on') mtype.push('m');
	    system['WeaponMaterialGroup'] = mtype.join('');
	    const bonus = parseIntDefault(ia.inventoryaddweaponobbonus, 0);
	    if (bonus != 0) {
	      system['OB'] = bonus;
	    }
	    system['Attack Table'] = ia.inventoryaddweaponattacktable;
	    // FIXME: assumign medium creatures here
	    let size = parseIntDefault(ia.inventoryaddweaponattacksize, 0);
	    if (size == -1) {
	      system.Size = 'S';
	    } else if (size == 1) {
	      system.Size = 'B';
	    } else {
	      system.Size = 'M';
	    }
	    system['Attack Skill'] = ia.inventoryaddweaponskill;

	  }
	  update.system = JSON.stringify(system);

	  // Do the add
	  let prefix = ""
	  if (ia.inventoryaddsaveid && ia.inventoryaddsaveid.length > 1) {
	    prefix = ia.inventoryaddsaveid + "_item";
	  } else {
	    const rowid = generateRowID();
	    prefix = "repeating_stuff_" + rowid + "_item";
	  }
	  let fullnames = {}
	  for (let [k, v] of Object.entries(update)) {
	    fullnames[prefix + k] = v;
	  }
	  fullnames.inventoryaddshow = 'off';
	  fullnames.inventoryaddmessage = '';
	  console.log(fullnames);
	  setAttrs(fullnames);
      });
  });

  onCheck("clicked:repeating_stuff:edititem", (ev) => {
      console.log(ev);
      const basename = ev.sourceAttribute.replace("_edititem", "");
      console.log(basename);
      // Don't need count - you can edit that directly
      getAttrs([`${basename}_itemname`, `${basename}_itemweight`,
	    `${basename}_itemsystem`, `${basename}_itemnotes`,
	    `${basename}_itemtype`,
	    `${basename}_itemmaterial`], (item) => {
	  console.log("Fetched data", item);
	  const update = {}
	  update.inventoryaddweaponmaterialc = 'off';
	  update.inventoryaddweaponmaterialw = 'off';
	  update.inventoryaddweaponmateriali = 'off';
	  update.inventoryaddweaponmaterials = 'off';
	  update.inventoryaddweaponmaterialm = 'off';

	  const sys = JSON.parse(item[`${basename}_itemsystem`]);
	  update.inventoryaddname = item[`${basename}_itemname`] || 'Item';
	  update.inventoryaddweight = parseIntDefault(item[`${basename}_itemweight`], 0);
	  update.inventoryaddtype = item[`${basename}_itemtype`] || 'Equipment';
	  update.inventoryaddstrength = parseIntDefault(sys.Strength, 0);
	  update.inventoryaddnotes = item[`${basename}_itemnotes`] || '';

	  //
	  {
	    const material = sys.WeaponMaterialGroup || '';
	    update.inventoryaddweaponmaterialc = material.includes('c') ? 'on' : 'off';
	    update.inventoryaddweaponmaterialw = material.includes('w') ? 'on' : 'off';
	    update.inventoryaddweaponmateriali = material.includes('i') ? 'on' : 'off';
	    update.inventoryaddweaponmaterials = material.includes('s') ? 'on' : 'off';
	    update.inventoryaddweaponmaterialm = material.includes('m') ? 'on' : 'off';
	    update.inventoryaddweaponobbonus = parseIntDefault(sys.OB, 0);
	    update.inventoryaddweaponskill = sys['Attack Skill'] || "";
	  }

	  //
	  {
	    if (sys.Subtype) {
	      update.inventoryaddarmorsubtype = sys.Subtype;
	    }
	    if (sys.AT) {
	      update.inventoryaddarmorat = sys.AT;
	    }
	    update.inventoryaddarmormaterial = item[`${basename}_itemmaterial`] || "metal";
	    update.inventoryaddarmordbbonus = parseIntDefault(sys.DB, 0);
	  }
	  {//
	    if (sys['Attacks Blocked']) {
	      update.inventoryaddshieldattacks = sys['Attacks Blocked'];
	    }
	    if (sys['DB Bonus']) {
	      update.inventoryaddshielddb = sys['DB Bonus'];
	    }
	  }

	  // Ideally this should be the same as the above function
	  update.inventoryaddarmortoggle = 'off';
	  update.inventoryaddshieldtoggle = 'off';
	  update.inventoryaddweapontoggle = 'off';

	  if (update.inventoryaddtype == 'Armor') {
	    update.inventoryaddarmortoggle = 'on';
	  } else if (update.inventoryaddtype == 'Weapon') {
	    update.inventoryaddweapontoggle = 'on';
	  } else if (update.inventoryaddtype == 'Shield') {
	    update.inventoryaddshieldtoggle = 'on';
	  }

	  update.inventoryaddshow = 'on'
	  update.inventoryaddmessage = ''
	  update.inventoryaddsaveid = basename;
	  console.log("Show item edit", update);
	  setAttrs(update)
      });
  });


} // End 'cheap-module' scope




let drop = {};

/* this does nothing */

onCheck("change:drop_data", event => drop.handleDrop());

const potentialInventory = {
  "Item": true, "Magic Item": true, "Magic Items": true,
  "Herb": true, "Herbs": true, 
  "Superior Item": true, "Superior Items": true,

};

drop.handleDrop = function(ev) {
  console.log("Handle drop", ev);

  getAttrs(['drop_name', 'drop_data', 'drop_category', 'sheetselect', 'charactercreated'], (drop) => {
      console.log(drop);
      if (potentialInventory[drop.drop_category] === true) {
	RMUInventory.itemDrop(drop.drop_name, drop.drop_data);
      } else if (drop.drop_category == 'Creature' || drop.drop_category == 'NPC') {
	// If we have a sheetselect ; don't allow to change your sheet
	if (drop.charactercreated == true || drop.charactercreated == 'true' ||
	      drop.sheetselect == 'trackersheet') {
	  console.log("Can't change to a creature now!\n");
	} else {
	  creature.newCreature("Creature", drop.drop_data);
	}
      } else {
	rmuerror("Don't know how to handle a ", drop.drop_category);
      }
  });
}


/**/



Edit = {};

Edit.clearSection = function(section) {
  getSectionIDs(section, (ids) => {
      ids.forEach((id) => {
	  removeRepeatingRow(`${section}_${id}`);
      });
  });
}

Edit.editList = function(display, options, toEdit) {
  let toget = []
  toEdit.forEach((item) => {
      toget.push(item.field);
  });
  tabs = [ "first", "second", "third" ];
  getAttrsPending(toget, (sheetinfo) => {
      updates = {};
      tabs.forEach((tabname, index) => {
	  if (!toEdit[index]) {
	    updates[`edit${tabname}name`] = '~';
	    updates[`edit${tabname}field`] = '~';
	    // Be nice if I could hide the third tab somehow.
	    return;
	  }
	  const item = toEdit[index];
	  updates[`edit${tabname}name`] = item.name;
	  updates[`edit${tabname}field`] = item.field;
	  const misc = miscRawGetFromString(sheetinfo[item.field]);
	  for (let item of misc) {
	    const rowid = generateRowID();
	    const prefix = `repeating_edit${tabname}_${rowid}`;

	    if (item.absolute) {
	      updates[`${prefix}_name`] = item.name;
	      updates[`${prefix}_number`] = item.absolute;
	      updates[`${prefix}_type`] = 'absolute'
	    } else if (item.message) {
	      updates[`${prefix}_name`] = item.message;
	      updates[`${prefix}_type`] = 'message'
	    } else {
	      updates[`${prefix}_name`] = item.name;
	      updates[`${prefix}_number`] = item.value;
	      updates[`${prefix}_type`] = 'value'
	    }
	  }
      });
      setAttrsPending(updates);
      Edit.showEdit(display, options);

  });
}

Edit.clearSections = function() {
    Edit.clearSection('repeating_editfirst');
    Edit.clearSection('repeating_editsecond');
    Edit.clearSection('repeating_editthird');
}

Edit.hideEdit = function() {
    setAttrs({"toggleeditbox": "false"});
}

Edit.showEdit = function(title, options) {
  title = title || "Edit";
  let ca = 'false';
  if (options && options.canedit) {
    ca = 'true';
  }
  let del = 'off';
  if (options && options.candelete) {
    del = 'on';
  }
  rmuSetAttrs({"edit_title": title, "toggleeditbox": "true", 'edit_caneditname': ca,
      'edit_candelete': del});
}

Edit.saveTab = function(tab) {
  getSectionIDs(`repeating_edit${tab}`, (ids) => {
      let toget = []
      toget.push(`edit${tab}field`);
      ids.forEach((id) => {
	  toget.push(`repeating_edit${tab}_${id}_name`);
	  toget.push(`repeating_edit${tab}_${id}_number`);
	  toget.push(`repeating_edit${tab}_${id}_type`);
      });
      getAttrsPending(toget, (items) => {
	  if (items[`edit${tab}field`] == '~') {
	    return;
	  }
	  let misc = miscRawNew();
	  let dups = {};
	  let cansave = true;
	  ids.forEach((id) => {
	    const name = items[`repeating_edit${tab}_${id}_name`];
	    // FIXME: Validate it's a number here.
	    const number = parseInt(items[`repeating_edit${tab}_${id}_number`]);
	    const type = items[`repeating_edit${tab}_${id}_type`];
	    if (dups.name) {
	      cansave = false;
	      rmuerror("Duplciation name");
	      return;
	    }
	    dups[name] = true;
	    if (type == 'absolute') {
	      misc = miscRawSetAbsolute(misc, name, number);
	    } else if (type == 'message') {
	      misc = miscRawMessage(misc, name);
	    } else {
	      misc = miscRawAppend(misc, name, number);
	    }
	  });
	  if (cansave) {
	    const field = items[`edit${tab}field`];
	    const str = miscRawToString(misc)
	    setAttrsPending({[field]: str});
	  }
      });
  });
}

onCheck("clicked:edit_skill_cancel", (ev) => {
    Edit.clearSections();
    Edit.hideEdit();
});

// This only wotk for skill specialisations
onCheck("clicked:edit_skill_save", (ev) => {
  getAttrsPending(['edit_title', 'edit_caneditname', 'editfirstfield'], (data) => {
      console.log(data)
      if (data.edit_caneditname) {
	let name = data.editfirstfield.replace("_ranks_misc", "_name");
	console.log({[name]: data.edit_title});
	setAttrsPending({[name]: data.edit_title});
      }
  });


  Edit.saveTab("first");
  Edit.saveTab("second");
  Edit.saveTab("third");
  Edit.hideEdit();
  pendingInfo();
  addPendingFunction("Skill Save updates", () => {
      RMUSkills.updateStatCache(RMUSkills.updateAllSkills);
  }); 
});

onCheck("clicked:edit_skill_delete", (_) => {
  console.log("delete");
  getAttrsPending(['editbasename'], (data) => {
    removeRepeatingRow(data.editbasename);
    Edit.hideEdit();
  });

});

onCheck("clicked:edit_skill", (ev) => {
    Edit.clearSections();
    const aname = ev.htmlAttributes['data-skill'];
    const skill = RMUSkills.getSkillByName(aname);
    if (!skill) {
      rmuerror("Unable to get skill ", aname);
      return;
    }

    Edit.editList(skill.display, { canedit: false},
    [
      { name: "Bonus",  field: `${aname}_misc` },
      { name: "Ranks",  field: `${aname}_ranks_misc` }
    ]);
});

onCheck("clicked:edit_stat", (ev) => {
    Edit.clearSections();

    const stat = ev.htmlAttributes['data-stat'];
    const abbr = ev.htmlAttributes['data-statabbr'];
    const display = ev.htmlAttributes['data-display']

    Edit.editList(display, { canedit: false },
    [ 
      { name: "Temp",  field: `${stat}_misc` },
      { name: "Pot",  field: `${stat}_pot_misc` },
      { name: "Bonus",  field: `${abbr}_misc` }
    ]);

});

onCheck("clicked:add_specialization", (ev) => {
    const aname = ev.htmlAttributes['data-skill'];
    if (!aname) {
      rmuerror("aname for add specialization not found");
      return;
    }
    const skill = RMUSkills.getSkillByName(aname);
    if (!skill) {
      rmuerror("Could not find skill", skill);
      return;
    }

    getSectionIDs(`repeating_specialization${aname}`, ids => {
	const count = ids.length + 1;
	const name = `${skill.dynamicspecializations} #${count}`;
	const id = generateRowID();
	const namefield = `repeating_specialization${aname}_${id}_name`
	setAttrs({[namefield]: name});
    });
});

onCheck("clicked:add_spelllist", (ev) => {
    const spelllisttype = ev.htmlAttributes['data-spelllisttype'];
    const spelllistdisplay = ev.htmlAttributes['data-spelllistdisplay'];
    getSectionIDs(`repeating_spelllist${spelllisttype}`, ids => {
	const count = ids.length + 1;
	const basename = `repeating_spelllist${spelllisttype}`;
	const display = `${spelllistdisplay} List #${count}`
	const id = generateRowID();
	setAttrs({[`${basename}_${id}_name`]: display});
    });
});

/**/

onCheck("clicked:repeating_specializationanimalhandling:editskillspecialization clicked:repeating_specializationriding:editskillspecialization clicked:repeating_specializationbattlestyle:editskillspecialization clicked:repeating_specializationdisciplinestyle:editskillspecialization clicked:repeating_specializationcombatstyle:editskillspecialization clicked:repeating_specializationpiloting:editskillspecialization clicked:repeating_specializationhistoriclore:editskillspecialization clicked:repeating_specializationlanguage:editskillspecialization clicked:repeating_specializationraciallore:editskillspecialization clicked:repeating_specializationregionlore:editskillspecialization clicked:repeating_specializationreligionphilosophy:editskillspecialization clicked:repeating_specializationgrace:editskillspecialization clicked:repeating_specializationspelltrickery:editskillspecialization clicked:repeating_specializationmusic:editskillspecialization clicked:repeating_specializationadministration:editskillspecialization clicked:repeating_specializationservice:editskillspecialization clicked:repeating_specializationtrade:editskillspecialization", (ev) => {
    Edit.clearSections();
    const basename = ev.sourceAttribute.replace("_editskillspecialization", "");
    getAttrsPending([`${basename}_name`], (bn) => {
	setAttrs({editbasename: basename});
	Edit.editList(bn[`${basename}_name`], { canedit: true, candelete: true },
	  [
	  { name: "Ranks",  field: `${basename}_ranks_misc` },
	  { name: "Bonus",  field: `${basename}_misc` },
	  ]);
    });
});

/**/
onCheck("clicked:repeating_spelllistspellownbase:editspelllist clicked:repeating_spelllistspellopen:editspelllist clicked:repeating_spelllistspellclosed:editspelllist clicked:repeating_spelllistspellotherbaseownrealm:editspelllist clicked:repeating_spelllistspellopenother:editspelllist clicked:repeating_spelllistspellclosedother:editspelllist clicked:repeating_spelllistspellotherbaseother:editspelllist clicked:repeating_spelllistarcane:editspelllist", (ev) => {
    Edit.clearSections();
    console.log(ev);
    const basename = ev.sourceAttribute.replace("_editspelllist", "");
    console.log("basename is", basename);

    getAttrsPending([`${basename}_name`], (bn) => {
	console.log(bn);
	setAttrs({editbasename: basename});
	Edit.editList(bn[`${basename}_name`], { canedit: true }/* edit name */,
	    [
	      { name: "Ranks",  field: `${basename}_ranks_misc` },
	      { name: "Bonus",  field: `${basename}_misc` },
	      { name: "Mastery",  field: `${basename}_spellmastery` },
	    ]);
    });
});


/**/

let attacks = {};

attacks.missmessage = [
    "Miss", "Miss", "Miss", "Miss", "Miss", "Miss", "Miss",
    "Miss", "Miss", "Miss", "Miss", "Miss", "Miss", "Miss",
    "Fails to makes contact",
    "Swings wide",
    "Not even close",
    "Does not hit",
    "Botches the attack",
    "Chooses to avoid risk of damage to their weapon",
    "Does not make contact",
];

// FIXME: This is mirrored in the HTML
attacks.critsToName = {
    A: "Acid",
    B: "Subdual",
    E: "Steam",
    G: "Grapple",
    H: "Heat",
    I: "Impact",
    K: "Krush",
    L: "Electricity",
    O: "Cold",
    P: "Puncture",
    S: "Slash",
    T: "Strikes",
    U: "Unbalance",
    V: "Void",
    W: "Sweeps",
    Y: "Holy"
};

// Also used to generate the critlist for rollcrits
attacks.critnameToCode = {
    Acid: "A",
    Cold: "O",
    Electricity: "L",
    Grapple: "G",
    Heat: "H",
    Holy: "Y",
    Impact: "I",
    Krush: "K",
    Mana: "M",
    Puncture: "P",
    Slash: "S",
    Steam: "E",
    Strikes: "T",
    Subdual: "B",
    Sweeps: "W",
    Unbalance: "U",
    Void: "V",
};


attacks.allAttackTables = [
  "Arming Sword",
  "Ball, Cold",
  "Battle Axe",
  "Beak",
  "Bite",
  "Bola",
  "Bow, Short",
  "Broadsword",
  "Claw",
  "Club",
  "Ball, Acid",
  "Ball, Cold",
  "Ball, Mana",
  "Ball, Fire",
  "Ball, Lightning",
  "Ball, Void",
  "Bolt, Acid",
  "Bolt, Fire",
  "Bolt, Lightning",
  "Bolt, Mana",
  "Bolt, Shock",
  "Bolt, Water",
  "Bolt, Void",
  "Crossbow",
  "Crush",
  "Dagger",
  "Falchion",
  "Fighting Stick",
  "Flail",
  "Grapple",
  "Horn",
  "Bolt, Ice",
  "Bow, Long",
  "Mace",
  "Ram",
  "Rapier",
  "Rock",
  "Scimitar",
  "Shield",
  "Sling",
  "Spear",
  "Stinger",
  "Trample",
  "Unarmed Strike",
  "Unarmed Sweeps",
  "War Hammer",
  "Whip",
];

function getMiss() {
    return attacks.missmessage[Math.floor(Math.random()*attacks.missmessage.length)]
}

function numericToCritCode(num) {
    if (num < -5) { num = -6 }
    if (num > 10) { num = 9 }

    switch (num) {
	case -6: return 'T';
	case -5: return 'U';
	case -4: return 'V';
	case -3: return 'X';
	case -2: return 'Y';
	case -1: return 'Z';
	case 0: return 'A';
	case 1: return 'B';
	case 2: return 'C';
	case 3: return 'D';
	case 4: return 'E';
	case 5: return 'F';
	case 6: return 'G';
	case 7: return 'H';
	case 8: return 'I';
	case 9: return 'J';

    }
}


// FIXME: Should do long names as well
function sizeToNumeric(code) {
    let x = parseIntDefault(code, -99);
    if (x != -99) {
	return x;
    }

    switch (code) {
	case 'I': return 1;
	case 'II': return 2;
	case 'III': return 3;
	case 'IV': return 4;
	case 'V': return 5;
	case 'VI': return 6;
	case 'VII': return 7;
	case 'VIII': return 8;
	case 'IX': return 9;
	case 'X': return 10;
	case "Mi": return 1;
	case "MI": return 1;
	case "Di": return 2;
	case "DI": return 2;
	case "D": return 2;
	case "T": return 3;
	case "S": return 4;
	case "M": return 5;
	case "B": return 6;
	case "L": return 7;
	case "H": return 8;
	case "G": return 9;
	case "E": return 10;
//	case "O:
    }
    rmuerror("Unknown size: ", code);
    return 5; 
}

function sizeFromNumeric(value) {
    // FIXME: value, value makes no sense.
    switch (parseIntDefault(value, value)) {
	case 1: return "Mi";
	case 2: return "Di";
	case 3: return "T";
	case 4: return "S";
	case 5: return "M";
	case 6: return "B";
	case 7: return "L";
	case 8: return "H";
	case 9: return "G";
	case 10: return "E";
    }
    rmuerror("Unknown size: ", value);
    return "M"
}

(function() {
    // FIXME: This should be structure
    var hitLocation = [
	/* 0-4 */   { location: "Australia", armorlocation: 1, rollindex: 0, down: 1 },
	 	    { location: "Head", armorlocation: 2, rollindex: 0, down: 1 },
		    { location: "Chest", armorlocation: 1, rollindex: 1, down: 1 },
		    { location: "Chest", armorlocation: 1, rollindex: 1, down: 1 },
		    { location: "Abdomen", armorlocation: 1, rollindex: 2, down: 1 },

	/* 5-9 */   { location: "Abdomen", armorlocation: 1, rollindex: 2, down: 1 },
		    { location: "Leg", armorlocation: 4, rollindex: 3, down: 1 },
		    { location: "Leg", armorlocation: 4, rollindex: 3, down: 1 },
		    { location: "Leg", armorlocation: 4, rollindex: 3, down: 1 },
		    { location: "Leg", armorlocation: 4, rollindex: 3, down: 1 },

	/* 10-14 */ { location: "Leg", armorlocation: 4, rollindex: 3, down: 1 },
		    { location: "Arm", armorlocation: 3, rollindex: 4, down: 1 },
		    { location: "Arm", armorlocation: 3, rollindex: 4, down: 1 },
		    { location: "Arm", armorlocation: 3, rollindex: 4, down: 1 },
		    { location: "Arm", armorlocation: 3, rollindex: 4, down: 1 },

	/* 15-19 */ { location: "Arm", armorlocation: 3, rollindex: 4, down: 1 },
		 { location: "Head", armorlocation: 2, rollindex: 5, down: 1 },
		 { location: "Head", armorlocation: 2, rollindex: 5, down: 1 },
		 { location: "Head", armorlocation: 2, rollindex: 5, down: 1 },
		 { location: "Head", armorlocation: 2, rollindex: 5, down: 1 },

	/* 20-24 */ { location: "Head", armorlocation: 2, rollindex: 5, down: 1 },
		 { location: "Chest", armorlocation: 1, rollindex: 6, down: 2 },
		 { location: "Chest", armorlocation: 1, rollindex: 6, down: 2 },
		 { location: "Chest", armorlocation: 1, rollindex: 6, down: 2 },
		 { location: "Chest", armorlocation: 1, rollindex: 6, down: 2 },

	/* 25-29 */ { location: "Chest", armorlocation: 1, rollindex: 6, down: 2 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },

	/* 30-34 */ { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },

	/* 35-39 */ { location: "Abdomen", armorlocation: 1, rollindex: 7, down: 4 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },

	/* 40-44 */ { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },

	/* 45-49 */ { location: "Leg", armorlocation: 4, rollindex: 8, down: 6 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },

	/* 50-54 */ { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		 { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },

	/* 55-59 */ { location: "Arm", armorlocation: 3, rollindex: 9, down: 11 },
		  { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },

	/* 60-64 */ { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },

	/* 65-69 */ { location: "Arm", armorlocation: 3, rollindex: 10, down: 46 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 11, down: 35 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },

	/* 70-74 */ { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },

	/* 75-79 */ { location: "Leg", armorlocation: 4, rollindex: 12, down: 36 },
		 { location: "Chest", armorlocation: 1, rollindex: 13, down: 21 },
		 { location: "Chest", armorlocation: 1, rollindex: 13, down: 21 },
		 { location: "Chest", armorlocation: 1, rollindex: 13, down: 21 },
		 { location: "Chest", armorlocation: 1, rollindex: 13, down: 21 },

	/* 80-84 */ { location: "Chest", armorlocation: 1, rollindex: 13, down: 21 },
		 { location: "Head", armorlocation: 2, rollindex: 14, down: 16 },
		 { location: "Head", armorlocation: 2, rollindex: 14, down: 16 },
		 { location: "Head", armorlocation: 2, rollindex: 14, down: 16 },
		 { location: "Head", armorlocation: 2, rollindex: 14, down: 16 },

	/* 85-89 */ { location: "Head", armorlocation: 2, rollindex: 14, down: 16 },
		 { location: "Arm", armorlocation: 3, rollindex: 15, down: 56 },
		 { location: "Arm", armorlocation: 3, rollindex: 15, down: 56 },
		 { location: "Arm", armorlocation: 3, rollindex: 15, down: 56 },
		 { location: "Arm", armorlocation: 3, rollindex: 15, down: 56 },

	/* 90-94 */ { location: "Arm", armorlocation: 3, rollindex: 15, down: 56 },
		 { location: "Leg", armorlocation: 4, rollindex: 16, down: 67 },
		 { location: "Leg", armorlocation: 4, rollindex: 16, down: 67 },
		 { location: "Leg", armorlocation: 4, rollindex: 16, down: 67 },
		 { location: "Leg", armorlocation: 4, rollindex: 16, down: 67 },

	/* 95-99 */ { location: "Leg", armorlocation: 4, rollindex: 16, down: 67 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 17, down: 66 },
		 { location: "Abdomen", armorlocation: 1, rollindex: 17, down: 66 },
		 { location: "Chest", armorlocation: 1, rollindex: 18, down: 76 },
		 { location: "Chest", armorlocation: 1, rollindex: 18, down: 76 },
	/* 100 */ { location: "Head", armorlocation: 2, rollindex: 19, down: 81 },
    ];

    const downByIndex = [
	/* 0 */ 0, 
	/* 1 */ 1,
	/* 2 */ 1,
	/* 3 */ 1,
	/* 4 */ 1,
	/* 5 */ 1,
	/* 6 */ 1,
	/* 7 */ 2,
	/* 8 */ 3,
	/* 9 */ 4,
	/* 10 */ 9,
	/* 11 */ 7,
	/* 12 */ 8,
	/* 13 */ 6,
	/* 14 */ 5,
	/* 15 */ 10,
	/* 16 */ 12,
	/* 17 */ 11,
	/* 18 */ 13,
	/* 19 */ 14,
    ];


    /* Returns an obj of location, side, at  */
    attacks.getLocation = function(roll) {
	if (typeof(roll) != 'Number') {
	    roll = parseIntDefault(roll, 0);
	}
	if (roll < 1) {
	    rmuerror("Roll is < 1", roll);
	    roll = 1;
	}
	if (roll > 100) {
	    rmuerror("Roll is > 100", roll);
	    roll = 100;
	}
	let side = "Right";
	if ((roll & 1) == 1) {
	    // Odd; left side
	    side = "Left";
	}
	return {
	    location: hitLocation[roll].location,
	    side: side,
	    atindex: hitLocation[roll].armorlocation,
	    critindex: hitLocation[roll].rollindex,
	    roll: roll,
	};
    }

    attacks.knownCrits = {}

    attacks.resolveCriticalList = function(critlist, donfn) {
	console.log("resolveCriticalList", critlist)
	const allresults = []
	for (const {sev, type, origsev, index} of critlist) {
	    let sevcode = numericToCritCode(sev);
	    console.log("Known Crits", type, index)
	    const crit = attacks.knownCrits[type][index]
	    const results = {}
	    // Get the C-H, C-St etc codes.
	    for (res in crit) {
		if (res[0] == sevcode) {
		    const suffix = res.substring(2)
		    if (suffix != 'description' && suffix != 'effect') {
			results[suffix] = crit[res];
		    }
		}
	    }

	    // So need to A-effect & A-description
	    allresults.push({
		    description: crit[sevcode + '-description'],
		    effect: crit[sevcode + '-effect'],
		    type: attacks.critsToName[type],
		    results: results,
		    code : sevcode + type});
	}

	donfn(allresults);
	//return allresults;
    }

    attacks.generateCritList = function(crits, severity, type, index) {
	let origsev = severity;

	while (severity < 0) {
	    index = downByIndex[index];
	    severity ++;
	}

	// Move to known sizes:
	if (severity > 4) {
	    crits.push({ sev: 4, type: type , index:index }); // Start with an E, then append some
	    switch (severity) {
	    case 5 /*F*/: crits.push({sev: 0, type:type, index:index }); break;
	    case 6 /*G*/: crits.push({sev: 1, type:type, index:index }); break;
	    case 7 /*H*/: crits.push({sev: 2, type:type, index:index }); break;
	    case 8 /*I*/: 
		crits.push({sev: 2, type:type, index:index });
		crits.push({sev: 0, type:type, index:index });
		break;
	    default /*J or more*/:
		crits.push({sev: 2, type:type, index:index });
		crits.push({sev: 1, type:type, index:index });
		break;
	    }
	    console.log(crits);
	} else {
	    // We only use origsev here;
	    crits.push({ sev: severity, type: type, origsev: origsev , index:index }); // Start with an E, then append some
	}
    }

    /*
    F E + A
    G E + B
    H E + C
    I E + C + A
    J E + C + B
    */
    attacks.getCritical = function(severity, type, index, overflow, additional, donefn) {
	const crits = [];
	let origsev = severity;

	attacks.generateCritList(crits, severity, type, index);
	/*
	this is barfign because the additonal crit is not being fetched.
	so I should fix tat.
	if (additional && additional != '') {
	    let newsev = parseIntDefault(additional.substring(1), 0) + origsev;
	    attacks.generateCritList(crits, newsev, additional.substring(0,1), origsev);
	}*/

	if (type.length > 1) {
	    type = attacks.critnameToCode[type];
	}

	// If we need to fetch crits here, do that first.
	{
	    const tofetch = {}
	    for (let i = 0 ; i < crits.length ; i ++) {
		console.log(crits[i].type)
		if (!attacks.knownCrits[crits[i].type]) {
		    const critname = "Criticals:" + attacks.critsToName[crits[i].type];
		    tofetch[critname] = true;
		}
	    }
	    const tofetchflat = Object.keys(tofetch);
	    console.log("Need to fetch", tofetch, tofetchflat, crits);
	    if (tofetchflat.length > 0) {
		getCompendiumPage("Criticals:" + attacks.critsToName[type], (data) => {
		    // FIXME: Handle errots here & multiple
		    console.log("fetched", data)
		    let result = JSON.parse(data.data['data-critical'])
		    // Save this
		    attacks.knownCrits[type] = result;
		    attacks.resolveCriticalList(crits, donefn);
		});

		return;
	    }
	}

	attacks.resolveCriticalList(crits, donefn);
    }

    // Returns an object:
    //	    critical = true | false
    //	    damage = the number of points of damage (Always present)
    //	    if true then sets
    //		severity - A-F
    //		severitynumeric: Number from -2 to X for character codes.  A = 0
    //		type = letter code
    //		typename = Name of the critical table
    attacks.parseCriticalResult = function(damage)  {
	if (typeof(damage) != 'number' && typeof(damage) != 'string') {
	    rmuerror("Invalid critical result; expect string or number", typeof(damage), damage);
	    return { critical: false, damage: -1 };
	}

	if (typeof(damage) == 'number') {
	    return { critical: false, damage: damage };
	}

	res = damage.match(/^(\d+)(([A-Z])([A-Z]))?$/);
	if (!res) {
	    rmuerror("Invalid critical result; neither \d or \dAK", typeof(damage), damage);
	    return { critical: false, damage: -1 };
	}

	if (!res[2]) {
	    // No critical
	    return { critical: false, damage: +(res[1]) };
	}

	let sev = res[3];
	let type = res[4];
	let name = attacks.critsToName[type] || "Unknown";
	if (name == 'Unknown') {
	    rmuerror("Warning: Unknown crit code", name);
	}

	console.log("Sev/type/name", sev, type, name);
	let numeric = sev.charCodeAt(0);
	console.log("numeric", numeric);
	if (numeric > 80) {
	    // Back end of hte alphabet, subtrack from 'Z'
	    numeric -= 'Z'.charCodeAt(0);
	    numeric -= 1;
	} else {
	    numeric -= 'A'.charCodeAt(0);
	}
	console.log("numeric  - ", numeric);
	const critinfo = { critical: true, damage: +(res[1]), 
		severity: sev, type: type, typename: name,
		severitynumeric: numeric};

	console.log("parseCritical:", damage, "->", critinfo);

	return critinfo;
    }

    //
    // Given a set of crit results and some hits.  Generate
    // an injury string, and descriptions.

    attacks.generateAttackResult = function (hits, critlist, result) {
	console.log("Generate attack result", hits, critlist, result);

	let injurystring = injury.updateInjuryString(hits, false, 'attacker', result);

	for (let i = 0 ; i < critlist.length ; i ++) {
	    let crit = critlist[i];
	    result['hascritical' + i] = 1
	    result['criteffect' + i] = crit.effect;
	    if (critlist.length > 1) {
		result['critdescription' + i] = crit.code + ": " + crit.description
	    } else {
		result['critdescription' + i] = crit.description
	    }
	    injurystring += crit.code + ":"
	    injurystring += injury.updateInjuryString(0, crit.results, 'attacker', result);
	}

	result.injurystring = injurystring;

	return result
    }

    // Params:
    //	    - rolls.attackroll.result - Roll + Skillmod
    //	    - rolls.attackrollum.result - Unmodfied attack roll
    //	    - cdata.fumblerange - Fumble number (<= is fumble)
    //	    - cdata.min - Minimum attack number to hit
    //	    - cdata.max - Top of the attack table
    //	    - cdata.targetat - The AT (single number) or ATs of the target
    //			(if 4 numbers, Torso,Head,Arms,Leg)
    //	    - cdata.attacksize - Attack size as number (0,1.. etc).  5 is medium
    //      - cdata.attackcritadjust - Int to modify crit
    //	    - cdata.attackersize - Size of the attacker
    //      - 
    //	    - cdata.targetsize = values.target_size || 0;
    //	    - cdata.targetcrit = values.target_crit || '';
    //      - cdata.attackmod = The numeric attack modifer - all mods
    //	    - cdata.attackmoddescription = Description of the above
    //      - cdata.statuspenalty = values.statuspenalty || 0;
    //      - cdata.extracrit = <CritType><number>  (number is relative crit type)
    //	    - cdata.targettokenid = Token ID of the target, (optional, string)

    // Results are:
    //	    - attackresult -> "Hit/Miss/Fumble"
    //	    - finalroll -> Either the UM if a fumble, else the modified attack roll
    //	    - hitlocation -> Where the hit was if it was a hit, or ""
    //	    - hitside -> Left or right
    //	    - tableres -> '17E' or '8' or "" (on fumble/miss)
    //	    - critical -> 88 or "" (on fumble/miss)
    //	    - fluff -> coming soon
    
    attacks.resolveAttack = function(rollId, rolls, cdata) {
	console.log("ResolveAttack", rollId, rolls, cdata);
	let result = {};
	let injuryhits = 0;
	let moddescription = '';
	// Nil out the defined fields
	result.attackresult = "??";
	result.finalroll = "??";

	result.attackmoddescription = cdata.attackmoddescription;
	result.attackmod = cdata.attackmod;

	// First check for a fumble
	if (rolls.attackrollum.result <= cdata.fumblerange) {
	    result.attackresult = "Fumble";
	    result.finalroll = rolls.attackrollum.result;
	    finishRoll(rollId, result);
	    attacks.afterAttack(cdata.attackafter);
	    return;
	}

	    
	result.finalroll = rolls.attackroll.result;
	// FIXME: Expand this roll into the log

	// Now did we hit or miss?
	if (result.finalroll < cdata.min) {
	    result.attackresult = getMiss();
	    finishRoll(rollId, result);
	    attacks.afterAttack(cdata.attackafter);
	    return;
	}

	result.attackresult = "Hit";
	result.ishit = 1;

	let critroll = rolls.critical.result;
	// Did we break the top of the table?
	if (result.finalroll > cdata.max) {
	    let delta = Math.floor((result.finalroll - cdata.max) / 5);
	    critroll += delta;
	}

	// We hit - Where?
	let hit = attacks.getLocation(critroll);

	// Attack data is a really big string - json it as late as we can
	let attackdata = JSON.parse(cdata.attackdata);

	// What is our row (need to clamp for top of the table)
	let rowid = Math.floor((Math.min(result.finalroll, cdata.max) - cdata.min) / 3);
	let row = attackdata[attackdata.length - rowid - 1]

	// what is our column (at)
	let at = 1;
	if (cdata.targetat) {
	    if (typeof(cdata.targetat) == 'number') {
		at = cdata.targetat;
	    } else {
		const res = cdata.targetat.match(/(\d+),(\d+),(\d+),(\d+)/);
		if (res) {
		    at = res[hit.atindex];
		    at = +at || 1;
		} else {
		    at = +cdata.targetat || 1;
		}
	    }
	}

	let damage = row["AT" + at];

	// Was there a critical?
	let critinfo = attacks.parseCriticalResult(damage);
	console.log("The cirtical result", critinfo, critinfo.severitynumeric);

	// Scale it if there is a cricial now
	if (critinfo.critical && typeof(cdata.attackcritadjust) == 'number' && 
		    cdata.attackcritadjust != 0) {
	    console.log("Crit adjust from attack: ", cdata.attackcritadjust,
		    typeof(cdata.attackcritadjust));
	    critinfo.severitynumeric += cdata.attackcritadjust;
	    critinfo.scaled = 1;
	}

	// Scale critical from size
	console.log("Target size", cdata.targetsize, critinfo, critinfo.severitynumeric);
	let sizedelta = +cdata.attacksize - +cdata.targetsize;

	// Scale damage for size
	{
	    let scale = attacks.scaleHits(sizedelta);
	    if (scale != 1) {
		critinfo.damage = Math.round(scale * critinfo.damage);
		critinfo.scaled = 1;
	    }
	}

	// Scale critical for crit reduction (if supplied)
	let critdelta = sizedelta - parseIntDefault(cdata.targetcrit, 0);

	if (critinfo.critical && critdelta != 0) {
	    critinfo.severitynumeric += critdelta;
	    critinfo.scaled = 1;
	}

	// If we are less than 'A'/1 walk index down
	// FIXME: This is now handled by resolve crit - should use that instead.
	if (critinfo.severitynumeric < 0) {
	    let sev = critinfo.severitynumeric;
	    // hit.roll contains the sanitised roll (1-100)
	    let newroll = hit.roll;
	    let side = hit.side;
	    while (sev < 0) {
		newroll = hitLocation[newroll].down;
		sev ++;
	    }
	    hit = attacks.getLocation(newroll);
	    hit.side = side; // Adjust side back to the original
	    critinfo.severitynumeric = 0; // It's now an 'A' (adjusted)
	}

	// Get the result ready: Last thing is the async crit.
	if (critinfo.scaled) {
	    if (critinfo.critical) {
		let critcode = numericToCritCode(critinfo.severitynumeric);
		result.damage = `${critinfo.damage}${critcode}${critinfo.type} (was ${damage})`
		injuryhits = critinfo.damage;
	    } else {
		result.damage = `${critinfo.damage} (was ${damage})`
		injuryhits = critinfo.damage;
	    }
	} else {
	    result.damage = damage;
	    injuryhits = damage;
	}
	result.hitlocation = hit.location;
	result.hitside = hit.side
	result.critical = critroll;
	result.materialgroup = cdata.materialgroup;

	// Get critical
	if (critinfo.critical) {
	    console.log("has a critical; getting crit", critinfo);
	    attacks.getCritical(critinfo.severitynumeric, critinfo.type, hit.critindex,
			false, cdata.extracrit, // OVerflow and additional
		(critinfo) => {
		    attacks.generateAttackResult(injuryhits, critinfo, result)
		    result.ishit = 1;
		    finishRoll(rollId, result);
		    attacks.afterAttack(cdata.attackafter);
		});
	    return;
	}

	result.injurystring = injury.updateInjuryString(injuryhits, {}, 'attacker', result);
	finishRoll(rollId, result);
	attacks.afterAttack(cdata.attackafter);
    }

    // Based on the size difference between the attack and foe,
    //	we scale the hits.
    //	Larger attacks do 1.5,2,3,...
    //	Smaller do the the inverse of the above
    attacks.scaleHits = function(sizeDelta) {
	if (typeof(sizeDelta) != 'number') {
	    rmuerror("ScaleHits: Expected number, got ", typeof(sizeDelta), sizeDelta);
	    return 1;
	}

	if (sizeDelta == 0) {
	    return 1;
	}

	let scale = 1;
	let inverse = false
	if (sizeDelta < 0) {
	    sizeDelta = -sizeDelta
	    inverse = true;
	}
	if (sizeDelta == 1) {
	    scale = 1.5;
	} else {
	    scale = sizeDelta;
	}
	if (inverse) {
	    scale = 1.0 / scale;
	}
	return scale;
    }

    //      - cdata.restrictedparry = true || falsey
    attacks.startAttack = function(cdata) {
	let attackmoddescription = '';
	let attackmod = 0;

	attackmod += cdata.attackbonus;
	attackmoddescription += ` +${cdata.attackbonus}&nbsp;[Attack&nbsp;Bonus]`; 

	if (cdata.attackhands == 'two') {
	    attackmod += 10;
	    attackmoddescription += ` +10&nbsp;[Two Hands]`;
	}

	if (cdata.statuspenalty < 0) {
	    attackmod += cdata.statuspenalty;
	    attackmoddescription += ` ${cdata.statuspenalty}&nbsp;[Status&nbsp;Penalty]`; 
	}

	if (cdata.targetsize < cdata.attackersize) {
	    const dbdiff = (5 * (cdata.attackersize - cdata.targetsize));
	    attackmod -= dbdiff;
	    attackmoddescription +=
		` -${dbdiff}&nbsp;[Size Difference (${cdata.attackersize} vs ${cdata.targetsize})]`;
	}

	attackmod -= cdata.targetdb;
	if (cdata.targetdb < 0) {
	    attackmoddescription += ` -(${cdata.targetdb})&nbsp;[Target&nbsp;DB]`;
	} else {
	    attackmoddescription += ` -${cdata.targetdb}&nbsp;[Target&nbsp;DB]`;
	}

	if (cdata.useap) {
	    let appenalty = 0;
	    if (cdata.attacktype == 'ranged') {
		if (cdata.apused < 1 || cdata.actionselect != 'missile') {
		    sendMessage("Must use at least 1 AP to fire missile");
		    return;
		}
		if (cdata.apused == 1) {
		    appenalty = 50;
		} else if (cdata.apused == 2) {
		    appenalty = 25;
		}
	    } else if (cdata.attacktype == 'directed') {
		if (cdata.apused < 2 || cdata.actionselect != 'spell') {
		    sendMessage("Must use at least 1 AP to cast directed spell");
		    return;
		}
		if (cdata.apused == 2) {
		    appenalty = 50;
		} else if (cdata.apused == 3) {
		    appenalty = 25;
		}
	    } else {
		if (cdata.apused < 2 || cdata.actionselect != 'melee') {
		    sendMessage(`Must use at least 2 AP to attack (Used ${cdata.apused})`);
		    return;
		}

		if (cdata.apused == 2) {
		    appenalty = 50;
		} else if (cdata.apused == 3) {
		    appenalty = 25;
		}
	    }

	    // If we have a penalty add it to the string etc
	    if (appenalty != 0) {
		attackmoddescription += ` -${appenalty}&nbsp;[Fast&nbsp;Attack (${cdata.apused}&nbsp;AP)]`;
		attackmod -= appenalty;
	    }
	}

	if (cdata.statuseffect) {
	    attackmoddescription += ` ${cdata.statuseffect}&nbsp;[Stun]`
	    attackmod += cdata.statuseffect;
	}

	if (cdata.restrictedparry && cdata.parrymod > 0) {
	    const hparry = Math.floor(parseIntDefault(cdata.parrymod, 0) / 2)
	    attackmoddescription += ` -${hparry}&nbsp;` +
			`[Parry (Restricted: ${cdata.parrymod} / 2)]`;
	    attackmod -= hparry;
	} else if (cdata.parrymod > 0) {
	    attackmoddescription += ` -${cdata.parrymod}&nbsp;[Parry]`;
	    attackmod -= cdata.parrymod;
	}

	if (cdata.attacktype == 'ranged' && cdata.ranged_penalty && cdata.ranged_penalty != 0) {
	    // If it exists, it's a penalty.  Maybe positive.  Maybe negative
	    let rp = cdata.ranged_penalty;
	    if (rp > 0) rp = -rp;
	    attackmoddescription += ` ${rp}&nbsp;[Armor Ranged Penalty]`;
	    attackmod += rp;
	}

	attackmod += cdata.othermod;
	if (cdata.othermod > 0) {
	    attackmoddescription += ` +${cdata.othermod}&nbsp;[Other]`;
	} else if (cdata.othermod < 0) {
	    attackmoddescription += ` ${cdata.othermod}&nbsp;[Other]`;
	}

	cdata.attackmod = attackmod;
	cdata.attackmoddescription = attackmoddescription;

	// The 'computed' version of the target is html entity encoded
	// FIXME: Entity should be all; not just )
	cdata.targetescaped = cdata.targetname.replaceAll(")", '&#41;');

	const roll_string = "@{whispertype} &{template:rmuattack} " +
	    `[[ [[ 1d100!>96 ]] + ${attackmod} ]] ` +
	    "[[ 1d100 ]] " + // crit roll
	    `{\{name=${cdata.character}}} ` +
	    `{\{target=${cdata.targetname}}} ` +
	    `{\{targetescaped=${cdata.targetescaped}}} ` +
	    `{\{weapon=${cdata.attackname}}} ` +
	    `{\{statuspenalty=${cdata.statuspenalty}}} ` +
	    `{\{attackmoddescription=[[0]]}} ` +
	    `{\{targetname=[[0]]}} ` +
	    "{\{hitlocation=[[1d7]] }} " +
	    "{\{attackrollum=$[[0]]}} " +
	    "{\{attackroll=$[[1]]}} " +
	    "{\{critical=$[[2]]}} " +
	    "{\{hascritical0=[[0]]}} " +
	    "{\{hascritical1=[[0]]}} " +
	    "{\{hascritical2=[[0]]}} " +
	    "{\{hascritical3=[[0]]}} " +
	    "{\{hascritical4=[[0]]}} " +
	    "{\{hascritical5=[[0]]}} " +
	    "{\{critdescription0=[[0]]}} " +
	    "{\{critdescription1=[[0]]}} " +
	    "{\{critdescription2=[[0]]}} " +
	    "{\{critdescription3=[[0]]}} " +
	    "{\{critdescription4=[[0]]}} " +
	    "{\{critdescription5=[[0]]}} " +
	    "{\{criteffect0=[[0]]}} " +
	    "{\{criteffect1=[[0]]}} " +
	    "{\{criteffect2=[[0]]}} " +
	    "{\{criteffect3=[[0]]}} " +
	    "{\{criteffect4=[[0]]}} " +
	    "{\{criteffect5=[[0]]}} " +
	    "{\{attackresult=[[0]]}} " +
	    "{\{damage=[[0]]}} " +
	    "{\{ishit=[[0]]}} " +
	    "{\{injurystring=[[0]]}} ";
	    console.log(roll_string);
	    console.log(cdata);
	    startRoll(roll_string, roll => {
		    attacks.resolveAttack(roll.rollId, roll.results, cdata);
	    });
    }

    onCheck('clicked:repeating_attack:rmuattackroll', (ev) => {
	attacks.doAttack(ev);
    });
    attacks.doAttack = function (ev) {
	const basename = ev.sourceAttribute.replace("_rmuattackroll", "");
	getAttrs(['character_name', `${basename}_attackstr`, `${basename}_attackmin`,
			`${basename}_attackmax`, `${basename}_attackdata`,
			`${basename}_attackbonus`,
			`${basename}_attackname`,
			`${basename}_attackfumble`,
			`${basename}_attacktype`,
			`${basename}_attackhands`,
			`${basename}_attackafter`,
			`${basename}_attackextracrit`,
			`${basename}_materialgroup`,
			`${basename}_attackcritadjust`,
			'size', `${basename}_attacksize`,
			'statuspenalty', 'statuseffect',
			'target_name', 'target_db', 'target_at',
			'target_size', 'target_crit',
			'parrymod', 'othermod', 'restrictedparry',
			// Ranged Penalty from armor
			'ranged_penalty',
			// Used depending on type: So get melee, missile and spell
			'actionselect', 'aptrack',
			'attackuseap', 'actionapperphase',
			'token_id'
			], values => {
		console.log('New attack: get attrs (with token)', values, ev);
		if (values.actionapperphase == '1' && 
			    values.statuseffect && values.statuseffect == 'staggered') {
		    sendMessage(`${values.character_name} is staggered, cannot attack`);
		    return;
		}
		cdata = {}
		cdata.min = +values[`${basename}_attackmin`];
		cdata.max = +values[`${basename}_attackmax`];
		cdata.fumblerange = +values[`${basename}_attackfumble`];
		cdata.character = values.character_name;
		cdata.attackbonus = +values[`${basename}_attackbonus`];
		cdata.attackdata = values[`${basename}_attackdata`];
		cdata.attacksize = sizeToNumeric(values[`${basename}_attacksize`] || 'M');
		cdata.attackersize = sizeToNumeric(values.size || 'M');
		cdata.attackname = values[`${basename}_attackname`] || "Weapon";
		cdata.attackhands = values[`${basename}_attackhands`] || "one";
		cdata.attackafter = values[`${basename}_attackafter`] || "nothing";
		cdata.attackcritadjust =
			    parseIntDefault(values[`${basename}_attackcritadjust`],0);
		cdata.str = +values.str || 0;
		cdata.targetname = values.target_name || "Foe";
		cdata.targetat = values.target_at || 1;
		cdata.targetdb = parseIntDefault(values.target_db, 0);
		cdata.targetsize = parseIntDefault(values.target_size, 5);
		cdata.targetcrit = parseIntDefault(values.target_crit, 0);
		cdata.statuseffect = parseIntDefault(values.statuseffect, 0);
		cdata.parrymod = parseIntDefault(values.parrymod, 0);
		cdata.othermod = parseIntDefault(values.othermod, 0);
		cdata.statuspenalty = parseIntDefault(values.statuspenalty, 0);
		cdata.useap = (values.attackuseap == 'on') ? true : false;
		cdata.materialgroup = values[`${basename}_materialgroup`] || '';
		cdata.extracrit = values[`${basename}_attackextracrit`] || '';
		// Use the attack type to get the right AP
		cdata.attacktype = values[`${basename}_attacktype`];
		cdata.apused = parseIntDefault(values.aptrack, 0);
		cdata.ranged_penalty = parseIntDefault(values.ranged_penalty, 0);
		cdata.actionselect = values.actionselect || 'nothing';
		cdata.restrictedparry = values.restrictedparry == 'on' ? true : false;
		attacks.startAttack(cdata);
	});
    }
    attacks.datarollregex = /^0\[(.*)\]\s*$/;
    attacks.getDataFromRoll = function (str) {
	return str.match(attacks.datarollregex)[1]
    }

    onCheck('clicked:rmuattackgettarget', (ev) => {
	attacks.getTargetData('target'); // Special keyword
    });

    onCheck('clicked:rmuattacktargetrefresh', (_) => {
	getAttrs(["target_characterid"], (ev) => {
	    console.log(ev);
	    const myid = setActiveCharacterId(ev.target_characterid);
	    console.log(myid);
	
	    getAttrs(["name", "db", "size", "name", "at_head", "at_torso", "at_arms", "at_legs"],
		    (remote) => {
		console.log("remote", remote);
		let atstr = ev.athead;
		if (remote.at_head != remote.at_torso ||
			remote.at_head != remote.at_arms ||
			remote.at_head != remote.at_legs) {
		    atstr = `${remote.attorso},${remote.athead},${remote.atarms},${remote.atlegs}`
		}

	    	let attrs = {target_at: atstr,
			target_name: remote.name,
			target_db: remote.db};

	    });
	    setActiveCharacterId(myid);
	});

/*
	getAttrs(["target_name"], (e) => {
		console.log(e);
		if (e.target_name && e.target_name.length > 0) {
		    attacks.getTargetData(ev.target_name);
		} else {
		    console.log("Can't refresh when no target selected");
		}
	});*/
    });

	function setActiveCharacterId(id) {
		const ocid = getActiveCharacterId();
		const data = {
			id: '0',
			type: 'setActiveCharacter',
			data: id,
		};
		if (self.dispatchEvent) {
			const event = new CustomEvent('message');
			event.data = data;
			self.dispatchEvent(event);
		}
		else {
			self.onmessage({ data });
		}
		return ocid;
	}
	function getAttrsAsync(props) {
		const acid = getActiveCharacterId();
		let ocid = null;
		return new Promise((resolve, reject) => {
			ocid = setActiveCharacterId(acid);
			try {
				getAttrs(props, (values) => resolve(values));
			}
			catch {
				reject();
			}
		}).finally(() => {
			setActiveCharacterId(ocid);
		});
	}

    onCheck('clicked:rmuattacktargetdelete', (ev) => {
	    console.log("Target delete");
	    setAttrs({target_at: 1,
		    target_name: 'Foe',
		    target_db: 0,
		    target_size: 5,
		    target_crit: 0
		    });
    });

    attacks.getTargetData = function(whom, prefix = "") {
	
	const roll_string = "@{whispertype} &{template:rmuattacktarget} [[1d20]]  " +
	    "{\{who=@{character_name}}} " +
	    `{\{targettokenid=[[0[@{${whom}|token_id}] ]]}} ` +
	    `{\{targetcharacterid=[[0[@{${whom}|character_id}] ]]}} ` +
	    `{\{targetname=[[0[@{${whom}|character_name}] ]]}} ` +
	    `{\{targetsize=[[0[@{${whom}|size}] ]]}} ` +
	    `{\{targetathead=[[0[@{${whom}|at_head}] ]]}} ` +
	    `{\{targetattorso=[[0[@{${whom}|at_torso}] ]]}} ` +
	    `{\{targetatarms=[[0[@{${whom}|at_arms}] ]]}} ` +
	    `{\{targetatlegs=[[0[@{${whom}|at_legs}] ]]}} ` +
	    `{\{targetdb=[[0[@{${whom}|db}] ]]}} ` +
	    `{\{targetdbmissile=[[0[@{${whom}|db}] ]]}} ` +
	    `{\{targetdbdirected=[[0[@{${whom}|db}] ]]}} ` +
	    `{\{targetcritred=[[0[@{${whom}|critreduction}] ]]}} ` +
	    "";
	startRoll(roll_string, roll => {
		const target_tokenid = attacks.getDataFromRoll(roll.results.targettokenid.expression);
		const tsize = attacks.getDataFromRoll(roll.results.targetsize.expression);
		const tname = attacks.getDataFromRoll(roll.results.targetname.expression);
		const athead = attacks.getDataFromRoll(roll.results.targetathead.expression);
		const attorso= attacks.getDataFromRoll(roll.results.targetattorso.expression);
		const atarms = attacks.getDataFromRoll(roll.results.targetatarms.expression);
		const atlegs = attacks.getDataFromRoll(roll.results.targetatlegs.expression);
		const db = attacks.getDataFromRoll(roll.results.targetdb.expression);
		const dodgem = attacks.getDataFromRoll(roll.results.targetdb.expression);
		const block = attacks.getDataFromRoll(roll.results.targetdb.expression);
		const critred = parseIntDefault(
			attacks.getDataFromRoll(roll.results.targetcritred.expression, 0));
		const charid = attacks.getDataFromRoll(roll.results.targetcharacterid.expression);
		let atstr = athead
		if (athead != attorso || athead != atarms || athead != atlegs) {
		    atstr = `${attorso},${athead},${atarms},${atlegs}`
		}
		let attrs = {target_at: atstr,
			target_name: tname,
			target_db: db,
			target_size: sizeToNumeric(tsize),
			target_crit: critred,
			target_tokenid: target_tokenid,
			target_characterid: charid};
		if (prefix != "") {
		    attrs = Object.keys(attrs).reduce((a, c) => 
			    (a[`${prefix}${c}`] = attrs[c], a), {});

		}
		console.log("fetched", attrs);
		setAttrs(attrs);
		finishRoll(roll.rollId, { targetname: tname })
	});
    }


    attacks.afterAttack = function(option) {

	if (!option || option === 'nothing') {
	    return;
	}

	// All options so far clear AP
	actionClear();

	if (option === 'endturn') {
	    doTurn();
	}
	

    }

    /** Roll Fumble/Crits etc stuff start */
    onCheck("clicked:rollfumble", (_) => { setAttrs({attackrollcritshow: "on"}); });
    onCheck("clicked:attackrollfumblecancel", (_) => { setAttrs({attackrollcritshow: 0}); });

    attacks.attackrollupdatetoggles = function() {
	getAttrs(['attackrollwhat', 'attackrollcritlookup'], (ev) => {
	    // Hide all the old stuff
	    const updates = {
		attackrollfumbletoggle: false,
		attackrollspellfailtoggle: false,
		attackrollcriticaltoggle: false,
		attackrollcriticallookuptoggle: false,
		attackrollattacktabletoggle: false,
		attackrollfumblelookuptoggle: false,
		attackrollfumblenotlookuptoggle: false,
		attackrolllookup: false,
		attackrollroll: false,
	    };
	    // Toggle the buttons
	    if (ev.attackrollcritlookup === 'on') {
		updates.attackrolllookup = 'on';
	    } else {
		updates.attackrollroll = 'on';
	    }


	    if (ev.attackrollwhat == 'weaponfumble') {
		updates.attackrollfumbletoggle = 'on';
		if (ev.attackrollcritlookup == 'on') {
		    updates.attackrollfumblelookuptoggle = 'on';
		} else {
		    updates.attackrollfumblenotlookuptoggle = "on";
		}
	    } else if (ev.attackrollwhat == 'spellfail') {
		updates.attackrollspellfailtoggle = 'on';
	    } else if (ev.attackrollwhat == 'crittable') {
		updates.attackrollcriticaltoggle = 'on';
		if (ev.attackrollcritlookup == 'on') {
		    updates.attackrollcriticallookuptoggle = 'on';
		}
	    } else if (ev.attackrollwhat == 'attacktable') {
		updates.attackrollattacktabletoggle = 'on';
	    }
	    console.log('Attack lookup set', updates);
	    setAttrs(updates);

	});
    }


    onCheck("change:attackrollcritlookup", attacks.attackrollupdatetoggles);
    onCheck("change:attackrollwhat",       attacks.attackrollupdatetoggles);

    // Roll it: Work out what is it and dispatch it appropriately.
    onCheck("clicked:attackrolldoroll", () => {
	console.log("Attack roll do roll");
	getAttrs(["attackrollwhat", "attackrollcritlookup",
		  "attackrollcriticalsev", "attackrollcriticaltype", "attackrollcriticalnumber",
		  "attackrollfumbletypetype", "attackrollfumblemod", "attackrollfumblelookupvalue",
		  "attackrollspellfailure"],
	  (data) => {
	    if (!data.attackrollwhat) {
		rmuerror("Attack roll what was not set\n", data);
		return;
	    }
	    console.log(data, data.attackrollwhat === 'spellfail', data.attackrollwhat)
	    if (data.attackrollwhat === 'crittable') {
		let rollvalue = undefined;
		if (data.attackrollcritlookup === 'on') {
		    rollvalue = parseIntDefault(data.attackrollcriticalnumber, 1);
		}
		attackrollcritical(data.attackrollcriticaltype,
			parseIntDefault(data.attackrollcriticalsev), rollvalue);
	    } else if (data.attackrollwhat === 'weaponfumble') {
		let rollvalue = undefined;
		let lookup = false;
		let mod = 0;
		if (data.attackrollcritlookup === 'on') {
		    lookup = true;
		    mod = parseIntDefault(data.attackrollfumblelookupvalue, 1);
		} else {
		    mod = parseIntDefault(data.attackrollfumblemod, 0);
		}
	    	fumbleRoll(data.attackrollfumbletypetype, mod, lookup);
	    } else if (data.attackrollwhat === 'spellfail') {
		console.log("Spell Failure roll");
		let table = data.attackrollspellfailure;
		let lookup = false;
		if (data.attackrollcritlookup === 'on') {
		    lookup = true;
		}
		spellFailureRoll(table, 0, lookup);

	    } else {
		console.log("Not implemented", data.attackrollwhat, data);	
	    }
	});
	// Send off after main async request starts
	setAttrs({attackrollcritshow: 0});
    });

    function attackrollcritical(type, degree, rollvalue) {
	let template;
	let theroll;
	if (rollvalue === undefined) {
	    template= "rmucritical"
	    theroll = '1d100'
	} else {
	    template = "rmucriticallookup";
	    theroll = rollvalue
	}

	const roll_string = `@{whispertype} &{template:${template}}` +
		"{\{who=@{character_name}}}" +
		`{\{roll=[[${theroll}]]}}` +
		"{\{type=[[0]]}}" +
		"{\{degree=[[0]]}}" +
		"{\{injurystring=[[0]]}}" +
		"{\{hascritical0=[[0]]}}" +
		"{\{hascritical1=[[0]]}}" +
		"{\{hascritical2=[[0]]}}" +
		"{\{critdescription0=[[0]]}}" +
		"{\{critdescription1=[[0]]}}" +
		"{\{critdescription2=[[0]]}}" +
		"{\{criteffect0=[[0]]}}" +
		"{\{criteffect1=[[0]]}}" +
		"{\{criteffect2=[[0]]}}";
		console.log(roll_string);
	startRoll(roll_string, roll => {
	    console.log("attackrollcritical", type, degree, typeof(type), typeof(degree));
	    let croll = parseIntDefault(roll.results.roll.result, 100);
	    if (croll < 1) {
		croll = 1;
	    } else if (croll > 100) {
		croll = 100;
	    }
	    const index = hitLocation[croll].rollindex;
	    const loc = {}
	    loc.hitlocation = hitLocation[croll].location;
	    loc.side = (croll & 1) ? "Left" : "Right";
	    attacks.getCritical(degree, type, index, false, false, (critinfo) => {
		    const result = attacks.generateAttackResult(0, critinfo, loc);
		    result.degree = numericToCritCode(degree);
		    result.type = attacks.critsToName[type];
		    finishRoll(roll.rollId, result);
	    });
	});

    }

    /* End of the roll table stuff */
    
    onCheck("clicked:attackadd", () => {
	setAttrs({attackaddshow : "on",  attackaddmessage : " ",
		    attackaddaction: "Add", attackaddbasename : "new",
		    attackaddcritadjust: 0});
    });

    let attackadditems = [
	"attackaddname", "attackaddskill", "attackaddtable", "attackaddsize",
	"attackaddfumble", "attackaddmodifier", "attackaddri", "attackaddstrength",
	"attackaddhands", "attackaddafter",
	"attackaddtype", "attackaddbasename", "attackaddcritadjust",
	"attackaddmaterialc", "attackaddmaterialw", "attackaddmaterials",
	"attackaddmateriali", "attackaddmaterialm",
	"attackaddadditionalcritical", 
	"attackaddadditionalcriticaltype", 
	"attackaddadditionalcriticalseverity", 
    ];

    // Returns 'true' if it validate, else an error mesasge (string)
    function attackaddvalidate(items) {
	for (const x of attackadditems) {
	    if (!(x in items) || items[x] === '') {
		return `Err${x}`;
	    }
	}

	return true
    }

    /**
     * Save the data from adding an attack on the sheet.
     */
    onCheck("clicked:attackaddsave", () =>  {
	// So we need to get the things; if there is an error we set the error mesage
	getAttrs(attackadditems, (items) => {
	    console.log("Fetched data:", items);
	    const validate = attackaddvalidate(items);
	    let updates = {};
	    if (typeof(validate) == 'string') {
		// Error
		setAttrs({"attackaddmessage": validate});
		return;
	    }
	    updates.attackaddmessage = "";
	    updates.attackaddshow = "off";

	    let prefix = "";
	    if (items.attackaddbasename && items.attackaddbasename != 'new') {
		prefix = items.attackaddbasename;
	    } else {
		const rowid = generateRowID();
		prefix = `repeating_attack_${rowid}`;
	    }

	    // Material
	    {
		let mtype = [];
		if (items.attackaddmaterialc == 'on') mtype.push('c');
		if (items.attackaddmaterialw == 'on') mtype.push('w');
		if (items.attackaddmateriali == 'on') mtype.push('i');
		if (items.attackaddmaterials == 'on') mtype.push('s');
		if (items.attackaddmaterialm == 'on') mtype.push('m');
		updates[`${prefix}_materialgroup`] = mtype.join('');
	    }

	    // Critical
	    if (items.attackaddadditionalcritical && items.attackaddadditionalcritical == 'on') {
		updates[`${prefix}_attackextracrit`] = items.attackaddadditionalcriticaltype +
			    items.attackaddadditionalcriticalseverity;
	    } else {
		updates[`${prefix}_attackextracrit`] = '';
	    }

	    getCompendiumPage(`AttackTable:${items.attackaddtable}`, cdata => {
		updates[`${prefix}_attackname`] = items.attackaddname;
		updates[`${prefix}_attacksize`] = sizeFromNumeric(items.attackaddsize);
		updates[`${prefix}_attackbasefumble`] = items.attackaddfumble;
		updates[`${prefix}_attacktable`] = items.attackaddtable;
		updates[`${prefix}_attackstr`] = items.attackaddstrength;
		updates[`${prefix}_attackhands`] = items.attackaddhands;
		updates[`${prefix}_attackafter`] = items.attackaddafter;
		updates[`${prefix}_attacksource`] = 'user';
		updates[`${prefix}_attackskill`] = items.attackaddskill;
		updates[`${prefix}_attackri`] = items.attackaddri;
		updates[`${prefix}_attacktype`] = items.attackaddtype;
		updates[`${prefix}_attackmodifier`] = parseIntDefault(items.attackaddmodifier, 0);
		updates[`${prefix}_attackcritadjust`] = parseIntDefault(items.attackaddcritadjust, 0);

		updates[`${prefix}_attackmin`] = cdata?.data?.min?.match(/\d+/)[0] || 0;
		updates[`${prefix}_attackmax`] = cdata?.data?.max?.match(/\d+/)[0] || 0;
		updates[`${prefix}_attackdata`] = cdata?.data['data-attack'] || "";
		// Once we have set it, update them all
		setAttrs(updates, attacks.updateAttackBonuses);
		console.log("Items saved", updates);
	    });
	});
    });
    
    onCheck("clicked:attackaddcancel", () =>  {
	setAttrs({"attackaddshow" : "off" });
    });
    
    /**/
    attacks.updateAttackBonuses = function () {
      getSectionIDsPending('repeating_attack', (ids) => {
	let toget = []
	ids.forEach((id) => {
	    toget.push(`repeating_attack_${id}_attackskill`);
	    toget.push(`repeating_attack_${id}_attackmodifier`);
	    toget.push(`repeating_attack_${id}_attackbasefumble`);
	});
	getAttrsPending(toget, (attackinfo) => {
	    // Now I need to get the skill bonuses
	    const skillSet = new Set();
	    ids.forEach((id) => {
		const name = attackinfo[`repeating_attack_${id}_attackskill`];
		if (name != 'none') {
		    skillSet.add(attackinfo[`repeating_attack_${id}_attackskill`] + '_bonus');
		    skillSet.add(attackinfo[`repeating_attack_${id}_attackskill`] + '_ranks');
		}
	    });
	    getAttrsPending(Array.from(skillSet), (skills) => {
		console.log("Attack bonuses retrieved", skills);
		const updates = {}
		ids.forEach((id) => {
		    let prefix = `repeating_attack_${id}_`;

		    let modifier =
			parseIntDefault(attackinfo[`repeating_attack_${id}_attackmodifier`], 0);
		    let skill = attackinfo[`repeating_attack_${id}_attackskill`];
		    let skillbonus = 0;
		    let skillranks = 0;
		    if (skill != 'none') {
			skillbonus = parseIntDefault(skills[skill + '_bonus'], 0);
			skillranks = parseIntDefault(skills[skill + '_ranks'], 0);
		    }
		    let fumble =
			parseIntDefault(attackinfo[`repeating_attack_${id}_attackbasefumble`], 0);

		    updates[prefix + 'attackbonus'] = skillbonus + modifier;
		    updates[prefix + 'attackfumble'] =
			    Math.max(1,
				parseIntDefault(attackinfo[prefix + 'attackbasefumble'], 10)
				- Math.floor(skillranks / 5));
		    updates[prefix + 'attackranks'] = skillranks;
		});
		setAttrsPending(updates);
	    });
		

	})
      });
    }

    onCheck("clicked:updateattacks", attacks.updateAttackBonuses);

    // FIXME: Should add a are you sure button
    onCheck('clicked:repeating_attack:deleteattack', (ev) => {
	const basename = ev.sourceAttribute.replace("_deleteattack", "");
	removeRepeatingRow(basename);
    });

    onCheck('clicked:repeating_attack:editattack', (ev) => {
	const basename = ev.sourceAttribute.replace("_editattack", "");
	const updates = {}
	updates.attackaddshow = 'on'
	updates.attackaddmessage = `Edit item: ${basename}`;
	// Don't get source - it is user now
	getAttrs([`${basename}_attackname`,`${basename}_attacksize`,
		    `${basename}_attackbasefumble`, `${basename}_attacktable`,
		    `${basename}_attackstr`, `${basename}_attackcritadjust`,
		    `${basename}_attackhands`, `${basename}_attackafter`,
		    `${basename}_attackskill`, `${basename}_attackri`,
		    `${basename}_attacktype`, `${basename}_attackmodifier`,
		    `${basename}_materialgroup`, `${basename}_attackextracrit`,
		    ], (attackinfo) => {
		console.log(attackinfo);
		updates.attackaddname = attackinfo[`${basename}_attackname`];
		updates.attackaddfumble = attackinfo[`${basename}_attackbasefumble`];
		updates.attackaddstrength = attackinfo[`${basename}_attackstr`];
		updates.attackaddtable = attackinfo[`${basename}_attacktable`];
		updates.attackaddskill = attackinfo[`${basename}_attackskill`];
		updates.attackaddhands = attackinfo[`${basename}_attackhands`];
		updates.attackaddafter = attackinfo[`${basename}_attackafter`];
		updates.attackaddri = attackinfo[`${basename}_attackri`];
		updates.attackaddcritadjust = attackinfo[`${basename}_attackcritadjust`] || 0;
		updates.attackaddtype = attackinfo[`${basename}_attacktype`];
		updates.attackaddmodifier = attackinfo[`${basename}_attackmodifier`];
		updates.attackaddsize = sizeToNumeric(attackinfo[`${basename}_attacksize`]);
		{
		    const material = attackinfo[`${basename}_materialgroup`] || '';
		    updates.attackaddmaterialc = material.includes('c') ? 'on' : 'off';
		    updates.attackaddmaterialw = material.includes('w') ? 'on' : 'off';
		    updates.attackaddmateriali = material.includes('i') ? 'on' : 'off';
		    updates.attackaddmaterials = material.includes('s') ? 'on' : 'off';
		    updates.attackaddmaterialm = material.includes('m') ? 'on' : 'off';
		}
		{
		    const extracrit = attackinfo[`${basename}_attackextracrit`] || '';
		    if (extracrit && extracrit.length > 1) {
			updates.attackaddadditionalcritical = 'on'
			updates.attackaddadditionalcriticaltype = extracrit.substring(0, 1);
			updates.attackaddadditionalcriticalseverity = extracrit.substring(1);
		    } else {
			updates.attackaddadditionalcritical = 0
		    }
		}

		updates.attackaddbasename = basename;
		updates.attackaddaction = 'Update';
		console.log(updates);
		setAttrs(updates);
	});
    });

})();

// vim: set sw=4 sts=4 syn=javascript :



function fumblematchrange(str) {
    let match = [];
    if (match = str.match(/^\d*$/)) {
	let tmp = parseIntDefault(match[0]);
	return [tmp, tmp]
    } else if (match = str.match(/^(\d*)\s*[–-]\s*(\d*)$/)) {
	
	return [parseIntDefault([match[1]], 0), parseIntDefault([match[2]], 0)];
    }
    rmuerror(`Unable to match range "${str}"`);
    return [undefined, undefined];
}

// Table is the name of the table to lookup
// modifier is the roll modifier OR the number to lookup
// lookup is a flag: Do you want to roll or lookup
//    template has:
//	who
//	computed:roll
//	computed:type
//	computed:rangemin
//	computed:rangemax
//	computed:result
function fumbleRoll(table, modifier, lookup) {
    let template = "rmufumble";
    let theroll = '1d100';
    if (lookup) {
	template = "rmufumblelookup";
	theroll = modifier;
    } else {
	if (modifier) {
	    theroll += ' + ' + modifier;
	}
    }

    const rollstring = `@{whispertype} &{template:${template}}` +
		"{\{who=@{character_name}}}" +
		`{\{roll=[[${theroll}]]}}` +
		"{\{type=[[0]]}}" +
		"{\{rangemin=[[0]]}}" +
		"{\{rangemax=[[0]]}}" +
		"{\{result=[[0]]}}";
    startRoll(rollstring, roll => {
	dofumblecompendiumlookup(table, parseIntDefault(roll.results.roll.result, 1), 
	    (result) => {
		result.type = table;
		finishRoll(roll.rollId, result);
	    }
	);
    });
}



function dofumblecompendiumlookup(table, value, donefn) {
    getCompendiumPage("Fumbles:" + table, (data) => {
	if (!data.data || !data.data.Category || data.data.Category != "Fumbles") {
	    console.log("Fetched Error:", data);
	    sendMessage("Error fetching fumble data"); 
	}
	console.log("fumble", table, data);
	// So data is an array keyed by '\d*' or '\d*-\d*'
	for (match in data.data) {
	    const [min, max] = fumblematchrange(match);
	    if (min === undefined) {
		console.log(match, "-> undefined, skipping");
		continue;
	    }
	    console.log("matching", value, min, max);
	    if (value >= min && value <= max) {
		donefn({
		    rangemin: min,
		    rangemax: max,
		    value: value,
		    result: data.data[match]
		});
	    }
	}
    });
}



function dospellfailureompendiumlookup(realm, type, value, donefn) {
    console.log(`Category:SpellFailure Realm:${realm} Type:${type}`)
    getCompendiumQuery(`Category:SpellFailure Realm:${realm} Type:${type}`, (data) => {
	console.log(data);
	console.log(data[0]);
	if (!data[0] || !data[0].data || !data[0].data.Category || data[0].data.Category != "SpellFailure") {
	    console.log("Fetched Error:", data);
	    sendMessage("Error fetching fumble data"); 
	}
	const results = JSON.parse(data[0].data['data-result']);
	console.log("results is ", results, data[0].data['data-result']);
	for (match of results) {
	    
	    console.log("match", match)
	    const min = parseIntDefault(match.min, 0);
	    const max = parseIntDefault(match.max, 10000)
	    if (min === undefined) {
		console.log(match, "-> undefined, skipping");
		continue;
	    }
	    console.log("matching", value, min, max);
	    if (value >= min && value <= max) {
		donefn({
		    rangemin: min,
		    rangemax: max,
		    value: value,
		    result: match.result
		});
	    }
	}
    });
}



// vim: set sw=4 sts=4 syn=javascript :




const posibleActions = {
    melee : { dots: 4, marker: 'red', display: "Melee Attack" },
    missile: { dots: 3, special : 'loaded', marker: 'green', display: "Missile Attack" },
    spell: { dots: 4, marker: 'blue', display: "Spell Casting" },
    perception: { dots: 2, marker: 'orange', display: "Perception" },
    eat: { dots: 2, display: "Eat/Drink" },
    stand: { dots: 2, display: "Standing" },
    dropprone : { dots: 2, display: "Dropping Prone" },
    other: { dots: 4, display: "Other Action" },
    pickup: { dots: 3, display: "Pickup item" },
    mount: {dots : 4, display: "Mount steed" },
    dismount: {dots : 4, display: "Dismount steed" },
    stringbow: { dots: 6, display: "String bow" },
    loadlight: {dots : 6, display: "Load Light Crossbow", },
    loadheavy: { dots : 14, display: "Load Heavy Crossbow" },
    fulldodge: { dots: 4, display: "Full Dodge" },
    fullblock: { dots: 4, display: "Full Block" },
    picklock : { dots: 20, display: "Pick Lock or Disarm Trap" },
};

// Curent action changed: Clear all the bits
onCheck("change:actionselect", (ev) => {
  setAttrs(actionSelection(ev.newValue, ev.previousValue));
});

function actionSelection(newValue, previousValue) {
    // If you change to the same one we ignore it.
    if (previousValue) {
      if (previousValue == newValue) {
	// Same... do nothing
	return;
      }
    }

    const updates = {}

    let dots = { dots: 4 }; // Assume the default
    if (posibleActions[newValue]) {
      dots = posibleActions[newValue];
    }

    // turn off the specials first
    updates[`aptracktoggleloaded`] = 'off';
    if (dots.special) {
      updates[`aptracktoggle${dots.special}`] = 'on';
    }

    for (let i = 1 ; i <= 20 ; i ++) {
      if (i <= dots.dots) {
	updates[`aptracktoggle${i}`] = 'on';
      } else {
	updates[`aptracktoggle${i}`] = 'off';
      }
    }

    // Only on PC page... don't need to track aptrackcreature
    updates.apspellmirror = 0;

    updates.aptrack = 0;
    updates.aptrackcreature = 0;

    return updates;
}

// Request a single AP in something.
function actionIncrease(action) {
  if (!posibleActions[action]) {
    rmuerror("actionIncrease", "Unknown Action", action);
    return
  }
  const info = posibleActions[action];
  // FIXME: Handle loaded
  getAttrs(['actionselect', 'aptrack', 'aptrack_loaded', 'aptrackcreature', 'character_name'],
    (state) => {
      let aptrack = Math.max(
	    parseIntDefault(state.aptrackcreature, 0), 
	    parseIntDefault(state.aptrack, 0))

      let updates = {}
      if (state.actionselect != action) {
	updates = actionSelection(action);
	aptrack = 0;
      }

      // This can be generalised, but ony special is loaded for now
      if (info.special === 'loaded' && state.aptrack_loaded !== 'on') {
	updates.aptrack_loaded = 'on';
      } else {
	aptrack ++;
	if (aptrack > info.dots) {
	  aptrack = info.dots;
	}
      }
      updates.aptrack = aptrack;
      updates.aptrackcreature = aptrack;
      updates.actionselect = action;
  
      // Only on PC page... don't need to track aptrackcreature
      if (action == 'spell') {
	updates.apspellmirror = aptrack;
      } else {
	updates.apspellmirror = 0;
      }
    
      console.log("Actially setting", updates);
      setAttrs(updates, { silent: true });
      sendMessage(`${state.character_name} now has ${updates.aptrack} on ${info.display}`);
  });

}

// Update the spell tracker.
// This should only trigger in response to the user clicking something;
// other updates are done using 'silent'
onCheck("change:aptrack", () => {
  getAttrs(["aptrack", "actionselect"], (data) => {
    if (data.actionselect == 'spell') {
      setAttrs({apspellmirror: data.aptrack});
    }
  });
})

function actionClear() {
  // Just set the the AP to zero
  setAttrs({ aptrack: 0, aptrackcreature: 0 }, { silent: true });
  getAttrs(['character_name'], (status) => {
      sendMessage(`${status.character_name} resets thier action`);
  });
}

function actionConcentration() {
  setAttrs({ aptrack_concentration: 'on' }, {silent: true});
  getAttrs(['character_name'], (status) => {
      sendMessage(`${status.character_name} Concentrates`);
  });
}

function actionStatus() {
  getAttrs(['actionselect', 'aptrack', 'aptrackcreature', 'character_name'], (status) => {
    const ap = Math.max(
	    parseIntDefault(status.aptrackcreature, 0), 
	    parseIntDefault(status.aptrack, 0))
    const info = posibleActions[status.actionselect];
    sendMessage(`${status.character_name} has spent ${ap} AP on ${info.display}`);
  });
}


// Free checked; record current phase.  In 4 phases we clear it
onCheck("change:aptrack_freeused", (_) => { handleFreeClicked(); });

onCheck("change:aptrack_loaded", (ev) => {
  console.log(ev);
  if (ev.newValue == 'on') {
    startRoll(`@{whispertype} &{template:rmuactionload}  {\{who=@{character_name}}} `, roll => {
	finishRoll(roll.rollId);
    });
  } else {
    startRoll(`@{whispertype} &{template:rmuactionunload}  {\{who=@{character_name}}} `, roll => {
	finishRoll(roll.rollId);
    });
  }
});


// This is on the attack panel, but it makes sense here
// So new combat:
//   - Reset phase
//   - Reset AP
//   - Reset freeaction
onCheck("clicked:newcombat", () => {
    const updates = actionSelection("melee", "missile");
    setAttrs({
      ...updates,
      aptrack_concentration: 0,
      aptrack_concentration_prev1: "off",
      aptrack_concentration_prev2: "off",
      aptrack_concentration_prev3: "off",
      aptrack_concentration_prev4: "off",
      aptrack_lastconcentration: 0,
      parrymod: 0,
      othermod: 0,
      currentphase: 0,
      currentphasedisplay: 0,
      freeused: 0,
      freeactionphase: -1 },
      { silent: true });
    getAttrs(["character_name"], (ev) => {
	sendMessage(`${ev.character_name} prepares for battle`);
    });
    actionsUpdateStatus();
    updatetokenmarkers();
});

// So this is our per AP stuff
onCheck("clicked:endphase clicked:endturn", () => {
    console.log("end phase");
  // FIXME: Should reset when initiative is rolled
  doTurn();
});

onCheck("clicked:deletebleed", () => {
    getAttrs(["character_name"], (x) => {
	sendMessage(`${x.character_name} is no longer bleeding`);
	setAttrs({ bleeding: 0, bleedlist: []});
	updatetokenmarkers();
    });
});

onCheck("clicked:statusstun75delete", () => {
    getAttrs(["character_name"], (x) => {
	sendMessage(`${x.character_name} has stun-75 lifted.`);
	setAttrs({ statusstun75: 0 }, actionsUpdateStatus);
	updatetokenmarkers();
    });
});

onCheck("clicked:statusstun50delete", () => {
    getAttrs(["character_name"], (x) => {
	sendMessage(`${x.character_name} has stun-50 lifted.`);
	setAttrs({ statusstun50: 0 }, actionsUpdateStatus);
	updatetokenmarkers();
    });
});

onCheck("clicked:statusstun25delete", () => {
    getAttrs(["character_name"], (x) => {
	sendMessage(`${x.character_name} has stun-25 lifted.`);
	setAttrs({ statusstun25: 0 }, actionsUpdateStatus);
	updatetokenmarkers();
    });
});

function handleFreeClicked() {
  getAttrs(["currentphase", "aptrack_freeused", "character_name"], (data) => {
      if (data.aptrack_freeused == 'on') {
	const currentphase = parseIntDefault(data.currentphase, 0);
	// Turn it off at the _end_ of which phase.
	setAttrs({freeactionphase: currentphase + 3});
	sendMessage(`${data.character_name} uses their free action`);
      }
  });
}

function handleBleed(currentphase, bleedlist) {
  // Bleedlist is probably a string.
  if (!bleedlist || typeof(bleedlist) != 'string') {
    return 0;
  }

  // Shift current phase to 1..4
  const relphase = (currentphase - 1) % 4 + 1;

  const bleeds = JSON.parse(bleedlist);
  let total = 0;

  for (let bleed of bleeds) {
    if (bleed.phase == relphase) {
      // May be some bleeds without a startphase.
      if (bleed.startphase && bleed.startphase == currentphase) {
	continue;
      }
      total += bleed.amount;
    }
  }

  return total;
}

function totalBleed(bleedlist) {
  // Bleedlist is probably a string.
  if (!bleedlist || typeof(bleedlist) != 'string') {
    return 0;
  }

  const bleeds = JSON.parse(bleedlist);
  let total = 0;

  for (let bleed of bleeds) {
    total += bleed.amount;
  }

  return total;
}

/**
 * Generic handler for the status list updates.  Called once per phase.
 *
 * {
 *   name: "Bleed" or "Blur" // required
 *   remaining: N,  *count down in phases; until deleted if not set
 *   phase: X, The phase the activity happens.  If no phase we are just a count down
 *  }
 *   
 *   
 */
function handleStatusListUpdate(statuslist, currentphase) {
  if (!statuslist || typeof(statuslist) != 'array') {
    return;
  }

  // Shift current phase to 1..4
  currentphase = (currentphase - 1) % 4 + 1;

  for (let st of statuslist) {
    if (st.remaining) {
      // Reduce by 1
      st.remaining --;
      if (st.remaining == 0) {
		
      }
    }
  }
}

function roundString(phases) {
  let roundstr = '';
  if (phases == 0) {
    return 0;
  }
  const rounds = Math.floor(phases / 4);
  if (rounds > 0) {
    roundstr = `${rounds}`
  }
  const pphases = phases % 4;
  if (pphases == 1) {
    roundstr += '\xBC'
  } else if (pphases == 2) {
    roundstr += '\xBD'
  } else if (pphases == 3) {
    roundstr += '\xBE'
  }
  return roundstr;
}

/***/
function actionsUpdateStatus() {
  getAttrs(["character_name", "statusstagger", "statusstun75", "statusstun50", "statusstun25",
            "grapplestatus",
	    "statuslist", "statuspenalty"], (status) => {
	let updates = {}

	let statusstagger = parseIntDefault(status.statusstagger, 0);
	let statusstun75 = parseIntDefault(status.statusstun75, 0);
	let statusstun50 = parseIntDefault(status.statusstun50, 0);
	let statusstun25 = parseIntDefault(status.statusstun25, 0);
	let grapplestatus = parseIntDefault(status.grapplestatus, 0);

	updates.statuseffect = 0;  // Default

	updates.statusmessage = 'Okay';
	let statuspenalty = parseIntDefault(status.statuspenalty, 0);
	updates.allpenalties = statuspenalty;
	if (statusstagger) {
	  updates.statuseffect = 'staggered'
	  updates.statusmessge = 'Staggered'
	  updates.allpenalties =  -300;
	} else if (statusstun75) {
	  updates.statuseffect = -75;
	  updates.statusmessage = 'Stun -75'
	  updates.allpenalties = updates.statuseffect + statuspenalty;
	} else if (statusstun50) {
	  updates.statuseffect = -50;
	  updates.statusmessage = 'Stun -50'
	  updates.allpenalties = updates.statuseffect + statuspenalty;
	} else if (statusstun25) {
	  updates.statuseffect = -25;
	  updates.statusmessage = 'Stun -25'
	  updates.allpenalties = updates.statuseffect + statuspenalty;
	}

        if (grapplestatus > 0) {
          updates.allpenalties -= grapplestatus;
          if (updates.statusmessage === "Okay") {
            updates.statusmessage = `Grappled ${grapplestatus}%`;
          } else {
            updates.statusmessage += `; Grappled ${grapplestatus}%`;
          } 
        }

	updates.statuspercent = Math.max(100 + updates.allpenalties, 0);
	updates.statuspercent200 = Math.max(200 + updates.allpenalties, 0);

	rmuSetAttrs(updates);
    });

}

/**
 * Update fields based on a status.
 *
 * We track free actions, stuns and bleeds specially.
 *
 * Stuns are special as they don't cool down together - instead just
 * the worst.
 * FIXME: Join these into a single infrastrucure.
 */
function doTurn() {
  getAttrs(["character_name", "currentphase",  "actionapperphase",
      "bleedlist", "hp", "freeactionphase",
      "aptrack_concentration",
      "aptrack_concentration_prev1",
      "aptrack_concentration_prev2",
      "aptrack_concentration_prev3",
      "statusstagger", "statusstun75", "statusstun50", "statusstun25",
      "statuslist"],
    (turn) => {
      console.log("End of turn updates", turn);
      const apperphase = parseIntDefault(turn.actionapperphase, 1);
      let currentphase = parseIntDefault(turn.currentphase, 1);
      const relativephase = (currentphase - 1) % 4 + 1;
      const freeactionphase = parseIntDefault(turn.freeactionphase, -1); // Default is never
      const round = Math.floor((currentphase + 3) / 4);
      const name = turn.character_name;
      const updates = {};
      let statuslist = []
      if (turn.statuslist) {
	statuslist = JSON.parse(turn.statuslist);
      }

      let statusstagger = parseIntDefault(turn.statusstagger, 0);
      let statusstun75 = parseIntDefault(turn.statusstun75, 0);
      let statusstun50 = parseIntDefault(turn.statusstun50, 0);
      let statusstun25 = parseIntDefault(turn.statusstun25, 0);
      let hp = parseIntDefault(turn.hp, 0);

      // For each phase we are advancing, apply each effect
      for (let i = 0 ; i < apperphase ; i ++) {
	{
	  const n = handleBleed(currentphase, turn.bleedlist); 
	  if (n > 0) {
	    hp -= n;
	    sendMessage(`${name} bleeds ${n} hits.  Now has ${hp} hits`);
	    updates.hp = hp;
	  }
	}

//	handleGeneralStatus(currentphase, statuslist);

	if (freeactionphase == currentphase) {
	  sendMessage(`${name} has a free action available`);
	  updates.aptrack_freeused = 0;
	  updates.freeactionphase = -1;
	}

	/* If Else chain as stagger beats stuns, and stuns in order */
	if (statusstagger > 0) {
	  statusstagger --;
	  if (statusstagger == 0) {
	    sendMessage(`${name} is no longer staggered`);
	  }
	} else if (statusstun75 > 0) {
	  statusstun75 --;
	  if (statusstun75 == 0) {
	    sendMessage(`${name} is no longer stunned at -75`);
	  }
	} else if (statusstun50 > 0) {
	  statusstun50 --;
	  if (statusstun50 == 0) {
	    sendMessage(`${name} is no longer stunned at -50`);
	  }
	} else if (statusstun25 > 0) {
	  statusstun25 --;
	  if (statusstun25 == 0) {
	    sendMessage(`${name} is no longer stunned at -25`);
	  }
	}

	currentphase = currentphase + 1;
      } // End the per AP advance

      /*  */
      updates.aptrack_concentration_prev4 = turn.aptrack_concentration_prev3;
      updates.aptrack_concentration_prev3 = turn.aptrack_concentration_prev2;
      updates.aptrack_concentration_prev2 = turn.aptrack_concentration_prev1;
      updates.aptrack_concentration_prev1 = turn.aptrack_concentration;
      updates.aptrack_concentration = 0; 

      updates.currentphase = currentphase;
      updates.statusstagger = statusstagger;
      updates.statusstun75 = statusstun75;
      updates.statusstun50 = statusstun50;
      updates.statusstun25 = statusstun25;

      updates.statusstun75info = roundString(statusstun75);
      updates.statusstun50info = roundString(statusstun50);
      updates.statusstun25info = roundString(statusstun25);

      updates.currentphasedisplay = roundString(currentphase);

      VrmuSetAttrs(updates, ()=> {
	  sendEOTMessage(`${name} completes their turn (Round ${updates.currentphasedisplay})`)
	  actionsUpdateStatus();
	  updatetokenmarkers();
      });
  });
}

/* */
onCheck("change:activedefense change:parrymod change:parrytype", (_) => {
  updateCurrentDefenseMode();
});

function updateCurrentDefenseMode() {
    getAttrs(['activedefense', 'parrymod', 'parrytype',
      'db_passivedodge', 'db_passivedodgemissile', 'db_passiveblock',
      'db_partialdodge', 'db_partialdodgemissile', 'db_partialblock',
      'db_fulldodge', 'db_fulldodgemissile', 'db_fullblock'], (ev) => {
	  const update = {};
	  if (!ev.parrytype) {
	    ev.parrytype = 'parrynormal'
	  }

	  let db = parseIntDefault(ev.parrymod, 0);
	  if (ev.parrytype == 'parryenhanced' && db > 1) {
	    db = Math.floor(db * 1.5);
	  } else if (ev.parrytype == 'parryrestrict' && db > 1) {
	    db = Math.floor(db / 2);
	  }

	  if (ev.activedefense == 'partialblock') {
	    update.activedb  = `${ev.db_partialblock}`
	    update.db = db + ev.db_partialblock;
	  } else if (ev.activedefense == 'partialdodge') {
	    let melee = db + ev.db_partialdodge;
	    let missile = db + ev.db_partialdodgemissile;
	    update.activedb = `${melee} / ${missile}`;
	    update.db = melee;
	  } else if (ev.activedefense == 'fullblock') {
	    update.activedb = db + ev.db_fullblock;
	    update.db = db + ev.db_fullblock;
	  } else if (ev.activedefense == 'fulldodge') {
	    let melee = db + ev.db_fulldodge;
	    let missile = db + ev.db_fulldodgemissile;
	    update.activedb = `${melee} / ${missile}`;
	    update.db = melee;
	  } else if (ev.activedefense == 'surprised') {
	    // FIXME
	    update.activedb = 'bad time';
	    update.db = -100;
	  } else if (ev.activedefense == 'flatfooted') {
	    update.activedb = 'real bad time';
	    update.db = -200;
	  } else { // passive
	    let pdb = db + Math.max(ev.db_passiveblock, ev.db_passivedodge);
	    update.activedb = `${pdb}`;
	    update.db = pdb
	  }

	  update.activedb_info = 'Stuff!!';

	  setAttrs(update);
      });
}


function actionClearActions() {
  let update = actions.reduce((update, item) => {
	  update[item] = 0;
	}, {});
  setAttrs(update);
}





function getCurrentDateString() {
  const today = new Date();
  const year = today.getFullYear();
  let month = today.getMonth() + 1; // Months are 0-indexed, so add 1
  let day = today.getDate();

  // Add leading zeros if month or day is less than 10
  if (month < 10) {
    month = '0' + month;
  }
  if (day < 10) {
    day = '0' + day;
  }

  return `${year}-${month}-${day}`;
}


onCheck("clicked:journaladdshow", (_) => {
    const fields = {};
    fields.togglejournaladdshow = 'on';
    fields.journaladdsessiondate = getCurrentDateString();
    // don't mess with the in game date. let people update
    fields.journaladdtitle = "";
    fields.journaladddescription = "";
    fields.journaladdxp = 0;
    console.log(fields);
    setAttrs(fields);
});

onCheck("clicked:journaladdcancel", (_) => {
    setAttrs({togglejournaladdshow: "off"});
});

onCheck("clicked:journaladdsave", (_) => {
    rmuGetAttrs(["togglejournaladdshow", "journaladdsessiondate",
	    "journaladdingamedate", "journaladdtitle",
	    "journaladddescription", "journaladdxp"], (data) => {
	addJournalEntry(data.journaladdingamedate,
	      data.journaladdsessiondate,
	      data.journaladdtitle,
	      data.journaladddescription,
	      data.journaladdxp);
	setAttrs({togglejournaladdshow: "off"});
    });
});

function addJournalEntry(ingamedate, sessiondate, title, description, xp) {
  const rid = generateRowID();
  const entry = {}
  entry[`repeating_journalentry_${rid}_ingamedate`] = ingamedate;
  entry[`repeating_journalentry_${rid}_sessiondate`] = sessiondate;
  entry[`repeating_journalentry_${rid}_title`] = title;
  entry[`repeating_journalentry_${rid}_description`] = description;
  entry[`repeating_journalentry_${rid}_xp`] = xp;
  if (xp > 0) {
    rmuGetAttrs(["xp"], (data) => {
	entry.xp = parseIntDefault(data.xp,0) + xp;
	setAttrs(entry);
    });
  } else {
    rmuSetAttrs(entry);
  }
}

onCheck("clicked:journalxprefresh", (_) => {
    getSectionIDs("repeating_journalentry", (ids) => {
	let toget = ids.map((id) => { return `repeating_journalentry_${id}_xp`});
	getAttrs(toget, (xps) => {
	    let xp = 0;
	    for (const [_, entry] of Object.entries(xps)) {
		xp += parseIntDefault(entry, 0); 
	    }
	    setAttrs({xp: xp});
	});
	
    });
});



// vim: set sw=2 sts=2 syn=javascript : 


const fatigueResults = {
  absolutefail: {
    msg:  "You feel a weakness wash over you. When is it going to be time for bed? " +
      "Increase your current fatigue penalty by 20 and suffer 10 hits.",
    hits: -10,
    fatigue: -20
  },
  fail: {
    msg: "Why is everyone moving so fast? What's the rush, you just need a short nap. " +
      "Just a few minutes…. please? Increase your fatigue penalty by 10.",
    fatigue: -10
  },
  unusual: {
    msg: "While fighting off exhaustion you have a brief hallucination that gives you insight " +
      "into a problem you have been having. You may, in the next 24 hours, reroll a previously " +
      "failed Lore, Science, or Delving roll in order to achive your goal.",
  },
  partial: {
    msg: "It's hard work, and every bit saps your just strength. But surely you are " +
      "strong enough to push on ahead. Increase fatigue penalty by 5.",
    fatigue: -5,
  },
  success: {
    msg: "Between the excitement and your fortitude, you shrug off the exhaustion and are " +
      "ready for whatever is coming next. You accumulate no additional fatigue.",
  },
  absolutesuccess: {
    msg: "It's time for a marathon. You take solace in your task and feel more energized " +
      "than ever to tackle what lies before you. Reduce any current fatigue penalty by 10, " +
      "and gain a +5 to whatever action you are about to perform.",
    fatigue: 5
  }
};


onCheck("change:hppenalty change:injurypenalty change:fatigue", updatePenalties);

onCheck("change:bodydevelopment_bonus change:hits change:powerdevelopment_bonus change:pp_multiplier",
	    updateHPPP);

function updateHPPP(_) {
    getAttrs(['bodydevelopment_bonus', 'hp', 'pp', 'powerdevelopment_bonus', 'hits',
	  'hp_misc', 'pp_multiplier', 'sheettype'], (ev) => {
	let update = {}
	let hplog = "Hit Points\n"
	let hp = 0;

        {
	  let [mtot, mlog] = miscBonusTotal(ev.hp_misc);
	  hplog += mlog
	  hp += mtot;
	}
	let bdbonus = parseIntDefault(ev.bodydevelopment_bonus, 0)
	hp += bdbonus;
	hplog += `${bdbonus}  Body Development`;
	// Creatures use 'hits'; Use that instead of bodydevelopement
	if (ev.hits) {
	  hp = ev.hits
	}
	update.hp_max = hp;
	update.hp_info = hplog;

	if (ev.sheettype != 'playersheet') {
	  let pp = ev.powerdevelopment_bonus;
	  if (pp < 0) {
	    pp = 0;
	  }
	  if (ev.pp_multiplier) {
	    let mul = Number.parseFloat(ev.pp_multiplier);
	    if (!Number.isNaN(mul) && mul > 0) {
	      // So it's valid
	      pp = Math.floor(mul * pp);
	    }
	  }

	  update.pp_max = pp
	}
	setAttrs(update, { silent:true });
    });
}

// Update the endurance modifier
onCheck("change:bodydevelopment_bonus change:endurance_misc change:mentalfocus_bonus", (_) => {
    updateEnduranceBonus()
});

function updateEnduranceBonus() {
    getAttrs(['bodydevelopment_bonus', 'endurance_misc', 'mentalfocus_bonus'], (ev) => {
	let log = "Endurance\n" +
	    `${F(ev.bodydevelopment_bonus)} Body Development\n`;
	const end = miscBonusTotal(ev.endurance_misc);
	log += end[1];
	let total = parseIntDefault(ev.bodydevelopment_bonus, -100) + end[0];
	log += `${T(total)} Total`;

	let mfbonus = parseIntDefault(ev.mentalfocus_bonus, -100);
	let mlog = "Mental Endurance\n" +
	    `${F(mfbonus)} Mental Focus\n`;
	mlog += end[1];
	let mftotal = mfbonus + end[0]
	mlog += `${T(mftotal)} Total`;
	setAttrsPending({
	    endurance: total,
	    endurance_info: log,
	    mentalendurance: mftotal,
	    mentalendurance_info: mlog
	    });
    });
}


onCheck("change:hp", (_) => {
    getAttrs(['hp', 'hp_max'], (values) => {
	let update = {};
	let ratio = values.hp / values.hp_max;
	let hppercent = Math.min(Math.max(ratio || 0,0) * 100,100);
	if (ratio > 0.75) {
	  update.hppenalty = 0;
	} else if (ratio > 0.5) {
	  update.hppenalty = -10;
	} else if (ratio > 0.25) {
	  update.hppenalty = -20;
	} else if (ratio > 0) {
	  update.hppenalty = -30;
	} else {
	  update.hppenalty = -100;
	}
	update.hp_percent = hppercent;
	setAttrs(update, { slient: true});
    });
});

onCheck("change:pp", (_) => {
    getAttrs(['pp', 'pp_max'], (values) => {
      let update = {}
      if (values.pp == values.pp_max) {
	update.pp_percent = 100;
      } else {
	let ratio = +values.pp / +values.pp_max;
	update.pp_percent = Math.min(Math.max(ratio || 1,0) * 100,100);
      }
      setAttrs(update, { silent: true });
    });
});


onCheck("clicked:enduranceroll", (_) => {
    // FIXME: Encumberance penalty as well
    doEnduranceRoll("endurance");
});

onCheck("clicked:mentalfatigueroll", (_) => {
    doEnduranceRoll("mental");
});

function doEnduranceRoll(type) {
  if (type != "mental" && type != "endurance") {
    rmuerror("Unknown endurance roll type");
    type = "endurance";
  }

    getAttrs(['character_name', 'endurance', 'fatigue', 'injurypenalty',
	      'hppenalty', 'hp', 'mentalendurance'], (ev) => {
	      console.log(ev);
	const roll_string = "@{whispertype} &{template:rmuendurance} " +
	    "[[ [[ 1d100!>96 ]] + [[ 1d100!>96 ]] ]] " +
	    "{\{firstroll=$[[0]]}} " +
	    "{\{secondroll=$[[1]]}} " +
	    `{\{name=${ev.character_name}}}` +
	    "{\{message=[[0]]}} " +
	    "{\{hashitupdate=[[0]]}} " +
	    "{\{hitupdate=[[0]]}} " +
	    "{\{hasfatigueupdate=[[0]]}} " +
	    "{\{fatigueupdate=[[0]]}} " +
	    "{\{updates=[[0]]}}";
	startRoll(roll_string, roll => {
	    // Check for OE low.
	    let log = "= (";
	    let endroll = parseInt(roll.results.firstroll.result);
	    let ue = false;
	    if (endroll == 66) {
	      ue = true;
	      log = '66 UM!';
	    } else {
	      if (endroll < 6) {
		log += `${endroll} - (`;
		endroll -= parseInt(roll.results.secondroll.result);
		log += roll.results.secondroll.dice.join(' + ');
		log += ')'
	      } else {
		log += roll.results.firstroll.dice.join(' + ');
	      }
	      if (type == 'mental') {
		endroll += parseIntDefault(ev.mentalendurance, 0);
		log += `) + ${ev.endurance}&nbsp;(Mental Endurance)`
	      } else {
		endroll += parseIntDefault(ev.endurance, 0);
		log += `) + ${ev.endurance}&nbsp;(Endurance)`
	      }
	      for (const pen of [ ["fatigue", "Fatigue Penalty"],
		      ['injurypenalty', "Injury Penalty"],
		      ['hppenalty', "Hits Penalty"] ]) {
		  if (ev[pen[0]]) {
		    let value = parseInt(ev[pen[0]]);
		    if (value == 0) {
		      continue;
		    }
		    endroll += parseInt(ev[pen[0]]);
		    log += ` ${value}&nbsp;(${pen[1]})`;
		  }
	      }
	    }

	    let fr = fatigueResults.absolutefail;
	    if (ue) {
	      fr = fatigueResults.unusual;
	    } else if (endroll > 175) {
	      fr = fatigueResults.absolutesuccess;
	    } else if (endroll > 100) {
	      fr = fatigueResults.success;
	    } else if (endroll > 75) {
	      fr = fatigueResults.partial;
	    } else if (endroll > 0) {
	      fr = fatigueResults.fail;
	    }

	    let updates = {};
	    let updatemsg = "";
	    let needUpdate = false;
	    let hashitupdate = 0;
	    let hasfatigueupdate = 0;
	    let hitupdate = false;
	    let fatigueupdate = false;
	    let hasinjuryupdate = 0;
	    let injury = 0;
	    if (fr.hits) {
	      updates.hp = parseInt(ev.hp) + fr.hits
	      let hppos = -fr.hits;
	      needUpdate = true;
	      hashitupdate = 1;
	      hitupdate = `HP reduced by ${hppos} to ${updates.hp}`
	    }
	    if (fr.fatigue) {
	      updates.fatigue = parseIntDefault(ev.fatigue,0) + fr.fatigue;
	      let fppos = -fr.fatigue;
	      if (updates.fatigue < -50) {
		// so more than 50 becomes an injury
		injury = updates.fatigue + 50;
		updates.fatigue = -50;
		hasinjuryupdate = 1;
		updates.injurypenalty = parseIntDefault(ev.injurypenalty, 0) + injury;
		fatigueupdate = "Fatigue penalty is -50 (capped).  Injury penalty " +
		    `increased by ${injury} to ${updates.injurypenalty}`;
	      } else if (fr.fatigue > 0) {
		fatigueupdate = `Fatigue penalty increased by ${fppos} to ${updates.fatigue}`
	      } else  {
		if (updates.fatigue > 0) {
		  updates.fatigue = 0;
		}
		fatigueupdate = `Fatigue penalty reduced by ${fppos} to ${updates.fatigue}`
	      }
	      hasfatigueupdate = 1;
	      needUpdate = true;
	    }

	    if (needUpdate) {
	      setAttrs(updates);
	    }

	    finishRoll(roll.rollId, {
		firstroll: endroll,
		secondroll: log,
		message: fr.msg,
		updates: updatemsg,
		hasfatigueupdate: hasfatigueupdate,
		hashitupdate: hashitupdate,
		fatigueupdate: fatigueupdate,
		hitupdate: hitupdate,
	    });
	});
    });
}

function updatePenalties() {
  getAttrs(["fatigue", "hppenalty", "injurypenalty"], (ev) => {
      let total = parseIntDefault(ev.fatigue, 0) +
	    parseIntDefault(ev.hppenalty, 0) +
	    parseIntDefault(ev.injurypenalty, 0);
      setAttrs({statuspenalty: total}, actionsUpdateStatus);
  });
}

/** resting for minutes just recovers fatigue. */
onCheck("clicked:statusrest", (_) => {
  startRoll("@{whispertype} &{template:rmurest}" +
      "{\{who=@{character_name}}}" +
      "{\{rests=rests}}" +
      "{\{period=[[?{How many minutes?}]]}}" +
      "{\{unit=minutes}}" +
      "{\{result=[[0]]}}" +
      "{\{fatigue=[[@{fatigue}]]}}",
      (roll) => {
	  console.log(roll);
	  let minutes = roll.results.period.result;
	  let penalty = roll.results.fatigue.result;
	  if (minutes < 0) {
	    minutes = 0;
	  }
	  result = "";
	  if (penalty < 0) {
	    penalty += minutes;
	    if (penalty > 0) {
	      penalty = 0;
	      result = "Is fully rested (No Fatigue)";
	    } else {
	      result = `Is partially rested (Fatigue ${penalty})`;
	    }
	  }
	  setAttrs({fatigue: penalty})
	  finishRoll(roll.rollId, {
	    result: result
	  });
    });
});

onCheck("clicked:statussleep", () => {
  getSectionIDs('repeating_specificinjury', (ids) => {
      const toget = []
      for (id of ids) {
	toget.push('repeating_specificinjury_' + id + '_dailyrecovery');
	toget.push('repeating_specificinjury_' + id + '_dailyrecovery');
      }
      getAttrs(toget, (data) => {
	  const untreated = checkInjuryRecoveryRoll(data);
	  if (untreated > 0) {
	    let str = "You have an untreated injury, make a recovery roll before resting.";
	    if (untreated > 1) {
	      str = `You have ${untreated} untreated injuries, make recovery rolls before resting.`;
	    }
	    setAttrs({togglesleepinjuriesuntreatedshow: 'on', sleepinjuriesuntreatedmessage: str}); 
	  } else {
	    // Show the dialog to get the number of hours of rest.
	    // Then we need to modify them to cap the recovery rate
	    setAttrs({togglesleepshow: 'on'})
	  }
      });
  });
});

// Use the same button for both
onCheck("clicked:statussleepcancel", () => {
  setAttrs({togglesleepshow: 'off', togglesleepinjuriesuntreatedshow: 'off'});
});

const ppRecoveryPerHour = {
  Average : 5,
  Superior : 10,
  Heroic : 15,
  Legendary: 20, 
  Epic : 25
};

onCheck("clicked:statussleepsave", () => {
  const updates = {};
  updates.togglesleepshow = 'off'
  const logs = []

  getSectionIDs('repeating_specificinjury', (ids) => {
    toget = ["hp", "hp_max", "pp", "pp_max", "powerlevel",
      "statussleephours", "statussleepfullrest",
      "statussleepcreatejournal",
      "journaladdingamedate", "journaladdsessiondate",
      "statussleepjournalnote",
      "option_usefx", "activetokenid",
      "injurypenalty"];
    for (id of ids) {
      toget.push('repeating_specificinjury_' + id + '_dailyrecovery');
      toget.push('repeating_specificinjury_' + id + '_summary');
    }
    rmuGetAttrs(toget, (data) => {
	let hp = parseIntDefault(data.hp, 100);
	let hporig = hp;
	let hp_max = parseIntDefault(data.hp_max, 100);
	let hours = parseIntDefault(data.statussleephours, 0);

	// Hits: Every 2 hours is 10%
	let hpph = Math.max(1, Math.floor(hp_max / 10))
	hp = Math.min(hp_max, hp + hpph * hours);

	if (hp > hporig) {
	  logs.push(`HP now ${hp} (Recovered ${hp - hporig})`);
	  updates.hp = hp;
	}

	// PP: as per power level.  Every _2_ hours you get the increment.
	let hours2 = Math.floor(hours / 2);
	let pp = parseIntDefault(data.pp, 0);
	let pporig = pp;
	let pp_max = parseIntDefault(data.pp_max, 0);
	let powerlevel = data.powerlevel;
	let ppphpercent = ppRecoveryPerHour[powerlevel] || 10;
	let ppph = Math.max(1, Math.floor(ppphpercent * pp_max / 100));

	if (pp > pp_max) {
	  // Too many PP.. bleed it off
	  pp = Math.max(pp - hours, pp_max);
	  logs.push(`PP now ${pp} (Lost ${pporig - pp})`);
	  updates.pp = pp;
	} else if (pp < pp_max) {
	  pp = pp + ppph * Math.min(4, hours2);
	  logs.push(`PP now ${pp} (Recovered ${pp - pporig})`);
	  updates.pp = pp;
	}

	const penaltychange = calculateInjuryUpdates(data, logs, updates);
	if (penaltychange > 0) {
	  let oldpenalties = parseIntDefault(data.injurypenalty, 0);
	  oldpenalties += penaltychange;
	  // Cap at zero
	  oldpenalties = Math.min(0, oldpenalties);
	  updates.injurypenalty = oldpenalties;
	}

	const logdesc = logs.join(", ");
	rmuSetAttrs(updates);

	startRoll("@{whispertype} &{template:rmurest}" +
	    "{\{who=@{character_name}}}" +
	    "{\{rests=rests}}" +
	    `{\{period=${data.statussleephours} }}` +
	    "{\{unit=hours}}" +
	    "{\{result=[[0]]}}", (roll) => {
	    finishRoll(roll.rollId, { result: logdesc });
	    });
	if (data.option_usefx != 'none' && data.activetokenid && data.activetokenid.length > 1) {
	  startRoll(`/fx glow-holy ${data.activetokenid}`,
	      (x) => { finishRoll(x.rollId,x)});
	}

	if (data.statussleepcreatejournal == 'on') {
	  addJournalEntry(data.journaladdingamedate, data.journaladdsessiondate, 
	      `Rest for ${hours}`, logdesc, 0);
	}
      });
  });
});

// So check all injuries, and make sure they all have made a recovery roll
function checkInjuryRecoveryRoll(data) {
  let untreated = 0;

  for (let key in data) {
    if (!key.startsWith('repeating_specificinjury_')) { continue; }
    const value = data[key];
    if (value == 'none') {
      untreated ++;
    }
  }

  return untreated;
}


function calculateInjuryUpdates(data, logs, updates) {
  let untreated = 0;
  let penaltychange = 0;

  for (let key in data) {
    if (!key.startsWith('repeating_specificinjury_')) { continue; }
    if (!key.endsWith('_dailyrecovery')) { continue; } // the summary
    let str = data[key]
    if (typeof(str) != "string") {
      untreated ++;
      rmuerror(`Unable to match injury recovery as not a string ${data[key]}`)
      continue;
    }

    const values = str.split(",");
    const healed = parseIntDefault(values.shift());
    if (healed == -1) {
      untreated ++;
      rmuerror(`Unable to make in int injury recovery string ${data[key]}`)
      continue;
    }

    let desc = data[key.replace("_dailyrecovery", "_summary")] || "non-specific"

    if (values.length == 0) {
      // Injury healed
      logs.push(`Injury ${desc} improved by ${healed} and is fully healed.`);
      // delete the injury
      removeRepeatingRow(key.replace("_dailyrecovery", ""));
      console.log("remove", key.replace("_dailyrecovery", ""));
    } else {
      logs.push(`Injury ${desc} improved by ${healed}.`);
      // Update the new item
      updates[key] = values.join(",");
    }
    penaltychange += healed;
  }

  if (untreated) {
    logs.push(`There were ${untreated} injuries untreated`);
  }
  logs.push(`Total injury penalty improved by ${penaltychange}`);

  return penaltychange;
}

onCheck("clicked:refreshinjurypenalty", () => {
    refreshInjuryPenalty();
});

function refreshInjuryPenalty() {
  getSectionIDs('repeating_specificinjury', (ids) => {
    const toget = []
    for (id of ids) {
      toget.push('repeating_specificinjury_' + id + '_dailyrecovery');
      toget.push('repeating_specificinjury_' + id + '_penalty');
    }
    let total = 0;
    getAttrs(toget, (data) => {
      // For each ID: See if we have daily recovery, else use the penalty
      for (id of ids) {
	const recovery = data['repeating_specificinjury_' + id + '_dailyrecovery'];
	if (recovery) {
	  const items = recovery.split(",");
	  const result = items.reduce((sum, num) => sum + parseIntDefault(num), 0);
	  total += result;
	} else {
	  total += parseIntDefault(data['repeating_specificinjury_' + id + '_penalty']);
	}
      }
      rmuSetAttrs({injurypenalty: -total});
    });

  });

}


onCheck("clicked:rollinitiative", () => {
    doRollInitiative();
});

function doRollInitiative() {
  // roll20 treats floor as round to negative infinity, so ceil since they should be negative
  startRoll('@{whispertype} &{template:rmuinit} [[ [[ 2d10 ]] + @{initiative} + [[ceil(@{statuspenalty} / 10)]] &{tracker}]] ' +
      '{\{actor=@{character_name} }} ' +
      '{\{bonus=@{initiative} }} ' +
      '{\{total=$[[2]]}} {\{roll=$[[0]]}} ' +
      '{\{maneuver=$[[1]] }}' +
      '{\{activetokenid=[[0[@{selected|token_id}] ]]}} ' +
      '{\{selectedcharacterid=[[0[@{selected|character_id}] ]]}}',
      (roll) => {
	finishRoll(roll.rollId, {});
	const activetokenid = attacks.getDataFromRoll(roll.results.activetokenid.expression);
	const selectedcharacterid = attacks.getDataFromRoll(roll.results.selectedcharacterid.expression);
	rmuSetAttrs({lastinitiative: roll.results.total.result});
	const mycharacterid = getActiveCharacterId()
	// So are we the selected token?  If so, update the token id
	console.log("Selected Char ID/My Char ID/Active Token ID",selectedcharacterid, mycharacterid, activetokenid)
	if (selectedcharacterid === mycharacterid && activetokenid && activetokenid.length > 1) {
	  // w00t: save it
	  rmuSetAttrs({ activetokenid : activetokenid });
	  console.log("My tokenid is", activetokenid);
	}
  });
}

function doRollInitiativeNoTracker() {
  // roll20 treats floor as round to negative infinity, so ceil since they should be negative
  startRoll('@{whispertype} &{template:rmuinit} [[ [[ 2d10 ]] + @{initiative} + [[ceil(@{statuspenalty} / 10)]] ]] ' +
      '{\{actor=@{character_name} }} ' +
      '{\{bonus=@{initiative} }} ' +
      '{\{total=$[[2]]}} {\{roll=$[[0]]}} ' +
      '{\{maneuver=$[[1]] }}',
      (roll) => {
	rmuSetAttrs({lastinitiative: roll.results.total.result});
	finishRoll(roll.rollId, {});
  });
}




/**/
function updatetokenmarkers() {
  console.log("updatetokenmarkers start");
  getAttrs(['option_usetokenmarkers', 'sheetselect', 'character_name',
    // Stuns & staggered
    'statusstagger', 'statusstun75', 'statusstun50', 'statusstun25',
    'bleedlist', 'grapplestatus'], (info) => {
      console.log("Update token makers", info);
      if (!info.option_usetokenmarkers || info.option_usetokenmarkers == 'no') {
	return;
      }
      if (info.option_usetokenmarkers == 'pc' && info.sheettype != 'playersheet') {
	return;
      }
      if (info.option_usetokenmarkers == 'npc' && info.sheettype != 'creaturesheet') {
	return;
      }
      let statusstagger = parseIntDefault(info.statusstagger, 0);
      let statusstun75 = parseIntDefault(info.statusstun75, 0);
      let statusstun50 = parseIntDefault(info.statusstun50, 0);
      let statusstun25 = parseIntDefault(info.statusstun25, 0);
      let grapplestatus = parseIntDefault(info.statusstun25, 0);

      let tokens = []

      let bleeds = totalBleed(info.bleedlist);
      if (bleeds > 9) bleeds = 9;
      tokens.push((bleeds > 0)  ? `red:${bleeds}` : "!red");

      tokens.push((statusstagger > 0)  ? "pink" : "!pink");
      if (statusstun75 > 0) {
	let rounds = Math.floor(statusstun75 / 4);
	tokens.push(`blue:${rounds}`);
      } else {
	tokens.push("!blue");
      }

      if (statusstun50 > 0) {
	let rounds = Math.floor(statusstun50 / 4);
	tokens.push(`green:${rounds}`);
      } else {
	tokens.push("!green");
      }
      if (statusstun25 > 0) {
	let rounds = Math.floor(statusstun25 / 4);
	tokens.push(`purple:${rounds}`);
      } else {
	tokens.push("!purple");
      }

      let tstr = tokens.join('|')

      // Join token string.  with --set st
      let message = `!token-mod --ids @{${info.character_name}|character_id} --set statusmarkers|${tstr}`
      console.log(message)
      startRoll(message, (t) => finishRoll(t.rollId, t));
  });
}
    




creature = {}

creature.getLongSize = function(shortname) {
  switch (shortname) {
  case "Mi": return "Miniscule";
  case "MI": return "Miniscule";
  case "Di": return "Diminutive";
  case "D": return "Diminutive";
  case "T": return "Tiny";
  case "S": return "Small";
  case "M": return "Medium";
  case "B": return "Big";
  case "L": return "Large";
  case "H": return "Huge";
  case "G": return "Gigantic";
  case "E": return "Enormous";
  case "I": return "Immense";
  case "O": return "Behomoth";
  case "V": return "Leviathan";
  }
  console.log("Unknown size ", shortname);
  return "??"
}

creature.getLongDescriptionFromNumber = function(numeric) {
  switch (numeric) {
  case 1: return "Miniscule";
  case 2: return "Diminutive";
  case 3: return "Tiny";
  case 4: return "Small";
  case 5: return "Medium";
  case 6: return "Big";
  case 7: return "Large";
  case 8: return "Huge";
  case 9: return "Gigantic";
  case 10: return "Enormous";
  case 11: return "Immense";
  case 12: return "Behomoth";
  case 13: return "Leviathan";
  }
  console.log("Unknown size ", numeric);
  return "??"
}

// Sorted alphabetically
//  Weapon (we) and ranged weapon are special (rw)
//  Require table and size for each.
creature.weaponcodes =
  {
  "as": { "table": "Arming Sword", "size": 0, "type": "melee" },
  "be": { "table": "Beak", "size": 0, "type": "melee" },
  "bi": { "table": "Bite", "size": 0, "type": "melee" },
  "bo": { "display": "Bola", "table": "Bola", "size": 0, "type": "ranged", "ri": 20 },
  "bs": { "table": "Broadsword", "size": 0, "type": "melee" },
  "bx": { "display": "Battle Axe", "size": 0, "type": "melee", "table": "Battle Axe" },
  "cba": { "table": "Ball, Cold", "display": "Cold Ball", "size": 0, "type": "ranged" },
  "cl": { "table": "Claw", "size": 0, "type": "melee" },
  "cr": { "table": "Crush", "size": 0, "type": "melee" },
  "cu": { "display": "Club", "table": "Club", "size": 0, "type": "melee" },
  "da": { "table": "Dagger", "size": 0, "type": "melee" },
  "ebo": { "table": "Bolt, Ice", "size": 2, "crit": "I", "type": "directed", "display" : "Earth Ball" },
  "fa": { "table": "Falchion", "size": 0, "type": "melee" },
  "fba": { "table": "Ball, Fire", "size": 0, "type": "ball", "display": "Fire ball" },
  "fbo": { "table": "Bolt, Fire", "size": 0, "type": "directed", "display": "Fire Bolt" },
  "gr": { "table": "Grapple", "size": 0, "type": "melee" },
  "hc": { "table": "Crossbow", "size": 1, "type": "ranged", "display": "Heavy Crossbow" },
  "hf": { "display": "Heavy Flail", "table": "Flail", "size": 1, "type": "melee" },
  "ho": { "table": "Horn", "size": 0, "type": "melee" },
  "hx": { "display": "Hand Axe", "size":-2, "type": "melee", "table": "Battle Axe" },
  "ibo": { "display": "Ice bolt", "table": "Bolt, Ice", "size": 0, "type": "ranged" },
  "ja": { "display": "Javelin", "table": "Spear", "size": -1, "type": "ranged", "ri": 25 },
  "lb": { "table": "Bow, Long", "size": 0, "type": "ranged", "ri": 100 },
  "lba": { "display": "Lightning Ball", "table": "Ball, Lightning", "size": 0, "type": "ball" },
  "lbo": { "table": "Bolt, Lightning", "size": 0, "type": "ranged", "display": "Ligtning Bolt" },
  "lc": { "table": "Crossbow", "size": 0, "type": "ranged", "display": "Light Crossbow" },
  "ls": { "display": "Long Sword", "table": "Arming Sword", "size": 1, "type": "melee" },
  "ma": { "display": "Mace", "table": "Mace", "size": 0, "type": "melee" },
  "px": { "display": "Pole Axe", "size" : 1, "table": "War Hammer", "type": "melee" },
  "qs": { "display": "Quarterstaff", "table": "Fighting Stick", "size": 1, "type": "melee" },
  "ra": { "table": "Ram", "size": 0, "type": "melee" },
  "rp": { "table": "Rapier", "size": 0, "type": "melee" },
  "rt" : { "display": "Thrown Rock", "type": "ranged", "size": 0, "table": "Rock" },
  "ro" : { "display": "Thrown Rock", "type": "ranged", "size": 0, "table": "Rock" },
  "sb": { "table": "Bow, Short", "size": 0, "type": "ranged" },
  "sc": { "table": "Scimitar", "size": 0, "type": "melee" },
  "sh": { "table": "Shield", "size": 0, "type": "melee", "display": "Shield Bash" },
  "sl": { "display" : "Sling", "ri": 60, "type": "ranged", "table": "Sling", "size": 0 },
  "sp": { "display": "Spear", "size":0, "table": "Spear", "type" : "melee" },
  "ss": { "display": "Short Sword", "table": "Arming Sword", "size": -1, "type": "melee" },
  "sw": { "table": "Unarmed Sweeps", "size": 0, "type": "melee", "display": "Sweep" },
  "ta": { "display": "Thrown Hand Axe", "table": "Battle Axe", "size": -1, "type" : "ranged" },
  "tc": { "display": "Two Handed Club", "table": "Club", "size": 1, "type" : "melee" },
  "td": { "display": "Thrown Dagger", "table": "Dagger", "size": 0, "type" : "ranged" },
  "tp": { "display": "Thrown Spear", "size":0, "table": "Spear", "type" : "ranged" },
  "ts": { "display": "Two Handed Sword", "table": "XX", "size": 1, "type" : "melee" },
  "tw": { "display": "Thrown War Hammer", "table": "War Hammer", "size": 0, "type": "ranged" },
  "tx": { "display": "Two Handed Axe", "size": 1, "type": "melee", "table": "Battle Axe" },
  "un": { "table": "Unarmed Strike", "size": 0, "type": "melee" },
  "wbo": { "table": "Bolt, Water", "size": 0, "type": "ranged", "display": "Water Bolt" },
  "tw": { "table": "War Hammer", "size": 0, "type": "melee", "display": "War Hammer" },
  "wi": { "display": "Whip", "table": "Whip", "size": 0, "type": "melee" },
  "wm": { "display": "War Mattock", "table": "XZ", "size": 0, "type": "melee" },

  "si": { "table": "Stinger", "size": 0, "type": "melee" },
  "tr": { "table": "Trample", "size": 0, "type": "melee" },


  "handcrossbow": { "table": "Crossbow", "size": -1, "type": "ranged", "display" : "Hand Crossbow" },


  "we": { "table": "Arming Sword", "size": 0, "type": "melee" },
  "any": { "table": "Arming Sword", "size": 0, "type": "melee" },
  "all": { "table": "Arming Sword", "size": 0, "type": "melee" },
  "rw": { "table": "Arming Sword", "size": 0, "type": "melee" }
}




/* if the data comes from roll20 sub arrays may be json, or they may be strings.
   This is obviously stupid... but still.

   So take a look, it's string, parse im as JSON.  If an object,
   just return directly.
*/
creature.parseJSONMaybe = function(jdata, def) {
  if (typeof(jdata) == 'string') {
    return JSON.parse(jdata);
  } else if (jdata) {
    return jdata;
  } else {
    return def;
  }
}

/*
 * This is terribly inefficent.  Search is linear
 *
 * return { code: 'xx', size: modifier }
 */
creature.weaponbyname = function(name) {
  for (key in creature.weaponcodes) {
    let entry = creature.weaponcodes[key];
    if (entry.table === name) {
      // Found it
      return { code: key, size: entry.size };
    }
  }
  return false;
}

/**
 *  Returns an Object or null
 *  Nil if if does not match.
 * Object has:
 *  - OB: The OB natch
 *  - size: Size of the attack as a Letter.
 *  - sizen: Size of the attack as number
 *  - type:  Attack type: two or three letter code or "any"
 *  - nextound: true (or not present) if attack has one to follow next round
 *  - bonus: Attack happens on a bonus on critical
 *  - crit: Additional Crit type / Not implemented
 *  - extra: Currently just anything else
 */
creature.parseAttackString = function(string) {
  // The > sometimes is turned in &gt;  
  string = string.replace("&gt;", ">")

  //                       1.OB  2.Size       3.sizen  4.Attack type  5 []    6 > 7 >>  8. extra
  match = string.match(/^(-?\d+)([A-Za][Ii]?)\((\d*)\)([a-z]*)(?:\[(\w*)])?(>)?(≫)?\s*(\(.*\))?$/);
  if (match) {
    return {
      OB: match[1],
      size: match[2],
      sizen: parseInt(match[3]),
      type: match[4] || false,
      crit: match[5] || false,
      nextround: match[6] ? true : false,
      bonus: match[7] ? true : false,
      extra: match[8] || false,
    }
  }

  // Same as above, but don't require the numeric size (sizen)
  //                       1.OB  2.Size       3.Attack type  4 []    5 > 6 >>  7. extra
  match = string.match(/^(-?\d+)([A-Za][Ii]?)([a-z]*)(?:\[(\w*)])?(>)?(≫)?\s*(\(.*\))?$/);
  if (match) {
    return {
      OB: match[1],
      size: match[2],
      sizen: sizeToNumeric(match[2]),
      type: match[3] || false,
      crit: match[4] || false,
      nextround: match[5] ? true : false,
      bonus: match[6] ? true : false,
      extra: match[7] || false,
    }
  }



  //--> 28G(9)any 2 melee(2WF)
  //                             1,OB   2, Size      3.n     4. any melee          ?? >/>>
  match = string.match(/^(-?\d+)([A-Za][Ii]?)(\(\d*\))(?:any|all).*melee(?:\(.*\))?$/);
 if (match) {
    return {
      OB: match[1],
      size: match[2],
      sizen: parseInt(match[3]),
      type: match[4], 
      nextround: false,
      bonus: false,
      extra: false
    }
  }

  return null;
}

/* */
creature.parseAttack = function(attack, cdata, updates) {
  const info = creature.parseAttackString(attack.attack);
  if (!info) {
    rmuerror("Unable to match attack", attack.attack);
    return;
  }
  const ob = info.OB;
  const size = info.size;
  const type = info.type;
  console.log("Attack", info, ob, size, type);
  const rowid = generateRowID();
  const prefix = `repeating_creatureattack_${rowid}`;

  //
  const wc = creature.weaponcodes[type];
  if (!wc) {
    rmuerror("Unable to find weapon code, dropping attack");
    return
  }

  let attacksize = info.sizen + wc.size;
  {
    // All the displayed ones
    updates[`${prefix}_attacksize`] = attacksize;
    updates[`${prefix}_attacksizedisplay`] = creature.getLongDescriptionFromNumber(attacksize);
    updates[`${prefix}_notes`] = info.extra || "";
  }

  updates[`${prefix}_attack`] = attack.attack;
  updates[`${prefix}_ob`] = ob;
  updates[`${prefix}_attackskill`] = ob;
  updates[`${prefix}_attackersize`] = cdata.size;

  updates[`${prefix}_type`] = type;
  creature.updateAttackTable(prefix, wc.table, wc.display || wc.table);
}

/* */
creature.parseDefenses = function(defenses) {
  const defs = creature.parseJSONMaybe(defenses);
  const update = {}

  update.elemSelector = ".creaturedefense";

  let options = []
  options.push({label: "Default", value: 0 });
  defs.forEach(def => {
      options.push({label: `${def.name} (${def.dbmod})`, value: def.dbmod});
  });
  update.optionsArray = options;
  populateListOptions(update);
}

onCheck("change:creaturedefense change:db_base", () => {
  getAttrs(["db_base", "creaturedefense"], (db) => {
      let dbbase = parseIntDefault(db.db_base, 0);
      let newmod = parseIntDefault(db.creaturedefense, 0);
      setAttrs({db: dbbase + newmod});
  });
});

/**/
creature.newCreature = function(name, jdata) {
  console.log("new creatures", name, jdata, typeof(jdata));
  let cdata = jdata;
  if (typeof(jdata) == 'string') {
    cdata = JSON.parse(jdata);
  }
  console.log(cdata);
  let updates = {}

  updates.sheetselect = 'creaturesheet';

  
  updates.ag = cdata.AG;
  updates.co = cdata.CO;
  updates.em = cdata.EM;
  updates.in = cdata.IN;
  updates.me = cdata.ME;
  updates.pr = cdata.PR;
  updates.qu = cdata.QU;
  updates.re = cdata.RE;
  updates.sd = cdata.SD;
  updates.st = cdata.ST;

  if (typeof(cdata.AT) == 'string') {
    updates.at = cdata.AT.replace("AT ", '')
    // 	const res = cdata.targetat.match(/(\d+),(\d+),(\d+),(\d+)/);
  } else {
    updates.at = cdata.AT;
  }
  
  updates.at_torso = updates.at_head = updates.at_arms = updates.at_legs = updates.at;
  updates.db = cdata.DB;
  updates.db_base = cdata.DB; // Base is this - change when people click different defense
  updates.defenses = cdata.defenses || [];

  updates.critreduction = parseIntDefault(cdata.critreduction, 0);
  if (updates.critreduction == 0) {
    updates.critreduction = '-';
  }
  if (cdata.critresist) {
    updates.critresist = cdata.critresist;
  }
  updates.critimmune = cdata.critimmune || ''

  updates.level = parseInt(cdata.level || cdata.Level);
  updates.hits = parseInt(cdata.hits);
  updates.hp = updates.hits;
  updates.hp_max = updates.hp;
  updates.scaledhits = cdata.scaledhits || 0;
  updates.pp = parseInt(cdata.PP) || 0;
  updates.pp_max = updates.pp;
  updates.size = cdata.size;
  updates.initiative = cdata.initiative;

  // Status stuff
  updates.hppenalty = 0; // Nothing by default
  updates.injurypenalty = 0;
  updates.endurance = cdata.Fatigue;
  updates.fatigue = 0;
  updates.statuspenalty = 0;

  updates.rr_channeling_bonus = parseIntDefault(cdata.Ch, 0);
  updates.rr_essence_bonus = parseIntDefault(cdata.Ess, 0);
  updates.rr_mentalism_bonus = parseIntDefault(cdata.Mnt, 0);
  updates.rr_arcane_bonus = parseIntDefault(cdata.Arcane, mid3(updates.rr_channeling_bonus,
          updates.rr_essence_bonus, updates.rr_mentalism_bonus));
  updates.rr_physical_bonus = cdata.Phy;
  updates.rr_fear_bonus = cdata.Fear;

  // Attacks:  Format is 8M(5)be.  OB - SizeLetter - Size Numberic - Attack Table
  let attacks = creature.parseJSONMaybe(cdata['data-attack'], []);
  updates.attacklist = attacks.join(',');
  for (attack of attacks) {
    console.log(" - Attack", attack);
    let up = {}
    creature.parseAttack(attack, cdata, up)
    setAttrs(up);
  }

  {
    const moves = creature.parseJSONMaybe(cdata['data-move'], []);
    const movecompressed = [];
    for (const { type, pace, bmr } of moves) {
      const rowid = generateRowID();
      const prefix = `repeating_creaturemove_${rowid}`;
      updates[`${prefix}_type`] = type;
      updates[`${prefix}_pace`] = pace;
      updates[`${prefix}_bmr`] = bmr;
      movecompressed.push(`${type}(${pace})${bmr}`)
    }
    updates.movestring = movecompressed.join(';');
  }

  // "data-skills": [ { "skill": "Running", "bonus": 43 } ],
  const skills = creature.parseJSONMaybe(cdata['data-skills'], [])
  const skillcompressed = []
  for (const { skill, bonus, ranks} of skills) {
    const rowid = generateRowID();
    const prefix = `repeating_creatureskill_${rowid}`;
    updates[`${prefix}_name`] = skill;
    updates[`${prefix}_bonus`] = bonus;
    if (ranks) {
      updates[`${prefix}_ranks`] = ranks;
      skillcompressed.push(`${skill} (${ranks}) ${bonus}`)
    } else {
      skillcompressed.push(`${skill} ${bonus}`)
    }
    if (skill == 'Perception') { updates.perception_bonus = bonus; }
  }
  updates.skillstring = skillcompressed.join(";");
  

  {
    const talents = creature.parseJSONMaybe(cdata['data-talents'], [])
    let lastgroup = 'Elvis';
    for (const {talent, group} of talents) {
      const rowid = generateRowID();
      const prefix = `repeating_creaturetalent_${rowid}`;
      if (lastgroup != group) {
        updates[`${prefix}_group`] = group;
        lastgroup = group;
      }
      updates[`${prefix}_talent`] = talent;
    }
  }

  // "data-spellLists": [  { "list": "Concussions Ways ", "ranks": "1" } ]
  const spells = creature.parseJSONMaybe(cdata['data-Spelllists'], [])
  for (const { list, ranks, scr } of spells) {
    const rowid = generateRowID();
    const prefix = `repeating_creaturespell_${rowid}`;
    let cranks = ranks;
    updates[`${prefix}_name`] = list;
    // Ranks may be expressed as level or Own Level
    if (ranks == "Own lvl") {
      cranks = updates.level
    } else {
      cranks = ranks;
    }
    updates[`${prefix}_ranks`] = cranks;
    // If we have an SCR mod, use it; else just ranks
    // FIXME: Should get realm
    updates[`${prefix}_scr`] = scr || cranks;
  }

  updates.togglenpcupload = 0;

  updates.statuspenalty = 0;
  updates.statusmessage = "Okay";
  //updates.description = creature.content || creature['data-description'];

  VrmuSetAttrs(updates);

  creature.parseDefenses(updates.defenses)
  setDefaultToken({
    cd_bar1_l: 'hp',
    bar1_link:'hp',
    cd_bar2_l: 'pp',
    bar2_link: 'pp',
    cd_bar3_l: 'allpenalties',
    bar3_link: 'allpenalties',
    cd_bar4_l: 'aptrack',
    bar4_link: 'aptrack',
    showname: true,
    showplayers_name: true,
    width: 70,
    height: 70
  });
}

creature.adjustPowerLevel = function(newpower) {
}



// The number changed: Update the displayed on to match
onCheck('change:repeating_creatureattack:attacksize', (ev) => {
    setAttrs({[ev.sourceAttribute.replace("_attacksize", "_attacksizedisplay")]:
        creature.getLongDescriptionFromNumber(parseIntDefault(ev.newValue))});
});

onCheck('change:repeating_creatureattack:type', (ev) => {
    const wc = creature.weaponcodes[ev.newValue];
    creature.updateAttackTable(ev.sourceAttribute.replace("_type", ""), wc.table,
        wc.display || wc.table);
});




/**
 * Fetches info about an attack and fills in the hidden details
 */
creature.updateAttackTable = function (prefix, table, display) {
  getCompendiumPage(`AttackTable:${table}`, cdata => {
      let nu = {};
      // FIXME: Handle errors in size slookup gracefully.
      nu[`${prefix}_attackbasefumble`] = 1; // FIXMEitems.attackaddfumble;
      nu[`${prefix}_attacktable`] = table;
      nu[`${prefix}_attackstr`] = 100;
      nu[`${prefix}_attacksource`] = 'creature';
      nu[`${prefix}_attackri`] = 10;
      nu[`${prefix}_attackname`] = display;

      nu[`${prefix}_attackmin`] = cdata.data.min.match(/\d+/)[0] || 0;
      nu[`${prefix}_attackmax`] = cdata.data.max.match(/\d+/)[0] || 0;
      nu[`${prefix}_attackdata`] = cdata.data['data-attack'] || "";

      rmuSetAttrs(nu);
  });

}


/**
 * So some poor sap is being attacked.  We need to get all the stuff into a object (cdata),
 * then generate the roll string - and then let attacks resolve it.
 */
onCheck('clicked:repeating_creatureattack:creaturemakeattack', (ev) => {
  creature.doAttack(ev)
});

creature.doAttack = function(ev) {
    console.log("Creature attack", ev);
    const basename = ev.sourceAttribute.replace("_creaturemakeattack","");
    console.log("basenae", basename);
    const toget = [
      'character_name',
      'size',
      `${basename}_ob`,
      `${basename}_attack`,
      `${basename}_attacksize`,
      `${basename}_type`,
      `${basename}_attackstr`,
      `${basename}_attackmin`,
      `${basename}_attackmax`,
      `${basename}_attackdata`,
      `${basename}_attackbonus`,
      `${basename}_attackname`,
      `${basename}_attackfumble`,
      `${basename}_attacksize`,
      'parrymod', 'othermod',
      'actionselect', 'aptrack',
      'target_name',
      'target_db',
      'target_at',
      'target_size',
      'target_crit',
      'statuspenalty',
      'statuseffect',
    ];
    getAttrs(toget, (values) => {
      console.log("Attack data", toget, values);
      cdata = {};
      cdata.min = +values[`${basename}_attackmin`];
      cdata.max = +values[`${basename}_attackmax`];
      cdata.fumblerange = +values[`${basename}_attackfumble`] || 1;
      cdata.character = values.character_name;
      cdata.attackbonus = parseIntDefault(values[`${basename}_ob`], 0);
      cdata.attackdata = values[`${basename}_attackdata`];
      cdata.attacksize = sizeToNumeric(values[`${basename}_attacksize`] || 'M');
      cdata.attackersize = sizeToNumeric(values.size || 'M');
      cdata.attackname = values[`${basename}_attackname`] || "Weapon";
      cdata.str = +values.str || 0;
      cdata.targetname = values.target_name || "Foe";
      cdata.targetat = values.target_at || 1;
      cdata.targetdb = parseIntDefault(values.target_db, 0);
      cdata.targetsize = parseIntDefault(values.target_size, 5);
      cdata.targetcrit = parseIntDefault(values.target_crit, 0);
      cdata.statuseffect = parseIntDefault(values.statuseffect, 0);
      cdata.statuspenalty = parseIntDefault(values.statuspenalty, 0);
      cdata.parrymod = parseIntDefault(values.parrymod, 0);
      cdata.othermod = parseIntDefault(values.othermod, 0);
      cdata.apused = parseIntDefault(values.aptrack, 0);
      cdata.actionselect = values.actionselect;
      if (values.actionselect == 'spell') {
        cdata.attacktype = 'directed';
      } else if (values.actionselect == 'missile') {
        cdata.attacktype = 'missile';
      } else {
        cdata.attacktype = 'melee';
      }
      cdata.useap = cdata.apused ? true : false;
      console.log(cdata);
      attacks.startAttack(cdata);
    });
}

onCheck('change:powerlevel', (ev) => {
  const newpower = ev.newValue;
  console.log("New power level", newpower);

  creature.adjustPowerLevel(newpower);
});


onCheck('clicked:uploadnpccancel', (e) => {
    setAttrs({togglenpcupload: 0});
});

onCheck('clicked:uploadnpcstart', (e) => {
    setAttrs({togglenpcupload: 'on'});
});




/**/

onCheck("clicked:npcgenerate", doNpcGeneate);

const remaphelpers = {
  handleAT: function(inobj, outobj) {
    if (inobj.at_torso == inobj.at_head && inobj.at_torso == inobj.at_arm &&
	  inobj.at_torso == inobj.at_body) {
      outobj.AT = `AT ${inobj.at_head}`;
    } else {
      outobj.AT = `AT ${inobj.at_torso},${inobj.at_head},${inobj.at_arms},${inobj.at_legs}`;
    }
  },

  handlebmr: function(inobj, outobj) {
    outobj['data-move'] = [{ type: "Walk", pace: inobj.maxpace, bmr: inobj.bmr }];
  },

  handledb: function(inobj, outobj) {
    const def = []
    def.push({ name: "Base", dbmod: inobj.db_base });
    def.push({ name: "Passive Dodge", dbmod: inobj.db_passivedodge });
    def.push({ name: "Partial Dodge", dbmod: inobj.db_partialdodge });
    def.push({ name: "Full Dodge", dbmod: inobj.db_fulldodge });
    def.push({ name: "Passive Block", dbmod: inobj.db_passiveblock });
    def.push({ name: "Partial Block", dbmod: inobj.db_partialblock });
    def.push({ name: "Full Block", dbmod: inobj.db_fullblock });
    outobj.defenses = def;
  },
};


/*
 - A string means asve as that.
 - A function calls it when we find it
 - A true boolean means its required, used for functions
*/

const remaplist = {
  /* from : to */
  ag: "AG", co: "CO", em: "EM", in: "IN", me: "ME", pr: "PR", qu: "QU", re: "RE", sd: "SD", st: "ST",
  at_head: remaphelpers.handleAT, at_torso: true, at_arms: true, at_legs: true,
  level: "level",
  character_name: "Name",
  initiative: "initiative",
  size: "size",
  hp_max: "hits",
  pp_max: "PP",
  endurance: "Fatigue",
  bmr: remaphelpers.handlebmr, maxpace: true,

  db_base: remaphelpers.handledb,
  db_passivedodge: true, db_partialdodge: true, db_fulldodge: true,
  db_passiveblock: true, db_partialblock: true, db_fullblock: true,
  // spells

  rr_channeling_bonus: "Ch",
  rr_essence_bonus: "Ess",
  rr_mentalism_bonus: "Mnt",
  rr_fear_bonus: "Fear",
  rr_physical_bonus: "Phy",
};

function remapitems(inobj, outobj, mappings) {
  for (map in mappings) {
    if (inobj[map] == null) {
      console.log("Missing field", map);
    }
    if (typeof(mappings[map]) === 'string') {
      outobj[mappings[map]] = inobj[map];
    }
  }
  // Afer we have checked everything, call the functions
  for (map in mappings) {
    if (typeof(mappings[map]) === 'function') {
      mappings[map](inobj, outobj)
    }
  }

}

function doNpcGeneate() {
  setAttrs({npcstring: "Generating"});

  const toget = Object.keys(remaplist);
  const out = {}

  addPendingFunction("NPC Gen: Get simple stuff", () => {
      getAttrsPending(toget, (data) => {
	  out.Category = "Creature";
	  remapitems(data, out, remaplist);
      });
  });

  const skillsToGet = [];
  const fetchList = [];
  out['data-skills'] = [];
  addPendingFunction("NPC Gen: Get Skill Anames", () => {
      forEachSkillPending((skill, cat, parent) => {
	  let tofetch = {};
	  if (parent && skill.fulldisplay) {
	    tofetch.name = skill.fulldisplay;
	  } else if (parent) {
	    tofetch.name = skill.aname + "_name";
	    tofetch.prefix = parent.display;
	    fetchList.push(tofetch.name);
	  } else {
	    tofetch.name = skill.display
	  }
	  tofetch.ranks = skill.aname + "_ranks"
	  tofetch.bonus = skill.aname + "_bonus"
	  skillsToGet.push(tofetch);
	  fetchList.push(tofetch.ranks, tofetch.bonus);
      });
  });

  addPendingFunction("NPC Gen: Get Skill Bonuses", () => {
      getAttrsPending(fetchList, (data) => {
	for (skill of skillsToGet) {
	  let ranks = data[skill.ranks];
	  let bonus = data[skill.bonus];
	  let name = skill.name;
	  if (data[skill.name]) {
	    name = skill.prefix + ": " + data[skill.name];
	  }
	  if (ranks > 0 || bonus > 0) {
	    out['data-skills'].push({ skill:name, bonus, ranks});
	  }
	}
      });
  });

  out[`data-talents`] = [];
  addPendingFunction("NPC Gen: Get Talents", () => {
    getSectionIDsPending("repeating_talent", (ids) => {
	let talentToGet = []
	for (id of ids) {
	  // Just the names for now
	  talentToGet.push(`repeating_talent_${id}_talentname`);
	}
	getAttrsPending(talentToGet, (talents) => {
	    console.log(talents, talentToGet);
	    for (key in talents) {
	      out[`data-talents`].push({ name: talents[key]})
	    }
	});
    });
  });

  out['data-attack'] = []
  addPendingFunction("NPC Gen: Get Attacks", () => {
      getSectionIDsPending("repeating_attack", (ids) => {
	  let attacksToGet = []
	  for (id of ids) {
	    attacksToGet.push(
		`repeating_attack_${id}_attacksize`,
		`repeating_attack_${id}_attacktable`,
		`repeating_attack_${id}_attackbonus`
	    )
	  }
	  getAttrsPending(attacksToGet, (attacks) => {
	      for (id of ids) {
		let bonus = attacks[`repeating_attack_${id}_attackbonus`];
		let size = attacks[`repeating_attack_${id}_attacksize`];
		let code = creature.weaponbyname(attacks[`repeating_attack_${id}_attacktable`])
		if (!code) {
		  rmuerror("Unable to find code for attack", attacks[`repeating_attack_${id}_attacktable`])
		  continue;
		}
		let sizenum = sizeToNumeric(size);
		if (code.size) {
		  sizenum += code.size;
		  size = sizeFromNumeric(sizenum);
		}
		out['data-attack'].push({attack:`${bonus}${size}(${sizenum})${code.code}`});
	      }
	  });

      });
  });

  // move
  out['data-Spelllists'] = []
  addPendingFunction("NPC Gen: Save Spells Base", () => {
      let spellsToGet = []
      let prefixs = [];
      // Messing with the indentation here for sanity
      getSectionIDsPending("repeating_spelllistspellownbase", (ids1) => {
	let p1 = ids1.map((id) => "repeating_spelllistspellownbase_" + id);
      getSectionIDsPending("repeating_spelllistspellopen", (ids2) => {
	let p2 = ids2.map((id) => "repeating_spelllistspellopen_" + id);
      getSectionIDsPending("repeating_spelllistspellclosed", (ids3) => {
	let p3 = ids3.map((id) => "repeating_spelllistspellclosed_" + id);
	let prefixes = p1.concat(p2, p3);
	for (prefix of prefixes) {
	  spellsToGet.push(
		`${prefix}_listname`,
		`${prefix}_ranks`,
		`${prefix}_scr`,
	  );
	}
	getAttrsPending(spellsToGet, (spells) => {
	    for (prefix of prefixes) {
		let ranks = parseIntDefault(spells[`${prefix}_ranks`],0);
		if (!ranks || ranks === 0) { continue; }
		let name = spells[`${prefix}_listname`];
		let scr = spells[`${prefix}_scr`];
		out['data-Spelllists'].push({
		  name: name,
		  scr: scr,
		  ranks: ranks });
	      }
	  });

      }); }); }); // Nest getSectionIds above
  });


  addPendingFunction("NPC Gen: Save NPC String", () => {
      setAttrs({npcstring: JSON.stringify(out)})
  });


  checkPending();
}





//



const injury = {}

// Maps the critical table to the critical encoding.
// Hits are not covered, nor is the description field
// T is for the Token Id
// H is for hits
injury.criticalmaps = {
    P : 'P' /* Ijury penalty */,
    F: 'F' /* Fatigue */,
    B: 'B' /* Bleed */,
    St: 'S' /* staggered */,
    Prn: 'P' /* Prone */,
    K: 'K' /* Knock back */,
    G: 'G' /* Grapple % */,
    "S25" : 'Q', "S50" : 'W', "S75" : 'E', /* Stuns */
    Br: 'X' /* Breakage roll */,
    D: 'D' /* Death/defeat */,
};

// Grabs all the known fields and create an injury string.
// returns it as a string.
injury.updateInjuryString = function(hits, critical, attacker, result) {
    let istr = "";
    console.log("Update Injury string", hits, critical, attacker, result);

    if (result.materialgroup && result.materialgroup.length > 0) {
      istr += 'W' + result.materialgroup;
    }

    // First get base hits + critical hits
    let totalhits = parseIntDefault(hits, 0);
    if (critical && critical.H) {
	totalhits += parseIntDefault(critical.H, 0);
    }
    if (totalhits > 0) {
	istr += `H${totalhits}`;
    }

    if (!critical) {
	return istr + 'Z';
    }

    // So get all the effects that we care about, except H
    for (let [critfield, value] of Object.entries(critical)) {
	if (critfield == 'H') {
	    // Ignore this; we deal elsewhere.
	    continue;
	}
	const istrfield = injury.criticalmaps[critfield];
	if (typeof(istrfield) !== 'string') {
	    rmuerror("Update Injury string Unknown critical type", critfield, value, critical);
	} else {
	    // Sometimes negatives has '( )' around them
	    value = value.replace(/[)(]/g, "");
	    // Knockback may have a foot marker (single quote)
	    value = value.replace(/(\d+)'/g, "$1");
	    istr += `${istrfield}${Math.abs(value)}`;
	}
    }

    if (result.hitlocation) {
	if (result.hitlocation == 'Head') istr += 'L2';
	else if (result.hitlocation == 'Chest') istr += 'L1';
	else if (result.hitlocation == 'Abdomen') istr += 'L1';
	else if (result.hitlocation == 'Arm') istr += 'L3';
	else if (result.hitlocation == 'Leg') istr += 'L4';
    }

    if (result.side) {
	if (result.side == 'Left') istr += 'O1';
	else istr += 'O2';
    }

    // Indicate the end of the numeric items
    istr += 'Z';
    /*

    if (attacker && typeof(attacker) === 'string') {
	const asan = attacker.replaceAll('@', '').replaceAll(")", '&#41');
	istr += `@${asan}@`;
    }

    if (critical.description) {
	// kill double quotes
	const desc = critical.description.replaceAll('"', '').replaceAll(")", '&#41;');
	istr += `#${desc}#`;
    }
*/
    console.log("Injury string", istr);
    return istr;
}

/** The result is in "ev.originalRollId".  I wish I was joking */
onCheck("clicked:applyattackresult", (ev) => {
	console.log("Apply Attack result triggered", ev);
	let str = ev.originalRollId;
	injury.parseInjuryString(str);
});

onCheck("clicked:applyinjuryhack", () => {
    getAttrs(["hackinjury"], ev => {
	injury.parseInjuryString(ev.hackinjury);
    });
});

/* So injury strings have two parts seperated by ;.
   The first is the numeric fields,
   The second is the descrtive parts.
*/
injury.parseInjuryString = function (str) {
    let original = str;

    // Kill the 'Injury: ' from pasting from Crit rolls
    str = str.replace(/^Injury:\s*/, "");
    str = str.replace(/\s+/g, "");

    // So we may have multiple crits in the form of "Z<sev><type>:"
    //  Just squash them for now.  When we do immunities; we will
    //  need to handle them specifically.
   // str = str.replaceAll(/Z[A-Z][A-Z]:/g, "");
   
    const injuryarray = str.split(/Z/)

    const injurydata = {};
    const updates = {};
    let reported = false;

    getAttrs(["character_name", "hp", "injurypenalty", "fatigue", "bleedlist", "currentphase",
		"statusstagger", "statusstun75", "statusstun50", "statusstun25",
		"critresist", "critimmune", "grapplestatus",
		"option_usefx",
		"activetokenid", // Maagic hackery
		], (cdata) => {
	console.log("data for creature", cdata);
	// Pull the fields out.  If we modify save to updates
	// as well.  So anything changed will be in updates.
	let hp = parseIntDefault(cdata.hp, 0);
	let injurypenalty = parseIntDefault(cdata.injurypenalty, 0);
	let fatigue = parseIntDefault(cdata.fatigue, 0);
	let statusstagger = parseIntDefault(cdata.statusstagger, 0);
	let statusstun25 = parseIntDefault(cdata.statusstun25, 0);
	let statusstun50 = parseIntDefault(cdata.statusstun50, 0);
	let statusstun75 = parseIntDefault(cdata.statusstun75, 0);
	let grapplestatus = parseIntDefault(cdata.grapplestatus, 0);
	const critresist = cdata.critresist || "";

	const currentphase = parseIntDefault(cdata.currentphase, 1);

	// Phase in the round - 1-4
	const relphase = (currentphase - 1) % 4 + 1;
	let critimmune = false
	if (cdata.critimmune) {
	    critimmune = cdata.critimmune.match(/P([A-Z])/)[1]
	}
	// Creature is immune to bleeding results. Convert every hit
	//of bleeding to a concussion hit.
	const nobleed = critresist.includes('#');
	    // Creature is immune to stun results. If the creature can be
	    // staggered, relegate the result to the comparable Stagger
	    // result: Daze - stagger, Stun/ stun unable to parry - knock
	    // back, down- knock down.
	const nostun = critresist.includes('@');
	    // Creature is immune to stagger, knock back and knock
	    // down results.
	const noknock = critresist.includes('!');
	    // Creature does not get fatigued
	const nofatigue = critresist.includes('*');

	// FIXME: Error handle on this
	let bl = cdata.bleedlist ? JSON.parse(cdata.bleedlist) : [];

	let fxhavebleed = 0;

	for (let subinjury of injuryarray) {
	    if (subinjury == "") {
		// Stupid js split function
		continue;
	    }
	    console.log(subinjury)
	    // slurp out the crit type if necessary 
	    const subifields = subinjury.match(/^([A-Z])([A-Z]):(.*)/)
	    if (subifields) {
		if (critimmune == subifields[2]) {
		    console.log("Proof against, skipping");
		    sendMessage(`${cdata.character_name} ignores the ${subifields[2]} critical`);
		    continue;
		}
		subinjury = subifields[3];
	    }

	    /* Split into our array of effects */
	    const found = subinjury.match(/[A-Z]\d+/g);

	    for (res of found) {
		var value = parseInt(res.substring(1));
		injurydata[res[0]] = value; // Save it
		switch (res[0]) {
		    case 'H':
			hp -= value;
			updates.hp = hp;
			break;
		    case 'P':
			injurypenalty -= value;
			updates.injurypenalty = injurypenalty;
			reported = true; // Needs healing time
			break;
		    case 'F':
			if (nofatigue) {
			    sendMessage(`${cdata.character_name} is not winded`);
			} else {
			    fatigue -= value;
			    updates.fatigue = fatigue;
			}
			break;
		    case 'B': {
			  if (nobleed) {
			      // If nobleed, they just add to hits - no need to report.
			      hp -= value;
			      updates.hp = hp;
			      break;
			  } else {
			      reported = true;
			      bl.push({startphase: currentphase, phase: relphase, amount: value});
			      // Get the total bleed
			      let bleed = 0;
			      for (const b of bl){
				  bleed += b.amount;
			      }
			      updates.bleedlist = JSON.stringify(bl);
			      updates.bleeding = bleed;
			  }
			  break;
		      }
		    case 'S':
			if (noknock) {
			    sendMessage(`${cdata.character_name} immediately recovers from the blow`);
			} else {
			    statusstagger += value;
			    updates.statusstagger = statusstagger;
			    // This trumps everything else - apply immediately
			    updates.statuseffect = 'staggered';
			}
			break;
		    case 'Q': // stun25
			if (nostun) {
			    // A single round of stun 25
			    statusstun25 = 4;
			    updates.statusstun25 = statusstun25;
			    updates.statusstun25info = roundString(statusstun25);
			} else {
			    statusstun25 += 4 * value;
			    updates.statusstun25 = statusstun25;
			    updates.statusstun25info = roundString(statusstun25);
			}
			break;
		    case 'W': // Stun 50
			if (nostun) {
			    // A single round of stun 25
			    statusstun25 = 4;
			    updates.statusstun25 = statusstun25;
			    updates.statusstun25info = roundString(statusstun25);
			} else {
			    statusstun50 += 4 * value;
			    updates.statusstun50 = statusstun50;
			    updates.statusstun50info = roundString(statusstun50);
			}
			break;
		    case 'E': // Stun 75
			if (nostun) {
			    // Turns into a single round of stun 25
			    statusstun25 = 4;
			    updates.statusstun25 = statusstun25;
			    updates.statusstun25info = roundString(statusstun25);
			} else {
			    statusstun75 += 4 * value;
			    updates.statusstun75 = statusstun75;
			    updates.statusstun75info = roundString(statusstun75);
			}
			break;
		    case 'K':
			if (noknock) {
			    sendMessage(`${cdata.character_name} is unphased by the blow`);
			} else {
			    sendMessage(`${cdata.character_name} is knocked back ${value} feet`);
			}
			break;
		    case 'R':
			if (noknock) {
			    sendMessage(`${cdata.character_name} remains as they were`);
			} else {
			    sendMessage(`${cdata.character_name} is knocked prone`);
			}
			break;
		    case 'X':
			sendMessage(`${cdata.character_name} must make a breakage check at ${value}`);
			break;
		    case 'G':
			grapplestatus += value;
			updates.grapplestatus = grapplestatus;
			sendMessage(`${cdata.character_name} is grappled at ${grapplestatus} (increase ${value}`);
			break;
		    case 'L': case 'O': // Already saved... do nothing
			break;
		    default:
			rmuerror("Can't handle ${res[0]} in injury ${str}");
			break;
		}
	    }
	}

	if (fatigue < -50) {
	    const foverflow = fatigue + 50;
	    console.log("foverflow", foverflow, fatigue);
	    injurypenalty += foverflow;
	    fatigue = -50;
	    updates.injurypenalty = injurypenalty;
	    updates.fatigue = fatigue;
	    reported = true; // Needs healing time
	}

	if (reported) {
	    sendMessage(`${cdata.character_name} has an injury`);
	    addSpecificInjury(injurydata);
	}
	if (updates.hp <= 0) {
	    sendMessage(`${cdata.character_name} is down`);
	}
	sendMessage(`${cdata.character_name} has ${original} applied`);

	if (updates.hp) {
	    RMUSkills.uses('bodydevelopment');
	}

	// I should queue up the effects and trigger them
	if (cdata.activetokenid && cdata.activetokenid.length > 1) {
	    startRoll(`/fx bubbling-blood ${cdata.activetokenid}`,
		    (x) => { finishRoll(x.rollId,x)});
	}

	// Update the status as soon as the injury is applied.
	VrmuSetAttrs(updates, () => {
	    actionsUpdateStatus();
	    updatetokenmarkers();
	});
    });

}

function addSpecificInjury(injury) {
    const rowid = generateRowID();
    const prefix = `repeating_specificinjury_${rowid}`;

    updates = {}
    updates[`${prefix}_summary`] = "Some Injury";
    updates[`${prefix}_bleed`] = injury.B || 0;
    updates[`${prefix}_penalty`] = injury.P || 0;
    if (injury.B > 6 || injury.P > 40) {
	updates[`${prefix}_severity`] = 'Severe';
    } else if (injury.B > 4 || injury.P > 20) {
	updates[`${prefix}_severity`] = 'Medium';
    } else {
	updates[`${prefix}_severity`] = 'Mild';
    }
    let ilocation = 'Right ';
    if (injury.O == 1) {
	ilocation = 'Left ';
    } 
    if (injury.L) {
	if (injury.L == 1) ilocation += 'side of Chest/Abdoment';
	else if (injury.L == 2) ilocation += 'side of Head';
	else if (injury.L == 3) ilocation += 'Arm';
	else if (injury.L == 4) ilocation += 'Leg';
	else rmuerror("Unknown location ", injury.L);
    }
    updates[`${prefix}_location`] = ilocation;
    updates[`${prefix}_type`] = 'unknown';
    updates[`${prefix}_treatment`] = 'new';
    updates[`${prefix}_dailyrecovery`] = 'none';

    VrmuSetAttrs(updates);
}

function startRecoveryRoll(prefix) {
    getAttrs([`${prefix}_severity`, `${prefix}_type`,
	    `${prefix}_bleed`, `${prefix}_penalty`,
	    `${prefix}_location`, `${prefix}_treatment`,
	    'bodydevelopment_ranks', 'co', 'character_name'],
	(ev) => {
	    const simple = {};
	    for (let key of Object.keys(ev)) {
		const nk = key.replace(prefix + '_', '')
		simple[nk] = ev[key];
	    }
	    simple.dailyrecovery = `${prefix}_dailyrecovery`;
	    handleRecoveryRoll(simple);
    	}
    );
}



const recoveryRollData = {
    bone: [ 10, 8, 6, 4, 3 ,2, 1],
    cutsburn: [ 12, 10, 8, 6, 4 ,2, 1],
    muscle: [ 15, 12, 9, 7, 5 ,3, 1],
    organ: [ 20, 16, 12, 8, 6 ,4, 2],
    poison: [ 25, 20, 15, 10, 8 ,5, 3],
    tissue: [ 5, 4, 3, 2, 2 ,1, 1],
}

injuryCalcPerDayHeal = function (penalty, days) {
    penalty = Math.abs(penalty);
    const baseperday = Math.trunc(penalty / days);
    let excess = penalty % days

    const toheal = [];
    for (let i = 0 ; i < days ; i ++) {
	if (excess > 0) {
	    toheal[i] = baseperday + 1;
	    excess --;
	} else {
	    toheal[i] = baseperday;
	}

    }

    return toheal.join(",");
}


function handleRecoveryRoll(injury) {
    let mul = 1;

    if (injury.treatment === 'new') {
	sendMessage("Injury needs to be treated; or set to Untreated");
	return;
    }
    if (injury.type === 'unknown') {
	sendMessage("Please set the injury type before rolling (Bone, Organ etc)");
	return;
    }
    let column = recoveryRollData[injury.type];
    if (!column) {
	sendMessage(`Unable to find recovery column for ${injury.type}`);
	rmuerror(`Unable to find recovery column for ${injury.type}`);
	return;
    }

    // d100OE + BD ranks + Co + Type - Injury Penalty
    let mod = parseIntDefault(injury.bodydevelopment_ranks);
    let log = `${mod} [BodyDev Ranks] `;

    {
	const co = parseIntDefault(injury.co, 0);
	mod += co;
	if (co > 0) {
	    log += `+${co}&nbsp;[Co bonus] `;
	} else {
	    log += `${co}&nbsp;[Co bonus] `;
	}
    }

    {
	const pen = parseIntDefault(injury.penalty);
	mod -= pen;
	log += `-${pen}&nbsp[Injury Penalty] `;
    }

    if (injury.treatment == 'untreated') {
	mod -= 100;
	log += '-100&nbsp;[Untreated] ';
    } else if (injury.treatment == 'medicine') {
	log += '+0&nbsp;[Medicine] ';
    } else if (injury.treatment == 'medicineabsolute') {
	mod += 25;
	log += '+25&nbsp;[Medicine Absolute Success] ';
    } else if (injury.treatment == 'magic') {
	mod += 50;
	log += '+50&nbsp;[Magic or Herbalism] ';
    } else if (injury.treatment == 'magicherbalism') {
	mod += 75;
	log += '+75&nbsp;[Magic and Herbalism] ';
    }

    startRoll("@{whispertype} &{template:rmurecovery} " +
	"[[ 1d100!>96 ]] [[ 1d100!>96 ]] " +
	     "{\{roll=$[[0]]}} " +
	     "{\{oeroll=$[[1]]}} " +
	     `{\{who=${injury.character_name}}} ` +
	     `{\{mod=${mod}}} ` +
	     `{\{modlog=[[0]]}} ` +
	     `{\{total=[[0]]}} ` +
	     `{\{result=[[0]]}} `, (roll) => {
	let mainroll = roll.results.roll.result;
	let mainrollstr = roll.results.roll.dice.join(' + ');
	if (mainroll < 6) {
	    mainroll -= roll.results.oeroll.result
	    mainrollstr = mainrollstr + ' - (' + roll.results.oeroll.dice.join(' + ') + ')';
	}
	let total = mainroll + mod;

	// So lets work out the index;
	let ind = 6;
	if (total < 1) ind = 0;
	else if (total < 51) ind = 1;
	else if (total < 76) ind = 2;
	else if (total < 101) ind = 3;
	else if (total < 126) ind = 4;
	else if (total < 176) ind = 5;
	else ind = 6;

	let basedays = column[ind];
	if (typeof(basedays) != 'number') {
		console.log("Got invalid result", basedays, column, ind);
		sendMessage("Error occured looking up base days");
		return;
	}

	// So mutiplier time
	let adjustdays = basedays;
	let adjustlog = `${basedays} days`;
	if (injury.location.toLowerCase().includes('head')) {
	    adjustdays *= 2;
	    adjustlog += ' x2&nbsp;[Head Injury] ';
	}

	if (injury.severity == 'Medium') {
	    adjustdays *= 5;
	    adjustlog += ' x5&nbsp;[Medium Severity] ';
	} else if (injury.severity == 'Severe') {
	    adjustdays *= 10;
	    adjustlog += ' x10&nbsp;[Severe Severity] ';
	}

	let finallog = adjustlog;
	if (adjustdays != basedays) {
	    finallog = `${adjustdays} Days = ` + adjustlog;
	}

	
	finishRoll(roll.rollId, {
		total: total,
		roll: mainrollstr,
		modlog: log,
		result: finallog
	});

	// Calculate recovery schedule and save it.
	const perday = injuryCalcPerDayHeal(parseIntDefault(injury.penalty, 0), adjustdays);
	setAttrs({[injury.dailyrecovery]: perday});
	console.log("Saving", {[injury.dailyrecovery]: perday});

     });
}

onCheck("clicked:repeating_specificinjury:recoveryroll", (ev) => {
    const basename = ev.sourceAttribute.replace(/_recoveryroll\d*$/, "");
    startRecoveryRoll(basename);
});

// FIXME: Should add a are you sure button
onCheck('clicked:repeating_specificinjury:deleteitem', (ev) => {
	const basename = ev.sourceAttribute.replace("_deleteitem", "");
	removeRepeatingRow(basename);
});



// vim: set sw=4 sts=4 syn=javascript :



/**
 * This is called on init.
 *
 * All sheet:opened calls should be from here.
 */

onCheck("sheet:opened", (x) => {
    // First clear pending
    console.log("Sheet Load", x);
    pendingInfo();
    pendingReset();

    messageHackery()

    Edit.hideEdit();
    setAttrs({inventoryaddshow: 'off', toggletalentshow: 'off',
          togglesleepshow: 'off', togglesleepinjuriesuntreatedshow: 'off'});

    getAttrs(['charactercreated'], init => {
        if (init.charactercreated == 'true') {
          // Make sure charactermancer button is hiiden
          setAttrs({"flag_cmancer_show": "0"})

          // Do nothing
          return;
        }
        setAttrs({"flag_cmancer_show": "on"})
    });

    getAttrs(['sheetselect', 'version'], (sheet) => {
        console.log(`Current Version: ${sheet.version} : Sheet type: ${sheet.sheetselect}`);
        if (!sheet.sheetselect) {
          sheet.sheetselect = 'playersheet';
          setAttrs(sheet);
        }
        if (sheet.sheetselect == 'playersheet') {
          RMUSkills.updateStatCache();
        }

        doVersionCheck(sheet.version || 1, sheet.sheetselect);

        if (sheet.sheetselect == 'creaturesheet') {
          getAttrs(["defenses"], data => { creature.parseDefenses(data.defenses) });
        }
    });

});

function doVersionCheck(version, sheettype) {
  const oldversion = version;
  if (version == 'latest') {
    // New character... we are done
    vesion = 17;
  }

  if (version == 1) {
    addPendingFunction("Upgrade from 1 to 2", upgradeV1to2);
    version = 2;
  }

  if (version == 2) {
    addPendingFunction("Upgrade from 2 to 3", upgradeV2to3);
    version = 3;
  }

  if (version == 3) {
    addPendingFunction("Upgrade from 3 to 4", upgradeV3to4);
    version = 4;
  }

  if (version == 4) {
    addPendingFunction("Upgrade from 4 to 5 (Dynamic Vocations)", upgradeV4to5);
    version = 5;
  }

  if (version == 5) {
    addPendingFunction("Upgrade to 6: Force skill update from missing update in 5", RMUSkills.updateAllSkills);
    version = 6;
  }

  if (version == 6) {
    addPendingFunction("Upgrade to 7: Save baselists on sheet", upgradeV6to7);
    version = 7;
  }

  // Version 7->8 was faulty, bump it to 9 to force it to run again.
  if (version == 7) {
    version = 8;
  }

  if (version == 8) {
    // updatePenalties in in status; old value will be updateed by equipment update
    addPendingFunction("Upgrade to 9: Manuever_penalty -> statuspenalty", updatePenalties);
    addPendingFunction("Upgrade to 9: Update Equipment", RMUInventory.updateEquipped);
    addPendingFunction("Upgrade to 9: Update Encumberance", RMUInventory.updateEncumberance);
    version = 9;
  }

  if (version == 9) {
    addPendingFunction("Upgrade to 10: Update Endurance", updateEnduranceBonus);
    version = 10;
  }

  if (version == 10) {
    addPendingFunction("Upgrade to 11: Force RR recalc for Arcane", () => {
        if (sheettype == 'creaturesheet') {
          getAttrsPending(["rr_channeling_bonus", "rr_essence_bonus", "rr_mentalism_bonus"], (rr) => {
              setAttrs({rr_arcane_bonus: mid3(parseIntDefault(rr.rr_channeling_bonus, 0),
                      parseIntDefault(rr.rr_essence_bonus, 0), 
                      parseIntDefault(rr.rr_mentalism_bonus, 0))});
          });
        } else {
          rrs.updateAllRR();
        }
    });
    version = 11;
  }

  if (version == 11) {
    // Hoised to 13
    version = 12;
  }

  if (version == 12) {
    setAttrs({allpenalties: 0, statuspercent: 0, statuspercent_max: 100 });
    version = 13;
  }

  if (version == 13) {
    setAttrs({allpenalties: 0, statuspercent200: 0, statuspercent200_max: 200 });
    version = 14;
  }

  if (version == 14) {
    addPendingFunction("Upgrade to V15: Fix racial HP bonus", upgradeV14to15HPFix)
    version = 15;
  }

  if (version == 15) {
    addPendingFunction("Upgrade to V16: Set XP Progression", upgradeV15to16XPProgression)
    version = 16;
  }

  if (version == 16) {
    addPendingFunction("Upgrade to V17: No prep overcast option", () => {
        setAttrsPending({"option_allownoprepovercast": "no"});
    });
    version = 17;
  }
  if (oldversion != version) {
    addPendingFunction(`Version update to ${version}`, () => {
        setAttrsPending({version: version});
    });
  }

  checkPending();
}

/**
 * Version 1 has costs in charactermancer.  Version 2 moves to each field.
 */
function upgradeV1to2() {
  // get profeession.
  getAttrsPending(['profession'], ({profession}) => {
      console.log('profession', profession); 
      getCompendiumPage(`Profession:${profession}`, (pdata) => {
          const skills = JSON.parse(pdata.data['data-skillCost']);
          const updates = {};
          for (const [group, cost] of Object.entries(skills)) {
            updates[RMUSkills.getCatByDisplayName(group)?.aname + "_cost"] = cost;
          }
          {
            const mcosts = JSON.parse(pdata.data['data-Spellcasting']);
            updates.magicalritual_cost = mcosts['Magic Ritual'];
            updates.spellownbase_cost = mcosts['Base'];
            updates.spellopen_cost = mcosts['Open'];
            updates.spellclosed_cost = mcosts['Closed'];
            updates.spellrestricted_cost = mcosts['Restricted'];
            updates.spellarcane_cost = mcosts['Arcane'];
          }
          updates.costdatasaved = true;
          console.log(updates);
          setAttrsPending(updates);
      });

  });
}

/**
 * Version 2 may have two realm stats listed in scr misc.
 * delete the 'Realm Stat Bonus' field.
 */
function upgradeV2to3() {
  miscAttrRemove("scr_misc", "Realm Stat Bonus");
}

function upgradeV3to4() {
  setAttrs({powerlevel:"Superior"});
}

const upgradeSkillList = {
  administration : {
    bookkeeper : "Bookkeeper",
    librarian : "Librarian",
    officer : "Officer",
    manager : "Manager",
    quartermaster : "Quartermaster",
    seneschal : "Seneschal",
  },
  service: {
    bodyguard : "Bodyguard",
    bonesetter : "Bonesetter",
    casinodealercroupier : "Casino Dealer/Croupier",
    guardsman : "Guardsman",
    guide : "Guide",
    innkeeper : "Innkeeper",
    purser : "Purser",
    researcher : "Researcher",
    shaman : "Shaman",
    teacher : "Teacher",
    valet : "Valet",
  },
  trade: {
    blacksmith : "Blacksmith",
    carpenter : "Carpenter",
    farmer : "Farmer",
    fence : "Fence",
    gambler : "Gambler",
    herdsman : "Herdsman",
    hunter : "Hunter",
    merchant : "Merchant",
    miner : "Miner",
    pirate : "Pirate",
    sailor : "Sailor",
    scribe : "Scribe",
    soldier : "Soldier",
    thief : "Thief",
    tinker : "Tinker",
    trapper : "Trapper",
    weaver : "Weaver",
  }
}


function upgradeV4to5() {
  toget = [];
  // So loop through the three categories, then
  for (voc in upgradeSkillList) {
    for (spec in upgradeSkillList[voc]) {
      toget.push(spec + '_ranks_misc');
      toget.push(spec + '_misc');
    }
  }
  getAttrsPending(toget, (bonuses) => {
      const toupdate = {}
      let needupdate = false;
      for (voc in upgradeSkillList) {
        for (spec in upgradeSkillList[voc]) {
          if (bonuses[ spec + '_ranks_misc'] || bonuses[ spec + '_misc']) {
            needupdate = true;
            const row = generateRowID()
            toupdate[`repeating_specialization${voc}_${row}_ranks_misc`] = bonuses[spec + '_ranks_misc'] || '';
            toupdate[`repeating_specialization${voc}_${row}_misc`] = bonuses[spec + '_misc'] || '';
            toupdate[`repeating_specialization${voc}_${row}_name`] = upgradeSkillList[voc][spec];
          }
        }
      }
      console.log(toupdate);
      if (needupdate) {
        setAttrsPending(toupdate);
      }
  });
}

// Since treasure law requires you to pick base lists, we are going to store them on
// the sheet itself going forward.
//
// We only need to apply this change if they have a profession.  So newly created
// characters are skipped.
function upgradeV6to7() {
  getAttrsPending(["profession"], (prof) => {
    if (!prof.profession) {
      //New character; done!
      console.log("Character not created; skipping");
      return;
    }
    console.log("get existing base lists");
    getSectionIDsPending("repeating_spelllistspellownbase", (ids) => {
      if (ids.length == 6) {
        console.log("if 6... we are done");
        // We have enough; stop.
        return;
      }
      const toget = []
      for (id of ids) {
        toget.push(`repeating_spelllistspellownbase_${id}_name`);
      }
      getAttrsPending(toget, (listnames) => {
        // FIXME: This is a set.
        const names = {};
        for (name in listnames) {
          names[listnames[name]] = true;
        }
        getCompendiumQueryPending(`Category:SpellList ListType:*${prof.profession} Base*`, (lists) => {
          const toupdate = {};
          for (ind in lists) {
            const list = lists[ind];
            if (names[list.name]) {
              continue;
            }
            const rowid = generateRowID();
            toupdate[`repeating_spelllistspellownbase_${rowid}_name`] = list.name;
          }

          setAttrsPending(toupdate);
        });
      });
    });
  });
}

// So I was adding the racial bonus to body development.
// frewfrux pointed out this is wrong: This means you get
// racial bonus to Endurance
function upgradeV14to15HPFix() {
  getAttrsPending(["hp_misc", "bodydevelopment_misc"], (data) => {
      console.log("Data for upgrade", data)
      let res = miscBonusPrefix(data.bodydevelopment_misc, "Racial");
      if (res && res.name) {
        // Found it: Lets delete it
        let updates = {}
        updates.bodydevelopment_misc = miscBonusRemove(data.bodydevelopment_misc, res.name);

        // Now add to the HP misc
        let hpms = miscRawGetFromString(data.hp_misc);
        hpms.push(res);
        updates.hp_misc = miscRawToString(hpms);
        console.log(updates)
        setAttrsPending(updates);

        // After we are done; do these
        addPendingFunction("Post V15 Upgrade; Update All Skills", RMUSkills.updateAllSkills);
        addPendingFunction("Post V15 Upgrade; Update HP", updateHPPP);
        addPendingFunction("Post V15 Upgrade; Update Endurance", updateEnduranceBonus);
      }
  });
}


function upgradeV15to16XPProgression() {
  getAttrsPending(["option_xpprogression", "option_fixedrrbase", "option_journalledxp"], (data) => {
      if (!data.option_xpprogression) {
        setAttrsPending({option_xpprogression: "rmu"});
      }
      if (!data.option_fixedrrbase) {
        setAttrsPending({option_fixedrrbase: "no"});
      }
      if (!data.option_journalledxp) {
        setAttrsPending({option_journalledxp: "no"});
      }
  });
}



function messageHackery() {

  console.log("Message Hacker", postMessage)
  console.log("Character ID", getActiveCharacterId());
}

// vim: set sw=2 sts=2 syn=javascript :


let tracker = {}

tracker.repeatingprefix = "repeating_trackercharacter";

/*
Movement
Attacks 
Movement skills
Footwork 
Spells.
Initiative
Perception*/

tracker.allAttributes = [
  "hp", "hp_max", "pp", "pp_max", 
  "hp_percent", "pp_percent",
  "character_token",
  "character_name",
  "actionselect", 
  "aptrack_loaded",
  "aptrack",
  "lastinitiative",
  "rr_channeling_bonus", 
  "rr_arcane_bonus", 
  "rr_essence_bonus", 
  "rr_mentalism_bonus", 
  "rr_fear_bonus", 
  "rr_physical_bonus", 
  "parry_mod",
  "other_mod",
  "dbmod",
  "activedb",
  "at"
]



onCheck("clicked:trackedreturntocharacter", () => {
  setAttrs({sheetselect: "playersheet"});
});

onCheck("clicked:trackerinit", () => {
  console.log("Tracker sheet start");
  setAttrs({sheetselect: "trackersheet"});
});


// Somone clicked the add target button. so lets add them
// We just get the token_id and the character_id first.
// Then we start getting all the other fields.
onCheck("clicked:trackeraddcreature", () =>{
//  tracker.dataGet('target', generateRowID());
 const roll_string = "&{template:rmutrackeradd} [[1d20]] " +
        "{\{who=Tracker}} " +
        "{\{targettokenid=[[0[@{target|token_id}]]]}} " +
        "{\{targetname=[[0[@{target|character_name}]]]}} " +
        "{\{targetcharacterid=[[0[@{target|character_id}]]]}}";
  console.log(roll_string);
  startRoll(roll_string, roll => {
      console.log(roll);
      const tokenid = attacks.getDataFromRoll(roll.results.targettokenid.expression);
      const characterid = attacks.getDataFromRoll(roll.results.targetcharacterid.expression);
      const targetname = attacks.getDataFromRoll(roll.results.targetname.expression);
      const updates = { targetname: targetname };
      console.log("Got tokenid and characterid", tokenid, characterid, roll);

      tracker.addTarget(targetname, characterid, tokenid);
      finishRoll(roll.rollId, updates);
  });
});

tracker.appendPrefix = function(prefix, object) {
  return Object.fromEntries(
    Object.entries(object).map(([key, value]) => [prefix + key, value])
  );
}

// So when the AP per phase here triggers, set all the sheets
// This si one way - tracker sets teh other sheets.
onCheck("change:apperphase", (ev) => {
  console.log(ev)
  tracker.setAllSheets({actionapperphase:ev.newValue});
});

/**
 * This is the main call to add items to the tracker.
 */
// FIXME: Should check for duplicates
// FIXME: Should warn if no character id
tracker.addTarget = function(name, characterid, tokenid) {
  const rowid = generateRowID();
  const prefix = `repeating_trackercharacter_${rowid}_`;

  // First pass: Lets just add the basic item
  const updates = {}
  updates.trackedname = name;
  updates.tokenid = tokenid;
  updates.characterid = characterid;

  console.log(tracker.appendPrefix(prefix, updates));
  setAttrs(tracker.appendPrefix(prefix, updates));

  const trackerid = getActiveCharacterId();

  // So as the character I need to let it know what tracker it has
  rmuSetAttrsRemote(characterid, {trackerid: trackerid, trackerprefix: prefix});
  
  rmuGetAttrsRemote(characterid, tracker.allAttributes, (data) => {
      // this call back is in the context of the character.
      rmuSetAttrsRemote(trackerid, tracker.appendPrefix(prefix, data));
  });
}


tracker.setAllSheets = function(values) {
  tracker.forAllSheets((id) => {
        rmuSetAttrsRemote(id, values);
  });
}

tracker.forAllSheets = function(func) {
  getSectionIDs(tracker.repeatingprefix, (ids) => {
    const toget = ids.map((x) => tracker.repeatingprefix + "_" + x + "_characterid");
    getAttrs(toget, (characterids) => {
      for (row in characterids) {
        func(characterids[row])
      }
    });
  });
}

onCheck("clicked:trackerrollinitiative", (_) => {
  tracker.forAllSheets((id) => {
    asCharacter(id, () => {doRollInitiativeNoTracker()});
  });
});


// old call
onCheck("clicked:repeating_trackercharacter:deletetracked", (ev) => {
  const basename = ev.sourceAttribute.replace("_deletetracked", "");
  removeRepeatingRow(basename);
});

// old call; now borked
onCheck("clicked:repeating_trackercharacter:selecttarget", (ev) => {
  // We are keeping the last '_' as getTargetData doesn;t know about it
  const basename = ev.sourceAttribute.replace("selecttarget", "");
  attacks.getTargetData("target", basename)
 });



// old call
const fields = {
    // Type is the type of data.
    // Field is what we pull on the source character
    trackedname: { type: "string", field: "character_name" },
    trackedat: { type: "string", field: "at" },
    trackeddb: { type: "string", field: "db" },
    trackedchannelingrr: { type: "number", field: "rr_channeling_bonus" },
    trackedessencerr: { type: "number", field: "rr_essence_bonus" },
    trackedmentalismrr: { type: "number", field: "rr_mentalism_bonus" },
    trackedfearrr: { type: "number", field: "rr_fear_bonus" },
    trackedphysicalrr: { type: "number", field: "rr_physical_bonus" },
    trackedparrymod: { type: "number", field: "parrymod" },
    trackedothermod: { type: "number", field: "othermod" },
    //trackedtokenid: { type: "string", field: "token_id" },
    trackedskills: { type: "skillstring", field: "skillstring" },
    trackedmoves: { type: "movestring", field: "movestring" },
    trackedstatuseffect: { type: "string", field: "statuseffect" },
    trackedstatusmessage: { type: "string", field: "statusmessage" },
    trackedattacklist: { type: "attackstring", field: "attacklist" },
}

/**/
// old call
tracker.extractResults = function(roll, prefix) {
  const results = {}
  const rr = roll.results;
  for (const field in fields) {
    const info = fields[field];
    if (info.type == 'string') {
      results[field] = attacks.getDataFromRoll(rr[field].expression);
    } else if (info.type == 'number') {
      results[field] = parseIntDefault(attacks.getDataFromRoll(rr[field].expression), 0);
    } else if (info.type == 'skillstring') {
      tracker.handleSkillString(attacks.getDataFromRoll(rr[field].expression), results);
    } else if (info.type == 'movestring') {
      tracker.handleMoveString(attacks.getDataFromRoll(rr[field].expression), results);
    } else if (info.type === 'attackstring') {
      tracker.handleAttackString(attacks.getDataFromRoll(rr[field].expression), results);
    } else {
      rmuerror("Tracker Unknown type:", info.type);
    }
  }
  return results;
}

// old call
tracker.buildString = function(whom) {
  let reqs = ["&{template:rmuattacktarget} [[1d20]]"];
  for (const field in fields) {
    const info = fields[field];
    if (info.type == 'string' || info.type == 'skillstring' || info.type == 'movestring') {
      reqs.push(`{\{${field}=[[0[@{${whom}|${info.field}}] ]]}}`);
    } else if (info.type == 'number') {
      reqs.push(`{\{${field}=[[0[@{${whom}|${info.field}}] ]]}}`);
    } else {
      rmuerror("Unkown type, barfing");
    }
  }
  return reqs.join(" ");
}


// old call
tracker.dataGet = function(whom, rowid) {
  const roll_string = tracker.buildString(whom);
  startRoll(roll_string, roll => {
    const prefix = `repeating_trackercharacter_${rowid}_`;
    // FIXME: Should not do prefix: Instead do extract, then a fixup pass,
    // then add the prefix
    const results = tracker.extractResults(roll, prefix);
    // Update the results
    const toset = {}
    Object.keys(results).forEach(x => {
        toset[prefix + x] = results[x];
    });
    finishRoll(roll.rollId);
    console.log(toset);
    setAttrs(toset);
  });
}


// old call
tracker.handleSkillString = function(string, updates) {
  console.log("Handle skill string", string);
  if (!string || string == '') return;
  if (string.startsWith("TARGET")) return;
  if (string.endsWith("|skillstring")) return;
  let skills = string.split(';');
  console.log(skills);
  for (let i = 0 ; i < skills.length ; i ++) {
    let skill = skills[i]
    console.log(">", skill);
    const match = skill.match(/^(.*) (\d*)$/);
    console.log(match, match.length);
    if (match.length < 3) {
      continue;
    }
    updates[`trackedskill${i}skillname`] =`${match[1]} ${match[2]}`;
    updates[`trackedskill${i}skillranks`] = match[2];
   // updates[`repeat_trackedskill${rowid}_bonus`] = match[2];
  }
}
// old call
tracker.handleMoveString = function(string, updates) {
  console.log("Handle move string", string);
  if (!string || string == '') return;
  let moves = string.split(';');
  console.log(moves);
  for (let i = 0 ; i < moves.length ; i ++) {
    // Expected: Walk(Dash)34;Swimming(Walk)23
    let move = moves[i]
    const fields = move.match(/(.*)\((.*)\)(\d*)/)
    if (!fields[0]) {
      rmuerror("Unable to match move string", move, moves);
      continue;
    }
    updates[`trackedmove${i}name`] = fields[1];
    updates[`trackedmove${i}pace`] = fields[2];
    updates[`trackedmove${i}rate`] = fields[3];
  }
}

// old call
tracker.handleAttackString = function(string, updates) {
  console.log("Handle attack string", string);
  if (!string || string == '') return;
  let attacks = string.split(',')
  console.log(attacks)
  for (let i = 0 ; i < attacks.length ; i ++) {

  }


}

/**
 * Sheet Events
 *
 * These should all be triggered in the context of the sheet.
 * And then send the data to the tracker, if any.
 */
onCheck("change:lastinitiative", () => {
  getAttrs(["lastinitiative", "trackerid", "trackerprefix"], (data) => {
    if (data.trackerid && data.trackerprefix) {
      rmuSetAttrsRemote(data.trackerid,
          { [data.trackerprefix + "lastinitiative"] : data.lastinitiative });
    }
  });
});

for (attr of tracker.allAttributes) {
  onCheck("change:" + attr, (ev) => {
      getAttrs(["trackerid", "trackerprefix"], (data) => {
          if (data.trackerid && data.trackerprefix) {
            rmuSetAttrsRemote(data.trackerid,
                { [data.trackerprefix +  ev.sourceAttribute] : ev.newValue }
            );
          }
      });
  });
}




console.log("Tracker sheet loaded");

/**/

/**/
const actionCalls = [
	'attack primary_action', 'attack secondary_action',
	'ap➙melee_action',
	'ap➙missile_action', 'ap➙clear_action', 'ap➙spell_action',
	'ap➙perception_action', 'ap➙concentration_action', 'ap➙free_action',
	'ap➙status_action', 'end turn_action', "initiative_action",
	'target_action'];
onCheck("sheet:opened change:character_name", (_) => {
  getAttrs(['character_name',...actionCalls],(attributes) => {
    const setObj = actionCalls.reduce((m,attr) => {
	let ar = attr.replace(/_/g, '-');
        m[attr] = `%{${attributes.character_name}|${ar}}`;
        return m;
    }, {});
    console.log("Attribute onload actionbutton hackery", setObj);
    setAttrs(setObj,{silent:true});
  });
});



function apactionAttackSelect(prefix, ids, attackindex, handler) {
  console.log(ids);
  
  if (!ids[attackindex]) {
    rmuerror("We don't have an index of ", attackindex, ids, prefix, "apactionAttackSelect");
    return;
  }

  // So get the right prefix
  const id = prefix + '_' + ids[attackindex];
  console.log(id);
  console.log(handler);
  // Fake up an event
  handler({ sourceAttribute : id });
}

onCheck("clicked:attack primary-action clicked:attack secondary-action", (ev) => {
    console.log(ev);
    let attackindex = 0;
    if (ev.triggerName.includes('secondary')) {
      attackindex = 1;
    }


    // So we need to find out what sort of sheet
    getAttrs(['sheetselect'], (sheet) => {
	console.log(sheet);
	if (sheet.sheetselect == 'playersheet') {
	  getSectionIDs('repeating_attack', (attacklist) => {
	      apactionAttackSelect('repeating_attack', attacklist, attackindex, attacks.doAttack);
	  });
	  
	} else if (sheet.sheetselect == 'creaturesheet') {
	  console.log("creature attack", sheet);
	  getSectionIDs('repeating_creatureattack', (attacks) => {
	      console.log("attacks rodered", attacks);
	      apactionAttackSelect('repeating_creatureattack', attacks, attackindex, creature.doAttack);
	  });
	} else {
	  rmuerror("Tokenactions: Primary attack: Unknown sheet:", sheet.sheetselect);
	}
    });
});




onCheck("clicked:ap➙missile-action", (ev) => { actionIncrease('missile'); });
onCheck("clicked:ap➙melee-action", (ev) => { actionIncrease('melee'); });
onCheck("clicked:ap➙spell-action", (ev) => { actionIncrease('spell'); });
onCheck("clicked:ap➙perception-action", (ev) => { actionIncrease('perception'); });

// Just trigger the event sequence
onCheck("clicked:ap➙free-action", (ev) => { setAttrs({"aptrack_freeused":'on'}) });
onCheck("clicked:ap➙concentration-action", (ev) => { actionConcentration(ev); });
onCheck("clicked:ap➙status-action", (ev) => { actionStatus(ev); });
onCheck("clicked:ap➙clear-action", (ev) => { actionClear(); });

onCheck("clicked:end turn-action", (ev) => {
    doTurn();
});
onCheck("clicked:target-action", (_) => {
    console.log("Target action clicked");
    attacks.getTargetData('target');
});

onCheck("clicked:initiative-action", (ev) => {
  doRollInitiative();
});

// vim: set sw=2 sts=2 syn=javascript :

/**/

const target = {}


onCheck("change:target_characterid", (change) => {
    console.log("Change of target characgter id", change);
    if (change.newValue == change.previousValue) {
        return;
    }

    let oldidtarget = change.oldValue;
    let newidtarget = change.newValue;
    const myid = getActiveCharacterId();

    // Remove myself from the old list
    /*
    rmuGetAttrsRemote(oldidtarget, ["target_listeners"], (remote) => {
       const result = remote.target_listeners
            .split(",")
            .filter(item => item !== myid)
            .join(",");
        setAttrs({target_listeners: result});
    });*/

    // Add myself to the new list

    rmuGetAttrsRemote(newidtarget, ["target_listeners"], (remote) => {
        let result = remote.target_listeners
        if (result) {
            result += ',' + myid;
        } else {
            result = myid;
        }
        setAttrs({target_listeners: result})
    });
});

onCheck("change:db", (db) => {
    getAttrs(["target_listeners"], (listen) => {
        console.log("db change", db, listen);
        if (!listen.target_listeners || listen.target_listeners.length < 2) {
            console.log("Seems empty; stopping");
            return;
        }
        listen.target_listeners.split(",").forEach((who) => {
            rmuSetAttrsRemote(who, {target_db: db.newValue});
        });


    });
});





/* vim:set sw=4 sts=4 syn=javascript : */



function getStatFromAName(aname) {
	for (let i = 0 ; i < StatInfo.length ; i ++) {
		if (StatInfo[i].aname == aname){
			return StatInfo[i];
		}
	}
	console.log("Could not find stat "  + aname);
	return null;
}


function d100(){
    return Math.floor(Math.random() * 100) + 1;
}

function d100min(min) {
    let x = d100();
    while (x < min) {
	x = d100();
    }
    return x;
}

function dX(x) {
    return Math.floor(Math.random() * x) + 1;
}


// Hacky send to chat
onCheck("clicked:sendtochat", () => {
  console.log("Send to chat clicked");
  getAttrs(["chatcommand"], (ev) => {
    console.log("command", ev);
    //macroscript = "!token-mod --set statusmarkers|red";
    startRoll(ev.chatcommand, (results2) => {
        console.log(results2);
        // Holding the computed data in an object is a bit cleaner if your rolls get more complex
        let rollData2 = results2.results;
        finishRoll(results2.rollId, rollData2);
        });
      });
});

</script>




</div>

