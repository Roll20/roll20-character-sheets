<input type='hidden' class='page-form' name='attr_pageTab' />

<div class='page'>
    <div class="grid-general">
        <!-- Colonne de gauche, infos du perso et expertise -->

        <div class="grid-character">
            <div class="page-block">
                <!-- Logo broxia -->
                <div class="grid-logo-onepiece">
                    <img src="https://raw.githubusercontent.com/Mihawk59/onepiece-d100/main/img/logo.jpg"/>
                </div>
                <div class="grid-head-character">
                    Personnage
                </div>
                <div class="grid-character-nom">
                    Nom :<br>
                    <input type="text" title="@{perso_nom}" class="page-input-text" spellcheck="false"
                        name="attr_perso_nom" placeholder="Nom" />
                </div>
                <div class="grid-character-race">
                    Race :<br>
                    <input type="text" title="@{perso_race}" class="page-input-text" spellcheck="false"
                        name="attr_perso_race" placeholder="Race" />
                </div>
                <div class="grid-character-taille">
                    Taille :<br>
                    <input type="text" title="@{perso_taille}" class="page-input-text" spellcheck="false"
                        name="attr_perso_taille" placeholder="Taille" />
                </div>
                <div class="grid-character-classe">
                    Classe :<br>
                    <input type="text" title="@{perso_classe}" class="page-input-text" spellcheck="false"
                        name="attr_perso_classe" placeholder="Classe" />
                </div>
                <div class="grid-character-profession">
                    Profession :<br>
                    <input type="text" title="@{perso_profession}" class="page-input-text" spellcheck="false"
                        name="attr_perso_profession" placeholder="Profession" />
                </div>
                <div class="grid-character-faction">
                    Faction :<br>
                    <input type="text" title="@{perso_faction}" class="page-input-text" spellcheck="false"
                        name="attr_perso_faction" placeholder="Faction" />
                </div>
                <div class="grid-character-themes">
                    Thèmes :<br>
                    <textarea class="area-perso" spellcheck="false" title="@{perso_themes}" name="attr_perso_themes"
                        placeholder="Thèmes"></textarea>
                </div>
                <div class="grid-character-statut">
                    Statut :<br>
                    <input type="text" title="@{perso_statut}" class="page-input-text" spellcheck="false"
                        name="attr_perso_statut" placeholder="Statut" />
                </div>
                <div class="grid-character-prime">
                    Prime :<br>
                    <input type="text" class="text-prime" name="attr_prime" title="@{prime}">
                    <img src="https://raw.githubusercontent.com/Mihawk59/onepiece-d100/main/img/Symbole_Berry.png" width="8%" />
                </div>
            </div>
        </div>

        <div class='grid-stats-perso'>
            <!-- Stats du personnage-->
            <div class="page-block">
                <div class="page-head">
                    Attributs
                </div>

                <!-- On définit la valeur de l'energie', 0 par défaut -->
                <input name="attr_modenergy" type="hidden" value="0" title="@{modenergy}">

                <!-- Input afin de stocker les valeurs MAX -->
                <input name="attr_volonte_max_stock" type="hidden" title="@{volonte_max_stock}">
                <input name="attr_haki_max_stock" type="hidden" title="@{haki_max_stock}">
                
                <div class="grid-stats-ingame">
                    <div class="grid-stats-lvl">
                        Niveau :
                        <input type="number" class="page-number-main" name="attr_niveau" title="@{niveau}">
                    </div>
                    <div class="grid-stats-volonte">
                        Volonté :
                        <input type="number" class="page-number-main" name="attr_volonte" title="@{volonte}">
                        /
                        <input type="number" class="page-number-bar-max" name="attr_volonte_max" title="@{volonte_max}">
                    </div>
                    <div class="grid-stats-energy">
                        Énergie :
                        <input type="number" class="page-number-main" name="attr_energy" title="@{energy}">
                        /
                        <input type="number" class="page-number-bar-max" name="attr_energy_max" title="@{energy_max}">
                    </div>
                    <div class="grid-stats-desdestin">
                        Destin :
                        <input type="number" class="page-number-main" name="attr_des_destin" title="@{des_destin}">
                        <button type='action' name='act_destinbutton' class="destiny-dice" title="@{destinbutton}"><img
                                src="https://raw.githubusercontent.com/Mihawk59/onepiece-d100/main/img/destiny-dice.png"
                                width="20px" /></button>
                    </div>
                    <div class="grid-stats-haki">
                        Haki :
                        <input type="number" class="page-number-main" name="attr_haki" title="@{haki}">
                        /
                        <input type="number" class="page-number-bar-max" name="attr_haki_max" title="@{haki_max}">
                    </div>
                    <div class="grid-stats-vitesse">
                        Vitesse :
                        <input type="number" class="page-number-long" name="attr_vitesse" title="@{vitesse}">

                        <!-- Stock la vitesse max autorisée par le personnage, hors bonus -->
                        <input name="attr_vitesse_stock" type="hidden" title="@{vitesse_stock}">
                    </div>
                </div>

                <div class="page-head">
                    Statistiques
                </div>
                <!-- Stats principales et secondaires : exemple Physique - force - Agilité -->
                <div class="grid-stats">
                    <div class="grid-stats-physique">
                        Physique
                    </div>
                    <div class="grid-stats-social">
                        Social
                    </div>
                    <div class="grid-stats-mental">
                        Mental
                    </div>

                    <div class="grid-stats-physique-value">
                        <input type="number" class="page-number-main" name="attr_physique" title="@{physique}">

                        <!-- On lance un dés qui s'affiche en rouge en cas d'échec critique (entre 96 et 100) et en vert en cas de réussite critique (5 ou moins)
                             et on affiche la stats concernée + les modificateurs bonus/malus
                            plus d'info : https://wiki.roll20.net/Dice_Reference#Critical_Success_and_Fumble_Points -->

                        <button type='roll'
                            value='/me effectue un jet de Physique ! [[1d100cs<5cf>96]] vs: [[@{physique}+@{mod}+@{modenergy}]]'
                            name='roll_Physique'></button>

                        <!-- le format de la value est une macro roll20 : https://wiki.roll20.net/Macros -->
                    </div>
                    <div class="grid-stats-social-value">
                        <input type="number" class="page-number-main" name="attr_social" title="@{social}">
                        <button type='roll'
                            value='/me effectue un jet de Social ! [[1d100cs<5cf>96]] vs: [[@{social}+@{mod}]]'
                            name='roll_Social'></button>
                    </div>
                    <div class="grid-stats-mental-value">
                        <input type="number" class="page-number-main" name="attr_mental" title="@{mental}">
                        <button type='roll'
                            value='/me effectue un jet de Mental ! [[1d100cs<5cf>96]] vs: [[@{mental}+@{mod}+@{modenergy}]]'
                            name='roll_Mental'></button>
                    </div>

                    <div class="grid-stats-force">
                        Force
                    </div>
                    <div class="grid-stats-agilite">
                        Agilité
                    </div>
                    <div class="grid-stats-intimidation">
                        Intimidation
                    </div>
                    <div class="grid-stats-persuasion">
                        Persuasion
                    </div>
                    <div class="grid-stats-intuition">
                        Intuition
                    </div>
                    <div class="grid-stats-intelligence">
                        Intelligence
                    </div>

                    <!-- On définit en caché les jets possibles pour les sous-catégories des stats principales -->
                    <input type="number" disabled="true" class="page-query"
                        value="?{type de dé|d6, 1d6cs1cf6|d8, 1d8cs1cf8|d10, 1d10cs1cf10|d12, 1d12cs1cf12|d20, 1d4cs1cf4}"
                        name="attr_query" title="@{query}">

                    <div class="grid-stats-force-value">
                        <input type="number" class="page-number" name="attr_force" title="@{force}">

                        <!-- On lance le dés choisi par le joeur dans la query ci-dessus et on compare à la stat + le modificateur de bonus/malus -->

                        <button type='roll'
                            value="/me effectue un jet de force ! [[@{query}]] vs: [[@{force}+@{mod}]]"
                            name='roll_force'></button>
                    </div>
                    <div class="grid-stats-agilite-value">
                        <input type="number" class="page-number" name="attr_agilite" title="@{agilite}">
                        <button type='roll'
                            value="/me effectue un jet de agilite ! [[@{query}]] vs: [[@{agilite}+@{mod}]]"
                            name='roll_agilite'></button>
                    </div>
                    <div class="grid-stats-intimidation-value">
                        <input type="number" class="page-number" name="attr_intimidation" title="@{intimidation}">
                        <button type='roll' value="/me effectue un jet d'intimidation ! [[@{query}]] vs: [[@{intimidation}+@{mod}]]"
                            name='roll_intimidation'></button>
                    </div>
                    <div class="grid-stats-persuasion-value">
                        <input type="number" class="page-number" name="attr_persuasion" title="@{persuasion}">
                        <button type='roll'
                            value="/me effectue un jet de persuasion ! [[@{query}]] vs: [[@{persuasion}+@{mod}]]"
                            name='roll_persuasion'></button>
                    </div>
                    <div class="grid-stats-intuition-value">
                        <input type="number" class="page-number" name="attr_intuition" title="@{intuition}">
                        <button type='roll'
                            value="/me effectue un jet d'intuition ! [[@{query}]] vs: [[@{intuition}+@{mod}]]"
                            name='roll_intuition'></button>
                    </div>
                    <div class="grid-stats-intelligence-value">
                        <input type="number" class="page-number" name="attr_intelligence" title="@{intelligence}">
                        <button type='roll'
                            value="/me effectue un jet de intelligence ! [[@{query}]] vs: [[@{intelligence}+@{mod}]]"
                            name='roll_intelligence'></button>
                    </div>
                </div>
            </div>

            <!-- Mise en place des tabs, par défaut sur competences -->
            <input type="hidden" class="page-tabstoggle" name="attr_pageTab" value="competences" />

            <div class="tab" name="attr_tab">
                <button class="tablinks" type="action" name="act_competences">Compétences</button>
                <button class="tablinks" type="action" name="act_equipement">Équipement</button>
                <button class="tablinks" type="action" name="act_specialisation">Spécialisation</button>
            </div>

            <div class="page-competences">
                <!-- Compétences et capacites -->
                <div class="page-block">
                    <div class="page-head">
                        Compétences et capacités
                    </div>
                    <div class="grid-competences-capacites">

                        <!-- Répétitions de compétences, création de ligne à la volé -->
                        <div class='grid-competences'>
                            Compétences
                            <fieldset class="repeating_competences">
                                <div>
                                    <input type="text" class="page-text-competence" spellcheck="false"
                                        name="attr_competence" placeholder="Compétence" title="@{competence}"/><br>
                                    <select name="attr_competence_attr" class="page-select" title="@{competence_attr}">
                                        <option value="0">Attribut</option>
                                        <option value="[[@{physique}+@{mod}+@{modenergy}]]">Physique</option>
                                        <option value="@{social}">Social</option>
                                        <option value="[[@{mental}+@{mod}+@{modenergy}]]">Mental</option>
                                    </select>
                                    +
                                    <input type="number" class="page-number-long" name="attr_competence_mod" title="@{competence_mod}">
                                    <!-- On lance un test de compétence en prenant en compte la stat principale + le bonus de compétence + le modificateur de bonus/malus -->
                                    <button type='roll'
                                        value="/me teste sa compétence  @{competence} ! [[1d100cs<5cf>96]] vs: [[@{competence_attr}+@{competence_mod}+@{mod}]]"
                                        name='roll_Comp'></button>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Répétitions de capacites, création de ligne à la volé -->
                        <div class='grid-capacites'>
                            Capacités
                            <fieldset class="repeating_capacites">
                                <div>
                                    <input type="text" class="page-text-capacite" spellcheck="false" name="attr_capacite"
                                        placeholder="Capacité" title="@{capacite}"/><br>
                                        Coût: 
                                    <input type="number" placeholder="0" class="page-number-main"
                                        name="attr_capacite_cout" title="@{capacite_cout}">
                                        Dégâts :
                                    <input type="number" name="attr_capacite_dmgdice" class="page-number-long" placeholder="1" title="@{capacite_dmgdice}">
                                    <select name="attr_capacite_dX" class="page-comp-dX-select" placeholder="type" title="@{capacite_dX}">
                                        <option value="x">d?</option>
                                        <option value="d4">d4</option>
                                        <option value="d6">d6</option>
                                        <option value="d8">d8</option>
                                        <option value="d10">d10</option>
                                        <option value="d12">d12</option>
                                        <option value="d20">d20</option>
                                    </select>
                                    +
                                    <input type="number" name="attr_capacite_mod" class="page-number" placeholder="1" title="@{capacite_mod}">
                                    <!-- On lance la capacité et les dégâts de celle-ci. -->
                                    <button type='roll'
                                        value="/me utilise @{capacite} et inflige [[(@{capacite_dmgdice}@{capacite_dX})+@{capacite_mod}+@{mod}]] !"
                                        name='roll_dmg'></button>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <div class="grid-competences-passiv">
                        Passives <br>
                        <textarea class="textarea.passiv" spellcheck="false" name="attr_competencespassives"
                            placeholder="Passives" title="@{competencespassives}"></textarea>
                    </div>
                </div>
            </div>

            <div class="page-equipement">
                <!-- Equipement -->
                <div class="page-block">
                    <div class="page-head">
                        Équipement
                    </div>
                    <div class="grid-equipement">

                        <!-- Répétitions d'armes, création de ligne à la volé -->
                        <div class="grid-armes">
                            Armes
                            <fieldset class="repeating_armes">
                                <div>
                                    <input type="text" class="page-arme" spellcheck="false" name="attr_arme"
                                        placeholder="Arme" title="@{arme}"/>
                                    <select name="attr_arme_type" class="page-select" title="@{arme_type}">
                                        <option value="none">Type</option>
                                        <option value="perforant">Perforant</option>
                                        <option value="tranchant">Tranchant</option>
                                        <option value="contondant">Contondant</option>
                                    </select>
                                    <input type="number" name="attr_arme_dmgdice" class="page-number-long" placeholder="1" title="@{arme_dmgdice}">
                                    <select name="attr_arme_dX" class="page-comp-dX-select" placeholder="type" title="@{arme_dX}">
                                        <option value="x">d?</option>
                                        <option value="d4">d4</option>
                                        <option value="d6">d6</option>
                                        <option value="d8">d8</option>
                                        <option value="d10">d10</option>
                                        <option value="d12">d12</option>
                                        <option value="d20">d20</option>
                                    </select>
                                    +
                                    <input type="number" class="page-number-long" name="attr_arme_dmgmod" title="@{arme_dmgmod}">

                                    <!-- On affiche le nombre de dégât en prenant en compte les dégâts fixes et le type de dégât en fonction de l'arme -->
                                    <button type='roll'
                                        value='/me inflige [[(@{arme_dmgdice}@{arme_dX})+@{arme_dmgmod}]] de dégâts @{arme_type} avec @{arme} !'
                                        name='roll_dmg'></button>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Répétitions d'armures, création de ligne à la volé -->
                        <div class="grid-armure">
                            Armure
                            <fieldset class="repeating_armure">
                                <div>
                                    <input type="text" class="page-armure" spellcheck="false" name="attr_armure"
                                        placeholder="Armure" title="@{armure}"/><br>
                                        Phys.  
                                    <input type="number" class="page-number-long" name="attr_armure_physique"
                                        placeholder="Phy" title="@{armure_physique}"/>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Répétitions d'équipements, création de ligne à la volé -->
                        <div class="grid-sac">
                            Equipement total (en Kg)
                            <fieldset class="repeating_equipements">
                                <div>
                                    <input type="text" class="page-objet-nom" spellcheck="false" name="attr_equipement"
                                        placeholder="Objet" title="@{equipement}"/><br>
                                        Qté : 
                                    <input type="number" class="page-number-long" spellcheck="false"
                                        name="attr_equipement_nombre" placeholder="Nb" title="@{equipement_nombre}"/>
                                        Poids : 
                                    <input type="number" class="page-number-long" spellcheck="false"
                                        name="attr_equipement_poids" placeholder="Kg" title="@{equipement_poids}"/>
                                </div>
                            </fieldset>

                            <!-- On affiche de poids total, basé sur le script repeatingSum -->
                            Poids total
                            <div>
                                <input type="number" class="page-number-long" spellcheck="false" name="attr_poids_total"
                                    value="0" reacapacitely title="@{poids_total}"/>
                                /
                                <input type="number" class="page-number-long" spellcheck="false"
                                    name="attr_poids_maximum" title="@{poids_maximum}"/>
                            </div>
                        </div>

                        <!-- Champ libre -->
                        <div class="grid-autre">
                            Autres
                            <div>
                                <textarea class="textarea.autres" spellcheck="false" name="attr_autre"
                                    placeholder="Autres" title="@{autre}"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-specialisation">
                <!-- Spécialitées liées aux classes -->
                <div class="page-block">
                    <div class="page-head">
                        Spécialisation
                    </div>
                    <div class="grid-specialisation">
                        <div class="grid-haki">
                            <div class="grid-haki-head">
                                Haki
                            </div>
                            <div class="grid-haki-armement">
                                <span class="span-spe">Armement</span><br>
                            </div>
                            <div class="grid-haki-buso">
                                <input type="checkbox" name="attr_buso" title="@{buso}">
                                Buso
                            </div>
                            <div class="grid-haki-koka">
                                <input type="checkbox" name="attr_koka" title="@{koka}">
                                Koka
                            </div>
                            <div class="grid-haki-ryuo">
                                <input type="checkbox" name="attr_ryuo" title="@{ryuo}">
                                Ryuo
                            </div>

                            <div class="grid-haki-observation">
                                <span class="span-spe">Observation</span><br>
                            </div>
                            <div class="grid-haki-precognition">
                                <input type="checkbox" name="attr_precognition" title="@{precognition}">
                                Précognition
                            </div>
                            <div class="grid-haki-perception">
                                <input type="checkbox" name="attr_perception" title="@{perception}">
                                Perception
                            </div>
                            <div class="grid-haki-prediction">
                                <input type="checkbox" name="attr_prediction" title="@{prediction}">
                                Prédiction
                            </div>

                            <div class="grid-haki-roi">
                                <span class="span-spe">Royal</span><br>
                            </div>
                            <div class="grid-haki-domination">
                                <input type="checkbox" name="attr_domination" title="@{domination}">
                                Domination
                            </div>
                            <div class="grid-haki-neutralisation">
                                <input type="checkbox" name="attr_neutralisation" title="@{neutralisation}">
                                Neutralisation
                            </div>
                            <div class="grid-haki-pression">
                                <input type="checkbox" name="attr_pression" title="@{pression}">
                                Pression
                            </div>
                        </div>

                        <div class="grid-rokushiki">
                            <div class="grid-rokushiki-head">
                                Rokushiki
                            </div>
                            <div class="grid-rokushiki-kamie">
                                <input type="checkbox" name="attr_kamie" title="@{kamie}">
                                Kami-e
                            </div>
                            <div class="grid-rokushiki-geppo">
                                <input type="checkbox" name="attr_geppo" title="@{geppo}">
                                Geppo
                            </div>
                            <div class="grid-rokushiki-rankyaku">
                                <input type="checkbox" name="attr_rankyaku" title="@{rankyaku}">
                                Rankyaku
                            </div>

                            <div class="grid-rokushiki-shigan">
                                <input type="checkbox" name="attr_shigan" title="@{shigan}">
                                Shigan
                            </div>
                            <div class="grid-rokushiki-soru">
                                <input type="checkbox" name="attr_soru" title="@{soru}">
                                Soru
                            </div>
                            <div class="grid-rokushiki-tekkai">
                                <input type="checkbox" name="attr_tekkai" title="@{tekkai}">
                                Tekkai
                            </div>
                        </div>

                        <div class="grid-fruit">
                            <div class="grid-fruit-head">
                                Fruit du démon
                            </div>
                            <div class="grid-fruit-type">
                                Type : 
                                <select name="attr_fruit_type" class="page-select-fruit" title="@{fruit_type}">
                                    <option value="0">Aucun</option>
                                    <option value="@{paraC}">Paramecia corporel</option>
                                    <option value="@{paraM}">Paramecia manipulateur</option>
                                    <option value="@{paraP}">Paramecia productif</option>
                                    <option value="@{zoanN}">Zoan naturel</option>
                                    <option value="@{zoanArt}">Zoan artificiel</option>
                                    <option value="@{zoanAnt}">Zoan antique</option>
                                    <option value="@{zoanM}">Zoan mythique</option>
                                    <option value="@{logiaC}">Logia corporel</option>
                                    <option value="@{logiaI}">Logia intangible</option>
                                </select>
                                Nom : 
                                <input type="text" class="fruit-text-name" spellcheck="false" name="attr_fruit" placeholder="Fruit" title="@{fruit}"/><br>
                                Éveil : 
                                <input type="checkbox" name="attr_eveil" title="@{eveil}">
                            </div>
                            <div class="grid-fruit-faiblesse">
                                Faiblesses : 
                                <input type="text" class="fruit-text" spellcheck="false" name="attr_faiblesse" placeholder="Faiblesse(s)" title="@{faiblesse}"/>
                            </div>
                            <div class="grid-fruit-resistance">
                                Résistances :
                                <input type="text" class="fruit-text" spellcheck="false" name="attr_resistance" placeholder="Résistance(s)" title="@{resistance}"/>
                            </div>
                            <div class="grid-fruit-immunite">
                                Immunités : 
                                <input type="text" class="fruit-text" spellcheck="false" name="attr_immunite" placeholder="Immunité(s)" title="@{immunite}"/>
                            </div>
                        </div>
                    </div>  
                </div>
            </div>
        </div>
        <!-- Active/Desactive l'ajout d'une boite de dialogue pour ajouter des bonus/malus aux jets -->
        <div class="page-options">
            Bonus/malus dans les jets: <input type="checkbox" value="?{Bonus/malus|0}[mod]" name="attr_mod"
                checked="true" title="@{mod}">
        </div>
    </div>
</div>

<div class="ver"> Ver. 1.0 </div><!-- Version format: [Nb de prod].[Modifs post-prod] -->

<!-- Scripts -->
<script type="text/worker">
    //Calcul de la vitesse du personnage basé sur agilite*2
    on('change:agilite', function() {
        getAttrs(['agilite', "vitesse"," vitesse_stock"], function(values) {
            let agilitevalue = parseInt(values.agilite)||0;
    
            setAttrs({     
                vitesse: Math.ceil(agilitevalue * 2),
                vitesse_stock: Math.ceil(agilitevalue * 2)
            });
        });
    });

    //Calcul de la fatigue du personnage basé sur Physique/10+niveau
    on('change:physique', function() {
        getAttrs(['physique', "energy_max", "niveau"], function(values) {
            let physique = parseInt(values.physique)||0;
            let energy = parseInt(values.energy_max)||0;
            let lvl = parseInt(values.niveau)||0;

            energy = Math.ceil(physique / 10) +lvl;
    
            setAttrs({     
                energy_max: energy
            });
        });
    });

    //Calcul du poids max basé sur force*10
    on('change:force', function() {
        getAttrs(['force', "poids_maximum"], function(values) {
            let forceact = parseInt(values.force)||0;
    
            setAttrs({     
                poids_maximum: Math.ceil(forceact * 10)
            });
        });
    });

    //Calcul du nombre de jet de destin basé sur la valeur intuition
    on('change:intuition', function() {
        getAttrs(['intuition', "des_destin"], function(values) {
            let nbdes = parseInt(values.intuition)||0;
            let nbdesactuel = values.des_destin;
            log(nbdes);

            if (nbdesactuel != "") {
                nbdes= nbdesactuel;
            } else {
                nbdes= nbdes;
            }
            setAttrs({     
                des_destin: nbdes
            });
        });
    });

    //Enlève un des de chance perso en cliquant sur le bouton de des
    on('clicked:destinbutton', function() {
        getAttrs(["des_destin"], function(values) {
            let nbdes = parseInt(values.des_destin)||0;

            if (nbdes == 0) {
                nbdes= nbdes;
            } else {
                nbdes= nbdes-1;
            }
            setAttrs({     
                des_destin: nbdes
            });
        });
    });

    //Calcul du poids total
    const repeatingSum = (destinations, section, fields) => {
        if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
        if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
        getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;

            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);

            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
                console.log(output);
                setAttrs(output);
            }); 
        }); 
    };

    //Lignes d'équipement total
    on('change:repeating_equipements remove:repeating_equipements', function() {
        repeatingSum("poids_total","equipements",["equipement_poids","equipement_nombre"]);
    }); 

    //IDs des nouvelles lignes créées à la volée
    on(`page:opened`, function() {
        var newrowattrs = {};
        newrowattrs['code_version'] = 1;
        var newrowid = generateRowID();
        
        newrowid = generateRowID();
        newrowattrs["repeating_competences_" + newrowid + "_competence"] = values.competence;
        newrowattrs["repeating_competences_" + newrowid + "_competence_attr"] = values.competence_attr;
        newrowattrs["repeating_competences_" + newrowid + "_competence_mod"] = values.competence_mod;

        newrowid = generateRowID();
        newrowattrs["repeating_capacites_" + newrowid + "_capacite"] = "values.capacite";
        newrowattrs["repeating_capacites_" + newrowid + "_capacite_cout"] = "values.capacite_cout";
        newrowattrs["repeating_capacites_" + newrowid + "_capacite_dmgdice"] = "values.capacite_dmgdice";
        newrowattrs["repeating_capacites_" + newrowid + "_capacite_dX"] = "values.capacite_dX";

        newrowid = generateRowID();
        newrowattrs["repeating_armes_" + newrowid + "_arme"] = "values.arme";
        newrowattrs["repeating_armes_" + newrowid + "_arme_type"] = "values.arme_type";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dmgdice"] = "values.arme_dmgdice";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dX"] = "values.arme_dX";
        newrowattrs["repeating_armes_" + newrowid + "_arme_dmgmod"] = "values.arme_dmgmod";
                
        newrowid = generateRowID();
        newrowattrs["repeating_armure_" + newrowid + "_armure"] = "values.armure";
        newrowattrs["repeating_armure_" + newrowid + "_armure_physique"] = "values.armure_physique";

        newrowid = generateRowID();
        newrowattrs["repeating_equipements_" + newrowid + "_equipement"] = "values._equipement";
        newrowattrs["repeating_equipements_" + newrowid + "_equipement_nombre"] = "values.equipement_nombre";
        newrowattrs["repeating_equipements_" + newrowid + "_equipement_poids"] = "values.equipement_poids";

        setAttrs(newrowattrs);
    });

    //Diminue la vitesse de 30% en cas d'exédent de poids de 30% (+0-25%), puis 60% en cas de surcharge (+25-50%) et enfin met à 0 si le poids est trop lourd (+50%)
    on('change:poids_total change:poids_maximum change:repeating_equipements remove:repeating_equipements', function() {
        getAttrs(['poids_total',"poids_maximum","vitesse","vitesse_stock"], function(values) {
            let poidstotal = parseInt(values.poids_total)||0;
            let poidsmax = parseInt(values.poids_maximum)||0;
            let vitessemax = parseInt(values.vitesse_stock)||0;

            let poids25 = Math.floor(values.poids_maximum * 1.25);
            let poids50 = Math.floor(values.poids_maximum * 1.5);

            if (values.poids_total > values.poids_maximum) {
                if (values.poids_total <= poids25) {
                    setAttrs({     
                        vitesse: Math.ceil(vitessemax * 0.70)
                    });
                } else {
                    if (values.poids_total <= poids50) {
                        setAttrs({
                            vitesse: Math.ceil(vitessemax * 0.40)
                        });
                    } else {
                        setAttrs({     
                            vitesse: 0
                        });
                    }
                }
            } else {
                setAttrs({     
                    vitesse: vitessemax
                });
            }
        });
    });

    //Gestion des tabs globales
    const buttonlist = ["competences","equipement","specialisation"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                pageTab: button
            });
        });
    });
</script>