<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="main" />
<input type="hidden" name="attr_current_path_layout" value="freeform">
<input type="hidden" name="attr_hide_resources_toggle" value="0" />
	<div class="sheet-container">
	    <div class="sheet-notebook-tabs">
			<button type="action" name="act_main" class="sheet-notebook-tab sheet-button0">Main</button>
            <button type="action" name="act_notes" class="sheet-notebook-tab sheet-button1">Notes</button>
            <button type="action" name="act_settings" class="sheet-notebook-tab sheet-button2 settings-tab">
				<span class="gear-icon"></span>
            </button>
        </div>
		<div class="sheet-main">
			<div class="top-row">
				<div class="name-section">
					<div class="name-section-header"></div>
					<div class="name-section-content">
						<div class="name-left-side">
							<div class="name-top-fields">
								<div class="name-field-group">
									<div class="name-field-label">NAME</div>
									<input type="text" class="name-text-input-main" name="attr_character_name" placeholder="">
								</div>
							</div>
							
							<div class="name-bottom-fields">
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PATH</div>
									<input type="text" class="name-text-input" name="attr_player_name" placeholder="">
								</div>
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PLAYER</div>
									<input type="text" class="name-text-input" name="attr_second" placeholder="">
								</div>
							</div>
						</div>
						
						<div class="name-right-side">
							<div class="name-field-group">
								<div class="name-field-label">DISTINCTIVE FEATURES</div>
								<textarea class="name-text-area" name="attr_distinctive_features" placeholder=""></textarea>
							</div>
						</div>
					</div>            
				</div>
				<div class="logo-section">
					<img src="https://imgur.com/KKRe2oc.jpg" alt="Grimwild Logo" class="grimwild-logo">
				</div>
			</div>
			<div class="main-content">
				<div class="left-column">
					<div class="stats-section">
						<div class="stats-content">
							<div class="stats-row">
								<div class="stat-group">
									<button type="action" name="act_roll_brawn" class="stat-name">Brawn</button>
									<div class="stat-container">
										<div class="stat-square">
											<input type="text" name="attr_brawn" class="stat-input" />
										</div>
										<div class="stat-diamond">
											<input type="checkbox" name="attr_brawn_marked" />
										</div>
									</div>
								</div>
								<div class="stat-group">
									<button type="action" name="act_roll_agility" class="stat-name">Agility</button>
									<div class="stat-container">
										<div class="stat-square">
											<input type="text" name="attr_agility" class="stat-input" />
										</div>
										<div class="stat-diamond">
											<input type="checkbox" name="attr_agility_marked" />
										</div>
									</div>
								</div>
								<div class="stat-group">
									<button type="action" name="act_roll_wits" class="stat-name">Wits</button>
									<div class="stat-container">
										<div class="stat-square">
											<input type="text" name="attr_wits" class="stat-input" />
										</div>
										<div class="stat-diamond">
											<input type="checkbox" name="attr_wits_marked" />
										</div>
									</div>
								</div>
								<div class="stat-group">
									<button type="action" name="act_roll_presence" class="stat-name">Presence</button>
									<div class="stat-container">
										<div class="stat-square">
											<input type="text" name="attr_presence" class="stat-input" />
										</div>
										<div class="stat-diamond">
											<input type="checkbox" name="attr_presence_marked" />
										</div>
									</div>
								</div>
							</div>
							<div class="conditions-section">
								<div class="conditions-row">
									<div class="condition-group">
										<div class="condition-diamond">
											<input type="checkbox" name="attr_bloodied" />
										</div>
										<div class="condition-label">BLOODIED</div>
									</div>
									<div class="condition-group">
										<div class="condition-diamond">
											<input type="checkbox" name="attr_rattled" />
										</div>
										<div class="condition-label">RATTLED</div>
									</div>
								</div>
								<button type="action" name="act_roll_dropped" class="dropped-button">DROPPED</button>
							</div>

							<div class="bottom-controls">
								<div class="control-group">
									<div class="control-label">Add Thorns</div>
									<div class="increment-control">
										<button type="action" name="act_thorns_decrement" class="increment-btn">−</button>
										<span name="attr_thorns" class="increment-display"></span>
										<input type="hidden" name="attr_thorns" value="0">
										<button type="action" name="act_thorns_increment" class="increment-btn">+</button>
									</div>
								</div>
							
								<div class="control-group">
									<div class="control-label">Use Spark</div>
									<div class="spark-checkboxes">
										<div class="spark-checkbox-counter-style spark-use-only">
											<input type="checkbox" name="attr_using_spark_1" />
											<button type="action" name="act_using_spark_1_manual" class="spark-checkbox-overlay"></button>
										</div>
										<div class="spark-checkbox-counter-style spark-use-only">
											<input type="checkbox" name="attr_using_spark_2" />
											<button type="action" name="act_using_spark_2_manual" class="spark-checkbox-overlay"></button>
										</div>
									</div>
									<input type="hidden" name="attr_show_no_spark_message" value="0">
									<div class="no-spark-message">You have no Spark to use</div>
								</div>
							
								<div class="control-group">
									<div class="control-label">Add Dice</div>
									<div class="increment-control">
										<button type="action" name="act_extra_dice_decrement" class="increment-btn">−</button>
										<span name="attr_extra_dice" class="increment-display">0</span>
										<input type="hidden" name="attr_extra_dice" value="0">
										<button type="action" name="act_extra_dice_increment" class="increment-btn">+</button>
									</div>
								</div>
							</div>
						</div>
						<div class="stats-conditions-overlay"></div> 
					</div>

					<div class="character-details">
						<div class="section-header">
							CHARACTER DETAILS
							<div class="header-instruction">INTRODUCE A TANGLE: TAKE SPARK</div>
						</div>
						
						<div class="section-content">
							<div class="field-group">
								<div class="backgrounds-wises-header">
									<div class="backgrounds-column">BACKGROUNDS</div>
									<div class="wises-column">WISES</div>
								</div>

								<div class="backgrounds-wises-list">
									<div class="backgrounds-wises-row">
										<div class="backgrounds-cell">
											<textarea class="backgrounds-input" name="attr_background_1" placeholder=""></textarea>
										</div>
										<div class="wises-cell">
											<textarea class="wises-input" name="attr_wise_1" placeholder=""></textarea>
										</div>
									</div>
									<div class="backgrounds-wises-row">
										<div class="backgrounds-cell">
											<textarea class="backgrounds-input" name="attr_background_2" placeholder=""></textarea>
										</div>
										<div class="wises-cell">
											<textarea class="wises-input" name="attr_wise_2" placeholder=""></textarea>
										</div>
									</div>
								</div>
							</div>
							<div class="traits-section">
								<div class="trait-header">TRAITS:&nbsp 2 you are (●)  &nbsp|&nbsp  1 you're really not (×)</div>
								<div class="trait-grid">
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_brave" class="trait-button">
											<div class="trait-checkbox" data-trait="brave"></div>
											<span>Brave</span>
										</button>
										<input type="hidden" name="attr_trait_brave" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_gentle" class="trait-button">
											<div class="trait-checkbox" data-trait="gentle"></div>
											<span>Gentle</span>
										</button>
										<input type="hidden" name="attr_trait_gentle" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_protective" class="trait-button">
											<div class="trait-checkbox" data-trait="protective"></div>
											<span>Protective</span>
										</button>
										<input type="hidden" name="attr_trait_protective" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_caring" class="trait-button">
											<div class="trait-checkbox" data-trait="caring"></div>
											<span>Caring</span>
										</button>
										<input type="hidden" name="attr_trait_caring" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_honest" class="trait-button">
											<div class="trait-checkbox" data-trait="honest"></div>
											<span>Honest</span>
										</button>
										<input type="hidden" name="attr_trait_honest" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_quiet" class="trait-button">
											<div class="trait-checkbox" data-trait="quiet"></div>
											<span>Quiet</span>
										</button>
										<input type="hidden" name="attr_trait_quiet" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_confident" class="trait-button">
											<div class="trait-checkbox" data-trait="confident"></div>
											<span>Confident</span>
										</button>
										<input type="hidden" name="attr_trait_confident" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_honorable" class="trait-button">
											<div class="trait-checkbox" data-trait="honorable"></div>
											<span>Honorable</span>
										</button>
										<input type="hidden" name="attr_trait_honorable" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_rash" class="trait-button">
											<div class="trait-checkbox" data-trait="rash"></div>
											<span>Rash</span>
										</button>
										<input type="hidden" name="attr_trait_rash" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_curious" class="trait-button">
											<div class="trait-checkbox" data-trait="curious"></div>
											<span>Curious</span>
										</button>
										<input type="hidden" name="attr_trait_curious" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_persistent" class="trait-button">
											<div class="trait-checkbox" data-trait="persistent"></div>
											<span>Persistent</span>
										</button>
										<input type="hidden" name="attr_trait_persistent" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_trait_stubborn" class="trait-button">
											<div class="trait-checkbox" data-trait="stubborn"></div>
											<span>Stubborn</span>
										</button>
										<input type="hidden" name="attr_trait_stubborn" value="0" class="trait-value">
									</div>
								</div>
								
								<div class="custom-trait">
									<div class="trait-item" style="margin-right: 10px;">
										<button type="action" name="act_cycle_trait_custom" class="trait-button">
											<div class="trait-checkbox" data-trait="custom"></div>
										</button>
										<input type="hidden" name="attr_trait_custom_state" value="0" class="trait-value">
									</div>
									<input type="text" name="attr_trait_custom" placeholder="">
								</div>

								<div class="trait-header" style="margin-top: 20px;">DESIRES: 2 you want (●)  &nbsp|&nbsp  1 you really don't (×)</div>
								<div class="trait-grid">
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_belonging" class="trait-button">
											<div class="trait-checkbox" data-trait="belonging"></div>
											<span>Belonging</span>
										</button>
										<input type="hidden" name="attr_desire_belonging" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_justice" class="trait-button">
											<div class="trait-checkbox" data-trait="justice"></div>
											<span>Justice</span>
										</button>
										<input type="hidden" name="attr_desire_justice" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_renown" class="trait-button">
											<div class="trait-checkbox" data-trait="renown"></div>
											<span>Renown</span>
										</button>
										<input type="hidden" name="attr_desire_renown" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_glory" class="trait-button">
											<div class="trait-checkbox" data-trait="glory"></div>
											<span>Glory</span>
										</button>
										<input type="hidden" name="attr_desire_glory" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_knowledge" class="trait-button">
											<div class="trait-checkbox" data-trait="knowledge"></div>
											<span>Knowledge</span>
										</button>
										<input type="hidden" name="attr_desire_knowledge" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_thrills" class="trait-button">
											<div class="trait-checkbox" data-trait="thrills"></div>
											<span>Thrills</span>
										</button>
										<input type="hidden" name="attr_desire_thrills" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_harmony" class="trait-button">
											<div class="trait-checkbox" data-trait="harmony"></div>
											<span>Harmony</span>
										</button>
										<input type="hidden" name="attr_desire_harmony" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_love" class="trait-button">
											<div class="trait-checkbox" data-trait="love"></div>
											<span>Love</span>
										</button>
										<input type="hidden" name="attr_desire_love" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_wealth" class="trait-button">
											<div class="trait-checkbox" data-trait="wealth"></div>
											<span>Wealth</span>
										</button>
										<input type="hidden" name="attr_desire_wealth" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_honor" class="trait-button">
											<div class="trait-checkbox" data-trait="honor"></div>
											<span>Honor</span>
										</button>
										<input type="hidden" name="attr_desire_honor" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_power" class="trait-button">
											<div class="trait-checkbox" data-trait="power"></div>
											<span>Power</span>
										</button>
										<input type="hidden" name="attr_desire_power" value="0" class="trait-value">
									</div>
									
									<div class="trait-item">
										<button type="action" name="act_cycle_desire_wisdom" class="trait-button">
											<div class="trait-checkbox" data-trait="wisdom"></div>
											<span>Wisdom</span>
										</button>
										<input type="hidden" name="attr_desire_wisdom" value="0" class="trait-value">
									</div>
								</div>
								
								<div class="custom-trait">
									<div class="trait-item" style="margin-right: 10px;">
										<button type="action" name="act_cycle_desire_custom" class="trait-button">
											<div class="trait-checkbox" data-trait="custom_desire"></div>
										</button>
										<input type="hidden" name="attr_desire_custom_state" value="0" class="trait-value">
									</div>
									<input type="text" name="attr_desire_custom" placeholder="">
								</div>
							</div>
						</div>
					</div>

					<div class="bonds-section">
						<div class="section-header">
							BONDS
							<div class="header-instruction">CHANGE A BOND: THE OTHER PC TAKES SPARK <br> QUARREL: BOTH TAKE SPARK</div>
						</div>
						
						<div class="section-content">
							<div class="bonds-header">
								<div class="pc-column">PC</div>
								<div class="bond-column">&emsp;&emsp;BOND</div>
							</div>
							
							<div class="bonds-list">
								<div class="bond-row">
									<div class="pc-cell">
										<textarea class="pc-input" name="attr_bond_pc_1" placeholder=""></textarea>
									</div>
									<div class="bond-cell">
										<textarea class="bond-input" name="attr_bond_1" placeholder=""></textarea>
									</div>
								</div>
								<div class="bond-row">
									<div class="pc-cell">
										<textarea class="pc-input" name="attr_bond_pc_2" placeholder=""></textarea>
									</div>
									<div class="bond-cell">
										<textarea class="bond-input" name="attr_bond_2" placeholder=""></textarea>
									</div>
								</div>
								<div class="bond-row">
									<div class="pc-cell">
										<textarea class="pc-input" name="attr_bond_pc_3" placeholder=""></textarea>
									</div>
									<div class="bond-cell">
										<textarea class="bond-input" name="attr_bond_3" placeholder=""></textarea>
									</div>
								</div>
								<div class="bond-row">
									<div class="pc-cell">
										<textarea class="pc-input" name="attr_bond_pc_4" placeholder=""></textarea>
									</div>
									<div class="bond-cell">
										<textarea class="bond-input" name="attr_bond_4" placeholder=""></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="right-column">
					<div class="conditions-notes">
						<div class="conditions-notes-header">
							CONDITIONS & WOUNDS
							<div class="header-instruction">MARK: +1t, THEN CLEAR<br>HARM: +1t TO ALL ROLLS</div>
						</div>
						<div class="conditions-notes-content">
							<textarea name="attr_conditions_notes" class="notes-textarea" placeholder=""></textarea>
							<div class="vex-text"><b>VEX:</b> FIGHT&nbsp;—&nbsp;FLIGHT&nbsp;—&nbsp;FREEZE&nbsp;—&nbsp;FREAKOUT</div>
						</div>
					</div>

					<div class="pool-section">
						<div class="pool-group-left">
							 <div class="pool-label"></div>
							 <button type="action" name="act_assist" class="roll-button">ASSIST</button>
						</div>
						<div class="pool-group-mid">
							<div class="pool-label">BUILD POOL</div>
							<div class="increment-control">
								<button type="action" name="act_pool_decrement" class="increment-btn">−</button>
								<span name="attr_pool_value" class="increment-display">0</span>
								<input type="hidden" name="attr_pool_value" value="0">
								<button type="action" name="act_pool_increment" class="increment-btn">+</button>
							</div>
						</div>
						<div class="pool-group-right">
							 <div class="pool-label"></div>
							 <button type="action" name="act_roll_pool" class="roll-button">ROLL POOL</button>
						</div>
					</div>

					<div class="counters-section">
						<div class="counter-group">
							<button type="action" name="act_toggle_spark" class="counter-name spark-button">SPARK</button>
							<div class="counter-boxes">
								<div class="counter-box">
									<input type="checkbox" name="attr_spark1" />
								</div>
								<div class="counter-box">
									<input type="checkbox" name="attr_spark2" />
								</div>
							</div>
						</div>
						<div class="counter-group">
							<span class="counter-name">STORY</span>
							<div class="counter-boxes">
								<div class="counter-box">
									<input type="checkbox" name="attr_story1" />
								</div>
								<div class="counter-box">
									<input type="checkbox" name="attr_story2" />
								</div>
							</div>
						</div>
						<div class="counter-button">
						   <button type="action" name="act_roll_story" class="roll-button">Story Roll</button>
						</div>
					</div>
	   
					<div class="adventurer-section">
						<div class="section-header">
							TALENTS
						</div>
						
						<div class="section-content">
							<div class="subsection">
								<div class="subsection-header">
									<span class="core-talent-heading-default">CORE TALENT</span>
									<span class="core-talent-heading-fighter">CORE TALENT | FIGHTER</span>
									<span class="core-talent-heading-rogue">CORE TALENT | ROGUE</span>
									<span class="core-talent-heading-bard">CORE TALENT | BARD</span>
									<span class="core-talent-heading-wizard">CORE TALENT | WIZARD</span>
									<span class="core-talent-heading-berserker">CORE TALENT | BERSERKER</span>
									<span class="core-talent-heading-cleric">CORE TALENT | CLERIC</span>
									<span class="core-talent-heading-druid">CORE TALENT | DRUID</span>
									<span class="core-talent-heading-ranger">CORE TALENT | RANGER</span>
									<span class="core-talent-heading-monk">CORE TALENT | MONK</span>
									<span class="core-talent-heading-paladin">CORE TALENT | PALADIN</span>
									<span class="core-talent-heading-sorcerer">CORE TALENT | SORCERER</span>
									<span class="core-talent-heading-warlock">CORE TALENT | WARLOCK</span>
									<div class="talent-container">
										<input type="hidden" name="attr_core_talent_resize_unlocked" value="false">
										<button type="action" name="act_toggle_core_talent_resize" class="resize-toggle-btn" title="Toggle resize mode"></button>
									</div>
								</div>
								<div class="subsection-content">
									<div class="core-talent-layout freeform-layout">
										<textarea class="core-talent-area" name="attr_core_talent" placeholder="CORE TALENT NAME&#10;Core talent description. &#10;&#10;INSTRUCTIONS: First line automatically formats as a heading. Save by clicking out of the box. Reopen editor by clicking the text. Lock toggles free resizing. Alternatively, enter one of the twelve Grimwild Paths above to autopopulate this section."></textarea>
									</div>
									
										<div class="core-talent-layout fighter-mastery-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">WEAPON MASTERY</div>
														<div class="fighter-talent-description">
															Choose a fighting style that you have mastered: <em>brawling—dual-wielding—one-handed weapons—ranged weapons—thrown weapons—two-handed weapons</em>. You have a <strong>mastery die</strong>, a special d6. When you fight in your style, take +1d (<em>the mastery die</em>) on the roll. If the mastery die is a 6, it counts as a critical. If it's already a critical, <strong>take spark</strong>.
															<br><br>
															<strong>GROWTH:</strong> Every 3 levels, your mastery die increases by +1d.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">FIGHTING STYLE</div>
														<select name="attr_fighter_style" class="fighter-style-select">
															<option value="">[Select Here]</option>
															<option value="brawling">Brawling</option>
															<option value="dual-wielding">Dual-Wielding</option>
															<option value="one-handed">One-Handed</option>
															<option value="ranged">Ranged Weapons</option>
															<option value="thrown">Thrown Weapons</option>
															<option value="two-handed">Two-Handed</option>
														</select>
													</div>
																										
													<div class="fighter-control-group">
														<div class="fighter-control-label">MASTERY DIE</div>
														<div class="fighter-mastery-controls">
															<div class="fighter-mastery-row">
																<input type="hidden" name="attr_fighter_mastery_dice_count" value="1">
																<button type="action" name="act_toggle_mastery_dice" class="fighter-dice-toggle">
																	<span class="dice-count-1">+1d</span>
																	<span class="dice-count-2">+2d</span>
																	<span class="dice-count-3">+3d</span>
																</button>
																<div class="fighter-mastery-checkbox">
																	<input type="checkbox" name="attr_fighter_mastery_active">
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="core-talent-layout rogue-expertise-layout" style="display: none;">
											<div class="fighter-talent-text-wrapper">
												<div class="fighter-talent-title">EXPERTISE</div>
												<div class="fighter-talent-description">
													Choose a skillset below as your expertise. Each session, you have a <strong><em>3d Contingency</em></strong> resource pool, always planning ahead. You can roll the pool as bonus dice after any roll that falls within your expertise.
												</div>
													<input type="hidden" name="attr_skullduggery_active" value="0">
													<input type="hidden" name="attr_assassination_active" value="0">

													<div class="rogue-expertise-options">
														<div class="rogue-expertise-option">
															<input type="radio" name="attr_rogue_expertise" value="assassination" class="rogue-expertise-radio">
															<button type="action" name="act_select_assassination" class="rogue-expertise-button">
																<div class="rogue-expertise-name"><em>Assassination</em></div>
																<div class="rogue-expertise-desc">Take +1d at stealth, tracking people, opening strikes, and disguises.</div>
															</button>
														</div>
														
														<div class="rogue-expertise-option">
														<input type="radio" name="attr_rogue_expertise" value="skullduggery" class="rogue-expertise-radio">
															<button type="action" name="act_select_skullduggery" class="rogue-expertise-button">
																<div class="rogue-expertise-name"><em>Skullduggery</em></div>
																<div class="rogue-expertise-desc">Take +1d at stealth, picking locks, lying, and sleight of hand.</div>
															</button>
														</div>
													</div>
												<div class="fighter-talent-description" style="margin-top: 8px;">
													<strong>GROWTH:</strong> Every 2 levels, increase Contingency by 1d.
												</div>
											</div>
										</div>
										<div class="core-talent-layout bard-song-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">BARDSONG</div>
														<div class="fighter-talent-description">
															Each session, you can sing <strong>3 bardsongs</strong>. Sing one to pull off a <strong><em>potent feat of emotional influence</em></strong> (like eliciting <em>a vex response in an NPC</em>, <em>buffing a group of allies</em>, or <em>inflicting hindrances on enemies</em>) or to <strong><em>interrupt</em></strong> an impact move. Choose a <strong><em>style</em></strong>, <strong><em>tune</em></strong>, and <strong><em>impact</em></strong> and roll Presence. Each session, you can also sing <strong>3 melodies</strong>, spur of the moment tunes without specific composition. Spend them to: <em>assist without risk</em>—<em>calm or intensify a vex response</em>—<em>clear a mark</em>. These don't require a roll. You cannot affect yourself.
															<br><br>
															<strong>GROWTH:</strong> Every 3 levels, +1 bardsong and melody per session.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">BARDSONGS</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_bardsong_1">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_bardsong_2">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_bardsong_3">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_bardsong_4">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_bardsong_5">
															</div>
														</div>
													</div>
													
													<div class="fighter-control-group">
														<div class="fighter-control-label">MELODIES</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_melody_1">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_melody_2">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_melody_3">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_melody_4">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_melody_5">
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="core-talent-layout wizard-spellcraft-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">SPELLCRAFT</div>
														<div class="fighter-talent-description">
															You have spellcasting ability. You roll Wits to cast and a <strong>spell theorem</strong> serves as the touchstone. You know 4 spell theorems inscribed in a spellbook. Each session, you can cast 4 <strong><em>spells</em></strong> and 2 <strong><em>potent spells</em></strong> from your theorems. You can learn new spell theorems from studying and experimenting with scrolls.
															<br><br>
															<strong>GROWTH:</strong> Every 2 levels, +1 spell and potent spell cast per session and a new spell theorem.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">SPELLS</div>
														<div class="wizard-spell-grid">
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-primary wizard-tracker-top-left">
																	<input type="checkbox" name="attr_wizard_spell_1">
																</div>
																<div class="bard-tracker-box bard-tracker-primary">
																	<input type="checkbox" name="attr_wizard_spell_2">
																</div>
																<div class="bard-tracker-box bard-tracker-primary">
																	<input type="checkbox" name="attr_wizard_spell_3">
																</div>
																<div class="bard-tracker-box bard-tracker-primary wizard-tracker-top-right">
																	<input type="checkbox" name="attr_wizard_spell_4">
																</div>
															</div>
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-left">
																	<input type="checkbox" name="attr_wizard_spell_5">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-middle">
																	<input type="checkbox" name="attr_wizard_spell_6">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-right">
																	<input type="checkbox" name="attr_wizard_spell_7">
																</div>
															</div>
														</div>
													</div>
													
													<div class="fighter-control-group">
														<div class="fighter-control-label">POTENT SPELLS</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_wizard_potent_1">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_wizard_potent_2">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_wizard_potent_3">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_wizard_potent_4">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_wizard_potent_5">
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="core-talent-layout berserker-frenzy-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">FRENZY</div>
														<div class="fighter-talent-description">
															Once per session, or when you get bloodied or vexed, you can enter a <strong>frenzy</strong> for a scene. During a frenzy, you can only take aggressive actions. Calm down only when <em>no challenger stands before you</em>, you get dropped, or you <strong>push yourself</strong>. Effects:<br>
															◆ Take +1d for each mark and ignore all harm and mark thorns.<br>
															◆ Inflict <em>collateral damage</em> on each action roll, regardless of the outcome. You must choose one: <em>send something flying</em>—<em>smash mooks</em>—<em>throw insults</em>—<em>wreck something</em>.<br>
															◆ Get a final action when dropped. Ignore dropped on a crit.
															<br><br>
															<strong>GROWTH:</strong> Every 3 levels, +1 free frenzy activation per session.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<input type="hidden" name="attr_berserker_frenzy_active" value="0">
															<button type="action" name="act_toggle_berserker_frenzy" class="berserker-frenzy-toggle">
																<span class="frenzy-text-inactive">ENTER A <span style= 'font-weight: 900'>FRENZY</span></span>
																<span class="frenzy-text-active">CALM DOWN</span>
															</button>
													</div>
													<div class="fighter-control-group berserker-uses-group">
														<div class="fighter-control-label">FREE USES</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_berserker_frenzy_1">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_berserker_frenzy_2">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_berserker_frenzy_3">
															</div>
														</div>
													</div>
													
												</div>
											</div>
										</div>
										<div class="core-talent-layout cleric-divinity-layout" style="display: none;">
											<div class="fighter-talent-text-wrapper">
												<div class="fighter-talent-title">CHANNEL DIVINITY</div>
												<div class="fighter-talent-description">
													Your god grants you spellcasting ability. You roll a domain pool to cast and that domain pool and your god's epithet serve as touchstones. You have <strong>1 major domain</strong>, a 6d power pool, and <strong>2 minor domains</strong>, each a 4d power pool. These pools replenish each session. You can drop 1d and roll the domain to cast a <strong><em>potent spell</em></strong>.
												</div>
												
												<div class="cleric-divinity-god-group">
													<div class="cleric-god-label"><em>You draw power from</em></div>
														<input type="text" class="cleric-god-input" name="attr_cleric_god" placeholder="[Your God's Name and Epithet]">
												</div>
												
												<div class="fighter-talent-description" style="margin-top: 8px;">
													<strong>GROWTH:</strong> Every 2 levels, increase one domain pool by 1d (max 8d).
												</div>
											</div>
										</div>
										<div class="core-talent-layout druid-wildshape-layout" style="display: none;">
											<div class="fighter-talent-text-wrapper">
												<div class="fighter-talent-title">WILD SHAPE</div>
												<div class="fighter-talent-description">
													Shift into any familiar beast form, rolling a 4d <strong>Wild Shape</strong> pool that replenishes after each scene. You take on the form's physical qualities and feral instincts, moving stat points to represent this (<em>min 1, max 3</em>). While using Wild Shape, you lose access to any talent related to your physical form. Drop 1d for each <strong><em>wild talent</em></strong> (max 2) a form has. These include things like <em>aquatic, smaller than a cat, bigger than a bear, venomous, and flight</em>—as well as talents from a path or heritage.
													<br><br>
													<strong>GROWTH:</strong> Every 2 levels, increase your Wild Shape pool by 1d.
												</div>
											</div>
										</div>
										<div class="core-talent-layout ranger-huntersmark-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">HUNTER'S MARK</div>
														<div class="fighter-talent-description">
															Twice per session, you can declare a weakness in a non-humanoid creature. Describe what you know or see, tagging it with a <strong><em>2d Weakness</em></strong> pool. When anyone targets the weakness specifically, roll the pool as bonus dice on their roll. As it depletes, the creature learns to hide its weakness, causing it to shift its behavior. <strong>Take spark</strong> when any Weakness die rolls a perfect (not the overall result). 
															<br><br>
															<strong>GROWTH:</strong> Every 2 levels, +1 use of Hunter's Mark per session.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">WEAKNESS</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_ranger_weakness_1">
															</div>
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_ranger_weakness_2">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_ranger_weakness_3">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_ranger_weakness_4">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_ranger_weakness_5">
															</div>
														</div>
													</div>
													<div class="fighter-control-group">
												<input type="hidden" name="attr_prowess_active" value="0">
												<button type="action" name="act_toggle_prowess" class="prowess-button">
													<div class="prowess-name"><em>Prowess</em></div>
													<div class="prowess-desc">+1d at stealth, traversal, setting traps, and tracking</div>
												</button>
											</div>
												</div>
											</div>
											<input type="hidden" name="attr_rogue_expertise_active" value="0">
										</div>
										<div class="core-talent-layout monk-discipline-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">DISCIPLINE</div>
														<div class="fighter-talent-description">
															You never suffer thorns due to weapon matchups. Once per session, you can <strong><em>interrupt</em></strong> with a: <em>philosophical point—quick reaction—stunning strike</em>. Each scene, you have <strong>4 flow</strong>. You can spend it to:<br>
															◆ Ignore difficulty thorns from: <em>being outnumbered—a single powerful opponent</em>.<br>
															◆ Attempt a <strong>fluid maneuver</strong>. Before rolling, declare you want to also: <em>disarm them—redirect momentum—reposition you, them, or both</em>. On a perfect or messy, it happens.<br>
															◆ Pull off a <strong><em>potent feat of mystical grace</em></strong>, like <em>running across water</em> or <em>falling harmlessly from a great height</em>. For 1 <em>more flow</em>, extend this to those you're touching.
															<br><br>
															<strong>GROWTH:</strong> Every 3 levels, +1 flow and interrupts per refresh.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">FLOW</div>
														<div class="wizard-spell-grid">
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-primary wizard-tracker-top-left">
																	<input type="checkbox" name="attr_monk_flow_1">
																</div>
																<div class="bard-tracker-box bard-tracker-primary">
																	<input type="checkbox" name="attr_monk_flow_2">
																</div>
																<div class="bard-tracker-box bard-tracker-primary">
																	<input type="checkbox" name="attr_monk_flow_3">
																</div>
																<div class="bard-tracker-box bard-tracker-primary wizard-tracker-top-right">
																	<input type="checkbox" name="attr_monk_flow_4">
																</div>
															</div>
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-left">
																	<input type="checkbox" name="attr_monk_flow_5">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-middle">
																	<input type="checkbox" name="attr_monk_flow_6">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary wizard-tracker-bottom-right">
																	<input type="checkbox" name="attr_monk_flow_7">
																</div>
															</div>
														</div>
													</div>
													
													<div class="fighter-control-group">
														<div class="fighter-control-label">INTERRUPTS</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_monk_interrupt_1">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_monk_interrupt_2">
															</div>
															<div class="bard-tracker-box bard-tracker-secondary">
																<input type="checkbox" name="attr_monk_interrupt_3">
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="core-talent-layout sorcerer-sorcery-layout" style="display: none;">
											<div class="fighter-talent-text-wrapper">
												<div class="fighter-talent-title">SORCERY</div>
												<div class="fighter-talent-description">
													You have spellcasting ability. You roll Presence to cast and your <strong>magic paths</strong> and <strong>techniques</strong> serve as touchstones—you begin with a total of 4. You can cast spells at-will, though they always carry risk and require a roll. You can <strong>push yourself</strong> to cast a <strong><em>potent spell</em></strong>, but gain no free activation of it. When casting, rolling two or more 1s (including thorns) triggers a secondary <strong>wild surge</strong>—raw magic spirals out of your control. <strong><em>Make a 2d story roll</em></strong> to see what happens.
													<br><br>
													<strong>GROWTH:</strong> Every 2 levels, gain a new technique or magic path.
												</div>
											</div>
										</div>
										<div class="core-talent-layout warlock-pact-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">PACT</div>
														<div class="fighter-talent-description">
															Your patron, a powerful otherworldly being you've made a pact with, provides you with <strong>gifts</strong> in exchange for <strong>obligations</strong>. You can cast cantrips with your patron's trappings as touchstones, useful as <em>set dressing</em> and <em>magic utility</em>. Additionally, <strong><em>you gain a bonus talent</em></strong> and each of your talents is infused with your patron's trappings.
															<br><br>
															<strong>Gifts:</strong> Roll 2d at session start. You can replace <strong><em>any</em></strong> rolled d6 with one these results, then erase the Gift.
															<br><br>
															<strong>Obligations:</strong> Your patron has an <strong><em>8d Patience</strong></em> pool. Roll it at session start if your patron isn't satisfied by your service.
															<br><br>
															<strong>GROWTH:</strong> Every 3 levels, +1 talent but -2d max Patience.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">GIFTS</div>
														<div class="warlock-gifts-container">
															<input type="number" class="warlock-gift-input" name="attr_warlock_gift_1" min="1" max="6" placeholder="">
															<input type="number" class="warlock-gift-input" name="attr_warlock_gift_2" min="1" max="6" placeholder="">
														</div>
													</div>
												</div>
											</div>
										</div>
										<div class="core-talent-layout paladin-oath-layout" style="display: none;">
											<div class="fighter-talent-container">
												<div class="fighter-talent-left">
													<div class="fighter-talent-text-wrapper">
														<div class="fighter-talent-title">OATHSWORN</div>
														<div class="fighter-talent-description">
															You draw power from <strong>three sworn tenets</strong>. When a tenet is violated, discuss the toll and take -1 smite. When you atone, <strong>take spark</strong>. You don't take thorns from harm, instead taking +1d on rolls with the related physical or mental stats. Each session, you have <strong>3 smite</strong>. When attacking someone in combat or argument, you can spend it to drop dice from a task pool <strong><em>after</em></strong> rolling it. Each session, as an <strong>affirmation</strong> you can <strong><em>give spark to a player</em></strong> who joined a scene involving your tenets.
															<div class="paladin-oaths-container">
																<div class="paladin-oath-label">YOU HAVE SWORN TO</div>
																<input type="text" class="paladin-oath-input" name="attr_paladin_oath_1" placeholder="1. First Tenet">
																<input type="text" class="paladin-oath-input" name="attr_paladin_oath_2" placeholder="2. Second Tenet">
																<input type="text" class="paladin-oath-input" name="attr_paladin_oath_3" placeholder="3. Third Tenet">
															</div>
															<strong>GROWTH:</strong> Every 2 levels, increase smite by 1.
														</div>
													</div>
												</div>
												
												<div class="fighter-talent-right">
													<div class="fighter-control-group">
														<div class="fighter-control-label">SMITE</div>
														<div class="wizard-spell-grid paladin-smite-grid">
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-primary paladin-tracker-top-left">
																	<input type="checkbox" name="attr_paladin_smite_1">
																</div>
																<div class="bard-tracker-box bard-tracker-primary">
																	<input type="checkbox" name="attr_paladin_smite_2">
																</div>
																<div class="bard-tracker-box bard-tracker-primary paladin-tracker-top-right">
																	<input type="checkbox" name="attr_paladin_smite_3">
																</div>
															</div>
															<div class="wizard-spell-row">
																<div class="bard-tracker-box bard-tracker-secondary paladin-tracker-bottom-left">
																	<input type="checkbox" name="attr_paladin_smite_4">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary">
																	<input type="checkbox" name="attr_paladin_smite_5">
																</div>
																<div class="bard-tracker-box bard-tracker-secondary paladin-tracker-bottom-right">
																	<input type="checkbox" name="attr_paladin_smite_6">
																</div>
															</div>
														</div>
													</div>
													
													<div class="fighter-control-group">
														<div class="fighter-control-label">AFFIRMATION</div>
														<div class="bard-tracker-row">
															<div class="bard-tracker-box bard-tracker-primary">
																<input type="checkbox" name="attr_paladin_affirmation">
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
								</div>
							</div>
							
							<div class="subsection">
								<div class="subsection-header">
									ACQUIRED TALENTS
									<div class="talent-container">
										<input type="hidden" name="attr_acquired_talents_resize_unlocked" value="false">
										<button type="action" name="act_toggle_acquired_talents_resize" class="resize-toggle-btn" title="Toggle resize mode"></button>
									</div>
								</div>
								<div class="subsection-content">
									<fieldset class="repeating_talents">
										<div class="talent-slot-container">
											<input type="checkbox" name="attr_talent_collapsed" class="talent-collapse-checkbox" tabindex="-1">
											<button type="action" name="act_share-talent" class="talent-chat-btn"></button>
											<textarea class="talent-slot" name="attr_talent_text" placeholder="TALENT NAME&#10;Talent description.&#10;&#10;INSTRUCTIONS: First line automatically formats as a heading. Save by clicking out of the box. Reopen editor by clicking the text. Lock toggles free resizing."></textarea>
										</div>
									</fieldset>
								</div>
							</div>
						</div>
					</div>

					<div class="resources-section">
						<div class="section-header">
							RESOURCES
						</div>
						<div class="section-content">
							<fieldset class="repeating_items">
								<div class="items-row">
									<div class="resource-box">
										<input type="text" class="resource-name-input" name="attr_item_1_name" placeholder="Name">
										<div class="resource-count-container">
											<input type="number" class="resource-count-input" name="attr_item_1_count" value="0" min="0">
										</div>
										<input type="text" class="resource-notes-input" name="attr_item_1_notes" placeholder="Notes">
									</div>
									<div class="resource-box">
										<input type="text" class="resource-name-input" name="attr_item_2_name" placeholder="Name">
										<div class="resource-count-container">
											<input type="number" class="resource-count-input" name="attr_item_2_count" value="0" min="0">
										</div>
										<input type="text" class="resource-notes-input" name="attr_item_2_notes" placeholder="Notes">
									</div>
									<div class="resource-box">
										<input type="text" class="resource-name-input" name="attr_item_3_name" placeholder="Name">
										<div class="resource-count-container">
											<input type="number" class="resource-count-input" name="attr_item_3_count" value="0" min="0">
										</div>
										<input type="text" class="resource-notes-input" name="attr_item_3_notes" placeholder="Notes">
									</div>
									<div class="resource-box">
										<input type="text" class="resource-name-input" name="attr_item_4_name" placeholder="Name">
										<div class="resource-count-container">
											<input type="number" class="resource-count-input" name="attr_item_4_count" value="0" min="0">
										</div>
										<input type="text" class="resource-notes-input" name="attr_item_4_notes" placeholder="Notes">
									</div>
								</div>
							</fieldset>
						</div>
					</div>

					<div class="story-experience-row">
						<div class="story-arcs-section">
							<div class="section-header">
								STORY ARCS
								<div class="header-instruction">FINISH/MOVE ON FROM<br> AN ARC: TAKE SPARK</div>
							</div>
							
							<div class="section-content">
								<div class="subsection">
									<div class="subsection-header">GROUP ARC</div>
									<div class="subsection-content">
										<textarea class="arc-area" name="attr_group_arc" placeholder=""></textarea>
									</div>
								</div>
								
								<div class="subsection">
									<div class="subsection-header">CHARACTER ARC</div>
									<div class="subsection-content">
										<textarea class="arc-area" name="attr_character_arc" placeholder=""></textarea>
									</div>
								</div>
							</div>
						</div>

						<div class="experience-section">
							<div class="section-header">
								EXPERIENCE
							</div>
							
							<div class="section-content">
								<div class="xp-instruction">Each session, take 1 XP:</div>
								
								<div class="xp-tracks">
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_1_1" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_1_2" value="1">
											</div>
										</div>
									</div>
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_2_1" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_2_2" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_2_3" value="1">
											</div>
										</div>
									</div>
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_3_1" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_3_2" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_3_3" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_3_4" value="1">
											</div>
										</div>
									</div>
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_4_1" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_4_2" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_4_3" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_4_4" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_4_5" value="1">
											</div>
										</div>
									</div>
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_5_1" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_5_2" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_5_3" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_5_4" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_5_5" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_5_6" value="1">
											</div>
										</div>
									</div>
									<div class="xp-track">
										<div class="checkbox-group">
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_1" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_2" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_3" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_4" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_5" value="1">
											</div>
											<div class="xp-checkbox">
												<input type="checkbox" name="attr_xp_6_6" value="1">
											</div>
											<div class="xp-checkbox plus-box">
												<input type="checkbox" name="attr_xp_6_7" value="1">
											</div>
										</div>
									</div>
								</div>
								
								<div class="talent-instruction">At +, take a new talent.</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="sheet-notes">
			<div class="top-row">
				<div class="name-section">
					<div class="name-section-header"></div>
					<div class="name-section-content">
						<div class="name-left-side">
							<div class="name-top-fields">
								<div class="name-field-group">
									<div class="name-field-label">NAME</div>
									<input type="text" class="name-text-input-main" name="attr_character_name" placeholder="">
								</div>
							</div>
							
							<div class="name-bottom-fields">
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PATH</div>
									<input type="text" class="name-text-input" name="attr_player_name" placeholder="">
								</div>
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PLAYER</div>
									<input type="text" class="name-text-input" name="attr_second" placeholder="">
								</div>
							</div>
						</div>
						
						<div class="name-right-side">
							<div class="name-field-group">
								<div class="name-field-label">DISTINCTIVE FEATURES</div>
								<textarea class="name-text-area" name="attr_distinctive_features" placeholder=""></textarea>
							</div>
						</div>
					</div>            
				</div>
				<div class="logo-section">
					<img src="https://imgur.com/KKRe2oc.jpg" alt="Grimwild Logo" class="grimwild-logo">
				</div>
			</div>
			<div class="main-content">
				<div class="left-column">
					<div class="treasure-section">
						<div class="section-header">TREASURE
							<div class="header-instruction">CAROUSE: MINOR TREASURE FOR PARTY MONTAGE, TAKE SPARK</div>
						</div>
							<div class="section-content">
								<div class="treasure-row">
									<div class="treasure-box">
										<div class="treasure-name">MINOR</div>
										<div class="treasure-count-container">
											<input type="number" class="treasure-count-input" name="attr_treasure_minor" value="0" min="0">
										</div>
									</div>
									<div class="treasure-box">
										<div class="treasure-name">MAJOR</div>
										<div class="treasure-count-container">
											<input type="number" class="treasure-count-input" name="attr_treasure_major" value="0" min="0">
										</div>
									</div>
									<div class="treasure-box">
										<div class="treasure-name">MYTHIC</div>
										<div class="treasure-count-container">
											<input type="number" class="treasure-count-input" name="attr_treasure_mythic" value="0" min="0">
										</div>
									</div>
								</div>
								<div class="subsection-header">
								TREASURE NOTES
								</div>	
									<textarea name="attr_treasure_notes" class="treasure-textarea" placeholder=""></textarea>
							</div>
					</div>
					<div class="arcana-section">
						<div class="section-header">ARCANA</div>
						<div class="section-content">
							<fieldset class="repeating_arcana">
								<div class="arcana-item">
									<div class="arcana-header-row">
										<div class="arcana-name-cell">
											<input type="text" class="arcana-name-input" name="attr_arcana_name" placeholder="Arcana Name">
										</div>
										<div class="arcana-tier-cell">
											<select class="arcana-tier-select" name="attr_arcana_tier">
												<option value="Minor">MINOR</option>
												<option value="Major">MAJOR</option>
												<option value="Mythic">MYTHIC</option>
											</select>
										</div>
									</div>
									<div class="arcana-field-group">
										<textarea class="arcana-description" name="attr_arcana_description" placeholder="Description of the arcana and its effects"></textarea>
									</div>
									
									<div class="arcana-field-group">
										<div class="arcana-field-label">LIMITATIONS</div>
										<textarea class="arcana-textarea" name="attr_arcana_limitations" placeholder="The factors that limit the use of the arcana"></textarea>
									</div>
									
									<div class="arcana-field-group">
										<div class="arcana-field-label">TOUCHSTONES</div>
										<textarea class="arcana-textarea" name="attr_arcana_touchstones" placeholder="E.g., Balance — Refuge — Time"></textarea>
									</div>
								</div>
							</fieldset>
						</div>
					</div>
				</div>	
				<div class="right-column">
					<div class="adventurer-section">
						<div class="section-header">
							SPELLCRAFT
						</div>
						
						<div class="section-content">
							<div class="subsection">
								<div class="subsection-header">
									SOURCE OF SPELLCRAFT
									<div class="spell-container">
										<input type="hidden" name="attr_spell_source_resize_unlocked" value="false">
										<button type="action" name="act_toggle_spell_source_resize" class="resize-toggle-btn" title="Toggle resize mode"></button>
									</div>
								</div>
								<div class="subsection-content">
									<textarea class="spell-source-area" name="attr_spell_source" placeholder="SOURCE&#10;Description. (Examples of sources include Wizardry, Sorcery, Pacts, etc.)"></textarea>
								</div>
							</div>
							
							<div class="subsection">
								<div class="subsection-header">
									SPELLS & TOUCHSTONES
									<div class="spell-container">
										<input type="hidden" name="attr_spells_resize_unlocked" value="false">
										<button type="action" name="act_toggle_spells_resize" class="resize-toggle-btn" title="Toggle resize mode"></button>
									</div>
								</div>
								<div class="subsection-content">
									<fieldset class="repeating_spells">
										<div class="spell-slot-container">
											<input type="checkbox" name="attr_spell_collapsed" class="spell-collapse-checkbox" tabindex="-1">
											<button type="action" name="act_share-spell" class="spell-chat-btn"></button>
											<textarea class="spell-slot" name="attr_spell_text" placeholder="TOUCHSTONES&#10;Description and additional notes."></textarea>
										</div>
									</fieldset>
								</div>
							</div>
						</div>
					</div>
						<div class="pools-section">
							<div class="section-header">POOLS
								<div class="header-instruction">POOL SIZES: 4d|SHORT, 6d|MID, 8d|LONG</div>
							</div>
							<div class="section-content">
								<div class="pools-header">
									<div class="pool-name-column">NAME</div>
									<div class="pool-total-column">TOTAL</div>
									<div class="pool-current-column">
										CURRENT
									</div>
									<div class="pool-power-column">
										POWER
									</div>
									<div class="pool-roll-column">
										ROLL
									</div>
								</div>
								
								<fieldset class="repeating_pools">
									<div class="pool-row">
										<div class="pool-name-cell">
											<input type="text" class="pool-name-input" name="attr_pool_name" placeholder="Custom Pool" maxlength="22">
										</div>
										<div class="pool-total-cell">
											<input type="number" class="pool-number-input" name="attr_pool_total" value="0" min="0" max="8">
										</div>
										<div class="pool-current-cell">
											<input type="number" class="pool-number-input" name="attr_pool_current" value="0" min="0" max="8">
										</div>
										<div class="pool-power-cell">
											<input type="checkbox" class="pool-power-checkbox" name="attr_pool_power">
										</div>
										<div class="pool-roll-cell">
											<button type="action" name="act_roll-custom-pool" class="pool-roll-button">&#x1F3B2;</button>
										</div>
									</div>
								</fieldset>
							</div>
						</div>
				</div>
			
			</div>	
				<div class="notes-section">
					<div class="section-header">GENERAL NOTES</div>
					<div class="section-content">
						<div class="notes-columns">
							<textarea name="attr_full_notes_1" class="notes-column" placeholder=""></textarea>
							<textarea name="attr_full_notes_2" class="notes-column" placeholder=""></textarea>
							<textarea name="attr_full_notes_3" class="notes-column" placeholder=""></textarea>
						</div>
					</div>
				</div>	
        </div>
		<div class="sheet-settings">
			<div class="top-row">
				<div class="name-section">
					<div class="name-section-header"></div>
					<div class="name-section-content">
						<div class="name-left-side">
							<div class="name-top-fields">
								<div class="name-field-group">
									<div class="name-field-label">NAME</div>
									<input type="text" class="name-text-input-main" name="attr_character_name" placeholder="">
								</div>
							</div>
							
							<div class="name-bottom-fields">
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PATH</div>
									<input type="text" class="name-text-input" name="attr_player_name" placeholder="">
								</div>
								<div class="name-field-group name-field-small">
									<div class="name-field-label">PLAYER</div>
									<input type="text" class="name-text-input" name="attr_second" placeholder="">
								</div>
							</div>
						</div>
						
						<div class="name-right-side">
							<div class="name-field-group">
								<div class="name-field-label">DISTINCTIVE FEATURES</div>
								<textarea class="name-text-area" name="attr_distinctive_features" placeholder=""></textarea>
							</div>
						</div>
					</div>            
				</div>
				<div class="logo-section">
					<img src="https://imgur.com/KKRe2oc.jpg" alt="Grimwild Logo" class="grimwild-logo">
				</div>
			</div>
				<div class="main-content">
					<div class="left-column">
						<div class="section-header">ROLL SETTINGS</div>
							<div class="section-content">
								<div class="field-group">
									<label class="settings-label-flex">
										<input type="checkbox" name="attr_use_api_rolls">
										<span>Use API Rolls</span>
									</label>
									<div class="settings-help-text">
										Enable when using the Grimwild Roll20 Character Sheet API to enhance how rolls are displayed and autocalculate results.
									</div>
								</div>
								<div class="field-group">
									<label class="settings-label-flex">
										<input type="checkbox" name="attr_clean_story_assist" checked="checked">
										<span>Use Unaltered Story, Assist, and Montage Rolls</span>
									</label>
									<div class="settings-help-text">
										Enable to ensure added thorns, dice, and spark do not affect story, assist, and montage rolls.
									</div>
								</div>
								<div class="field-group">
									<label class="settings-label-flex">
										<input type="checkbox" name="attr_use_rollable_tables" checked="">
										<span>Use Rollable Tables (when API is disabled)</span>
									</label>
									<div class="settings-help-text">
										Enable when using Roll20 rollable tables instead of standard d6 or d8 rolls.
									</div>
								</div>
								<div class="field-group">
									<label class="settings-label-flex">
										<input type="checkbox" name="attr_hide_roll_guidance">
										<span>Hide Roll Reminders (when API is disabled)</span>
									</label>
									<div class="settings-help-text">
										Enable to remove the reminders at the bottom of rolls that describe how to interpret results.
									</div>
								</div>
							</div>
					</div>
					<div class="right-column">	
						<div class="section-header">SHEET SETTINGS</div>
							<div class="section-content">
								<div class="field-group">
									<label class="settings-label-block">
										<span class="settings-label-title">Sheet Size</span>
									</label>
									<div class="settings-help-text-spaced">
										Adjust the overall size of the character sheet.
									</div>
									<div class="settings-radio-group">
										<label class="settings-radio-option">
											<input type="radio" name="attr_sheet_size" value="compact">
											<span>Compact</span>
										</label>
										<label class="settings-radio-option">
											<input type="radio" name="attr_sheet_size" value="regular" checked="checked">
											<span>Default</span>
										</label>
										<label class="settings-radio-option">
											<input type="radio" name="attr_sheet_size" value="expanded">
											<span>Expanded</span>
										</label>
									</div>
								</div>
								<div class="field-group">
									<label class="settings-label-flex">
										<input type="checkbox" name="attr_lock_path_layout">
										<span>Lock Path</span>
									</label>
									<div class="settings-help-text">
										Enable to lock the current Core Talent layout regardless of what is entered into the Path field. By default, when a Path is recognized as one of the 12 Grimwild Paths the Core Talent is automatically updated.<br><br>The available paths are: <em>Bard, Berserker, Cleric, Druid, Fighter, Monk, Paladin, Ranger, Rogue, Sorcerer, Warlock,</em> and <em>Wizard</em>.
									</div>
								</div>
								<div class="field-group">
										<label class="settings-label-flex">
											<input type="checkbox" name="attr_hide_resources_toggle">
											<span>Hide Resources Section</span>
										</label>
										<div class="settings-help-text">
											Enable to hide the Resources section found on the sheet's Main tab.
										</div>
								</div>
						</div>
					</div>

				</div>
		</div>
	</div>
				</div>	
        </div>
    </div>
<script type="text/worker">
const pathTemplates = {
    'fighter': {
        name: 'Fighter',
        layout: 'fighter_mastery'
    },
    'rogue': {
        name: 'Rogue',
        layout: 'rogue_expertise'
    },
    'bard': {
        name: 'Bard',
        layout: 'bard_song'
    },
    'wizard': {
        name: 'Wizard',
        layout: 'wizard_spellcraft'
    },
    'berserker': {
        name: 'Berserker',
        layout: 'berserker_frenzy'
    },
	'cleric': {
        name: 'Cleric',
        layout: 'cleric_divinity'
    }
	,
	'druid': {
        name: 'Druid',
        layout: 'druid_wildshape'
    }
	,
	'ranger': {
        name: 'Ranger',
        layout: 'ranger_huntersmark'
    }
	,
	'monk': {
        name: 'Monk',
        layout: 'monk_discipline'
    }
	,
	'paladin': {
        name: 'Paladin',
        layout: 'paladin_oath'
    }
	,
	'sorcerer': {
        name: 'sorcerer',
        layout: 'sorcerer_sorcery'
    }
	,
	'warlock': {
        name: 'Warlock',
        layout: 'warlock_pact'
    }
};

function populatePathTalent(pathName) {
    getAttrs(['lock_path_layout'], function(values) {
        if (values.lock_path_layout === 'on') {
            console.log('Path layout is locked - ignoring PATH field change');
            return;
        }
        
        const normalizedPath = pathName ? pathName.toLowerCase().trim() : '';
        const pathData = pathTemplates[normalizedPath];
        
        if (pathData) {
            setAttrs({
                current_path_layout: pathData.layout
            });
            console.log(`Switched to ${pathData.name} layout: ${pathData.layout}`);
        } else {
            setAttrs({
                current_path_layout: 'freeform'
            });
            console.log(`Switched to Custom/Freeform layout`);
        }
    });
}

on('change:player_name', function(eventInfo) {
    const pathName = eventInfo.newValue;
    populatePathTalent(pathName);
});

on('clicked:toggle_mastery_dice', function() {
    getAttrs(['fighter_mastery_dice_count'], function(values) {
        let currentCount = parseInt(values.fighter_mastery_dice_count) || 1;
        let newCount = currentCount >= 3 ? 1 : currentCount + 1;
        
        setAttrs({
            fighter_mastery_dice_count: newCount
        });
    });
});

on('sheet:opened', function() {
    getAttrs(['sheet_size', 'use_api_rolls', 'hide_resources'], function(values) {
        let updates = {};
        
        if (!values.sheet_size) {
            updates.sheet_size = 'regular';
        }
        
        if (!values.use_api_rolls) {
            updates.use_api_rolls = 'on';
        }
        
        if (values.use_rollable_tables === undefined) {
            updates.use_rollable_tables = '0';  
        }
        
        if (values.hide_resources === undefined) {
            updates.hide_resources = '0';
        }
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates);
        }
    });
    
    getSectionIDs('repeating_items', function(ids) {
        if (ids.length === 0) {
            const newRowId = generateRowID();
            const newRow = {};
            for (let i = 1; i <= 4; i++) {
                newRow[`repeating_items_${newRowId}_item_${i}_name`] = '';
                newRow[`repeating_items_${newRowId}_item_${i}_count`] = 0;
                newRow[`repeating_items_${newRowId}_item_${i}_notes`] = '';
            }
            setAttrs(newRow);
        }
    });
    
    getAttrs(['player_name', 'current_path_layout'], function(values) {
        if (values.player_name) {
            populatePathTalent(values.player_name);
        }
    });
});

function getTotalSparkDice(callback) {
    getAttrs(['using_spark_1', 'using_spark_2'], function(values) {
        let sparkCount = 0;
        if (values.using_spark_1 === 'on') sparkCount++;
        if (values.using_spark_2 === 'on') sparkCount++;
        callback(sparkCount);
    });
}

function clearAllSpark() {
    setAttrs({
        using_spark_1: '0',
        using_spark_2: '0'
    });
}

on('clicked:pool_increment', function() {
    getAttrs(['pool_value'], function(values) {
        const current = +values.pool_value || 0;
        if (current < 8) {
            const newValue = current + 1;
            setAttrs({
                pool_value: newValue
            });
            console.log("Pool set to:", newValue);
        }
    });
});

	on('clicked:pool_decrement', function() {
		getAttrs(['pool_value'], function(values) {
			const current = +values.pool_value || 0;
			if (current > 0) {
				const newValue = current - 1;
				setAttrs({
					pool_value: newValue
				});
			}
		});
	});

	on('clicked:thorns_increment', function() {
		getAttrs(['thorns'], function(values) {
			const current = +values.thorns || 0;
			if (current < 3) {
				setAttrs({
					thorns: current + 1
				});
			}
		});
	});

	on('clicked:thorns_decrement', function() {
		getAttrs(['thorns'], function(values) {
			const current = +values.thorns || 0;
			if (current > 0) {
				setAttrs({
					thorns: current - 1
				});
			}
		});
	});

	on('clicked:extra_dice_increment', function() {
		getAttrs(['extra_dice'], function(values) {
			const current = +values.extra_dice || 0;
			if (current < 8) {
				setAttrs({
					extra_dice: current + 1
				});
			}
		});
	});

	on('clicked:extra_dice_decrement', function() {
		getAttrs(['extra_dice'], function(values) {
			const current = +values.extra_dice || 0;
			if (current > 0) {
				setAttrs({
					extra_dice: current - 1
				});
			}
		});
	});
	
	on('clicked:roll_pool', function() {
    getAttrs(['use_api_rolls', 'pool_value', 'character_name', 'hide_roll_guidance'], function(values) {
			const useAPI = values.use_api_rolls === 'on';
			const poolSize = +values.pool_value || 0;
			
			if (poolSize < 1) {
				console.log("Cannot roll pool - pool value must be at least 1");
				return;
			}
			
			if (poolSize > 8) {
				console.log("Cannot roll pool - maximum pool size is 8");
				return;
			}
			
			if (useAPI) {
				const apiCommand = `!grimpool ${poolSize}`;
				startRoll(apiCommand, function(results) {
					finishRoll(results.rollId, {});
				});
			} else {
				let rollString = `&{template:grimwild-basic} {{rollname=${values.character_name} | Pool Roll}} `;
				if (values.hide_roll_guidance === 'on') {
					rollString += `{{hide_guidance=1}} `;
				}
				
				rollString += `{{main_dice=`;
				for (let i = 0; i < poolSize; i++) {
					if (i > 0) rollString += ` `;
					rollString += `[[1d6]]`;
				}
				rollString += `}} `;
				
				rollString += `{{pool_size=${poolSize}}} `;
				
				startRoll(rollString, function(results) {
					finishRoll(results.rollId, {});
				});
			}
		});
	});
	
on('clicked:roll_brawn', function() {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        
        if (useAPI) {
            getAttrs(['brawn', 'thorns', 'extra_dice', 'brawn_marked', 'bloodied', 'rattled', 'using_spark_1', 'using_spark_2', 'fighter_mastery_active', 'fighter_mastery_dice_count', 'berserker_frenzy_active', 'agility_marked', 'wits_marked', 'presence_marked', 'current_path_layout', 'rogue_expertise', 'skullduggery_active', 'assassination_active', 'prowess_active'], function(values) {
                const stat = +values.brawn || 0;
                const difficultyThorns = +values.thorns || 0;
                const extraDice = +values.extra_dice || 0;
                const isMarked = values.brawn_marked === 'on';
                const isBloodied = values.bloodied === 'on';
                const isRattled = values.rattled === 'on';
                
                const isFrenzied = values.berserker_frenzy_active === 'on';
                const isPaladin = values.current_path_layout === 'paladin_oath';
                
                let totalMarks = 0;
                if (values.brawn_marked === 'on') totalMarks++;
                if (values.agility_marked === 'on') totalMarks++;
                if (values.wits_marked === 'on') totalMarks++;
                if (values.presence_marked === 'on') totalMarks++;
                
                let sparkDice = 0;
                if (values.using_spark_1 === 'on') sparkDice++;
                if (values.using_spark_2 === 'on') sparkDice++;
                const usingSpark = sparkDice > 0;
                
                let masteryDice = 0;
                const usingMastery = values.fighter_mastery_active === 'on';
                if (usingMastery) {
                    masteryDice = +values.fighter_mastery_dice_count || 0;
                }
                
                let expertiseDice = 0;
                let usingExpertise = false;
                let expertiseType = '';
                if (values.skullduggery_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'skullduggery';
                } else if (values.assassination_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'assassination';
                }
                
                let prowessDice = 0;
                const usingProwess = values.prowess_active === 'on';
                if (usingProwess) {
                    prowessDice = 1;
                }
                
                let markHarmThorns = 0;
                let oathDice = 0;
                
                if (isPaladin) {
                    if (isBloodied) oathDice = 1;
                } else {
                    if (isBloodied) markHarmThorns += 1;
                    if (isRattled) markHarmThorns += 1;
                }
                
                if (isMarked) markHarmThorns += 1;
                
				const totalThorns = difficultyThorns + (isFrenzied ? 0 : markHarmThorns);
                let mainDiceCount = stat + extraDice;
                
                if (mainDiceCount > 0 || usingSpark || usingMastery || oathDice > 0 || usingExpertise || usingProwess) {
                    let apiCommand = `!grimwild ${mainDiceCount} t${totalThorns} Brawn d${difficultyThorns} m${markHarmThorns} e${extraDice} s${sparkDice} mastery${masteryDice} frenzymarks${isFrenzied ? totalMarks : 0} oath${oathDice} expertise${expertiseDice} prowess${prowessDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    if (isMarked) apiCommand += ` marked`;
                    if (usingMastery) apiCommand += ` mastery`;
                    if (isFrenzied) apiCommand += ` frenzy`;
                    if (oathDice > 0) apiCommand += ` oath`;
                    if (usingExpertise) apiCommand += ` expertise ${expertiseType}`;
                    if (usingProwess) apiCommand += ` prowess`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        let attrsToSet = {};
                        if (isMarked) attrsToSet.brawn_marked = '0';
                        if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                        if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                        if (Object.keys(attrsToSet).length > 0) setAttrs(attrsToSet);
                    });
                }
            });
        } else {
            rollAttribute('brawn');
        }
    });
});

on('clicked:roll_agility', function() {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        
        if (useAPI) {
            getAttrs(['agility', 'thorns', 'extra_dice', 'agility_marked', 'bloodied', 'rattled', 'using_spark_1', 'using_spark_2', 'fighter_mastery_active', 'fighter_mastery_dice_count', 'berserker_frenzy_active', 'brawn_marked', 'wits_marked', 'presence_marked', 'current_path_layout', 'rogue_expertise', 'skullduggery_active', 'assassination_active', 'prowess_active'], function(values) {
                const stat = +values.agility || 0;
                const difficultyThorns = +values.thorns || 0;
                const extraDice = +values.extra_dice || 0;
                const isMarked = values.agility_marked === 'on';
                const isBloodied = values.bloodied === 'on';
                const isRattled = values.rattled === 'on';
                
                const isFrenzied = values.berserker_frenzy_active === 'on';
                const isPaladin = values.current_path_layout === 'paladin_oath';
                
                let totalMarks = 0;
                if (values.brawn_marked === 'on') totalMarks++;
                if (values.agility_marked === 'on') totalMarks++;
                if (values.wits_marked === 'on') totalMarks++;
                if (values.presence_marked === 'on') totalMarks++;
                
                let sparkDice = 0;
                if (values.using_spark_1 === 'on') sparkDice++;
                if (values.using_spark_2 === 'on') sparkDice++;
                const usingSpark = sparkDice > 0;
                
                let masteryDice = 0;
                const usingMastery = values.fighter_mastery_active === 'on';
                if (usingMastery) {
                    masteryDice = +values.fighter_mastery_dice_count || 0;
                }
                
                let expertiseDice = 0;
                let usingExpertise = false;
                let expertiseType = '';
                if (values.skullduggery_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'skullduggery';
                } else if (values.assassination_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'assassination';
                }
                
                let prowessDice = 0;
                const usingProwess = values.prowess_active === 'on';
                if (usingProwess) {
                    prowessDice = 1;
                }
                
                let markHarmThorns = 0;
                let oathDice = 0;
                
                if (isPaladin) {
                    if (isBloodied) oathDice = 1;
                } else {
                    if (isBloodied) markHarmThorns += 1;
                    if (isRattled) markHarmThorns += 1;
                }
                
                if (isMarked) markHarmThorns += 1;
                
				const totalThorns = difficultyThorns + (isFrenzied ? 0 : markHarmThorns);
                let mainDiceCount = stat + extraDice;
                
                if (mainDiceCount > 0 || usingSpark || usingMastery || oathDice > 0 || usingExpertise || usingProwess) {
                    let apiCommand = `!grimwild ${mainDiceCount} t${totalThorns} Agility d${difficultyThorns} m${markHarmThorns} e${extraDice} s${sparkDice} mastery${masteryDice} frenzymarks${isFrenzied ? totalMarks : 0} oath${oathDice} expertise${expertiseDice} prowess${prowessDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    if (isMarked) apiCommand += ` marked`;
                    if (usingMastery) apiCommand += ` mastery`;
                    if (isFrenzied) apiCommand += ` frenzy`;
                    if (oathDice > 0) apiCommand += ` oath`;
                    if (usingExpertise) apiCommand += ` expertise ${expertiseType}`;
                    if (usingProwess) apiCommand += ` prowess`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        let attrsToSet = {};
                        if (isMarked) attrsToSet.agility_marked = '0';
                        if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                        if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                        if (Object.keys(attrsToSet).length > 0) setAttrs(attrsToSet);
                    });
                }
            });
        } else {
            rollAttribute('agility');
        }
    });
});

on('clicked:roll_wits', function() {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        
        if (useAPI) {
            getAttrs(['wits', 'thorns', 'extra_dice', 'wits_marked', 'bloodied', 'rattled', 'using_spark_1', 'using_spark_2', 'fighter_mastery_active', 'fighter_mastery_dice_count', 'berserker_frenzy_active', 'brawn_marked', 'agility_marked', 'presence_marked', 'current_path_layout', 'rogue_expertise', 'skullduggery_active', 'assassination_active', 'prowess_active'], function(values) {
                const stat = +values.wits || 0;
                const difficultyThorns = +values.thorns || 0;
                const extraDice = +values.extra_dice || 0;
                const isMarked = values.wits_marked === 'on';
                const isBloodied = values.bloodied === 'on';
                const isRattled = values.rattled === 'on';
                
                const isFrenzied = values.berserker_frenzy_active === 'on';
                const isPaladin = values.current_path_layout === 'paladin_oath';
                
                let totalMarks = 0;
                if (values.brawn_marked === 'on') totalMarks++;
                if (values.agility_marked === 'on') totalMarks++;
                if (values.wits_marked === 'on') totalMarks++;
                if (values.presence_marked === 'on') totalMarks++;
                
                let sparkDice = 0;
                if (values.using_spark_1 === 'on') sparkDice++;
                if (values.using_spark_2 === 'on') sparkDice++;
                const usingSpark = sparkDice > 0;
                
                let masteryDice = 0;
                const usingMastery = values.fighter_mastery_active === 'on';
                if (usingMastery) {
                    masteryDice = +values.fighter_mastery_dice_count || 0;
                }
                
                let expertiseDice = 0;
                let usingExpertise = false;
                let expertiseType = '';
                if (values.skullduggery_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'skullduggery';
                } else if (values.assassination_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'assassination';
                }
                
                let prowessDice = 0;
                const usingProwess = values.prowess_active === 'on';
                if (usingProwess) {
                    prowessDice = 1;
                }
                
                let markHarmThorns = 0;
                let oathDice = 0;
                
                if (isPaladin) {
                    if (isRattled) oathDice = 1;
                } else {
                    if (isBloodied) markHarmThorns += 1;
                    if (isRattled) markHarmThorns += 1;
                }
                
                if (isMarked) markHarmThorns += 1;
                
				const totalThorns = difficultyThorns + (isFrenzied ? 0 : markHarmThorns);
                let mainDiceCount = stat + extraDice;
                
                if (mainDiceCount > 0 || usingSpark || usingMastery || oathDice > 0 || usingExpertise || usingProwess) {
                    let apiCommand = `!grimwild ${mainDiceCount} t${totalThorns} Wits d${difficultyThorns} m${markHarmThorns} e${extraDice} s${sparkDice} mastery${masteryDice} frenzymarks${isFrenzied ? totalMarks : 0} oath${oathDice} expertise${expertiseDice} prowess${prowessDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    if (isMarked) apiCommand += ` marked`;
                    if (usingMastery) apiCommand += ` mastery`;
                    if (isFrenzied) apiCommand += ` frenzy`;
                    if (oathDice > 0) apiCommand += ` oath`;
                    if (usingExpertise) apiCommand += ` expertise ${expertiseType}`;
                    if (usingProwess) apiCommand += ` prowess`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        let attrsToSet = {};
                        if (isMarked) attrsToSet.wits_marked = '0';
                        if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                        if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                        if (Object.keys(attrsToSet).length > 0) setAttrs(attrsToSet);
                    });
                }
            });
        } else {
            rollAttribute('wits');
        }
    });
});

on('clicked:roll_presence', function() {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        
        if (useAPI) {
            getAttrs(['presence', 'thorns', 'extra_dice', 'presence_marked', 'bloodied', 'rattled', 'using_spark_1', 'using_spark_2', 'fighter_mastery_active', 'fighter_mastery_dice_count', 'berserker_frenzy_active', 'brawn_marked', 'agility_marked', 'wits_marked', 'current_path_layout', 'rogue_expertise', 'skullduggery_active', 'assassination_active', 'prowess_active'], function(values) {
                const stat = +values.presence || 0;
                const difficultyThorns = +values.thorns || 0;
                const extraDice = +values.extra_dice || 0;
                const isMarked = values.presence_marked === 'on';
                const isBloodied = values.bloodied === 'on';
                const isRattled = values.rattled === 'on';
                
                const isFrenzied = values.berserker_frenzy_active === 'on';
                const isPaladin = values.current_path_layout === 'paladin_oath';
                
                let totalMarks = 0;
                if (values.brawn_marked === 'on') totalMarks++;
                if (values.agility_marked === 'on') totalMarks++;
                if (values.wits_marked === 'on') totalMarks++;
                if (values.presence_marked === 'on') totalMarks++;
                
                let sparkDice = 0;
                if (values.using_spark_1 === 'on') sparkDice++;
                if (values.using_spark_2 === 'on') sparkDice++;
                const usingSpark = sparkDice > 0;
                
                let masteryDice = 0;
                const usingMastery = values.fighter_mastery_active === 'on';
                if (usingMastery) {
                    masteryDice = +values.fighter_mastery_dice_count || 0;
                }
                
                let expertiseDice = 0;
                let usingExpertise = false;
                let expertiseType = '';
                if (values.skullduggery_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'skullduggery';
                } else if (values.assassination_active === 'on') {
                    expertiseDice = 1;
                    usingExpertise = true;
                    expertiseType = 'assassination';
                }
                
                let prowessDice = 0;
                const usingProwess = values.prowess_active === 'on';
                if (usingProwess) {
                    prowessDice = 1;
                }
                
                let markHarmThorns = 0;
                let oathDice = 0;
                
                if (isPaladin) {
                    if (isRattled) oathDice = 1;
                } else {
                    if (isBloodied) markHarmThorns += 1;
                    if (isRattled) markHarmThorns += 1;
                }
                
                if (isMarked) markHarmThorns += 1;
                
				const totalThorns = difficultyThorns + (isFrenzied ? 0 : markHarmThorns);
                let mainDiceCount = stat + extraDice;
                
                if (mainDiceCount > 0 || usingSpark || usingMastery || oathDice > 0 || usingExpertise || usingProwess) {
                    let apiCommand = `!grimwild ${mainDiceCount} t${totalThorns} Presence d${difficultyThorns} m${markHarmThorns} e${extraDice} s${sparkDice} mastery${masteryDice} frenzymarks${isFrenzied ? totalMarks : 0} oath${oathDice} expertise${expertiseDice} prowess${prowessDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    if (isMarked) apiCommand += ` marked`;
                    if (usingMastery) apiCommand += ` mastery`;
                    if (isFrenzied) apiCommand += ` frenzy`;
                    if (oathDice > 0) apiCommand += ` oath`;
                    if (usingExpertise) apiCommand += ` expertise ${expertiseType}`;
                    if (usingProwess) apiCommand += ` prowess`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        let attrsToSet = {};
                        if (isMarked) attrsToSet.presence_marked = '0';
                        if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                        if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                        if (Object.keys(attrsToSet).length > 0) setAttrs(attrsToSet);
                    });
                }
            });
        } else {
            rollAttribute('presence');
        }
    });
});
on('clicked:roll_story', function() {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        
        if (useAPI) {
            getAttrs(['thorns', 'extra_dice', 'using_spark_1', 'using_spark_2', 'clean_story_assist'], function(values) {
                const cleanMode = values.clean_story_assist === 'on';
                
                if (cleanMode) {
                    const apiCommand = `!grimwild 0 menu Story d0 m0 e0 s0`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                    });
                } else {
                    const difficultyThorns = +values.thorns || 0;
                    const extraDice = +values.extra_dice || 0;
                    
                    let sparkDice = 0;
                    if (values.using_spark_1 === 'on') sparkDice++;
                    if (values.using_spark_2 === 'on') sparkDice++;
                    const usingSpark = sparkDice > 0;
                    
                    const apiCommand = `!grimwild 0 menu Story d${difficultyThorns} m0 e${extraDice} s${sparkDice}${usingSpark ? ' spark' : ''}`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        if (usingSpark) {
                            let attrsToSet = {};
                            if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                            if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                            setAttrs(attrsToSet);
                        }
                    });
                }
            });
        } else {
            rollStoryAdvanced();
        }
    });
});
	
	on('clicked:cycle_trait_brave', function() {
		getAttrs(['trait_brave'], function(values) {
			let current = +values.trait_brave || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_brave: next
			});
		});
	});

	on('clicked:cycle_trait_gentle', function() {
		getAttrs(['trait_gentle'], function(values) {
			let current = +values.trait_gentle || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_gentle: next
			});
		});
	});

	on('clicked:cycle_trait_protective', function() {
		getAttrs(['trait_protective'], function(values) {
			let current = +values.trait_protective || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_protective: next
			});
		});
	});

	on('clicked:cycle_trait_caring', function() {
		getAttrs(['trait_caring'], function(values) {
			let current = +values.trait_caring || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_caring: next
			});
		});
	});

	on('clicked:cycle_trait_honest', function() {
		getAttrs(['trait_honest'], function(values) {
			let current = +values.trait_honest || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_honest: next
			});
		});
	});

	on('clicked:cycle_trait_quiet', function() {
		getAttrs(['trait_quiet'], function(values) {
			let current = +values.trait_quiet || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_quiet: next
			});
		});
	});

	on('clicked:cycle_trait_confident', function() {
		getAttrs(['trait_confident'], function(values) {
			let current = +values.trait_confident || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_confident: next
			});
		});
	});

	on('clicked:cycle_trait_honorable', function() {
		getAttrs(['trait_honorable'], function(values) {
			let current = +values.trait_honorable || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_honorable: next
			});
		});
	});

	on('clicked:cycle_trait_rash', function() {
		getAttrs(['trait_rash'], function(values) {
			let current = +values.trait_rash || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_rash: next
			});
		});
	});

	on('clicked:cycle_trait_curious', function() {
		getAttrs(['trait_curious'], function(values) {
			let current = +values.trait_curious || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_curious: next
			});
		});
	});

	on('clicked:cycle_trait_persistent', function() {
		getAttrs(['trait_persistent'], function(values) {
			let current = +values.trait_persistent || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_persistent: next
			});
		});
	});

	on('clicked:cycle_trait_stubborn', function() {
		getAttrs(['trait_stubborn'], function(values) {
			let current = +values.trait_stubborn || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_stubborn: next
			});
		});
	});

	on('clicked:cycle_trait_custom', function() {
		getAttrs(['trait_custom_state'], function(values) {
			let current = +values.trait_custom_state || 0;
			let next = (current + 1) % 3;
			setAttrs({
				trait_custom_state: next
			});
		});
	});

	on('clicked:cycle_desire_belonging', function() {
		getAttrs(['desire_belonging'], function(values) {
			let current = +values.desire_belonging || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_belonging: next
			});
		});
	});

	on('clicked:cycle_desire_justice', function() {
		getAttrs(['desire_justice'], function(values) {
			let current = +values.desire_justice || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_justice: next
			});
		});
	});

	on('clicked:cycle_desire_renown', function() {
		getAttrs(['desire_renown'], function(values) {
			let current = +values.desire_renown || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_renown: next
			});
		});
	});

	on('clicked:cycle_desire_glory', function() {
		getAttrs(['desire_glory'], function(values) {
			let current = +values.desire_glory || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_glory: next
			});
		});
	});

	on('clicked:cycle_desire_knowledge', function() {
		getAttrs(['desire_knowledge'], function(values) {
			let current = +values.desire_knowledge || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_knowledge: next
			});
		});
	});

	on('clicked:cycle_desire_thrills', function() {
		getAttrs(['desire_thrills'], function(values) {
			let current = +values.desire_thrills || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_thrills: next
			});
		});
	});

	on('clicked:cycle_desire_harmony', function() {
		getAttrs(['desire_harmony'], function(values) {
			let current = +values.desire_harmony || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_harmony: next
			});
		});
	});

	on('clicked:cycle_desire_love', function() {
		getAttrs(['desire_love'], function(values) {
			let current = +values.desire_love || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_love: next
			});
		});
	});

	on('clicked:cycle_desire_wealth', function() {
		getAttrs(['desire_wealth'], function(values) {
			let current = +values.desire_wealth || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_wealth: next
			});
		});
	});

	on('clicked:cycle_desire_honor', function() {
		getAttrs(['desire_honor'], function(values) {
			let current = +values.desire_honor || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_honor: next
			});
		});
	});

	on('clicked:cycle_desire_power', function() {
		getAttrs(['desire_power'], function(values) {
			let current = +values.desire_power || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_power: next
			});
		});
	});

	on('clicked:cycle_desire_wisdom', function() {
		getAttrs(['desire_wisdom'], function(values) {
			let current = +values.desire_wisdom || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_wisdom: next
			});
		});
	});

	on('clicked:cycle_desire_custom', function() {
		getAttrs(['desire_custom_state'], function(values) {
			let current = +values.desire_custom_state || 0;
			let next = (current + 1) % 3;
			setAttrs({
				desire_custom_state: next
			});
		});
	});
	
	on('clicked:rest', function() {
		setAttrs({
			brawn_marked: '0',
			agility_marked: '0',
			wits_marked: '0',
			presence_marked: '0',
			
			bloodied: '0',
			rattled: '0',
			
			thorns: 0,
			extra_dice: 0
		});
	});
	on('clicked:toggle_core_talent_resize', function() {
		getAttrs(['core_talent_resize_unlocked'], function(values) {
			const isCurrentlyUnlocked = values.core_talent_resize_unlocked === 'true';
			const newState = isCurrentlyUnlocked ? 'false' : 'true';
			
			setAttrs({
				core_talent_resize_unlocked: newState
			});
			
			console.log('Resize mode toggled to:', newState === 'true' ? 'UNLOCKED (manual resize)' : 'LOCKED (auto-size)');
		});
	});

on('clicked:toggle_acquired_talents_resize', function() {
    getAttrs(['acquired_talents_resize_unlocked'], function(values) {
        const isCurrentlyUnlocked = values.acquired_talents_resize_unlocked === 'true';
        const newState = isCurrentlyUnlocked ? 'false' : 'true';
        
        setAttrs({
            acquired_talents_resize_unlocked: newState
        });
        
        console.log('Acquired Talents resize mode toggled to:', newState === 'true' ? 'UNLOCKED' : 'LOCKED');
    });
	});

	on('sheet:opened', function() {
		setAttrs({
			core_talent_resize_unlocked: 'false',
			acquired_talents_resize_unlocked: 'false',
			spell_source_resize_unlocked: 'false',
			spells_resize_unlocked: 'false'
		});
		console.log('Sheet opened - all sections set to LOCKED mode (auto-size)');
	});
	const tabList = ["main", "notes", "settings"];

	tabList.forEach(tab => {
		on(`clicked:${tab}`, function() {
			setAttrs({
				sheetTab: tab
			});
		});
	});

	on('sheet:opened', function() {
		getAttrs(['sheetTab'], function(values) {
			if (!values.sheetTab) {
				setAttrs({
					sheetTab: 'main'
				});
			}
		});
		getSectionIDs('repeating_items', function(ids) {
		});
	});
on('clicked:assist', function() {
    getAttrs(['use_api_rolls', 'use_rollable_tables', 'clean_story_assist', 'hide_roll_guidance'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        const cleanMode = values.clean_story_assist === 'on';
        
        if (useAPI) {
            if (cleanMode) {
                const apiCommand = `!grimwild 1 t0 Assist d0 m0 e0 s0`;
                
                startRoll(apiCommand, function(results) {
                    finishRoll(results.rollId, {});
                });
            } else {
                getAttrs(['using_spark_1', 'using_spark_2'], function(sparkValues) {
                    let sparkDice = 0;
                    if (sparkValues.using_spark_1 === 'on') sparkDice++;
                    if (sparkValues.using_spark_2 === 'on') sparkDice++;
                    const usingSpark = sparkDice > 0;
                    
                    let apiCommand = `!grimwild 1 t0 Assist d0 m0 e0 s${sparkDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        if (usingSpark) {
                            let attrsToSet = {};
                            if (sparkValues.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                            if (sparkValues.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                            setAttrs(attrsToSet);
                        }
                    });
                });
            }
        } else {
            if (cleanMode) {
                getAttrs(['character_name'], function(rollValues) {
                    const useRollableTables = values.use_rollable_tables === 'on';
                    
                    let rollString = `&{template:grimwild-basic} {{rollname=${rollValues.character_name} | Assist Roll}} `;
                    rollString += `{{roll_type=Assist}} `;
                    if (useRollableTables) {
                        rollString += `{{use_rollable_tables=1}} `;
                    }
                    if (values.hide_roll_guidance === 'on') {
                        rollString += `{{hide_guidance=1}} `;
                    }
                    rollString += `{{main_dice=`;
                    rollString += useRollableTables ? `[[1t[GWRoll]]]` : `[[1d6]]`;
                    rollString += `}}`;
                    
                    startRoll(rollString, function(results) {
                        finishRoll(results.rollId, {});
                    });
                });
            } else {
                getAttrs(['using_spark_1', 'using_spark_2', 'character_name'], function(rollValues) {
                    let sparkDice = 0;
                    if (rollValues.using_spark_1 === 'on') sparkDice++;
                    if (rollValues.using_spark_2 === 'on') sparkDice++;
                    const usingSpark = sparkDice > 0;
                    const useRollableTables = values.use_rollable_tables === 'on';
                    let totalDice = 1 + sparkDice;
                    
                    let rollString = `&{template:grimwild-basic} {{rollname=${rollValues.character_name} | Assist Roll}} `;
                    rollString += `{{roll_type=Assist}} `;
                    if (useRollableTables) {
                        rollString += `{{use_rollable_tables=1}} `;
                    }
                    if (values.hide_roll_guidance === 'on') {
                        rollString += `{{hide_guidance=1}} `;
                    }
                    rollString += `{{main_dice=`;
                    for (let i = 0; i < totalDice; i++) {
                        if (i > 0) rollString += ` `;
                        rollString += useRollableTables ? `[[1t[GWRoll]]]` : `[[1d6]]`;
                    }
                    rollString += `}}`;
                    
                    startRoll(rollString, function(results) {
                        finishRoll(results.rollId, {});
                        
                        if (usingSpark) {
                            let attrsToSet = {};
                            if (rollValues.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                            if (rollValues.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                            setAttrs(attrsToSet);
                        }
                    });
                });
            }
        }
    });
});
on('clicked:repeating_pools:roll-custom-pool', function(eventInfo) {
    getAttrs(['use_api_rolls'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        const rowId = eventInfo.sourceAttribute.split('_')[2];
        
        if (useAPI) {
            getAttrs([
                `repeating_pools_${rowId}_pool_name`,
                `repeating_pools_${rowId}_pool_total`,
                `repeating_pools_${rowId}_pool_current`,
                `repeating_pools_${rowId}_pool_power`,
                'thorns',
                'bloodied',
                'rattled',
                'using_spark_1',
                'using_spark_2'
            ], function(values) {
                const poolName = values[`repeating_pools_${rowId}_pool_name`] || 'Custom Pool';
                const poolTotal = parseInt(values[`repeating_pools_${rowId}_pool_total`]) || 0;
                const poolCurrent = parseInt(values[`repeating_pools_${rowId}_pool_current`]) || 0;
                const isPowerPool = values[`repeating_pools_${rowId}_pool_power`] === 'on';
                
                let rollValue = poolCurrent > 0 ? poolCurrent : poolTotal;
                
                if (rollValue < 1 || rollValue > 12) {
                    console.log("Cannot roll pool - value must be between 1 and 12");
                    return;
                }
                
                let apiCommand;
                if (isPowerPool) {
                    const thorns = parseInt(values.thorns) || 0;
                    const bloodied = values.bloodied === 'on' ? 1 : 0;
                    const rattled = values.rattled === 'on' ? 1 : 0;
                    
                    let sparkDice = 0;
                    if (values.using_spark_1 === 'on') sparkDice++;
                    if (values.using_spark_2 === 'on') sparkDice++;
                    const usingSpark = sparkDice > 0;
                    
				apiCommand = `!grimpowerpool ${rollValue} ${poolName} t${thorns} b${bloodied} r${rattled} s${sparkDice}`;
				if (usingSpark) apiCommand += ` spark`;
                } else {
                    apiCommand = `!grimpool ${rollValue} ${poolName}`;
                }
                
                startRoll(apiCommand, function(results) {
                    finishRoll(results.rollId, {});
                    
                    if (isPowerPool) {
                        getAttrs(['using_spark_1', 'using_spark_2'], function(sparkValues) {
                            let attrsToSet = {};
                            if (sparkValues.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                            if (sparkValues.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                            if (Object.keys(attrsToSet).length > 0) setAttrs(attrsToSet);
                        });
                    }
                });
            });
        } else {
            getAttrs([
                `repeating_pools_${rowId}_pool_name`,
                `repeating_pools_${rowId}_pool_total`,
                `repeating_pools_${rowId}_pool_current`,
                `repeating_pools_${rowId}_pool_power`,
                'character_name',
                'hide_roll_guidance'
            ], function(values) {
                const poolName = values[`repeating_pools_${rowId}_pool_name`] || 'Custom Pool';
                const poolTotal = parseInt(values[`repeating_pools_${rowId}_pool_total`]) || 0;
                const poolCurrent = parseInt(values[`repeating_pools_${rowId}_pool_current`]) || 0;
                const characterName = values.character_name || 'Character';
                const isPowerPool = values[`repeating_pools_${rowId}_pool_power`] === 'on';
                
                let rollValue = poolCurrent > 0 ? poolCurrent : poolTotal;
                
                if (rollValue < 1 || rollValue > 12) {
                    console.log("Cannot roll pool - value must be between 1 and 12");
                    return;
                }
                
                if (isPowerPool) {
                    getAttrs([
                        'thorns', 'bloodied', 'rattled', 'using_spark_1', 'using_spark_2', 'use_rollable_tables'
                    ], function(powerValues) {
                        const difficultyThorns = parseInt(powerValues.thorns) || 0;
                        const bloodiedThorns = powerValues.bloodied === 'on' ? 1 : 0;
                        const rattledThorns = powerValues.rattled === 'on' ? 1 : 0;
                        
                        let sparkDice = 0;
                        if (powerValues.using_spark_1 === 'on') sparkDice++;
                        if (powerValues.using_spark_2 === 'on') sparkDice++;
                        const usingSpark = sparkDice > 0;
                        
                        const useRollableTables = powerValues.use_rollable_tables === 'on';
                        
                        const totalThorns = difficultyThorns + bloodiedThorns + rattledThorns;
                        let finalPoolSize = rollValue + sparkDice;
                        
                        let rollString = `&{template:grimwild-basic} {{rollname=${characterName} | ${poolName} Power Pool}} `;
                        if (useRollableTables) {
                            rollString += `{{use_rollable_tables=1}} `;
                        }
                        if (values.hide_roll_guidance === 'on') {
                            rollString += `{{hide_guidance=1}} `;
                        }
                        
                        rollString += `{{main_dice=`;
                        for (let i = 0; i < finalPoolSize; i++) {
                            if (i > 0) rollString += ` `;
                            rollString += useRollableTables ? `[[1t[GWRoll]]]` : `[[1d6]]`;
                        }
                        rollString += `}} `;
                        
                        if (totalThorns > 0) {
                            rollString += `{{thorns=`;
                            for (let i = 0; i < totalThorns; i++) {
                                if (i > 0) rollString += ` `;
                                rollString += useRollableTables ? `[[1t[Thorn]]]` : `[[1d8]]`;
                            }
                            rollString += `}} `;
                        }
                        
                        rollString += `{{pool_size=${finalPoolSize}}}`;
                        
                        startRoll(rollString, function(results) {
                            finishRoll(results.rollId, {});
                            
                            if (usingSpark) {
                                let attrsToSet = {};
                                if (powerValues.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                                if (powerValues.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                                setAttrs(attrsToSet);
                            }
                        });
                    });
                } else {
                    let rollString = `&{template:grimwild-basic} {{rollname=${characterName} | ${poolName} Pool}} `;
                    if (values.hide_roll_guidance === 'on') {
                        rollString += `{{hide_guidance=1}} `;
                    }
                    rollString += `{{main_dice=`;
                    for (let i = 0; i < rollValue; i++) {
                        if (i > 0) rollString += ` `;
                        rollString += `[[1d6]]`;
                    }
                    rollString += `}} {{pool_size=${rollValue}}}`;
                    
                    startRoll(rollString, function(results) {
                        finishRoll(results.rollId, {});
                    });
                }
            });
        }
    });
});
	on('clicked:toggle_spell_source_resize', function() {
		getAttrs(['spell_source_resize_unlocked'], function(values) {
			const isCurrentlyUnlocked = values.spell_source_resize_unlocked === 'true';
			const newState = isCurrentlyUnlocked ? 'false' : 'true';
			
			setAttrs({
				spell_source_resize_unlocked: newState
			});
			
			console.log('Spell Source resize mode toggled to:', newState === 'true' ? 'UNLOCKED' : 'LOCKED');
		});
	});

	on('clicked:toggle_spells_resize', function() {
		getAttrs(['spells_resize_unlocked'], function(values) {
			const isCurrentlyUnlocked = values.spells_resize_unlocked === 'true';
			const newState = isCurrentlyUnlocked ? 'false' : 'true';
			
			setAttrs({
				spells_resize_unlocked: newState
			});
			
			console.log('Spells resize mode toggled to:', newState === 'true' ? 'UNLOCKED' : 'LOCKED');
		});
	});
function rollAttribute(attributeName) {
    const attrs = [
        attributeName, 'extra_dice', 'using_spark_1', 'using_spark_2', 'thorns', 
        `${attributeName}_marked`, 'bloodied', 'rattled', 'character_name', 'use_rollable_tables', 'hide_roll_guidance',
        'fighter_mastery_active', 'fighter_mastery_dice_count', 'skullduggery_active', 'assassination_active', 'prowess_active',
        'current_path_layout', 'berserker_frenzy_active', 'brawn_marked', 'agility_marked', 'wits_marked', 'presence_marked'
    ];
    getAttrs(attrs, function(values) {
        const baseDice = parseInt(values[attributeName]) || 0;
        const extraDice = parseInt(values.extra_dice) || 0;
        
        let sparkDice = 0;
        if (values.using_spark_1 === 'on') sparkDice++;
        if (values.using_spark_2 === 'on') sparkDice++;
        
        let masteryDice = 0;
        const usingMastery = values.fighter_mastery_active === 'on';
        if (usingMastery) {
            masteryDice = parseInt(values.fighter_mastery_dice_count) || 0;
        }
        
        let expertiseDice = 0;
        if (values.skullduggery_active === 'on' || values.assassination_active === 'on') {
            expertiseDice = 1;
        }
        
        let prowessDice = 0;
        if (values.prowess_active === 'on') {
            prowessDice = 1;
        }
        
        const isFrenzied = values.berserker_frenzy_active === 'on';
        let totalMarks = 0;
        if (values.brawn_marked === 'on') totalMarks++;
        if (values.agility_marked === 'on') totalMarks++;
        if (values.wits_marked === 'on') totalMarks++;
        if (values.presence_marked === 'on') totalMarks++;
        
        let frenzyDice = 0;
        if (isFrenzied) {
            frenzyDice = totalMarks;
        }
        
        let markHarmThorns = 0;
        let oathDice = 0;
        
        const isPaladin = values.current_path_layout === 'paladin_oath';
        if (isPaladin) {
            if ((attributeName === 'brawn' || attributeName === 'agility') && values.bloodied === 'on') {
                oathDice = 1;
            }
            if ((attributeName === 'wits' || attributeName === 'presence') && values.rattled === 'on') {
                oathDice = 1;
            }
        } else {
            if (values.bloodied === 'on') markHarmThorns += 1;
            if (values.rattled === 'on') markHarmThorns += 1;
        }
        
        const isMarked = values[`${attributeName}_marked`] === 'on';
        if (isMarked) markHarmThorns += 1;
        
        const totalThorns = isFrenzied ? parseInt(values.thorns) || 0 : ((parseInt(values.thorns) || 0) + markHarmThorns);
        const mainDiceTotal = baseDice + extraDice + sparkDice;
        
        const baseThorns = parseInt(values.thorns) || 0;
        const markThorns = values[`${attributeName}_marked`] === 'on' ? 1 : 0;
        const bloodiedThorns = isPaladin ? 0 : (values.bloodied === 'on' ? 1 : 0);
        const rattledThorns = isPaladin ? 0 : (values.rattled === 'on' ? 1 : 0);
        const thornTotal = totalThorns;
        const attributeTitle = attributeName.charAt(0).toUpperCase() + attributeName.slice(1);
        
        const useRollableTables = values.use_rollable_tables === 'on';
        
        let rollString = `&{template:grimwild-basic} {{rollname=${values.character_name} | ${attributeTitle} Roll}} `;
        if (useRollableTables) {
            rollString += `{{use_rollable_tables=1}} `;
        }
        if (values.hide_roll_guidance === 'on') {
            rollString += `{{hide_guidance=1}} `;
        }
        rollString += `{{roll_type=${attributeTitle}}} `;
		
        if (mainDiceTotal > 0) {
            rollString += `{{main_dice=`;
            for (let i = 0; i < mainDiceTotal; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (masteryDice > 0) {
            rollString += `{{mastery_dice=`;
            for (let i = 0; i < masteryDice; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (oathDice > 0) {
            rollString += `{{oath_dice=`;
            for (let i = 0; i < oathDice; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (expertiseDice > 0) {
            rollString += `{{expertise_dice=`;
            for (let i = 0; i < expertiseDice; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (prowessDice > 0) {
            rollString += `{{prowess_dice=`;
            for (let i = 0; i < prowessDice; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (frenzyDice > 0) {
            rollString += `{{frenzy_dice=`;
            for (let i = 0; i < frenzyDice; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[GWRoll]]]`;
                } else {
                    rollString += `[[1d6]]`;
                }
            }
            rollString += `}} `;
        }
        
        if (thornTotal > 0) {
            rollString += `{{thorns=`;
            for (let i = 0; i < thornTotal; i++) {
                if (i > 0) rollString += ` `;
                if (useRollableTables) {
                    rollString += `[[1t[Thorn]]]`;
                } else {
                    rollString += `[[1d8]]`;
                }
            }
            rollString += `}}`;
        }
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
            
            let attrsToSet = {};
            
            if (values[`${attributeName}_marked`] === 'on') {
                attrsToSet[`${attributeName}_marked`] = '0';
            }
            if (values.using_spark_1 === 'on') {
                attrsToSet.using_spark_1 = '0';
            }
            if (values.using_spark_2 === 'on') {
                attrsToSet.using_spark_2 = '0';
            }
            
            if (Object.keys(attrsToSet).length > 0) {
                setAttrs(attrsToSet);
            }
        });
    });
}

on('clicked:roll_brawn_advanced', function() {
    rollAttribute('brawn');
});

on('clicked:roll_agility_advanced', function() {
    rollAttribute('agility');
});

on('clicked:roll_wits_advanced', function() {
    rollAttribute('wits');
});

on('clicked:roll_presence_advanced', function() {
    rollAttribute('presence');
});

on('clicked:roll_story_advanced', function() {
    getAttrs(['extra_dice', 'using_spark', 'thorns', 'bloodied', 'rattled', 'character_name'], function(values) {
        const extraDice = parseInt(values.extra_dice) || 0;
        const sparkDice = values.using_spark === 'on' ? 1 : 0;
        const mainDiceTotal = extraDice + sparkDice;
        
        const baseThorns = parseInt(values.thorns) || 0;
        const bloodiedThorns = values.bloodied === 'on' ? 1 : 0;
        const rattledThorns = values.rattled === 'on' ? 1 : 0;
        const thornTotal = baseThorns + bloodiedThorns + rattledThorns;
        
        let rollString = `&{template:grimwild-basic} {{rollname=${values.character_name} | Story}} `;
        
        if (mainDiceTotal > 0) {
            rollString += `{{main_dice=`;
            for (let i = 0; i < mainDiceTotal; i++) {
                if (i > 0) rollString += ` `;
                rollString += `[[1t[GWRoll]]]`;
            }
            rollString += `}} `;
        }
        
        if (thornTotal > 0) {
            rollString += `{{thorns=`;
            for (let i = 0; i < thornTotal; i++) {
                if (i > 0) rollString += ` `;
                rollString += `[[1t[Thorn]]]`;
            }
            rollString += `}}`;
        }
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
   
            if (values.using_spark === 'on') {
                setAttrs({
                    using_spark: '0'
                });
            }
        });
    });
});
on('clicked:roll_pool_advanced', function() {
    getAttrs(['pool_value', 'character_name', 'use_rollable_tables', 'hide_roll_guidance'], function(values) {
        const poolSize = parseInt(values.pool_value) || 0;
        const useRollableTables = values.use_rollable_tables === 'on';
        
        if (poolSize < 1) {
            console.log("Cannot roll pool - pool value must be at least 1");
            return;
        }
        
        if (poolSize > 12) {
            console.log("Cannot roll pool - maximum pool size is 12");
            return;
        }
        
		let rollString = `&{template:grimwild-basic} {{rollname=${values.character_name} | Pool}} `;
		if (values.hide_roll_guidance === 'on') {
			rollString += `{{hide_guidance=1}} `;
		}
        
        rollString += `{{main_dice=`;
        for (let i = 0; i < poolSize; i++) {
            if (i > 0) rollString += ` `;
            rollString += useRollableTables ? `[[1t[GWRoll]]]` : `[[1d6]]`;
        }
        rollString += `}} `;
        
        rollString += `{{pool_size=${poolSize}}} `;
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
        });
    });
});
function rollStoryAdvanced() {
    getAttrs(['extra_dice', 'using_spark_1', 'using_spark_2', 'thorns', 'character_name', 'use_rollable_tables', 'clean_story_assist', 'hide_roll_guidance'], function(values) {
        const extraDice = parseInt(values.extra_dice) || 0;
        
        let sparkDice = 0;
        if (values.using_spark_1 === 'on') sparkDice++;
        if (values.using_spark_2 === 'on') sparkDice++;
        
        const baseThorns = parseInt(values.thorns) || 0;
        const thornTotal = baseThorns; 
        const characterName = values.character_name || 'Character';
        
        const cleanMode = values.clean_story_assist === 'on';
        const additionalDice = cleanMode ? 0 : (extraDice + sparkDice);
        const useRollableTables = values.use_rollable_tables === 'on';
        
        let rollString = '&{template:grimwild-basic} ';
        rollString += '{{rollname=' + characterName + ' | Story Roll}} ';
        rollString += '{{roll_type=Story}} ';
        if (useRollableTables) {
            rollString += '{{use_rollable_tables=1}} ';
        }
        if (values.hide_roll_guidance === 'on') {
            rollString += '{{hide_guidance=1}} ';
        }
        rollString += '{{main_dice=?{Story Roll Type';
        
        const diceNotation = useRollableTables ? '[[1t[GWRoll]]]' : '[[1d6]]';
        const additionalDiceString = useRollableTables ? ' [[1t[GWRoll]]]' : ' [[1d6]]';
        
        rollString += '|Bad Odds (' + (1 + additionalDice) + 'd),' + diceNotation;
        for (let i = 0; i < additionalDice; i++) {
            rollString += additionalDiceString;
        }
        
        rollString += '|Even Odds (' + (2 + additionalDice) + 'd),' + diceNotation + ' ' + diceNotation;
        for (let i = 0; i < additionalDice; i++) {
            rollString += additionalDiceString;
        }
        
        rollString += '|Good Odds (' + (3 + additionalDice) + 'd),' + diceNotation + ' ' + diceNotation + ' ' + diceNotation;
        for (let i = 0; i < additionalDice; i++) {
            rollString += additionalDiceString;
        }
        
        rollString += '|Montage (' + (2 + additionalDice) + 'd),' + diceNotation + ' ' + diceNotation;
        for (let i = 0; i < additionalDice; i++) {
            rollString += additionalDiceString;
        }
        
        rollString += '}}} ';
        
        if (thornTotal > 0 && !cleanMode) {
            const thornNotation = useRollableTables ? '[[1t[Thorn]]]' : '[[1d8]]';
            rollString += '{{thorns=';
            for (let i = 0; i < thornTotal; i++) {
                if (i > 0) rollString += ' ';
                rollString += thornNotation;
            }
            rollString += '}}';
        }
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
            
            if (!cleanMode && sparkDice > 0) {
                let attrsToSet = {};
                if (values.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                if (values.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                setAttrs(attrsToSet);
            }
        });
    });
}
on('clicked:roll_dropped', function() {
    getAttrs(['use_api_rolls', 'use_rollable_tables', 'clean_story_assist', 'hide_roll_guidance'], function(values) {
        const useAPI = values.use_api_rolls === 'on';
        const cleanMode = values.clean_story_assist === 'on';
        
        if (useAPI) {
            if (cleanMode) {
                const apiCommand = `!grimwild 2 t0 Dropped d0 m0 e0 s0`;
                
                startRoll(apiCommand, function(results) {
                    finishRoll(results.rollId, {});
                });
            } else {
                getAttrs(['thorns', 'extra_dice', 'using_spark_1', 'using_spark_2'], function(rollValues) {
                    const difficultyThorns = +rollValues.thorns || 0;
                    const extraDice = +rollValues.extra_dice || 0;
                    
                    let sparkDice = 0;
                    if (rollValues.using_spark_1 === 'on') sparkDice++;
                    if (rollValues.using_spark_2 === 'on') sparkDice++;
                    const usingSpark = sparkDice > 0;
                    
                    let mainDiceCount = 2 + extraDice;
                    
                    let apiCommand = `!grimwild ${mainDiceCount} t${difficultyThorns} Dropped d${difficultyThorns} m0 e${extraDice} s${sparkDice}`;
                    if (usingSpark) apiCommand += ` spark`;
                    
                    startRoll(apiCommand, function(results) {
                        finishRoll(results.rollId, {});
                        
                        if (usingSpark) {
                            let attrsToSet = {};
                            if (rollValues.using_spark_1 === 'on') attrsToSet.using_spark_1 = '0';
                            if (rollValues.using_spark_2 === 'on') attrsToSet.using_spark_2 = '0';
                            setAttrs(attrsToSet);
                        }
                    });
                });
            }
        } else {
            getAttrs(['character_name'], function(rollValues) {
                const useRollableTables = values.use_rollable_tables === 'on';
                
                let rollString = `&{template:grimwild-basic} {{rollname=${rollValues.character_name} | Dropped Roll}} `;
                rollString += `{{roll_type=Dropped}} `;
                if (useRollableTables) {
                    rollString += `{{use_rollable_tables=1}} `;
                }
                if (values.hide_roll_guidance === 'on') {
                    rollString += `{{hide_guidance=1}} `;
                }
                
                rollString += `{{main_dice=`;
                const diceNotation = useRollableTables ? `[[1t[GWRoll]]]` : `[[1d6]]`;
                rollString += `${diceNotation} ${diceNotation}`;
                rollString += `}}`;
                
                startRoll(rollString, function(results) {
                    finishRoll(results.rollId, {});
                });
            });
        }
    });
});

let sparkButtonActive = false;

on('clicked:toggle_spark', function() {
    sparkButtonActive = true; 
    
    getAttrs(['spark1', 'spark2', 'using_spark_1', 'using_spark_2'], function(values) {
        const spark1 = values.spark1 === 'on';
        const spark2 = values.spark2 === 'on';
        const using1 = values.using_spark_1 === 'on';
        const using2 = values.using_spark_2 === 'on';
        
        let updates = {};
        
        if (spark1 || spark2) {
            if (spark2) {
                updates.spark2 = '0';
            } else if (spark1) {
                updates.spark1 = '0';
            }
            
            if (!using1) {
                updates.using_spark_1 = 'on';
            } else if (!using2) {
                updates.using_spark_2 = 'on';
            }
        }
        else if (using1 || using2) {
            if (using1 && using2) {
                updates.using_spark_1 = '0';
                updates.using_spark_2 = '0';
                updates.spark1 = 'on';
                updates.spark2 = 'on';
            }
            else {
                if (using2) {
                    updates.using_spark_2 = '0';
                } else if (using1) {
                    updates.using_spark_1 = '0';
                }
                
                if (!spark1) {
                    updates.spark1 = 'on';
                } else if (!spark2) {
                    updates.spark2 = 'on';
                }
            }
        }
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates, function() {
                sparkButtonActive = false; 
            });
        } else {
            sparkButtonActive = false; 
        }
    });
});
on('clicked:using_spark_1_manual', function() {
    getAttrs(['spark1', 'spark2', 'using_spark_1', 'using_spark_2'], function(values) {
        const spark1 = values.spark1 === 'on';
        const spark2 = values.spark2 === 'on';
        const using1 = values.using_spark_1 === 'on';
        const using2 = values.using_spark_2 === 'on';
        
        let updates = {};
        
        if (spark1 || spark2) {
            if (spark2) {
                updates.spark2 = '0';
            } else if (spark1) {
                updates.spark1 = '0';
            }
            
            if (!using1) {
                updates.using_spark_1 = 'on';
            } else if (!using2) {
                updates.using_spark_2 = 'on';
            }
        }
        else if (using1 || using2) {
            if (using1 && using2) {
                updates.using_spark_1 = '0';
                updates.using_spark_2 = '0';
                updates.spark1 = 'on';
                updates.spark2 = 'on';
            }
            else {
                if (using2) {
                    updates.using_spark_2 = '0';
                } else if (using1) {
                    updates.using_spark_1 = '0';
                }
                
                if (!spark1) {
                    updates.spark1 = 'on';
                } else if (!spark2) {
                    updates.spark2 = 'on';
                }
            }
        }
        else {
            if (!spark1 && !spark2 && !using1 && !using2) {
                updates.show_no_spark_message = '1';
            }
        }
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates);
        }
    });
});
on('clicked:using_spark_2_manual', function() {
    getAttrs(['spark1', 'spark2', 'using_spark_1', 'using_spark_2'], function(values) {
        const spark1 = values.spark1 === 'on';
        const spark2 = values.spark2 === 'on';
        const using1 = values.using_spark_1 === 'on';
        const using2 = values.using_spark_2 === 'on';
        
        let updates = {};
        
        if (spark1 || spark2) {
            if (spark2) {
                updates.spark2 = '0';
            } else if (spark1) {
                updates.spark1 = '0';
            }
            
            if (!using1) {
                updates.using_spark_1 = 'on';
            } else if (!using2) {
                updates.using_spark_2 = 'on';
            }
        }
        else if (using1 || using2) {
            if (using1 && using2) {
                updates.using_spark_1 = '0';
                updates.using_spark_2 = '0';
                updates.spark1 = 'on';
                updates.spark2 = 'on';
            }
            else {
                if (using2) {
                    updates.using_spark_2 = '0';
                } else if (using1) {
                    updates.using_spark_1 = '0';
                }
                
                if (!spark1) {
                    updates.spark1 = 'on';
                } else if (!spark2) {
                    updates.spark2 = 'on';
                }
            }
        }
        else {
            if (!spark1 && !spark2 && !using1 && !using2) {
                updates.show_no_spark_message = '1';
            }
        }
        
        if (Object.keys(updates).length > 0) {
            setAttrs(updates);
        }
    });
});
on('change:spark1 change:spark2 change:using_spark_1 change:using_spark_2', function() {
    getAttrs(['spark1', 'spark2', 'using_spark_1', 'using_spark_2'], function(values) {
        const hasAnySpark = values.spark1 === 'on' || values.spark2 === 'on' || 
                           values.using_spark_1 === 'on' || values.using_spark_2 === 'on';
        
        if (hasAnySpark) {
            setAttrs({show_no_spark_message: '0'});
        }
    });
});
on('clicked:select_skullduggery', function() {
    getAttrs(['rogue_expertise', 'skullduggery_active'], function(values) {
        const currentSelection = values.rogue_expertise;
        const isActive = values.skullduggery_active === 'on';
        
        if (currentSelection === 'skullduggery') {
            setAttrs({
                skullduggery_active: isActive ? '0' : 'on',
                assassination_active: '0'
            });
        } else {
            setAttrs({
                rogue_expertise: 'skullduggery',
                skullduggery_active: '0',
                assassination_active: '0'
            });
        }
    });
});

on('clicked:select_assassination', function() {
    getAttrs(['rogue_expertise', 'assassination_active'], function(values) {
        const currentSelection = values.rogue_expertise;
        const isActive = values.assassination_active === 'on';
        
        if (currentSelection === 'assassination') {
            setAttrs({
                assassination_active: isActive ? '0' : 'on',
                skullduggery_active: '0'
            });
        } else {
            setAttrs({
                rogue_expertise: 'assassination',
                assassination_active: '0',
                skullduggery_active: '0'
            });
        }
    });
});
on('clicked:toggle_prowess', function() {
    getAttrs(['prowess_active'], function(values) {
        const isActive = values.prowess_active === 'on';
        setAttrs({
            prowess_active: isActive ? '0' : 'on'
        });
    });
});
on('clicked:toggle_berserker_frenzy', function() {
    getAttrs(['berserker_frenzy_active'], function(values) {
        const isActive = values.berserker_frenzy_active === 'on';
        const newState = isActive ? '0' : 'on';
        
        setAttrs({
            berserker_frenzy_active: newState
        });
        
        console.log('Frenzy toggled to:', newState === 'on' ? 'ACTIVE' : 'INACTIVE');
    });
});

on('change:berserker_frenzy_active', function(eventInfo) {
    const isActive = eventInfo.newValue === 'on';
    const buttonClass = isActive ? 'berserker-frenzy-toggle berserker-frenzy-active' : 'berserker-frenzy-toggle';
    console.log('Frenzy state changed, button class should be:', buttonClass);
});
on('clicked:repeating_talents:toggle_talent_collapse', function(eventInfo) {
    const sourceAttr = eventInfo.sourceAttribute;
    const rowId = sourceAttr.match(/repeating_talents_([^_]+)/)[1];
    
    getAttrs([`repeating_talents_${rowId}_talent_collapsed`], function(values) {
        const currentState = values[`repeating_talents_${rowId}_talent_collapsed`] || '0';
        const newState = currentState === '1' ? '0' : '1';
        
        const updates = {};
        updates[`repeating_talents_${rowId}_talent_collapsed`] = newState;
        
        setAttrs(updates, function() {
            console.log(`Talent toggled to: ${newState === '1' ? 'COLLAPSED' : 'EXPANDED'}`);
        });
    });
});
on('clicked:repeating_talents:share-talent', function(eventInfo) {
    const rowId = eventInfo.sourceAttribute.split('_')[2];
    
    getAttrs(['character_name', `repeating_talents_${rowId}_talent_text`], function(values) {
        const characterName = values.character_name || 'Character';
        const talentText = values[`repeating_talents_${rowId}_talent_text`] || '';
        
        if (!talentText.trim()) return;
        
        const lines = talentText.split('\n');
        const firstLine = lines[0] || '';
        const restLines = lines.slice(1).join('\n').trim();
        
        console.log('First line:', firstLine);
        console.log('Rest:', restLines);
        
        let rollString = `&{template:grimwild-talent} {{charactername=${characterName}}} {{talentname=Talent}}`;
        
        if (firstLine) {
            rollString += ` {{talentfirstline=${firstLine}}}`;
        }
        
        if (restLines) {
            rollString += ` {{talentrest=${restLines}}}`;
        }
        
        console.log('Roll string:', rollString);
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
        });
    });
});
on('clicked:repeating_spells:toggle_spell_collapse', function(eventInfo) {
    const sourceAttr = eventInfo.sourceAttribute;
    const rowId = sourceAttr.match(/repeating_spells_([^_]+)/)[1];
    
    getAttrs([`repeating_spells_${rowId}_spell_collapsed`], function(values) {
        const currentState = values[`repeating_spells_${rowId}_spell_collapsed`] || '0';
        const newState = currentState === '1' ? '0' : '1';
        
        const updates = {};
        updates[`repeating_spells_${rowId}_spell_collapsed`] = newState;
        
        setAttrs(updates, function() {
            console.log(`Spell toggled to: ${newState === '1' ? 'COLLAPSED' : 'EXPANDED'}`);
        });
    });
});

on('clicked:repeating_spells:share-spell', function(eventInfo) {
    const rowId = eventInfo.sourceAttribute.split('_')[2];
    
    getAttrs(['character_name', `repeating_spells_${rowId}_spell_text`], function(values) {
        const characterName = values.character_name || 'Character';
        const spellText = values[`repeating_spells_${rowId}_spell_text`] || '';
        
        if (!spellText.trim()) return;
        
        const lines = spellText.split('\n');
        const firstLine = lines[0] || '';
        const restLines = lines.slice(1).join('\n').trim();
        
	let rollString = `&{template:grimwild-spell} {{charactername=${characterName}}}`;

	if (firstLine) {
		rollString += ` {{spellfirstline=${firstLine}}}`;
	}

	if (restLines) {
		rollString += ` {{spellrest=${restLines}}}`;
	}
        
        startRoll(rollString, function(results) {
            finishRoll(results.rollId, {});
        });
    });
});
	</script>
<rolltemplate class="sheet-rolltemplate-grimwild">
    <div class="sheet-container">
		<div class="sheet-container-header">
			{{charactername}} | {{#poolroll}}{{#rollname}}{{rollname}} Pool{{/rollname}}{{^rollname}}Pool Roll{{/rollname}}{{/poolroll}}{{^poolroll}}{{rollname}} Roll{{/poolroll}}
		</div>
        <div class="sheet-container-content">
            {{^poolroll}}
            <div class="sheet-dice-row-container">
				<div class="sheet-dice-header-left">{{poolname}}
					<div class="sheet-top-dice-row-left">
						{{#dice1}}<div class="sheet-dice sheet-dice{{dice1}}">{{dice1}}</div>{{/dice1}}
						{{#dice2}}<div class="sheet-dice sheet-dice{{dice2}}">{{dice2}}</div>{{/dice2}}
						{{#dice3}}<div class="sheet-dice sheet-dice{{dice3}}">{{dice3}}</div>{{/dice3}}
						{{#dice4}}<div class="sheet-dice sheet-dice{{dice4}}">{{dice4}}</div>{{/dice4}}
						{{#dice5}}<div class="sheet-dice sheet-dice{{dice5}}">{{dice5}}</div>{{/dice5}}
						{{#dice6}}<div class="sheet-dice sheet-dice{{dice6}}">{{dice6}}</div>{{/dice6}}
						{{#dice7}}<div class="sheet-dice sheet-dice{{dice7}}">{{dice7}}</div>{{/dice7}}
						{{#dice8}}<div class="sheet-dice sheet-dice{{dice8}}">{{dice8}}</div>{{/dice8}}
						{{#mastery1}}<div class="sheet-dice sheet-dice{{mastery1}}">{{mastery1}}<div class="sheet-mastery-label">WM</div></div>{{/mastery1}}
						{{#mastery2}}<div class="sheet-dice sheet-dice{{mastery2}}">{{mastery2}}<div class="sheet-mastery-label">WM</div></div>{{/mastery2}}
						{{#mastery3}}<div class="sheet-dice sheet-dice{{mastery3}}">{{mastery3}}<div class="sheet-mastery-label">WM</div></div>{{/mastery3}}
						{{#oath1}}<div class="sheet-dice sheet-dice{{oath1}}">{{oath1}}<div class="sheet-mastery-label">Oath</div></div>{{/oath1}}
						{{#oath2}}<div class="sheet-dice sheet-dice{{oath2}}">{{oath2}}<div class="sheet-mastery-label">Oath</div></div>{{/oath2}}
						{{#oath3}}<div class="sheet-dice sheet-dice{{oath3}}">{{oath3}}<div class="sheet-mastery-label">Oath</div></div>{{/oath3}}
						{{#expertise1}}<div class="sheet-dice sheet-dice{{expertise1}}">{{expertise1}}<div class="sheet-mastery-label">Ex</div></div>{{/expertise1}}
						{{#expertise2}}<div class="sheet-dice sheet-dice{{expertise2}}">{{expertise2}}<div class="sheet-mastery-label">Ex</div></div>{{/expertise2}}
						{{#expertise3}}<div class="sheet-dice sheet-dice{{expertise3}}">{{expertise3}}<div class="sheet-mastery-label">Ex</div></div>{{/expertise3}}
						{{#prowess1}}<div class="sheet-dice sheet-dice{{prowess1}}">{{prowess1}}<div class="sheet-mastery-label">P</div></div>{{/prowess1}}
						{{#prowess2}}<div class="sheet-dice sheet-dice{{prowess2}}">{{prowess2}}<div class="sheet-mastery-label">P</div></div>{{/prowess2}}
						{{#prowess3}}<div class="sheet-dice sheet-dice{{prowess3}}">{{prowess3}}<div class="sheet-mastery-label">P</div></div>{{/prowess3}}
						{{#frenzy1}}<div class="sheet-dice sheet-dice{{frenzy1}}">{{frenzy1}}<div class="sheet-mastery-label">F</div></div>{{/frenzy1}}
						{{#frenzy2}}<div class="sheet-dice sheet-dice{{frenzy2}}">{{frenzy2}}<div class="sheet-mastery-label">F</div></div>{{/frenzy2}}
						{{#frenzy3}}<div class="sheet-dice sheet-dice{{frenzy3}}">{{frenzy3}}<div class="sheet-mastery-label">F</div></div>{{/frenzy3}}
						{{#frenzy4}}<div class="sheet-dice sheet-dice{{frenzy4}}">{{frenzy4}}<div class="sheet-mastery-label">F</div></div>{{/frenzy4}}
					</div>        
				</div>
                {{#spark}}     
                <div class="sheet-dice-header-right">Add Spark
                    <div class="sheet-top-dice-row-right">
                        {{#spark1}}<div class="sheet-dice sheet-dice{{spark1}}">{{spark1}}</div>{{/spark1}}
                        {{#spark2}}<div class="sheet-dice sheet-dice{{spark2}}">{{spark2}}</div>{{/spark2}}
                    </div>        
                </div>
                {{/spark}}
            </div>
            {{/poolroll}}
            
            {{#poolroll}}
            <div class="sheet-dice-row-container">
                <div class="sheet-dice-header-left">{{poolname}}
					<div class="sheet-top-dice-row-left sheet-pool-dice{{#powerroll}} sheet-power-pool-dice{{/powerroll}}">
                        {{#dice1}}<div class="sheet-dice sheet-dice{{dice1}}">{{dice1}}</div>{{/dice1}}
                        {{#dice2}}<div class="sheet-dice sheet-dice{{dice2}}">{{dice2}}</div>{{/dice2}}
                        {{#dice3}}<div class="sheet-dice sheet-dice{{dice3}}">{{dice3}}</div>{{/dice3}}
                        {{#dice4}}<div class="sheet-dice sheet-dice{{dice4}}">{{dice4}}</div>{{/dice4}}
                        {{#dice5}}<div class="sheet-dice sheet-dice{{dice5}}">{{dice5}}</div>{{/dice5}}
                        {{#dice6}}<div class="sheet-dice sheet-dice{{dice6}}">{{dice6}}</div>{{/dice6}}
                        {{#dice7}}<div class="sheet-dice sheet-dice{{dice7}}">{{dice7}}</div>{{/dice7}}
                        {{#dice8}}<div class="sheet-dice sheet-dice{{dice8}}">{{dice8}}</div>{{/dice8}}
                        {{#dice9}}<div class="sheet-dice sheet-dice{{dice9}}">{{dice9}}</div>{{/dice9}}
                        {{#dice10}}<div class="sheet-dice sheet-dice{{dice10}}">{{dice10}}</div>{{/dice10}}
                        {{#dice11}}<div class="sheet-dice sheet-dice{{dice11}}">{{dice11}}</div>{{/dice11}}
                        {{#dice12}}<div class="sheet-dice sheet-dice{{dice12}}">{{dice12}}</div>{{/dice12}}
                    </div>        
                </div>
            </div>
            {{/poolroll}}
            
            {{#thorns}}
            <div class="sheet-divider"></div>
            <div class="sheet-dice-row-container">
                <div class="sheet-dice-header-left">Difficulty
                    <div class="sheet-top-dice-row-left">
                        {{#thorn1}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{thorn1}}">{{thorn1}}</div></div>{{/thorn1}}
                        {{#thorn2}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{thorn2}}">{{thorn2}}</div></div>{{/thorn2}}
                        {{#thorn3}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{thorn3}}">{{thorn3}}</div></div>{{/thorn3}}
                        {{#thorn4}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{thorn4}}">{{thorn4}}</div></div>{{/thorn4}}
                    </div>        
                </div>
                {{#markharm}}     
                <div class="sheet-dice-header-right">Marks & Harm
                    <div class="sheet-top-dice-row-right">
                        {{#mark1}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark1}}">{{mark1}}</div></div>{{/mark1}}
                        {{#mark2}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark2}}">{{mark2}}</div></div>{{/mark2}}
                        {{#mark3}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark3}}">{{mark3}}</div></div>{{/mark3}}
                    </div>        
                </div>
                {{/markharm}}
            </div>
            {{/thorns}}
            
            {{#markharmonly}}
            <div class="sheet-divider"></div>
            <div class="sheet-dice-row-container">
                <div class="sheet-dice-header-left">Marks & Harm
                    <div class="sheet-top-dice-row-left {{poolclass}}">
                        {{#mark1}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark1}}">{{mark1}}</div></div>{{/mark1}}
                        {{#mark2}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark2}}">{{mark2}}</div></div>{{/mark2}}
                        {{#mark3}}<div class="sheet-dice-thorn"><div class="sheet-dice-thorn_text sheet-thorn{{mark3}}">{{mark3}}</div></div>{{/mark3}}
                    </div>        
                </div>
            </div>
            {{/markharmonly}}
            
		{{#result}}
		<div class="sheet-divider"></div>
		<div class="sheet-result-bold">{{resultname}}</div>
		<div class="sheet-result-text">{{resulttext}}</div>
		{{/result}}

		{{#status}}
		<div class="sheet-mark-text">{{status}}</div>
		{{/status}}

		{{#powerresult}}
		<div class="sheet-divider"></div>
		<div class="sheet-result-bold">{{powerresultname}}</div>
		<div class="sheet-result-text">{{powerresulttext}}</div>
		{{/powerresult}}

		{{#powerstatus}}
		<div class="sheet-mark-text">{{powerstatus}}</div>
		{{/powerstatus}}
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-grimwild-basic">
    <div class="sheet-container">
        <div class="sheet-header">
            {{rollname}}
        </div>
        
		{{#main_dice}}
		<div class="sheet-section">
			{{#pool_size}}
			<div class="sheet-section-title">{{pool_size}}D Pool</div>
			{{/pool_size}}
			{{^pool_size}}
			{{#roll_type}}
			{{#dice_count}}
			<div class="sheet-section-title">{{roll_type}} ({{dice_count}}D)</div>
			{{/dice_count}}
			{{^dice_count}}
			<div class="sheet-section-title">{{roll_type}}</div>
			{{/dice_count}}
			{{/roll_type}}
			{{^roll_type}}
			<div class="sheet-section-title">Dice Results</div>
			{{/roll_type}}
			{{/pool_size}}
			<div class="sheet-results">{{main_dice}}</div>
		</div>
		{{/main_dice}}

		{{#mastery_dice}}
		<div class="sheet-section">
			<div class="sheet-section-title">Mastery</div>
			<div class="sheet-results">{{mastery_dice}}</div>
		</div>
		{{/mastery_dice}}

		{{#oath_dice}}
		<div class="sheet-section">
			<div class="sheet-section-title">Oath</div>
			<div class="sheet-results">{{oath_dice}}</div>
		</div>
		{{/oath_dice}}
		
		{{#frenzy_dice}}
		<div class="sheet-section">
			<div class="sheet-section-title">Frenzy</div>
			<div class="sheet-results">{{frenzy_dice}}</div>
		</div>
		{{/frenzy_dice}}
		
		{{#expertise_dice}}
		<div class="sheet-section">
			<div class="sheet-section-title">Expertise</div>
			<div class="sheet-results">{{expertise_dice}}</div>
		</div>
		{{/expertise_dice}}

		{{#prowess_dice}}
		<div class="sheet-section">
			<div class="sheet-section-title">Prowess</div>
			<div class="sheet-results">{{prowess_dice}}</div>
		</div>
		{{/prowess_dice}}

		{{#thorns}}
		<div class="sheet-divider"></div>
		<div class="sheet-section">
			<div class="sheet-section-title">Thorns</div>
			<div class="sheet-results">{{thorns}}</div>
		</div>
		{{/thorns}}
        
        {{^hide_guidance}}
        <div class="sheet-instructions">
			{{#pool_size}}
            {{#use_rollable_tables}}
            1-3: <span style="font-family: 'Lilita One'">DROPPED</span> | 4-6: <span style="font-family: 'Lilita One'">REMAIN</span><br>
            <span style="font-family: 'Lilita One'">0 REMAIN:</span> Fiction changes<br>
            <span style="font-family: 'Lilita One'">0 DROPPED:</span> Secondary effect<br>
			<span style="font-family: 'Lilita One'">1 REMAINS:</span> Push or spend to drop
            {{/use_rollable_tables}}
            {{^use_rollable_tables}}
            1-3: <span style="font-family: 'Lilita One'">DROPPED</span> | 4-6: <span style="font-family: 'Lilita One'">REMAIN</span><br>
            <span style="font-family: 'Lilita One'">0 REMAIN:</span> Fiction changes<br>
            <span style="font-family: 'Lilita One'">0 DROPPED:</span> Secondary effect<br>
			<span style="font-family: 'Lilita One'">1 REMAINS:</span> Push or spend to drop
            {{/use_rollable_tables}}
            {{/pool_size}}
			{{^pool_size}}

            {{#use_rollable_tables}}
            1-3: <span style="font-family: 'Lilita One'">GRIM</span> | 4-5: <span style="font-family: 'Lilita One'">MESSY</span> | 6: <span style="font-family: 'Lilita One'">PERFECT</span><br>
            <span style="font-family: 'Lilita One'">2+ PERFECT:</span> Critical (ignore cuts)<br>
            <span style="font-family: 'Lilita One'">7 or 8 THORN:</span> Cut outcome by a step<br>
			<span style="font-family: 'Lilita One'">Cut GRIM:</span> Disaster 
            {{/use_rollable_tables}}
            {{^use_rollable_tables}}
            1-3: <span style="font-family: 'Lilita One'">GRIM</span> | 4-5: <span style="font-family: 'Lilita One'">MESSY</span> | 6: <span style="font-family: 'Lilita One'">PERFECT</span><br>
            <span style="font-family: 'Lilita One'">2+ PERFECT:</span> Critical (ignore cuts)<br>
            <span style="font-family: 'Lilita One'">7 or 8 THORN:</span> Cut outcome by a step<br>
			<span style="font-family: 'Lilita One'">Cut GRIM:</span> Disaster 
            {{/use_rollable_tables}}
            {{/pool_size}}
        </div>
        {{/hide_guidance}}
    </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-grimwild-menu">
    <div class="sheet-container">
        <div class="sheet-container-header">
            {{rollname}}
        </div>
        <div class="sheet-container-content">
            <div class="sheet-menu-title">{{menu_title}}</div>
            <div class="sheet-menu-options">{{menu_options}}</div>
        </div>
    </div>
</rolltemplate>	
<rolltemplate class="sheet-rolltemplate-grimwild-talent">
    <div class="sheet-container">
        <div class="sheet-container-header">
            {{charactername}} | Talent
        </div>
        <div class="sheet-container-content">
            <div class="sheet-talent-name">{{talentfirstline}}</div>
            <div class="sheet-talent-rest">{{talentrest}}</div>
        </div>
    </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-grimwild-spell">
    <div class="sheet-container">
        <div class="sheet-container-header">
            {{charactername}} | Spell
        </div>
        <div class="sheet-container-content">
            <div class="sheet-talent-name">{{spellfirstline}}</div>
            <div class="sheet-talent-rest">{{spellrest}}</div>
        </div>
    </div>
</rolltemplate>