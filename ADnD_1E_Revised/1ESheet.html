<!--new character?-->
<input type="hidden" name="attr_old_character" value="0" />
<!--background hidden inputs-->
<input type="checkbox" name="attr_background" value="1" class="background-selection hidden" checked />
<input type="checkbox" name="attr_background" value="2" class="background-selection hidden" />
<input type="checkbox" name="attr_background" value="3" class="background-selection hidden" />
<input type="checkbox" name="attr_background" value="4" class="background-selection hidden" />
<input type="checkbox" name="attr_background" value="5" class="background-selection hidden" />
<input type="checkbox" name="attr_background" value="6" class="background-selection hidden" />

<!--option toggles-->
<input type="hidden" name="attr_is_npc" value="0" class="is-npc" />
<input type="hidden" name="attr_toggle_npc" value="0" class="toggle-npc" />
<input type="checkbox" name="attr_toggle_costs" value="1" class="toggle-costs hidden" />
<input type="checkbox" name="attr_toggle_caster2" value="1" class="toggle-caster2 hidden" checked />
<input type="checkbox" name="attr_toggle_thief_skills" value="1" class="toggle-thief-skills hidden" checked />
<input type="checkbox" name="attr_toggle_spells" value="1" class="toggle-spells hidden" />
<input type="checkbox" name="attr_toggle_nwp" value="1" class="toggle-nwp hidden" />
<input type="checkbox" name="attr_toggle_exceptional" value="1" class="toggle-exceptional hidden" checked />
<input type="checkbox" name="attr_toggle_comeliness" value="1" class="toggle-comeliness hidden" checked />
<input type="checkbox" name="attr_toggle_multiclass" value="1" class="toggle-multiclass hidden" />
<input type="checkbox" name="attr_toggle_psionics" value="1" class="toggle-psionics hidden" checked />
<input type="checkbox" name="attr_toggle_macros" value="1" class="toggle-macros hidden" checked />
<input type="checkbox" name="attr_toggle_single_column_attributes" class="toggle-single-column-attributes hidden" value="1" checked />
<input type="checkbox" name="attr_toggle_single_column_abilities" class="toggle-single-column-abilities hidden" value="1" checked />
<input type="checkbox" name="attr_toggle_single_column_notes" class="toggle-single-column-notes hidden" value="1" checked />
<input type="checkbox" name="attr_toggle_single_column_spells" class="toggle-single-column-spells hidden" value="1" checked />
<input type="checkbox" name="attr_toggle_critdamage" class="toggle-critdamage hidden" value="1" />
<input type="checkbox" name="attr_toggle_lbs" class="toggle-lbs hidden" value="1" />
<div class="background">
  <div class="wrapper">
    <!-- Sheet Header-->
    <section class="top-header">
      <!-- NPC/Monster toggle-->
      <section class="npc-toggle npc-tabs">
        <input type="radio" name="attr_toggle_npc" value="0" class="toggle-npc tab-hidden tab" title="Player Character" checked /><span class="tab"></span>
        <input type="radio" name="attr_toggle_npc" value="1" class="toggle-npc tab-hidden tab" title="Non-Player Character/Monster" /><span class="tab">Monster</span>
        <input type="radio" name="attr_toggle_npc" value="99" class="toggle-npc tab-hidden tab" title="Sheet Settings" /><span class="material-icons custom-btn-nav"></span>
      </section>
      <!-- Announcements -->
      <section class="announcements-box">
        <span class="pc-npc">
          <span class="inline-label" title="@{is_npc} | Indicates that the sheet is either a PC or NPC/Monster.">
            <input type="radio" class="width-smallest is-pc" name="attr_is_npc" value="0" checked /><span></span>
            <input type="radio" class="width-smallest is-npc" name="attr_is_npc" value="1" /><span></span>
          </span>
        </span>
        <input type="checkbox" class="sect-show" name="attr_toggle_announcements" value="1" title="Open to read about important sheet changes." checked />
        <span class="header announcements-title">i</span><span class="material-icons"></span>
        <div class="sect announcements">
          <h4>Important Sheet Announcements</h4>
          <h5 class="right two-columns">
            <span class="left">
              <span>v.<span name="attr_sheet_version">
            </span>
            <span class="right">4/30/24'</span>
          </h5>
          <ul>
            <li>The Revised sheet is now live! While the roll20 would not permit both versions of the 1e sheet to coexist, they have agreed to deprecate the old sheet. It will remain as-is for anyone that is currently using that sheet in their existing games and could possibly get future updates/changes. It will not show up as an available sheet for new games however. Only the Revised 1e sheet will be listed for new games going forward. Game creators using the old sheet can convert to the Revised sheet if/when they desire by changing the game settings character template to the "Advanced Dungeons & Dragons 1e sheet".</li>
            <li>Sheet.json has been updated to allow setting default values for most of the options found on the sheet's settings page. These Game/Campaign options are only available to game creators when using a live sheet template and will affect all future characters/NPC's created in-game.</li>
            <li>Bug Fix; the Initiative roll subtitle was incorrectly referencing the surprise_die selector. Roll was correct, but the title was not.</li>
            <li>Psionics option added. Uncheck Sheet Settings|Hide Areas|Psionics to reveal additional psionic-related fields under Special Abilities. Attack/Defensive Modes and Disciplines can be added as Special Abilities. I may add a Point Cost field to Special Abilities as well.</li>
            <li>Added an alternative Turn Undead roll that groups undead by "adjusted" HD. Expands the turn undead table beyond the MM.<span class="inline-label">See Dragonsfoot.com <button type="roll" class="url-roll" value="[www.dragonsfoot.org/Footprints #7](http://www.dragonsfoot.org/php4/archive.php?sectioninit=FT&fileid=175&watchfile=0)"><span>Footprints #7</span></button>e-zine for details.</span></li>
            <li>Bug fix; missing Damage buttons with attacks when creating a new attack from the Equipment|Weapon|+Add option.</li>
            <li>Made a small adjustment for the attack table output to work regardless of the Sidebar|Text Chat Options 'Enable Chat Timestamps' setting.</li>
            <li>Refined the Turn/Command Undead roll to check a given type of Undead vs all possible Undead. While the Turn Undead roll can be found in Sheet Settings|Misc. you can use the '+Add' to create a unique, non-synced, Special Ability that includes a chat menu button to roll the Turn Undead check from chat.</li>
            <li>Added a Turn Undead roll. Located in Sheet Settings|Misc. Reminder: nearly all the buttons on the sheet can be dragged to the macrobar and/or used in other macros to execute a sheet roll without having to open the sheet.</li>
            <li>Added dice icon to ability row rolls.</li>
            <li>Added Suprise Others roll.</li>
            <li>Added an auto-fill option for the Attack matrix tables. By default, the to-hit tables will auto-fill the table based on the class and level selected.</li>
            <li>Added "Light Greyhawk" and "Greyhawk" to background colors.</li>
            <li>Added "In Use" checkbox to attacks to better distinguish weapons that are armed, and on-the-ready.</li>
            <li>Added a warning indicator if the attack matrix values have not been filled out. to-Hit table values default to all "20's" otherwise.</li>
            <li>Fixed single column checkbox bug that required toggling the box to sync.</li>
            <li>Changed fractional HP field to prevent 'out of range' browser warnings.</li>
            <li>Changed most buttons to plain text.</li>
            <li>Updated repeating_equipment armor to hide meaningless fields in order to match their Armor Details counterpart.</li>
            <li>Added a Language roll button to post known languages to chat.</li>
            <li>Added option to 'Use Lbs' instead of gold pieces when determining encumbrance. Carying capacities and carried coin weight will be divided by 10. Per-item weights need to be entered as lbs in order for the sheet to properly calculate encumbrance. Leave STR allowance in gp as per Strength table. Strength allowance will be converted to lbs on the encumbrance table.</li>
            <li>Updated Thief Skill migration to better handle existing attributes and normal skill calcs.</li>
            <li>Climb Walls updated to allow decimals. in-turn, checks made when Climb Walls is 99.1 or greater will receive an additional d10/10 added to the roll as a fraction.</li>
            <li>Small darkmode adjustments.</li>
            <li>Added the pc/npc whisper options to image and info buttons. This also applies to clicking the sheet's image directly.</li>
            <li>Fix made to Saving Throw calc logic that would prevent entering "20" as the base value.</li>
            <li>Armor Details rows Other(2-6), AC and AR selectors have been changed from a base value(10 through 0) to a bonus(+0 through +10) to AC and AR.</li>
            <li>Unarmored fix to enable AC and AR calcs to work without requiring a name value for the unarmored row.</li>
            <li>Removed "Roll" from the repeating roll buttons.</li>
            <li>Updated the Special Ability macro to include "0 +" for the inline rolls to prevent a chat error if a non-number is used in the ability_die and/or ability_current_max fields. Roll template checks these inline rolls for numbers in order to show or hide info.</li>
            <li>Added rolls for Racial Notes and Special Senses.</li>
            <li>Small adjustments to text and layout.</li>
            <li>Added the ability to create an attack from Equipment|Weapons(sub-section). Using the "+ADD" button will create a unique(ie not linked to equipment) attack.</li>
            <li>Updated repeating_equipment sheetworker; split tab changes that set the hide/show attributes for all rows from the type and carry changes that only happen within a given row.</li>
            <li>Version check to correct equipment type:gear that could have erroneously been set to an out of range value instead of Gear.</li>
            <li>Small adjustment to repeating row edit:move handling.</li>
            <li>Fixed a bug in the Bulk load calculation incorrectly using "Heavy" as the baseline instead of "Normal".</li>
            <li>The Encumbered condition will remove any DEX bonus from AC calculations. There will also be a visual indicator (dashed-border w/small warning icon) added to the "Dex Adj." field when Encumbered as a helpful reminder.</li>
            <li>Added Weapon Proficiency total field. @{weapon_proficiency_total}</li>
            <li>Sheet portrait can now be clicked on to post the image to chat.</li>
            <li>Increased the Monster portrait image area. Avatar or URL images will fill the vailable space up to a 350px<sup>2</sup>.</li>
            <li>Updated Initiative and Surprise rolls to show Encumbrance penalties.</li>
            <li>Disabled repeating_equipment|armor| "armor details" attributes until an armor type has been selected. This helps ensure the proper fields are shown for armor type.</li>
            <li>Adjustment to exceptional abilities so that they will only be displayed if the Show Exceptional is unchecked in Sheet Settings and the ability is at least 18. Exceptional Strength is always shown regardless of the hide option.</li>
            <li>Fixed incorrect table data for STR and CON. Updated Open Doors macro to use % vs d6.</li>
            <li>Armor Bulk and Encumbrance are now used to auto-adjust the movement load indicator and speeds. Dex penalty and roll template bulk/encumbrance text are on the to-do list.</li>
            <li>Armor Details: the unArmored Base row has been included with repeating_equipment|armor sync. This row is designed to represent any non-armor "Base AC". ie monsters natural skin/hide or a PC's clothing.</li>
            <li>Fixed a bug with newly added equipment and the equipment_carried_select attr. While the select showed "carried", the weight calc was incorrectly using "0" (ie not carried), which is the default value for equipment_carried.</li>
            <li>Added an Auto-Calc Movement option. The movement load can be temporarily selected even if the auto-calc option is enabled but any changes to encumbrance, base movement, or opening the sheet will cause a re-calc. If Auto-Calc Movement is disabled, any manual changes to the movement load will be persistant.</li>
            <li>Fixed NPC image link roll.</li>
            <li>Fixed triggering event for total weight. Was not recalculating until sheet open.</li>
            <li>Fixed portrait image resize to be consistant between using the default avatar image or custom image url.</li>
            <li>Armor details on repeating_equipment has been moved into the expanded sub-section.</li>
            <li>Fixed equipment|armor|shield AC and AR dropdown selectors to match Armor Details.</li>
            <li>Added back the display of armor and weapon weight sub-totals to the bottom of the equipment section.</li>
            <li>Sheet Settings; expanded the "Reset" macros button to include buttons for each repeating section. Reseting simply clears the existing macro-text in order to use the most current default macros used for sheet rolls.</li>
            <li>Weapon weight and cost migration; one-time update checks existing repeating_weapon that have either weight or cost being tracked (ie non-zero value) and creates a copy of them to equipment|weapons if the weapon isn't already in equipment. Names must match exactly to be considered a match. "Matched" items are updated with the weapon weight and cost values. If a weapon is not having it's weight/cost tracked, it will be ignored. This was necessary in order to prevent adding multiple versions of the same weapon. ie variations of an attack. Add weapons to equipment|weapons manually to track weight/cost. Weight and Cost calcs are now included with equipment.</li>
            <li>Fixed a bug in the equipment default value update that set all equipment to carried.</li>
            <li>Fixed equipment type dropdown from teleporting to the matching tab view when the "All" tab is selected.</li>
            <li>Sync spell tab level view to match a spell level change.</li>
            <li>Fixed missing armor weight and cost for armor 1 when migrating older sheets.</li>
            <li>Added Caster Class 1 and Caster Class 2. Each class will have it's own spell/day grid. Repeating spells now include the caster class and the caster level. Caster Class 2 related sections are hidden by default but can be toggled visible in the sheet options. Spells can be sorted by Caster class.</li>
            <li>Added Save Type field to spells.</li>
            <li>Armor Details rows are now synced with repeating_equipment under Armor. Changes made to either should be reflected in both locations. There are now 6 "Other" rows that can be used for anything else that might effect AC. ie magical items and spells. Weight and Cost calcs are now included with equipment.</li>
            <li>Added two more custom rows to Armor Details section.</li>
            <li>Fixed a bug that caused a gap between repeating rows of spells.</li>
            <li>Added a url "Link" attribute and button to Spells, Equipment, Special Abilities, NWP, and Monster. Button sends a clickable "LINK" to chat. Link has also been added to the roll template.</li>
            <li>Toggling the sheet's role from PC to NPC will also change the main tab text to help indicate that the NPC sheet role can use both the 'Monster' tab and PC tab which gets renamed 'NPC' with this update. Toggle back to PC and the main tab displays 'PC' and hides the Monster tab.</li>
            <li>Added @{hitdice_total} to Class Details to Track total/effective Hit Dice for Spell effects and XP.</li>
            <li>Added a Custom Attributes section located on the settings page. Use custom attributes to track misc. adjustments for macros and mods. ie Ring of Protection +1 Saves, +1 AC.</li>
            <li>Expanded the Special Abilities to include additional fields/attributes to better handle SLA's and misc. Powers. New Abilities will automatically get the updated roll template for these new fields. Manually reset the macro-text(ie delete the current macro-text) to force the new default macro. To-do: Auto-update roll template for old/existing special abilities.</li>
            <li>New fields/attributes;
              <ul><b>- PC/NPC:</b> @{pc_image_link}, @{surprise_others_mod}, @{senses}, @{pc_image_link}, @{npc_image_link}, @{npc_link}</ul>
              <ul><b>- Spells:</b> @{priest_caster_level}, @{mage_caster_level}, @{spell_link}, @{spell_notes}</ul>
              <ul><b>- Special Abilities:</b> @{ability_effect_type}, @{ability_level}, @{ability_ct}, @{ability_range}, @{ability_duration}, @{ability_save}, @{ability_aoe}, @{ability_save_type}, @{ability_link}, @{ability_notes}</ul>
            </li>
            <li>Added URL fields and a button to post images and hyperlinks to chat.</li>
            <li>Fixed accidentally open/closing the collapsible areas by clicking the whitespace between repeating fields.</li>
            <li>Small adjustment to header spacing when an avatar has not been selected.</li>
          </ul>
          <!-- older updates-->
          <details>
            <summary>
              <h5>Older Updates...</h5>
            </summary>
            <ul>
              <li>Bug Fix: Typo prevented some of the Saving Throws (Spells, and Custom 1-3) from including the Misc and Temp values in the total.</li>
              <li>Sheet Settings: Fixed the hide Thief Skills option. Missing "checked" state in a hidden checkbox used to trigger hide/show areas of the sheet.</li>
              <li>Small changes to improve weapon Range field validation. Normal input will accept S/M/L ranges as numbers seperated by '/'. ie 1/2/3. You may also include single or double quotes as distance indicators. ie 1"/2"/3" or 10'/20'/30'. Entering a single value will result in all ranges using that value.</li>
              <li>NPC/Monster: added @{monsterHD} to help differentiate player class hit dice vs monster hit dice.</li>
              <li>Armor Details: Dex Adj. can be toggled to adjust AC for certain conditions.</li>
              <li>Added a PC/NPC radio selector. Located directly under the sheet "Announcements". @{is_npc} Added to the Default Settings page as well.</li>
              <li>Comeliness: added @{comeliness_base} which should represent the Comeliness rolled.ie un-adjusted.</li>
              <li>Sheet Rolls: macro-text for rolls have been updated to allow bonuses(in fields and/or the modifier prompts) to include the '+' symbol. ie '+2'. Prior to this update, including the plus symbol ie '+2' would result in a '++2' which would break the macro.</li>
              <li>Abilities: bonuses and penalties are now displayed with the appropriate +/- symbols as per the Ability table. The sheet used to show the mathematically correct value, but now shows the table value instead.</li>
              <li>Armor Details: changed Magic and Misc. Adj fields from dropdown selectors to regular input fields. Bonuses lower AC. Penalties raise AC. ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2. The AC calculations row has also been updated to display the inverted Defensive Adjustment for Dex as well as Armor Adj. and Shield Adj.</li>
              <li>Armor Details: Magic Adj. and Misc. Adj dropdowns have been expanded to allow -6(penalty) thru +6(bonus).</li>
              <li>Added Default Settings options(only available once the sheet goes live) that allow the game's creator to set sheet defaults. These will be applied to all new sheets automatically (ie npc, whispers, hide/show various areas, auto-calc ac, hp, crit damage, etc.), but can also be applied to ALL existing sheets through an additional in-game step from the 'My Settings' page, 'Apply Default Settings'.</li>
              <li>Repeating Weapons/Attacks: added weapon_ammo/weapon_ammo_max to help track arrows, bolts, etc. Ammo will be shown with ranged and ranged touch attacks. Also added weapon_num_attacks to indicate multiple/iterative attacks. Shown with Melee and Touch attacks. #Attacks is only serves as a visual indicator at this time. May be used in a future update to roll multiple attacks.</li>
              <li>Critical Damage: "Use Crit Damage" has been added to the sheet options. If enabled, natural 20 rolls will use Crit Damage in lieu of normal damage. Defaults to normal weapon damage x2 and can be modified per attack.</li>
              <li>Added Ability Checks(click an ability to make a roll). Defaults to 1d20 vs the Ability score, but the check can be customized from Sheet Settings|Ability Check die. </li>
              <li>Bug Fix: Range and Backstab fields were not toggling based on weapon_type.(melee, range, touch, ranged touch).</li>
              <li>Moved sheet Settings(gear icon) to the top tab bar.</li>
              <li>Comeliness: Charisma adjustment (same race) is auto-calculated.</li>
              <li>Sync HP option added to Class Details and Advanced Settings. Let the sheet sync Total HP from Class Details with HP ( @{hitpoints_max} )</li>
              <li>Sync AC option added to Armor Details and Advanced Settings. Enabling "Sync AC" will lock AC Total from Armor Details with AC ie @{armorclass} at the top of the sheet.</li>
              <li>Bug Fix: backstab adj. that were enabled for attacks were still active even when Thief Skills were hidden. Hiding Thief Skills also hides and disables Backstab adjustments.</li>
              <li>Dual-Wield: dual-wield primary and secondary penalty has been added to the top of the Weapons section. Directly below Weapon Proficiencies. ( @{dual_pen_primary} and @{dual_pen_secondary} ) Dual-wield penalties are calculated based on Dexterity. You can override these penalties locally, per attack, if desired.</li>
              <li>Armor Rating: clicking "Ignore AR" sets armorclass_rating and unarmored_base to "-".</li>
              <li>Choosing "Ranged Touch" will now accept a single range and or text in the Range field without displaying an input error. The Range field label also changes from "S/M/L" to "Range" which might avoid any confusion that you must enter three range values.</li>
              <li>Armor Rating has also been added to the top of the sheet. Matches AR found in the Armor Details section.</li>
              <li>Fixed Total Ac CALC. Bug was introduced after last the last changes for shields.</li>
              <li>Changed Size2 to "Temp Size" for both PC and NPC for consistency.</li>
              <li>Armor Details - Shield: the AC Rating and AC dropdown selectors have been changed to "+1 through +10". The bottom column totals, "In Use/Best" have also been updated to reflect a shield's impact on AC Rating and AC accordingly.</li>
              <li>Bug Fix: Shield AC was being included in the AC Base.</li>
              <li>Added Comeliness to non-weapon proficiencies dropdown selector for nwp checks/rolls. Also added two new fields to the Comeliness row to track CHA and Racial adjustments.</li>
              <li>Weapons: Range now includes three hidden attributes, weapon_range_short, weapon_range_medium, and weapon_range_long. While the weapon_range field excepts any text value, the preferred format should be three numbers separated by a forward slash. Dash, space, or comma should also work. ie '1/2/3', '10-20-30', '1 2 3', '1,2,3'. The sheet will attempt to extract the three range values but will show a red/gold border with red text if it cannot extract all three ranges.</li>
              <li>Weapons: added a new Attack Type selector to indicate "Melee, Ranged, Touch, or Ranged Touch". Mostly a visual indicator, but can also help differentiate attack types for API. Range and Fire Rate are hidden for Melee attacks. Backstab is hidden for Ranged attacks. Changed the older Dual-wield "Attack Type" attributes ie weapon_attack_type_pen to weapon_dual_pen and have also updated the macro-text accordingly.</li>
              <li>Morale check button added. Basic roll: d100 vs @{morale_base} + mod</li>
              <li>Backstab: the Backstab Multiplier,@{backstab} and Backstab Bonus,@{backstab_bonus} are now included with attack rolls. The multiplier defaults to "1", and the bonus defaults to "0" so they will not affect normal attacks. Enabling the "Backstab" checkbox on the attack adds the To-Hit bonus (defaults to "+4") to the attack roll and multiply weapon damage rolled. Any damage, magic, misc. bonuses are applied after the damage multiplier. The backstab checkbox is hidden if Sheet Settings|Hide Areas|Thief Skills is checked.</li>
              <li>Roll Templates: brought back alternating row shading.</li>
              <li>Added a one-time version check/update that auto-calcs ability rows, saves, and thief skills.</li>
              <li>Added a one-time version check/update that updates the macro-text for repeating weapons, abilities, nwp, and spells. Only unedited, default macro-text will be updated to the latest default roll automatically. Customized macro-text will be skipped. FYI: to force a field to update to the latest default, simply delete the text. Using the "Reset Now" button from within the Sheet Settings tab forces updates of multiple sheet-wide macro-text fields. Use with caution.</li>
              <li>Auto-updating ability stats. Completed: Strength, Intelligence(bonuslanguages only auto-fills for humans), Wisdom, Dexterity, Constitution(checks for fighter, paladin, or ranger, to expand bonuses past +2), Charisma.</li>
              <li>Attack Type: updated 'Normal' so that the roll template does not show '(Normal Attack)'. Only '(Primary Attack)' and '(Secondary Attack)' will be included with an attack roll.</li>
              <li>AC Details: added the option 'Auto-Calc AC'. Enabled by default so that any changes to the armor detail rows will auto-calculate the AC totals at the bottom of the section. The best AC at the top of the sheet is still manual so you may enter whatever you want regardless of any auto-calculated 'suggestions'. Also, the 'Calc AC' button can be used to force a re-calc regardless of the 'Auto-Calc AC' checkbox.</li>
              <li>Adjustments to help the roll templates better handle inserted images.</li>
              <li>Armor Details: added a column to list Bulk. Info tracking only. Not used in any calculations.</li>
              <li>Repositioned the Rear and Shieldless AC boxes to a vertical postion nearer AC. Made fields editable to match Armor Details.</li>
              <li>Armor Details: reworked this section as per forum discussions. Bottom row numbers can be manually changed and they will only gets auto-calculated, (based on the table above) if you use the "Calc AC" button.</li>
              <li>Added Secondary Skill field. Added Weapon Proficiency fields to the top of the Weapons section.</li>
              <li>NPC: attacks and special abilities will be shared between pc/npc. Same attributes.</li>
              <li>Settings: added "pink" and "darkpink" to the roll template options.(Khruc) and "colorized" the roll template selector to help visualize your selection. Also made a few small teaks to the header text contrast to help with a few of the color choices.</li>
              <li>NPC: added Save rolls. These are shared with the PC tab and use the Base number to keep things simple.</li>
              <li>Thief Functions: each row is now auto-calculated. While you can temporarily override the total, any changes made to the row will trigger a recalc. Special handling for pre-existing characters; older thief values will be copied to the Base column. This allows for the "new" total to still match the old value, but will auto-calc once the row is manually adjusted. New sheets default to level 1 Thief base values.</li>
              <li>Settings: Toggle Multi-Class fields. Toggle is also included inside the Class Details section.</li>
              <li>Settings: Toggles all macro-text fields. Only show when you want to edit rolls.</li>
              <li>Equipment: moved Wealth below the repeating equipment rows.</li>
              <li>Armor Details: Added No Armor/Natural field.</li>
              <li>NPC: added an Wears Armor checkbox. Used to indicate that the AC includes unnatural armor. Weapons vs Armor Type should apply. Unchecked by default. Uses a new attribute: @{armor_rating_flag}</li>
              <li>NPC: added Type. Uses the existing attribute: @{race}.</li>
              <li>PC/NPC: added Size and Temp Size. Size can be used for the Natural/Unaltered size, where as Temp Size can be used to track the current size. Uses new attributes: @{size} and @{size2}</li>
              <li>NPC: added a Secondary/Other movement field. Only the primary movement is used for sheet speed calcs. Uses a new attribute: @{movement2}</li>
              <li>NPC: No Apperaing will now expand to match text entered.</li>
              <li>Darkmode: More adjustments.</li>
              <li>Settings: Option to hide comeliness row.</li>
              <li>Darkmode: Fixed HP and AC weirdness.</li>
              <li>Special Abilities: added die and modifier. A roll will be included with the Special Ability roll only if the die field is more than 1d0 or if the modifier is greater than 0.</li>
              <li>Settings: added an Advanced Option to reset all sheet macros. **WARNING:** This option will clear all repeating macro-text which forces the macro fields to re-populate to the latest sheet defaults. Any customization/editing that was done to any existing macro-text fields will be lost if the reset option is utilized. I will include an auto-matic check and reset of non-edited macro-text once the sheet is ready to to go live. For testing purposes, using the Reset option is the easiest method to ensure the sheet is using the latest macros.</li>
              <li>Settings: added options to whisper PC and NPC rolls.</li>
              <li>Attacks: added Attack Type for dual wielding attacks. normal, primary, and secondary option. Penalties are auto-calculated and adjusted for Dex.</li>
              <li>Attacks: added Damage Type. Also displayed with damage rolls.</li>
              <li>Initiative and Surprise: exposed macro text in settings to allow for more customization.</li>
              <li>Fixed logo from being resized by roll20 image server which was causing the image to look blurry. Changed the logo to a background-image instead of an img element.</li>
              <li>Saves: each save row is now auto-calculated. While you can temporarily override the save total, any changes made to the row will trigger a recalc. Special handling for pre-existing characters; older save values will be copied to the Base/Class column. This allows for the "new" save total to still match the old value, but will auto-calc once the row is manually adjusted. New sheets default to 20.</li>
              <li>Hit Adj. vs AC type: Added additional fields beyond AC 2. ie 1 and 0.</li>
              <li>Attack row: alignment adjustments.</li>
              <li>Included a check that adds a single repeating row if no rows have been added. Serves as a placeholder entry.</li>
              <li>Updated navigational indicators (hide/show triangles have been changed to chevrons).</li>
              <li>Updated logo with a cleaner more scalable image. (Thanks David)</li>
              <li>Saves: removed Class Adj. column and added Temp. Adj.</li>
              <li>Added hide/show toggle for custom saves and custom thief functions.</li>
              <li>Minor adjustments to navigational section headings and button rolls.</li>
              <li>Adjustments made to help better control portrait image.</li>
              <li>Added some adjustments for dark mode.</li>
              <li>Bug Fix: Equip weight- newly added items were not calculating weight properly.</li>
              <li>Spells: changed Spell Type/School field to a datalist. Type to sort and choose, or enter any text.</li>
              <li>Made the sheet a "little" more friendly to resizing the journal window. YMMV...</li>
              <li>Attack Matrix: autofill to hit table automatically by selecting class/monster and level/HD.</li>
              <li>NPC/Monster(WIP): added a toggle at the top of the sheet to switch sheet from PC to NPC/Monster.</li>
              <li>Equipment: added carried options(yes,no,mount) with additional filtering(carried, not carried, mount). items that are not carried or on mount are not included in the character's weight calcs.</li>
              <li>Bug Fix: Spells - toggling memorized spells(wasn't actually filtering correctly...) and also prevented seeing a newly added spell. Oops.</li>
              <li>Spells: memorized spells will be slightly emphasized over non-prepared using a subtle opacity difference.</li>
              <li>Settings: additional toggles added to hide Thief Skills, Spells, and Non-Weapon Proficiencies.</li>
              <li>Notes: added repeating notes with the ability to output the note to chat with a roll.</li>
              <li>Created an additional roll template for the attack table that places the matrix/thac0 output directly below the attack roll in chat. Should take up less room in chat make it a little easier if/when the Hit Armor Type table is also used.</li>
              <li>Settings: added an option to either use a sheet's avatar or a custom url for the sheet's image/portrait.</li>
              <li>Font updates to the sheet and templates. Also added a linear gradient to the template header color.</li>
              <li>Attack Matrix and THAC0 table have been moved into the top of the Weapons section.</li>
              <li>Settings: toggle Attack Matrix or THAC0 table.</li>
              <li>Spells: toggle added to display memorized spells only.</li>
              <li>Updated Saving Throws to show Success/Failure.</li>
              <li>Repeating sections have been "condensed" and now include an option to expand the row for descriptions and macro-text.</li>
              <li>Equipment: added tabs to help organize items. Includes a expanding section with description, macro-text and a sheet roll. Currently I'm hiding weight and cost for armor and weapons since you can enter that info outside of equipment. I'm toward removing the weight and cost field from the other sections entirely and simply track those in one location, Equipment...</li>
              <li>Settings: added toggles to hide Costs and Exceptional Ability column.</li>
              <li>Carrying Capacities and Movement Rates beyond 'Normal' are now calculated by the sheet.</li>
              <li>Armor Details now has a carried option to handle armor weight.</li>
              <li>Armor Details; now includes a auto-calculations based off of the armor "matrix". Best selected/worn base will be used for AC. All selected/worn armor adjustment and magical adjustments are applied. Calcs, Rear, Shieldless, and Total AC. </li>
              <li>Still wrestling with how best to track multi-class hp. See the "Class Details" sub-section. Currently, the Total HP calc is all class hp+con/# of classes. Result can be a fraction for a multi-class character. Use this the Total HP result to determine what to enter in the HitPoint|max field. There is a spot to track any fractional HP if desired.</li>
              <li>Sheet has now been converted over to be CSE(character sheet enhancement) mode and will break if the sheet is loaded in as a Custom game as Legacy.</li>
              <li>added additional custom rows for saves and thief functions.</li>
              <li>Added a Weapon Proficiency adj. checkbox toggle. Non-proficiency(unchecked) reveals a "penalty" field. Sheet auto-calcs weapon_prof_pen based on checkbox state and weapon_prof value. @{weapon_prof_pen} has been added to the default attack macro-text.</li>
              <li>Added to hit vs armor type adj. Incldes a checkbox to toggle the table with the attack roll. Sheet auto-calcs whether to use "{{ToHitACadj2to10}}" or "{{ToHitACadj2to10=<complete hit adj. by armor type table values>}}" and saves this value to @{weapon_ToHitACadj} which has been added to the default attack macro-text.</li>
              <li>Small updates to the roll template to better accommodate the To Hit table.</li>
              <li>All the older table data has been replaced. Moving to a grid/flex-based layout should help to make future changes easier.</li>
              <li>Settings; Init and Surprise have a "die" option in the settings(located in the footer). d6 is the default. Hide/Show Costs has not been enabled yet.</li>
              <li>Still planning to auto-hide the extra class and levels fields at the top of the sheet if not a multi-class.</li>
              <li>Continuing to convert sheet layout from tables (only the roll templates are left to convert...)</li>
              <li>Added a character portrait that pulls the sheet's avatar. Todo: add a default image(generic siloute) in cases where there is not an image to pull or if it's not desired.</li>
              <li>Working out a better class sub-section to better handle tracking xp and hp calcs for multiclass. Currently all manual entry, but auto-calculation "possibly" planned for hitpoints|max.</li>
              <li>Added additional types of AC. ie Shieldless, Surprised, and Rear.</li>
              <li>Updated some of the ability-based rolls to show target/threshold number as well as any adjustments included with the roll.</li>
              <li>Updated Mental Save macro. 1d20+wis adj + query adj</li>
              <li>Saving throw "matrix" added to handle multiple adjustments for saving throws. ie ability, racial, class, and misc. Currently all manual entry, but auto-calculation planned for the total of each type of saving throw. Also added an additional custom save row.</li>
              <li>Updated saving throw rolls to show target/threshold and any adjustments included with the roll. Removed the success/fail border indicator for now... since it did not actually work correctly when appling modifiers. Border color was only based on the raw roll(system limitation). This will be addressed once the roll templates are updated.</li>
              <li>Added notes for armor/defenses, racial, history/bio, and saving throws.</li>
              <li>Thief skills now uses a matrix layout similar to saves. Add additional attributes to track adj. Also added an additional custom save row.</li>
            </ul>
          </details>
        </div>
      </section>
    </section>
    <!-- NPC/Monster statblock1-4 -->
    <section class="npc-box statblock1">
      <input type="text" class="height-short text-large left" name="attr_character_name" title="@{character_name}" placeholder="Character Name" style="width: calc(50vw - 3em);min-width:17.5em;" />
      <span class="inline-label">
        <label>
          <span>TYPE:</span>
          <input type="text" name="attr_race" value="" title="@{race}" placeholder="Type, Race, etc." style="width: calc(49vw - 6em); min-width:14em;" />
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>FREQUENCY:</span>
          <select name="attr_frequency">
            <option selected>Nil</option>
            <option>Very rare</option>
            <option>Rare</option>
            <option>Uncommon</option>
            <option>Common</option>
            <option>Unique</option>
          </select>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>NO. APPEARING:</span>
          <span class="autoexpand">
            <input type="text" name="attr_number_appearing" value="1" />
            <span name="attr_number_appearing"></span>
          </span>
        </label>
      </span>
      <span class="inline-label split">
        <label style="min-width:8.5em">
          <span>ARMOR CLASS:</span>
          <input type="text" class="width-smallest field-border" name="attr_armorclass" title="@{armorclass} | Best AC." value="10" style="text-align:center; padding:0;">
        </label>
        <label class="label-under-small width-auto">
          <span>
            <span>AR:</span>
            <select name="attr_unarmored_base" title="@{unarmored_base}" class="width-small">
              <option value="10" selected>10</option>
              <option value="9">9</option>
              <option value="8">8</option>
              <option value="7">7</option>
              <option value="6">6</option>
              <option value="5">5</option>
              <option value="4">4</option>
              <option value="3">3</option>
              <option value="2">2</option>
              <option value="1">1</option>
              <option value="0">0</option>
              <option value="-">-</option>
            </select>
          </span>
          <label title="AC is not from armor. Weapons vs Armor Type does not apply.">
            <input type="checkbox" name="attr_armor_rating_flag" value="1">
            <span>Ignore</span>
          </label>
        </label>
      </span>
      <span class="inline-label split">
        <label title="Primary Movement. NOTE: only the Primary movement is used for sheet calculations.">
          <span>MOVE:</span>
          <input type="text" class="width-small-plus" name="attr_movement" title="@{movement}" value="12" />
        </label>
        <label title="Other Movement. NOTE: not used for sheet calculations.">
          <span>OTHER:</span>
          <input type="text" class="width-small-plus" name="attr_movement2" title="@{movement2}" value="" placeholder="Nil" />
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>HIT DICE:</span>
          <input type="text" class="width-small" name="attr_monsterHD" title="@{monsterHD}" value="" placeholder="Nil" />
        </label>
        <label>
          +
          <input type="text" class="width-small" name="attr_monsterHD_bonus" title="@{monsterHD_bonus}" value="0" />
        </label>
        <label>
          <span>HIT POINTS:</span>
          <input type="text" class="field-border" name="attr_hitpoints" title="@{hitpoints}" value="0" style="text-align:center; padding:0;" />
        </label>
        <label>/
          <input type="text" class="width-small" name="attr_hitpoints_max" title="@{hitpoints_max}" value="0" />
        </label>
      </span>
    <span class="inline-label split" style="margin-left: 15%;">
      <label class="label-percent">
        <button class="dice-button text-only btn ui-draggable" type="roll" name="attr_morale-roll" title="%{selected|morale-roll} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Morale Check}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{morale_base}[BASE] + ( ?{Modifier?|0}[MOD] ) ]]%}} {{mod_applied=[[ ?{Modifier?|0} ]]%}}">
        <span>MORALE</span>
        </button>
        <input type="text" class="width-smaller" name="attr_morale_base" title="@{morale_base} | Base is 50%. Adjust +/- per circumstances." value="50">
      </label>
    </span>
      <span class="inline-label split">
        <label>
          <span>% IN LAIR:</span>
          <input type="text" class="width-small" name="attr_lair" title="@{lair}" value="" placeholder="Nil" />
        </label>
        <label>
          <span>TREASURE TYPE:</span>
          <input type="text" class="width-fill" name="attr_treasure_type" title="@{treasure_type}" value="" placeholder="Nil" />
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>NO. OF ATTACKS:</span>
          <input type="text" class="width-small" name="attr_number_of_attacks" title="@{number_of_attacks}" value="1" />
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>DAMAGE/ATTACK:</span>
          <textarea class="height-short" name="attr_attack_damage" title="@{attack_damage}" value="" placeholder="e.g. 1d4/1d4/1d6"></textarea>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <button type="roll" class="dice-button text-only" name="roll_senses_roll" title="%{selected|senses_roll}" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Senses}} {{freetext=@{senses}}}"><span>SENSES:</span>
          </button>
          <textarea class="height-short" name="attr_senses" title="@{senses}" placeholder="Nil"></textarea>
        </label>
      </span>
    </section>
    <section class="npc-box statblock2">
      <span class="inline-label">
        <label>
          <span>SPECIAL ATTACKS:</span>
          <textarea class="height-short" name="attr_special_attacks" title="@{special_attacks}" placeholder="Nil"></textarea>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>SPECIAL DEFENSES:</span>
          <textarea class="height-short" name="attr_special_defenses" title="@{special_defenses}" placeholder="Nil"></textarea>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>WEAKNESSES:</span>
          <textarea class="height-short" name="attr_weaknesses" title="@{weaknesses}" placeholder="Nil"></textarea>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>MAGIC RESISTANCE:</span>
          <textarea class="height-short" name="attr_magic_resistance" title="@{magic_resistance}" placeholder="Nil"></textarea>
        </label>
      </span>
      <div class="five-columns center">
        <label class="label-under">
          <button type="roll" class="text-only" name="roll_saveparalysispoisondeath" title="%{selected|saveparalysispoisondeath} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Paralysis, Poison or Death Magic}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{saveparalysispoisondeath}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Paralysis, Poison, or Death</span></button>
          <input type="text" class="width-smaller border" name="attr_saveparalysispoisondeath_base" title="@{saveparalysispoisondeath_base}" value="20">
        </label>
        <label class="label-under">
          <button class="text-only" type="roll" name="roll_savepetrificationpolymorph" title="%{selected|savepetrificationpolymorph} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Petrification or Polymorph}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savepetrificationpolymorph}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Petrification or Polymorph</span></button>
          <input type="text" class="width-smaller border" name="attr_savepetrificationpolymorph_base" title="@{savepetrificationpolymorph_base}" value="20">
        </label>
        <label class="label-under">
          <button type="roll" class="text-only" name="roll_saverodsstaveswands" title="%{selected|saverodsstaveswands} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Rods, Staves, or Wands}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{saverodsstaveswands}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Rods, Staves, Wands</span></button>
          <input type="text" class="width-smaller border" name="attr_saverodsstaveswands_base" title="@{saverodsstaveswands_base}" value="20">
        </label>
        <label class="label-under">
          <button type="roll" class="text-only" name="roll_savebreathweapons" title="%{selected|savebreathweapons} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Breath Weapon}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savebreathweapons}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Breath Weapon</span></button>
          <input type="text" class="width-smaller border" name="attr_savebreathweapons_base" title="@{savebreathweapons_base}" value="20">
        </label>
        <label class="label-under">
          <button type="roll" class="text-only" name="roll_savespells" title="%{selected|savespells} | NPC Roll" value="@{whisper_npc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Spells}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savespells}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Spells</span></button>
          <input type="text" class="width-smaller border" name="attr_savespells_base" title="@{savespells_base}" value="20">
        </label>
      </div>
      <span class="inline-label">
        <label>
          <span>LANGUAGES:</span>
          <textarea class="height-short" name="attr_languages" title="@{languages}" placeholder="languages known"></textarea>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>INTELLIGENCE:</span>
          <select name="attr_intelligence_npc" title="@{intelligence_npc}">
            <option selected>Nil</option>
            <option>Non-intelligent/not ratable</option>
            <option>Animal intelligence</option>
            <option>Semi-intelligent</option>
            <option>Low intelligence</option>
            <option>Average (human) intelligence</option>
            <option>Very intelligent</option>
            <option>Highly intelligent</option>
            <option>Exceptionally intelligent</option>
            <option>Genius-level intelligence</option>
            <option>Supra-genius</option>
            <option>Godlike intelligence</option>
          </select>
        </label>
      </span>
      <span class="inline-label">
        <textarea class="height-short" name="attr_intelligence_npc2" title="@{intelligence_npc2}" value="" placeholder="notes"></textarea>
      </span>
      <span class="inline-label">
        <label>
          <span>ALIGNMENT:</span>
          <input type="text" class="width-medium" name="attr_alignment" title="@{alignment}" />
        </label>
      </span>
      <span class="inline-label split">
        <label title="Natural/Unaltered size.">
          <span>SIZE:</span>
          <select name="attr_size" title="@{size}">
            <option>S</option>
            <option selected>M</option>
            <option>L</option>
          </select>
        </label>
        <label title="Current/Altered size.">
          <span>Temp Size:</span>
          <select name="attr_size2" title="@{size2}">
            <option>S</option>
            <option selected>M</option>
            <option>L</option>
          </select>
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>PSIONIC ABILITY:</span>
          <input type="text" class="width-medium" name="attr_psionic_ability" title="@{psionic_ability} | Use Special Abilities to add Attack/Defensive Modes, and Specialties." value="" placeholder="Nil" />
        </label>
        <label class="inline-label" title="@{toggle_psionics} | Hides Psionic-related fields found within Special Abilities.">
          <span>Psionics:</span>
          <input type="checkbox" name="attr_toggle_psionics" value="1" checked="">
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>Attack/Defense Modes</span>
          <input type="text" class="width-medium" name="attr_psionic_modes" title="@{psionic_modes}" value="" placeholder="Nil" />
        </label>
      </span>
      <span class="inline-label">
        <label>
          <span>LEVEL/XP VALUE:</span>
          <input type="text" class="width-large" name="attr_level_xp_value" title="@{level_xp_value}" value="" placeholder="Nil" />
      </span>
      <label class="inline-label">
        <button type="roll" class="image-link" value="@{whisper_npc} [**LINK**](@{sheet_image_url})" title="Send image to chat."></button>
        <textarea class="image-link" wrap="off" name="attr_sheet_image_url" title="@{sheet_image_url} | Enter a valid image URL that ends with a proper image extension. ie .png, .jpg, .gif If needed, trim the url to the end of the image extension or add a 3-letter extension to the end of the url.." placeholder="https://www.example.com/image.jpg"></textarea>
        <button type="roll" class="info-link" value="@{whisper_npc} [**LINK**](@{npc_link})" title="Send link to chat."></button>
        <textarea class="info-link" wrap="off" name="attr_npc_link" title="@{npc_link}" placeholder="https://www.example.com"></textarea>
      </label>
    </section>
    <section class="npc-box statblock3">
      <input type="checkbox" class="hidden toggle-avatar" name="attr_sheet_image" value="1" checked />
      <div class="image-avatar" name="attr_sheet_image_url" title="Send image to chat.">
        <img name="attr_character_avatar" />
        <!-- <button type="roll" class="image-link" value="@{whisper_npc} @{sheet_image_src}"></button> -->
        <button type="action" name="act_postimage" class="image-link"></button>
        <input type="hidden" name="attr_sheet_image_src" />
      </div>
    </section>
    <section class="npc-box statblock3-span">
      <span class="inline-label wrap">
        <label>
          <button class="dice-button text-only" type="roll" name="attr_init-roll" title="%{selected|init-roll}" value="@{whisper_npc} @{init_macro_text}"><span>INITIATIVE</span></button>
        </label>
        <label>
          <button class="dice-button text-only" type="roll" name="attr_surprise-roll" title="%{selected|surprise-roll}" value="@{whisper_npc} @{surprise_macro_text}"><span>SURPRISE</span></button>
        </label>
        <label class="auto-width right">
          <span>Surprise Chance</span>
          <input type="text" class="width-smaller" name="attr_surprise" title="@{surprise}" value="2" />
        </label>
        <label class="auto-width left">
          <select name="attr_surprise_die" class="width-medium" title="@{surprise_die}">
            <option value="6" selected>of 6</option>
            <option value="8">of 8</option>
            <option value="10">of 10</option>
            <option value="12">of 12</option>
            <option value="20">of 20</option>
            <option value="100">of 100</option>
          </select>
        </label>
        <label class="auto-width">
            <button type="roll" class="dice-button text-only" name="roll_surprise_others-roll" title="%{selected|surprise_others-roll}" value="@{whisper_npc} @{surprise_others_macro_text}">
              <span>Surprise Others</span>
            </button>
            <span>Adj.</span>
          <input type="text" class="width-smaller" name="attr_surprise_others_mod" title="@{surprise_others_mod} | The modifier is typically indicated as bonus although the value is SUBTRACTED from the opponents Surprise check." value="0" />
        </label>
      </span>
    </section>
    <section class="npc-box statblock4">
      <textarea name="attr_npc_notes" title="@{npc_notes}" placeholder="Enter Notes/Description..." style="height:100%;"></textarea>
    </section>
    <!-- Header -->
    <section class="header-box">
      <!--Details-->
      <div class="heading-box">
        <input type="text" class="width-fill border text-large" name="attr_character_name" title="@{character_name}" placeholder="Character Name">
        <label class="inline-label">
          <span>Race:</span>
          <input type="text" class="width-fill" name="attr_race" title="@{race}" placeholder="Description" />
        </label>
        <label class="inline-label">
          <span>Alignment:</span>
          <input type="text" class="width-fill" name="attr_alignment" title="@{alignment}" placeholder="Description" />
        </label>
        <label class="inline-label">
          <span>Class:</span>
          <input type="text" name="attr_class" title="@{class}" placeholder="Class" />
          <span class="toggle-multiclass">Lvl:</span>
          <input type="text" class="toggle-multiclass width-smaller" name="attr_level" title="@{level}" value="0" />
        </label>
        <label class="inline-label toggle-multiclass">
          <span>Class:</span>
          <input type="text" name="attr_secondclass" title="@{secondclass}" placeholder="Class" />
          <span>Lvl:</span>
          <input type="text" class="width-smaller" name="attr_level_2" title="@{level_2}" value="0" />
        </label>
        <label class="inline-label toggle-multiclass">
          <span>Class:</span>
          <input type="text" name="attr_thirdclass" title="@{thirdclass}" placeholder="Class" />
          <span>Lvl:</span>
          <input type="text" class="width-smaller" name="attr_level_3" title="@{level_3}" value="0" />
        </label>
        <label class="inline-label toggle-multiclass-swap">
          <span>Lvl:</span>
          <input type="text" class="width-smaller" name="attr_level" title="@{level}" value="0" />
          <span>XP:</span>
          <input type="text" class="width-medium" name="attr_xp" title="@{xp}" value="0" />
          <span class="inline-label">
            <input type="checkbox" name="attr_xp_bonus" title="@{xp_bonus}" value="1" />
            <span>10%</span>
          </span>
        </label>
      </div>
      <!-- Logo and HP/AC-->
      <div class="logo-box center">
        <span class="span-all normalmode">
          &nbsp;
        </span>
        <span class="span-all darkmode">
          &nbsp;
        </span>
        <span class="span-two two-columns">
          <label>
            <span class="text-large left">HP</span>
            <span class="heart">
              <input type="text" class="heart-input" name="attr_hitpoints" title="@{hitpoints} | Current Hit Points." value="0" />
            </span>
            <span>/</span>
            <input type="text" class="width-smaller" name="attr_hitpoints_max" title="@{hitpoints|max} | Maximum Hit Points. No Damage." value="0" style="height: 2em;" />
            <span class="sync-lock" title="@{sync_hp_flag} | Let the sheet sync Total HP from Class Details with HP ( @{hitpoints_max} ).">
              <input type="checkbox" name="attr_sync_hp_flag" value="1" />
              <span></span>
            </span>
          </label>
          <label>
            <span class="text-large">AC</span>
            <span class="shield">
              <input type="text" class="shield-input" name="attr_armorclass" title="@{armorclass} | Best AC." value="10" />
            </span>
            <span class="sync-lock" title="@{sync_ac_flag} | Let the sheet sync Total AC from Armor Details with AC ( @{armorclass} ).">
              <input type="checkbox" name="attr_sync_ac_flag" value="1" />
              <span></span>
            </span>
          </label>
          <span class="class-details">
            <input type="checkbox" class="sect-show" name="attr_class_details_show" value="1" checked />
            <span class="subheader">Class Details</span><span class="material-icons"></span>
          </span>
          <span class="armor-details">
            <input type="checkbox" class="sect-show" name="attr_armor_details_show" value="1" checked />
            <span class="subheader">Armor Details</span><span class="material-icons"></span>
          </span>
        </span>
        <span class="ac-columns">
          <label class="label-under" title="@{armorclass_shieldless} | Best AC without a Shield bonus.">
            <input type="text" class="readonly-span width-smaller" name="attr_armorclass_shieldless" title="@{armorclass_shieldless} | Best AC without a Shield bonus." value="0" />
            <span class="text-medium">Shieldless</span>
          </label>
          <label class="label-under" title="@{armorclass_rear} | Best AC without a Dex bonus.">
            <input type="text" class="readonly-span width-smaller" name="attr_armorclass_rear" title="@{armorclass_rear} | Best AC without a Dex bonus." value="0" />
            <span class="text-medium">Rear</span>
          </label>
          <label class="label-under" title="@{armorclass_rating} | Best Armor Rating">
            <input type="text" class="readonly-span width-smaller" name="attr_armorclass_rating" value="-" />
            <span class="text-medium">AR</span>
          </label>
        </span>
      </div>
      <!-- Portrait -->
      <div class="portrait-box">
        <input type="checkbox" class="hidden toggle-avatar" name="attr_sheet_image" value="1" checked />
        <div class="image-avatar" name="attr_sheet_image_url" title="Send image to chat.">
          <img name="attr_character_avatar" />
          <!-- <button type="roll" class="image-link" value="@{whisper_pc} @{sheet_image_src}"></button> -->
          <button type="action" name="act_postimage" class="image-link"></button>
        </div>
      </div>
    </section>
    <!-- Class Details -->
    <section class="class-box">
      <input type="checkbox" class="sect-show" name="attr_class_details_show" value="1" checked />
      <div class="sect header">CLASS DETAILS</div>
      <span class="sect material-icons"></span>
      <div class="sect border">
        <span class="class-columns column-header">
          <span>Class</span>
          <span>Lvl</span>
          <span>HD</span>
          <span>HP/Level</span>
          <span></span>
          <span>HP+Con</span>
          <span></span>
          <span>XP</span>
          <span>Next Level</span>
          <span>+10%</span>
        </span>
        <span class="class-columns">
          <input type="text" class="width-fill" name="attr_class" title="@{class}" placeholder="Class" />
          <input type="text" class="width-smaller" name="attr_level" title="@{level}" value="0" />
          <input type="text" class="width-medium" name="attr_hitdice" title="@{hitdice}" value="" placeholder="1d6" />
          <textarea class="width-medium-plus" name="attr_hitpoints_1_tracked" title="@{hitpoints_1_tracked} | Track rolled HP + CON adjustments per level." placeholder="Track HP 1 hp+con 2 hp+con 3 hp+con etc."></textarea>
          <span class="text-large">=</span>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_hitpoints_1_class_error" value="1" checked />
          <input type="text" class="width-small" name="attr_hitpoints_1_class" title="@{hitpoints_1_class} | Enter a running total of HP+CON." value="0" />
          <span></span>
          <input type="text" class="width-medium" name="attr_xp" title="@{xp}" value="0" />
          <input type="text" class="width-medium" name="attr_xp_next" title="@{xp_next}" value="0" />
          <input type="checkbox" name="attr_xp_bonus" title="@{xp_bonus} | XP bonus applies. Primary ability threshold met or exceeded for the class." value="1" />
        </span>
        <span class="class-columns toggle-multiclass">
          <input type="text" class="width-fill" name="attr_secondclass" title="@{secondclass}" placeholder="2rd class" />
          <input type="text" class="width-smaller" name="attr_level_2" title="@{level_2}" value="0" />
          <input type="text" class="width-medium" name="attr_hitdice_2" title="@{hitdice_2}" value="" placeholder="1d6" />
          <textarea class="width-medium-plus" name="attr_hitpoints_2_tracked" title="@{hitpoints_2_tracked} | Track rolled HP + CON adjustments per level." placeholder="Track HP 1 hp+con 2 hp+con 3 hp+con etc."></textarea>
          <span class="text-large">=</span>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_hitpoints_2_class_error" value="1" checked />
          <input type="text" class="width-small" name="attr_hitpoints_2_class" title="@{hitpoints_2_class} | Enter a running total of HP+CON." value="0" />
          <span></span>
          <input type="text" class="width-medium" name="attr_xp_2" title="@{xp_2}" value="0" />
          <input type="text" class="width-medium" name="attr_xp_2_next" title="@{xp_2_next}" value="0" />
          <input type="checkbox" name="attr_xp_2_bonus" title="@{xp_2_bonus} | XP bonus applies." value="1">
        </span>
        <span class="class-columns toggle-multiclass">
          <input type="text" class="width-fill" name="attr_thirdclass" title="@{thirdclass}" placeholder="3rd class" />
          <input type="text" class="width-smaller" name="attr_level_3" title="@{level_3}" value="0" />
          <input type="text" class="width-medium" name="attr_hitdice_3" title="@{hitdice_3}" value="" placeholder="1d6" />
          <textarea class="width-medium-plus" name="attr_hitpoints_3_tracked" title="@{hitpoints_3_tracked} | Track rolled HP + CON adjustments per level." placeholder="Track HP 1 hp+con 2 hp+con 3 hp+con etc."></textarea>
          <span class="text-large">=</span>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_hitpoints_3_class_error" value="1" checked />
          <input type="text" class="width-small" name="attr_hitpoints_3_class" title="@{hitpoints_3_class} | Enter a running total of HP+CON." value="0" />
          <span></span>
          <input type="text" class="width-medium" name="attr_xp_3" title="@{xp_3}" value="0" />
          <input type="text" class="width-medium" name="attr_xp_3_next" title="@{xp_3_next}" value="0" />
          <input type="checkbox" name="attr_xp_3_bonus" title="@{xp_3_bonus} | XP bonus applies." value="1">
        </span>
        <hr class="toggle-multiclass">
        <span class="class-columns">
          <label>
            <span>Hide Multi-Class:</span>
            <input type="checkbox" name="attr_toggle_multiclass" value="1" title="@{toggle_multiclass}" />
          </label>
          <label></label>
          <label class="label-under-small" title="@{hitdice_total} | Track total/effective Hit Dice for Spell effects and XP. Single class = level. Multi-class = highest level + 1. Three classes = highest level +2.">
            <input type="text" class="width-small" name="attr_hitdice_total" value="0" />
            <span>Total HD</span>
          </label>
          <span class="hp-calc-columns" style="margin-left: -10%;">
            <label class="label-under toggle-multiclass" title="@{hitpoints_class_total} | Uses the total HP+Con from table above." style="margin-left: 44%;">
              <input type="text" class="width-small" name="attr_hitpoints_class_total" value="0" readonly>
              <span>Total</span>
            </label>
            <label></label>
            <label class="label-under-small toggle-multiclass">
              <input type="text" class="width-small" name="attr_hp_quotient" title="@{hp_quotient}" value="0" readonly />
              <span>/Classes</span>
            </label>
            <label class="text-large toggle-multiclass">=</label>
            <label class="label-under" title="@{hitpoints_total} | Max Hit Points.">
              <input type="text" class="width-small" name="attr_hitpoints_total" value="0" readonly />
              <span>TOTAL HP</span>
            </label>
            <label class="toggle-multiclass span-two" title="@{hitpoints_remainder_total} | Used to track any remainder HP that would be lost due to rounding for mult-class characters.">
              <span class="center">Partial HP:</span>
              <input type="number" class="width-auto" name="attr_hitpoints_remainder_total" value="0" step=".01" />
            </label>
            <label class="sync-lock" title="@{sync_hp_flag} | Let the sheet sync Total HP from Class Details with HP ( @{hitpoints_max} ).">
              <span class="center">Sync HP:</span>
              <input type="checkbox" name="attr_sync_hp_flag" value="1" />
              <span></span>
            </label>
          </span>
        </span>
      </div>
    </section>
    <!-- Armor Details-->
    <section class="armor-box">
      <input type="checkbox" class="sect-show" name="attr_armor_details_show" value="1" checked />
      <div class="sect header">ARMOR DETAILS</div>
      <span class="sect material-icons"></span>
      <!-- used to sync armor details to repeating_equipment-->
      <input type="hidden" name="attr_unarmored_row_id" value="0" />
      <input type="hidden" name="attr_armortype1_row_id" value="0" />
      <input type="hidden" name="attr_armortype2_row_id" value="0" />
      <input type="hidden" name="attr_armorshield_row_id" value="0" />
      <input type="hidden" name="attr_armorhelmet_row_id" value="0" />
      <input type="hidden" name="attr_armorother1_row_id" value="0" />
      <input type="hidden" name="attr_armorother2_row_id" value="0" />
      <input type="hidden" name="attr_armorother3_row_id" value="0" />
      <input type="hidden" name="attr_armorother4_row_id" value="0" />
      <input type="hidden" name="attr_armorother5_row_id" value="0" />
      <input type="hidden" name="attr_armorother6_row_id" value="0" />
      <input type="hidden" name="attr_armordetails_array" value="0" />
      <!--
        holds the old armor details attributes moved to repeating_equipment
        and is also used to get armor weight sub-total
      -->
      <input type="hidden" name="attr_armor_weight" value="0" />
      <input type="hidden" name="attr_unarmored_weight" value="0" />
      <input type="hidden" name="attr_armortype2_weight" value="0" />
      <input type="hidden" name="attr_armorshield_weight" value="0" />
      <input type="hidden" name="attr_armorhelmet_weight" value="0" />
      <input type="hidden" name="attr_armor_cost" value="0" />
      <input type="hidden" name="attr_unarmored_cost" value="0" />
      <input type="hidden" name="attr_armortype2_cost" value="0" />
      <input type="hidden" name="attr_armorshield_cost" value="0" />
      <input type="hidden" name="attr_armorhelmet_cost" value="0" />

      <div class="sect border">
        <span class="armor-columns column-header">
          <span>Armor Type</span>
          <span title="Only worn items are included in the AC calculations below.">In Use</span>
          <span>Name</span>
          <span title="Armor Class">AC</span>
          <span title="Armor Rating for weapon vs armor adjustments.">AR</span>
          <span title="Magical Bonuses to AC.">Magic</span>
          <span title="Misc adjustments to AC.">Misc</span>
          <span title="Items in use are carried, but items not in use can still be carried.">Carried</span>
          <span title="Armor Bulk affects movement.">Bulk</span>
        </span>
        <span class="armor-columns">
          <label class="stack-text"><span>UnArmored Base</span></label>
          <input type="checkbox" name="attr_unarmored_worn" value="1" title="@{unarmored_worn}" checked />
          <input type="text" class="width-fill" name="attr_unarmored" value="" title="@{unarmored} | Use for Unarmored, Clothing, Natural Armor, etc." placeholder="non-armor" />
          <select name="attr_unarmored_ac" title="@{unarmored_ac} | Enter the actual AC value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <select name="attr_unarmored_base" title="@{unarmored_base} | Enter the actual AR value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
            <option value="-">-</option>
          </select>
          <span></span>
          <span></span>
          <input type="checkbox" name="attr_unarmored_carried" value="1" title="@{unarmored_carried} | In use/worn cannot be un-carried." checked />
          <select class="width-fill" name="attr_unarmored_bulk" title="@{unarmored_bulk}">
            <option value="0" selected>n/a</option>
            <option value="1">non-Bulky 12"</option>
            <option value="2">Fairly 9"</option>
            <option value="3">Bulky 6"</option>
          </select>
        </span>
        <span class="armor-columns">
          <label><span>Armor 1</span></label>
          <input type="checkbox" name="attr_armortype_worn" title="@{armortype_worn}" value="1" checked />
          <input type="text" class="width-fill" name="attr_armortype" title="@{armortype}" placeholder="Description" />
          <select name="attr_armortype_ac" title="@{armortype_ac} | Enter the actual AC value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
            <!-- additional range to handle magrating AC-->
            <option class="hidden" value="-1">-1</option>
            <option class="hidden" value="-2">-2</option>
            <option class="hidden" value="-3">-3</option>
            <option class="hidden" value="-4">-4</option>
            <option class="hidden" value="-5">-5</option>
            <option class="hidden" value="-6">-6</option>
            <option class="hidden" value="-7">-7</option>
            <option class="hidden" value="-8">-8</option>
            <option class="hidden" value="-9">-9</option>
            <option class="hidden" value="-10">-10</option>
          </select>
          <select name="attr_armortype_base" title="@{armortype_base} | Enter the actual AR value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armortype_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armortype_magic" value="0" title="@{armortype_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <input type="checkbox" name="attr_armortype_carried" value="1" title="@{armortype_carried} | In use/worn cannot be un-carried." checked />
          <select class="width-fill" name="attr_armortype_bulk" title="@{armortype_bulk}">
            <option value="0" selected>n/a</option>
            <option value="1">non-Bulky 12"</option>
            <option value="2">Fairly 9"</option>
            <option value="3">Bulky 6"</option>
          </select>
        </span>
        <span class="armor-columns">
          <label><span>Armor 2</span></label>
          <input type="checkbox" name="attr_armortype2_worn" title="@{armortype2_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armortype2" title="@{armortype2}" placeholder="Description" />
          <select name="attr_armortype2_ac" title="@{armortype2_ac} | Enter the actual AC value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <select name="attr_armortype2_base" title="@{armortype2_base} | Enter the actual AR value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armortype2_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armortype2_magic" value="0" title="@{armortype2_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <input type="checkbox" name="attr_armortype2_carried" value="1" title="@{armortype2_carried} | In use/worn cannot be un-carried." checked />
          <select class="width-fill" name="attr_armortype2_bulk" title="@{armortype2_bulk}">
            <option value="0" selected>n/a</option>
            <option value="1">non-Bulky 12"</option>
            <option value="2">Fairly 9"</option>
            <option value="3">Bulky 6"</option>
          </select>
        </span>
        <span class="armor-columns">
          <label><span>Shield</span></label>
          <input type="checkbox" name="attr_armorshield_worn" title="@{armorshield_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorshield" title="@{armorshield}" placeholder="Description" />
          <select name="attr_armorshield_ac" title="@{armorshield_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorshield_base" title="@{armorshield_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorshield_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorshield_magic" value="0" title="@{armorshield_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorshield_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorshield_mod" value="0" title="@{armorshield_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" name="attr_armorshield_carried" value="1" title="@{armorshield_carried} | In use/worn cannot be un-carried." checked />
          <select class="width-fill" name="attr_armorshield_bulk" title="@{armorshield_bulk}">
            <option value="0" selected>n/a</option>
            <option value="1">non-Bulky 12"</option>
            <option value="2">Fairly 9"</option>
            <option value="3">Bulky 6"</option>
          </select>
        </span>
        <span class="armor-columns">
          <label><span>Helm</span></label>
          <input type="checkbox" name="attr_armorhelmet_worn" title="@{armorhelmet_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorhelmet" title="@{armorhelmet}" placeholder="Description" />
          <select name="attr_armorhelmet_ac" title="@{armorhelmet_ac} | Other than Magic Bonuses, Helms do not impact Total AC calculations.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <span></span>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorhelmet_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorhelmet_magic" value="0" title="@{armorhelmet_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <span></span>
          <span></span>
        </span>
        <span class="armor-columns" style="margin-bottom: -.25em;">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother_worn" title="@{armorother_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother" title="@{armorother}" placeholder="Description" />
          <select name="attr_armorother_ac" title="@{armorother_ac} | Enter the actual AC value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <select name="attr_armorother_base" title="@{armorother_base} | Enter the actual AR value for this item.">
            <option value="10" selected>10</option>
            <option value="9">9</option>
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
            <option value="0">0</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother_magic" value="0" title="@{armorother_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother_mod" value="0" title="@{armorother_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <span class="span-all" style="margin-bottom: -.5em; padding-left:.5em;">
            <input type="checkbox" class="sect-show more" title="@{armorother-show}" name="attr_armorother_show" value="1" />
            <span style="top: -6px;position: relative;">More</span><span class="material-icons" style="padding-bottom: 6px;"></span>
          </span>
        </span>
        <input type="checkbox" class="sect-show hidden" name="attr_armorother_show" value="1" />
        <span class="sect armor-columns">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother2_worn" title="@{armorother2_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother2" title="@{armorother2}" placeholder="Description" />
          <select name="attr_armorother2_ac" title="@{armorother2_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorother2_base" title="@{armorother2_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother2_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother2_magic" value="0" title="@{armorother2_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother2_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother2_mod" value="0" title="@{armorother2_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <span></span>
        </span>
        <span class="sect armor-columns">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother3_worn" title="@{armorother3_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother3" title="@{armorother3}" placeholder="Description" />
          <select name="attr_armorother3_ac" title="@{armorother3_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorother3_base" title="@{armorother3_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother3_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother3_magic" value="0" title="@{armorother3_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother3_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother3_mod" value="0" title="@{armorother3_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
        </span>
        <span class="sect armor-columns">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother4_worn" title="@{armorother4_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother4" title="@{armorother4}" placeholder="Description" />
          <select name="attr_armorother4_ac" title="@{armorother4_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorother4_base" title="@{armorother4_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother4_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother4_magic" value="0" title="@{armorother4_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother4_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother4_mod" value="0" title="@{armorother4_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
        </span>
        <span class="sect armor-columns">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother5_worn" title="@{armorother5_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother5" title="@{armorother5}" placeholder="Description" />
          <select name="attr_armorother5_ac" title="@{armorother5_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorother5_base" title="@{armorother5_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother5_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother5_magic" value="0" title="@{armorother5_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother5_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother5_mod" value="0" title="@{armorother5_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <span></span>
        </span>
        <span class="sect armor-columns">
          <label><span>Other</span></label>
          <input type="checkbox" name="attr_armorother6_worn" title="@{armorother6_worn}" value="1" />
          <input type="text" class="width-fill" name="attr_armorother6" title="@{armorother6}" placeholder="Description" />
          <select name="attr_armorother6_ac" title="@{armorother6_ac} | ie +2 lowers AC by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <select name="attr_armorother6_base" title="@{armorother6_base} | ie +2 lowers AR by -2.">
            <option value="0" selected>+0</option>
            <option value="-1">+1</option>
            <option value="-2">+2</option>
            <option value="-3">+3</option>
            <option value="-4">+4</option>
            <option value="-5">+5</option>
            <option value="-6">+6</option>
            <option value="-7">+7</option>
            <option value="-8">+8</option>
            <option value="-9">+9</option>
            <option value="-10">+10</option>
          </select>
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother6_magic_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother6_magic" value="0" title="@{armorother6_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <input type="checkbox" class="hidden toggle-input-error" name="attr_armorother6_mod_error" value="1" checked />
          <input type="text" class="width-small" name="attr_armorother6_mod" value="0" title="@{armorother6_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
          <span></span>
          <span></span>
        </span>
        <span class="armor-columns">
          <!--column tally - In Use/Total-->
          <span class="span-three"></span>
          <label class="readonly-span-textonly" title="In Use/Best AC">
            <span>
              <span name="attr_armorclass_base_used"></span>
              <input type="text" class="hidden" name="attr_armorclass_base_used" value="0" readonly />
            </span>
            <span>/</span>
            <span>
              <span name="attr_armorclass_base_best"></span>
              <input type="text" class="hidden" name="attr_armorclass_base_best" value="0" readonly />
            </span>
          </label>
          <label class="readonly-span-textonly" title="In Use/Best AR">
            <span>
              <span name="attr_armorclass_rating_used"></span>
              <input type="text" class="hidden" name="attr_armorclass_rating_used" value="0" readonly />
            </span>
            <span>/</span>
            <span>
              <span name="attr_armorclass_rating_best"></span>
              <input type="text" class="hidden" name="attr_armorclass_rating_best" value="0" readonly />
            </span>
          </label>
          <label class="readonly-span-textonly" title="In Use/Total Magic">
            <span>
              <span name="attr_armorclass_magic_with_shield"></span>
              <input type="text" class="hidden" name="attr_armorclass_magic_with_shield" value="0" readonly />
            </span>
            <span>/</span>
            <span>
              <span name="attr_armorclass_magic_total"></span>
              <input type="text" class="hidden" name="attr_armorclass_magic_total" value="0" readonly />
            </span>
          </label>
          <label class="readonly-span-textonly" title="In Use/Total Misc.">
            <span>
              <span name="attr_armorclass_mod_with_shield"></span>
              <input type="text" class="hidden" name="attr_armorclass_mod_with_shield" value="0" readonly />
            </span>
            <span>/</span>
            <span>
              <span name="attr_armorclass_mod_total"></span>
              <input type="text" class="hidden" name="attr_armorclass_mod_total" value="0" readonly />
            </span>
          </label>
          <label class="readonly-span-textonly span-two" title="@{current_bulk_label} | Current Bulk as per active armors, shield, clothing, etc.">
            <input type="text" class="width-fill height-short" name="attr_current_bulk_label" value="" placeholder="no bulk" readonly />
          </label>
          <input type="text" class="hidden" name="attr_current_bulk" value="" />
        </span>
        <hr>
        <!--AC Calcs-->
        <span class="ac-calc-columns">
          <label class="label-under-small" title="@{unarmored_base} | Enter a value for Natural Armor or No Armor rating. Default is 10.">
            <input type="text" class="readonly-span width-small" name="attr_unarmored_base" value="10" />
            <span>UnArmored</span>
          </label>
          <label class="label-under-small" title="@{armorclass_base} | Compares the UnArmored Base AC to the AC from above and uses the best(lowest) value.">
            <input type="text" class="readonly-span width-small" name="attr_armorclass_base" value="0" />
            <span>AC Base</span>
          </label>
          <label class="label-under-small" title="@{armorclass_combined_mod_magic} | Magic + Misc. Adjustments from above.">
            <input type="text" class="hidden" name="attr_armorclass_combined_mod_magic" value="0" />
            <input type="text" class="readonly-span width-small" name="attr_armorclass_combined_mod_magic_inverted" value="0" />
            <!--mod and magic totals stored here if needed-->
            <input type="text" class="hidden" name="attr_armorclass_magic" value="0" readonly />
            <input type="text" class="hidden" name="attr_armorclass_mod" value="0" readonly />
            <span>Armor Adj.</span>
          </label>
          <input type="checkbox" class="hidden toggle-input-attention" name="attr_encumbrance_flag" value="1" checked />
          <label class="text-large">=</label>
          <label class="label-under" title="@{armorclass_rear} | Best AC without a Dex bonus.">
            <input type="text" class="readonly-span field-border" name="attr_armorclass_rear" value="0" />
            <span>Rear</span>
          </label>
          <input type="checkbox" class="hidden toggle-input-attention" name="attr_encumbrance_flag" value="1" checked />
          <label class="label-under-small" title="@{armorbonus} | Defensive Adjustment from Dexterity row.">
            <input type="text" class="readonly-span width-small" name="attr_armorbonus_inverted" value="0" />
            <span class="material-icons" title="Encumbered! DEX bonus has been removed.">nearby_error</span>
            <label class="inline-label" title="@{armorbonus_toggle} | DEX bonus can be removed circumstantially.">
              <span>Dex Adj.</span>
              <input type="checkbox" name="attr_armorbonus_toggle" value="1" checked />
            </label>
          </label>
          <label class="text-large">=</label>
          <label class="label-under" title="@{armorclass_shieldless} | Best AC without a Shield bonus.">
            <input type="text" class="readonly-span field-border" name="attr_armorclass_shieldless" value="0" />
            <span>Shieldless</span>
          </label>
          <label class="label-under-small" title="@{armorclass_combined_shield_mod_magic} | Magic + Misc. Adjustments from Shield above.">
            <input type="text" class="hidden" name="attr_armorclass_combined_shield_mod_magic" value="0" />
            <input type="text" class="readonly-span width-small" name="attr_armorclass_combined_shield_mod_magic_inverted" value="0" />
            <!--mod and magic totals stored here if needed-->
            <input type="text" class="hidden" name="attr_armorclass_shield_mod" value="0" readonly />
            <input type="text" class="hidden" name="attr_armorclass_shield_magic" value="0" readonly />
            <span>Shield Adj.</span>
          </label>
          <label class="text-large">=</label>
          <label class="label-under" title="@{armorclass_total} | Best AC">
            <input type="text" class="readonly-span field-border" name="attr_armorclass_total" value="0" />
            <span>Total AC</span>
          </label>
        </span>
        <span class="five-columns">
          <span class="inline-label" title="@{autocalc_ac} | This is a persistent setting. Let the sheet auto-calculate AC based on the values entered in the Armor Details table above. This will overwrite all values in the bottom row.">
            <label>
              <span>Auto-Calc AC:</span>
              <input type="checkbox" name="attr_autocalc_ac" value="1" checked />
            </label>
            <button type="action" class="text-only" name="act_calcac" style="padding: inherit;" title="This is an immediate action and works regardless of the Auto-Calc AC setting. Let the sheet auto-calculate AC based on the values entered in the Armor Details table above. This will overwrite all values in the bottom row.">
              <span class="width-large">Calc AC</span>
            </button>
          </span>
          <span class="inline-label sync-lock" title="@{sync_ac_flag} | Let the sheet sync Total AC from Armor Details with AC ( @{armorclass} ).">
            <label>
              <span>Sync AC:</span>
              <input type="checkbox" name="attr_sync_ac_flag" value="1" />
              <span></span>
            </label>
          </span>
          <span></span>
          <span class="inline-label" title="@{armor_rating_flag} | AC is not from armor. Weapons vs Armor Type does not apply.">
            <label><span>Ignore AR:</span></label>
            <input type="checkbox" name="attr_armor_rating_flag" value="1" />
          </span>
          <span class="inline-label" title="@{armorclass_rating} | Best AR">
            <label><span>Armor Rating</span></label>
            <input type="text" class="readonly-span width-small" name="attr_armorclass_rating" value="-" />
          </span>
        </span>
        <span class="inline-label">
          <label class="width-auto">
            <button type="roll" name="roll_defensive_notes_roll" class="dice-button text-only" title="%{selected|defensive_notes_roll}" value="@{whisper_pc} &amp;{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Defensive Notes}} {{freetext=@{defensive_notes}}}">
              <span>Defensive Notes:</span>
            </button>
          </label>
            <textarea name="attr_defensive_notes" class="height-short" title="@{defensive_notes}" placeholder="Enter Defensive Notes..."></textarea>
        </span>
      </div>
    </section>
    <!-- Personal -->
    <section class="personal-attributes-box">
      <input type="checkbox" class="sect-show" name="attr_personal_attributes_info_show" value="1" checked />
      <div class="header">PERSONAL ATTRIBUTES</div><span class="material-icons"></span>
      <div class="sect">
        <span class="details-row1">
          <label class="inline-label">
            <span>Gender:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_gender" title="@{gender}" placeholder="n/a">
              <span name="attr_gender"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Age:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_age" title="@{age}" value="0">
              <span name="attr_age"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Height:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_height" title="@{height}" value="0">
              <span name="attr_height"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Weight:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_weight" title="@{weight}" value="0">
              <span name="attr_weight"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Eyes:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_eyes" title="@{eyes}" placeholder="Color">
              <span name="attr_eyes"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Hair:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_hair" title="@{hair}" placeholder="Color">
              <span name="attr_hair"></span>
            </span>
          </label>
          <label class="inline-label" title="Natural/Unaltered size." style="padding-left: .35em;">
            <span>Size:</span>
            <select class="width-small" name="attr_size" title="@{size}">
              <option>S</option>
              <option selected>M</option>
              <option>L</option>
            </select>
          </label>
          <label class="inline-label" title="Altered size." style="padding-left: .35em;">
            <span>Temp Size:</span>
            <select class="width-small" name="attr_size2" title="@{size2}">
              <option>S</option>
              <option selected>M</option>
              <option>L</option>
            </select>
          </label>
          <label class="inline-label">
            <span>Deity:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_deity" title="@{deity}" placeholder="Description">
              <span name="attr_deity"></span>
            </span>
          </label>
          <label class="inline-label">
            <span>Secondary Skill:</span>
            <span class="autoexpand">
              <input type="text" class="autoexpand" name="attr_secondary_skill" title="@{secondary_skill}" placeholder="Description">
              <span name="attr_secondary_skill"></span>
            </span>
          </label>
          <span class="inline-label" style="padding-left: .35em; max-width: -webkit-fill-available;">
            <label>
              <button type="roll" class="image-link" value="@{whisper_pc} [**LINK**](@{sheet_image_url})" title="Send image to chat."></button>
              <textarea class="image-link" wrap="off" name="attr_sheet_image_url" title="@{sheet_image_url} | Enter a valid image URL that ends with a proper image extension. ie .png, .jpg, .gif If needed, trim the url to the end of the image extension or add a 3-letter extension to the end of the url.." placeholder="https://www.example.com/image.jpg"></textarea>
            </label>
          </span>
        </span>
        <span class="details-row">
            <label class="inline-label width-auto">
              <button type="roll" name="roll_racial_notes_roll" class="dice-button text-only" title="%{selected|racial_notes_roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Racial Notes}} {{freetext=@{racial_notes}}}">
                <span>Racial Notes:</span>
              </button>
            </label>
            <textarea name="attr_racial_notes" class="height-short" title="@{racial_notes}" placeholder="Enter Racial Notes..."></textarea>
        </span>
        <span class="details-row">
          <label class="inline-label width-auto">
            <button type="roll" name="roll_languages_roll" class="dice-button text-only" title="%{selected|languages_roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Known Languages}} {{freetext=@{languages}}}">
              <span>Languages:</span>
            </button>
          </label>
          <textarea class="height-short" name="attr_languages" title="@{languages}" placeholder="languages known"></textarea>
        </span>
        <span class="details-row">
          <label class="inline-label width-auto">
            <button type="roll" name="roll_senses_roll" class="dice-button text-only" title="%{selected|senses_roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Senses}} {{freetext=@{senses}}}">
              <span>Special Senses:</span>
            </button>
          </label>
          <textarea name="attr_senses" class="height-short" title="@{senses}" placeholder="Enter Special Senses..."></textarea>
        </span>
        <span class="details-row3">
          <input type="checkbox" class="sect-show" name="attr_character-description_show" value="1" checked />
          <span class="subheader">Character History/Bio</span><span class="material-icons"></span>
          <textarea class="sect height-half" name="attr_character_description" title="@{character_description}" placeholder="Enter Character Description..."></textarea>
        </span>
      </div>
      <hr>
    </section>
    <!-- Abilities -->
    <section class="abilities-box">
      <input type="checkbox" class="sect-show" name="attr_abilities_info_show" value="1" checked />
      <div class="header">ABILITIES</div><span class="material-icons"></span>
      <div class="sect">
        <span class="abilities-columns">
          <!-- STR -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_strength_check_roll" title="%{selected|strength_check_roll}" value="@{strength_check_macro_text}"><span>STR</span></button>
            <input type="text" class="hidden" name="attr_strength_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Strength Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{strength} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_strength" title="@{strength}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_strength_flag" value="1" />
          <label class="toggle-exceptional strength">
            <input type="text" class="width-smallest" name="attr_exceptionalstrength" title="@{exceptionalstrength | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label>
            <span class="stack-text">To-Hit Adj.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_meleebonus" title="@{meleebonus} | Melee attack &quot;To-Hit&quot; adjustment." value="0" />
          <label>
            <span class="stack-text">Damage Adj.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_dmgbonus" title="@{dmgbonus} | Melee attack Damage adjustment." value="0" />
          <label>
            <span class="stack-text">Weight All.</span>
          </label>
          <input type="text" class="width-fill" name="attr_encumbrancebonus" title="@{encumbrancebonus} | Weight Allowance in gp. Keep this value as gp even if the sheet is using the lbs option." value="0" />
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_minorstrengthfeat-roll" title="%{selected|minorstrengthfeat-roll} | Minor Strength Feat" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Open Doors}} {{roll_low=[[ 1d100cs ]]%}} {{roll_target=[[ @{minorstrengthfeat} ]]}} {{locked_doors=[Open a Locked Door?](~@{character_id}|minorstrengthfeat_locked-roll) You have a [[@{selected|minorstrengthfeat_locked}]]% chance to force open a locked, barred, magically held, or wizard locked door. Fighter's only.}}">
              <span>Open Doors</span>
            </button>
          </label>
          <span class="two-columns">
            <label class="label-percent">
              <input type="text" class="width-smallest" name="attr_minorstrengthfeat" title="@{minorstrengthfeat} | Minor Strength Feat: uses the highest # from STR table." value="0">
            </label>
            <input type="checkbox" class="hidden exceptional" name="attr_exceptional_strength_flag" value="1" />
            <sup class="toggle-exceptional strength" title="@{minorstrengthfeat_locked} | Fighter's can attempt to force open a locked, barred, magically held, or wizard locked door with exceptional Strength of 18(99)+.">
              <span name="attr_minorstrengthfeat_locked"></span>
            </sup>
            <input type="hidden" name="attr_minorstrengthfeat_locked" value="0" />
            <button class="hidden" type="roll" name="attr_minorstrengthfeat_locked-roll" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Open Locked Door}} {{roll_low=[[ 1d100cs ]]% }} {{roll_target=[[ @{minorstrengthfeat_locked} ]]%}}"></button>
          </span>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_majorstrengthfeat-roll" title="%{selected|majorstrengthfeat-roll} | Major Strength Feat" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Bend Bars/Lift Gates}} {{roll_low=[[1d100cs]]%}} {{roll_target=[[ @{majorstrengthfeat}]]%}}">
              <span>Bend</span>
            </button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_majorstrengthfeat" title="@{majorstrengthfeat} | Major Strength Feat" value="0" />
          </label>
          <!-- INT -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_intelligence_check_roll" title="%{selected|intelligence_check_roll}" value="@{intelligence_check_macro_text}"><span>INT</span></button>
            <input type="text" class="hidden" name="attr_intelligence_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Intelligence Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{intelligence} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_intelligence" title="@{intelligence}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_intelligence_flag" value="1" />
          <label class="toggle-exceptional">
            <input type="text" class="width-smallest" name="attr_exceptionalintelligence" title="@{exceptionalintelligence} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label>
            <span class="stack-text">Add. Lang.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_bonuslanguages" title="@{bonuslanguages} | Auto-filled for humans. Manual entry required for demi-humans." value="0" />
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_knowspell-roll" title="%{selected|knowspell-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Chance to Know Spell}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{knowspell} ]]%}}"><span>Know Spell</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_knowspell" title="@{knowspell}" value="0" />
          </label>
          <label>
            <span class="stack-text">Min # Spells</span>
          </label>
          <input type="text" class="width-smaller" name="attr_minspells" title="@{minspells}" value="0" />
          <label>
            <span class="stack-text">Max # Spells</span>
          </label>
          <input type="text" class="width-smaller" name="attr_maxspells" title="@{maxspells}" value="0" />
          <label class="span-two inline-label">
            <button class="dice-button text-only" type="roll" name="attr_init-roll" title="%{selected|init-roll}" value="@{whisper_pc} @{init_macro_text}"><span>Initiative</span></button>
          </label>
          <!-- WIS -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_wisdom_check_roll" title="%{selected|wisdom_check_roll}" value="@{wisdom_check_macro_text}"><span>WIS</span></button>
            <input type="text" class="hidden" name="attr_wisdom_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Wisdom Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{wisdom} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_wisdom" title="@{wisdom}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_wisdom_flag" value="1" />
          <label class="toggle-exceptional">
            <input type="text" class="width-smallest" name="attr_exceptionalwisdom" title="@{exceptionalwisdom} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_mentalsave-roll" title="%{selected|mentalsave-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Mental Save}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] + [[ @{mentalsavebonus} ]][BON] ]]}} {{roll_target=[[?{Target # for success?|20}]]}} {{wis_applied=[[ @{mentalsavebonus} ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Mental Save</span></button>
          </label>
          <input type="text" class="width-smaller" name="attr_mentalsavebonus" title="@{mentalsavebonus}" value="0" />
          <label>
            <span class="stack-text">Spell Bonus</span>
          </label>
          <span class="autoexpand span-two" style="margin-left: 2px;">
            <input type="text" name="attr_spellbonus" class="no-border" title="@{spellbonus} | Track the # of bonus spells/level as per the PHB." value="0/0/0/0/0/0/0" />
            <span name="attr_spellbonus"></span>
          </span>
          <label></label>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_spellfailure-roll" title="%{selected|spellfailure-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Chance of Spell Failure}} {{roll_high=[[ 1d100 ]]%}} {{roll_target=[[ @{spellfailure} ]]%}}"><span>Spell Failure</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_spellfailure" title="@{spellfailure}" value="0" />
          </label>
          <label class="span-two inline-label">
            <button class="dice-button text-only" type="roll" name="attr_surprise-roll" title="%{selected|surprise-roll}" value="@{whisper_pc} @{surprise_macro_text}"><span>Surprise</span></button>
          </label>
          <!-- DEX -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_dexterity_check_roll" title="%{selected|dexterity_check_roll}" value="@{dexterity_check_macro_text}"><span>DEX</span></button>
            <input type="text" class="hidden" name="attr_dexterity_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Dexterity Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{dexterity} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_dexterity" title="@{dexterity}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_dexterity_flag" value="1" />
          <label class="toggle-exceptional">
            <input type="text" class="width-smallest" name="attr_exceptionaldexterity" title="@{exceptionaldexterity} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label>
            <span class="stack-text">Reaction Adj.</span>
          </label>
          <input type="text" class="hidden" name="attr_surprisebonus" value="0" />
          <input type="text" class="width-smaller" name="attr_surprisebonus_inverted" title="@{surprisebonus} | Modifier for initiative/surprise and missile-based combat attacks." value="0" />
          <label>
            <span class="stack-text">Missile Adj.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_rangedbonus" title="@{rangedbonus} | Ranged attack 'To-Hit' adjustment." value="0" />
          <label>
            <span class="stack-text">Defensive Adj.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_armorbonus" title="@{armorbonus} | Used to compute AC in the 'Armor Details' section above." value="0" />
          <label class="span-three">
            <span>Surprise Chance</span>
            <input type="text" class="width-smaller" name="attr_surprise" title="@{surprise}" value="2" />
          </label>
          <label>
            <select name="attr_surprise_die" class="text-small" title="@{surprise_die}">
              <option value="6" selected>of 6</option>
              <option value="8">of 8</option>
              <option value="10">of 10</option>
              <option value="12">of 12</option>
              <option value="20">of 20</option>
              <option value="100">of 100</option>
            </select>
          </label>
          <!-- CON -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_constitution_check_roll" title="%{selected|constitution_check_roll}" value="@{constitution_check_macro_text}"><span>CON</span></button>
            <input type="text" class="hidden" name="attr_constitution_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Constitution Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{constitution} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_constitution" title="@{constitution}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_constitution_flag" value="1" />
          <label class="toggle-exceptional">
            <input type="text" class="width-smallest" name="attr_exceptionalconstitution" title="@{exceptionalconstitution} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label>
            <span class="stack-text">HP Adj.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_hitpointbonus" title="@{hitpointbonus} | Max +2 unless Fighter, Paladin, or Ranger." value="0" />
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_systemshock-roll" title="%{selected|systemshock-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=System Shock Survival}} {{roll_low=[[ 1d100 ]] %}} {{roll_target=[[ @{systemshock} ]]%}}"><span>Sys. Shock</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_systemshock" title="@{systemshock}" value="0" />
          </label>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_resurrectionsurvival-roll" title="%{selected|resurrectionsurvival-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Resurrection Survival}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{resurrectionsurvival} ]]%}}"><span>Res. Surv.</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_resurrectionsurvival" title="@{resurrectionsurvival}" value="0" />
          </label>
          <label class="span-four inline-label">
            <button type="roll" class="dice-button text-only" name="roll_surprise_others-roll" title="%{selected|surprise_others-roll}" value="@{whisper_pc} @{surprise_others_macro_text}">
              <span>Surprise Others</span>
            </button>
            <span>Adj.</span>
            <input type="text" class="width-smaller" name="attr_surprise_others_mod" title="@{surprise_others_mod} | The modifier is typically indicated as bonus although the value is SUBTRACTED from the opponents Surprise check." value="0" />
          </label>
          <!-- CHA -->
          <label>
            <button type="roll" class="ability-button text-only" name="attr_charisma_check_roll" title="%{selected|charisma_check_roll}" value="@{charisma_check_macro_text}"><span>CHA</span></button>
            <input type="text" class="hidden" name="attr_charisma_check_macro_text" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Charisma Check}} {{roll_low=[[ @{ability_check_die}cs ]]}} {{roll_target=[[ @{charisma} ]]}}" />
          </label>
          <input type="text" class="field-border" name="attr_charisma" title="@{charisma}" value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_charisma_flag" value="1" />
          <label class="toggle-exceptional">
            <input type="text" class="width-smallest" name="attr_exceptionalcharisma" title="@{exceptionalcharisma} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <label>
            <span class="stack-text">Max # Hench.</span>
          </label>
          <input type="text" class="width-smaller" name="attr_maximumhenchmen" title="@{maximumhenchmen}" value="0" />
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_loyalty-roll" title="%{selected|loyalty-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Loyalty}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ 50 + (@{loyaltybonus}[LOYALTY]) + ( ?{Modifier?|0}[MOD] ) ]]%}} {{Loyalty Applied=[[@{loyaltybonus}]]%}} {{mod_applied=[[ ?{Modifier?|0} ]]%}}"><span>Loyalty</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_loyaltybonus" title="@{loyaltybonus}" value="0" />
          </label>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_reaction-roll" title="%{selected|reaction-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Reaction}} {{roll=[[ 1d100 + (@{reactionbonus}[BON]) + ( ?{Modifier?|0}[MOD] ) ]]%}} {{Reaction Applied=[[@{reactionbonus}]]%}} {{mod_applied=[[ ?{Modifier?|0} ]]%}}"><span>React.</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_reactionbonus" title="@{reactionbonus}" value="0" />
          </label>
          <label class="inline-label">
            <button class="dice-button text-only" type="roll" name="attr_morale-roll" title="%{selected|morale-roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Morale Check}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{morale_base}[BASE] + ( ?{Modifier?|0}[MOD] ) ]]%}} {{mod_applied=[[ ?{Modifier?|0} ]]%}}"><span>Morale</span></button>
          </label>
          <label class="label-percent">
            <input type="text" class="width-smaller" name="attr_morale_base" title="@{morale_base} | Base is 50%. Adjust +/- per circumstances." value="50" />
          </label>
          <label></label>
          <label></label>
          <!-- COM -->
          <label class="toggle-comeliness">
            <button type="roll" class="ability-button text-only"><span>COM</span></button>
          </label>
          <input type="text" class="field-border toggle-comeliness" name="attr_comeliness" title="@{comeliness} | Score should reflect 'Adjusted Comeliness' which takes into account Charisma and/or any racial adjustments." value="10" />
          <input type="checkbox" class="hidden exceptional" name="attr_exceptional_comeliness_flag" value="1" />
          <label class="toggle-exceptional toggle-comeliness">
            <input type="text" class="width-smallest" name="attr_exceptionalcomeliness" title="@{exceptionalcomeliness} | Must have an Ability of 18+ to access field." value="0" />
          </label>
          <span class="span-ten inline-label toggle-comeliness">
            <b class="text-large">=</b>
            <span>Base COM</span>
            <input type="text" class="width-smaller" name="attr_comeliness_base" title="@{comeliness_base} | Comeliness base score. ie un-adjusted roll." value="8" />
            <b class="text-large">+</b>
            <span>CHA Adj.</span>
            <input type="text" class="width-smaller" name="attr_comeliness_cha_adj" title="@{comeliness_cha_adj} | Same race Bonus/Penalty adjustment. Auto-calculated based on Charisma." value="0" readonly />
            <b class="text-large">+</b>
            <span>Racial Adj.</span>
            <select name="attr_comeliness_racial_adj" title="@{comeliness_racial_adj} | Bonus/Penalty adjustment as perceived by other races.">
              <option value="-3">Half-Orcs</option>
              <option value="-1">Dwarves, Gnomes</option>
              <option value="0" selected>Halflings, Humans</option>
              <option value="1">Half-Elves, Sylvan Elves</option>
              <option value="2">Gray Elves, High Elves</option>
            </select>
            <input type="text" class="width-smaller" name="attr_comeliness_racial_adj" value="0" readonly />
          </span>
        </span>
      </div>
      <!-- Movement -->
      <div class="sect border">
        <span class="subheader center width-fill">Speed and Movement</span>
        <span class="basemove-columns column-header">
          <span class="span-five">Adjusted Speed</span>
          <span></span>
          <span class="stack-text">Explore/<wbr>Map</span>
          <span class="stack-text">Known Route</span>
          <span>Run/Flee</span>
        </span>
        <span class="basemove-columns">
          <label class="label-under">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance_move" value="0" readonly />
            <input type="text" class="width-smaller field-border" name="attr_movement" title="@{movement}" value="12" />
            <span>Normal</span>
          </label>
          <label class="label-under" title="@{movement_heavy} | No DEX Bonus to Init.">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance_move" value="1" readonly />
            <input type="text" class="hidden" name="attr_movement_heavy" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_heavy" title="@{movement_heavy}"></span>
            <span>Heavy</span>
          </label>
          <label class="label-under" title="@{movement_load} | No DEX Bonus to Init, Delayed, +1 Segment if Surprised.">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance_move" value="2" readonly />
            <input type="text" class="hidden" name="attr_movement_load" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_load" title="@{movement_load}"></span>
            <span class="nowrap">Very Heavy</span>
          </label>
          <label class="label-under" title="@{movement_max} |No DEX Bonus to Init or AC, Go Last in Init, +2 Segments if Surprised, Cannot Charge, Enemies get +2 to-hit.">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance_move" value="3" readonly />
            <input type="text" class="hidden" name="attr_movement_max" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_max" title="@{movement_max}"></span>
            <span class="long">Encumbered</span>
          </label>
          <h4 class="stack-text">Move/<wbr>Round</h4>
          <label class="text-large">=</label>
          <label class="label-under" title="@{movement_normal}">
            <input type="text" class="hidden" name="attr_movement_normal" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_normal" title="@{movement_normal}"></span>
            <span class="text-small">(Speed x1')</span>
          </label>
          <label class="label-under" title="@{movement_known}">
            <input type="text" class="hidden" name="attr_movement_known" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_known" title="@{movement_known}"></span>
            <span class="text-small">(Speed x5')</span>
          </label>
          <label class="label-under" title="@{movement_run}">
            <input type="text" class="hidden" name="attr_movement_run" value="0" readonly />
            <span class="readonly-span no-border" name="attr_movement_run" title="@{movement_run}"></span>
            <span class="text-small">(Speed x10')</span>
          </label>
          <!--deprecated attribute: crawl kept in case attribute is needed -->
          <input type="text" class="hidden" name="attr_movement_crawl" value="0" readonly />
          <span class="span-six">
            <label class="inline-label" title="@{current_bulk_label} | Current Bulk as per active armors, shield, clothing, etc.">
              <span class="stack-text">Current Armor Bulk:</span>
              <input type="text" class="width-fill height-short" name="attr_current_bulk_label" value="" placeholder="no bulk" readonly />
            </label>
            <label class="inline-label" title="@{current_encumbrance_label} | Encumbrance is the current load for carried weight vs strength adjustments.">
              <span class="stack-text">Current Encumbrance:</span>
              <input type="text" class="width-fill height-short" style="margin-right: -1em;" name="attr_current_encumbrance_label" value="" placeholder="no encumbrance" readonly />
            </label>
          </span>
          <label class="inline-label span-three right" title="@{autocalc_movement_flag} | Let the sheet calculate Movement/Speed. Uses base movement and the current encumbrance(STR vs total_weight carried). Note: Load can can be set manually but any changes to base movement, encumbrance, or opening the sheet will trigger a re-calc.">
            <span class="stack-text">Auto-Calc Movement:</span>
            <input type="checkbox" name="attr_autocalc_movement_flag" value="1" checked />
          </label>
        </span>
      </div>
      <hr>
    </section>
    <!-- Saves -->
    <section class="saves-box">
      <input type="checkbox" class="sect-show" name="attr_saves_info_show" value="1" checked />
      <div class="header">SAVES</div><span class="material-icons"></span>
      <div class="sect">
        <span class="saves-columns column-header">
          <span></span>
          <span>TOTAL</span>
          <span></span>
          <span>Base/Class</span>
          <span></span>
          <span>Racial Adj.</span>
          <span></span>
          <span>Ability Adj.</span>
          <span></span>
          <span>Misc. Adj.</span>
          <span></span>
          <span>Temp. Adj.</span>
        </span>
        <span class="saves-columns">
          <button class="saves-button text-only" type="roll" name="roll_saveparalysispoisondeath" title="%{selected|saveparalysispoisondeath}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Paralysis, Poison or Death Magic}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{saveparalysispoisondeath}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Paralysis, Poison, or Death Magic</span></button>
          <span title="@{saveparalysispoisondeath}"><input type="text" class="width-smaller field-border readonly-span" name="attr_saveparalysispoisondeath" title="@{saveparalysispoisondeath}" value="20" /></span>
          <span class="text-large">=</span>
          <span><input type="text" class="width-smaller" name="attr_saveparalysispoisondeath_base" title="@{saveparalysispoisondeath_base}" value="20" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saveparalysispoisondeath_racial_mod" title="@{saveparalysispoisondeath_racial_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saveparalysispoisondeath_ability_mod" title="@{saveparalysispoisondeath_ability_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saveparalysispoisondeath_misc_mod" title="@{saveparalysispoisondeath_misc_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saveparalysispoisondeath_temp_mod" title="@{saveparalysispoisondeath_temp_mod}" value="0" /></span>
        </span>
        <span class="saves-columns">
          <button class="saves-button text-only" type="roll" name="roll_savepetrificationpolymorph" title="%{selected|savepetrificationpolymorph}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Petrification or Polymorph}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savepetrificationpolymorph}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Petrification or Polymorph</span></button>
          <span title="@{savepetrificationpolymorph}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savepetrificationpolymorph" title="@{savepetrificationpolymorph}" value="20" /></span>
          <span class="text-large">=</span>
          <span><input type="text" class="width-smaller" name="attr_savepetrificationpolymorph_base" title="@{savepetrificationpolymorph_base}" value="20" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savepetrificationpolymorph_racial_mod" title="@{savepetrificationpolymorph_racial_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savepetrificationpolymorph_ability_mod" title="@{savepetrificationpolymorph_ability_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savepetrificationpolymorph_misc_mod" title="@{savepetrificationpolymorph_misc_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savepetrificationpolymorph_temp_mod" title="@{savepetrificationpolymorph_temp_mod}" value="0" /></span>
        </span>
        <span class="saves-columns">
          <button class="saves-button text-only" type="roll" name="roll_saverodsstaveswands" title="%{selected|saverodsstaveswands}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Rods, Staves, or Wands}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{saverodsstaveswands}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Rods, Staves, or Wands</span></button>
          <span title="@{saverodsstaveswands}"><input type="text" class="width-smaller field-border readonly-span" name="attr_saverodsstaveswands" title="@{saverodsstaveswands}" value="20" /></span>
          <span class="text-large">=</span>
          <span><input type="text" class="width-smaller" name="attr_saverodsstaveswands_base" title="@{saverodsstaveswands_base}" value="20" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saverodsstaveswands_racial_mod" title="@{saverodsstaveswands_racial_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saverodsstaveswands_ability_mod" title="@{saverodsstaveswands_ability_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saverodsstaveswands_misc_mod" title="@{saverodsstaveswands_misc_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_saverodsstaveswands_temp_mod" title="@{saverodsstaveswands_temp_mod}" value="0" /></span>
        </span>
        <span class="saves-columns">
          <button class="saves-button text-only" type="roll" name="roll_savebreathweapons" title="%{selected|savebreathweapons}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Breath Weapon}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savebreathweapons}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Breath Weapon</span></button>
          <span title="@{savebreathweapons}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savebreathweapons" title="@{savebreathweapons}" value="20" /></span>
          <span class="text-large">=</span>
          <span><input type="text" class="width-smaller" name="attr_savebreathweapons_base" title="@{savebreathweapons_base}" value="20" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savebreathweapons_racial_mod" title="@{savebreathweapons_racial_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savebreathweapons_ability_mod" title="@{savebreathweapons_ability_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savebreathweapons_misc_mod" title="@{savebreathweapons_misc_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savebreathweapons_temp_mod" title="@{savebreathweapons_temp_mod}" value="0" /></span>
        </span>
        <span class="saves-columns">
          <button class="saves-button text-only" type="roll" name="roll_savespells" title="%{selected|savespells}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Spells}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savespells}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span>Spells</span></button>
          <span title="@{savespells}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savespells" title="@{savespells}" value="20" /></span>
          <span class="text-large">=</span>
          <span><input type="text" class="width-smaller" name="attr_savespells_base" title="@{savespells_base}" value="20" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savespells_racial_mod" title="@{savespells_racial_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savespells_ability_mod" title="@{savespells_ability_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savespells_misc_mod" title="@{savespells_misc_mod}" value="0" /></span>
          <span class="text-large"></span>
          <span><input type="text" class="width-smaller" name="attr_savespells_temp_mod" title="@{savespells_temp_mod}" value="0" /></span>
        </span>
        <input type="checkbox" class="sect-show" name="attr_custom_saves_show" value="1" />
        <span class="subheader">Custom Saves</span><span class="material-icons"></span>
        <div class="sect">
          <span class="saves-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="saves-button text-only" type="roll" name="roll_savemisc" title="%{selected|savemisc}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{savemisc_name}}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savemisc}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span name="attr_savemisc_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_savemisc_name" title="@{savemisc_name}" value="Custom..." />
            </details>
            <span title="@{savemisc}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savemisc" title="@{savemisc}" value="20" /></span>
            <span class="text-large">=</span>
            <span><input type="text" class="width-smaller" name="attr_savemisc_base" title="@{savemisc_base}" value="20" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc_racial_mod" title="@{savemisc_racial_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc_ability_mod" title="@{savemisc_ability_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc_misc_mod" title="@{savemisc_misc_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc_temp_mod" title="@{savemisc_temp_mod}" value="0" /></span>
          </span>
          <span class="saves-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="saves-button text-only" type="roll" name="roll_savemisc1" title="%{selected|savemisc1}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{savemisc1_name}}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savemisc1}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span name="attr_savemisc1_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_savemisc1_name" title="@{savemisc1_name}" value="Custom..." />
            </details>
            <span title="@{savemisc1}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savemisc1" title="@{savemisc1}" value="20" /></span>
            <span class="text-large">=</span>
            <span><input type="text" class="width-smaller" name="attr_savemisc1_base" title="@{savemisc1_base}" value="20" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc1_racial_mod" title="@{savemisc1_racial_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc1_ability_mod" title="@{savemisc1_ability_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc1_misc_mod" title="@{savemisc1_misc_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc1_temp_mod" title="@{savemisc1_temp_mod}" value="0" /></span>
          </span>
          <span class="saves-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="saves-button text-only" type="roll" name="roll_savemisc2" title="%{selected|savemisc2}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{savemisc2_name}}} {{roll_high=[[ 1d20 + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[@{savemisc2}]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}}"><span name="attr_savemisc2_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_savemisc2_name" title="@{savemisc2_name}" value="Custom..." />
            </details>
            <span title="@{savemisc2}"><input type="text" class="width-smaller field-border readonly-span" name="attr_savemisc2" title="@{savemisc2}" value="20" /></span>
            <span class="text-large">=</span>
            <span><input type="text" class="width-smaller" name="attr_savemisc2_base" title="@{savemisc2_base}" value="20" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc2_racial_mod" title="@{savemisc2_racial_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc2_ability_mod" title="@{savemisc2_ability_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc2_misc_mod" title="@{savemisc2_misc_mod}" value="0" /></span>
            <span class="text-large"></span>
            <span><input type="text" class="width-smaller" name="attr_savemisc2_temp_mod" title="@{savemisc2_temp_mod}" value="0" /></span>
          </span>
        </div>
        <span class="inline-label width-fill">
          <label class="inline-label width-auto">
          <button type="roll" name="roll_savingthrow_notes_roll" class="dice-button text-only" title="%{selected|savingthrow_notes_roll}" value="@{whisper_pc} &amp;{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Saving Throw Notes}} {{freetext=@{savingthrow_notes}}}">
            <span>Saving Throw Notes:</span>
          </button>
          </label>
          <textarea name="attr_savingthrow_notes" class="height-short" title="@{savingthrow_notes}" placeholder="Resistances, Immunities, Saving Throw adjustments, etc."></textarea>
        </span>
      </div>
      <hr>
    </section>
    <!-- Weapons -->
    <section class="weapons-box">
      <input type="checkbox" class="sect-show" name="attr_weapons_info_show" value="1" checked />
      <div class="header">
        <span class="hide-as-npc">ATTACKS</span>
        <span class="hide-as-pc">ATTACKS</span>
      </div>
      <span class="material-icons"></span>
      <!-- Weapon Proficiency -->
      <div class="weapons-proficiency-box border sect hide-as-npc">
        <h4 class="inline-label">Weapon Proficiency:</h4>
        <label>
          <span class="stack-text-wide">Initial # of Weapons:</span>
          <input type="text" class="width-small" name="attr_weapon_proficiency_initial" value="0" title="@{weapon_proficiency_initial}">
        </label>
        <label>
          <span class="stack-text-wide">Non-Proficiency Penalty:</span>
          <select class="width-small" name="attr_weapon_proficiency_penalty" title="@{weapon_proficiency_penalty}">
            <option value="0">0</option>
            <option value="-1">-1</option>
            <option value="-2" selected>-2</option>
            <option value="-3">-3</option>
            <option value="-4">-4</option>
            <option value="-5">-5</option>
          </select>
          <input type="number" class="hidden" name="attr_weapon_proficiency_penalty" value="-2">
        </label>
        <label class="span-two" style="align-items: center;">
          <span class="stack-text-wide">Added Proficiency every:</span>
          <input type="text" class="width-small" name="attr_weapon_proficiency_added_per_level" value="0" title="@{weapon_proficiency_added_per_level}">
          <span>Levels</span>
        </label>
        <span></span>
        <label>
          <span>Total</span>
          <input type="text" class="width-small" name="attr_weapon_proficiency_total" value="0" title="@{weapon_proficiency_total}">
        </label>
        <h4 class="inline-label">Weapons:</h4>
        <label class="span-six">
          <textarea class="height-short" name="attr_weapon_proficiency_list" title="@{weapon_proficiency_list}" placeholder="List weapon proficiencies"></textarea>
        </label>
        <span class="span-all inline-label">
          <label title="@{meleebonus} | STR Melee attack adjustment.">
            <span class="stack-text">To-Hit:</span>
            <input type="text" class="width-smaller" name="attr_meleebonus" value="0" readonly />
          </label>
          <label title="@{dmgbonus} | STR Melee attack Damage adjustment.">
            <span class="stack-text">Damage:</span>
            <input type="text" class="width-smaller" name="attr_dmgbonus" value="0" readonly />
          </label>
          <label title="@{rangedbonus} | DEX Ranged attack 'To-Hit' adjustment.">
            <span class="stack-text">Missile:</span>
            <input type="text" class="width-smaller" name="attr_rangedbonus" value="0" readonly />
          </label>
          <label class="inline-label">
            <span>Dual-Wield Pen:</span>
          </label>
          <label title="@{dual_pen_primary} | -2 and adjusted as per Dexterity. Auto-calculated based on Dexterity.">
            <span class="stack-text">Primary:</span>
            <input type="text" class="width-smaller" name="attr_dual_pen_primary" value="0" readonly>
          </label>
          <label title="@{dual_pen_secondary} | -4 and adjusted as per Dexterity. Auto-calculated based on Dexterity.">
            <span class="stack-text">Secondary:</span>
            <input type="text" class="width-smaller" name="attr_dual_pen_secondary" value="0" readonly>
          </label>
        </span>
      </div>
      <div class="sect" style="margin: 5px 0 22px 0;">
        <input type="checkbox" class="hidden toggle-to-hit-table" name="attr_toggle_to_hit_table" value="1" />
        <!-- To Hit Table-->
        <details class="matrix-box">
          <summary title="Enter To-Hit Armor Class Table data.">
            <span class="material-icons grid"></span>
            <span class="subheader label-matrix">Attack Matrix</span>
            <span class="material-icons"></span>
          </summary>
          <div class="matrix-class section">
            <label></label>
            <label></label>
            <label class="center">
              <span>Class/Monster</span>
            </label>
            <input type="checkbox" name="attr_toggle_matrixhd" value="1" class="toggle-matrixhd hidden" />
            <label class="matrix-level center">
              <span>Level</span>
            </label>
            <label class="matrix-hd center" style="margin-left: -1em;">
              <span>HD/Lvl</span>
            </label>
            <span></span>
            <label class="inline-label" title="@{autofill_matrix} | Let the sheet auto-fill the to-hit tables when the class and level selectors are changed in the attack Matrix window.">
              <input type="checkbox" name="attr_autofill_matrix" value="1" checked />
              <h4>Autofill Table:</h4>
            </label>
            <label class="center width-large">
              <select class="width-fill border" name="attr_matrix_class" title="@{matrix_class}">
                <option value="0" selected>Select a Class or Monster</option>
                <option value="1">Clerics, Druids and Monks</option>
                <option value="2">Fighters, Paladins, Rangers,</option>
                <option value="2">Bards, & 0-lvl Halflings & Humans</option>
                <option value="3">Magic-Users and Illusionists</option>
                <option value="4">Thieves and Assassins</option>
                <option value="5">Monsters</option>
              </select>
            </label>
            <input type="checkbox" name="attr_toggle_matrixhd" value="1" class="toggle-matrixhd hidden" />
            <label class="matrix-level center">
              <input class="width-small border" type="number" min="0" name="attr_matrix_level" value="1" title="@{matrix_level}">
            </label>
            <label class="matrix-hd center" style="margin-left: -1em;">
              <select class="width-small-plus border" name="attr_matrix_hitdice" title="@{matrix_hitdice}">
                <option value="0" selected>Select HD/Lvl</option>
                <option value="1">up to 1-1</option>
                <option value="2">1-1</option>
                <option value="3">1</option>
                <option value="4">1+</option>
                <option value="5">2-3+</option>
                <option value="6">4-5+</option>
                <option value="7">6-7+</option>
                <option value="8">8-9+</option>
                <option value="9">10-11+</option>
                <option value="10">12-13+</option>
                <option value="11">14-15+</option>
                <option value="12">16+</option>
              </select>
            </label>
          </div>
          <div class="section center">
            <span class="to-hit">
              <span>-10</span>
              <span>-9</span>
              <span>-8</span>
              <span>-7</span>
              <span>-6</span>
              <span>-5</span>
              <span>-4</span>
              <span>-3</span>
              <span>-2</span>
              <span>-1</span>
              <span>0</span>
              <span>1</span>
              <span>2</span>
              <span>3</span>
              <span>4</span>
              <span>5</span>
              <span>6</span>
              <span>7</span>
              <span>8</span>
              <span>9</span>
              <span>10</span>
            </span>
            <span class="to-hit-input">
              <span><input type="text" name="attr_thac-10" title="@{thac-10}" value="20" /></span>
              <span><input type="text" name="attr_thac-9" title="@{thac-9}" value="20" /></span>
              <span><input type="text" name="attr_thac-8" title="@{thac-8}" value="20" /></span>
              <span><input type="text" name="attr_thac-7" title="@{thac-7}" value="20" /></span>
              <span><input type="text" name="attr_thac-6" title="@{thac-6}" value="20" /></span>
              <span><input type="text" name="attr_thac-5" title="@{thac-5}" value="20" /></span>
              <span><input type="text" name="attr_thac-4" title="@{thac-4}" value="20" /></span>
              <span><input type="text" name="attr_thac-3" title="@{thac-3}" value="20" /></span>
              <span><input type="text" name="attr_thac-2" title="@{thac-2}" value="20" /></span>
              <span><input type="text" name="attr_thac-1" title="@{thac-1}" value="20" /></span>
              <span><input type="text" name="attr_thac0" title="@{thac0}" value="20" /></span>
              <span><input type="text" name="attr_thac1" title="@{thac1}" value="20" /></span>
              <span><input type="text" name="attr_thac2" title="@{thac2}" value="20" /></span>
              <span><input type="text" name="attr_thac3" title="@{thac3}" value="20" /></span>
              <span><input type="text" name="attr_thac4" title="@{thac4}" value="20" /></span>
              <span><input type="text" name="attr_thac5" title="@{thac5}" value="20" /></span>
              <span><input type="text" name="attr_thac6" title="@{thac6}" value="20" /></span>
              <span><input type="text" name="attr_thac7" title="@{thac7}" value="20" /></span>
              <span><input type="text" name="attr_thac8" title="@{thac8}" value="20" /></span>
              <span><input type="text" name="attr_thac9" title="@{thac9}" value="20" /></span>
              <span><input type="text" name="attr_thac10" title="@{thac10}" value="20" /></span>
            </span>
          </div>
        </details>
        <!-- THAC0 Table-->
        <details class="thac0-box">
          <summary title="Enter THAC0 data">
            <span class="material-icons grid"></span>
            <span class="label-matrix">THAC0</span>
            <span class="material-icons"></span>
          </summary>
          <div class="matrix-class section">
            <label></label>
            <label></label>
            <label class="center"><span>Class/Monster</span></label>
            <input type="checkbox" name="attr_toggle_matrixhd" value="1" class="toggle-matrixhd hidden" />
            <label class="matrix-level center"><span>Level</span></label>
            <label class="matrix-hd center" style="margin-left: -1em;"><span>HD/Lvl</span></label>
            <span></span>
            <h4>Autofill Table:</h4>
            <label class="center width-large">
              <select class="width-fill border" name="attr_matrix_class" title="@{matrix_class}">
                <option value="0" selected>Select a Class or Monster</option>
                <option value="1">Clerics, Druids and Monks</option>
                <option value="2">Fighters, Paladins, Rangers, Bards, & 0-lvl Halflings & Humans</option>
                <option value="3">Magic-Users and Illusionists</option>
                <option value="4">Thieves and Assassins</option>
                <option value="5">Monsters</option>
              </select>
            </label>
            <input type="checkbox" name="attr_toggle_matrixhd" value="1" class="toggle-matrixhd hidden" />
            <label class="matrix-level center">
              <input class="width-small border" type="number" min="0" name="attr_matrix_level" value="1" title="@{matrix_level}" />
            </label>
            <label class="matrix-hd center">
              <select class="width-small-plus border" name="attr_matrix_hitdice" title="@{matrix_hitdice}">
                <option value="0" selected>Select HD/Lvl</option>
                <option value="1">up to 1-1</option>
                <option value="2">1-1</option>
                <option value="3">1</option>
                <option value="4">1+</option>
                <option value="5">2-3+</option>
                <option value="6">4-5+</option>
                <option value="7">6-7+</option>
                <option value="8">8-9+</option>
                <option value="9">10-11+</option>
                <option value="10">12-13+</option>
                <option value="11">14-15+</option>
                <option value="12">16+</option>
              </select>
            </label>
          </div>
          <div class="sect center">
            <span class="to-hit">
              <span>-10</span>
              <span>-9</span>
              <span>-8</span>
              <span>-7</span>
              <span>-6</span>
              <span>-5</span>
              <span>-4</span>
              <span>-3</span>
              <span>-2</span>
              <span>-1</span>
              <span>0</span>
              <span>1</span>
              <span>2</span>
              <span>3</span>
              <span>4</span>
              <span>5</span>
              <span>6</span>
              <span>7</span>
              <span>8</span>
              <span>9</span>
              <span>10</span>
            </span>
            <span class="to-hit-input">
              <span><input type="text" name="attr_thac0-10" title="@{thac0-10}" value="20" /></span>
              <span><input type="text" name="attr_thac0-9" title="@{thac0-9}" value="20" /></span>
              <span><input type="text" name="attr_thac0-8" title="@{thac0-8}" value="20" /></span>
              <span><input type="text" name="attr_thac0-7" title="@{thac0-7}" value="20" /></span>
              <span><input type="text" name="attr_thac0-6" title="@{thac0-6}" value="20" /></span>
              <span><input type="text" name="attr_thac0-5" title="@{thac0-5}" value="20" /></span>
              <span><input type="text" name="attr_thac0-4" title="@{thac0-4}" value="20" /></span>
              <span><input type="text" name="attr_thac0-3" title="@{thac0-3}" value="20" /></span>
              <span><input type="text" name="attr_thac0-2" title="@{thac0-2}" value="20" /></span>
              <span><input type="text" name="attr_thac0-1" title="@{thac0-1}" value="20" /></span>
              <span><input type="text" name="attr_thac00" title="@{thac00}" value="20" style="font-weight:bold; border: 1px solid black;" /></span>
              <span><input type="text" name="attr_thac01" title="@{thac01}" value="20" /></span>
              <span><input type="text" name="attr_thac02" title="@{thac02}" value="20" /></span>
              <span><input type="text" name="attr_thac03" title="@{thac03}" value="20" /></span>
              <span><input type="text" name="attr_thac04" title="@{thac04}" value="20" /></span>
              <span><input type="text" name="attr_thac05" title="@{thac05}" value="20" /></span>
              <span><input type="text" name="attr_thac06" title="@{thac06}" value="20" /></span>
              <span><input type="text" name="attr_thac07" title="@{thac07}" value="20" /></span>
              <span><input type="text" name="attr_thac08" title="@{thac08}" value="20" /></span>
              <span><input type="text" name="attr_thac09" title="@{thac09}" value="20" /></span>
              <span><input type="text" name="attr_thac010" title="@{thac010}" value="20" /></span>
            </span>
          </div>
        </details>
      </div>
      <div class="sect">
        <input type="checkbox" class="hidden toggle-input-attention" name="attr_attack_matrix_flag" value="1" checked />
        <span class="material-icons" title="Attack tables have not been set!">nearby_error</span>
        <input type="checkbox" class="hidden toggle-to-hit-table" name="attr_toggle_to_hit_table" value="1" />
        <fieldset class="repeating_weapon">
          <input type="hidden" class="weapon-type-toggle" name="attr_weapon_attack_type_flag" value="0" />
          <input type="checkbox" class="hidden" name="attr_weapon_critdamage_flag" value="1" />
          <div class="top-row border-top-half">
            <span class="weapons-row1 center">
              <button class="dice-button hide-as-npc" type="roll" name="attr_weapon_attack_roll" title="%{selected|repeating_weapon_$X_weapon_attack_roll} | PC Roll" value="@{whisper_pc} @{weapon_macro_text} @{weapon_whisper_to_hit}"></button>
              <!--NPC version-->
              <button class="dice-button hide-as-pc" type="roll" name="attr_weapon_attack_npc_roll" title="%{selected|repeating_weapon_$X_weapon_attack_npc_roll} | NPC Roll" value="@{whisper_npc} @{weapon_macro_text} @{weapon_damage_chat_menu_npc} @{weapon_whisper_to_hit}"></button>
              <label class="label-under-small repeating-name">
                <input type="text" class="text-large" name="attr_weapon_name" title="@{repeating_weapon_$X_weapon_name}" placeholder="Enter Weapon" />
                <span>Name</span>
              </label>
              <label class="label-under-small">
                <select name="attr_weapon_attack_type" class="select-over-label" title="@{repeating_weapon_$X_weapon_attack_type}">
                  <option value="0" selected>Melee</option>
                  <option value="1">Ranged</option>
                  <option value="2">Touch</option>
                  <option value="3">Ranged Touch</option>
                </select>
                <span class="hide-overflowing-text">Attack Type</span>
              </label>
              <label class="label-under-small toggle-backstab hide-if-ranged">
                <span class="two-inputs-over-label">
                  <input type="checkbox" class="toggle-field" name="attr_weapon_backstab_flag" title="@{repeating_weapon_$X_weapon_backstab_flag}" value="1">
                  <input type="text" class="width-smaller" name="attr_weapon_backstab_var" value="0" title="@{repeating_weapon_$X_weapon_backstab_bonus} | Uses the @{backstab_bonus} from the Thief's section below." readonly>
                  <input type="number" class="hidden" name="attr_weapon_backstab_bonus" value="0" />
                </span>
                <span title="Apply a Backstab bonus to the attack roll.">Backstab</span>
              </label>
              <label class="label-under-small">
                <input type="text" class="width-medium" name="attr_weapon_tohitbonus" title="@{repeating_weapon_$X_weapon_tohitbonus}" value="0" />
                <span>To-Hit</span>
              </label>
              <label class="label-under-small">
                <input type="text" class="width-medium" name="attr_weapon_magicbonus" title="@{repeating_weapon_$X_weapon_magicbonus}" value="0" />
                <span>Magic</span>
              </label>
              <label class="label-under-small">
                <span class="two-inputs-over-label">
                  <input type="checkbox" class="toggle-field" name="attr_weapon_prof_flag" title="@{repeating_weapon_$X_weapon_prof_flag}" value="1" />
                  <input type="text" class="width-smaller" name="attr_weapon_prof" value="0" title="@{repeating_weapon_$X_weapon_prof_pen} | Uses the value from @{weapon_proficiency_penalty} from Weapon Proficiency section above." readonly />
                  <input type="number" class="hidden" name="attr_weapon_prof_pen" value="0" />
                </span>
                <span class="nowrap" title="Non-Proficiency penalty will be applied to the attack roll.">NP Penalty</span>
              </label>
              <label class="label-under-small center" title="Dual-wield attack? Defaults to Primary -2, Secondary -4 and then auto-calculated according to Dex.">
                <span class="two-inputs-over-label">
                  <select class="select-over-label" name="attr_weapon_dual" title="@{repeating_weapon_$X_weapon_dual}">
                    <option value="" selected>Normal</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                  </select>
                  <input type="text" class="width-smaller" name="attr_weapon_dual_pen" title="@{repeating_weapon_$X_weapon_dual_pen}" value="0" />
                </span>
                <span>Dual-Wield</span>
              </label>
              <label></label>
            </span>
            <span class="weapons-row2 center">
              <span class="inline-label" style="position: absolute; top: 2.1em;">
                <input type="checkbox" name="attr_weapon_use" title="@{repeating_weapon_$X_weapon_use} | Weapon is armed." value="1" />
                <span class="label-under-small">In Use</span>
              </span>
              <details class="small-damage">
                <summary>
                  <span class="material-icons custom-btn-nav toggle-critdamage"></span>
                  <input type="text" class="width-medium" name="attr_weapon_damagesmallmedium" title="@{repeating_weapon_$X_weapon_damagesmallmedium}" value="" placeholder="1d4" />
                  <button class="text-only hide-as-npc" type="roll" name="roll_weapon_damagesmallmedium_roll" title="%{repeating_weapon_$X_weapon_damagesmallmedium_roll} | PC Roll" value="@{weapon_damagesmallmedium_macro_text}"><span class="dice-button nowrap">DMG S/M</span></button>
                  <button class="text-only hide-as-pc" type="roll" name="roll_weapon_damagesmallmedium_npc_roll" title="%{repeating_weapon_$X_weapon_damagesmallmedium_npc_roll} | NPC Roll" value="@{weapon_damagesmallmedium_macro_npc_text}"><span class="dice-button nowrap">DMG S/M</span></button>

                  <input type="hidden" name="attr_weapon_damagesmallmedium_chat_menu" value="" />
                  <input type="hidden" name="attr_weapon_critdamagesmallmedium_chat_menu" value="" />
                  <!--NPC version-->
                  <input type="hidden" name="attr_weapon_damagesmallmedium_npc_chat_menu" value="" />
                  <input type="hidden" name="attr_weapon_critdamagesmallmedium_npc_chat_menu" value="" />

                  <textarea class="hidden" name="attr_weapon_damagesmallmedium_macro_text">@{whisper_pc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsSM=[[ (@{weapon_damagesmallmedium}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}}</textarea>

                  <textarea class="hidden" name="attr_weapon_critdamagesmallmedium_macro_text">@{whisper_pc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsSM=[[ (@{weapon_critdamagesmallmedium}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{crit=[[ @{toggle_critdamage} ]]}}</textarea>
                  <!--NPC version-->
                  <textarea class="hidden" name="attr_weapon_damagesmallmedium_macro_npc_text">@{whisper_npc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsSM=[[ (@{weapon_damagesmallmedium}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}}</textarea>

                  <textarea class="hidden" name="attr_weapon_critdamagesmallmedium_macro_npc_text">@{whisper_npc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsSM=[[ (@{weapon_critdamagesmallmedium}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{crit=[[ @{toggle_critdamage} ]]}}</textarea>
                </summary>
                <label class="label-under toggle-critdamage">
                  <button class="text-only hide-as-npc" type="roll" name="roll_weapon_critdamagesmallmedium_roll" title="%{repeating_weapon_$X_weapon_critdamagesmallmedium_roll} | PC Roll" value="@{weapon_critdamagesmallmedium_macro_text}"><span class="dice-button nowrap">Roll Crit</span></button>
                  <button class="text-only hide-as-pc" type="roll" name="roll_weapon_critdamagesmallmedium_npc_roll" title="%{repeating_weapon_$X_weapon_critdamagesmallmedium_npc_roll} | NPC Roll" value="@{weapon_critdamagesmallmedium_macro_npc_text}"><span class="dice-button nowrap">Roll Crit</span></button>
                  <textarea class="height-short toggle-macros" name="attr_weapon_critdamagesmallmedium" title="@{repeating_weapon_$X_weapon_critdamagesmallmedium} | Crit Damage roll in lieu of normal damage roll.  Defaults to x2 of the weapon's normal damage. ie @{weapon_damagesmallmedium}*2">@{weapon_damagesmallmedium}*2</textarea>
                </label>
              </details>
              <details class="large-damage">
                <summary>
                  <span class="material-icons custom-btn-nav toggle-critdamage"></span>
                  <input type="text" class="width-medium" name="attr_weapon_damagelarge" title="@{repeating_weapon_$X_weapon_damagelarge}" value="" placeholder="1d6" />
                  <button class="text-only hide-as-npc" type="roll" name="roll_weapon_damagelarge_roll" title="%{repeating_weapon_$X_weapon_damagelarge_roll} | PC Roll" value="@{weapon_damagelarge_macro_text}"><span class="dice-button nowrap">DMG LG</span></button>
                  <button class="text-only hide-as-pc" type="roll" name="roll_weapon_damagelarge_npc_roll" title="%{repeating_weapon_$X_weapon_damagelarge_npc_roll} | NPC Roll" value="@{weapon_damagelarge_macro_npc_text}"><span class="dice-button nowrap">DMG LG</span></button>
                  <input type="hidden" name="attr_weapon_damagelarge_chat_menu" value="" />
                  <input type="hidden" name="attr_weapon_critdamagelarge_chat_menu" value="" />
                  <!--NPC version-->
                  <input type="hidden" name="attr_weapon_damagelarge_npc_chat_menu" value="" />
                  <input type="hidden" name="attr_weapon_critdamagelarge_npc_chat_menu" value="" />

                  <textarea class="hidden" name="attr_weapon_damagelarge_macro_text">@{whisper_pc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsL=[[ (@{weapon_damagelarge}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}}</textarea>

                  <textarea class="hidden" name="attr_weapon_critdamagelarge_macro_text">@{whisper_pc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsL=[[ (@{weapon_critdamagelarge}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{crit=[[ @{toggle_critdamage} ]]}}</textarea>
                  <!--NPC version-->
                  <textarea class="hidden" name="attr_weapon_damagelarge_macro_npc_text">@{whisper_npc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsL=[[ (@{weapon_damagelarge}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}}</textarea>

                  <textarea class="hidden" name="attr_weapon_critdamagelarge_macro_npc_text">@{whisper_npc} &{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{damage1vsL=[[ (@{weapon_critdamagelarge}) * @{weapon_backstab_mult}[MULT] + ( @{weapon_attackdmgbonus}[DMG_BON] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{crit=[[ @{toggle_critdamage} ]]}}</textarea>
                </summary>
                <label class="label-under toggle-critdamage">
                  <button class="text-only hide-as-npc" type="roll" name="roll_weapon_critdamagelarge_roll" title="%{repeating_weapon_$X_weapon_critdamagelarge_roll} | PC Roll" value="@{weapon_critdamagelarge_macro_text}"><span class="dice-button nowrap">Roll Crit</span></button>
                  <button class="text-only hide-as-pc" type="roll" name="roll_weapon_critdamagelarge_npc_roll" title="%{repeating_weapon_$X_weapon_critdamagelarge_npc_roll} | NPC Roll" value="@{weapon_critdamagelarge_macro_npc_text}"><span class="dice-button nowrap">Roll Crit</span></button>
                  <textarea class="height-short toggle-macros" name="attr_weapon_critdamagelarge" title="@{repeating_weapon_$X_weapon_critdamagelarge} | Crit Damage roll instead of normal damage roll.  Defaults to x2 of the weapon's normal damage. ie @{weapon_damagelarge}*2">@{weapon_damagelarge}*2</textarea>
                </label>
              </details>
              <!--inserted into the NPC attack roll. Needed so that damage chat menu respects the whisper_npc setting-->
              <input type="hidden" name="attr_weapon_damage_chat_menu_npc" value="{{damagevsSMchatmenu=@{weapon_damagesmallmedium_npc_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_npc_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_npc_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_npc_chat_menu}}}" />
              <label class="label-under-small toggle-backstab hide-if-ranged center">
                <span class="two-inputs-over-label">
                  <input type="checkbox" class="toggle-field" name="attr_weapon_backstab_flag" title="@{repeating_weapon_$X_weapon_backstab_flag}" value="1" />
                  <input type="text" class="width-smaller" name="attr_weapon_backstab" value="1" title="@{repeating_weapon_$X_weapon_backstab_mult} | Uses the value from @{backstab} from the Thief Skills section below." readonly />
                  <input type="number" class="hidden" name="attr_weapon_backstab_mult" value="1" />
                </span>
                <span class="hide-overflowing-text" title="Apply a multiplier to the weapon damage rolled.">Backstab Mult</span>
              </label>
              <label class="label-under-small">
                <input type="text" class="width-medium" name="attr_weapon_attackdmgbonus" title="@{repeating_weapon_$X_weapon_attackdmgbonus}" value="0" />
                <span>DMG Adj.</span>
              </label>
              <label class="label-under-small" title="@{repeating_weapon_$X_weapon_attackdmgtype} | (P)iercing, (S)lashing, (B)ludgeoning, etc.">
                <input type="text" class="width-medium" name="attr_weapon_attackdmgtype" value="" placeholder="-" />
                <span>DMG Type</span>
              </label>
              <label class="label-under-small hide-if-melee">
                <input type="text" class="width-small" name="attr_weapon_rateoffire" title="@{repeating_weapon_$X_weapon_rateoffire}" value="" placeholder="-" />
                <span>Rate</span>
              </label>
              <input type="checkbox" class="hidden toggle-input-error" name="attr_weapon_range_error" value="1" />
              <label class="label-under-small hide-if-melee center">
                <input type="text" class="width-medium" name="attr_weapon_range" title="@{repeating_weapon_$X_weapon_range} | Enter Short/Medium/Long ranges. Enter numbers only, seperated by '/'. Entering a single value will be used for all ranges." value="" placeholder="S/M/L" />
                <span class="hide-if-ranged-touch hide-overflowing-text">RNG S/M/L</span>
                <span class="ranged-touch">Range</span>
              </label>
              <!--use sheetworker to parse weapon_range into separate ranges-->
              <input type="text" class="hidden" name="attr_weapon_range_short" value="1" />
              <input type="text" class="hidden" name="attr_weapon_range_medium" value="2" />
              <input type="text" class="hidden" name="attr_weapon_range_long" value="3" />
              <label class="label-under-small hide-if-ranged">
                <input type="text" class="width-smaller" name="attr_weapon_num_attacks" value="1" title="@{repeating_weapon_$X_weapon_num_attacks} | Indicate the number of multiple attacks." />
                <span>#Attacks</span>
              </label>
              <label class="label-under-small hide-if-melee">
                <span class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_weapon_ammo" value="0" title="@{repeating_weapon_$X_weapon_ammo} | Use for resource tracking." />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_weapon_ammo_max" value="0" title="@{repeating_weapon_$X_weapon_ammo_max} | Use for resource tracking." />
                </span>
                <span>Ammo/Max</span>
              </label>
              <label class="label-under-small">
                <input type="text" class="width-smaller" name="attr_weapon_quantity" value="1" title="@{repeating_weapon_$X_weapon_quantity}" />
                <span>QTY</span>
              </label>
              <label class="label-under-small">
                <textarea class="hidden" name="attr_weapon_whisper_to_hit"></textarea>
                <select class="select-over-label" name="attr_weapon_whisper_to_hit_select" title="@{repeating_weapon_$X_weapon_whisper_to_hit_select}">
                  <option value="0" class="matrix-box" selected>Matrix</option>
                  <option value="1" class="thac0-box">THACO</option>
                  <option value="2">No</option>
                </select>
                <span title="Include '/w gm Hit table'?">/w gm?</span>
              </label>
            </span>
            <!--deprecated: weapon_dmgbonus has been replaced with weapon_attackdmgbonus-->
            <input type="hidden" name="attr_weapon_dmgbonus" value="0" />
            <input type="hidden" name="attr_weapon_weight" value="0" />
            <input type="hidden" name="attr_weapon_cost" value="0" />
          </div>
          <details class="border-bottom-half">
            <summary>
              <span class="material-icons gear-nav"></span>
            </summary>
            <span class="to-hit-adj-box">
              <span class="to-hit center">
                <input type="text" class="width-small" name="attr_weapon_speed" title="@{repeating_weapon_$X_weapon_speed}" value="" placeholder="-" />
                <input type="text" class="width-small" name="attr_weapon_length" title="@{repeating_weapon_$X_weapon_length}" value="" placeholder="-" />
                <input type="text" class="width-small" name="attr_weapon_space" title="@{repeating_weapon_$X_weapon_space}" value="" placeholder="-" />
                <h5>Armor Type:</h5>
                <span>0</span>
                <span>1</span>
                <span>2</span>
                <span>3</span>
                <span>4</span>
                <span>5</span>
                <span>6</span>
                <span>7</span>
                <span>8</span>
                <span>9</span>
                <span>10</span>
                <input type="checkbox" name="attr_weapon_tohitacadj_flag" title="@{repeating_weapon_$x_weapon_tohitacadj_flag}" value="1" />
                <input type="text" class="hidden" name="attr_weapon_tohitacadj" value="{{ToHitACadj2to10}}" />
              </span>
              <span class="to-hit-input center">
                <label class="label-under-small">SPD</label>
                <label class="label-under-small">LEN</label>
                <label class="label-under-small">SPC</label>
                <h5>Adjustment:</h5>
                <span><input type="text" name="attr_weapon_thac_adj0" title="@{repeating_weapon_$x_weapon_thac_adj0}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj1" title="@{repeating_weapon_$x_weapon_thac_adj1}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj2" title="@{repeating_weapon_$x_weapon_thac_adj2}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj3" title="@{repeating_weapon_$x_weapon_thac_adj3}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj4" title="@{repeating_weapon_$x_weapon_thac_adj4}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj5" title="@{repeating_weapon_$x_weapon_thac_adj5}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj6" title="@{repeating_weapon_$x_weapon_thac_adj6}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj7" title="@{repeating_weapon_$x_weapon_thac_adj7}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj8" title="@{repeating_weapon_$x_weapon_thac_adj8}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj9" title="@{repeating_weapon_$x_weapon_thac_adj9}" value="0" /></span>
                <span><input type="text" name="attr_weapon_thac_adj10" title="@{repeating_weapon_$x_weapon_thac_adj10}" value="0" /></span>
                <label class="label-under-small stack-text">show w/roll</label>
              </span>
            </span>
            <textarea class="height-short" name="attr_weapon_notes" title="@{repeating_weapon_$X_weapon_notes}" placeholder="Description"></textarea>
            <textarea class="height-short toggle-macros" name="attr_weapon_macro_text" title="@{repeating_weapon_$X_weapon_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + ( @{weapon_backstab_bonus}[BACKSTAB] ) + ( @{weapon_tohitbonus}[HIT_BON] ) + ( @{weapon_prof_pen}[PROF_PEN] ) + ( @{weapon_dual_pen}[DUAL_PEN] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{To Hit Modifier?|0}[MISC_MOD] ) ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=[[ @{toggle_critdamage} ]]}} @{weapon_tohitacadj}</textarea>
          </details>
        </fieldset>
      </div>
      <hr class="hide-as-npc">
    </section>
    <!-- Equipment -->
    <section class="equipment-box">
      <input type="checkbox" class="sect-show" name="attr_equipment_info_show" value="1" />
      <div class="header">EQUIPMENT</div><span class="material-icons"></span>
      <div class="equipment-tabs section">
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="0" /><span class="tab">Gear</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="1" /><span class="tab">Weapon</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="2" /><span class="tab">Armor</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="3" /><span class="tab">Magic</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="4" /><span class="tab">Other</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_type" value="-1" checked /><span class="tab">All</span>

        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_carry" value="1" style="margin-left: 10%;" /><span class="tab">Carried</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_carry" value="0" /><span class="tab">Not Carried</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_carry" value="2" /><span class="tab">Mount</span>
        <input type="radio" class="tab-hidden tab" name="attr_equipment_tabs_carry" value="-1" checked /><span class="tab">All</span>
      </div>
      <div class="section">
        <input type="hidden" class="hidden equipment-display-type" name="attr_equipment_tabs_type" value="-1"/>
        <input type="hidden" class="hidden equipment-display-carry" name="attr_equipment_tabs_carry" value="-1"/>
        <span class="equipment-columns column-header">
          <span></span>
          <span>Item</span>
          <span>Location</span>
          <span>Type</span>
          <span class="hidden-for-armor">Uses</span>
          <span class="hidden-for-armor">/</span>
          <span class="hidden-for-armor">Max</span>
          <span>Carried?</span>
          <span>Qty</span>
          <span>/</span>
          <span>Max</span>
          <span>Wt</span>
          <span class="toggle-costs">Cost</span>
        </span>
        <fieldset class="repeating_equipment">
          <input type="hidden" class="toggle-carry" name="attr_equipment_show_carry" value="1" readonly />
          <input type="hidden" class="toggle-type" name="attr_equipment_show_type" value="1" readonly />
          <div class="equipment-display-carry section">
            <div class="equipment-display-type">
              <span class="top-row equipment-columns border-top-half">
                <button class="dice-button" type="roll" name="attr_equipment_roll" title="%{repeating_equipment_$X_equipment_roll}" value="@{equipment_macro_text}"></button>
                <input type="text" class="width-fill" name="attr_equipment_item" title="@{repeating_equipment_$X_equipment_item}" value="" placeholder="Item/Description" />
                <input type="text" class="width-fill" name="attr_equipment_location" title="@{repeating_equipment_$X_equipment_location}" value="" placeholder="Location" />
                <select class="equipment-type" name="attr_equipment_type" title="@{repeating_equipment_$X_equipment_type}">
                  <option value="0" selected>Gear</option>
                  <option value="1">Weapon</option>
                  <option value="2">Armor</option>
                  <option value="3">Magic</option>
                  <option value="4">Other</option>
                </select>
                <input type="hidden" class="hidden equipment-type" name="attr_equipment_type" value="0" />
                <input type="text" class="width-smaller hidden-for-armor" name="attr_equipment_current" title="@{repeating_equipment_$X_equipment_current}" value="0" />
                <span class="hidden-for-armor">/</span>
                <input type="text" class="width-smaller hidden-for-armor" name="attr_equipment_current_max" title="@{repeating_equipment_$X_equipment_current|max}" value="0" />
                <select class="width-medium" name="attr_equipment_carried_select" title="@{repeating_equipment_$X_equipment_carried_select} | Carried items are used for weight calculations.">
                  <option value="0">No</option>
                  <option value="1" selected>Yes</option>
                  <option value="2">Mount</option>
                </select>
                <input type="checkbox" class="hidden" name="attr_equipment_carried" value="1" checked />
                <input type="text" class="width-smaller" name="attr_equipment_quantity" title="@{repeating_equipment_$X_equipment_quantity} | Used for weight and cost calculations." value="1" />
                <span>/</span>
                <input type="text" class="width-smaller" name="attr_equipment_quantity_max" title="@{repeating_equipment_$X_equipment_quantity|max}" value="" placeholder="n/a" />
                <input type="text" class="width-fill" name="attr_equipment_weight" title="@{repeating_equipment_$X_equipment_weight} | Weight for one item." value="0" />
                <input type="text" class="width-fill toggle-costs" name="attr_equipment_cost" title="@{repeating_equipment_$X_equipment_cost} | Cost for one item." value="0" />
              </span>
              <details class="border-bottom-half">
                <summary>
                  <span class="material-icons gear-nav"></span>
                </summary>
                <!-- sync armor-->
                <span class="span-all show-for-armor inline-label" title="Choose an Armor Type first to unlock fields.">
                  <input type="hidden" class="toggle-armor-details show-shield-only" name="attr_equipment_armor_type" value="99" />
                  <label class="label-under-small">
                    <select name="attr_equipment_armor_type" title="@{repeating_equipment_$X_equipment_armor_type}">
                      <option value="99" selected>choose</option>
                      <option value="0">Clothing</option>
                      <option value="1">Armor 1</option>
                      <option value="2">Armor 2</option>
                      <option value="3">Shield</option>
                      <option value="4">Helmet</option>
                      <option value="5">Other 1</option>
                      <option value="6">Other 2</option>
                      <option value="7">Other 3</option>
                      <option value="8">Other 4</option>
                      <option value="9">Other 5</option>
                      <option value="10">Other 6</option>
                    </select>
                    <span>Type</span>
                  </label>
                  <label class="label-under-small">
                    <input type="checkbox" name="attr_equipment_armor_worn" value="1" title="@{repeating_equipment_$X_equipment_armor_worn}" />
                    <span>In Use</span>
                  </label>
                  <label class="label-under-small">
                    <select class="show-shield-only" name="attr_equipment_armor_ac" title="@{repeating_equipment_$X_equipment_armor_ac} | ie +2 lowers AC by -2.">
                      <option value="0" selected>+0</option>
                      <option value="-1">+1</option>
                      <option value="-2">+2</option>
                      <option value="-3">+3</option>
                      <option value="-4">+4</option>
                      <option value="-5">+5</option>
                      <option value="-6">+6</option>
                      <option value="-7">+7</option>
                      <option value="-8">+8</option>
                      <option value="-9">+9</option>
                      <option value="-10">+10</option>
                    </select>
                    <select name="attr_equipment_armor_ac" title="@{repeating_equipment_$X_equipment_armor_ac} | Enter the actual AC value for this item.">
                      <option value="10" selected>10</option>
                      <option value="9">9</option>
                      <option value="8">8</option>
                      <option value="7">7</option>
                      <option value="6">6</option>
                      <option value="5">5</option>
                      <option value="4">4</option>
                      <option value="3">3</option>
                      <option value="2">2</option>
                      <option value="1">1</option>
                      <option value="0">0</option>
                      <option class="hidden" value="-1">-1</option>
                      <option class="hidden" value="-2">-2</option>
                      <option class="hidden" value="-3">-3</option>
                      <option class="hidden" value="-4">-4</option>
                      <option class="hidden" value="-5">-5</option>
                      <option class="hidden" value="-6">-6</option>
                      <option class="hidden" value="-7">-7</option>
                      <option class="hidden" value="-8">-8</option>
                      <option class="hidden" value="-9">-9</option>
                      <option class="hidden" value="-10">-10</option>
                    </select>
                    <span>AC</span>
                  </label>
                  <label class="label-under-small hide-ar">
                    <select class="show-shield-only" name="attr_equipment_armor_base" title="@{repeating_equipment_$X_equipment_armor_base} | ie +2 lowers AR by -2.">
                      <option value="0" selected>+0</option>
                      <option value="-1">+1</option>
                      <option value="-2">+2</option>
                      <option value="-3">+3</option>
                      <option value="-4">+4</option>
                      <option value="-5">+5</option>
                      <option value="-6">+6</option>
                      <option value="-7">+7</option>
                      <option value="-8">+8</option>
                      <option value="-9">+9</option>
                      <option value="-10">+10</option>
                    </select>
                    <select name="attr_equipment_armor_base" title="@{repeating_equipment_$X_equipment_armor_base}| Enter the actual AR value for this item.">
                      <option value="10" selected>10</option>
                      <option value="9">9</option>
                      <option value="8">8</option>
                      <option value="7">7</option>
                      <option value="6">6</option>
                      <option value="5">5</option>
                      <option value="4">4</option>
                      <option value="3">3</option>
                      <option value="2">2</option>
                      <option value="1">1</option>
                      <option value="0">0</option>
                      <option class="hidden" value="-1">-1</option>
                      <option class="hidden" value="-2">-2</option>
                      <option class="hidden" value="-3">-3</option>
                      <option class="hidden" value="-4">-4</option>
                      <option class="hidden" value="-5">-5</option>
                      <option class="hidden" value="-6">-6</option>
                      <option class="hidden" value="-7">-7</option>
                      <option class="hidden" value="-8">-8</option>
                      <option class="hidden" value="-9">-9</option>
                      <option class="hidden" value="-10">-10</option>
                    </select>
                    <span>AR</span>
                  </label>
                  <input type="checkbox" class="hidden toggle-input-error hide-magic" name="attr_equipment_armor_magic_error" value="1" checked />
                  <label class="label-under-small hide-magic">
                    <input type="text" class="width-small" name="attr_equipment_armor_magic" value="0" title="@{repeating_equipment_$X_equipment_armor_magic} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
                    <span>Magic</span>
                  </label>
                  <input type="checkbox" class="hidden toggle-input-erro hide-misc" name="attr_equipment_armor_mod_error" value="1" checked />
                  <label class="label-under-small hide-misc">
                    <input type="text" class="width-small" name="attr_equipment_armor_mod" value="0" title="@{repeating_equipment_$X_equipment_armor_mod} | Bonuses lower AC.  Penalties raise AC.  ie '+2' bonus lowers AC by -2 while a '-2' penalty will raise AC by 2." />
                    <span>Misc</span>
                  </label>
                  <label class="label-under-small hide-bulk">
                    <select name="attr_equipment_armor_bulk" title="@{repeating_equipment_$X_equipment_armor_bulk}">
                      <option value="0" selected>n/a</option>
                      <option value="1">non-Bulky 12"</option>
                      <option value="2">Fairly 9"</option>
                      <option value="3">Bulky 6"</option>
                    </select>
                    <span>Bulk</span>
                  </label>
                  <label style="margin-top: 0;">
                    <button type="action" name="act_addarmor" title="Adds armor to the selected Armor Details row. Items will be synced."><span>+Add</span></button>
                  </label>
                </span>
                <span class="span-all show-for-weapons inline-label">
                  <label class="label-under-small">
                    <select name="attr_equipment_weapon_type" class="select-over-label" title="@{repeating_equipment_$X_equipment_weapon_type}">
                      <option value="0" selected>Melee</option>
                      <option value="1">Ranged</option>
                      <option value="2">Touch</option>
                      <option value="3">Ranged Touch</option>
                    </select>
                    <span>Type</span>
                  </label>
                  <input type="hidden" class="toggle-weapon-details" name="attr_equipment_weapon_type" value="0" />
                  <label class="label-under-small hide-melee">
                    <input type="text" class="width-small" name="attr_equipment_weapon_speed" title="@{repeating_equipment_$X_equipment_weapon_speed}" value="" placeholder="-" />
                    <span>SPD</span>
                  </label>
                  <label class="label-under-small hide-melee">
                    <input type="text" class="width-small" name="attr_equipment_weapon_length" title="@{repeating_equipment_$X_equipment_weapon_length}" value="" placeholder="-" />
                    <span>LEN</span>
                  </label>
                  <label class="label-under-small hide-melee">
                    <input type="text" class="width-small" name="attr_equipment_weapon_space" title="@{repeating_equipment_$X_equipment_weapon_space}" value="" placeholder="-" />
                    <span>SPC</span>
                  </label>
                  <label class="label-under-small">
                    <input type="text" class="width-medium" name="attr_equipment_weapon_damagesmallmedium" title="@{repeating_equipment_$X_equipment_weapon_damagesmallmedium}" value="" placeholder="1d4" />
                    <span>S/M</span>
                  </label>
                  <label class="label-under-small">
                    <input type="text" class="width-medium" name="attr_equipment_weapon_damagelarge" title="@{repeating_equipment_$X_equipment_weapon_damagelarge}" value="" placeholder="1d4" />
                    <span>LG</span>
                  </label>
                  <label class="label-under-small">
                    <input type="text" class="width-small" name="attr_equipment_weapon_attackdmgtype" title="@{repeating_equipment_$X_equipment_weapon_attackdmgtype}" value="" placeholder="-" />
                    <span>DMG Type</span>
                  </label>
                  <label class="label-under-small hide-ranged">
                    <input type="text" class="width-small" name="attr_equipment_weapon_rateoffire" title="@{repeating_equipment_$X_equipment_weapon_rateoffire}" value="" placeholder="-" />
                    <span>RT</span>
                  </label>
                  <label class="label-under-small hide-ranged">
                    <input type="text" class="width-medium" name="attr_equipment_weapon_range" title="@{repeating_equipment_$X_equipment_weapon_range} | Enter Short/Medium/Long ranges. Enter numbers only, seperated by '/'. Entering a single value will be used for all ranges." value="" placeholder="-" />
                    <span>RNG S/M/L</span>
                  </label>
                  <label style="margin-top: 0;">
                    <button type="action" name="act_addattack" title="Adds weapon to attacks. Creates a unique, non-synced, attack."><span>+Add</span></button>
                  </label>
                </span>
                <span class="inline-label">
                  <textarea class="height-short" name="attr_equipment_description" title="@{repeating_equipment_$X_equipment_description}" value="" placeholder="Description"></textarea>
                  <label>
                    <button type="roll" class="info-link" value="@{whisper_pc} [**LINK**](@{equipment_link})" title="Send link to chat."></button>
                    <textarea class="info-link" wrap="off" name="attr_equipment_link" title="@{repeating_equipment_$X_equipment_link}" placeholder="https://www.example.com"></textarea>
                  </label>
                </span>
                <textarea class="height-short toggle-macros" name="attr_equipment_macro_text" title="@{repeating_equipment_$X_equipment_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Item/Equipment: @{equipment_item}}} {{link=@{equipment_link}}} {{freetext=@{equipment_description}}} {{quantity= @{equipment_quantity}}} {{quantity_max=@{equipment_quantity|max}}} {{uses=@{equipment_current}}} {{uses_max=[[ @{equipment_current|max} ]]}}</textarea>
              </details>
            </div>
          </div>
        </fieldset>
      </div>
      <div class="sect four-columns">
        <div class="capacity-box">
          <textarea class="height-fill" name="attr_itemnotes" title="@{itemnotes}" placeholder="Equipment Notes"></textarea>
        </div>
        <!--Weight/Cost Totals-->
        <div class="equipment-totals">
          <label style="max-width: 100%;">
            <span>Use Lbs:</span>
            <input type="checkbox" class="toggle-lbs" name="attr_toggle_lbs" value="1" title="@{toggle_lbs} | Use Lbs instead of gold pieces when determining encumbrance. Carying capacities and carried coin weight will be divided by 10. Per-item weights need to be entered as lbs in order for the sheet to properly calculate encumbrance.">
          </label>
          <label class="center"><span class="toggle-lbs">Wt in GP</span><span>Wt in Lbs</span></label>
          <label class="center toggle-costs">Cost</label>
          <label><span>Equipment:</span></label>
          <input type="text" class="hidden width-fill" name="attr_total_equipment_weight" value="0" readonly />
          <!-- show equipment weight w/out armor and weapon weight -->
          <input type="text" class="width-fill" name="attr_total_equipment_weight_adjusted" title="@{total_equipment_weight_adjusted} | Carried Equipment Weight - Weapons and Armor." value="0" readonly />
          <input type="text" class="width-fill toggle-costs" name="attr_total_equipment_cost" title="@{total_equipment_cost}" value="0" readonly />

          <!-- HIDDEN BECAUSE ARMOR and Weapons are NOW INCLUDED IN EQUIPMENT CALCS -->
          <label><span>Armor:</span></label>
          <input type="text" class="width-fill" name="attr_total_armor_weight" value="0" title="@{total_armor_weight}" readonly />
          <label class="width-fill center toggle-costs">---</label>
          <input type="text" class="hidden width-fill toggle-costs" name="attr_total_armor_cost" value="0" readonly />
          <label><span>Weapons:</span></label>
          <input type="text" class="width-fill" name="attr_total_weapon_weight" value="0" title="@{total_weapon_weight}" readonly />
          <label class="width-fill center toggle-costs">---</label>
          <input type="text" class="hidden width-fill toggle-costs" name="attr_total_weapon_cost" value="0" readonly />

          <label><span>Coins:</span></label>
          <input type="text" class="width-fill" name="attr_total_coin_weight" title="@{total_coin_weight}" value="0" readonly />
          <label class="width-fill center toggle-costs">---</label>
          <label><span>TOTALS:</span></label>
          <input type="text" class="readonly-span" name="attr_total_weight" title="@{total_weight} | Total Carried Weight." value="0" readonly />
          <input type="text" class="readonly-span toggle-costs" name="attr_total_cost" title="@{total_cost} | Total Equipment Costs." value="0" readonly />
        </div>
      </div>
      <!--Wealth-->
      <div class="wealth-box border sect">
        <span class="subheader center width-fill">Wealth</span>
        <div class="coin-columns column-header">
          <span></span>
          <span>Copper</span>
          <span>Silver</span>
          <span>Electrum</span>
          <span>Gold</span>
          <span>Platinum</span>
        </div>
        <div class="coin-columns">
          <label class="text-large right"><span>Carried Coins:</span></label>
          <input type="text" class="width-medium" name="attr_cp" title="@{cp}" value="0" />
          <input type="text" class="width-medium" name="attr_sp" title="@{sp}" value="0" />
          <input type="text" class="width-medium" name="attr_ep" title="@{ep}" value="0" />
          <input type="text" class="width-medium" name="attr_gp" title="@{gp}" value="0" />
          <input type="text" class="width-medium" name="attr_pp" title="@{pp}" value="0" />
          <label class="span-all">
            <span class="text-small"><b>hint:</b> 200cp = 20sp = 2ep = 1gp = 1/5pp</span>
          </label>
        </div>
        <hr>
        <div class="coin-columns">
          <label class="text-large right"><span>Total Coins:</span></label>
          <input type="text" class="width-medium" name="attr_cp-total" title="@{cp-total}" value="0" />
          <input type="text" class="width-medium" name="attr_sp-total" title="@{sp-total}" value="0" />
          <input type="text" class="width-medium" name="attr_ep-total" title="@{ep-total}" value="0" />
          <input type="text" class="width-medium" name="attr_gp-total" title="@{gp-total}" value="0" />
          <input type="text" class="width-medium" name="attr_pp-total" title="@{pp-total}" value="0" />
        </div>
        <textarea class="height-tall" name="attr_wealthNotes" title="@{wealthNotes}" placeholder="Wealth Notes"></textarea>
      </div>
      <!--Carrying Capacity-->
      <div class="span-all border sect">
        <span class="subheader center width-fill">Carrying Capacity</span>
        <div class="capacity-box-loads column-header">
          <span class="span-three">Strength Adj.</span>
          <span class="span-four">
            <span>Current Encumbrance</span>
            <span class="toggle-lbs text-small">(gp)</span><span class="text-small">(lbs)</span>
          </span>
        </div>
        <div class="capacity-box-loads center">
          <label class="label-under" title="@{normal_load} 'Unencumbered load' (defaults 350gp based on STR 8-11.)">
            <input type="text" class="hidden" name="attr_normal_load" value="350" readonly />
            <span type="text" class="readonly-span" name="attr_normal_load" title="@{normal_load} 'Unencumbered load' (defaults 350gp based on STR 8-11.)"></span>
            <span class="inline-label">
              <span>Base</span>
              <span class="toggle-lbs text-small">(gp)</span><span class="text-small">(lbs)</span>
            </span>
          </label>
          <label class="label-under">
            <span class="center toggle-lbs" title="@{encumbrancebonus} | Weight Allowance in gp. Keep this value as gp even if the sheet is using the lbs option.">
              <input class="hidden" type="text" name="attr_encumbrancebonus" value="0" />
              <span class="readonly-span" name="attr_encumbrancebonus"></span>
              <span class="inline-label">
                <span>Weight All.</span>
                <span class="text-small">(gp)</span>
              </span>
            </span>
            <span class="center" title="@{encumbrancebonus_lbs} | Weight Allowance in lbs.">
              <input class="hidden" type="text" name="attr_encumbrancebonus_lbs" value="0" readonly />
              <span class="readonly-span" name="attr_encumbrancebonus_lbs"></span>
              <span class="inline-label">
                <span>Weight All.</span>
                <span class="text-small">(lbs)</span>
              </span>
            </span>
          </label>
          <label class="text-large">=</label>
          <label class="label-under" title="@{normal_load_adjusted} Unencumbered + Weight Allowance.)">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance" value="0" checked="checked" readonly />
            <input type="text" class="hidden" name="attr_normal_load_adjusted" value="0" readonly />
            <span class="readonly-span" name="attr_normal_load_adjusted" title="@{normal_load_adjusted} Unencumbered + Weight Allowance.)"></span>
            <span>Unencumbered</span>
          </label>
          <label class="label-under" title="@{heavy_load} Heavy load = Unencumbered + (Weight Allowance x2).">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance" value="1" readonly />
            <input type="text" class="hidden" name="attr_heavy_load" value="0" readonly />
            <span class="readonly-span" name="attr_heavy_load" title="@{heavy_load} Heavy load = Unencumbered + (Weight Allowance x2)."></span>
            <span>Heavy</span>
          </label>
          <label class="label-under" title="@{very_heavy_load} Very heavy load = Unencumbered + (Weight Allowance x3).">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance" value="2" readonly />
            <input type="text" class="hidden" name="attr_very_heavy_load" value="0" readonly />
            <span class="readonly-span" name="attr_very_heavy_load" title="@{very_heavy_load} Very heavy load = Unencumbered + (Weight Allowance x3)."></span>
            <span>Very Heavy</span>
          </label>
          <label class="label-under" title="@{max_load} Any amount greater than; Unencumbered + (Weight Allowance x3).">
            <input type="checkbox" class="hidden current-encumbrance" name="attr_current_encumbrance" value="3" readonly />
            <span>
              <input type="text" class="hidden" name="attr_max_load" value="0" readonly />
              <span class="readonly-span" name="attr_max_load" title="@{max_load} Any amount greater than; Unencumbered + (Weight Allowance x3).">
              </span>
              <b class="text-large">+</b>
            </span>
            <span>Encumbered</span>
          </label>
        </div>
      </div>
      <hr>
    </section>
    <!-- Special Abilities -->
    <section class="special-abilities-box">
      <input type="checkbox" class="sect-show" name="attr_special_abilities_info_show" value="1" />
      <div class="header">
        <span class="hide-as-npc">SPECIAL ABILITIES</span>
        <span class="hide-as-pc">SPECIAL ABILITIES</span>
      </div>
      <span class="material-icons"></span>
      <div class="sect">
        <div class="toggle-psionics border">
          <h4 class="subheader center width-fill">Psionics</h4>
          <span class="inline-label">
            <label class="inline-label" title="@{psionic_ability_strength} | Total Psionic Ability = 1d100 + Ability Bonus (ie +1 for each unmodified point of INT, WIS and CHA above 12. In addition, if 2 of these scores are above 16, the number of points is doubled, and if all 3 scores are above 16, the number of points are quadrupled.) x2.">
              <span>Total Ability:</span>
              <input type="text" name="attr_psionic_ability_strength" value="0" class="width-small" />
              <span>/</span>
              <input type="text" name="attr_psionic_ability_strength_max" value="0" class="width-small" />
            </label>
            <label class="inline-label">
              <span>Psionic Attack:</span>
              <input type="text" name="attr_psionic_attack" value="0" class="width-small" title="@{psionic_attack}" />
              <span>/</span>
              <input type="text" name="attr_psionic_attack_max" value="0" class="width-small" title="@{psionic_attack|max}" readonly />
            </label>
            <label class="inline-label">
              <span>Psionic Defense:</span>
              <input type="text" name="attr_psionic_defense" value="0" class="width-small" title="@{psionic_defense}" />
              <span>/</span>
              <input type="text" name="attr_psionic_defense_max" value="0" class="width-small" title="@{psionic_defense|max}" readonly />
            </label>
          </span>
          <span class="inline-label">
            <label class="inline-label" title="@{psionic_attack_modes} | Add Modes as Special Abilities below.">
              <span>Attack Modes:</span>
              <input type="text" name="attr_psionic_attack_modes" value="" class="width-medium" placeholder="A,B,C,D,E"/>
            </label>
            <label class="inline-label" title="@{psionic_defensive_modes} | Add Modes as Special Abilities below.">
              <span>Defensive Modes:</span>
              <input type="text" name="attr_psionic_defensive_modes" value="" class="width-medium" placeholder="F,G,H,I,J"/>
            </label>
            <label class="inline-label right" title="@{psionic_minor} | Add Disciplines as Special Abilities below."">
              <span>Minor Disciplines:</span>
              <input type="text" name="attr_psionic_minor" value="0" class="width-smallest" />
            </label>
            <label class="inline-label" title="@{psionic_major} | Add Disciplines as Special Abilities below."">
              <span>Major Disciplines:</span>
              <input type="text" name="attr_psionic_major" value="0" class="width-smallest" />
            </label>
          </span>
        </div>
        <label class="left">
          <span>Single Column</span>
          <input type="checkbox" class="toggle-single-column-abilities" name="attr_toggle_single_column_abilities" title="@{toggle_single_column_abilities}" value="1" checked />
        </label>
        <span class="special-abilities-row1 column-header hide-as-npc">
          <span></span>
          <span>Name</span>
          <span>Short Description</span>
          <span>Uses</span>
        </span>
        <span class="special-abilities-row1 column-header two-column-header hide-as-npc">
          <span></span>
          <span>Name</span>
          <span>Uses</span>
          <span></span>
          <span>Name</span>
          <span>Uses</span>
        </span>
        <fieldset class="repeating_ability">
          <span class="top-row special-abilities-row1 border-top-half">
            <button class="dice-button hide-as-npc ability-area-roll" type="roll" name="attr_ability_roll" title="%{repeating_ability_$X_ability_roll} | PC Roll" value="@{whisper_pc} @{ability_macro_text}"></button>
            <!--NPC version-->
            <button class="dice-button hide-as-pc ability-area-roll" type="roll" name="attr_ability_npc_roll" title="%{repeating_ability_$X_ability_npc_roll} | NPC Roll" value="@{whisper_npc} @{ability_macro_text}"></button>
            <label class="repeating-name ability-area-name">
              <input type="text" name="attr_ability_name" title="@{repeating_ability_$X_ability_name}" placeholder="Ability Name" />
            </label>
            <label class="inline-label ability-area-desc">
              <textarea class="height-short" name="attr_ability_short_description" title="@{repeating_ability_$X_ability_short_description}" placeholder="Short Description"></textarea>
            </label>
            <label class="inline-label ability-area-uses">
              <input type="text" class="width-smaller" name="attr_ability_current" title="@{repeating_ability_$X_ability_current}" value="" />
              <span>/</span>
              <input type="text" class="width-smaller" name="attr_ability_current_max" title="@{repeating_ability_$X_ability_current|max}" value="0" />
              <!--deprecated; attr_max has been replaced with ability_current_max-->
              <input type="hidden" name="attr_ability_max" value="1" />
            </label>
          </span>
          <details class="border-bottom-half">
            <summary>
              <span class="material-icons gear-nav"></span>
            </summary>
            <div class="special-abilities-row2">
              <label class="label-under-small" title="TIP: Must include a dice roll to be included with the roll. ie 1d6">
                <input type="text" class="width-small" name="attr_ability_die" title="@{repeating_ability_$X_ability_die}" value="1d0" />
                <span>Die</span>
              </label>
              <label class="label-under-small">
                <input type="text" class="width-small" name="attr_ability_mod" title="@{repeating_ability_$X_ability_mod}" value="0" />
                <span>Modifier</span>
              </label>
              <textarea class="height-medium" name="attr_ability_description" title="@{repeating_ability_$X_ability_description}" placeholder="Ability Description"></textarea>
            </div>
            <div class="spell-details-grid">
              <label class="span-two"><span>Effect Type:</span>
                <input type="text" name="attr_ability_effect_type" title="@{repeating_ability_$X_ability_effect_type}" value="" placeholder="n/a" />
              </label>
              <label><span>Spell Level:</span>
                <input type="text" name="attr_ability_level" title="@{repeating_ability_$X_ability_level}" value="" placeholder="n/a" />
              </label>
              <label><span>Casting Time:</span>
                <input type="text" name="attr_ability_ct" title="@{repeating_ability_$X_ability_ct}" value="" placeholder="n/a" />
              </label>
              <label><span>Range:</span>
                <input type="text" name="attr_ability_range" title="@{repeating_ability_$X_ability_range}" value="" placeholder="n/a" />
              </label>
              <label><span>Saving Throw:</span>
                <input type="text" name="attr_ability_save" title="@{repeating_ability_$X_ability_save}" value="" placeholder="n/a" />
              </label>
              <label><span>Duration:</span>
                <input type="text" name="attr_ability_duration" title="@{repeating_ability_$X_ability_duration}" value="" placeholder="n/a" />
              </label>
              <label><span>Save Type:</span>
                <input type="text" name="attr_ability_save_type" title="@{repeating_ability_$X_ability_save_type}" value="" placeholder="n/a" />
              </label>
              <label class="span-two"><span>Area of Effect:</span>
                <input type="text" name="attr_ability_aoe" title="@{repeating_ability_$X_ability_aoe}" value="" placeholder="n/a" />
              </label>
            </div>
            <span class="inline-label">
              <label>
                <span>Notes:</span>
                <textarea name="attr_ability_notes" class="height-short" title="@{repeating_ability_$X_ability_notes}" placeholder="Notes"></textarea>
              </label>
              <label>
                <button type="roll" class="info-link" value="@{whisper_pc} [**LINK**](@{ability_link})" title="Send link to chat."></button>
                <textarea class="info-link" wrap="off" name="attr_ability_link" title="@{repeating_ability_$X_ability_link}" placeholder="https://www.example.com"></textarea>
              </label>
            </span>
            <textarea class="height-short toggle-macros" name="attr_ability_macro_text" title="@{repeating_ability_$X_ability_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ 0 + @{ability_die} + @{ability_mod}[MOD] ]]}} {{link=@{ability_link}}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ 0 + @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}</textarea>
          </details>
        </fieldset>
        <!-- deprecated since each repeating row includes description and notes-->
        <textarea class="hidden" name="attr_special_abilitiesnotes"></textarea>
      </div>
      <hr class="hide-as-npc">
    </section>
    <!-- Non Weapon Proficiencies (NWP) -->
    <section class="nonweapon-proficiencies-box">
      <input type="checkbox" class="sect-show" name="attr_nonweapon_proficiencies_info_show" value="1" style="max-width:18em;"/>
      <div class="header">NON WEAPON PROFICIENCIES</div><span class="material-icons"></span>
      <div class="sect">
        <span class="nonweapon-proficiencies-row1 column-header">
          <span></span>
          <span>Proficiency</span>
          <span>Short Description</span>
          <span>Attribute</span>
          <span>Slots</span>
          <span>Adj.</span>
        </span>
        <fieldset class="repeating_nonweaponproficiencies">
          <span class="top-row nonweapon-proficiencies-row1 border-top-half">
            <button class="dice-button" type="roll" name="attr_nwp_roll" title="%{repeating_nonweaponproficiencies_$X_nwp_roll} |
            * Very easy proficiency = +3 modifier
            * Easy proficiency = +1 modifier
            * Normal proficiency = no modifier
            * Hard proficiency = -1 modifier
            * Very hard proficiency = -2 modifier
            * Extremely hard proficiency = -3 modifier" value="@{nwp_macro_text}"></button>
            <label class="repeating-name">
              <input type="text" name="attr_nwp_name" title="@{repeating_nonweaponproficiencies_$X_nwp_name}" placeholder="Proficiency Name" />
            </label>
            <textarea class="height-short" name="attr_nwp_short_description" title="@{repeating_nonweaponproficiencies_$X_nwp_short_description}" placeholder="Short Description"></textarea>
            <select class="width-medium" name="attr_nwp_attribute" title="%{repeating_nonweaponproficiencies_$X_nwp_attribute}">
              <option value="0" selected>None</option>
              <option value="@{strength}">STR</option>
              <option value="@{dexterity}">DEX</option>
              <option value="@{constitution}">CON</option>
              <option value="@{intelligence}">INT</option>
              <option value="@{wisdom}">WIS</option>
              <option value="@{charisma}">CHA</option>
              <option value="@{comeliness}" class="toggle-comeliness">COM</option>
            </select>
            <input class="width-small" type="text" name="attr_nwp_slots" title="@{repeating_nonweaponproficiencies_$X_nwp_slots}" value="0" />
            <input class="width-small" type="text" name="attr_nwp_modifier" title="@{repeating_nonweaponproficiencies_$X_nwp_modifier}" value="0" />
          </span>
          <details class="border-bottom-half">
            <summary>
              <span class="material-icons gear-nav"></span>
            </summary>
            <span class="inline-label">
              <textarea class="height-short" name="attr_nwp_description" title="@{repeating_nonweaponproficiencies_$X_nwp_description}" placeholder="Ability Description"></textarea>
              <label>
                <button type="roll" class="info-link btn ui-draggable" name="attr_nwp_link_roll" value="@{whisper_pc} [**LINK**](@{nwp_link})" title="@{repeating_nonweaponproficiencies_$X_nwp_link_roll}"></button>
                <textarea class="info-link" wrap="off" name="attr_nwp_link" title="@{repeating_nonweaponproficiencies_$X_nwp_link}" placeholder="https://www.example.com"></textarea>
              </label>
            </span>
            <textarea class="height-short toggle-macros" name="attr_nwp_macro_text" title="@{repeating_nonweaponproficiencies_$X_nwp_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{roll_low=[[ 1d20 + [[ @{nwp_modifier} ]][MOD] + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[ @{nwp_attribute}[ATTR] ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{nwp_mod_applied=[[ @{nwp_modifier} ]]}} {{link=@{nwp_link}}} {{freetext=@{nwp_short_description} @{nwp_description}}}</textarea>
          </details>
        </fieldset>
      </div>
      <hr>
    </section>
    <!-- Thief Skills -->
    <section class="thief-skills-box">
      <input type="checkbox" class="sect-show" name="attr_thief_skills_info_show" value="1" />
      <div class="header">THIEF SKILLS</div><span class="material-icons"></span>
      <div class="sect">
        <span class="thief-columns column-header">
          <span>Function</span>
          <span>TOTAL</span>
          <span></span>
          <span>Base/Level</span>
          <span></span>
          <span>Dex Adj.</span>
          <span></span>
          <span>Racial Adj.</span>
          <span></span>
          <span>Magic/Item</span>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_pickpockets" title="%{selected|pickpockets}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Pick Pockets}} {{roll_low=[[ 1d100 ]]%}} {{roll_target= [[ @{pickpockets} ]]%}}"><span>Pick Pockets</span></button>
          <label class="label-percent" title="@{pickpockets}">
            <input type="text" name="attr_pickpockets" class="field-border readonly-span" title="@{pickpockets}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_pickpockets_base" class="width-smaller" title="@{pickpockets_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_pickpockets_ability_mod" class="width-smaller" title="@{pickpockets_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_pickpockets_racial_mod" class="width-smaller" title="@{pickpockets_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_pickpockets_magic" class="width-smaller" title="@{pickpockets_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_openlocks" title="%{selected|openlocks}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Open Locks}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{openlocks} ]]%}}"><span>Open Locks</span></button>
          <label class="label-percent" title="@{openlocks}">
            <input type="text" name="attr_openlocks" class="field-border readonly-span" title="@{openlocks}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_openlocks_base" class="width-smaller" title="@{openlocks_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_openlocks_ability_mod" class="width-smaller" title="@{openlocks_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_openlocks_racial_mod" class="width-smaller" title="@{openlocks_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_openlocks_magic" class="width-smaller" title="@{openlocks_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_findtraps" title="%{selected|findtraps}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Find/Remove Traps}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{findtraps} ]]%}}"><span>Find/Remove Traps</span></button>
          <label class="label-percent" title="@{findtraps}">
            <input type="text" name="attr_findtraps" class="field-border readonly-span" title="@{findtraps}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_findtraps_base" class="width-smaller" title="@{findtraps_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_findtraps_ability_mod" class="width-smaller" title="@{findtraps_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_findtraps_racial_mod" class="width-smaller" title="@{findtraps_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_findtraps_magic" class="width-smaller" title="@{findtraps_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_movequietly" title="%{selected|movequietly}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Move Silently}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{movequietly} ]]%}}"><span>Move Silently</span></button>
          <label class="label-percent" title="@{movequietly}">
            <input type="text" name="attr_movequietly" class="field-border readonly-span" title="@{movequietly}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_movequietly_base" class="width-smaller" title="@{movequietly_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_movequietly_ability_mod" class="width-smaller" title="@{movequietly_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_movequietly_racial_mod" class="width-smaller" title="@{movequietly_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_movequietly_magic" class="width-smaller" title="@{movequietly_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_hideinshadows" title="%{selected|HideInShadows}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Hide In Shadows}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{hideinshadows} ]]%}}"><span>Hide In Shadows</span></button>
          <label class="label-percent" title="@{hideinshadows}">
            <input type="text" name="attr_hideinshadows" class="field-border readonly-span" title="@{hideinshadows}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_hideinshadows_base" class="width-smaller" title="@{hideinshadows_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hideinshadows_ability_mod" class="width-smaller" title="@{hideinshadows_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hideinshadows_racial_mod" class="width-smaller" title="@{hideinshadows_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hideinshadows_magic" class="width-smaller" title="@{hideinshadows_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_hearnoise" title="%{selected|hearnoise}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Hear Noise}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{hearnoise} ]]%}}"><span>Hear Noise</span></button>
          <label class="label-percent" title="@{hearnoise}">
            <input type="text" name="attr_hearnoise" class="field-border readonly-span" title="@{hearnoise}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_hearnoise_base" class="width-smaller" title="@{hearnoise_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hearnoise_ability_mod" class="width-smaller" title="@{hearnoise_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hearnoise_racial_mod" class="width-smaller" title="@{hearnoise_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_hearnoise_magic" class="width-smaller" title="@{hearnoise_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_climbwalls" title="%{selected|climbwalls}" value="@{climbwalls_macro_text}"><span>Climb Walls</span></button>
          <textarea class="hidden" name="attr_climbwalls_macro_text">@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Climb Walls}} {{roll_low=[[ 1d00 ]]%}} {{roll_target=[[ @{climbwalls} ]]%}}</textarea>
          <label class="label-percent" title="@{climbwalls}">
            <input type="text" name="attr_climbwalls" class="field-border readonly-span" title="@{climbwalls}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_climbwalls_base" class="width-smaller" title="@{climbwalls_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_climbwalls_ability_mod" class="width-smaller" title="@{climbwalls_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_climbwalls_racial_mod" class="width-smaller" title="@{climbwalls_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_climbwalls_magic" class="width-smaller" title="@{climbwalls_magic}" value="0" />
          </label>
        </span>
        <span class="thief-columns">
          <button class="text-only thiefskills-button" type="roll" name="roll_readlanguages" title="%{selected|readlanguages}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Read Languages}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{readlanguages} ]]%}}"><span>Read Languages</span></button>
          <label class="label-percent" title="@{readlanguages}">
            <input type="text" name="attr_readlanguages" class="field-border readonly-span" title="@{readlanguages}" value="0" />
          </label>
          <span class="text-large">=</span>
          <label class="label-percent">
            <input type="text" name="attr_readlanguages_base" class="width-smaller" title="@{readlanguages_base}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_readlanguages_ability_mod" class="width-smaller" title="@{readlanguages_ability_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_readlanguages_racial_mod" class="width-smaller" title="@{readlanguages_racial_mod}" value="0" />
          </label>
          <span class="text-large"></span>
          <label class="label-percent">
            <input type="text" name="attr_readlanguages_magic" class="width-smaller" title="@{readlanguages_magic}" value="0" />
          </label>
        </span>
        <input type="checkbox" class="sect-show" name="attr_custom_function_show" value="1" />
        <span class="subheader">Custom Functions</span><span class="material-icons"></span>
        <div class="section">
          <span class="thief-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="text-only thiefskills-button" type="roll" name="roll_thiefmisc" title="%{selected|thiefmisc}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{thiefmisc_name}}} {{roll_low=[[ 1d100 ]] %}} {{roll_target=[[ @{thiefmisc} ]]%}}"><span name="attr_thiefmisc_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_thiefmisc_name" title="@{thiefmisc_name}" value="Custom..." />
            </details>
            <label class="label-percent" title="@{thiefmisc}">
              <input type="text" name="attr_thiefmisc" class="field-border readonly-span" title="@{thiefmisc}" value="0" />
            </label>
            <span class="text-large">=</span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc_base" class="width-smaller" title="@{thiefmisc_base}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc_ability_mod" class="width-smaller" title="@{thiefmisc_ability_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc_racial_mod" class="width-smaller" title="@{thiefmisc_racial_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc_magic" class="width-smaller" title="@{thiefmisc_magic}" value="0" />
            </label>
          </span>
          <span class="thief-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="text-only thiefskills-button" type="roll" name="roll_thiefmisc1" title="%{selected|thiefmisc1}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{thiefmisc1_name}}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{thiefmisc1} ]]%}}"><span name="attr_thiefmisc1_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_thiefmisc1_name" title="@{thiefmisc1_name}" value="Custom..." />
            </details>
            <label class="label-percent" title="@{thiefmisc1}">
              <input type="text" name="attr_thiefmisc1" class="field-border readonly-span" title="@{thiefmisc1}" value="0" />
            </label>
            <span class="text-large">=</span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc1_base" class="width-smaller" title="@{thiefmisc1_base}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc1_ability_mod" class="width-smaller" title="@{thiefmisc1_ability_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc1_racial_mod" class="width-smaller" title="@{thiefmisc1_racial_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc1_magic" class="width-smaller" title="@{thiefmisc1_magic}" value="0" />
            </label>
          </span>
          <span class="thief-columns">
            <details>
              <summary>
                <span class="material-icons custom-btn-nav"></span>
                <button class="text-only thiefskills-button" type="roll" name="roll_thiefmisc2" title="%{selected|thiefmisc2}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{thiefmisc2_name}}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{thiefmisc2} ]]%}}"><span name="attr_thiefmisc2_name"></span></button>
              </summary>
              <input type="text" class="width-fill" name="attr_thiefmisc2_name" title="@{thiefmisc2_name}" value="Custom..." />
            </details>
            <label class="label-percent" title="@{thiefmisc2}">
              <input type="text" name="attr_thiefmisc2" class="field-border readonly-span" title="@{thiefmisc2}" value="0" />
            </label>
            <span class="text-large">=</span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc2_base" class="width-smaller" title="@{thiefmisc2_base}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc2_ability_mod" class="width-smaller" title="@{thiefmisc2_ability_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc2_racial_mod" class="width-smaller" title="@{thiefmisc2_racial_mod}" value="0" />
            </label>
            <span class="text-large"></span>
            <label class="label-percent">
              <input type="text" name="attr_thiefmisc2_magic" class="width-smaller" title="@{thiefmisc2_magic}" value="0" />
            </label>
          </span>
        </div>
        <span class="thief-columns">
          <h4>Backstab:</h4>
          <label class="label-under span-two">
            <span>x
              <input type="text" name="attr_backstab" class="width-smaller" title="@{backstab} | Damage done per hit is twice normal for the weapon used per four XP levels." value="2">
            </span>
            <span>Multiplier</span>
          </label>
          <label class="label-under span-two">
            <span>+
              <input type="text" name="attr_backstab_bonus" class="width-smaller" title="@{backstab_bonus} | Striking by surprise from behind also increases the hit probability by 20% (+4 on the thiefs to hit die roll)." value="4">
            </span>
            <span>To-Hit Adj.</span>
          </label>
        </span>
      </div>
      <hr>
    </section>
    <!-- Spells -->
    <section class="spells-box">
      <input type="checkbox" class="sect-show" name="attr_spells_info_show" value="1" />
      <div class="header">SPELLS</div><span class="material-icons"></span>
      <div class="sect">
        <div class="section center">
          <span class="inline-label">
            <label class="auto-width">
              <h4>Caster Class 1:</h4>
              <input type="text" class="auto-width" name="attr_caster_class1_name" title="@{caster_class1_name}" value="" placeholder="enter caster class" />
            </label>
            <label class="width-medium">
              <h4>Level:</h4>
              <input type="text" class="width-small" name="attr_caster_class1_level" title="@{caster_class1_level}" value="0" />
            </label>
          </span>
          <span class="spells-top column-header">
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
            <span>Cur&nbsp;/&nbsp;Max</span>
          </span>
          <span class="spells-middle">
            <span><input type="text" class="width-fill" name="attr_spells_lvl_0_current" title="@{spells_lvl_0_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_0_max" title="@{spells_lvl_0_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_1_current" title="@{spells_lvl_1_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_1_max" title="@{spells_lvl_1_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_2_current" title="@{spells_lvl_2_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_2_max" title="@{spells_lvl_2_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_3_current" title="@{spells_lvl_3_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_3_max" title="@{spells_lvl_3_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_4_current" title="@{spells_lvl_4_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_4_max" title="@{spells_lvl_4_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_5_current" title="@{spells_lvl_5_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_5_max" title="@{spells_lvl_5_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_6_current" title="@{spells_lvl_6_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_6_max" title="@{spells_lvl_6_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_7_current" title="@{spells_lvl_7_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_7_max" title="@{spells_lvl_7_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_8_current" title="@{spells_lvl_8_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_8_max" title="@{spells_lvl_8_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_9_current" title="@{spells_lvl_9_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells_lvl_9_max" title="@{spells_lvl_9_max}" value="0" /></span>
          </span>
          <span class="to-hit spells-bottom">
            <span>Cantrips</span>
            <span>1st</span>
            <span>2nd</span>
            <span>3rd</span>
            <span>4th</span>
            <span>5th</span>
            <span>6th</span>
            <span>7th</span>
            <span>8th</span>
            <span>9th</span>
          </span>
          <span class="spells-middle toggle-caster2">
            <span class="inline-label span-all no-border">
              <label class="auto-width">
                <h4>Caster Class 2:</h4>
                <input type="text" class="auto-width" name="attr_caster_class2_name" title="@{caster_class2_name}" value="" placeholder="enter caster class" />
              </label>
              <label class="width-medium">
                <h4>Level:</h4>
                <input type="text" class="width-small" name="attr_caster_class2_level" title="@{caster_class2_level}" value="0" />
              </label>
            </span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_0_current" title="@{spells2_lvl_0_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_0_max" title="@{spells2_lvl_0_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_1_current" title="@{spells2_lvl_1_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_1_max" title="@{spells2_lvl_1_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_2_current" title="@{spells2_lvl_2_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_2_max" title="@{spells2_lvl_2_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_3_current" title="@{spells2_lvl_3_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_3_max" title="@{spells2_lvl_3_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_4_current" title="@{spells2_lvl_4_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_4_max" title="@{spells2_lvl_4_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_5_current" title="@{spells2_lvl_5_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_5_max" title="@{spells2_lvl_5_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_6_current" title="@{spells2_lvl_6_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_6_max" title="@{spells2_lvl_6_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_7_current" title="@{spells2_lvl_7_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_7_max" title="@{spells2_lvl_7_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_8_current" title="@{spells2_lvl_8_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_8_max" title="@{spells2_lvl_8_max}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_9_current" title="@{spells2_lvl_9_current}" value="0" /></span>
            <span><input type="text" class="width-fill" name="attr_spells2_lvl_9_max" title="@{spells2_lvl_9_max}" value="0" /></span>
          </span>
          <span class="to-hit spells-bottom toggle-caster2">
            <span>Cantrips</span>
            <span>1st</span>
            <span>2nd</span>
            <span>3rd</span>
            <span>4th</span>
            <span>5th</span>
            <span>6th</span>
            <span>7th</span>
            <span>8th</span>
            <span>9th</span>
          </span>
        </div>
        <div class="inline-label">
          <div class="spell-caster-tabs toggle-caster2">
            <input type="radio" class="tab-hidden tab" name="attr_spell_caster_tabs" value="0"><span class="tab">Caster 1</span>
            <input type="radio" class="tab-hidden tab" name="attr_spell_caster_tabs" value="1"><span class="tab">Caster 2</span>
            <input type="radio" class="tab-hidden tab" name="attr_spell_caster_tabs" value="-1" checked><span class="tab">All</span>
          </div>
          <label class="left">
            <span>Single Column</span>
            <input type="checkbox" class="toggle-single-column-spells" name="attr_toggle_single_column_spells" title="@{toggle_single_column_spells}" value="1" checked />
          </label>
          <label class="left">
            <span>Memorized Only</span>
            <input type="checkbox" name="attr_toggle_show_memorized" title="@{toggle_show_memorized}" value="1">
          </label>
        </div>
        <div class="spell-tabs">
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="0"><span class="tab">Cantrips</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="1"><span class="tab">1st</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="2"><span class="tab">2nd</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="3"><span class="tab">3rd</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="4"><span class="tab">4th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="5"><span class="tab">5th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="6"><span class="tab">6th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="7"><span class="tab">7th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="8"><span class="tab">8th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="9"><span class="tab">9th</span>
          <input type="radio" class="tab-hidden tab" name="attr_spell_tabs" value="-1" checked><span class="tab">All</span>
        </div>
        <div class="sect">
          <fieldset class="repeating_spells">
            <!-- show only the spell level chosen -->
            <input type="hidden" class="hidden toggle-show" name="attr_spell_show" value="1" readonly />
            <!-- lower opacity of un-memorized spells -->
            <input type="hidden" class="hidden not-memorized" name="attr_spell_memorized" value="0" readonly />
            <!-- hide un-memorized spells -->
            <input type="checkbox" class="hidden toggle-memorized" name="attr_spell_show_memorized" value="1" readonly />
            <!-- show all spell levels -->
            <input type="checkbox" class="hidden toggle-all" name="attr_spell_show_all" value="1" readonly checked />
            <span class="top-row spells-repheader spell-display border-top-half">
              <button class="dice-button" type="roll" name="attr_spell_roll" title="%{selected|repeating_spells_$X_spell_roll}" value="@{spell_macro_text}" style="margin-right:12px;"></button>
              <label class="repeating-name">
                <input type="text" class="auto-width" name="attr_spell_name" title="@{repeating_spells_$X_spell_name}" placeholder="Spell Name" />
              </label>
              <label class="right" style="min-width: 2em; max-width: 3em;">
                <span>#</span>
                <input type="text" class="width-smallest" name="attr_spell_memorized" title="@{repeating_spells_$X_spell_memorized}" value="0" />
              </label>
            </span>
            <details class="spell-display border-bottom-half">
              <summary>
                <span class="material-icons gear-nav"></span>
              </summary>
              <div class="spell-details-grid">
                <span class="span-all inline-label">
                  <label>
                    <select class="width-medium" name="attr_spell_caster_class" title="@{repeating_spells_$X_spell_caster_class}">
                      <option value="0" selected>n/a</option>
                      <option value="1">Caster 1</option>
                      <option class="toggle-caster2" value="2">Caster 2</option>
                    </select>
                    <input type="hidden" name="attr_spell_caster_class" value="1" />
                    <input type="text" class="width-medium shrink-on-placeholder" name="attr_spell_caster_class_name" value="" title="@{repeating_spells_$X_spell_caster_class_name}" placeholder="add caster class" readonly />
                  </label>
                  <label class="right" style="min-width: 3em; max-width: 4em; margin-left: 5px;">
                    <span>Lvl</span>
                    <input type="text" class="width-smallest" name="attr_spell_caster_class_level" value="0" title="@{repeating_spells_$X_spell_caster_class_level}" readonly />
                  </label>
                </span>
                <label><span>Spell Level:</span>
                  <select class="width-small" name="attr_spell_level" title="@{repeating_spells_$X_spell_level}">
                    <option selected>?</option>
                    <option>0</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                  </select>
                </label>
                <label>
                  <span>School:</span>
                  <span class="inline-label width-fill">
                    <input type="text" list="spell_school" name="attr_spell_school" title="@{repeating_spells_$X_spell_school}" value="" placeholder="Spell Type">
                  </span>
                </label>
                <label><span>Components:</span>
                  <input type="text" name="attr_spell_components" title="@{repeating_spells_$X_spell_components}" value="" placeholder="V,S,M" />
                </label>
                <label><span>Range:</span>
                  <input type="text" name="attr_spell_range" title="@{repeating_spells_$X_spell_range}" value="" placeholder="6&quot;" />
                </label>
                <label><span>Casting Time:</span>
                  <input type="text" name="attr_spell_ct" title="@{repeating_spells_$X_spell_ct}" value="" placeholder="1 rnd" />
                </label>
                <label><span>Duration:</span>
                  <input type="text" name="attr_spell_duration" title="@{repeating_spells_$X_spell_duration}" value="" placeholder="1 rnd" />
                </label>
                <label><span>Saving Throw:</span>
                  <input type="text" name="attr_spell_save" title="@{repeating_spells_$X_spell_save}" value="" placeholder="None" />
                </label>
                <label><span>Save Type:</span>
                  <input type="text" name="attr_spell_save_type" title="@{repeating_spell_$X_spell_save_type}" value="" placeholder="n/a">
                </label>
                <label class="span-two"><span>Area of Effect:</span>
                  <input type="text" name="attr_spell_aoe" title="@{repeating_spells_$X_spell_aoe}" value="" placeholder="One Creature" />
                </label>
              </div>
              <textarea class="sect height-tall" name="attr_spell_description" title="@{repeating_spells_$X_spell_description}" placeholder="Spell Description"></textarea>
              <span class="inline-label">
                <label>
                  <span>Notes:</span>
                  <textarea name="attr_spell_notes" class="height-short" title="@{repeating_spells_$X_spell_notes}" placeholder="Notes"></textarea>
                </label>
                <label>
                  <button type="roll" class="info-link" value="@{whisper_pc} [**LINK**](@{spell_link})" title="Send link to chat."></button>
                  <textarea class="info-link" wrap="off" name="attr_spell_link" title="@{repeating_spells_$X_spell_link}" placeholder="https://www.example.com"></textarea>
                </label>
              </span>
              <textarea name="attr_spell_macro_text" class="height-short toggle-macros" title="@{repeating_spells_$X_spell_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{school=@{spell_school}}} {{spell_level=@{spell_level}}} {{spell_class=@{spell_caster_class_name}}} {{spell_class_level=@{spell_caster_class_level}}} {{range=@{spell_range}}} {{duration=@{spell_duration}}} {{area_of_effect=@{spell_aoe}}} {{components=@{spell_components}}} {{casting_time=@{spell_ct}}} {{saving_throw=@{spell_save}}} {{save_type=@{spell_save_type}}} {{link=@{spell_link}}} {{freetext=@{spell_description}}}</textarea>
            </details>
          </fieldset>
        </div>
        <input type="checkbox" class="sect-show" name="attr_spellsnotes_show" value="1" />
        <span class="subheader">Spells Notes</span><span class="material-icons"></span>
        <div class="sect">
          <textarea name="attr_spellsnotes" title="@{spellsnotes}" placeholder="Spells Notes"></textarea>
        </div>
      </div>
      <hr>
    </section>
    <!-- Notes -->
    <section class="notes-box">
      <input type="checkbox" class="sect-show" name="attr_notes_info_show" value="1" />
      <div class="header">NOTES</div><span class="material-icons"></span>
      <div class="sect">
        <label class="left">
          <span>Single Column</span>
          <input type="checkbox" class="toggle-single-column-notes" name="attr_toggle_single_column_notes" title="@{toggle_single_column_notes}" value="1" checked />
        </label>
        <span class="notes-norep-columns">
          <button class="dice-button" type="roll" name="attr_note_roll" title="%{note_roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{note_name}}} {{freetext=@{notes}}}"></button>
          <label>
            <input type="text" name="attr_note_name" title="@{note_name}" value="" placeholder="Note Name" />
          </label>
          <textarea class="height-short" name="attr_notes" title="@{notes}" placeholder="Misc Notes"></textarea>
        </span>
      </div>
      <div class="sect">
        <fieldset class="repeating_notes">
          <span class="top-row notes-columns border-top-half">
            <button class="dice-button" type="roll" name="attr_notes_roll" title="%{repeating_notes_$X_notes_roll}" value="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{notes_name}}} {{freetext=@{notes_description}}}"></button>
            <input type="text" name="attr_notes_name" title="@{repeating_notes_$X_notes_name}" value="" placeholder="Note Name" />
          </span>
          <details class="border-bottom-half">
            <summary>
              <span class="material-icons gear-nav"></span>
            </summary>
            <textarea class="height-tall" name="attr_notes_description" title="@{repeating_notes_$X_notes_description}" placeholder="Misc Notes"></textarea>
          </details>
        </fieldset>
      </div>
      <hr>
    </section>
    <!-- Settings -->
    <section class="options-box">
      <input type="checkbox" class="sect-show" name="attr_settings_show" value="1" checked />
      <div class="header">SETTINGS</div><span class="material-icons"></span>
      <div class="settings sect">
        <span class="inline-label">
          <label title="@{background} | Choose a sheet background. note: Using Roll20's dark mode option will override this option.">
            <h4>Background:</h4>
            <select class="background-selection" name="attr_background">
              <option value="1" default="">White</option>
              <option value="2" style="background-color: #d5cdc2;">Parchment</option>
              <option value="3" style="background-color: #f4d74f;">Goldenrod</option>
              <option value="4" style="background-color: #b5dcb3">Moldvay</option>
              <option value="5" style="background-color: var(--color-white1);">Light Greyhawk</option>
              <option value="6" style="background-color: rgb(179 179 179 / 54%);">Greyhawk</option>
            </select>
          </label>
          <label title="@{color_option} | Color will be displayed with sheet rolls.">
            <h4>Roll Template Color:</h4>
            <select name="attr_color_option">
              <option style="background-color: var(--black); color: #fff;" selected="">black</option>
              <option style="background-color: var(--blue); color: #fff;" value="blue">blue</option>
              <option style="background-color: var(--darkblue); color: #fff;" value="darkblue">darkblue</option>
              <option style="background-color: var(--darkgreen); color: #fff;" value="darkgreen">darkgreen</option>
              <option style="background-color: var(--darkgrey); color: #fff;" value="darkgrey">darkgrey</option>
              <option style="background-color: var(--darkorange); color: #fff;" value="darkorange">darkorange</option>
              <option style="background-color: var(--darkpink); color: #fff;" value="darkpink">darkpink</option>
              <option style="background-color: var(--darkpurple); color: #fff;" value="darkpurple">darkpurple</option>
              <option style="background-color: var(--darkred); color: #fff;" value="darkred">darkred</option>
              <option style="background-color: var(--darkyellow); color: #fff;" value="darkyellow">darkyellow</option>
              <option style="background-color: var(--green); color: #fff;" value="green">green</option>
              <option style="background-color: var(--grey); color: #fff;" value="grey">grey</option>
              <option style="background-color: var(--orange); color: #fff;" value="orange">orange</option>
              <option style="background-color: var(--pink); color: #fff;" value="pink">pink</option>
              <option style="background-color: var(--purple); color: #fff;" value="purple">purple</option>
              <option style="background-color: var(--red); color: #fff;" value="red">red</option>
              <option style="background-color: var(--white);" value="white">white</option>
              <option style="background-color: var(--yellow);" value="yellow">yellow</option>
            </select>
          </label>
        </span>
        <span class="inline-label width-fill">
          <h4 class="stack-text">Sheet Image:</h4>
          <label>
            <select name="attr_sheet_image" title="@{sheet_image} | Displays the avatar or provided url as an image in the top left corner of the sheet." style="width:8em;">
              <option value="0">Use URL</option>
              <option value="1" selected="">Avatar</option>
            </select>
            <button type="roll" class="button" value="[**LINK**](@{sheet_image_url})" title="Send image to chat.">
              <span>Image URL:</span>
            </button>
            <input type="text" class="width-fill border-light" name="attr_sheet_image_url" title="@{sheet_image_url} | Enter a valid image URL that ends with a proper image extension. ie .png, .jpg, .gif If needed, trim the url to the end of the image extension or add a 3-letter extension to the end of the url.." placeholder="https://www.example.com/image.jpg">
          </label>
        </span>
        <span class="inline-label width-fill" title="@{surprise_die} | Choose the die used for Surprise rolls.">
          <h4 class="stack-text">Surprise die:</h4>
          <label style="width:auto;">
            <select name="attr_surprise_die" class="width-small">
              <option value="6" selected>1d6</option>
              <option value="8">1d8</option>
              <option value="10">1d10</option>
              <option value="12">1d12</option>
              <option value="20">1d20</option>
              <option value="100">1d100</option>
            </select>
          </label>
          <label>
            <button type="roll" class="button" value="@{surprise_macro_text}" title="Test Roll">
              <span>Surprise Macro:</span>
            </button>
            <!--keep the html substitutions for '<' and '>' -->
            <textarea class="height-half" name="attr_surprise_macro_text" title="@{surprise_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Surprised 1-?{Surprised on?(enter upper limit)|@{surprise}} on 1d@{surprise_die}}} {{roll=[[ 1d@{surprise_die}cf&lt;?{Surprised on?(enter upper limit)|@{surprise}}cs&gt;?{Surprised on?(enter upper limit)|@{surprise}} ]] }} {{Segment Adjustments}} {{dex_adjustment=[[ @{surprisebonus} ]]}} {{current_encumbrance=[[ @{current_encumbrance_move} ]]}}</textarea>
        </span>
        <span class="inline-label width-fill" title="@{surprise_others_die} | Choose the die used for the Surprise Others rolls.">
          <h4 class="stack-text">Surprise die:</h4>
          <label style="width:auto;">
            <select name="attr_surprise_others_die" class="width-small">
              <option value="6" selected>1d6</option>
              <option value="8">1d8</option>
              <option value="10">1d10</option>
              <option value="12">1d12</option>
              <option value="20">1d20</option>
              <option value="100">1d100</option>
            </select>
          </label>
          <label>
            <button type="roll" class="button" value="@{surprise_others_macro_text}" title="Test Roll">
              <span>Surprise Others:</span>
            </button>
            <!--keep the html substitutions for '<' and '>' -->
            <textarea class="height-half" name="attr_surprise_others_macro_text" title="@{surprise_others_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Surprise Others 1-?{Surprise others on?(enter upper limit)|@{surprise}} on 1d@{surprise_others_die}}} {{roll=[[ 1d@{surprise_others_die}cs&lt;?{Surprise others on?(enter upper limit)|@{surprise}}cf&gt;?{Surprise others on?(enter upper limit)|@{surprise}} ]] }} {{Surprise Others Adj: [[ @{surprise_others_mod} ]]}} {{Segment Adjustments}} {{dex_adjustment=[[ @{surprisebonus} ]]}} {{current_encumbrance=[[ @{current_encumbrance_move} ]]}}</textarea>
        </span>
        <span class="inline-label width-fill" title="@{initiative_die} | Choose the die used for Initiative rolls.">
          <h4 class="stack-text">Initiative die:</h4>
          <label style="width:auto;">
            <select name="attr_initiative_die" class="width-small">
              <option value="6" selected>1d6</option>
              <option value="8">1d8</option>
              <option value="10">1d10</option>
              <option value="12">1d12</option>
              <option value="20">1d20</option>
              <option value="100">1d100</option>
            </select>
          </label>
          <label>
            <button type="roll" class="button" value="@{init_macro_text}" title="Test Roll">
              <span>Initiative Macro:</span>
            </button>
            <textarea class="height-half" name="attr_init_macro_text" title="@{init_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Initiative! 1d@{initiative_die}}} {{roll=[[ 1d@{initiative_die} + ( ?{Modifier?|0}[MOD] ) &{tracker}]]}} {{Misc. Adjustments}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{dex_adjustment= @{surprisebonus_inverted}}} {{current_encumbrance=[[ @{current_encumbrance_move} ]]}}</textarea>
          </label>
        </span>
        <span class="inline-label wrap width-fill">
          <h4>Misc. Options:</h4>
          <label title="@{ability_check_die} | Die/Dice vs Ability Score. ie 1d20, 4d6, 3d6, etc.">
            <span>Ability Check die:</span>
            <input type="text" class="width-small-plus border" name="attr_ability_check_die" value="1d20" />
          </label>
          <label title="@{toggle_to_hit_table} | Use THAC0 instead of Attack Matrix">
            <span>Use THAC0:</span>
            <input type="checkbox" name="attr_toggle_to_hit_table" value="1" />
          </label>
          <label title="@{toggle_critdamage} | Use crit damage rolls on natural 20. Defaults to weapon damage x2. Crit damage handling can be adjusted per attack.">
            <span>Use Crit Damage:</span>
            <input type="checkbox" name="attr_toggle_critdamage" value="1" />
          </label>
          <label title="@{toggle_lbs} | Use Lbs instead of gold pieces when determining encumbrance. Carying capacities and carried coin weight will be divided by 10. Per-item weights need to be entered as lbs in order for the sheet to properly calculate encumbrance.">
            <span>Use Lbs:</span>
            <input type="checkbox" class="toggle-lbs" name="attr_toggle_lbs" value="1" />
          </label>
        </span>
        <!-- Turn Undead -->
        <span class="inline-label wrap width-fill">
          <span class="inline-label">
            <h4 class="stack-text" title="Standard Turn Undead by type.">Standard Turn Undead:</h4>
            <label title="@{turn_undead_macro} | Choose a Cleric level.">
              <span>Cleric Lvl:</span>
              <select name="attr_turn_undead_macro" class="width-smaller" style="appearance: none;">
                <option value="1}} {{?{Undead Type?|Skeleton,[[1d12]]Skeleton's=[[1d20cs>10cf<10]]|Zombie,[[1d12]]Zombie's=[[1d20cs>13cf<13]]|Ghoul,[[1d12]]Ghoul's=[[1d20cs>16cf<16]]|Shadow,[[1d12]]Shadow's=[[1d20cs>19cf<19]]|Wight,[[1d12]]Wight's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}" selected>1</option>
                <option value="2}} {{?{Undead Type?|Skeleton,[[1d12]]Skeleton's=[[1d20cs>7cf<7]]|Zombie,[[1d12]]Zombie's=[[1d20cs>10cf<10]]|Ghoul,[[1d12]]Ghoul's=[[1d20cs>13cf<13]]|Shadow,[[1d12]]Shadow's=[[1d20cs>16cf<16]]|Wight,[[1d12]]Wight's=[[1d20cs>19cf<19]]|Ghast,[[1d12]]Ghast's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">2</option>
                <option value="3}} {{?{Undead Type?|Skeleton,[[1d12]]Skeleton's=[[1d20cs>4cf<4]]|Zombie,[[1d12]]Zombie's=[[1d20cs>7cf<7]]|Ghoul,[[1d12]]Ghoul's=[[1d20cs>10cf<10]]|Shadow,[[1d12]]Shadow's=[[1d20cs>13cf<13]]|Wight,[[1d12]]Wight's=[[1d20cs>16cf<16]]|Ghast,[[1d12]]Ghast's=[[1d20cs>19cf<19]]|Wraith,[[1d12]]Wraith's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">3</option>
                <option value="4}} {{?{Undead Type?|Skeleton,[[1d12 [T]]]Skeleton's=T|Zombie,[[1d12 [T]]]Zombie's=T|Ghoul,[[1d12]]Ghoul's=[[1d20cs>4cf<4]]|Shadow,[[1d12]]Shadow's=[[1d20cs>7cf<7]]|Wight,[[1d12]]Wight's=[[1d20cs>10cf<10]]|Ghast,[[1d12]]Ghast's=[[1d20cs>13cf<13]]|Wraith,[[1d12]]Wraith's=[[1d20cs>16cf<16]]|Mummy,[[1d12]]Mummy's=[[1d20cs>19cf<19]]|Spectre,[[1d12]]Spectre's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">4</option>
                <option value="5}} {{?{Undead Type?|Skeleton,[[1d12 [T]]]Skeleton's=T|Zombie,[[1d12 [T]]]Zombie's=T|Ghoul,[[1d12 [T]]]Ghoul's=T|Shadow,[[1d12]]Shadow's=[[1d20cs>4cf<4]]|Wight,[[1d12]]Wight's=[[1d20cs>7cf<7]]|Ghast,[[1d12]]Ghast's=[[1d20cs>10cf<10]]|Wraith,[[1d12]]Wraith's=[[1d20cs>13cf<13]]|Mummy,[[1d12]]Mummy's=[[1d20cs>16cf<16]]|Spectre,[[1d12]]Spectre's=[[1d20cs>19cf<19]]|Vampire,[[1d12]]Vampire's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">5</option>
                <option value="6}} {{?{Undead Type?|Skeleton,[[1d12 [D]]]Skeleton's=D|Zombie,[[1d12]]Zombie's=D|Ghoul,[[1d12 [T]]]Ghoul's=T|Shadow,[[1d12 [T]]]Shadow's=T|Wight,[[1d12]]Wight's=[[1d20cs>4cf<4]]|Ghast,[[1d12]]Ghast's=[[1d20cs>7cf<7]]|Wraith,[[1d12]]Wraith's=[[1d20cs>10cf<10]]|Mummy,[[1d12]]Mummy's=[[1d20cs>13cf<13]]|Spectre,[[1d12]]Spectre's=[[1d20cs>16cf<16]]|Vampire,[[1d12]]Vampire's=[[1d20cs>19cf<19]]|Ghost,[[1d12]]Ghost's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">6</option>
                <option value="7}} {{?{Undead Type?|Skeleton,[[1d12 [D]]]Skeleton's=D|Zombie,[[1d12 [D]]]Zombie's=D|Ghoul,[[1d12 [D]]]Ghoul's=D|Shadow,[[1d12 [T]]]Shadow's=T|Wight,[[1d12 [T]]]Wight's=T|Ghast,[[1d12]]Ghast's=[[1d20cs>4cf<4]]|Wraith,[[1d12]]Wraith's=[[1d20cs>7cf<7]]|Mummy,[[1d12]]Mummy's=[[1d20cs>10cf<10]]|Spectre,[[1d12]]Spectre's=[[1d20cs>13cf<13]]|Vampire,[[1d12]]Vampire's=[[1d20cs>16cf<16]]|Ghost,[[1d12]]Ghost's=[[1d20cs>19cf<19]]|Lich,[[1d12]]Lich's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">7</option>
                <option value="8}} {{?{Undead Type?|Skeleton,[[1d6+6 [D&#0185;]]]Skeleton's=D&#0185;|Zombie,[[1d12 [D]]]Zombie's=D|Ghoul,[[1d12 [D]]]Ghoul's=D|Shadow,[[1d12 [D]]]Shadow's=D|Wight,[[1d12 [T]]]Wight's=T|Ghast,[[1d12 [T]]]Ghast's=T|Wraith,[[1d12]]Wraith's=[[1d20cs>4cf<4]]|Mummy,[[1d12]]Mummy's=[[1d20cs>7cf<7]]|Spectre,[[1d12]]Spectre's=[[1d20cs>10cf<10]]|Vampire,[[1d12]]Vampire's=[[1d20cs>13cf<13]]|Ghost,[[1d12]]Ghost's=[[1d20cs>16cf<16]]|Lich,[[1d12]]Lich's=[[1d20cs>19cf<19]]|Special,[[1d2 [Special]]]Special=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">8</option>
                <option value="9-13}} {{?{Undead Type?|Skeleton,[[1d6+6 [D&#0185;]]]Skeleton's=D&#0185;|Zombie,[[1d6+6 [D&#0185;]]]Zombie's=D&#0185;|Ghoul,[[1d12 [D]]]Ghoul's=D|Shadow,[[1d12 [D]]]Shadow's=D|Wight,[[1d12 [D]]]Wight's=D|Ghast,[[1d12 [T]]]Ghast's=T|Wraith,[[1d12 [T]]]Wraith's=T|Mummy,[[1d12]]Mummy's=[[1d20cs>4cf<4]]|Spectre,[[1d12]]Spectre's=[[1d20cs>7cf<7]]|Vampire,[[1d12]]Vampire's=[[1d20cs>10cf<10]]|Ghost,[[1d12]]Ghost's=[[1d20cs>13cf<13]]|Lich,[[1d12]]Lich's=[[1d20cs>16cf<16]]|Special,[[1d2 [Special]]]Special=[[1d20cs>19cf<19]]}}} {{Turned for [[3d4]]rounds}}">9-13</option>
                <option value="14+}} {{?{Undead Type?|Skeleton,[[1d6+6 [D&#0185;]]]Skeleton's=D&#0185;|Zombie,[[1d6+6 [D&#0185;]]]Zombie's=D&#0185;|Ghoul,[[1d6+6 [D&#0185;]]]Ghoul's=D&#0185;|Shadow,[[1d6+6 [D&#0185;]]]Shadow's=D&#0185;|Wight,[[1d12 [D]]]Wight's=D|Ghast,[[1d12 [D]]]Ghast's=D|Wraith,[[1d12 [D]]]Wraith's=D|Mummy,[[1d12 [T]]]Mummy's=T|Spectre,[[1d12 [T]]]Spectre's=T|Vampire,[[1d12]]Vampire's=[[1d20cs>4cf<4]]|Ghost,[[1d12]]Ghost's=[[1d20cs>7cf<7]]|Lich,[[1d12]]Lich's=[[1d20cs>10cf<10]]|Special,[[1d2 [Special]]]Special=[[1d20cs>13cf<13]]}}} {{Turned for [[3d4]]rounds}}">14+</option>
              </select>
            </label>
            <label title="%{turn_undead_roll} | Standard Turn Undead by type.">
              <button type="roll" name="roll_turn_undead_roll" value="@{whisper_pc} &{template:general} {{name=@{character_name}}} {{color=@{color_option}}} {{# & Type Effected}} {{subtag=Turn/Command Undead Lvl: @{turn_undead_macro}">
                <span>Turn Undead</span>
              </button>
            </label>
            <label title="Add to Special Abilities. Creates a unique, non-synced, ability.">
              <button type="action" name="act_addturnundead"><span>+Add</span></button>
            </label>
          </span>
          <span class="inline-label">
            <h4 class="stack-text" title="Alternate version that groups undead by adjusted HD. Credit to Dragonsfoot.com see Footprints #7 for details.">Alternate Turn Undead:</h4>
            <label title="@{turn_undead_macro2} | Choose a Cleric level.">
              <span>Cleric Lvl:</span>
              <select name="attr_turn_undead_macro2" class="width-smaller" style="appearance: none;">
                <option value="1}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12]]HD1: Poltergeist Skeleton Animal Skeleton=[[1d20cs>11cf<11]]|HD2: Zombie,[[1d12]]HD2: Zombie's=[[1d20cs>14cf<14]]|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>17cf<17]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}" selected>1</option>
                <option value="2}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12]]HD1: Poltergeist Skeleton Animal Skeleton=[[1d20cs>8cf<8]]|HD2: Zombie,[[1d12]]HD2: Zombie's=[[1d20cs>11cf<11]]|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>14cf<14]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>17cf<17]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">2</option>
                <option value="3}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12]]HD1: Poltergeist Skeleton Animal Skeleton=[[1d20cs>5cf<5]]|HD2: Zombie,[[1d12]]HD2: Zombie's=[[1d20cs>8cf<8]]|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>11cf<11]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>14cf<14]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>17cf<17]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">3</option>
                <option value="4}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12]]HD1: Poltergeist Skeleton Animal Skeleton=[[1d20cs>2cf<2]]|HD2: Zombie,[[1d12]]HD2: Zombie's=[[1d20cs>5cf<5]]|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>8cf<8]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>11cf<11]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>14cf<14]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>17cf<17]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">4</option>
                <option value="5}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [T]]]HD1: Poltergeist Skeleton Animal Skeleton=T|HD2: Zombie,[[1d12]]HD2: Zombie's=[[1d20cs>2cf<2]]|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>5cf<5]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>8cf<8]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>11cf<11]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>14cf<14]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>17cf<17]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">5</option>
                <option value="6}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [T]]]HD1: Poltergeist Skeleton Animal Skeleton=T|HD2: Zombie,[[1d12]]HD2: Zombie's=T|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12]]HD3: Coffer Corpse Ghoul Sheet Phantom=[[1d20cs>2cf<2]]|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>5cf<5]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>8cf<8]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>11cf<11]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>14cf<14]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>17cf<17]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">6</option>
                <option value="7}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [T]]]HD1: Poltergeist Skeleton Animal Skeleton=T|HD2: Zombie,[[1d12 [T]]]HD2: Zombie's=T|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [T]]]HD3: Coffer Corpse Ghoul Sheet Phantom=T|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=[[1d20cs>2cf<2]]|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>5cf<5]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>8cf<8]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>11cf<11]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>14cf<14]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>17cf<17]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">7</option>
                <option value="8}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [D]]]HD1: Poltergeist Skeleton Animal Skeleton=D|HD2: Zombie,[[1d12 [T]]]HD2: Zombie's=T|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [T]]]HD3: Coffer Corpse Ghoul Sheet Phantom=T|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [T]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=T|HD5: Ghast Shadow,[[1d12]]HD5: Ghast Shadow=[[1d20cs>2cf<2]]|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>5cf<5]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>8cf<8]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>11cf<11]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>14cf<14]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>17cf<17]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">8</option>
                <option value="9}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [D]]]HD1: Poltergeist Skeleton Animal Skeleton=D|HD2: Zombie,[[1d12 [D]]]HD2: Zombie's=D|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [T]]]HD3: Coffer Corpse Ghoul Sheet Phantom=T|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [T]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=T|HD5: Ghast Shadow,[[1d12 [T]]]HD5: Ghast Shadow=T|HD6: Son of Kyuss Wight Monster Zombie,[[1d12]]HD6: Son of Kyuss Wight Monster Zombie=[[1d20cs>2cf<2]]|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>5cf<5]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>8cf<8]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>11cf<11]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>14cf<14]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>17cf<17]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">9</option>
                <option value="10}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d12 [D]]]HD1: Poltergeist Skeleton Animal Skeleton=D|HD2: Zombie,[[1d12 [D]]]HD2: Zombie's=D|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [D]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [T]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=T|HD5: Ghast Shadow,[[1d12 [T]]]HD5: Ghast Shadow=T|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [T]]]HD6: Son of Kyuss Wight Monster Zombie=T|HD7: Crypt Thing Wraith,[[1d12]]HD7: Crypt Thing Wraith=[[1d20cs>2cf<2]]|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>5cf<5]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>8cf<8]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>11cf<11]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>14cf<14]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>17cf<17]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">10</option>
                <option value="11}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d6+6 [D&#0185;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0185;|HD2: Zombie,[[1d12 [D]]]HD2: Zombie's=D|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [D]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [T]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=T|HD5: Ghast Shadow,[[1d12 T]]]HD5: Ghast Shadow=T|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [T]]]HD6: Son of Kyuss Wight Monster Zombie=T|HD7: Crypt Thing Wraith,[[1d12 [T]]]HD7: Crypt Thing Wraith=T|HD8: Mummy,[[1d12]]HD8: Mummy's=[[1d20cs>2cf<2]]|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>5cf<5]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>8cf<8]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>11cf<11]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>14cf<14]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>17cf<17]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">11</option>
                <option value="12}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d6+6 [D&#0185;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0185;|HD2: Zombie,[[1d6+6 [D&#0185;]]]HD2: Zombie's=D&#0185;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d12 [D]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [D]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D|HD5: Ghast Shadow,[[1d12 [D]]]HD5: Ghast Shadow=D|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [T]]]HD6: Son of Kyuss Wight Monster Zombie=T|HD7: Crypt Thing Wraith,[[1d12 [T]]]HD7: Crypt Thing Wraith=T|HD8: Mummy,[[1d12 [T]]]HD8: Mummy's=T|HD9: Spectre,[[1d12]]HD9: Spectre's=[[1d20cs>2cf<2]]|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>5cf<5]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>8cf<8]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>11cf<11]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>14cf<14]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>17cf<17]]|HD15:,[[1d12]]HD15:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">12</option>
                <option value="13}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[1d6+6 [D&#0185;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0185;|HD2: Zombie,[[1d6+6 [D&#0185;]]]HD2: Zombie's=D&#0185;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d6+6 [D&#0185;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0185;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d12 [D]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D|HD5: Ghast Shadow,[[1d12 [D]]]HD5: Ghast Shadow=D|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [D]]]HD6: Son of Kyuss Wight Monster Zombie=D|HD7: Crypt Thing Wraith,[[1d12 [T]]]HD7: Crypt Thing Wraith=T|HD8: Mummy,[[1d12 [T]]]HD8: Mummy's=T|HD9: Spectre,[[1d12 [T]]]HD9: Spectre's=T|HD10: Apparition,[[1d12]]HD10: Apparition's=[[1d20cs>2cf<2]]|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>5cf<5]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>8cf<8]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>11cf<11]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>14cf<14]]|HD15:,[[1d12]]HD15:=[[1d20cs>17cf<17]]|HD16:,[[1d12]]HD16:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">13</option>
                <option value="14}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+6 [D&#0178;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0178;|HD2: Zombie,[[1d6+6 [D&#0185;]]]HD2: Zombie's=D&#0185;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d6+6 [D&#0185;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0185;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d6+6 [D&#0185;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0185;|HD5: Ghast Shadow,[[1d12 [D]]]HD5: Ghast Shadow=D|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [D]]]HD6: Son of Kyuss Wight Monster Zombie=D|HD7: Crypt Thing Wraith,[[1d12 [D]]]HD7: Crypt Thing Wraith=D|HD8: Mummy,[[1d12 [T]]]HD8: Mummy's=T|HD9: Spectre,[[1d12 [T]]]HD9: Spectre's=T|HD10: Apparition,[[1d12 [T]]]HD10: Apparition's=T|HD11: Vampire,[[1d12]]HD11: Vampire's=[[1d20cs>2cf<2]]|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>5cf<5]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>8cf<8]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>11cf<11]]|HD15:,[[1d12]]HD15:=[[1d20cs>14cf<14]]|HD16:,[[1d12]]HD16:=[[1d20cs>17cf<17]]|HD17:,[[1d12]]HD17:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">14</option>
                <option value="15}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+6 [D&#0178;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0178;|HD2: Zombie,[[2d6+6 [D&#0178;]]]HD2: Zombie's=D&#0178;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[1d6+6 [D&#0185;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0185;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d6+6 [D&#0185;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0185;|HD5: Ghast Shadow,[[1d6+6 [D&#0185;]]]HD5: Ghast Shadow=D&#0185;|HD6: Son of Kyuss Wight Monster Zombie,[[1d12 [D]]]HD6: Son of Kyuss Wight Monster Zombie=D|HD7: Crypt Thing Wraith,[[1d12 [D]]]HD7: Crypt Thing Wraith=D|HD8: Mummy,[[1d12 [D]]]HD8: Mummy's=D|HD9: Spectre,[[1d12 [T]]]HD9: Spectre's=T|HD10: Apparition,[[1d12 [T]]]HD10: Apparition's=T|HD11: Vampire,[[1d12 [T]]]HD11: Vampire's=T|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12]]HD12: Eye Of Fear & Flame Groaning Spirit=[[1d20cs>2cf<2]]|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>5cf<5]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>8cf<8]]|HD15:,[[1d12]]HD15:=[[1d20cs>11cf<11]]|HD16:,[[1d12]]HD16:=[[1d20cs>14cf<14]]|HD17:,[[1d12]]HD17:=[[1d20cs>17cf<17]]|HD18:,[[1d12]]HD18:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">15</option>
                <option value="16}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+6 [D&#0178;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0178;|HD2: Zombie,[[2d6+6 [D&#0178;]]]HD2: Zombie's=D&#0178;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[2d6+6 [D&#0178;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0178;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[1d6+6 [D&#0185;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0185;|HD5: Ghast Shadow,[[1d6+6 [D&#0185;]]]HD5: Ghast Shadow=D&#0185;|HD6: Son of Kyuss Wight Monster Zombie,[[1d6+6 [D&#0185;]]]HD6: Son of Kyuss Wight Monster Zombie=D&#0185;|HD7: Crypt Thing Wraith,[[1d12 [D]]]HD7: Crypt Thing Wraith=D|HD8: Mummy,[[1d12 [D]]]HD8: Mummy's=D|HD9: Spectre,[[1d12 [D]]]HD9: Spectre's=D|HD10: Apparition,[[1d12 [T]]]HD10: Apparition's=T|HD11: Vampire,[[1d12 [T]]]HD11: Vampire's=T|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12 [T]]]HD12: Eye Of Fear & Flame Groaning Spirit=T|HD13: Death Knight Ghost Lich,[[1d12]]HD13: Death Knight Ghost Lich=[[1d20cs>2cf<2]]|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>5cf<5]]|HD15:,[[1d12]]HD15:=[[1d20cs>8cf<8]]|HD16:,[[1d12]]HD16:=[[1d20cs>11cf<11]]|HD17:,[[1d12]]HD17:=[[1d20cs>14cf<14]]|HD18:,[[1d12]]HD18:=[[1d20cs>17cf<17]]|HD19:,[[1d12]]HD19:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">16</option>
                <option value="17}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+12 [D&#0179;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0179;|HD2: Zombie,[[2d6+6 [D&#0178;]]]HD2: Zombie's=D&#0178;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[2d6+6 [D&#0178;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0178;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[2d6+6 [D&#0178;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0178;|HD5: Ghast Shadow,[[1d6+6 [D&#0185;]]]HD5: Ghast Shadow=D&#0185;|HD6: Son of Kyuss Wight Monster Zombie,[[1d6+6 [D&#0185;]]]HD6: Son of Kyuss Wight Monster Zombie=D&#0185;|HD7: Crypt Thing Wraith,[[1d6+6 [D&#0185;]]]HD7: Crypt Thing Wraith=D&#0185;|HD8: Mummy,[[1d12 [D]]]HD8: Mummy's=D|HD9: Spectre,[[1d12 [D]]]HD9: Spectre's=D|HD10: Apparition,[[1d12 [D]]]HD10: Apparition's=D|HD11: Vampire,[[1d12 [T]]]HD11: Vampire's=T|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12 [T]]]HD12: Eye Of Fear & Flame Groaning Spirit=T|HD13: Death Knight Ghost Lich,[[1d12 [T]]]HD13: Death Knight Ghost Lich=T|HD14: Skeleton Warrior,[[1d12]]HD14: Skeleton Warrior=[[1d20cs>2cf<2]]|HD15:,[[1d12]]HD15:=[[1d20cs>5cf<5]]|HD16:,[[1d12]]HD16:=[[1d20cs>8cf<8]]|HD17:,[[1d12]]HD17:=[[1d20cs>11cf<11]]|HD18:,[[1d12]]HD18:=[[1d20cs>14cf<14]]|HD19:,[[1d12]]HD19:=[[1d20cs>17cf<17]]|HD20:,[[1d12]]HD20:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">17</option>
                <option value="18}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+12 [D&#0179;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0179;|HD2: Zombie,[[2d6+12 [D&#0179;]]]HD2: Zombie's=D&#0179;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[2d6+6 [D&#0178;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0178;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[2d6+6 [D&#0178;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0178;|HD5: Ghast Shadow,[[2d6+6 [D&#0178;]]]HD5: Ghast Shadow=D&#0178;|HD6: Son of Kyuss Wight Monster Zombie,[[1d6+6 [D&#0185;]]]HD6: Son of Kyuss Wight Monster Zombie=D&#0185;|HD7: Crypt Thing Wraith,[[1d6+6 [D&#0185;]]]HD7: Crypt Thing Wraith=D&#0185;|HD8: Mummy,[[1d6+6 [D&#0185;]]]HD8: Mummy's=D&#0185;|HD9: Spectre,[[1d12 [D]]]HD9: Spectre's=D|HD10: Apparition,[[1d12 [D]]]HD10: Apparition's=D|HD11: Vampire,[[1d12 [D]]]HD11: Vampire's=D|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12 [T]]]HD12: Eye Of Fear & Flame Groaning Spirit=T|HD13: Death Knight Ghost Lich,[[1d12 [T]]]HD13: Death Knight Ghost Lich=T|HD14: Skeleton Warrior,[[1d12 [T]]]HD14: Skeleton Warrior=T|HD15:,[[1d12]]HD15:=[[1d20cs>2cf<2]]|HD16:,[[1d12]]HD16:=[[1d20cs>5cf<5]]|HD17:,[[1d12]]HD17:=[[1d20cs>8cf<8]]|HD18:,[[1d12]]HD18:=[[1d20cs>11cf<11]]|HD19:,[[1d12]]HD19:=[[1d20cs>14cf<14]]|HD20:,[[1d12]]HD20:=[[1d20cs>17cf<17]]|HD21:,[[1d12]]HD21:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">18</option>
                <option value="19}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+12 [D&#0179;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0179;|HD2: Zombie,[[2d6+12 [D&#0179;]]]HD2: Zombie's=D&#0179;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[2d6+12 [D&#0179;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0179;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[2d6+6 [D&#0178;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0178;|HD5: Ghast Shadow,[[2d6+6 [D&#0178;]]]HD5: Ghast Shadow=D&#0178;|HD6: Son of Kyuss Wight Monster Zombie,[[2d6+6 [D&#0178;]]]HD6: Son of Kyuss Wight Monster Zombie=D&#0178;|HD7: Crypt Thing Wraith,[[1d6+6 [D&#0185;]]]HD7: Crypt Thing Wraith=D&#0185;|HD8: Mummy,[[1d6+6 [D&#0185;]]]HD8: Mummy's=D&#0185;|HD9: Spectre,[[1d6+6 [D&#0185;]]]HD9: Spectre's=D&#0185;|HD10: Apparition,[[1d12 [D]]]HD10: Apparition's=D|HD11: Vampire,[[1d12 [D]]]HD11: Vampire's=D|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12 [D]]]HD12: Eye Of Fear & Flame Groaning Spirit=D|HD13: Death Knight Ghost Lich,[[1d12 [T]]]HD13: Death Knight Ghost Lich=T|HD14: Skeleton Warrior,[[1d12 [T]]]HD14: Skeleton Warrior=T|HD15:,[[1d12 [T]]]HD15:=T|HD16:,[[1d12]]HD16:=[[1d20cs>2cf<2]]|HD17:,[[1d12]]HD17:=[[1d20cs>5cf<5]]|HD18:,[[1d12]]HD18:=[[1d20cs>8cf<8]]|HD19:,[[1d12]]HD19:=[[1d20cs>11cf<11]]|HD20:,[[1d12]]HD20:=[[1d20cs>14cf<14]]|HD21:,[[1d12]]HD21:=[[1d20cs>17cf<17]]|HD22:,[[1d12]]HD22:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">19</option>
                <option value="20+}} {{?{Undead Type?|HD1: Poltergeist Skeleton Animal Skeleton,[[2d6+12 [D&#0179;]]]HD1: Poltergeist Skeleton Animal Skeleton=D&#0179;|HD2: Zombie,[[2d6+12 [D&#0179;]]]HD2: Zombie's=D&#0179;|HD3: Coffer Corpse Ghoul Sheet Phantom,[[2d6+12 [D&#0179;]]]HD3: Coffer Corpse Ghoul Sheet Phantom=D&#0179;|HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie,[[2d6+12 [D&#0179;]]]HD4: Huecuva Penanggalan Sheet Ghoul Juju Zombie=D&#0179;|HD5: Ghast Shadow,[[2d6+6 [D&#0178;]]]HD5: Ghast Shadow=D&#0178;|HD6: Son of Kyuss Wight Monster Zombie,[[2d6+6 [D&#0178;]]]HD6: Son of Kyuss Wight Monster Zombie=D&#0178;|HD7: Crypt Thing Wraith,[[2d6+6 [D&#0178;]]]HD7: Crypt Thing Wraith=D&#0178;|HD8: Mummy,[[1d6+6 [D&#0185;]]]HD8: Mummy's=D&#0185;|HD9: Spectre,[[1d6+6 [D&#0185;]]]HD9: Spectre's=D&#0185;|HD10: Apparition,[[1d6+6 [D&#0185;]]]HD10: Apparition's=D&#0185;|HD11: Vampire,[[1d12 [D]]]HD11: Vampire's=D|HD12: Eye Of Fear & Flame Groaning Spirit,[[1d12 [D]]]HD12: Eye Of Fear & Flame Groaning Spirit=D|HD13: Death Knight Ghost Lich,[[1d12 [D]]]HD13: Death Knight Ghost Lich=D|HD14: Skeleton Warrior,[[1d12 [T]]]HD14: Skeleton Warrior=T|HD15:,[[1d12 [T]]]HD15:=T|HD16:,[[1d12 [T]]]HD16:=T|HD17:,[[1d12]]HD17:=[[1d20cs>2cf<2]]|HD18:,[[1d12]]HD18:=[[1d20cs>5cf<5]]|HD19:,[[1d12]]HD19:=[[1d20cs>8cf<8]]|HD20:,[[1d12]]HD20:=[[1d20cs>11cf<11]]|HD21:,[[1d12]]HD21:=[[1d20cs>14cf<14]]|HD22:,[[1d12]]HD22:=[[1d20cs>17cf<17]]|HD23:,[[1d12]]HD23:=[[1d20cs>20cf<20]]}}} {{Turned for [[3d4]]rounds}}">20+</option>
              </select>
            </label>
            <label title="%{turn_undead_roll} | Alternate version that groups undead by adjusted HD. Credit to Dragonsfoot.com see Footprints #7 for details.">
              <button type="roll" name="roll_turn_undead2_roll" value="@{whisper_pc} &{template:general} {{name=@{character_name}}} {{color=@{color_option}}} {{# & Type Effected}} {{subtag=Turn/Command Undead Lvl: @{turn_undead_macro2}">
                <span>Turn Undead</span>
              </button>
            </label>
            <label title="Add to Special Abilities. Creates a unique, non-synced, ability.">
              <button type="action" name="act_addturnundead2"><span>+Add</span></button>
            </label>
          </span>
        </span>
        <span class="six-columns">
          <h4 style="grid-row: 1/3; justify-self: left;">Hide Areas:</h4>
          <label class="inline-label" title="@{toggle_thief_skills} | Hides Thief Skills and melee attack backstab bonuses.">
            <span>Thief Skills:</span>
            <input type="checkbox" name="attr_toggle_thief_skills" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_spells} | Hides the Spells section." >
            <span>Spells:</span>
            <input type="checkbox" name="attr_toggle_spells" value="1" />
          </label>
          <label class="inline-label" title="@{toggle_caster2} | Hides a second caster class in the Spells section.">
            <span>Caster Class 2:</span>
            <input type="checkbox" name="attr_toggle_caster2" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_nwp} | Hides the Non-Weapon Proficiencies section.">
            <span>NWP:</span>
            <input type="checkbox" name="attr_toggle_nwp" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_costs} | Hides cost fields and totals.">
            <span>Costs:</span>
            <input type="checkbox" name="attr_toggle_costs" value="1" />
          </label>
          <label class="inline-label" title="@{toggle_exceptional} | Hides the exceptional ability column. caveat: exceptional Strength of 18+ will be shown regardless of this setting.">
            <span>Exceptional:</span>
            <input type="checkbox" name="attr_toggle_exceptional" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_comeliness} | Hides the Comeliness ability row.">
            <span>Comeliness:</span>
            <input type="checkbox" name="attr_toggle_comeliness" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_multiclass} | Hides additional class fields.">
            <span>Multi-Class:</span>
            <input type="checkbox" name="attr_toggle_multiclass" value="1" />
          </label>
          <label class="inline-label" title="@{toggle_psionics} | Hides Psionic-related fields found within Special Abilities.">
            <span>Psionics:</span>
            <input type="checkbox" name="attr_toggle_psionics" value="1" checked />
          </label>
          <label class="inline-label" title="@{toggle_macros} | Hides editable macro-text fields for various sheet-based rolls.">
            <span>Sheet Macros:</span>
            <input type="checkbox" name="attr_toggle_macros" value="1" checked />
          </label>
        </span>
        <span class="inline-label wrap">
          <h4>Whisper Options:</h4>
          <label style="max-width:14em;">
            <span>PC Rolls:</span>
            <select class="width-fill" name="attr_whisper_pc" title="@{whisper_pc}">
              <option value=" " selected>Open Rolls</option>
              <option value="/w gm">Whisper Rolls</option>
            </select>
          </label>
          <label style="max-width:14em;">
            <span>NPC Rolls:</span>
            <select class="width-fill" name="attr_whisper_npc" title="@{whisper_npc}">
              <option value=" " selected>Open Rolls</option>
              <option value="/w gm">Whisper Rolls</option>
            </select>
          </label>
        </span>
        <span class="eight-columns">
          <h4 style="grid-row: 1/3; justify-self: left;">ADVANCED Options:</h4>
          <span class="span-seven inline-label" title="WARNING: any customization/editing that has been done on existing macro-text fields will be lost! You will not break anything by reseting. Reseting a field simply erases the existing value and forces the sheet to re-populate the field with the latest default value.">
            <button type="action" name="act_resetallmacros" class="reset-macros"><span>Reset All</span></button>
            <button type="action" name="act_resetweaponsmacros" class="reset-macros"><span>Reset Weapons</span></button>
            <button type="action" name="act_resetspellsmacros" class="reset-macros"><span>Reset Spells</span></button>
            <button type="action" name="act_resetabilitiesmacros" class="reset-macros"><span>Reset Abilities</span></button>
            <button type="action" name="act_resetnwpsmacros" class="reset-macros"><span>Reset NWP</span></button>
            <button type="action" name="act_resetequipmentmacros" class="reset-macros"><span>Reset Equip</span></button>
          </span>
          <span class="span-six inline-label wrap">
            <label class="sync-lock" title="@{sync_hp_flag} | Let the sheet sync Total HP from Class Details with HP ( @{hitpoints_max} ).">
              <span>Sync HP:</span>
              <input type="checkbox" name="attr_sync_hp_flag" value="1" />
              <span></span>
            </label>
            <label class="sync-lock" title="@{sync_ac_flag} | Let the sheet sync Total AC from Armor Details with AC ( @{armorclass} ).">
              <span>Sync AC:</span>
              <input type="checkbox" name="attr_sync_ac_flag" value="1" />
              <span></span>
            </label>
            <label title="@{autocalc_ac} | This is a persistent setting. Let the sheet auto-calculate AC based on the values entered in the Armor Details table above. This will overwrite all values in the bottom row.">
              <span>Auto-Calc AC:</span>
              <input type="checkbox" name="attr_autocalc_ac" value="1" checked />
            </label>
            <label title="@{autocalc_movement_flag} | Let the sheet calculate Movement/Speed. Uses base movement and the current encumbrance(STR vs total_weight carried). Note: Load can can be set manually but any changes to base movement, encumbrance, or opening the sheet will trigger a re-calc.">
              <span>Auto-Calc Movement:</span>
              <input type="checkbox" name="attr_autocalc_movement_flag" value="1" checked />
            </label>
            <label title="@{autofill_matrix} | Let the sheet auto-fill the to-hit tables when the class and level selectors are changed in the attack Matrix window.">
              <span>Auto-fill ToHit:</span>
              <input type="checkbox" name="attr_autofill_matrix" value="1" checked />
            </label>
          </span>
        </span>
      </div>
      <!-- Custom Attributes-->
      <section class="custom-attributes">
        <input type="checkbox" class="sect-show" name="attr_custom_attributes_show" value="1" />
        <div class="header">CUSTOM ATTRIBUTES</div><span class="material-icons"></span>
        <div class="sect">
          <label class="left">
            <span>Single Column</span>
            <input type="checkbox" class="toggle-single-column-attributes" name="attr_toggle_single_column_attributes" title="@{toggle_single_column_attributes}" value="1" checked />
          </label>
          <fieldset class="repeating_attributes">
            <div class="border">
              <span class="inline-label">
                <span>
                  <button class="dice-button" type="roll" name="attr_attribute_roll" title="%{repeating_attributes_$X_attribute_roll} | PC Roll" value="@{attribute_macro_text}"></button>
                </span>
                <label>
                  <input type="text" name="attr_attribute_name" title="@{repeating_attributes_$X_attribute_name}" placeholder="Attribute Name" />
                </label>
                <label>
                  <span>Type:</span>
                  <input type="text" name="attr_attribute_type" title="@{repeating_attributes_$X_attribute_type}" placeholder="n/a" />
                </label>
              </span>
              <span class="custom-attributes-box">
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_1_name" title="@{attribute_mod_1_name}" value="" placeholder="attribute_mod_1" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_1" value="" title="@{attribute_mod_1}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_1_max" value="" title="@{attribute_mod_1_max}" />
                </label>
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_2_name" title="@{attribute_mod_2_name}" value="" placeholder="attribute_mod_2" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_2" value="" title="@{attribute_mod_2}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_2_max" value="" title="@{attribute_mod_2_max}" />
                </label>
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_3_name" title="@{attribute_mod_3_name}" value="" placeholder="attribute_mod_3" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_3" value="" title="@{attribute_mod_3}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_3_max" value="" title="@{attribute_mod_3_max}" />
                </label>
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_4_name" title="@{attribute_mod_4_name}" value="" placeholder="attribute_mod_4" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_4" value="" title="@{attribute_mod_4}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_4_max" value="" title="@{attribute_mod_4_max}" />
                </label>
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_5_name" title="@{attribute_mod_5_name}" value="" placeholder="attribute_mod_5" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_5" value="" title="@{attribute_mod_5}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_5_max" value="" title="@{attribute_mod_5_max}" />
                </label>
                <label>
                  <input type="text" class="width-fill" name="attr_attribute_mod_6_name" title="@{attribute_mod_6_name}" value="" placeholder="attribute_mod_6" />
                </label>
                <label class="two-inputs-over-label">
                  <input type="text" class="width-smallest" name="attr_attribute_mod_6" value="" title="@{attribute_mod_6}" />
                  <span>/</span>
                  <input type="text" class="width-smallest" name="attr_attribute_mod_6_max" value="" title="@{attribute_mod_6_max}" />
                </label>
                <span class="inline-label span-all">
                  <textarea class="height-short" name="attr_attribute_description" title="@{repeating_attributes_$X_attribute_description}" placeholder="Description"></textarea>
                </span>
                <label class="inline-label span-all">
                  <button type="roll" class="info-link" value="@{whisper_pc} [**LINK**](@{attribute_link})" title="Send link to chat."></button>
                  <textarea class="info-link" wrap="off" name="attr_attribute_link" title="@{repeating_attributes_$X_attribute_link}" placeholder="https://www.example.com"></textarea>
                </label>
                <textarea name="attr_attribute_notes" class="inline-label span-all height-short" title="@{repeating_attributes_$X_attribute_notes}" placeholder="Notes"></textarea>
                <textarea class="span-all height-short toggle-macros" name="attr_attribute_macro_text" title="@{repeating_attributes_$X_attribute_macro_text} | Caution: modifying the macro-text can break the roll.  Deleting the macro-text will safely reset the roll to the sheet's default macro.">@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{attribute_name}}} {{type=@{attribute_type}}} {{attribute_mod_1_name=@{attribute_mod_1_name}}} {{attribute_mod_1=@{attribute_mod_1}}} {{attribute_mod_1_max=@{attribute_mod_1|max}}} {{attribute_mod_2_name=@{attribute_mod_2_name}}} {{attribute_mod_2=@{attribute_mod_2}}} {{attribute_mod_2_max=@{attribute_mod_2|max}}} {{attribute_mod_3_name=@{attribute_mod_3_name}}} {{attribute_mod_3=@{attribute_mod_3}}} {{attribute_mod_3_max=@{attribute_mod_3|max}}} {{attribute_mod_4_name=@{attribute_mod_4_name}}} {{attribute_mod_4=@{attribute_mod_4}}} {{attribute_mod_4_max=@{attribute_mod_4|max}}} {{attribute_mod_5_name=@{attribute_mod_5_name}}} {{attribute_mod_5=@{attribute_mod_5}}} {{attribute_mod_5_max=@{attribute_mod_5|max}}} {{attribute_mod_6_name=@{attribute_mod_6_name}}} {{attribute_mod_6=@{attribute_mod_6}}} {{attribute_mod_6_max=@{attribute_mod_6|max}}} {{notes=@{attribute_notes}}} {{link=@{attribute_link}}} {{freetext=@{attribute_description}}}</textarea>
              </span>
            </div>
          </fieldset>
        </div>
      </section>
      <hr>
    </section>
    <!-- Footer -->
    <section class="footer-box">
      <span class="inline-label text-small">
        <span>Questions/feedback?</span>
        <button type="roll" class="url-roll" value="[Current AD&D1e thread](https://app.roll20.net/forum/post/10354613/ad-and-d-1e-update-part-2)">Current AD&D1e sheet thread on Roll20</button>
      </span>
      <span class="inline-label text-small">
        <span>Author: Vince &amp; the Roll20 Community</span>
        <label>
          <span>&nbsp;v.<input type="text" class="width-smaller version" name="attr_sheet_version" value="0" readonly />.beta</span>
        </label>
      </span>
    </section>
  </div>
</div>

<!--Roll Templates -->

<div class="sheet-roll_templates">
  <!-- Attack Roll Template -->
  <rolltemplate class="sheet-rolltemplate-attacks">
    <div class="{{#color}}color-{{color}}{{/color}}">
      <span class="sheet-row">
        {{#name}}
          <span class="sheet-template-header sheet-span-two">{{name}}</span>
        {{/name}}
        {{#subtag}}
          <span class="sheet-subheader sheet-span-two">{{subtag}}{{#dual}}&nbsp;<span class="sheet-smaller-text" title="Dual Attack.">({{dual}})</span>{{/dual}}</span>
        {{/subtag}}
      </span>

      {{#attack1}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Attack =</span>&nbsp;{{attack1}}
            {{#rollWasCrit() attack1}}
              <!-- Only seen if 'Use Crit Damage' is enabled -->
              {{#rollGreater() crit 0}}
                {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
              {{/rollGreater() crit 0}}
            {{/rollWasCrit() attack1}}
          </span>
        </span>
        {{#^rollGreater() crit 0}}
          {{#crit}}
            {{#damagevsSMchatmenu}}{{#damagevsLchatmenu}}
                <span class="sheet-row">
                  <span class="sheet-span-two sheet-center">
                    {{damagevsSMchatmenu}}{{damagevsLchatmenu}}
                  </span>
                </span>
              {{/damagevsLchatmenu}}{{/damagevsSMchatmenu}}
          {{/crit}}
        {{/^rollGreater() crit 0}}
        <!-- Only seen if 'Use Crit Damage' is enabled -->
        {{#rollGreater() crit 0}}
          {{#crit}}
            {{#^rollWasCrit() attack1}}
              {{#damagevsSMchatmenu}}{{#damagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{damagevsSMchatmenu}}{{damagevsLchatmenu}}
                    </span>
                  </span>
                {{/damagevsLchatmenu}}{{/damagevsSMchatmenu}}
            {{/^rollWasCrit() attack1}}
            {{#rollWasCrit() attack1}}
              {{#critdamagevsSMchatmenu}}{{#critdamagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{critdamagevsSMchatmenu}}{{critdamagevsLchatmenu}}
                    </span>
                  </span>
                {{/critdamagevsLchatmenu}}{{/critdamagevsSMchatmenu}}
            {{/rollWasCrit() attack1}}
          {{/crit}}
        {{/rollGreater() crit 0}}
      {{/attack1}}

      {{#attack2}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat">Attack 2 = {{attack2}}
            {{#rollWasCrit() attack2}}
              <!-- Only seen if 'Use Crit Damage' is enabled -->
              {{#rollGreater() crit 0}}
                {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
              {{/rollGreater() crit 0}}
            {{/rollWasCrit() attack2}}
          </span>
        </span>
        {{#rollGreater() crit 0}}
          {{#crit}}
            {{#^rollWasCrit() attack2}}
              {{#damagevsSMchatmenu}}{{#damagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{damagevsSMchatmenu}}{{damagevsLchatmenu}}
                    </span>
                  </span>
                {{/damagevsLchatmenu}}{{/damagevsSMchatmenu}}
            {{/^rollWasCrit() attack2}}
            {{#rollWasCrit() attack2}}
              {{#critdamagevsSMchatmenu}}{{#critdamagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{critdamagevsSMchatmenu}}{{critdamagevsLchatmenu}}
                    </span>
                  </span>
                {{/critdamagevsLchatmenu}}{{/critdamagevsSMchatmenu}}
            {{/rollWasCrit() attack2}}
          {{/crit}}
        {{/rollGreater() crit 0}}
      {{/attack2}}

      {{#attack3}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat">Attack 3 = {{attack3}}
            {{#rollWasCrit() attack3}}
              <!-- Only seen if 'Use Crit Damage' is enabled -->
              {{#rollGreater() crit 0}}
                {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
              {{/rollGreater() crit 0}}
            {{/rollWasCrit() attack3}}
          </span>
        </span>
        {{#rollGreater() crit 0}}
          {{#crit}}
            {{#^rollWasCrit() attack3}}
              {{#damagevsSMchatmenu}}{{#damagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{damagevsSMchatmenu}}{{damagevsLchatmenu}}
                    </span>
                  </span>
                {{/damagevsLchatmenu}}{{/damagevsSMchatmenu}}
            {{/^rollWasCrit() attack3}}
            {{#rollWasCrit() attack3}}
              {{#critdamagevsSMchatmenu}}{{#critdamagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{critdamagevsSMchatmenu}}{{critdamagevsLchatmenu}}
                    </span>
                  </span>
                {{/critdamagevsLchatmenu}}{{/critdamagevsSMchatmenu}}
            {{/rollWasCrit() attack3}}
          {{/crit}}
        {{/rollGreater() crit 0}}
      {{/attack3}}

      {{#attack4}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat">Attack 4 = {{attack4}}
            {{#rollWasCrit() attack4}}
              <!-- Only seen if 'Use Crit Damage' is enabled -->
              {{#rollGreater() crit 0}}
                {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
              {{/rollGreater() crit 0}}
            {{/rollWasCrit() attack4}}
          </span>
        </span>
        {{#rollGreater() crit 0}}
          {{#crit}}
            {{#^rollWasCrit() attack4}}
              {{#damagevsSMchatmenu}}{{#damagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{damagevsSMchatmenu}}{{damagevsLchatmenu}}
                    </span>
                  </span>
                {{/damagevsLchatmenu}}{{/damagevsSMchatmenu}}
            {{/^rollWasCrit() attack4}}
            {{#rollWasCrit() attack4}}
              {{#critdamagevsSMchatmenu}}{{#critdamagevsLchatmenu}}
                  <span class="sheet-row">
                    <span class="sheet-span-two sheet-center">
                      {{critdamagevsSMchatmenu}}{{critdamagevsLchatmenu}}
                    </span>
                  </span>
                {{/critdamagevsLchatmenu}}{{/critdamagevsSMchatmenu}}
            {{/rollWasCrit() attack4}}
          {{/crit}}
        {{/rollGreater() crit 0}}
      {{/attack4}}

      {{#damage1vsSM}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage =</span>&nbsp;{{damage1vsSM}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage1vsSM}}
      {{#damage1vsL}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage vs LG =</span>&nbsp;{{damage1vsL}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage1vsL}}

      {{#damage2vsSM}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 2 =</span>&nbsp;{{damage2vsSM}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage2vsSM}}
      {{#damage2vsL}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 2 vs LG =</span>&nbsp;{{damage2vsL}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage2vsL}}

      {{#damage3vsSM}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 3 =</span>&nbsp;{{damage3vsSM}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage3vsSM}}
      {{#damage3vsL}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 3 vs LG =</span>&nbsp;{{damage3vsL}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage3vsL}}

      {{#damage4vsSM}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 4 =</span>&nbsp;{{damage4vsSM}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage4vsSM}}
      {{#damage4vsL}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-tcat"><span class="sheet-center">Damage 4 vs LG =</span>&nbsp;{{damage4vsL}}
            <!-- Only seen if 'Use Crit Damage' is enabled -->
            {{#rollGreater() crit 0}}
              {{#crit}}<span class="sheet-bold sheet-center">CRIT!</span>{{/crit}}
            {{/rollGreater() crit 0}}
          </span>
        </span>
      {{/damage4vsL}}

      <span class="sheet-row">
        <span class="sheet-span-two sheet-tcat">
          {{#rollGreater() backstab 1}}
            {{#backstab}}<span class="sheet-bold sheet-center">Backstab Attack!!!</span>{{/backstab}}
          {{/rollGreater() backstab 1}}
        </span>
      </span>

      <span class="sheet-row">
        <span class="sheet-span-two smaller-text">
          {{#damagetype}}<span class="sheet-bold">Type:&nbsp;</span>{{damagetype}}&nbsp;{{/damagetype}}
          {{#rate}}<span class="sheet-bold">RoF:&nbsp;</span>{{rate}}&nbsp;{{/rate}}
          {{#range}}<span class="sheet-bold">Range:&nbsp;</span>{{range}}&nbsp;{{/range}}
          {{#length}}<span class="sheet-bold">Length:&nbsp;</span>{{length}}&nbsp;{{/length}}
          {{#space}}<span class="sheet-bold">Space:&nbsp;</span>{{space}}&nbsp;{{/space}}
          {{#speed}}<span class="sheet-bold">Speed:&nbsp;</span>{{speed}}&nbsp;{{/speed}}
          {{#range}}
            {{#rollGreater() ammo 0}}
              {{#ammo}}<span class="sheet-bold">Ammo:&nbsp;</span>{{ammo}}&nbsp;{{/ammo}}
            {{/rollGreater() ammo 0}}
            {{#rollTotal() ammo 0}}
              {{#ammo}}<span class="sheet-bold">No Ammo!</span>&nbsp;{{/ammo}}
            {{/rollTotal() ammo 0}}
          {{/range}}
        </span>
      </span>

      {{#ToHitAC-10to0}}
        <span class="sheet-ToHit sheet-span-two">AC:-10|-9|-8|-7|-6|-5|-4|-3|-2|-1|&nbsp;**0**<br />{{ToHitAC-10to0}}</span>
      {{/ToHitAC-10to0}}
      {{#ToHitAC1to10}}
        <span class="sheet-ToHit sheet-span-two">AC: **0**| 1| 2| 3| 4| 5| 6| 7| 8| 9|10<br />{{ToHitAC1to10}}</span>
      {{/ToHitAC1to10}}

      {{#allprops() name subtag footer backstab crit dual color attack1 attack2 attack3 attack4 damagevsSMchatmenu damagevsLchatmenu critdamagevsSMchatmenu critdamagevsLchatmenu damage1vsSM damage2vsSM damage3vsSM damage4vsSM damage1vsL damage2vsL damage3vsL damage4vsL damage1 ToHitACadj2to10 ToHitAC-10to0 ToHitAC1to10 WeaponNotes freetext damagetype rate range length space speed ammo whisper}}
        <span class="sheet-row sheet-all-props">
          <span class="sheet-tcat">{{key}}</span>
          <span>{{value}}</span>
        </span>
      {{/allprops() name subtag footer backstab crit dual color attack1 attack2 attack3 attack4 damagevsSMchatmenu damagevsLchatmenu critdamagevsSMchatmenu critdamagevsLchatmenu damage1vsSM damage2vsSM damage3vsSM damage4vsSM damage1vsL damage2vsL damage3vsL damage4vsL damage1 ToHitACadj2to10 ToHitAC-10to0 ToHitAC1to10 WeaponNotes freetext damagetype rate range length space speed ammo whisper}}

      {{#WeaponNotes}}
        <span class="sheet-row">
          <span class="sheet-text sheet-span-two sheet-text"><span class="sheet-bold">Notes</span>:&nbsp;{{WeaponNotes}}</span>
        </span>
      {{/WeaponNotes}}
      {{#freetext}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-text">{{freetext}}</span>
        </span>
      {{/freetext}}
      {{#ToHitACadj2to10}}
        <span class="sheet-row">
          <span class="sheet-ToHit sheet-span-two">ACtype: 0| 1| 2| 3| 4| 5| 6| 7| 8| 9|10<br />{{ToHitACadj2to10}}</span>
        </span>
      {{/ToHitACadj2to10}}
      <span class="sheet-row">
        <span class="sheet-template-footer sheet-span-two">{{#footer}}{{footer}}{{/footer}}</span>
      </span>
    </div>
  </rolltemplate>

  <!-- Attack Table Roll Template -->
  <rolltemplate class="sheet-rolltemplate-attacks-table">
    <div class="{{#color}}color-{{color}}{{/color}}">
      <span class="sheet-row">
        {{#name}}
          <span class="sheet-template-header sheet-span-two">{{name}}</span>
        {{/name}}
        {{#subtag}}
          <span class="sheet-subheader sheet-span-two">{{subtag}}</span>
        {{/subtag}}
      </span>
      {{#ToHitAC-10to0}}
        <span class="sheet-ToHit sheet-span-two">AC:-10|-9|-8|-7|-6|-5|-4|-3|-2|-1|&nbsp;**0**<br />{{ToHitAC-10to0}}</span>
      {{/ToHitAC-10to0}}
      {{#ToHitAC1to10}}
        <span class="sheet-ToHit sheet-span-two">AC: **0**| 1| 2| 3| 4| 5| 6| 7| 8| 9|10<br />{{ToHitAC1to10}}</span>
      {{/ToHitAC1to10}}
    </div>
  </rolltemplate>

  <!-- General Roll Template -->
  <rolltemplate class="sheet-rolltemplate-general">
    <div class="{{#color}}color-{{color}}{{/color}}">
      <span class="sheet-row">
        {{#name}}
          <span class="sheet-template-header sheet-span-two">{{name}}</span>
        {{/name}}
        {{#subtag}}
          <span class="sheet-subheader sheet-span-two">{{subtag}}</span>
        {{/subtag}}
      </span>
      <!--Success/Failure for Roll High-->
      {{#roll_high}}
        {{#^rollLess() roll_high roll_target}}
          <span class="sheet-row">
            <span class="sheet-tcat sheet-span-two sheet-success">Success!</span>
        {{/^rollLess() roll_high roll_target}}
        {{#rollLess() roll_high roll_target}}
          <span class="sheet-tcat sheet-span-two sheet-failure">Failure...</span>
        {{/rollLess() roll_high roll_target}}
        </span>
        <span class="sheet-row sheet-span-two sheet-tcat"><span class="sheet-center">Roll =</span>&nbsp;{{roll_high}}&nbsp;<span class="sheet-center">vs</span>&nbsp;{{roll_target}}</span>
      {{/roll_high}}
      <!--Success/Failure for Roll Low-->
      {{#roll_low}}
        {{#^rollGreater() roll_low roll_target}}
          <span class="sheet-row">
            <span class="sheet-tcat sheet-span-two sheet-success">Success!</span>
        {{/^rollGreater() roll_low roll_target}}
        {{#rollGreater() roll_low roll_target}}
          <span class="sheet-tcat sheet-span-two sheet-failure">Failure...</span>
        {{/rollGreater() roll_low roll_target}}
        </span>
        <span class="sheet-row sheet-span-two sheet-tcat"><span class="sheet-center">Roll =</span>&nbsp;{{roll_low}}&nbsp;<span class="sheet-center">vs</span>&nbsp;{{roll_target}}</span>
      {{/roll_low}}
      {{#^rollTotal() roll 0}}
        <span class="sheet-row sheet-span-two sheet-tcat"><span class="sheet-center">Roll =</span>&nbsp;{{roll}}</span>
      {{/^rollTotal() roll 0}}
      <!--Spells and Special Abilities-->
      {{#effect_type}}
        <span class="sheet-row">
          <span class="sheet-tcat">Effect Type</span>
          <span>{{effect_type}}</span>
        </span>
      {{/effect_type}}
      {{#spell_class}}
        <span class="sheet-row">
          <span class="sheet-tcat">{{spell_class}}</span>
          {{#spell_class_level}}<span>Level:{{spell_class_level}}</span>{{/spell_class_level}}
        </span>
      {{/spell_class}}
      {{#school}}
        <span class="sheet-row">
          <span class="sheet-tcat">Type</span>
          <span>{{school}}</span>
        </span>
      {{/school}}
      {{#spell_level}}
        <span class="sheet-row">
          <span class="sheet-tcat">Spell Level</span>
          <span>{{spell_level}}</span>
        </span>
      {{/spell_level}}
      {{#range}}
        <span class="sheet-row">
          <span class="sheet-tcat">Range</span>
          <span>{{range}}</span>
        </span>
      {{/range}}
      {{#duration}}
        <span class="sheet-row">
          <span class="sheet-tcat">Duration</span>
          <span>{{duration}}</span>
        </span>
      {{/duration}}
      {{#area_of_effect}}
        <span class="sheet-row">
          <span class="sheet-tcat">Area of Effect</span>
          <span>{{area_of_effect}}</span>
        </span>
      {{/area_of_effect}}
      {{#components}}
        <span class="sheet-row">
          <span class="sheet-tcat">Components</span>
          <span>{{components}}</span>
        </span>
      {{/components}}
      {{#casting_time}}
        <span class="sheet-row">
          <span class="sheet-tcat">Casting Time</span>
          <span>{{casting_time}}</span>
        </span>
      {{/casting_time}}
      {{#saving_throw}}
        <span class="sheet-row">
          <span class="sheet-tcat">Saving Throw</span>
          <span>{{saving_throw}}</span>
        </span>
      {{/saving_throw}}
      {{#save_type}}
        <span class="sheet-row">
          <span class="sheet-tcat">Save Type</span>
          <span>{{save_type}}</span>
        </span>
      {{/save_type}}
      {{#type}}
        <span class="sheet-row">
          <span class="sheet-tcat">Type:</span>
          <span>{{type}}</span>
        </span>
      {{/type}}
      <!-- repeating custom attributes-->
      {{#attribute_mod_1_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_1</span>
          <span>{{attribute_mod_1_name}}: {{#attribute_mod_1}}{{attribute_mod_1}}{{/attribute_mod_1}}{{#attribute_mod_1_max}}/{{attribute_mod_1_max}}{{/attribute_mod_1_max}}</span>
        </span>
      {{/attribute_mod_1_name}}
      {{#attribute_mod_2_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_2</span>
          <span>{{attribute_mod_2_name}}: {{#attribute_mod_2}}{{attribute_mod_2}}{{/attribute_mod_2}}{{#attribute_mod_2_max}}/{{attribute_mod_2_max}}{{/attribute_mod_2_max}}</span>
        </span>
      {{/attribute_mod_2_name}}
      {{#attribute_mod_3_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_3</span>
          <span>{{attribute_mod_3_name}}: {{#attribute_mod_3}}{{attribute_mod_3}}{{/attribute_mod_3}}{{#attribute_mod_3_max}}/{{attribute_mod_3_max}}{{/attribute_mod_3_max}}</span>
        </span>
      {{/attribute_mod_3_name}}
      {{#attribute_mod_4_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_4</span>
          <span>{{attribute_mod_4_name}}: {{#attribute_mod_4}}{{attribute_mod_4}}{{/attribute_mod_4}}{{#attribute_mod_4_max}}/{{attribute_mod_4_max}}{{/attribute_mod_4_max}}</span>
        </span>
      {{/attribute_mod_4_name}}
      {{#attribute_mod_5_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_5</span>
          <span>{{attribute_mod_5_name}}: {{#attribute_mod_5}}{{attribute_mod_5}}{{/attribute_mod_5}}{{#attribute_mod_5_max}}/{{attribute_mod_5_max}}{{/attribute_mod_5_max}}</span>
        </span>
      {{/attribute_mod_5_name}}
      {{#attribute_mod_6_name}}
        <span class="sheet-row">
          <span class="sheet-tcat">attribute_mod_6</span>
          <span>{{attribute_mod_6_name}}: {{#attribute_mod_6}}{{attribute_mod_6}}{{/attribute_mod_6}}{{#attribute_mod_6_max}}/{{attribute_mod_6_max}}{{/attribute_mod_6_max}}</span>
        </span>
      {{/attribute_mod_6_name}}

      <!-- locked door -->
      {{#rollGreater() locked_doors 0}}
        {{#locked_doors}}
          <span class="sheet-row sheet-span-two sheet-text">{{locked_doors}}</span>
        {{/locked_doors}}
      {{/rollGreater() locked_doors 0}}

      <span class="sheet-row">
        <span class="sheet-span-two sheet-tcat sheet-right">
          {{#uses_max}}
            {{#^rollTotal() uses_max 0}}
              {{#uses}}
                <span class="sheet-inlineroll-reset">Uses:{{uses}}/{{uses_max}}&nbsp;</span>
              {{/uses}}
            {{/^rollTotal() uses_max 0}}
          {{/uses_max}}

          {{#quantity_max}}
            {{#quantity}}
              <span class="sheet-inlineroll-reset">Qty:{{quantity}}/{{quantity_max}}</span>
            {{/quantity}}
          {{/quantity_max}}
        </span>
      </span>

      {{#allprops() name subtag footer freetext color effect_type school spell_level spell_class spell_class_level range duration area_of_effect components casting_time saving_throw save_type link type roll roll_high roll_low roll_target rolldecimal nwp_mod_applied mod_applied wis_applied current_encumbrance dex_adjustment quantity quantity_max uses uses_max whisper attribute_mod_1_name attribute_mod_1 attribute_mod_1_max attribute_mod_2_name attribute_mod_2 attribute_mod_2_max attribute_mod_3_name attribute_mod_3 attribute_mod_3_max attribute_mod_4_name attribute_mod_4 attribute_mod_4_max attribute_mod_5_name attribute_mod_5 attribute_mod_5_max attribute_mod_6_name attribute_mod_6 attribute_mod_6_max notes locked_doors}}
        <!-- <span class="sheet-row sheet-span-two sheet-all-props">
          {{key}}{{value}}
        </span> -->
        <span class="sheet-row sheet-all-props">
          <span class="sheet-tcat">{{key}}</span>
          <span>{{value}}</span>
        </span>
      {{/allprops() name subtag footer freetext color effect_type school spell_level spell_class spell_class_level range duration area_of_effect components casting_time saving_throw save_type link type roll roll_high roll_low roll_target rolldecimal nwp_mod_applied mod_applied wis_applied current_encumbrance dex_adjustment quantity quantity_max uses uses_max whisper attribute_mod_1_name attribute_mod_1 attribute_mod_1_max attribute_mod_2_name attribute_mod_2 attribute_mod_2_max attribute_mod_3_name attribute_mod_3 attribute_mod_3_max attribute_mod_4_name attribute_mod_4 attribute_mod_4_max attribute_mod_5_name attribute_mod_5 attribute_mod_5_max attribute_mod_6_name attribute_mod_6 attribute_mod_6_max notes locked_doors}}

      <span class="sheet-row">
        <span class="sheet-span-two smaller-text">
          {{#nwp_mod_applied}}<span class="sheet-bold">NWP Mod Applied:</span>{{nwp_mod_applied}}&nbsp;{{/nwp_mod_applied}}
          {{#mod_applied}}<span class="sheet-bold">Mod Applied:</span>{{mod_applied}}&nbsp;{{/mod_applied}}
          {{#wis_applied}}<span class="sheet-bold">Wis Applied:</span>{{wis_applied}}&nbsp;{{/wis_applied}}
          {{#dex_adjustment}}<span class="sheet-bold">Dex Adj:</span>{{dex_adjustment}}&nbsp;{{/dex_adjustment}}
          {{#encumbrance}}<span class="sheet-bold">Encumbrance:</span>{{encumbrance}}&nbsp;{{/encumbrance}}
          {{#rollTotal() current_encumbrance 0}}
            {{#current_encumbrance}}<span class="sheet-bold">Encum/Bulk - Normal</span>
              &nbsp;<span>None</span>{{/current_encumbrance}}
          {{/rollTotal() current_encumbrance 0}}
          {{#rollTotal() current_encumbrance 1}}
            {{#current_encumbrance}}<span class="sheet-bold">Encum/Bulk - Heavy</span>
              &nbsp;<span>No DEX Bonus to Init.</span>{{/current_encumbrance}}
          {{/rollTotal() current_encumbrance 1}}
          {{#rollTotal() current_encumbrance 2}}
            {{#current_encumbrance}}<span class="sheet-bold">Encum/Bulk - Very Heavy</span>
              &nbsp;<span>No DEX Bonus to Init, Delayed, +1 Segment if Surprised.</span>{{/current_encumbrance}}
          {{/rollTotal() current_encumbrance 2}}
          {{#rollTotal() current_encumbrance 3}}
            {{#current_encumbrance}}<span class="sheet-bold">Encum/Bulk - Encumbered</span>
              &nbsp;<span>No DEX Bonus to Init or AC, Go Last in Init, +2 Segments if Surprised, Cannot Charge, Enemies get +2 to-hit.</span>{{/current_encumbrance}}
          {{/rollTotal() current_encumbrance 3}}
        </span>
      </span>

      {{#notes}}
        <span class="sheet-row">
          <span class="sheet-tcat sheet-span-two sheet-left">Notes:</span>
          <span class="sheet-row sheet-span-two sheet-text" style="font-weight: normal;">{{notes}}</span>
        </span>
      {{/notes}}
      {{#freetext}}
        <span class="sheet-row">
          <span class="sheet-row sheet-span-two sheet-text">{{freetext}}</span>
        </span>
      {{/freetext}}
      {{#link}}
        <span class="sheet-row">
          <span class="sheet-span-two sheet-right">[LINK]({{link}})</span>
        </span>
      {{/link}}
      <span class="sheet-row">
        <span class="sheet-template-footer sheet-span-two">{{#footer}}{{footer}}{{/footer}}</span>
      </span>
    </div>
  </rolltemplate>
</div>

<!--Datalists-->
<datalist id="spell_school">
  <option value="Abjur">Abjur</option>
  <option value="Abjur, Evoc">Abjur, Evoc</option>
  <option value="Abjur/Alter">Abjur/Alter</option>
  <option value="Abjur/Conj/Summ">Abjur/Conj/Summ</option>
  <option value="Abjur/Evoc">Abjur/Evoc</option>
  <option value="Alter">Alter</option>
  <option value="Alter, Ench">Alter, Ench</option>
  <option value="Alter/Conj">Alter/Conj</option>
  <option value="Alter/Conj/Summ">Alter/Conj/Summ</option>
  <option value="Alter/Ench">Alter/Ench</option>
  <option value="Alter/Evoc">Alter/Evoc</option>
  <option value="Alter/Illus">Alter/Illus</option>
  <option value="Alter/Illus/Phant">Alter/Illus/Phant</option>
  <option value="Alter/Phant">Alter/Phant</option>
  <option value="Charm">Charm</option>
  <option value="Conj">Conj</option>
  <option value="Conj, Alter">Conj, Alter</option>
  <option value="Conj/Phant">Conj/Phant</option>
  <option value="Conj/Summ">Conj/Summ</option>
  <option value="Divin">Divin</option>
  <option value="Ench">Ench</option>
  <option value="Ench, Alter">Ench, Alter</option>
  <option value="Ench/Alter">Ench/Alter</option>
  <option value="Ench/Charm">Ench/Charm</option>
  <option value="Ench/Charm/Illus/Phant">Ench/Charm/Illus/Phant</option>
  <option value="Ench/Divin">Ench/Divin</option>
  <option value="Ench/Evoc">Ench/Evoc</option>
  <option value="Evoc">Evoc</option>
  <option value="Evoc, Alter">Evoc, Alter</option>
  <option value="Evoc/Abjur">Evoc/Abjur</option>
  <option value="Evoc/Alter">Evoc/Alter</option>
  <option value="Evoc/Alter/Ench/Charm">Evoc/Alter/Ench/Charm</option>
  <option value="Evoc/Conj">Evoc/Conj</option>
  <option value="Evoc/Divin">Evoc/Divin</option>
  <option value="Evoc/Ench">Evoc/Ench</option>
  <option value="Evoc/Ench/Charm">Evoc/Ench/Charm</option>
  <option value="Evoc/Illus">Evoc/Illus</option>
  <option value="Evoc/Illus/Phant">Evoc/Illus/Phant</option>
  <option value="Illus">Illus</option>
  <option value="Illus/Ench">Illus/Ench</option>
  <option value="Illus/Phant">Illus/Phant</option>
  <option value="Illus/Phant/Abjur">Illus/Phant/Abjur</option>
  <option value="Illus/Phant/Alter">Illus/Phant/Alter</option>
  <option value="Illus/Phant/Conj/Summ">Illus/Phant/Conj/Summ</option>
  <option value="Invoc">Invoc</option>
  <option value="Necro">Necro</option>
  <option value="Necro, Conj">Necro, Conj</option>
  <option value="Summ">Summ</option>
  <option value="Varies">Varies</option>
</datalist>

<script type="text/worker">
  // text/javascript
  // text/worker

  // GiGs custom handling for number type and logs
  const int = (score, fallback = 0) => parseInt(score) || fallback;
  const float = (score, fallback = 0) => parseFloat(score) || fallback;
  const clog = (text, color = 'green') => {
    const message = `%c ${text}`;
    console.log(message, `color: ${color}; font-weight:bold`);
  };

  // during version updates, we need to check that an attribute exists and is not equal to its default, before updating it.
  // changed != to !==   ie eslint suggestion
  const doUpdate = (stat, def = 0) => typeof stat !== 'undefined' && stat !== def;

  // handles regex for testing and replacing macrotext attributes
  const replaceSet = (attr, set) => {
    // set must be an object, with key: value pairs of 'itemToReplace': 'replaceWith'.
    let modifiedAttr = attr; // Create a new variable to store the modified string
    _.each(Object.entries(set), ([toReplace, replaceWith]) => {
      modifiedAttr = modifiedAttr.replace(new RegExp(toReplace.replace('{', '{'), 'gi'), replaceWith);
    });
    return modifiedAttr;
  };

  // Number Validation
  const numbersOnly = (attr) => {
    // numbers and/or - + symbols before number are allowed
    // add a `(?:\.[0-9]+)?` after the `[0-9]+` bit if decimals are allowed
    return /^[-+]?[0-9]+$/.test(attr) ? 1 : 0;
  };

  // generate a unique ID 100 % of the time
  const uniqueids = {};
  const generateUniqueRowID = () => {
    let generated = generateRowID();
    while (uniqueids[generated] === true) {
      clog(`generateUniqueRowID: ${generated} is not a unique ID, trying again.`);
      generated = generateRowID();
    }
    // clog(`generateUniqueRowID: ${generated} verified as unique, returning.`);
    uniqueids[generated] = true;
    return generated;
  };

  // Validate input for +/- adjustment
  on(
    'change:armortype_magic change:armortype2_magic change:armorshield_magic change:armorhelmet_magic change:armorother_magic change:armorother2_magic change:armorother3_magic change:armorother4_magic change:armorother5_magic change:armorother6_magic change:armorshield_mod change:armorother_mod change:armorother2_mod change:armorother3_mod change:armorother4_mod change:armorother5_mod change:armorother6_mod change:repeating_equipment:equipment_armor_mod change:repeating_equipment:equipment_armor_magic, change:hitpoints_1_class, change:hitpoints_2_class, change:hitpoints_3_class',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      const id = eventInfo.sourceAttribute.split('_')[2];
      getAttrs(
        [
          'armortype_magic',
          'armortype2_magic',
          'armorshield_magic',
          'armorhelmet_magic',
          'armorother_magic',
          'armorother2_magic',
          'armorother3_magic',
          'armorother4_magic',
          'armorother5_magic',
          'armorother6_magic',
          'armorshield_mod',
          'armorother_mod',
          'armorother2_mod',
          'armorother3_mod',
          'armorother4_mod',
          'armorother5_mod',
          'armorother6_mod',
          `repeating_equipment_${id}_equipment_armor_magic`,
          `repeating_equipment_${id}_equipment_armor_mod`,
          'hitpoints_1_class',
          'hitpoints_2_class',
          'hitpoints_3_class',
        ],
        (v) => {
          const output = {};
          const attr = v[`${eventInfo.sourceAttribute}`];
          // validate input
          const isNumber = numbersOnly(attr);
          // clog(`NUMBER?: ${isNumber}`);
          // write to a hidden checkbox in html ie 'X_error', CSS to style
          output[`${eventInfo.sourceAttribute}_error`] = isNumber;
          // output[`${eventInfo.sourceAttribute}`] = isNumber === 0 ? 0 : attr;
          setAttrs(output, {silent: true});
        }
      );
    }
  );

  // Global Variables
  let versionator = '';
  let autoCalcSaveRows = '';
  let autoCalcThiefRows = '';
  let autoCalcAbilityRows = '';
  let calcRange = '';
  let calcHP = '';
  let calcAC = '';
  let damageMacro = '';
  let strengthCalcs = '';
  let intelligenceCalcs = '';
  let wisdomCalcs = '';
  let dexterityCalcs = '';
  let constitutionCalcs = '';
  let charismaCalcs = '';
  let armorDetailsRowidArray;
  let saveparalysispoisondeathCalc = '';
  let savepetrificationpolymorphCalc = '';
  let saverodsstaveswandsCalc = '';
  let savebreathweaponsCalc = '';
  let savespellsCalc = '';
  let savemiscCalc = '';
  let savemisc1Calc = '';
  let savemisc2Calc = '';
  let pickpocketsCalc = '';
  let openlocksCalc = '';
  let findtrapsCalc = '';
  let movequietlyCalc = '';
  let hideinshadowsCalc = '';
  let hearnoiseCalc = '';
  let climbwallsCalc = '';
  let readlanguagesCalc = '';
  let thiefmiscCalc = '';
  let thiefmisc1Calc = '';
  let thiefmisc2Calc = '';
  let setSpellsCasterClass = '';

  const armorRowIDs = [
    'unarmored_row_id',
    'armortype1_row_id',
    'armortype2_row_id',
    'armorshield_row_id',
    'armorhelmet_row_id',
    'armorother1_row_id',
    'armorother2_row_id',
    'armorother3_row_id',
    'armorother4_row_id',
    'armorother5_row_id',
    'armorother6_row_id',
  ];

  const armorAttrs = [
    'unarmored_worn',
    'unarmored',
    'unarmored_ac',
    'unarmored_base',
    'unarmored_bulk',
    'unarmored_carried',
    'unarmored_weight',
    'unarmored_cost',
    'armortype_worn',
    'armortype',
    'armortype_ac',
    'armortype_base',
    'armortype_magic',
    'armortype_bulk',
    'armortype_carried',
    'armor_weight',
    'armor_cost',
    'armortype2_worn',
    'armortype2',
    'armortype2_ac',
    'armortype2_base',
    'armortype2_magic',
    'armortype2_bulk',
    'armortype2_carried',
    'armortype2_weight',
    'armortype2_cost',
    'armorshield_worn',
    'armorshield',
    'armorshield_ac',
    'armorshield_base',
    'armorshield_magic',
    'armorshield_mod',
    'armorshield_bulk',
    'armorshield_carried',
    'armorshield_weight',
    'armorshield_cost',
    'armorhelmet_worn',
    'armorhelmet',
    'armorhelmet_ac',
    'armorhelmet_magic',
    'armorhelmet_bulk',
    'armorhelmet_carried',
    'armorhelmet_weight',
    'armorhelmet_cost',
    'armorother_worn',
    'armorother',
    'armorother_ac',
    'armorother_base',
    'armorother_magic',
    'armorother_mod',
    'armorother2_worn',
    'armorother2',
    'armorother2_ac',
    'armorother2_base',
    'armorother2_magic',
    'armorother2_mod',
    'armorother3_worn',
    'armorother3',
    'armorother3_ac',
    'armorother3_base',
    'armorother3_magic',
    'armorother3_mod',
    'armorother4_worn',
    'armorother4',
    'armorother4_ac',
    'armorother4_base',
    'armorother4_magic',
    'armorother4_mod',
    'armorother5_worn',
    'armorother5',
    'armorother5_ac',
    'armorother5_base',
    'armorother5_magic',
    'armorother5_mod',
    'armorother6_worn',
    'armorother6',
    'armorother6_ac',
    'armorother6_base',
    'armorother6_magic',
    'armorother6_mod',
  ];

  // use in getSectionIds to separate repeating attribute names
  const section_attribute = (section, id, field) => `repeating_${section}_${id}_${field}`;

  // VERSIONATOR example
  // use blankUpdateTemplate below as a guide to add updates to versionator.
  // const blankUpdateTemplate = (current_version, final_version) => {
  // have this line up near the start
  //  const output = {};
  // do stuff. ie geSectionIDs, getAttrs, all the various calculations
  // then end the worker
  //  output.sheet_version = current_version;
  //  setAttrs(output, {silent: true}, versionator(current_version, final_version));
  // dont forget any close brackets for getattrs, etc.
  //  };
  // END

  // fixes attribute name conflict
  const dmgSwap = (current_version, final_version) => {
    // copy DmgBonus value to AttackDmgBonus
    // replace all instances of @{DmgBonus} with @{AttackDmgBonus} in macro-text
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'DmgBonus'));
        fields.push(section_attribute('weapon', id, 'macro-text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const macrodefault =
          '&{template:attacks} {{name=@{character_name}}} {{subtag=@{WeaponName}}} {{attack1=[[1d20 + @{ToHitBonus}[BON] + @{MagicBonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{DamageSmallMedium} + @{DmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{DamageLarge} + @{DmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{WeaponNotes}}} @{whisper_to-hit}';
        _.each(idArray, (id) => {
          const macrotext = v[section_attribute('weapon', id, 'macro-text')] || macrodefault;
          // replaces old attribute value with new
          output[section_attribute('weapon', id, 'macro-text')] = macrotext.replace(/@{DmgBonus}/g, '@{AttackDmgBonus}');
          output[section_attribute('weapon', id, 'AttackDmgBonus')] = +v[section_attribute('weapon', id, 'DmgBonus')] || 0;
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: dmgSwap completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // fixes attribute name conflict
  const maxSwap = (current_version, final_version) => {
    getSectionIDs('repeating_ability', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('ability', id, 'max'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        _.each(idArray, (id) => {
          // replaces old attribute value with new
          output[section_attribute('ability', id, 'current_max')] = +v[section_attribute('ability', id, 'max')] || 0;
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: maxSwap completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // replace default macro-text of non-weapon proficiencies ONLY IF they haven't been edited
  const nwpMacroUpdate = (current_version, final_version) => {
    const output = {};
    getSectionIDs('repeating_nonweaponproficiencies', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('nonweaponproficiencies', id, 'macro-text'));
      });
      getAttrs([...fields], (v) => {
        const replacements = {
          nwp_old:
            '&{template:general} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{=@{short_description}}}{{Success Amount=[[((@{rAttribute})+(@{rSlots}-1)-1d20)cs>1cf<-1]]}}',
          nwp_new:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{Proficiency Check=[[ 1d20 + [[@{rmodifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{rAttribute}[ATTR] ]]}}{{freetext=@{short_description}}}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('nonweaponproficiencies', id, 'macro-text')]) {
            output[section_attribute('nonweaponproficiencies', id, 'macro-text')] = v[section_attribute('nonweaponproficiencies', id, 'macro-text')].replace(
              replacements.nwp_old,
              replacements.nwp_new
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: nwpMacroUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  const weaponNameFix = (current_version, final_version) => {
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'roll'));
        fields.push(section_attribute('weapon', id, 'weaponname'));
        fields.push(section_attribute('weapon', id, 'tohitbonus'));
        fields.push(section_attribute('weapon', id, 'magicbonus'));
        fields.push(section_attribute('weapon', id, 'attackdmgbonus'));
        fields.push(section_attribute('weapon', id, 'whisper_to-hit'));
        fields.push(section_attribute('weapon', id, 'macro-text'));
        fields.push(section_attribute('weapon', id, 'damagesmallmedium'));
        fields.push(section_attribute('weapon', id, 'damagelarge'));
        fields.push(section_attribute('weapon', id, 'rateoffire'));
        fields.push(section_attribute('weapon', id, 'range'));
        fields.push(section_attribute('weapon', id, 'quantity'));
        fields.push(section_attribute('weapon', id, 'weight'));
        fields.push(section_attribute('weapon', id, 'weaponspeed'));
        fields.push(section_attribute('weapon', id, 'cost'));
        fields.push(section_attribute('weapon', id, 'weaponnotes'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const namesToFix = {
          '@{rateoffire}': '@{weapon_rateoffire}',
          '@{weaponname}': '@{weapon_name}',
          '@{tohitbonus}': '@{weapon_tohitbonus}',
          '@{magicbonus}': '@{weapon_magicbonus}',
          '@{attackdmgbonus}': '@{weapon_attackdmgbonus}',
          '@{whisper_to-hit}': '@{weapon_whisper_to_hit}',
          '@{damagesmallmedium}': '@{weapon_damagesmallmedium}',
          '@{damagelarge}': '@{weapon_damagelarge}',
          '@{range}': '@{weapon_range}',
          '@{quantity}': '@{weapon_quantity}',
          '@{weight}': '@{weapon_weight}',
          '@{weaponspeed}': '@{weapon_speed}',
          '@{cost}': '@{weapon_cost}',
          '@{macro-text}': '@{weapon_macro_text}',
          '@{weaponnotes}': '@{weapon_notes}',
        };
        const oldMacrotext =
          '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{WeaponName}}} {{attack1=[[1d20 + @{ToHitBonus}[BON] + @{MagicBonus}[MAG] + ?{To Hit Modifier?|0}[MOD]) ]]}} {{damage1vsSM=[[@{DamageSmallMedium} + @{AttackDmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{DamageLarge} + @{AttackDmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{WeaponNotes}}} @{whisper_to-hit}';
        _.each(idArray, (id) => {
          if (doUpdate(v[section_attribute('weapon', id, 'rateoffire')]))
            output[section_attribute('weapon', id, 'weapon_rateoffire')] = int(v[section_attribute('weapon', id, 'rateoffire')]);
          if (doUpdate(v[section_attribute('weapon', id, 'roll')])) output[section_attribute('weapon', id, 'weapon_roll')] = v[section_attribute('weapon', id, 'roll')];
          if (doUpdate(v[section_attribute('weapon', id, 'weaponname')])) output[section_attribute('weapon', id, 'weapon_name')] = v[section_attribute('weapon', id, 'weaponname')];
          if (doUpdate(v[section_attribute('weapon', id, 'tohitbonus')]))
            output[section_attribute('weapon', id, 'weapon_tohitbonus')] = int(v[section_attribute('weapon', id, 'tohitbonus')]);
          if (doUpdate(v[section_attribute('weapon', id, 'magicbonus')]))
            output[section_attribute('weapon', id, 'weapon_magicbonus')] = int(v[section_attribute('weapon', id, 'magicbonus')]);
          if (doUpdate(v[section_attribute('weapon', id, 'attackdmgbonus')]))
            output[section_attribute('weapon', id, 'weapon_attackdmgbonus')] = int(v[section_attribute('weapon', id, 'attackdmgbonus')]);
          if (doUpdate(v[section_attribute('weapon', id, 'whisper_to-hit')]))
            output[section_attribute('weapon', id, 'weapon_whisper_to_hit')] = v[section_attribute('weapon', id, 'whisper_to-hit')];
          if (doUpdate(v[section_attribute('weapon', id, 'macro-text')], oldMacrotext))
            output[section_attribute('weapon', id, 'weapon_macro_text')] = replaceSet(v[section_attribute('weapon', id, 'macro-text')], namesToFix);
          if (doUpdate(v[section_attribute('weapon', id, 'damagesmallmedium')]))
            output[section_attribute('weapon', id, 'weapon_damagesmallmedium')] = v[section_attribute('weapon', id, 'damagesmallmedium')];
          if (doUpdate(v[section_attribute('weapon', id, 'damagelarge')]))
            output[section_attribute('weapon', id, 'weapon_damagelarge')] = v[section_attribute('weapon', id, 'damagelarge')];
          if (doUpdate(v[section_attribute('weapon', id, 'range')])) output[section_attribute('weapon', id, 'weapon_range')] = v[section_attribute('weapon', id, 'range')];
          if (doUpdate(v[section_attribute('weapon', id, 'quantity')]))
            output[section_attribute('weapon', id, 'weapon_quantity')] = float(v[section_attribute('weapon', id, 'quantity')]);
          if (doUpdate(v[section_attribute('weapon', id, 'weight')])) output[section_attribute('weapon', id, 'weapon_weight')] = float(v[section_attribute('weapon', id, 'weight')]);
          if (doUpdate(v[section_attribute('weapon', id, 'weaponspeed')]))
            output[section_attribute('weapon', id, 'weapon_speed')] = int(v[section_attribute('weapon', id, 'weaponspeed')]);
          if (doUpdate(v[section_attribute('weapon', id, 'cost')])) output[section_attribute('weapon', id, 'weapon_cost')] = float(v[section_attribute('weapon', id, 'cost')]);
          if (doUpdate(v[section_attribute('weapon', id, 'weaponnotes')]))
            output[section_attribute('weapon', id, 'weapon_notes')] = v[section_attribute('weapon', id, 'weaponnotes')];
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: weaponNameFix completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  const spellNameFix = (current_version, final_version) => {
    getSectionIDs('repeating_spells', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('spells', id, 'roll'));
        fields.push(section_attribute('spells', id, 'memorized'));
        fields.push(section_attribute('spells', id, 'level'));
        fields.push(section_attribute('spells', id, 'name'));
        fields.push(section_attribute('spells', id, 'school'));
        fields.push(section_attribute('spells', id, 'range'));
        fields.push(section_attribute('spells', id, 'duration'));
        fields.push(section_attribute('spells', id, 'aoe'));
        fields.push(section_attribute('spells', id, 'components'));
        fields.push(section_attribute('spells', id, 'ct'));
        fields.push(section_attribute('spells', id, 'save'));
        fields.push(section_attribute('spells', id, 'macro-text'));
        fields.push(section_attribute('spells', id, 'description'));
        fields.push(section_attribute('spells', id, 'description-show'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const namesToFix = {
          '@{memorized}': '@{spell_memorized}',
          '@{level}': '@{spell_level}',
          '@{name}': '@{spell_name}',
          '@{school}': '@{spell_school}',
          '@{range}': '@{spell_range}',
          '@{duration}': '@{spell_duration}',
          '@{aoe}': '@{spell_aoe}',
          '@{components}': '@{spell_components}',
          '@{ct}': '@{spell_ct}',
          '@{save}': '@{spell_save}',
          '@{macro-text}': '@{spell_macro_text}',
          '@{description}': '@{spell_description}',
        };
        const oldMacrotext =
          '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{name}}} {{Level:=@{level}}} {{Range:=@{range}}} {{Duration:=@{duration}}} {{AOE:=@{aoe}}} {{Comp:=@{components}}} {{CT:=@{ct}}} {{Save:=@{save}}} {{freetext=@{description}}}';
        _.each(idArray, (id) => {
          if (doUpdate(v[section_attribute('spells', id, 'roll')])) output[section_attribute('spells', id, 'spell_roll')] = v[section_attribute('spells', id, 'roll')];
          if (doUpdate(v[section_attribute('spells', id, 'memorized')]))
            output[section_attribute('spells', id, 'spell_memorized')] = int(v[section_attribute('spells', id, 'memorized')]);
          if (doUpdate(v[section_attribute('spells', id, 'level')])) output[section_attribute('spells', id, 'spell_level')] = v[section_attribute('spells', id, 'level')];
          if (doUpdate(v[section_attribute('spells', id, 'name')])) output[section_attribute('spells', id, 'spell_name')] = v[section_attribute('spells', id, 'name')];
          if (doUpdate(v[section_attribute('spells', id, 'school')])) output[section_attribute('spells', id, 'spell_school')] = v[section_attribute('spells', id, 'school')];
          if (doUpdate(v[section_attribute('spells', id, 'range')])) output[section_attribute('spells', id, 'spell_range')] = v[section_attribute('spells', id, 'range')];
          if (doUpdate(v[section_attribute('spells', id, 'duration')])) output[section_attribute('spells', id, 'spell_duration')] = v[section_attribute('spells', id, 'duration')];
          if (doUpdate(v[section_attribute('spells', id, 'aoe')])) output[section_attribute('spells', id, 'spell_aoe')] = v[section_attribute('spells', id, 'aoe')];
          if (doUpdate(v[section_attribute('spells', id, 'components')]))
            output[section_attribute('spells', id, 'spell_components')] = v[section_attribute('spells', id, 'components')];
          if (doUpdate(v[section_attribute('spells', id, 'ct')])) output[section_attribute('spells', id, 'spell_ct')] = v[section_attribute('spells', id, 'ct')];
          if (doUpdate(v[section_attribute('spells', id, 'save')])) output[section_attribute('spells', id, 'spell_save')] = v[section_attribute('spells', id, 'save')];
          if (doUpdate(v[section_attribute('spells', id, 'macro-text')], oldMacrotext))
            output[section_attribute('spells', id, 'spell_macro_text')] = replaceSet(v[section_attribute('spells', id, 'macro-text')], namesToFix);
          if (doUpdate(v[section_attribute('spells', id, 'description')]))
            output[section_attribute('spells', id, 'spell_description')] = v[section_attribute('spells', id, 'description')];
          if (doUpdate(v[section_attribute('spells', id, 'description-show')]))
            output[section_attribute('spells', id, 'spell_description_show')] = int(v[section_attribute('spells', id, 'description-show')]);
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: spellNameFix completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  const equipmentNameFix = (current_version, final_version) => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'item-show'));
        fields.push(section_attribute('equipment', id, 'item'));
        fields.push(section_attribute('equipment', id, 'location'));
        fields.push(section_attribute('equipment', id, 'carried'));
        fields.push(section_attribute('equipment', id, 'quantity'));
        fields.push(section_attribute('equipment', id, 'quantity_max'));
        fields.push(section_attribute('equipment', id, 'weight'));
        fields.push(section_attribute('equipment', id, 'cos'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        _.each(idArray, (id) => {
          if (doUpdate(v[section_attribute('equipment', id, 'item-show')]))
            output[section_attribute('equipment', id, 'equipment_item_show')] = v[section_attribute('equipment', id, 'item-show')];
          if (doUpdate(v[section_attribute('equipment', id, 'item')])) output[section_attribute('equipment', id, 'equipment_item')] = v[section_attribute('equipment', id, 'item')];
          if (doUpdate(v[section_attribute('equipment', id, 'location')]))
            output[section_attribute('equipment', id, 'equipment_location')] = v[section_attribute('equipment', id, 'location')];
          if (doUpdate(v[section_attribute('equipment', id, 'carried')]))
            output[section_attribute('equipment', id, 'equipment_carried')] = v[section_attribute('equipment', id, 'carried')];
          if (doUpdate(v[section_attribute('equipment', id, 'quantity')]))
            output[section_attribute('equipment', id, 'equipment_quantity')] = float(v[section_attribute('equipment', id, 'quantity')]);
          if (doUpdate(v[section_attribute('equipment', id, 'quantity_max')]))
            output[section_attribute('equipment', id, 'equipment_quantity_max')] = float(v[section_attribute('equipment', id, 'quantity_max')]);
          if (doUpdate(v[section_attribute('equipment', id, 'weight')]))
            output[section_attribute('equipment', id, 'equipment_weight')] = float(v[section_attribute('equipment', id, 'weight')]);
          if (doUpdate(v[section_attribute('equipment', id, 'cost')]))
            output[section_attribute('equipment', id, 'equipment_cost')] = float(v[section_attribute('equipment', id, 'cost')]);
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: equipmentNameFix completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  const abilityNameFix = (current_version, final_version) => {
    getSectionIDs('repeating_ability', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'roll'));
        fields.push(section_attribute('equipment', id, 'name'));
        fields.push(section_attribute('equipment', id, 'short_description'));
        fields.push(section_attribute('equipment', id, 'current'));
        fields.push(section_attribute('equipment', id, 'current_max'));
        fields.push(section_attribute('equipment', id, 'macro-text'));
        fields.push(section_attribute('equipment', id, 'description'));
        fields.push(section_attribute('equipment', id, 'description-show'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const namesToFix = {
          '@{name}': '@{ability_name}',
          '@{current}': '@{ability_current}',
          '@{current_max}': '@{ability_current_max}',
          '@{short_description}': '@{ability_short_description}',
          '@{macro-text}': '@{ability_macro_text}',
          '@{description}': '@{ability_description}',
        };
        const oldMacrotext =
          '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{name}}} {{freetext=@{short_description} @{description}}}';
        _.each(idArray, (id) => {
          if (doUpdate(v[section_attribute('equipment', id, 'roll')])) output[section_attribute('equipment', id, 'ability_roll')] = v[section_attribute('equipment', id, 'roll')];
          if (doUpdate(v[section_attribute('equipment', id, 'name')])) output[section_attribute('equipment', id, 'ability_name')] = v[section_attribute('equipment', id, 'name')];
          if (doUpdate(v[section_attribute('equipment', id, 'short_description')]))
            output[section_attribute('equipment', id, 'ability_short_description')] = v[section_attribute('equipment', id, 'short_description')];
          if (doUpdate(v[section_attribute('equipment', id, 'current')]))
            output[section_attribute('equipment', id, 'ability_current')] = int(v[section_attribute('equipment', id, 'current')]);
          if (doUpdate(v[section_attribute('equipment', id, 'current_max')]))
            output[section_attribute('equipment', id, 'ability_current_max')] = int(v[section_attribute('equipment', id, 'current_max')]);
          if (doUpdate(v[section_attribute('equipment', id, 'macro-text')], oldMacrotext))
            output[section_attribute('equipment', id, 'ability_macro_text')] = replaceSet(v[section_attribute('equipment', id, 'macro-text')], namesToFix);
          if (doUpdate(v[section_attribute('equipment', id, 'description')]))
            output[section_attribute('equipment', id, 'ability_description')] = v[section_attribute('equipment', id, 'description')];
          if (doUpdate(v[section_attribute('equipment', id, 'description-show')]))
            output[section_attribute('equipment', id, 'ability_description_show')] = int(v[section_attribute('equipment', id, 'description-show')]);
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: abilityNameFix completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // fix duplicated repeating attribute names. Replaces old attribute names in macro_text
  const nwpNameFix = (current_version, final_version) => {
    getSectionIDs('repeating_nonweaponproficiencies', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('nonweaponproficiencies', id, 'roll'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'name'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'rAttribute'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'short_description'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'rSlots'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'rModifier'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'macro-text'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'description-show'));
        fields.push(section_attribute('nonweaponproficiencies', id, 'description'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const namesToFix = {
          '@{name}': '@{nwp_name}',
          '@{rAttribute}': '@{nwp_attribute}',
          '@{rSlots}': '@{nwp_slots}',
          '@{rModifier}': '@{nwp_modifier}',
          '@{short_description}': '@{nwp_short_description}',
          '@{macro-text}': '@{nwp_macro_text}',
          '@{description}': '@{nwp_description}',
        };
        const oldMacrotext =
          '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{Proficiency Check=[[ 1d20 + [[@{rmodifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{rAttribute}[ATTR] ]]}}{{freetext=@{short_description}}}';
        _.each(idArray, (id) => {
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'roll')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_roll')] = v[section_attribute('nonweaponproficiencies', id, 'roll')];
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'name')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_name')] = v[section_attribute('nonweaponproficiencies', id, 'name')];
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'rAttribute')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_attribute')] = v[section_attribute('nonweaponproficiencies', id, 'rAttribute')].toLowerCase();
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'short_description')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_short_description')] = v[section_attribute('nonweaponproficiencies', id, 'short_description')];
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'rSlots')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_slots')] = int(v[section_attribute('nonweaponproficiencies', id, 'rSlots')]);
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'rModifier')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_modifier')] = int(v[section_attribute('nonweaponproficiencies', id, 'rModifier')]);
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'macro-text')], oldMacrotext))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] = replaceSet(v[section_attribute('nonweaponproficiencies', id, 'macro-text')], namesToFix);
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'description-show')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_description_show')] = int(v[section_attribute('nonweaponproficiencies', id, 'description-show')]);
          if (doUpdate(v[section_attribute('nonweaponproficiencies', id, 'description')]))
            output[section_attribute('nonweaponproficiencies', id, 'nwp_description')] = v[section_attribute('nonweaponproficiencies', id, 'description')];
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: nwpNameFix completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // add {{color=@{color}}} to all repeating macro-text
  const macroColorUpdate = (current_version, final_version) => {
    const output = {};
    getSectionIDs('repeating_nonweaponproficiencies', (idnwps) => {
      getSectionIDs('repeating_weapon', (idweapons) => {
        getSectionIDs('repeating_ability', (idabilities) => {
          getSectionIDs('repeating_spells', (idspells) => {
            const attrsNWP = [];
            const attrsWeapon = [];
            const attrsAbility = [];
            const attrsSpells = [];
            _.each(idnwps, (id) => {
              attrsNWP.push(section_attribute('nonweaponproficiencies', id, 'nwp_macro_text'));
            });
            _.each(idweapons, (id) => {
              attrsWeapon.push(section_attribute('weapon', id, 'weapon_macro_text'));
            });
            _.each(idabilities, (id) => {
              attrsAbility.push(section_attribute('ability', id, 'ability_macro_text'));
            });
            _.each(idspells, (id) => {
              attrsSpells.push(section_attribute('spells', id, 'spell_macro_text'));
            });
            getAttrs([...attrsNWP, ...attrsWeapon, ...attrsAbility, ...attrsSpells], (v) => {
              const replacements = {
                nwp_old: '&{template:general} {{name=@{character_name}}}',
                nwp_new: '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}',
                wpn_old: '&{template:attacks} {{name=@{character_name}}}',
                wpn_new: '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}}',
                abl_old: '&{template:general} {{name=@{character_name}}}',
                abl_new: '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}',
                spl_old: '&{template:general} {{name=@{character_name}}}',
                spl_new: '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}',
              };
              _.each(idnwps, (id) => {
                if (v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')]) {
                  output[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] = v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')].replace(
                    replacements.nwp_old,
                    replacements.nwp_new
                  );
                  clog(`VERSION UPDATE: colorUpdate completed`);
                }
              });
              _.each(idweapons, (id) => {
                if (v[section_attribute('weapon', id, 'weapon_macro_text')]) {
                  output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
                    replacements.wpn_old,
                    replacements.wpn_new
                  );
                  clog(`VERSION UPDATE: colorUpdate completed`);
                }
              });
              _.each(idabilities, (id) => {
                if (v[section_attribute('ability', id, 'ability_macro_text')]) {
                  output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
                    replacements.abl_old,
                    replacements.abl_new
                  );
                  clog(`VERSION UPDATE: colorUpdate completed`);
                }
              });
              _.each(idspells, (id) => {
                if (v[section_attribute('spells', id, 'spell_macro_text')]) {
                  output[section_attribute('spells', id, 'spell_macro_text')] = v[section_attribute('spells', id, 'spell_macro_text')].replace(
                    replacements.spl_old,
                    replacements.spl_new
                  );
                  clog(`VERSION UPDATE: colorUpdate completed`);
                }
              });
              output.sheet_version = current_version;
              setAttrs(output, {silent: true}, versionator(current_version, final_version));
            });
          });
        });
      });
    });
  };

  // One-time update: Auto Calc Ability rows
  const stat_functions = () => {
    strengthCalcs();
    intelligenceCalcs();
    wisdomCalcs();
    dexterityCalcs();
    constitutionCalcs();
    charismaCalcs();
  };

  autoCalcAbilityRows = (current_version, final_version) => {
    const output = {};
    stat_functions();
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: autoCalcAbilityRows completed`);
    setAttrs(output, versionator(current_version, final_version));
  };

  // One-time update: Auto Calc Save rows
  autoCalcSaveRows = (current_version, final_version) => {
    const output = {};
    const migrate = 1;
    saveparalysispoisondeathCalc(migrate);
    savepetrificationpolymorphCalc(migrate);
    saverodsstaveswandsCalc(migrate);
    savebreathweaponsCalc(migrate);
    savespellsCalc(migrate);
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: autoCalcSaveRows(migrate) completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // One-time update: Auto Calc Thief rows
  autoCalcThiefRows = (current_version, final_version) => {
    const output = {};
    const migrate = 1;
    pickpocketsCalc(migrate);
    openlocksCalc(migrate);
    findtrapsCalc(migrate);
    movequietlyCalc(migrate);
    hideinshadowsCalc(migrate);
    hearnoiseCalc(migrate);
    climbwallsCalc(migrate);
    readlanguagesCalc(migrate);
    thiefmiscCalc();
    thiefmisc1Calc();
    thiefmisc2Calc();
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: autoCalcThiefRows(migrate) completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // Remove @{weapon_whisper_to_hit}
  const removeWhisper = (current_version, final_version) => {
    // remove all instances of @{weapon_whisper_to_hit} in macro-text
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const macrodefault =
          '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}} @{weapon_whisper_to_hit}';
        _.each(idArray, (id) => {
          const macrotext = v[section_attribute('weapon', id, 'weapon_macro_text')] || macrodefault;
          output[section_attribute('weapon', id, 'weapon_macro_text')] = macrotext.replace(/} @{weapon_whisper_to_hit}/g, '}');
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: removeWhisper completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // migrate HP
  const migrateHP = (current_version, final_version) => {
    // clog('HP migrated');
    getAttrs(['hitpoints_max', 'hitpoints_1_class', 'hitpoints_2_class', 'hitpoints_3_class'], (v) => {
      const output = {};
      const hitPointsMax = +v.hitpoints_max || 0;
      const hitpoints_1_class = +v.hitpoints_1_class || 0;
      const hitpoints_2_class = +v.hitpoints_2_class || 0;
      const hitpoints_3_class = +v.hitpoints_3_class || 0;
      const totalClassHP = int(Math.max(0, hitpoints_1_class) + Math.max(0, hitpoints_2_class) + Math.max(0, hitpoints_3_class));
      // older sheet will not have hp per class
      if (totalClassHP === 0 && hitPointsMax > 0) {
        output.hitpoints_1_class = hitPointsMax;
      }
      output.sheet_version = current_version;
      clog(`VERSION UPDATE: migrate HP completed`);
      setAttrs(output, {silent: true}, versionator(current_version, final_version), calcHP());
    });
  };

  // migrate AC
  const migrateAC = (current_version, final_version) => {
    getAttrs(['armorclass', 'armortype_ac', 'armorclass_total', 'armorbonus', 'armorshield'], (v) => {
      const output = {};
      const recalc = 0;
      let armorClass = +v.armorclass || 0;
      const armorBonus = -Math.abs(v.armorbonus) || 0;
      const armorClassTotal = +v.armorclass_total || 0;
      const armortypeAC = +v.armortype_ac || 0;
      const armorShield = v.armorshield;
      clog(`armorShield:${armorShield} armorClassTotal:${armorClassTotal} armorBonus:${armorBonus} armortypeAC:${armortypeAC} armorClass:${armorClass}`);
      // older sheet will have default value for armortypeAC and armorClassTotal.  AC s/b better than 10
      if (armorShield) {
        if (armortypeAC === 10 && armorClass < 10) {
          armorClass += 1;
          output.armortype_ac = armorClass;
          output.armortype_base = armorClass;
          output.armortype_worn = 1;
          output.armortype_carried = 1;
          output.armorshield_ac = -1;
          output.armorshield_base = -1;
          output.armorshield_worn = 1;
          output.armorshield_carried = 1;
          clog(`new armor w/shield`);
        }
      } else if (armortypeAC === 10 && armorClass < 10) {
        output.armortype_ac = armorClass;
        output.armortype_base = armorClass;
        output.armortype_worn = 1;
        output.armortype_carried = 1;
        clog(`new armor w/out shield`);
      } else {
        clog(`NEW ARMOR CHECK AND SET FAILED`);
      }
      output.sheet_version = current_version;
      clog(`VERSION UPDATE: Migrate AC completed`);
      setAttrs(output, {silent: true}, versionator(current_version, final_version), calcAC(recalc));
    });
  };

  // update Weapon macro-text ONLY IF they haven't been edited.
  // Tests against previous macro-text changes back to v1.58
  const weaponMacroUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const replacements = {
          weapon_old:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}}',
          weapon_old_v2:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD]) ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}}',
          weapon_old_v3:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} @{weapon_tohitacadj}',
          weapon_old_v4:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{crit=@{toggle_critdamage}}} @{weapon_tohitacadj}',
          weapon_old_v5:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=@{toggle_critdamage}}} @{weapon_tohitacadj}',
          weapon_old_v6:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=[[ @{toggle_critdamage} ]]}} @{weapon_tohitacadj}',
          weapon_current:
            '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + ( @{weapon_backstab_bonus}[BACKSTAB] ) + ( @{weapon_tohitbonus}[HIT_BON] ) + ( @{weapon_prof_pen}[PROF_PEN] ) + ( @{weapon_dual_pen}[DUAL_PEN] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{To Hit Modifier?|0}[MISC_MOD] ) ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=[[ @{toggle_critdamage} ]]}} @{weapon_tohitacadj}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old_v6) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old_v6,
              replacements.weapon_current
            );
          } else if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old_v5) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old_v5,
              replacements.weapon_current
            );
          } else if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old_v4) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old_v4,
              replacements.weapon_current
            );
          } else if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old_v3) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old_v3,
              replacements.weapon_current
            );
          } else if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old_v2) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old_v2,
              replacements.weapon_current
            );
          } else if (v[section_attribute('weapon', id, 'weapon_macro_text')] === replacements.weapon_old) {
            output[section_attribute('weapon', id, 'weapon_macro_text')] = v[section_attribute('weapon', id, 'weapon_macro_text')].replace(
              replacements.weapon_old,
              replacements.weapon_current
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: weaponMacroUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // update Special Ability macro-text ONLY IF they haven't been edited. Tests against v1.58 macro-text
  const abilityMacroUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_ability', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('ability', id, 'ability_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const replacements = {
          ability_old:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{freetext=@{ability_short_description} @{ability_description}}}',
          ability_old_v2:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=@{ability_current|max}}}',
          ability_old_v3:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}',
          ability_old_v4:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}',
          ability_old_v5:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{link=@{ability_link}}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[@{ability_current|max}]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}',
          ability_current:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ 0 + @{ability_die} + @{ability_mod}[MOD] ]]}} {{link=@{ability_link}}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ 0 + @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('ability', id, 'ability_macro_text')] === replacements.ability_old_v5) {
            output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
              replacements.ability_old_v5,
              replacements.ability_current
            );
          }
          if (v[section_attribute('ability', id, 'ability_macro_text')] === replacements.ability_old_v4) {
            output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
              replacements.ability_old_v4,
              replacements.ability_current
            );
          }
          if (v[section_attribute('ability', id, 'ability_macro_text')] === replacements.ability_old_v3) {
            output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
              replacements.ability_old_v3,
              replacements.ability_current
            );
          }
          if (v[section_attribute('ability', id, 'ability_macro_text')] === replacements.ability_old_v2) {
            output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
              replacements.ability_old_v2,
              replacements.ability_current
            );
          }
          if (v[section_attribute('ability', id, 'ability_macro_text')] === replacements.ability_old) {
            output[section_attribute('ability', id, 'ability_macro_text')] = v[section_attribute('ability', id, 'ability_macro_text')].replace(
              replacements.ability_old,
              replacements.ability_current
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: abilityMacroUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // update NWP macro-text ONLY IF they haven't been edited. Tests against v1.58 macro-text
  const nwpMacroUpdate2 = (current_version, final_version) => {
    getSectionIDs('repeating_nonweaponproficiencies', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('nonweaponproficiencies', id, 'nwp_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const replacements = {
          nwp_old:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{Proficiency Check=[[ 1d20 + [[@{nwp_modifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{nwp_attribute}[ATTR] ]]}}{{freetext=@{nwp_short_description}}}',
          nwp_old_v2:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{roll_low=[[ 1d20 + [[ @{nwp_modifier} ]][MOD] + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[ @{nwp_attribute}[ATTR] ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{NWP Mod Applied=[[ @{nwp_modifier} ]]}} {{freetext=@{nwp_short_description}}}',
          nwp_current:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{roll_low=[[ 1d20 + [[ @{nwp_modifier} ]][MOD] + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[ @{nwp_attribute}[ATTR] ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{nwp_mod_applied=[[ @{nwp_modifier} ]]}} {{link=@{nwp_link}}} {{freetext=@{nwp_short_description} @{nwp_description}}}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] === replacements.nwp_old_2) {
            output[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] = v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')].replace(
              replacements.nwp_old_2,
              replacements.nwp_current
            );
          }
          if (v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] === replacements.nwp_old) {
            output[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')] = v[section_attribute('nonweaponproficiencies', id, 'nwp_macro_text')].replace(
              replacements.nwp_old,
              replacements.nwp_current
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: nwpMacroUpdate2 completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // update Spells macro-text ONLY IF they haven't been edited. Tests against v1.58 macro-text
  const spellsMacroUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_spells', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('spells', id, 'spell_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const replacements = {
          spell_old:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{Level:=@{spell_level}}} {{Range:=@{spell_range}}} {{Duration:=@{spell_duration}}} {{AOE:=@{spell_aoe}}} {{Comp:=@{spell_components}}} {{CT:=@{spell_ct}}} {{Save:=@{spell_save}}} {{freetext=@{spell_description}}}',
          spell_old_v2:
            '&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{Range:=@{spell_range}}} {{Duration:=@{spell_duration}}} {{AOE:=@{spell_aoe}}} {{Save:=@{spell_save}}}',
          spell_old_v3:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{school=@{spell_school}}} {{spell_level=@{spell_level}}} {{range=@{spell_range}}} {{duration=@{spell_duration}}} {{area_of_effect=@{spell_aoe}}} {{components=@{spell_components}}} {{casting_time=@{spell_ct}}} {{saving_throw=@{spell_save}}} {{freetext=@{spell_description}}}',
          spell_current:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{school=@{spell_school}}} {{spell_level=@{spell_level}}} {{spell_class=@{spell_caster_class_name}}} {{spell_class_level=@{spell_caster_class_level}}} {{range=@{spell_range}}} {{duration=@{spell_duration}}} {{area_of_effect=@{spell_aoe}}} {{components=@{spell_components}}} {{casting_time=@{spell_ct}}} {{saving_throw=@{spell_save}}} {{save_type=@{spell_save_type}}} {{link=@{spell_link}}} {{freetext=@{spell_description}}}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('spells', id, 'spell_macro_text')] === replacements.spell_old_v3) {
            output[section_attribute('spells', id, 'spell_macro_text')] = v[section_attribute('spells', id, 'spell_macro_text')].replace(
              replacements.spell_old_v3,
              replacements.spell_current
            );
          }
          if (v[section_attribute('spells', id, 'spell_macro_text')] === replacements.spell_old_v2) {
            output[section_attribute('spells', id, 'spell_macro_text')] = v[section_attribute('spells', id, 'spell_macro_text')].replace(
              replacements.spell_old_v2,
              replacements.spell_current
            );
          }
          if (v[section_attribute('spells', id, 'spell_macro_text')] === replacements.spell_old) {
            output[section_attribute('spells', id, 'spell_macro_text')] = v[section_attribute('spells', id, 'spell_macro_text')].replace(
              replacements.spell_old,
              replacements.spell_current
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: spellsMacroUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // update Equipment macro-text ONLY IF they haven't been edited. Tests against v1.641 macro-text
  const equipmentMacroUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const replacements = {
          equipment_old:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Item/Equipment: @{equipment_item}}} {{freetext=@{equipment_description}}} {{quantity= @{equipment_quantity}}} {{quantity_max=@{equipment_quantity|max}}} {{uses=@{equipment_current}}} {{uses_max=[[ @{equipment_current|max} ]]}}',
          equipment_current:
            '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Item/Equipment: @{equipment_item}}} {{link=@{equipment_link}}} {{freetext=@{equipment_description}}} {{quantity=@{equipment_quantity}}} {{quantity_max=@{equipment_quantity|max}}} {{uses=@{equipment_current}}} {{uses_max=[[ @{equipment_current|max} ]]}}',
        };
        _.each(idArray, (id) => {
          if (v[section_attribute('equipment', id, 'equipment_macro_text')] === replacements.equipment_old) {
            output[section_attribute('equipment', id, 'equipment_macro_text')] = v[section_attribute('equipment', id, 'equipment_macro_text')].replace(
              replacements.equipment_old,
              replacements.equipment_current
            );
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: equipmentMacroUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // One-time update: formats and sets range fields
  const updateRange = (current_version, final_version) => {
    getSectionIDs('repeating_weapon', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_range'));
        fields.push(section_attribute('weapon', id, 'weapon_range_short'));
        fields.push(section_attribute('weapon', id, 'weapon_range_medium'));
        fields.push(section_attribute('weapon', id, 'weapon_range_long'));
        fields.push(section_attribute('weapon', id, 'weapon_attack_type'));
        fields.push(section_attribute('weapon', id, 'weapon_range_error'));
      });
      getAttrs(fields, (v) => {
        _.each(idArray, (id) => {
          // attack types selector: melee=0, ranged=1, touch=2, ranged_touch=3
          const thisType = +v[section_attribute('weapon', id, 'weapon_attack_type')] || 0;
          if (thisType === 0 || thisType === 2) return;
          let thisRange = v[section_attribute('weapon', id, 'weapon_range')];
          // remove quotes to prevent NaN (ie distance indicators)
          thisRange = thisRange.replace(/'/g, '');
          thisRange = thisRange.replace(/"/g, '');
          // parse ranges
          const thisRangeArray = thisRange.split('/').join(',').split(' ').join(',').split('-').join(',').split(',');
          // clog(`thisRangeArray: ${thisRangeArray}`);
          const thisRangeShort = Number(thisRangeArray[0]);
          let thisRangeMedium = Number(thisRangeArray[1]);
          let thisRangeLong = Number(thisRangeArray[2]);

          // clog(`Attack is Ranged. repeating_weapon_weapon_attack_type = ${thisType}`);

          // if only a single number is entered, make it Long ie Manticore spikes
          if (thisRangeArray.length === 1 && thisRangeShort >= 0 && !thisRangeMedium && !thisRangeLong) {
            thisRangeMedium = thisRangeShort;
            thisRangeLong = thisRangeShort;
          }
          // clog(`thisRangeShort: ${thisRangeShort} |thisRangeMedium: ${thisRangeMedium} |thisRangeLong: ${thisRangeLong}`);

          // check to see if range is in the proper format.
          if (Number.isNaN(thisRangeShort)) {
            output[section_attribute('weapon', id, 'weapon_range_short')] = 0;
            output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
            // clog(`WARNING: Field is not in the proper format.`);
          } else {
            output[section_attribute('weapon', id, 'weapon_range_short')] = thisRangeShort;
          }
          if (Number.isNaN(thisRangeMedium)) {
            output[section_attribute('weapon', id, 'weapon_range_medium')] = 0;
            output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
            // clog(`WARNING: Field is not in the proper format.`);
          } else {
            output[section_attribute('weapon', id, 'weapon_range_medium')] = thisRangeMedium;
          }
          if (Number.isNaN(thisRangeLong)) {
            output[section_attribute('weapon', id, 'weapon_range_long')] = 0;
            output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
            // clog(`WARNING: Field is not in the proper format.`);
          } else {
            output[section_attribute('weapon', id, 'weapon_range_long')] = thisRangeLong;
          }
          if (!Number.isNaN(thisRangeShort) && !Number.isNaN(thisRangeMedium) && !Number.isNaN(thisRangeLong)) {
            output[section_attribute('weapon', id, 'weapon_range_error')] = 1;
          } else {
            // clog(`Value did not parse.`);
          }
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: updateRange completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // One-time update: replace @{weapon_attack_type_pen} with @{weapon_dual_pen} in attack macro-text
  const updateAttackTypeMacro = (current_version, final_version) => {
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_macro_text'));
      });
      getAttrs([...fields], (v) => {
        const output = {};
        const macrodefault =
          '&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} @{weapon_tohitacadj}';
        _.each(idArray, (id) => {
          const macrotext = v[section_attribute('weapon', id, 'weapon_macro_text')] || macrodefault;
          output[section_attribute('weapon', id, 'weapon_macro_text')] = macrotext.replace(/@{weapon_attack_type_pen}/g, '@{weapon_dual_pen}');
          output[section_attribute('weapon', id, 'weapon_macro_text')] = macrotext.replace(/{{attacktype=@{weapon_attack_type}}} /g, '');
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: updateAttackTypeMacro completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // One-time update: set MonsterHD from hitdice
  const monsterHD = (current_version, final_version) => {
    getAttrs(['hitdice', 'monsterHD'], (v) => {
      const output = {};
      const monsterHD_value = v.monsterHD;
      const hitDice_value = v.hitdice;
      if (monsterHD_value === '') {
        output.monsterHD = hitDice_value;
      }
      output.monsterHD = monsterHD_value;
      output.sheet_version = current_version;
      clog(`VERSION UPDATE: monsterHD completed`);
      setAttrs(output, {silent: true}, versionator(current_version, final_version));
    });
  };

  // One-time update: clear old armor details fields that have been removed
  const clearArmorOther = (current_version, final_version) => {
    const output = {};
    output.armorother_cost = 0;
    output.armorother2_cost = 0;
    output.armorother3_cost = 0;
    output.armorother4_cost = 0;
    output.armorother5_cost = 0;
    output.armorother6_cost = 0;
    output.armorother_weight = 0;
    output.armorother2_weight = 0;
    output.armorother3_weight = 0;
    output.armorother4_weight = 0;
    output.armorother5_weight = 0;
    output.armorother6_weight = 0;
    output.armorother_carried = 0;
    output.armorother2_carried = 0;
    output.armorother3_carried = 0;
    output.armorother4_carried = 0;
    output.armorother5_carried = 0;
    output.armorother6_carried = 0;
    output.armorother_bulk = 0;
    output.armorother2_bulk = 0;
    output.armorother3_bulk = 0;
    output.armorother4_bulk = 0;
    output.armorother5_bulk = 0;
    output.armorother6_bulk = 0;
    clog(`VERSION UPDATE: clearArmorOther completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // combines 2 arrays so that the row_id attr is ONLY used with copyArmorToEquipment()
  const armorIDsAndAttrs = armorAttrs.concat(armorRowIDs);
  // sync armor
  function syncArmorToEquipment(id, attr, row_removed, migrate) {
    getAttrs(armorIDsAndAttrs, (v) => {
      const output = {};
      let newID = '';
      let id_low = id;
      id_low = id_low !== null ? id.toLowerCase() : id_low;
      // clog(`syncArmorToEquipment id:${id_low}  attr:${attr}  row_removed:${row_removed}`);
      const unarmored0_ID = v.unarmored_row_id.toString();
      const armortype1_ID = v.armortype1_row_id.toString();
      const armortype2_ID = v.armortype2_row_id.toString();
      const armorshield_ID = v.armorshield_row_id.toString();
      const armorhelmet_ID = v.armorhelmet_row_id.toString();
      const armorother1_ID = v.armorother1_row_id.toString();
      const armorother2_ID = v.armorother2_row_id.toString();
      const armorother3_ID = v.armorother3_row_id.toString();
      const armorother4_ID = v.armorother4_row_id.toString();
      const armorother5_ID = v.armorother5_row_id.toString();
      const armorother6_ID = v.armorother6_row_id.toString();
      const idArray = [
        unarmored0_ID,
        armortype1_ID,
        armortype2_ID,
        armorshield_ID,
        armorhelmet_ID,
        armorother1_ID,
        armorother2_ID,
        armorother3_ID,
        armorother4_ID,
        armorother5_ID,
        armorother6_ID,
      ].map((str) => (str ? str.toString().toLowerCase() : '0'));
      // clog(`syncArmorToEquipment idArray: [${idArray}]`);
      // use arrays to determine what row to create/update/reset
      const unarmoredAttrs = ['unarmored_worn', 'unarmored', 'unarmored_ac', 'unarmored_base', 'unarmored_bulk', 'unarmored_carried', 'unarmored_weight', 'unarmored_cost'];
      const armor1Attrs = ['armortype_worn', 'armortype', 'armortype_ac', 'armortype_base', 'armortype_magic', 'armortype_bulk', 'armortype_carried', 'armor_weight', 'armor_cost'];
      const armor2Attrs = [
        'armortype2_worn',
        'armortype2',
        'armortype2_ac',
        'armortype2_base',
        'armortype2_magic',
        'armortype2_bulk',
        'armortype2_carried',
        'armortype2_weight',
        'armortype2_cost',
      ];
      const shieldAttrs = [
        'armorshield_worn',
        'armorshield',
        'armorshield_ac',
        'armorshield_base',
        'armorshield_magic',
        'armorshield_mod',
        'armorshield_bulk',
        'armorshield_carried',
        'armorshield_weight',
        'armorshield_cost',
      ];
      const helmetAttrs = [
        'armorhelmet_worn',
        'armorhelmet',
        'armorhelmet_ac',
        'armorhelmet_magic',
        'armorhelmet_bulk',
        'armorhelmet_carried',
        'armorhelmet_weight',
        'armorhelmet_cost',
      ];
      const other1Attrs = ['armorother_worn', 'armorother', 'armorother_ac', 'armorother_base', 'armorother_magic', 'armorother_mod'];
      const other2Attrs = ['armorother2_worn', 'armorother2', 'armorother2_ac', 'armorother2_base', 'armorother2_magic', 'armorother2_mod'];
      const other3Attrs = ['armorother3_worn', 'armorother3', 'armorother3_ac', 'armorother3_base', 'armorother3_magic', 'armorother3_mod'];
      const other4Attrs = ['armorother4_worn', 'armorother4', 'armorother4_ac', 'armorother4_base', 'armorother4_magic', 'armorother4_mod'];
      const other5Attrs = ['armorother5_worn', 'armorother5', 'armorother5_ac', 'armorother5_base', 'armorother5_magic', 'armorother5_mod'];
      const other6Attrs = ['armorother6_worn', 'armorother6', 'armorother6_ac', 'armorother6_base', 'armorother6_magic', 'armorother6_mod'];
      function matchAttr(attribute) {
        const arrays = {unarmoredAttrs, armor1Attrs, armor2Attrs, shieldAttrs, helmetAttrs, other1Attrs, other2Attrs, other3Attrs, other4Attrs, other5Attrs, other6Attrs};
        const matchingArray = Object.entries(arrays).find(([arrayName, array]) => array.includes(attribute));
        return matchingArray ? matchingArray[0] : null; // Return the array name or null if no match is found
      }
      const attrToCheck = attr;
      const matchingArray = matchAttr(attrToCheck);
      if (matchingArray) {
        // console.log(`Match found in array: ${matchingArray}`);
      } else {
        // console.log(`No match found for attribute: ${attrToCheck}`);
      }
      const armor0 = v.unarmored;
      const armor1 = v.armortype;
      const armor2 = v.armortype2;
      const shield = v.armorshield;
      const helmet = v.armorhelmet;
      const other1 = v.armorother;
      const other2 = v.armorother2;
      const other3 = v.armorother3;
      const other4 = v.armorother4;
      const other5 = v.armorother5;
      const other6 = v.armorother6;
      // match the row
      if (matchingArray === 'unarmoredAttrs' || id_low === idArray[0] || migrate) {
        if (matchingArray === 'unarmoredAttrs' || migrate) {
          if (armor0) {
            if (unarmored0_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = unarmored0_ID.toLowerCase();
              output.unarmored_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 0;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.unarmored_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.unarmored;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.unarmored_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.unarmored_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.unarmored_bulk || 0;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.unarmored_worn === 1 && +v.unarmored_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.unarmored_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.unarmored_carried || 0;
              }
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.unarmored_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.unarmored_cost || 0;
              // clog(`repeating Armor exists armor1:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.unarmored_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 0;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.unarmored_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.unarmored;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.unarmored_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.unarmored_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.unarmored_bulk || 0;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.unarmored_worn === 1 && +v.unarmored_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.unarmored_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.unarmored_carried || 0;
              }
              // output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.unarmored_carried || 0;
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.unarmored_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.unarmored_cost || 0;
              // clog(`repeating armor does not exist. Creating armor1: ${newID}`);
            }
          } else if (unarmored0_ID === idArray[0]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.unarmored_row_id = 0;
            output.unarmored_worn = +v.unarmored_worn || 0;
            output.unarmored = '';
            output.unarmored_ac = +v.unarmored_ac || 0;
            output.unarmored_base = +v.unarmored_base || 0;
            output.unarmored_bulk = +v.unarmored_bulk || 0;
            output.unarmored_weight = +v.unarmored_weight || 0;
            output.unarmored_cost = +v.unarmored_cost || 0;
            // armor in use ie 'worn', should always be considered as carried
            if (+v.unarmored_worn === 1 && +v.unarmored_carried === 0) {
              output.unarmored_carried = 1;
            } else {
              output.unarmored_carried = +v.unarmored_carried || 0;
            }
            // clog(`rep_removed:${row_removed} - ID Exists. Deleted from Armor Detail unarmored:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.unarmored_row_id = 0;
          output.unarmored_worn = 1;
          output.unarmored = '';
          output.unarmored_ac = 10;
          output.unarmored_base = 10;
          output.unarmored_bulk = 0;
          output.unarmored_weight = 0;
          output.unarmored_cost = 0;
          output.unarmored_carried = 1;
          // clog(`rep_removed:${row_removed} - NO ID. Deleted from Equipment unarmored:${newID}`);
        }
      }
      if (matchingArray === 'armor1Attrs' || id_low === idArray[1] || migrate) {
        if (matchingArray === 'armor1Attrs' || migrate) {
          if (armor1) {
            if (armortype1_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armortype1_ID.toLowerCase();
              output.armortype1_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 1;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armortype;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype_bulk || 0;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.armortype_worn === 1 && +v.armortype_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.armortype_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype_carried || 0;
              }
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armor_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armor_cost || 0;
              // clog(`repeating Armor exists armor1:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armortype1_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 1;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armortype;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype_bulk || 0;
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype_carried || 0;
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armor_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armor_cost || 0;
              // clog(`repeating armor does not exist. Creating armor1: ${newID}`);
            }
          } else if (armortype1_ID === idArray[1]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armortype1_row_id = 0;
            output.armortype_worn = 0;
            output.armortype = '';
            output.armortype_ac = 10;
            output.armortype_base = 10;
            output.armortype_magic = 0;
            output.armortype_bulk = 0;
            output.armortype_weight = 0;
            output.armortype_cost = 0;
            output.armortype_carried = 1;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset armor1:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armortype1_row_id = 0;
          output.armortype_worn = 0;
          output.armortype = '';
          output.armortype_ac = 10;
          output.armortype_base = 10;
          output.armortype_magic = 0;
          output.armortype_bulk = 0;
          output.armortype_weight = 0;
          output.armortype_cost = 0;
          output.armortype_carried = 1;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset armor1:${newID}`);
        }
      }
      if (matchingArray === 'armor2Attrs' || id_low === idArray[2] || migrate) {
        if (matchingArray === 'armor2Attrs' || migrate) {
          if (armor2) {
            if (armortype2_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armortype2_ID.toLowerCase();
              output.armortype2_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype2_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armortype2;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype2_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype2_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype2_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype2_bulk || 0;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.armortype2_worn === 1 && +v.armortype2_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.armortype2_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype2_carried || 0;
              }
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armortype2_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armortype2_cost || 0;
              // clog(`repeating Armor exists armor2:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armortype2_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype2_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armortype2;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype2_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype2_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype2_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype2_bulk || 0;
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype2_carried || 0;
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armortype2_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armortype2_cost || 0;
              // clog(`repeating armor does not exist. Creating armor2: ${newID}`);
            }
          } else if (armortype2_ID === idArray[2]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armortype2_row_id = 0;
            output.armortype2_worn = 0;
            output.armortype2 = '';
            output.armortype2_ac = 10;
            output.armortype2_base = 10;
            output.armortype2_magic = 0;
            output.armortype2_bulk = 0;
            output.armortype2_weight = 0;
            output.armortype2_cost = 0;
            output.armortype2_carried = 1;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset armor2:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armortype2_row_id = 0;
          output.armortype2_worn = 0;
          output.armortype2 = '';
          output.armortype2_ac = 10;
          output.armortype2_base = 10;
          output.armortype2_magic = 0;
          output.armortype2_bulk = 0;
          output.armortype2_weight = 0;
          output.armortype2_cost = 0;
          output.armortype2_carried = 1;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset armor2:${newID}`);
        }
      }
      if (matchingArray === 'shieldAttrs' || id_low === idArray[3] || migrate) {
        if (matchingArray === 'shieldAttrs' || migrate) {
          if (shield) {
            if (armorshield_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorshield_ID.toLowerCase();
              output.armorshield_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 3;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorshield_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorshield;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorshield_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorshield_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = v.armorshield_magic;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = v.armorshield_mod;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armorshield_bulk || 0;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.armorshield_worn === 1 && +v.armorshield_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.armorshield_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorshield_carried || 0;
              }
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorshield_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorshield_cost || 0;
              // clog(`repeating Armor exists shield:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorshield_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 3;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorshield_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorshield;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorshield_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorshield_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = v.armorshield_magic;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = v.armorshield_mod;
              output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armorshield_bulk || 0;
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorshield_carried || 0;
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorshield_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorshield_cost || 0;
              // clog(`repeating armor does not exist. Creating shield: ${newID}`);
            }
          } else if (armorshield_ID === idArray[3]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorshield_row_id = 0;
            output.armorshield_worn = 0;
            output.armorshield = '';
            output.armorshield_ac = 0;
            output.armorshield_base = 0;
            output.armorshield_magic = 0;
            output.armorshield_mod = 0;
            output.armorshield_bulk = 0;
            output.armorshield_weight = 0;
            output.armorshield_cost = 0;
            output.armorshield_carried = 1;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset shield:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorshield_row_id = 0;
          output.armorshield_worn = 0;
          output.armorshield = '';
          output.armorshield_ac = 0;
          output.armorshield_base = 0;
          output.armorshield_magic = 0;
          output.armorshield_mod = 0;
          output.armorshield_bulk = 0;
          output.armorshield_weight = 0;
          output.armorshield_cost = 0;
          output.armorshield_carried = 1;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset shield:${newID}`);
        }
      }
      if (matchingArray === 'helmetAttrs' || id_low === idArray[4] || migrate) {
        if (matchingArray === 'helmetAttrs' || migrate) {
          if (helmet) {
            if (armorhelmet_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorhelmet_ID.toLowerCase();
              output.armorhelmet_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 4;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorhelmet_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorhelmet;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorhelmet_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = v.armorhelmet_magic;
              // armor in use ie 'worn', should always be considered as carried
              if (+v.armorhelmet_worn === 1 && +v.armorhelmet_carried === 0) {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
                output.armorhelmet_carried = 1;
              } else {
                output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorhelmet_carried || 0;
              }
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorhelmet_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorhelmet_cost || 0;
              // clog(`repeating Armor exists helmet:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorhelmet_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 4;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorhelmet_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorhelmet;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorhelmet_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = v.armorhelmet_magic;
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorhelmet_carried || 0;
              output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorhelmet_weight || 0;
              output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorhelmet_cost || 0;
              // clog(`repeating armor does not exist. Creating helmet: ${newID}`);
            }
          } else if (armorhelmet_ID === idArray[4]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorhelmet_row_id = 0;
            output.armorhelmet_worn = 0;
            output.armorhelmet = '';
            output.armorhelmet_ac = 10;
            output.armorhelmet_base = 10;
            output.armorhelmet_magic = 0;
            output.armorhelmet_bulk = 0;
            output.armorhelmet_weight = 0;
            output.armorhelmet_cost = 0;
            output.armorhelmet_carried = 1;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset helmet:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorhelmet_row_id = 0;
          output.armorhelmet_worn = 0;
          output.armorhelmet = '';
          output.armorhelmet_ac = 10;
          output.armorhelmet_base = 10;
          output.armorhelmet_magic = 0;
          output.armorhelmet_bulk = 0;
          output.armorhelmet_weight = 0;
          output.armorhelmet_cost = 0;
          output.armorhelmet_carried = 1;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset helmet:${newID}`);
        }
      }
      if (matchingArray === 'other1Attrs' || id_low === idArray[5] || migrate) {
        if (matchingArray === 'other1Attrs' || migrate) {
          if (other1) {
            if (armorother1_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother1_ID.toLowerCase();
              output.armorother1_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 5;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother_worn === 1 ? 1 : 0;
              // clog(`repeating Armor exists other1:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother1_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 5;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother_mod || 0;
              // clog(`repeating armor does not exist. Creating other1: ${newID}`);
            }
          } else if (armorother1_ID === idArray[5]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother1_row_id = 0;
            output.armorother_worn = 0;
            output.armorother = '';
            output.armorother_ac = 10;
            output.armorother_base = 10;
            output.armorother_magic = 0;
            output.armorother_mod = 0;
            output.armorother_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other1:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother1_row_id = 0;
          output.armorother_worn = 0;
          output.armorother = '';
          output.armorother_ac = 10;
          output.armorother_base = 10;
          output.armorother_magic = 0;
          output.armorother_mod = 0;
          output.armorother_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other1:${newID}`);
        }
      }
      if (matchingArray === 'other2Attrs' || id_low === idArray[6] || migrate) {
        if (matchingArray === 'other2Attrs' || migrate) {
          if (other2) {
            if (armorother2_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother2_ID.toLowerCase();
              output.armorother2_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 6;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother2_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother2;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother2_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother2_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother2_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother2_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother2_worn === 1 ? 1 : 0;
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother2_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 6;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother2_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother2;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother2_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother2_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother2_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother2_mod || 0;
              // clog(`repeating armor does not exist. Creating other2: ${newID}`);
            }
          } else if (armorother2_ID === idArray[6]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother2_row_id = 0;
            output.armorother2_worn = 0;
            output.armorother2 = '';
            output.armorother2_ac = 0;
            output.armorother2_base = 0;
            output.armorother2_magic = 0;
            output.armorother2_mod = 0;
            output.armorother2_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other2:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother2_row_id = 0;
          output.armorother2_worn = 0;
          output.armorother2 = '';
          output.armorother2_ac = 0;
          output.armorother2_base = 0;
          output.armorother2_magic = 0;
          output.armorother2_mod = 0;
          output.armorother2_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other2:${newID}`);
        }
      }
      if (matchingArray === 'other3Attrs' || id_low === idArray[7] || migrate) {
        if (matchingArray === 'other3Attrs' || migrate) {
          if (other3) {
            if (armorother3_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother3_ID.toLowerCase();
              output.armorother3_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 7;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother3_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother3;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother3_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother3_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother3_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother3_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother3_worn === 1 ? 1 : 0;
              // clog(`repeating Armor exists other3:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother3_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 7;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother3_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother3;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother3_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother3_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother3_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother3_mod || 0;
              // clog(`repeating armor does not exist. Creating other3: ${newID}`);
            }
          } else if (armorother3_ID === idArray[7]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother3_row_id = 0;
            output.armorother3_worn = 0;
            output.armorother3 = '';
            output.armorother3_ac = 0;
            output.armorother3_base = 0;
            output.armorother3_magic = 0;
            output.armorother3_mod = 0;
            output.armorother3_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other3:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother3_row_id = 0;
          output.armorother3_worn = 0;
          output.armorother3 = '';
          output.armorother3_ac = 0;
          output.armorother3_base = 0;
          output.armorother3_magic = 0;
          output.armorother3_mod = 0;
          output.armorother3_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other3:${newID}`);
        }
      }
      if (matchingArray === 'other4Attrs' || id_low === idArray[8] || migrate) {
        if (matchingArray === 'other4Attrs' || migrate) {
          if (other4) {
            if (armorother4_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother4_ID.toLowerCase();
              output.armorother4_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 8;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother4_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother4;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother4_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother4_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother4_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother4_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother4_worn === 1 ? 1 : 0;
              // clog(`repeating Armor exists other4:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother4_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 8;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother4_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother4;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother4_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother4_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother4_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother4_mod || 0;
              // clog(`repeating armor does not exist. Creating other4: ${newID}`);
            }
          } else if (armorother4_ID === idArray[8]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother4_row_id = 0;
            output.armorother4_worn = 0;
            output.armorother4 = '';
            output.armorother4_ac = 0;
            output.armorother4_base = 0;
            output.armorother4_magic = 0;
            output.armorother4_mod = 0;
            output.armorother4_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other4:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother4_row_id = 0;
          output.armorother4_worn = 0;
          output.armorother4 = '';
          output.armorother4_ac = 0;
          output.armorother4_base = 0;
          output.armorother4_magic = 0;
          output.armorother4_mod = 0;
          output.armorother4_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other4:${newID}`);
        }
      }
      if (matchingArray === 'other5Attrs' || id_low === idArray[9] || migrate) {
        if (matchingArray === 'other5Attrs' || migrate) {
          if (other5) {
            if (armorother5_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother5_ID.toLowerCase();
              output.armorother5_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 9;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother5_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother5;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother5_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother5_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother5_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother5_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother5_worn === 1 ? 1 : 0;
              // clog(`repeating Armor exists other5:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother5_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 9;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother5_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother5;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother5_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother5_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother5_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother5_mod || 0;
              // clog(`repeating armor does not exist. Creating other5: ${newID}`);
            }
          } else if (armorother5_ID === idArray[9]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother5_row_id = 0;
            output.armorother5_worn = 0;
            output.armorother5 = '';
            output.armorother5_ac = 0;
            output.armorother5_base = 0;
            output.armorother5_magic = 0;
            output.armorother5_mod = 0;
            output.armorother5_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other5:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother5_row_id = 0;
          output.armorother5_worn = 0;
          output.armorother5 = '';
          output.armorother5_ac = 0;
          output.armorother5_base = 0;
          output.armorother5_magic = 0;
          output.armorother5_mod = 0;
          output.armorother5_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other5:${newID}`);
        }
      }
      if (matchingArray === 'other6Attrs' || id_low === idArray[10] || migrate) {
        if (matchingArray === 'other6Attrs' || migrate) {
          if (other6) {
            if (armorother6_ID.length === 20) {
              // has name && has id = UPDATE ROW
              newID = armorother6_ID.toLowerCase();
              output.armorother6_row_id = newID;
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 10;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother6_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother6;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother6_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother6_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother6_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother6_mod || 0;
              // armor in use ie 'worn', should always be considered as carried
              output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorother6_worn === 1 ? 1 : 0;
              // clog(`repeating Armor exists other6:${newID}`);
            } else {
              // has name but NO id = CREATE NEW ROW
              newID = generateUniqueRowID();
              output.armorother6_row_id = newID.toLowerCase();
              output[`repeating_equipment_${newID}_equipment_type`] = 2;
              output[`repeating_equipment_${newID}_equipment_armor_type`] = 10;
              output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother6_worn || 0;
              output[`repeating_equipment_${newID}_equipment_item`] = v.armorother6;
              output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother6_ac || 0;
              output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother6_base || 0;
              output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother6_magic || 0;
              output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother6_mod || 0;
              // clog(`repeating armor does not exist. Creating other6: ${newID}`);
            }
          } else if (armorother6_ID === idArray[10]) {
            // no name but id exists: armor detail row REMOVED RESETING ROW
            output.armorother6_row_id = 0;
            output.armorother6_worn = 0;
            output.armorother6 = '';
            output.armorother6_ac = 0;
            output.armorother6_base = 0;
            output.armorother6_magic = 0;
            output.armorother6_mod = 0;
            output.armorother6_bulk = 0;
            // clog(`rep_removed:${row_removed} - Armor Details row has been reset other6:${newID}`);
          }
        } else {
          // null means repeating_row removed: has Name and id = REMOVED RESET ROW
          output.armorother6_row_id = 0;
          output.armorother6_worn = 0;
          output.armorother6 = '';
          output.armorother6_ac = 0;
          output.armorother6_base = 0;
          output.armorother6_magic = 0;
          output.armorother6_mod = 0;
          output.armorother6_bulk = 0;
          // clog(`rep_removed:${row_removed} - Armor Details row has been reset other6:${newID}`);
        }
      }
      setAttrs(output, armorDetailsRowidArray(), calcAC());
    });
  }

  // One-time update:  migrate Armor Details to repeating_equipment
  const migrateArmorDetails = (current_version, final_version) => {
    const output = {};
    const row_removed = 0;
    const migrate = 1;
    syncArmorToEquipment(null, null, row_removed, migrate);
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: migrateArmorDetails completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // One-time update: sets all equipment default values
  const setEquipmentUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_type'));
        fields.push(section_attribute('equipment', id, 'equipment_current'));
        fields.push(section_attribute('equipment', id, 'equipment_current_max'));
        fields.push(section_attribute('equipment', id, 'equipment_carried_select'));
        fields.push(section_attribute('equipment', id, 'equipment_carried'));
        fields.push(section_attribute('equipment', id, 'equipment_quantity'));
        fields.push(section_attribute('equipment', id, 'equipment_quantity_max'));
        fields.push(section_attribute('equipment', id, 'equipment_weight'));
        fields.push(section_attribute('equipment', id, 'equipment_cost'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_type'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_worn'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_ac'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_base'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_magic'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_mod'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_bulk'));
        fields.push(section_attribute('equipment', id, 'equipment_macro_text'));
      });
      getAttrs(fields, (v) => {
        _.each(idArray, (id) => {
          output[section_attribute('equipment', id, 'equipment_type')] = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
          output[section_attribute('equipment', id, 'equipment_current')] = +v[section_attribute('equipment', id, 'equipment_current')] || 0;
          output[section_attribute('equipment', id, 'equipment_current_max')] = +v[section_attribute('equipment', id, 'equipment_current_max')] || 0;
          output[section_attribute('equipment', id, 'equipment_carried_select')] = +v[section_attribute('equipment', id, 'equipment_carried')] || 0; // setting to carried to preserve existing value
          output[section_attribute('equipment', id, 'equipment_carried')] = +v[section_attribute('equipment', id, 'equipment_carried')] || 0;
          output[section_attribute('equipment', id, 'equipment_quantity')] = +v[section_attribute('equipment', id, 'equipment_quantity')] || 0;
          output[section_attribute('equipment', id, 'equipment_quantity_max')] = +v[section_attribute('equipment', id, 'equipment_quantity_max')] || 0;
          output[section_attribute('equipment', id, 'equipment_weight')] = +v[section_attribute('equipment', id, 'equipment_weight')] || 0;
          output[section_attribute('equipment', id, 'equipment_cost')] = +v[section_attribute('equipment', id, 'equipment_cost')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_type')] = +v[section_attribute('equipment', id, 'equipment_armor_type')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_worn')] = +v[section_attribute('equipment', id, 'equipment_armor_worn')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_ac')] = +v[section_attribute('equipment', id, 'equipment_armor_ac')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_base')] = +v[section_attribute('equipment', id, 'equipment_armor_base')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_magic')] = +v[section_attribute('equipment', id, 'equipment_armor_magic')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_mod')] = +v[section_attribute('equipment', id, 'equipment_armor_mod')] || 0;
          output[section_attribute('equipment', id, 'equipment_armor_bulk')] = +v[section_attribute('equipment', id, 'equipment_armor_bulk')] || 0;
          output[section_attribute('equipment', id, 'equipment_macro_text')] = v[section_attribute('equipment', id, 'equipment_macro_text')];
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: setEquipmentUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // One-time update: sets all weapons default values
  const setWeaponsUpdate = (current_version, final_version) => {
    getSectionIDs('repeating_weapon', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_attack_type'));
        fields.push(section_attribute('weapon', id, 'weapon_dual'));
        fields.push(section_attribute('weapon', id, 'weapon_whisper_to_hit'));
        fields.push(section_attribute('weapon', id, 'weapon_whisper_to_hit_select'));
        fields.push(section_attribute('weapon', id, 'weapon_dual_pen'));
        fields.push(section_attribute('weapon', id, 'weapon_backstab_var'));
        fields.push(section_attribute('weapon', id, 'weapon_tohitbonus'));
        fields.push(section_attribute('weapon', id, 'weapon_magicbonus'));
        fields.push(section_attribute('weapon', id, 'weapon_prof'));
        fields.push(section_attribute('weapon', id, 'weapon_backstab'));
        fields.push(section_attribute('weapon', id, 'weapon_backstab_bonus'));
        fields.push(section_attribute('weapon', id, 'weapon_backstab_mult'));
        fields.push(section_attribute('weapon', id, 'weapon_attackdmgbonus'));
        fields.push(section_attribute('weapon', id, 'weapon_num_attacks'));
        fields.push(section_attribute('weapon', id, 'weapon_quantity'));
        fields.push(section_attribute('weapon', id, 'weapon_ammo'));
        fields.push(section_attribute('weapon', id, 'weapon_ammo_max'));
        fields.push(section_attribute('weapon', id, 'weapon_weight'));
        fields.push(section_attribute('weapon', id, 'weapon_cost'));
        fields.push(section_attribute('weapon', id, 'weapon_range_short'));
        fields.push(section_attribute('weapon', id, 'weapon_range_medium'));
        fields.push(section_attribute('weapon', id, 'weapon_range_long'));
        fields.push(section_attribute('weapon', id, 'weapon_length'));
        fields.push(section_attribute('weapon', id, 'weapon_space'));
        fields.push(section_attribute('weapon', id, 'weapon_speed'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj0'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj1'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj2'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj3'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj4'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj5'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj6'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj7'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj8'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj9'));
        fields.push(section_attribute('weapon', id, 'weapon_thac_adj10'));
        fields.push(section_attribute('weapon', id, 'weapon_macro_text'));
        fields.push(section_attribute('weapon', id, 'weapon_damagesmallmedium_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_damagelarge_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_damagesmallmedium_npc_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_damagelarge_npc_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_critdamagesmallmedium_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_critdamagelarge_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_critdamagesmallmedium_npc_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_critdamagelarge_npc_chat_menu'));
        fields.push(section_attribute('weapon', id, 'weapon_damage_chat_menu_npc'));
      });
      getAttrs(fields, (v) => {
        _.each(idArray, (id) => {
          output[`repeating_weapon_${id}_weapon_attack_type`] = +v[section_attribute('weapon', id, 'weapon_attack_type')] || 0;
          output[`repeating_weapon_${id}_weapon_dual`] = v[section_attribute('weapon', id, 'weapon_dual')];
          output[`repeating_weapon_${id}_weapon_whisper_to_hit`] = v[section_attribute('weapon', id, 'weapon_whisper_to_hit')];
          output[`repeating_weapon_${id}_weapon_whisper_to_hit_select`] = +v[section_attribute('weapon', id, 'weapon_whisper_to_hit_select')] || 0;
          output[`repeating_weapon_${id}_weapon_dual_pen`] = +v[section_attribute('weapon', id, 'weapon_dual_pen')] || 0;
          output[`repeating_weapon_${id}_weapon_backstab_var`] = +v[section_attribute('weapon', id, 'weapon_backstab_var')] || 0;
          output[`repeating_weapon_${id}_weapon_tohitbonus`] = +v[section_attribute('weapon', id, 'weapon_tohitbonus')] || 0;
          output[`repeating_weapon_${id}_weapon_magicbonus`] = +v[section_attribute('weapon', id, 'weapon_magicbonus')] || 0;
          output[`repeating_weapon_${id}_weapon_prof`] = +v[section_attribute('weapon', id, 'weapon_prof')] || 0;
          output[`repeating_weapon_${id}_weapon_backstab`] = +v[section_attribute('weapon', id, 'weapon_backstab')] || 0;
          output[`repeating_weapon_${id}_weapon_backstab_bonus`] = +v[section_attribute('weapon', id, 'weapon_backstab_bonus')] || 0;
          output[`repeating_weapon_${id}_weapon_backstab_mult`] = +v[section_attribute('weapon', id, 'weapon_backstab_mult')] || 0;
          output[`repeating_weapon_${id}_weapon_attackdmgbonus`] = +v[section_attribute('weapon', id, 'weapon_attackdmgbonus')] || 0;
          output[`repeating_weapon_${id}_weapon_num_attacks`] = +v[section_attribute('weapon', id, 'weapon_num_attacks')] || 0;
          output[`repeating_weapon_${id}_weapon_quantity`] = +v[section_attribute('weapon', id, 'weapon_quantity')] || 0;
          output[`repeating_weapon_${id}_weapon_ammo`] = +v[section_attribute('weapon', id, 'weapon_ammo')] || 0;
          output[`repeating_weapon_${id}_weapon_ammo_max`] = +v[section_attribute('weapon', id, 'weapon_ammo_max')] || 0;
          output[`repeating_weapon_${id}_weapon_weight`] = +v[section_attribute('weapon', id, 'weapon_weight')] || 0;
          output[`repeating_weapon_${id}_weapon_cost`] = +v[section_attribute('weapon', id, 'weapon_cost')] || 0;
          output[`repeating_weapon_${id}_weapon_range_short`] = +v[section_attribute('weapon', id, 'weapon_range_short')] || 0;
          output[`repeating_weapon_${id}_weapon_range_medium`] = +v[section_attribute('weapon', id, 'weapon_range_medium')] || 0;
          output[`repeating_weapon_${id}_weapon_range_long`] = +v[section_attribute('weapon', id, 'weapon_range_long')] || 0;
          output[`repeating_weapon_${id}_weapon_length`] = v[section_attribute('weapon', id, 'weapon_length')];
          output[`repeating_weapon_${id}_weapon_space`] = v[section_attribute('weapon', id, 'weapon_space')];
          output[`repeating_weapon_${id}_weapon_speed`] = v[section_attribute('weapon', id, 'weapon_speed')];
          output[`repeating_weapon_${id}_weapon_thac_adj0`] = +v[section_attribute('weapon', id, 'weapon_thac_adj0')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj1`] = +v[section_attribute('weapon', id, 'weapon_thac_adj1')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj2`] = +v[section_attribute('weapon', id, 'weapon_thac_adj2')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj3`] = +v[section_attribute('weapon', id, 'weapon_thac_adj3')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj4`] = +v[section_attribute('weapon', id, 'weapon_thac_adj4')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj5`] = +v[section_attribute('weapon', id, 'weapon_thac_adj5')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj6`] = +v[section_attribute('weapon', id, 'weapon_thac_adj6')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj7`] = +v[section_attribute('weapon', id, 'weapon_thac_adj7')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj8`] = +v[section_attribute('weapon', id, 'weapon_thac_adj8')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj9`] = +v[section_attribute('weapon', id, 'weapon_thac_adj9')] || 0;
          output[`repeating_weapon_${id}_weapon_thac_adj10`] = +v[section_attribute('weapon', id, 'weapon_thac_adj10')] || 0;
          output[`repeating_weapon_${id}_weapon_macro_text`] = v[section_attribute('weapon', id, 'weapon_macro_text')];
          output[`repeating_weapon_${id}_weapon_damagesmallmedium_chat_menu`] = v[section_attribute('weapon', id, 'weapon_damagesmallmedium_chat_menu')];
          output[`repeating_weapon_${id}_weapon_damagelarge_chat_menu`] = v[section_attribute('weapon', id, 'weapon_damagelarge_chat_menu')];
          output[`repeating_weapon_${id}_weapon_damagesmallmedium_npc_chat_menu`] = v[section_attribute('weapon', id, 'weapon_damagesmallmedium_npc_chat_menu')];
          output[`repeating_weapon_${id}_weapon_damagelarge_npc_chat_menu`] = v[section_attribute('weapon', id, 'weapon_damagelarge_npc_chat_menu')];
          output[`repeating_weapon_${id}_weapon_critdamagesmallmedium_chat_menu`] = v[section_attribute('weapon', id, 'weapon_critdamagesmallmedium_chat_menu')];
          output[`repeating_weapon_${id}_weapon_critdamagelarge_chat_menu`] = v[section_attribute('weapon', id, 'weapon_critdamagelarge_chat_menu')];
          output[`repeating_weapon_${id}_weapon_critdamagesmallmedium_npc_chat_menu`] = v[section_attribute('weapon', id, 'weapon_critdamagesmallmedium_npc_chat_menu')];
          output[`repeating_weapon_${id}_weapon_critdamagelarge_npc_chat_menu`] = v[section_attribute('weapon', id, 'weapon_critdamagelarge_npc_chat_menu')];
          output[`repeating_weapon_${id}_weapon_damage_chat_menu_npc`] = v[section_attribute('weapon', id, 'weapon_damage_chat_menu_npc')];
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: setWeaponsUpdate completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  // One-time update: migrate Weapon weight and cost to repeating_equipment
  const clearWeaponsWeightCost = () => {
    // clear old weapon weight and cost values
    getSectionIDs('repeating_weapon', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_quantity'));
        fields.push(section_attribute('weapon', id, 'weapon_weight'));
        fields.push(section_attribute('weapon', id, 'weapon_cost'));
      });
      getAttrs(fields, (v) => {
        _.each(idArray, (id) => {
          output[section_attribute('weapon', id, 'weapon_quantity')] = +v[section_attribute('weapon', id, 'weapon_quantity')] || 0;
          output[section_attribute('weapon', id, 'weapon_weight')] = 0;
          output[section_attribute('weapon', id, 'weapon_cost')] = 0;
          // clog(`CLEARED OLD WEAPON WEIGHT AND COST`);
        });
        setAttrs(output);
      });
    });
  };

  const migrateWeaponWtCostFunction = () => {
    getSectionIDs('repeating_weapon', (weaponsArray) => {
      getSectionIDs('repeating_equipment', (equipmentArray) => {
        const output = {};
        const weaponFields = [];
        const equipmentFields = [];
        const fields = [...weaponFields, ...equipmentFields];
        _.each(weaponsArray, (id) => {
          fields.push(section_attribute('weapon', id, 'weapon_name'));
          fields.push(section_attribute('weapon', id, 'weapon_quantity'));
          fields.push(section_attribute('weapon', id, 'weapon_weight'));
          fields.push(section_attribute('weapon', id, 'weapon_cost'));
        });
        _.each(equipmentArray, (idEquip) => {
          fields.push(section_attribute('equipment', idEquip, 'equipment_item'));
          fields.push(section_attribute('equipment', idEquip, 'equipment_quantity'));
          fields.push(section_attribute('equipment', idEquip, 'equipment_weight'));
          fields.push(section_attribute('equipment', idEquip, 'equipment_cost'));
        });
        getAttrs(fields, (v) => {
          const equipmentNamesArray = [];
          const equipmentWeightsArray = [];
          const equipmentCostsArray = [];
          const equipmentIdsArray = [];
          let newID = '';
          _.each(weaponsArray, (id) => {
            const weaponName = v[section_attribute('weapon', id, 'weapon_name')];
            const weaponQuantity = v[section_attribute('weapon', id, 'weapon_quantity')];
            const weaponWeight = v[section_attribute('weapon', id, 'weapon_weight')];
            const weaponCost = v[section_attribute('weapon', id, 'weapon_cost')];
            _.each(equipmentArray, (idEquip) => {
              const equipmentId = idEquip;
              equipmentIdsArray.push(equipmentId);
              const equipmentName = v[section_attribute('equipment', idEquip, 'equipment_item')];
              equipmentNamesArray.push(equipmentName);
              const equipmentWeight = v[section_attribute('equipment', idEquip, 'equipment_weight')];
              equipmentWeightsArray.push(equipmentWeight);
              const equipmentCost = v[section_attribute('equipment', idEquip, 'equipment_cost')];
              equipmentCostsArray.push(equipmentCost);
            });
            // weapon weight, cost, or both are being tracked on the weapon row
            if (weaponWeight !== 0 || weaponCost !== 0) {
              clog(`weaponName:${weaponName} weaponWeight:${weaponWeight} weaponCost:${weaponCost}`);
              // test weapon name against equipment names
              const nameIndex = equipmentNamesArray.indexOf(weaponName);
              if (nameIndex === -1) {
                clog(`NO MATCH || COPY TO NEW ROW ||`);
                // create a new row
                newID = generateUniqueRowID();
                output[`repeating_equipment_${newID}_equipment_type`] = 1;
                output[`repeating_equipment_${newID}_equipment_item`] = weaponName;
                output[`repeating_equipment_${newID}_equipment_quantity`] = weaponQuantity;
                output[`repeating_equipment_${newID}_equipment_quantity_max`] = weaponQuantity;
                output[`repeating_equipment_${newID}_equipment_weight`] = weaponWeight;
                output[`repeating_equipment_${newID}_equipment_cost`] = weaponCost;
              } else if (equipmentWeightsArray[nameIndex] === '0' && equipmentCostsArray[nameIndex] === '0') {
                // weight & cost are being tracked on weapons
                clog(
                  `MATCH w/weight & cost tracked on weapons. || UPDATE ROW || name:${weaponName} weight:${equipmentWeightsArray[nameIndex]} cost:${equipmentCostsArray[nameIndex]} at index:${nameIndex} id:${equipmentIdsArray[nameIndex]}`
                );
                // update existing row
                newID = equipmentIdsArray[nameIndex];
                output[`repeating_equipment_${newID}_equipment_type`] = 1;
                output[`repeating_equipment_${newID}_equipment_quantity`] = weaponQuantity;
                output[`repeating_equipment_${newID}_equipment_quantity_max`] = weaponQuantity;
                output[`repeating_equipment_${newID}_equipment_weight`] = weaponWeight;
                output[`repeating_equipment_${newID}_equipment_cost`] = weaponCost;
              } else if (equipmentWeightsArray[nameIndex] !== '0' && equipmentCostsArray[nameIndex] === '0') {
                // weight is being tracked on equipment but costs are not
                clog(
                  `MATCH w/weight tracked on equipment. || UPDATE ROW || name:${weaponName} weight:${equipmentWeightsArray[nameIndex]} cost:${equipmentCostsArray[nameIndex]} at index:${nameIndex} id:${equipmentIdsArray[nameIndex]}`
                );
                // update existing row
                newID = equipmentIdsArray[nameIndex];
                output[`repeating_equipment_${newID}_equipment_type`] = 1;
                output[`repeating_equipment_${newID}_equipment_cost`] = weaponCost;
              } else if (equipmentWeightsArray[nameIndex] === '0' && equipmentCostsArray[nameIndex] !== '0') {
                // weight is not being tracked on equipment but costs are
                clog(
                  `MATCH w/cost tracked on equipment. || UPDATE ROW || name:${weaponName} weight:${equipmentWeightsArray[nameIndex]} cost:${equipmentCostsArray[nameIndex]} at index:${nameIndex} id:${equipmentIdsArray[nameIndex]}`
                );
                // update existing row
                newID = equipmentIdsArray[nameIndex];
                output[`repeating_equipment_${newID}_equipment_type`] = 1;
                output[`repeating_equipment_${newID}_equipment_weight`] = weaponWeight;
              } else if (equipmentWeightsArray[nameIndex] !== '0' && equipmentCostsArray[nameIndex] !== '0') {
                clog(
                  `100% MATCH weight & cost tracked on equipment. || IGNORE ROW || name:${weaponName} weight: ${equipmentWeightsArray[nameIndex]} cost:${equipmentCostsArray[nameIndex]} at index:${nameIndex}`
                );
              } else {
                // ignore
                clog(`No attribute data to migrate. || IGNORE ROW ||`);
              }
            }
          });
          // zero out weapon row weight and cost with clearWeaponsWeightCost()
          setAttrs(output, {silent: true}, clearWeaponsWeightCost());
        });
      });
    });
  };

  const migrateWeaponWtCost = (current_version, final_version) => {
    const output = {};
    migrateWeaponWtCostFunction();
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: migrateWeaponWtCost completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // One-time update:  checks and sets equipment-gear but the value was set out-of-range
  const setEquipmentType = (current_version, final_version) => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_type'));
      });
      getAttrs(fields, (v) => {
        _.each(idArray, (id) => {
          const equipType = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
          if (equipType >= 0) return;
          output[section_attribute('equipment', id, 'equipment_type')] = 0;
          clog(`equipType -1:${equipType} reset to Gear`);
        });
        output.sheet_version = current_version;
        clog(`VERSION UPDATE: setEquipmentType completed`);
        setAttrs(output, {silent: true}, versionator(current_version, final_version));
      });
    });
  };

  const migrateSetSpellsCasterClass = (current_version, final_version) => {
    const output = {};
    setSpellsCasterClass();
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: migrateSetSpellsCasterClass completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // One-time update: ensures warning flag is correct
  const recalcAC = (current_version, final_version) => {
    const output = {};
    const recalc = 0;
    calcAC(recalc);
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: recalcAC completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // One-time update: initiative macro subtitle fix
  const initMacroUpdate = (current_version, final_version) => {
    const output = {};
    output.init_macro_text = '';
    output.sheet_version = current_version;
    clog(`VERSION UPDATE: recalcAC completed`);
    setAttrs(output, {silent: true}, versionator(current_version, final_version));
  };

  // Check and set Ability defaults to 8 on new sheets
  const newSheet = () => {
    getAttrs(['hitdice', 'armorclass', 'strength', 'intelligence', 'wisdom', 'dexterity', 'constitution', 'charisma', 'old_character'], (v) => {
      const output = {};
      const testOldChar = +v.old_character || 0;
      if (testOldChar === 1) return;
      const testHitdice = +v.hitdice;
      const testAC = +v.armorclass || 0;
      const testStr = +v.strength || 0;
      const testInt = +v.intelligence || 0;
      const testWis = +v.wisdom || 0;
      const testDex = +v.dexterity || 0;
      const testCon = +v.constitution || 0;
      const testCha = +v.charisma || 0;
      // new sheets will have all abilities '10' by default
      // defaults will then be set to '8' default
      const testAbility = testStr + testInt + testWis + testDex + testCon + testCha;
      // clog(`~~~~~~ Average Ability detected: ${testAbility}, Hit Dice: ${testHitdice}, AC: ${testAC}`);
      if (testHitdice === 0 && testAC === 10 && testAbility === 60) {
        // clog(`~~~~~~ NEW SHEET DETECTED old_character:${testOldChar}, Ability Defaults set to "8".`);
        output.strength = testStr === 10 ? 8 : testStr;
        output.intelligence = testInt === 10 ? 8 : testInt;
        output.wisdom = testWis === 10 ? 8 : testWis;
        output.dexterity = testDex === 10 ? 8 : testDex;
        output.constitution = testCon === 10 ? 8 : testCon;
        output.charisma = testCha === 10 ? 8 : testCha;
        output.old_character = 1;
        stat_functions();
      } else {
        // clog(`~~~~~~ OLD SHEET DETECTED old_character:${testOldChar}`);
        output.old_character = 1;
      }
      setAttrs(output, {silent: true});
    });
  };

  // versioning routine to handle attribute changes
  versionator = (current_version, final_version) => {
    if (current_version < 0.1) {
      dmgSwap(0.1, final_version);
    } else if (current_version < 1.2) {
      maxSwap(1.2, final_version);
    } else if (current_version < 1.5) {
      nwpMacroUpdate(1.5, final_version);
    } else if (current_version < 1.52) {
      weaponNameFix(1.52, final_version);
    } else if (current_version < 1.53) {
      spellNameFix(1.53, final_version);
    } else if (current_version < 1.54) {
      equipmentNameFix(1.54, final_version);
    } else if (current_version < 1.55) {
      abilityNameFix(1.55, final_version);
    } else if (current_version < 1.56) {
      nwpNameFix(1.56, final_version);
    } else if (current_version < 1.57) {
      macroColorUpdate(1.57, final_version);
      //-------------------------------------------
      //
      // 1E REVISED SHEET IS ANY UPDATE > v1.58
      //
      //-------------------------------------------
    } else if (current_version < 1.591) {
      autoCalcAbilityRows(1.591, final_version);
    } else if (current_version < 1.592) {
      autoCalcSaveRows(1.592, final_version);
    } else if (current_version < 1.593) {
      autoCalcThiefRows(1.593, final_version);
    } else if (current_version < 1.594) {
      removeWhisper(1.594, final_version);
    } else if (current_version < 1.595) {
      weaponMacroUpdate(1.595, final_version);
    } else if (current_version < 1.596) {
      abilityMacroUpdate(1.596, final_version);
    } else if (current_version < 1.597) {
      nwpMacroUpdate2(1.597, final_version);
    } else if (current_version < 1.598) {
      spellsMacroUpdate(1.598, final_version);
    } else if (current_version < 1.61) {
      updateRange(1.61, final_version);
    } else if (current_version < 1.62) {
      updateAttackTypeMacro(1.62, final_version);
    } else if (current_version < 1.634) {
      weaponMacroUpdate(1.634, final_version);
    } else if (current_version < 1.635) {
      migrateHP(1.635, final_version);
    } else if (current_version < 1.636) {
      migrateAC(1.636, final_version);
    } else if (current_version < 1.637) {
      weaponMacroUpdate(1.637, final_version);
    } else if (current_version < 1.638) {
      monsterHD(1.638, final_version);
    } else if (current_version < 1.639) {
      clearArmorOther(1.639, final_version);
    } else if (current_version < 1.64) {
      migrateArmorDetails(1.641, final_version);
    } else if (current_version < 1.642) {
      equipmentMacroUpdate(1.643, final_version);
    } else if (current_version < 1.644) {
      setEquipmentUpdate(1.644, final_version);
    } else if (current_version < 1.645) {
      setWeaponsUpdate(1.645, final_version);
    } else if (current_version < 1.646) {
      migrateWeaponWtCost(1.646, final_version);
    } else if (current_version < 1.648) {
      setEquipmentType(1.648, final_version);
    } else if (current_version < 1.65) {
      migrateSetSpellsCasterClass(1.65, final_version);
    } else if (current_version < 1.652) {
      abilityMacroUpdate(1.652, final_version);
    } else if (current_version < 1.654) {
      recalcAC(1.654, final_version);
    } else if (current_version < 1.656) {
      initMacroUpdate(1.656, final_version);
      // all updates completed
    } else if (current_version < final_version) {
      setAttrs({
        sheet_version: final_version,
      });
    } else if (current_version === final_version) {
      // check if new sheet and set abilities
      newSheet();
    }
  };
  // Versioning
  on('sheet:opened', () => {
    // SET LATEST VERSION HERE. needs to be => the last update made in versionator
    const final_version = 1.657;
    getAttrs(['sheet_version', 'old_character'], (v) => {
      const output = {};
      let current_version = float(v.sheet_version);
      // prevent new sheets from stepping through versionator
      if (+v.old_character === 0 && current_version === 0) {
        // clog(`New Sheet:${v.old_character}`);
        current_version = final_version;
        output.sheet_version = final_version;
        setAttrs(output, {silent: true});
      }
      clog(`Current sheet data version:${current_version}, Sheet code version:${final_version}`);
      versionator(current_version, final_version);
    });
  });

  // Exceptional
  on('change:abilities_info_show change:toggle_exceptional change:intelligence change:wisdom change:dexterity change:constitution change:charisma change:comeliness', (eventInfo) => {
    getAttrs(['intelligence', 'wisdom', 'dexterity', 'constitution', 'charisma', 'comeliness', 'toggle_exceptional'], (v) => {
      const output = {};
      const toggle_exceptional = +v.toggle_exceptional || 0;
      if (toggle_exceptional === 1) return;
      const intelligence = +v.intelligence || 0;
      const wisdom = +v.wisdom || 0;
      const dexterity = +v.dexterity || 0;
      const constitution = +v.constitution || 0;
      const charisma = +v.charisma || 0;
      const comeliness = +v.comeliness || 0;
      output.exceptional_intelligence_flag = intelligence >= 18 ? 1 : 0;
      output.exceptional_wisdom_flag = wisdom >= 18 ? 1 : 0;
      output.exceptional_dexterity_flag = dexterity >= 18 ? 1 : 0;
      output.exceptional_constitution_flag = constitution >= 18 ? 1 : 0;
      output.exceptional_charisma_flag = charisma >= 18 ? 1 : 0;
      output.exceptional_comeliness_flag = comeliness >= 18 ? 1 : 0;
      setAttrs(output, {silent: true});
    });
  });

  on('change:abilities_info_show change:toggle_exceptional change:strength', (eventInfo) => {
    getAttrs(['strength'], (v) => {
      const output = {};
      const strength = +v.strength || 0;
      output.exceptional_strength_flag = strength >= 18 ? 1 : 0;
      setAttrs(output, {silent: true});
    });
  });

  // PC or NPC sheet role
  on('change:is_npc', (eventInfo) => {
    getAttrs(['is_npc', 'toggle_npc'], (v) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      const output = {};
      const isNPC = +v.is_npc;
      let toggleNPC = +v.toggle_npc;
      toggleNPC = isNPC === 0 ? 0 : 1;
      output.toggle_npc = toggleNPC;
      setAttrs(output, {silent: true});
    });
  });

  const sumEquipmentCost = () => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_quantity'));
        fields.push(section_attribute('equipment', id, 'equipment_cost'));
      });
      getAttrs(fields, (v) => {
        const equipmentCosts = [];
        _.each(idArray, (id) => {
          const quantity = +v[section_attribute('equipment', id, 'equipment_quantity')] || 0;
          let cost = +v[section_attribute('equipment', id, 'equipment_cost')] || 0;
          // costs
          cost = quantity > 0 ? cost * quantity : 0;
          equipmentCosts.push(cost);
        });
        const total_equipment_cost = equipmentCosts.reduce((sum, cost) => sum + cost, 0);
        output.total_equipment_cost = total_equipment_cost.toFixed(2);
        output.total_cost = total_equipment_cost.toFixed(2);
        setAttrs(output, {silent: true});
      });
    });
  };

  const sumEquipmentWeight = () => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_type'));
        fields.push(section_attribute('equipment', id, 'equipment_armor_type'));
        fields.push(section_attribute('equipment', id, 'equipment_location'));
        fields.push(section_attribute('equipment', id, 'equipment_weight'));
        fields.push(section_attribute('equipment', id, 'equipment_quantity'));
        fields.push(section_attribute('equipment', id, 'equipment_carried'));
        fields.push(section_attribute('equipment', id, 'equipment_carried_select'));
      });
      getAttrs(['total_coin_weight', ...fields], (v) => {
        const weaponWeights = [];
        const armorWeights = [];
        const totalEquipmentWeights = [];
        _.each(idArray, (id) => {
          const type = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
          const armorType = +v[section_attribute('equipment', id, 'equipment_armor_type')] || 0;
          // const location = v[section_attribute('equipment', id, 'equipment_location')];
          // Weight calcs use equipment_carried
          let carried = 0;
          const carriedSelect = +v[section_attribute('equipment', id, 'equipment_carried_select')] || 0;
          output[section_attribute('equipment', id, 'equipment_carried')] = carriedSelect === 1 ? 1 : 0;
          carried = carriedSelect === 1 ? 1 : 0;
          const quantity = +v[section_attribute('equipment', id, 'equipment_quantity')] || 0;
          let weight = +v[section_attribute('equipment', id, 'equipment_weight')] || 0;
          let weaponWeight = 0;
          let armorWeight = 0;
          weight = weight * quantity * carried;
          if (type === 1) weaponWeight = weight;
          if (type === 2) armorWeight = weight;
          weaponWeights.push(weaponWeight);
          armorWeights.push(armorWeight);
          totalEquipmentWeights.push(weight);
        });
        const totalWeaponWeight = weaponWeights.reduce((sum, weaponWeight) => sum + weaponWeight, 0);
        const totalArmorWeight = armorWeights.reduce((sum, armorWeight) => sum + armorWeight, 0);
        const totalEquipmentWeight = totalEquipmentWeights.reduce((sum, weight) => sum + weight, 0);
        const total_equipment_weight_adjusted = totalEquipmentWeight - totalArmorWeight - totalWeaponWeight;
        // conversion for coin lbs weight outside this function
        const total_weight = Math.round(float(v.total_coin_weight) + float(totalEquipmentWeight));
        output.total_weapon_weight = totalWeaponWeight.toFixed(2);
        output.total_armor_weight = totalArmorWeight.toFixed(2);
        output.total_equipment_weight = totalEquipmentWeight.toFixed(2);
        output.total_equipment_weight_adjusted = total_equipment_weight_adjusted.toFixed(2);
        output.total_weight = total_weight;
        setAttrs(output, {silent: true});
      });
    });
  };

  // Equipment Cost Calcs
  on('change:repeating_equipment:equipment_quantity change:repeating_equipment:equipment_cost remove:repeating_equipment', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    sumEquipmentCost();
  });

  // Equipment Weight Calcs
  on(
    'change:repeating_equipment:equipment_weight change:repeating_equipment:equipment_quantity change:repeating_equipment:equipment_carried change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_armor_worn change:total_coin_weight remove:repeating_equipment change:toggle_lbs',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      sumEquipmentWeight();
    }
  );

  // Coin Weight
  on('change:pp change:gp change:ep change:sp change:cp change:toggle_lbs', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getAttrs(['pp', 'gp', 'ep', 'sp', 'cp', 'toggle_lbs'], (v) => {
      const lbsConversion = +(v.toggle_lbs || 0) ? 10 : 1;
      setAttrs({
        total_coin_weight: (Math.round((float(v.pp) + float(v.gp) + float(v.ep) + float(v.sp) + float(v.cp)) / 1) / lbsConversion).toFixed(2),
      });
    });
  });

  // Encumbrance Calcs
  function setCurrentEncumbranceFlag() {
    getAttrs(['normal_load_adjusted', 'heavy_load', 'very_heavy_load', 'total_weight', 'autocalc_movement_flag', 'current_bulk', 'current_encumbrance_move'], (v) => {
      // clog('Current Encumbrance flag has been re-calculated');
      const output = {};
      const autocalc_movement_flag = +v.autocalc_movement_flag || 0;
      const normal_load_adjusted = +v.normal_load_adjusted || 0;
      const heavy_load = +v.heavy_load || 0;
      const very_heavy_load = +v.very_heavy_load || 0;
      const total_weight = +v.total_weight || 0;
      const current_bulk = +v.current_bulk || 0;
      let currentEncumbrance = 0;

      if (total_weight <= normal_load_adjusted) {
        output.current_encumbrance_label = 'Unencumbered';
        currentEncumbrance = 0;
        output.current_encumbrance = currentEncumbrance;
        // Bail out of IF unless auto-calc movement is enabled
        output.current_encumbrance_move = autocalc_movement_flag === 1 ? Math.max(currentEncumbrance, current_bulk) : v.current_encumbrance_move;
        // clog('===== Carrying Capacity is Unencumbered =====');
      } else if (total_weight > normal_load_adjusted && total_weight <= heavy_load) {
        output.current_encumbrance_label = 'Heavy';
        currentEncumbrance = 1;
        output.current_encumbrance = currentEncumbrance;
        // Bail out of IF unless auto-calc movement is enabled
        output.current_encumbrance_move = autocalc_movement_flag === 1 ? Math.max(currentEncumbrance, current_bulk) : v.current_encumbrance_move;
        // clog('===== Carrying Capacity is Heavy =====');
      } else if (total_weight > heavy_load && total_weight <= very_heavy_load) {
        output.current_encumbrance_label = 'Very Heavy';
        currentEncumbrance = 2;
        output.current_encumbrance = currentEncumbrance;
        // Bail out of IF unless auto-calc movement is enabled
        output.current_encumbrance_move = autocalc_movement_flag === 1 ? Math.max(currentEncumbrance, current_bulk) : v.current_encumbrance_move;
        // clog('===== Carrying Capacity is Very Heavy =====');
      } else {
        output.current_encumbrance_label = 'Encumbered';
        // no DEX Bonus to AC
        currentEncumbrance = 3;
        output.current_encumbrance = currentEncumbrance;
        // Bail out of IF unless auto-calc movement is enabled
        output.current_encumbrance_move = autocalc_movement_flag === 1 ? Math.max(currentEncumbrance, current_bulk) : v.current_encumbrance_move;
        // clog('===== Carrying Capacity is Encumbered =====');
      }
      setAttrs(output);
    });
  }

  on(
    'sheet:opened change:encumbrancebonus change:normal_load change:total_weight change:autocalc_movement_flag change:current_bulk change:encumbrancebonus_lbs change:toggle_lbs',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      getAttrs(['encumbrancebonus', 'toggle_lbs'], (v) => {
        // clog('Encumbrance has been re-calculated');
        const output = {};
        const useLbs = +(v.toggle_lbs || 0);
        const lbsConversion = useLbs ? 0.1 : 1;
        const normal = 350 * lbsConversion;
        const encumbranceBonus = +v.encumbrancebonus || 0;
        const encumbranceBonusLbs = float(encumbranceBonus * lbsConversion);
        const thisBonus = useLbs ? encumbranceBonusLbs : encumbranceBonus;
        const normalAdjusted = normal + thisBonus;
        const heavy = normalAdjusted + normal;
        const veryHeavy = heavy + normal;
        const max = veryHeavy;
        output.encumbrancebonus_lbs = encumbranceBonusLbs;
        output.normal_load = normal;
        output.normal_load_adjusted = normalAdjusted;
        output.heavy_load = heavy;
        output.very_heavy_load = veryHeavy;
        output.max_load = max + 1;
        setAttrs(output, {silent: true}, setCurrentEncumbranceFlag());
      });
    }
  );

  // Movement Calcs
  function setCurrentMovement() {
    getAttrs(['current_encumbrance_move', 'movement'], (v) => {
      // clog('Movement Rates have been re-calculated');
      const output = {};
      // only extract an integer from movement
      const movement = +v.movement.toString().replace(/[^0-9]/g, '');
      const current_encumbrance_move = +v.current_encumbrance_move || 0;
      let adjustedMove = 0;
      if (current_encumbrance_move === 0) {
        adjustedMove = movement;
        // clog('=====Movement is Normal=====');
      } else if (current_encumbrance_move === 1) {
        adjustedMove = int(movement - 3);
        // clog('=====Movement is Heavy=====');
      } else if (current_encumbrance_move === 2) {
        adjustedMove = int(movement - 6);
        // clog('=====Movement is Very Heavy=====');
      } else {
        adjustedMove = int(movement - 9);
        // clog('=====Movement is Encumbered=====');
      }
      output.movement_normal = adjustedMove;
      output.movement_known = adjustedMove * 5;
      output.movement_run = adjustedMove * 10;
      setAttrs(output, {silent: true});
    });
  }

  on('change:movement change:current_encumbrance change:current_encumbrance_move change:autocalc_movement_flag', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getAttrs(['movement'], (v) => {
      // clog('Current Base Movement has been re-calculated');
      const output = {};
      const recalc = 0;
      // only extract an integer from movement
      const movement = +v.movement.toString().replace(/[^0-9]/g, '');
      output.movement_heavy = Math.max(movement - 3, 0);
      output.movement_load = Math.max(movement - 6, 0);
      output.movement_max = Math.max(movement - 9, 0);
      setAttrs(output, {silent: true}, setCurrentMovement(), calcAC(recalc));
    });
  });

  // Bulk Calcs
  function setCurrentBulk() {
    getAttrs(
      ['unarmored_bulk', 'armortype_bulk', 'armortype2_bulk', 'armorshield_bulk', 'unarmored_worn', 'armortype_worn', 'armortype2_worn', 'armorshield_worn', 'armorshield_carried'],
      (v) => {
        const output = {};
        const {unarmored_worn} = v;
        const {armortype_worn} = v;
        const {armortype2_worn} = v;
        const {armorshield_worn} = v;
        const {armorshield_carried} = v;
        // shield bulk s/b considered even if it's just carried
        const armorShieldWornOrCarried = Math.max(armorshield_worn, armorshield_carried);
        const unarmored_bulk = v.unarmored_bulk * unarmored_worn;
        const armortype_bulk = v.armortype_bulk * armortype_worn;
        const armortype2_bulk = v.armortype2_bulk * armortype2_worn;
        const armorshield_bulk = v.armorshield_bulk * armorShieldWornOrCarried;
        const armorBulk = Math.max(unarmored_bulk, armortype_bulk, armortype2_bulk, armorshield_bulk);
        switch (armorBulk) {
          case 0:
            output.current_bulk_label = 'Not Bulky';
            output.current_bulk = 0;
            break;
          case 1:
            output.current_bulk_label = 'Not Bulky/Light';
            output.current_bulk = 0;
            break;
          case 2:
            output.current_bulk_label = 'Fairly/Moderate';
            output.current_bulk = 1;
            break;
          case 3:
            output.current_bulk_label = 'Bulky/Heavy';
            output.current_bulk = 2;
            break;
          default:
            clog(`>> failure in bulk calculation <<`);
        }
        setAttrs(output);
      }
    );
  }

  on(
    'change:unarmored_bulk change:armortype_bulk change:armortype2_bulk change:armorshield_bulk change:armorhelmet_bulk change:unarmored_worn change:armortype_worn change:armortype2_worn change:armorshield_worn change:armorhelmet_worn change:armorshield_carried remove:repeating_equipment',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      setCurrentBulk();
    }
  );

  // type/carry jumps to follow unless Show All or same type/carry tab
  // carried_select/carried sync for weight calcs
  on('change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_type change:repeating_equipment:equipment_carried_select', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    const id = eventInfo.sourceAttribute.split('_')[2];
    const source = `${eventInfo.sourceAttribute}`;
    // parses the event text
    const pattern = /equipment_type/;
    // boolean for equipment_type change
    const isType = pattern.test(source);
    const fields = [section_attribute('equipment', id, 'equipment_type'), section_attribute('equipment', id, 'equipment_carried_select')];
    getAttrs(['equipment_tabs_type', 'equipment_tabs_carry', ...fields], (v) => {
      const output = {};
      // carriedTab will be 1, 0, 2, -1
      const carriedTab = +v.equipment_tabs_carry || 0;
      // thisTab will be 0, 1, 2, 3, 4, -1
      const typeTab = +v.equipment_tabs_type || 0;
      // thisType will be 0, 1, 2, 3, 4
      const thisType = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
      // thisCarriedSelect will be 0, 1, 2
      const thisCarriedSelect = +v[section_attribute('equipment', id, 'equipment_carried_select')] || 0;
      // Weight calcs use equipment_carried so keep them synced
      output[section_attribute('equipment', id, 'equipment_carried')] = thisCarriedSelect === 1 ? 1 : 0;
      // jumps to equip type tab unless Show All or same equip type tab
      output.equipment_tabs_type = typeTab !== -1 && isType ? thisType : typeTab;
      // jumps to carry type tab unless Show All or same carry type tab
      output.equipment_tabs_carry = carriedTab === -1 || carriedTab === thisCarriedSelect ? -1 : thisCarriedSelect;
      setAttrs(output);
    });
  });

  // Equipment Tabs hide/show Rows
  on('change:equipment_tabs_type change:equipment_tabs_carry', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_equipment', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('equipment', id, 'equipment_type'));
        fields.push(section_attribute('equipment', id, 'equipment_carried_select'));
      });
      getAttrs(['equipment_tabs_type', 'equipment_tabs_carry', ...fields], (v) => {
        const output = {};
        // thisTab will be 0, 1, 2, 3, 4, -1
        const typeTab = +v.equipment_tabs_type || 0;
        // carriedTab will be 1, 0, 2, -1
        const carriedTab = +v.equipment_tabs_carry || 0;
        _.each(idArray, (id) => {
          // thisType will be 0, 1, 2, 3, 4
          const thisType = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
          // thisCarriedSelect will be 0, 1, 2
          const thisCarriedSelect = +v[section_attribute('equipment', id, 'equipment_carried_select')] || 0;
          // Use CSS to hide/show the repeating row using typeTab and/or carriedTab
          output[section_attribute('equipment', id, 'equipment_show_type')] = typeTab === -1 || typeTab === thisType ? 1 : 0;
          output[section_attribute('equipment', id, 'equipment_show_carry')] = carriedTab === -1 || carriedTab === thisCarriedSelect ? 1 : 0;
        });
        setAttrs(output);
      });
    });
  });

  const removeEmptyArmorRows = () => {
    getSectionIDs('repeating_equipment', (idArray) => {
      const fieldnames = idArray.reduce((fields, id) => [...fields, `repeating_equipment_${id}_equipment_armor_type`], []);
      getAttrs(['armordetails_array', ...armorRowIDs, ...fieldnames], (v) => {
        const output = {};
        const unarmored0_ID = v.unarmored_row_id.toString();
        const armortype1_ID = v.armortype1_row_id.toString();
        const armortype2_ID = v.armortype2_row_id.toString();
        const armorshield_ID = v.armorshield_row_id.toString();
        const armorhelmet_ID = v.armorhelmet_row_id.toString();
        const armorother1_ID = v.armorother1_row_id.toString();
        const armorother2_ID = v.armorother2_row_id.toString();
        const armorother3_ID = v.armorother3_row_id.toString();
        const armorother4_ID = v.armorother4_row_id.toString();
        const armorother5_ID = v.armorother5_row_id.toString();
        const armorother6_ID = v.armorother6_row_id.toString();
        const armorDetailsArray = [
          unarmored0_ID,
          armortype1_ID,
          armortype2_ID,
          armorshield_ID,
          armorhelmet_ID,
          armorother1_ID,
          armorother2_ID,
          armorother3_ID,
          armorother4_ID,
          armorother5_ID,
          armorother6_ID,
        ].map((str) => (str ? str.toString().toLowerCase() : '0'));
        // clog(`armordetails_array: ${armorDetailsArray}`);
        _.each(idArray, (id) => {
          const type = +v[`repeating_equipment_${id}_equipment_armor_type`];
          // 99 is nothing chosen in the selector
          if (type === 99) return;
          // Find positions where id matches in armorDetailsArray
          const matchingIndices = armorDetailsArray
            .map((element, index) => {
              // Check if the element is equal to the id
              if (element === id) {
                // If there's a match, return the corresponding row number
                return `${Math.floor(index) + 1}`;
              }
              // If there's no match, return null
              return null;
            })
            .filter((index) => index !== null);

          // Do stuff only when there are multiple matches
          if (matchingIndices.length > 1) {
            // console.log(`${matchingIndices} id:${id} type:${type}`);
            // console.log(type);
            // console.log(matchingIndices);

            // Create a new array of index positions with multiple matches
            const indicesWithMultipleMatches = matchingIndices;
            // Convert indicesWithMultipleMatches array to a comma-separated string
            const indicesString = indicesWithMultipleMatches.join(',');
            // Create a new variable called "removeRows" with values that don't equal "type"
            const removeRows = indicesString.split(',').filter((value) => value !== String(type));
            // Log the resulting array which could be up to 10 matches
            // console.log(removeRows);
            // Further filter removeRows and save the value at index 0 to removeRow
            const removeRow = removeRows.length > 0 ? removeRows[0] : null;
            // Log the final result
            // console.log(removeRow);
            // Use removeRow to delete the old Armor Details row

            switch (removeRow) {
              case '1':
                output.unarmored = '';
                clog(`>> DELETE/RESET ROW 0 - Unarmored <<`);
                break;
              case '2':
                output.armortype = '';
                clog(`>> DELETE/RESET ROW 1 - Armor 1 <<`);
                break;
              case '3':
                output.armortype2 = '';
                clog(`>> DELETE/RESET ROW 2 - Armor 2 <<`);
                break;
              case '4':
                output.armorshield = '';
                clog(`>> DELETE/RESET ROW 3 - Shield <<`);
                break;
              case '5':
                output.armorhelmet = '';
                clog(`>> DELETE/RESET ROW 4 - Helmet <<`);
                break;
              case '6':
                output.armorother = '';
                clog(`>> DELETE/RESET ROW 5 - Other <<`);
                break;
              case '7':
                output.armorother2 = '';
                clog(`>> DELETE/RESET ROW 6 - Other 2 <<`);
                break;
              case '8':
                output.armorother3 = '';
                clog(`>> DELETE/RESET ROW 7 - Other 3 <<`);
                break;
              case '9':
                output.armorother4 = '';
                clog(`>> DELETE/RESET ROW 8 - Other 4 <<`);
                break;
              case '10':
                output.armorother5 = '';
                clog(`>> DELETE/RESET ROW 9 - Other 5 <<`);
                break;
              case '11':
                output.armorother6 = '';
                clog(`>> DELETE/RESET ROW 10 - Other 6 <<`);
                break;
              default:
                clog(`>> NOTHING TO DELETE/RESET <<`);
            }
          }
        });
        setAttrs(output);
      });
    });
  };

  // sync/update repeating_equipment armor when Armor Details row changes
  const armorDetailslisteners = `${armorAttrs.map((stat) => `change:${stat}`).join(' ')}`;

  on(armorDetailslisteners, (eventInfo) => {
    // clog(eventInfo);
    if (eventInfo.sourceType === 'sheetworker') return;
    const attr = eventInfo.sourceAttribute;
    const attrPrev = eventInfo.previousValue;
    const attrNew = eventInfo.newValue;
    const row_removed = 0;
    // clog(`armorDetailslisteners sourceType:${eventInfo.sourceType} attr:${attr} attrNew:${attrNew} attrPrev:${attrPrev}`);
    // clog(`Change Detected in armorDetailslisteners attr: ${attr}`);
    getAttrs(armorAttrs, (v) => {
      const output = {};
      let newID = '';
      if (attr === 'unarmored' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.unarmored_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 0;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = 1;
        output[`repeating_equipment_${newID}_equipment_item`] = v.unarmored;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.unarmored_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.unarmored_base || 0;
        output[`repeating_equipment_${newID}_equipment_carried_select`] = 1;
        clog(`repeating armor does not exist. Creating unarmored: ${newID}`);
      }
      if (attr === 'armortype' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armortype1_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 1;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armortype;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype_bulk || 0;
        output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype_carried || 0;
        output[`repeating_equipment_${newID}_equipment_weight`] = +v.armor_weight || 0;
        output[`repeating_equipment_${newID}_equipment_cost`] = +v.armor_cost || 0;
        // clog(`repeating armor does not exist. Creating armor1: ${newID}`);
      }
      if (attr === 'armortype2' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armortype2_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armortype2_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armortype2;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armortype2_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armortype2_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armortype2_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armortype2_bulk || 0;
        output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armortype2_carried || 0;
        output[`repeating_equipment_${newID}_equipment_weight`] = +v.armortype2_weight || 0;
        output[`repeating_equipment_${newID}_equipment_cost`] = +v.armortype2_cost || 0;
        // clog(`repeating armor does not exist. Creating armor2: ${newID}`);
      }
      if (attr === 'armorshield' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorshield_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 3;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorshield_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorshield;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorshield_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorshield_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorshield_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorshield_mod || 0;
        output[`repeating_equipment_${newID}_equipment_armor_bulk`] = +v.armorshield_bulk || 0;
        output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorshield_carried || 0;
        output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorshield_weight || 0;
        output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorshield_cost || 0;
        // clog(`repeating armor does not exist. Creating shield: ${newID}`);
      }
      if (attr === 'armorhelmet' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorhelmet_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 4;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorhelmet_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorhelmet;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorhelmet_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorhelmet_magic || 0;
        output[`repeating_equipment_${newID}_equipment_carried_select`] = +v.armorhelmet_carried || 0;
        output[`repeating_equipment_${newID}_equipment_weight`] = +v.armorhelmet_weight || 0;
        output[`repeating_equipment_${newID}_equipment_cost`] = +v.armorhelmet_cost || 0;
        // clog(`repeating armor does not exist. Creating helmet: ${newID}`);
      }
      if (attr === 'armorother' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother1_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 5;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother_mod || 0;
        // clog(`repeating armor does not exist. Creating other1: ${newID}`);
      }
      if (attr === 'armorother2' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother2_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 6;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother2_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother2;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother2_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother2_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother2_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother2_mod || 0;
        // clog(`repeating armor does not exist. Creating other2: ${newID}`);
      }
      if (attr === 'armorother3' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother3_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 7;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother3_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother3;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother3_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother3_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother3_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother3_mod || 0;
        // clog(`repeating armor does not exist. Creating other3: ${newID}`);
      }
      if (attr === 'armorother4' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother4_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 8;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother4_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother4;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother4_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother4_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother4_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother4_mod || 0;
        // clog(`repeating armor does not exist. Creating other4: ${newID}`);
      }
      if (attr === 'armorother5' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother5_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 9;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother5_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother5;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother5_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother5_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother5_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother5_mod || 0;
        // clog(`repeating armor does not exist. Creating other5: ${newID}`);
      }
      if (attr === 'armorother6' && attrPrev === undefined) {
        // has new name but NO id = CREATE NEW ROW
        newID = generateUniqueRowID();
        output.armorother6_row_id = newID.toLowerCase();
        output[`repeating_equipment_${newID}_equipment_type`] = 2;
        output[`repeating_equipment_${newID}_equipment_armor_type`] = 10;
        output[`repeating_equipment_${newID}_equipment_armor_worn`] = +v.armorother6_worn || 0;
        output[`repeating_equipment_${newID}_equipment_item`] = v.armorother6;
        output[`repeating_equipment_${newID}_equipment_armor_ac`] = +v.armorother6_ac || 0;
        output[`repeating_equipment_${newID}_equipment_armor_base`] = +v.armorother6_base || 0;
        output[`repeating_equipment_${newID}_equipment_armor_magic`] = +v.armorother6_magic || 0;
        output[`repeating_equipment_${newID}_equipment_armor_mod`] = +v.armorother6_mod || 0;
        // clog(`repeating armor does not exist. Creating other6: ${newID}`);
      }
      setAttrs(output, {silent: true}, armorDetailsRowidArray());
      syncArmorToEquipment(null, attr, row_removed);
    });
  });

  function fillArmorDetails(id, callback) {
    getAttrs(
      [
        `repeating_equipment_${id}_equipment_armor_type`,
        `repeating_equipment_${id}_equipment_item`,
        `repeating_equipment_${id}_equipment_armor_worn`,
        `repeating_equipment_${id}_equipment_armor_ac`,
        `repeating_equipment_${id}_equipment_armor_base`,
        `repeating_equipment_${id}_equipment_armor_magic`,
        `repeating_equipment_${id}_equipment_armor_mod`,
        `repeating_equipment_${id}_equipment_armor_bulk`,
        `repeating_equipment_${id}_equipment_carried_select`,
        `repeating_equipment_${id}_equipment_carried`,
        `repeating_equipment_${id}_equipment_weight`,
        `repeating_equipment_${id}_equipment_cost`,
      ],
      (v) => {
        const output = {};
        const recalc = 0;
        const type = +v[`repeating_equipment_${id}_equipment_armor_type`] || 0;
        const item = v[`repeating_equipment_${id}_equipment_item`];
        const worn = +v[`repeating_equipment_${id}_equipment_armor_worn`] || 0;
        const ac = +v[`repeating_equipment_${id}_equipment_armor_ac`] || 0;
        const base = +v[`repeating_equipment_${id}_equipment_armor_base`] || 0;
        const magic = +v[`repeating_equipment_${id}_equipment_armor_magic`] || 0;
        const mod = +v[`repeating_equipment_${id}_equipment_armor_mod`] || 0;
        const bulk = +v[`repeating_equipment_${id}_equipment_armor_bulk`] || 0;
        let carriedSelect = +v[`repeating_equipment_${id}_equipment_carried_select`] || 0;
        const weight = +v[`repeating_equipment_${id}_equipment_weight`] || 0;
        const cost = +v[`repeating_equipment_${id}_equipment_cost`] || 0;
        // armor in use ie 'worn', should always be considered as carried
        if (worn === 1) {
          carriedSelect = 1;
          output[`repeating_equipment_${id}_equipment_carried_select`] = 1;
          // clog(`armor is worn: so armor is carried`);
        } else if (worn === 0 && (carriedSelect === 0 || carriedSelect === 2)) {
          output[`repeating_equipment_${id}_equipment_carried_select`] = carriedSelect;
          // clog(`armor is not worn: so armor is not carried or on mount.`);
        }
        const thisLog = [
          `ID:${id} ITEM:${item} TYPE:${type} WORN:${worn} AC:${ac} BASE:${base} MAGIC:${magic} MOD:${mod} BULK:${bulk} CARRIED:${carriedSelect} WEIGHT:${weight} COST:${cost} UPDATED:`,
        ];
        switch (type) {
          case 99:
            clog(`Choose an armor row.`);
            break;
          case 0:
            // clog(`${thisLog} Unarmored`);
            output.unarmored_worn = worn;
            output.unarmored = item;
            output.unarmored_ac = ac;
            output.unarmored_base = base;
            output.unarmored_bulk = bulk;
            // unarmored is always "in use" but is hidden attr,
            // but should be able to drop clothing ie swim, sleep, etc.
            output.unarmored_carried = carriedSelect;
            output.unarmored_row_id = id;
            break;
          case 1:
            // clog(`${thisLog} Armor 1`);
            output.armortype_worn = worn;
            output.armortype = item;
            output.armortype_ac = ac;
            output.armortype_base = base;
            output.armortype_magic = magic;
            output.armortype_bulk = bulk;
            output.armortype_carried = carriedSelect;
            output.armor_weight = weight;
            output.armor_cost = cost;
            output.armortype1_row_id = id;
            break;
          case 2:
            // clog(`${thisLog} Armor 2`);
            output.armortype2_worn = worn;
            output.armortype2 = item;
            output.armortype2_ac = ac;
            output.armortype2_base = base;
            output.armortype2_magic = magic;
            output.armortype2_bulk = bulk;
            output.armortype2_carried = carriedSelect;
            output.armortype2_weight = weight;
            output.armortype2_cost = cost;
            output.armortype2_row_id = id;
            break;
          case 3:
            // clog(`${thisLog} Shield`);
            output.armorshield_worn = worn;
            output.armorshield = item;
            output.armorshield_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorshield_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorshield_magic = magic;
            output.armorshield_mod = mod;
            output.armorshield_bulk = bulk;
            output.armorshield_carried = carriedSelect;
            output.armorshield_weight = weight;
            output.armorshield_cost = cost;
            output.armorshield_row_id = id;
            break;
          case 4:
            // clog(`${thisLog} Helmet`);
            output.armorhelmet_worn = worn;
            output.armorhelmet = item;
            output.armorhelmet_base = base;
            output.armorhelmet_magic = magic;
            output.armorhelmet_carried = carriedSelect;
            output.armorhelmet_weight = weight;
            output.armorhelmet_cost = cost;
            output.armorhelmet_row_id = id;
            break;
          case 5:
            // clog(`${thisLog} Other`);
            output.armorother_worn = worn;
            output.armorother = item;
            output.armorother_ac = ac;
            output.armorother_base = base;
            output.armorother_magic = magic;
            output.armorother_mod = mod;
            output.armorother1_row_id = id;
            break;
          case 6:
            // clog(`${thisLog} Other 2`);
            output.armorother2_worn = worn;
            output.armorother2 = item;
            output.armorother2_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorother2_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorother2_magic = magic;
            output.armorother2_mod = mod;
            output.armorother2_row_id = id;
            break;
          case 7:
            // clog(`${thisLog} Other 3`);
            output.armorother3_worn = worn;
            output.armorother3 = item;
            output.armorother3_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorother3_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorother3_magic = magic;
            output.armorother3_mod = mod;
            output.armorother3_row_id = id;
            break;
          case 8:
            // clog(`${thisLog} Other 4`);
            output.armorother4_worn = worn;
            output.armorother4 = item;
            output.armorother4_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorother4_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorother4_magic = magic;
            output.armorother4_mod = mod;
            output.armorother4_row_id = id;
            break;
          case 9:
            // clog(`${thisLog} Other 5`);
            output.armorother5_worn = worn;
            output.armorother5 = item;
            output.armorother5_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorother5_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorother5_magic = magic;
            output.armorother5_mod = mod;
            output.armorother5_row_id = id;
            break;
          case 10:
            // clog(`${thisLog} Other 6`);
            output.armorother6_worn = worn;
            output.armorother6 = item;
            output.armorother6_ac = ac >= 0 ? 0 : -Math.abs(ac);
            output.armorother6_base = base >= 0 ? 0 : -Math.abs(base);
            output.armorother6_magic = magic;
            output.armorother6_mod = mod;
            output.armorother6_row_id = id;
            break;
          default:
            clog(`Armor row is out of range.`);
        }
        // Once done, call the provided callback
        if (callback) callback();
        setAttrs(output, calcAC(recalc));
      }
    );
  }

  function createAttack(id) {
    const output = {};
    getAttrs(
      [
        `repeating_equipment_${id}_equipment_item`,
        `repeating_equipment_${id}_equipment_weapon_type`,
        `repeating_equipment_${id}_equipment_weapon_speed`,
        `repeating_equipment_${id}_equipment_weapon_length`,
        `repeating_equipment_${id}_equipment_weapon_space`,
        `repeating_equipment_${id}_equipment_weapon_damagesmallmedium`,
        `repeating_equipment_${id}_equipment_weapon_damagelarge`,
        `repeating_equipment_${id}_equipment_weapon_attackdmgtype`,
        `repeating_equipment_${id}_equipment_weapon_rateoffire`,
        `repeating_equipment_${id}_equipment_weapon_range`,
        `repeating_equipment_${id}_equipment_quantity`,
        `repeating_equipment_${id}_equipment_description`,
      ],
      (v) => {
        const newID = generateUniqueRowID();
        // clog(`Creating a new attack newID:${newID}`);
        output[`repeating_weapon_${newID}_weapon_name`] = v[`repeating_equipment_${id}_equipment_item`];
        output[`repeating_weapon_${newID}_weapon_type`] = +v[`repeating_equipment_${id}_equipment_weapon_type`] || 0;
        output[`repeating_weapon_${newID}_weapon_speed`] = v[`repeating_equipment_${id}_equipment_weapon_speed`];
        output[`repeating_weapon_${newID}_weapon_length`] = v[`repeating_equipment_${id}_equipment_weapon_length`];
        output[`repeating_weapon_${newID}_weapon_space`] = v[`repeating_equipment_${id}_equipment_weapon_space`];
        output[`repeating_weapon_${newID}_weapon_damagesmallmedium`] = v[`repeating_equipment_${id}_equipment_weapon_damagesmallmedium`];
        output[`repeating_weapon_${newID}_weapon_damagelarge`] = v[`repeating_equipment_${id}_equipment_weapon_damagelarge`];
        output[`repeating_weapon_${newID}_weapon_attackdmgtype`] = v[`repeating_equipment_${id}_equipment_weapon_attackdmgtype`];
        output[`repeating_weapon_${newID}_weapon_rateoffire`] = v[`repeating_equipment_${id}_equipment_weapon_rateoffire`];
        output[`repeating_weapon_${newID}_weapon_range`] = v[`repeating_equipment_${id}_equipment_weapon_range`];
        output[`repeating_weapon_${newID}_weapon_quantity`] = +v[`repeating_equipment_${id}_equipment_quantity`] || 0;
        output[`repeating_weapon_${newID}_weapon_notes`] = v[`repeating_equipment_${id}_equipment_description`];
        setAttrs(output, {silent: true});
        damageMacro(newID);
      }
    );
  }

  // checks repeating_equipment id against armor details ids
  function testArmorRowIDs(id, callback) {
    getAttrs(armorRowIDs, (v) => {
      const unarmored0_ID = v.unarmored_row_id.toString();
      const armortype1_ID = v.armortype1_row_id.toString();
      const armortype2_ID = v.armortype2_row_id.toString();
      const armorshield_ID = v.armorshield_row_id.toString();
      const armorhelmet_ID = v.armorhelmet_row_id.toString();
      const armorother1_ID = v.armorother1_row_id.toString();
      const armorother2_ID = v.armorother2_row_id.toString();
      const armorother3_ID = v.armorother3_row_id.toString();
      const armorother4_ID = v.armorother4_row_id.toString();
      const armorother5_ID = v.armorother5_row_id.toString();
      const armorother6_ID = v.armorother6_row_id.toString();
      const idArray = [
        unarmored0_ID,
        armortype1_ID,
        armortype2_ID,
        armorshield_ID,
        armorhelmet_ID,
        armorother1_ID,
        armorother2_ID,
        armorother3_ID,
        armorother4_ID,
        armorother5_ID,
        armorother6_ID,
      ].map((str) => (str ? str.toString().toLowerCase() : '0'));
      let isMatch = '';
      isMatch = idArray.includes(id) ? 1 : 0;
      // clog(`isMatch: ${!isMatch ? 'no id' : 'has id'}`);
      // Check if callback is a function before calling it
      if (typeof callback === 'function') {
        callback(isMatch, idArray);
      }
    });
  }

  armorDetailsRowidArray = (id) => {
    const output = {};
    // Pass a callback function to handle armorDetailsArray
    testArmorRowIDs(id, (result, armorDetailsArray) => {
      output.armordetails_array = [`${armorDetailsArray}`];
      // setAttrs(output, {silent: true}, clog(`armorDetailsArray:${armorDetailsArray}`));
      setAttrs(output, {silent: true});
    });
  };

  // ensures armordetails_array stays updated when the ids change
  const updateArray = `${armorRowIDs.map((stat) => `change:${stat}`).join(' ')}`;
  on(updateArray, (eventInfo) => {
    const attr = eventInfo.sourceAttribute;
    if (eventInfo.sourceType === 'sheetworker') return;
    getAttrs(attr, (v) => {
      const id = v[`${eventInfo.sourceAttribute}`];
      // console.log(`source type: ${eventInfo.sourceType} key:${id}`);
      clog(`Updating armordetails_array...`);
      armorDetailsRowidArray(id);
    });
  });

  // sync/update Armor Details when repeating_equipment armor changes
  on(
    'change:repeating_equipment:equipment_item change:repeating_equipment:equipment_armor_worn change:repeating_equipment:equipment_armor_ac change:repeating_equipment:equipment_armor_base change:repeating_equipment:equipment_armor_magic change:repeating_equipment:equipment_armor_mod change:repeating_equipment:equipment_armor_bulk change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_weight change:repeating_equipment:equipment_cost',
    (eventInfo) => {
      const id = eventInfo.sourceAttribute.split('_')[2].toLowerCase();
      if (eventInfo.sourceType === 'sheetworker') return;
      // checks repeating_equipment id against armor details ids
      testArmorRowIDs(id, (result) => {
        if (result) {
          // clog(`repeating_equipment ARMOR ROW has been CHANGED id: ${id}`);
          // console.log(`source type: ${eventInfo.sourceType} key:${id}`);
          fillArmorDetails(id);
        }
      });
    }
  );

  // sync armor button - fill armor details row with repeating attr values
  // IF the row already exists, but is then moved to a new row,
  // removeEmptyArmorRows will test for duplicates and reset old row
  on('clicked:repeating_equipment:addarmor', (eventInfo) => {
    const id = eventInfo.sourceAttribute.split('_')[2].toLowerCase();
    // clog(`sourceAttribute id: ${id}`);
    // callback to run removeEmptyArmorRows()
    fillArmorDetails(id, () => {
      removeEmptyArmorRows();
    });
  });

  on('clicked:repeating_equipment:addattack', (eventInfo) => {
    const id = eventInfo.sourceAttribute.split('_')[2];
    createAttack(id);
  });

  on('clicked:addturnundead', (eventInfo) => {
    const output = {};
    const newID = generateUniqueRowID();
    output[`repeating_ability_${newID}_ability_name`] = 'Turn Undead by Type';
    output[`repeating_ability_${newID}_ability_short_description`] = '[Turn Undead by Type](~selected|turn_undead_roll)';
    setAttrs(output, {silent: true});
  });

  on('clicked:addturnundead2', (eventInfo) => {
    const output = {};
    const newID = generateUniqueRowID();
    output[`repeating_ability_${newID}_ability_name`] = 'Turn Undead by HD';
    output[`repeating_ability_${newID}_ability_short_description`] = '[Turn Undead by HD](~selected|turn_undead2_roll)';
    setAttrs(output, {silent: true});
  });

  // resets the matching Armor Detail row attributes if removed
  on('remove:repeating_equipment', (eventInfo) => {
    const id = eventInfo.sourceAttribute.split('_')[2].toLowerCase();
    const row_removed = 1;
    // console.log({event: 'remove:repeating_equipment', eventInfo, id});
    // Pass a callback function to handle the result and armorDetailsArray
    testArmorRowIDs(id, (result, armorDetailsArray) => {
      if (result) {
        syncArmorToEquipment(id, null, row_removed);
      }
    });
  });

  // Spell Tabs and Memorized toggle
  on('change:spell_tabs change:toggle_show_memorized change:spell_caster_tabs change:toggle_caster2', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_spells', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('spells', id, 'spell_memorized'));
        fields.push(section_attribute('spells', id, 'spell_show_all'));
        fields.push(section_attribute('spells', id, 'spell_level'));
        fields.push(section_attribute('spells', id, 'spell_caster_class'));
      });
      getAttrs(['spell_tabs', 'toggle_show_memorized', 'spell_caster_tabs', 'toggle_caster2', ...fields], (v) => {
        const output = {};
        const memorizedOnly = +v.toggle_show_memorized || 0;
        const casterTab = +v.spell_caster_tabs || 0; // -1, 0, 1
        const hideCaster2 = +v.toggle_caster2 || 0;
        const levelTab = +v.spell_tabs || 0;
        _.each(idArray, (id) => {
          const thisMemorizedOnly = +v[section_attribute('spells', id, 'spell_memorized')] || 0;
          const thisCaster = +v[section_attribute('spells', id, 'spell_caster_class')] || 0; // 0, 1, 2
          const thisLevel = +v[section_attribute('spells', id, 'spell_level')] || 0;
          output[section_attribute('spells', id, 'spell_show_memorized')] = memorizedOnly === 1 && thisMemorizedOnly > 0 ? 1 : 0;
          output[section_attribute('spells', id, 'spell_show_all')] = memorizedOnly === 1 ? 0 : 1;
          // show THIS spell if spell level and spell tab match
          if (levelTab === -1 || levelTab === thisLevel) {
            // one caster: ignore caster tabs and show THIS spell
            if (hideCaster2 === 1) {
              output[section_attribute('spells', id, 'spell_show')] = 1;
              // multi-caster: continue using caster tabs
            } else if (hideCaster2 === 0) {
              // caster tab is All or spell class is 'n/a': show THIS spell
              if (casterTab === -1 || thisCaster === 0) {
                output[section_attribute('spells', id, 'spell_show')] = 1;
                // caster tab is caster1 and spell is caster1: show THIS spell
              } else if (casterTab === 0 && thisCaster === 1) {
                output[section_attribute('spells', id, 'spell_show')] = 1;
                // caster tab is caster2 and spell is caster2: show THIS spell
              } else if (casterTab === 1 && thisCaster === 2) {
                output[section_attribute('spells', id, 'spell_show')] = 1;
                // hide THIS spell
              } else {
                output[section_attribute('spells', id, 'spell_show')] = 0;
              }
            }
            // hide THIS spell if it does not match spell level tab selected
          } else {
            output[section_attribute('spells', id, 'spell_show')] = 0;
          }
        });
        setAttrs(output);
      });
    });
  });

  // Spell Tabs level change sync
  on('change:repeating_spells:spell_level change:repeating_spells:spell_caster_class', (eventInfo) => {
    // test if API is creating the repeating row and bail
    if (eventInfo.sourceType !== 'player') return;
    getAttrs(['repeating_spells_spell_level', 'repeating_spells_spell_caster_class', 'spell_caster_tabs', 'spell_tabs'], (v) => {
      const output = {};
      // 0, 1, -1
      const casterTab = +v.spell_caster_tabs || 0;
      // 0, 1, 2
      const thisCaster = +v.repeating_spells_spell_caster_class || 0;
      const levelTab = +v.spell_tabs || 0;
      const thisLevel = v.repeating_spells_spell_level;
      // jumps to spell level tab unless Show All or same level tab
      output.spell_tabs = thisLevel >= 0 && levelTab !== thisLevel ? thisLevel : levelTab;
      // jumps to caster class tab unless Show All or same caster tab
      output.spell_caster_tabs = casterTab !== -1 && thisCaster <= 1 ? 0 : 1;
      setAttrs(output);
    });
  });

  // Spell Caster Class Name/Level fill-in
  setSpellsCasterClass = () => {
    getSectionIDs('repeating_spells', (idArray) => {
      const output = {};
      const nonRep = ['caster_class1_name', 'caster_class2_name', 'caster_class1_level', 'caster_class2_level'];
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('spells', id, 'spell_caster_class'));
      });
      const combined = [...nonRep, ...fields];
      getAttrs(combined, (v) => {
        _.each(idArray, (id) => {
          const thisClass = +v[section_attribute('spells', id, 'spell_caster_class')] || 0;
          if (thisClass === 0) {
            output[section_attribute('spells', id, 'spell_caster_class_name')] = '';
            output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
            // clog(`thisClass 0:${thisClass}`);
          } else if (thisClass === 1) {
            output[section_attribute('spells', id, 'spell_caster_class_name')] = v.caster_class1_name;
            output[section_attribute('spells', id, 'spell_caster_class_level')] = +v.caster_class1_level || 0;
            output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
            // clog(`thisClass 1:${thisClass}`);
          } else if (thisClass === 2) {
            output[section_attribute('spells', id, 'spell_caster_class_name')] = v.caster_class2_name;
            output[section_attribute('spells', id, 'spell_caster_class_level')] = +v.caster_class2_level || 0;
            output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
            // clog(`thisClass 2:${thisClass}`);
          }
        });
        setAttrs(output, {silent: true});
      });
    });
  };

  on('change:caster_class1_name change:caster_class2_name change:caster_class1_level change:caster_class2_level', (eventInfo) => {
    // clog(`spell changed by who:${eventInfo.sourceType}`);
    setSpellsCasterClass();
  });

  on('change:repeating_spells:spell_name change:repeating_spells:spell_caster_class', (eventInfo) => {
    // console.log(`sourceType:${eventInfo.sourceType}`);
    const id = eventInfo.sourceAttribute.split('_')[2];
    getAttrs([`repeating_spells_${id}_spell_caster_class`, 'caster_class1_name', 'caster_class1_level', 'caster_class2_name', 'caster_class2_level'], (v) => {
      const output = {};
      const thisClass = +v[section_attribute('spells', id, 'spell_caster_class')] || 0;
      // console.log(`thisClass: ${thisClass} id: ${id}`);
      if (thisClass === 0) {
        output[section_attribute('spells', id, 'spell_caster_class_name')] = '';
        output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
      } else if (thisClass === 1) {
        output[section_attribute('spells', id, 'spell_caster_class_name')] = v.caster_class1_name;
        output[section_attribute('spells', id, 'spell_caster_class_level')] = +v.caster_class1_level || 0;
        output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
      } else if (thisClass === 2) {
        output[section_attribute('spells', id, 'spell_caster_class_name')] = v.caster_class2_name;
        output[section_attribute('spells', id, 'spell_caster_class_level')] = +v.caster_class2_level || 0;
        output[section_attribute('spells', id, 'spell_caster_class')] = thisClass;
      }
      setAttrs(output, {silent: true});
    });
  });

  // ToHitACadj Toggle
  on(
    'change:repeating_weapon:weapon_tohitacadj_flag change:repeating_weapon:weapon_thac_adj0 change:repeating_weapon:weapon_thac_adj1 change:repeating_weapon:weapon_thac_adj2 change:repeating_weapon:weapon_thac_adj3 change:repeating_weapon:weapon_thac_adj4 change:repeating_weapon:weapon_thac_adj5 change:repeating_weapon:weapon_thac_adj6 change:repeating_weapon:weapon_thac_adj7 change:repeating_weapon:weapon_thac_adj8 change:repeating_weapon:weapon_thac_adj9 change:repeating_weapon:weapon_thac_adj10',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      getAttrs(['repeating_weapon_weapon_ToHitACadj_flag', 'repeating_weapon_weapon_ToHitACadj'], (v) => {
        const output = {};
        const thisflag = +v.repeating_weapon_weapon_ToHitACadj_flag || 0;
        output.repeating_weapon_weapon_ToHitACadj =
          thisflag === 1
            ? '{{ToHitACadj2to10=HitAdj:[[ @{weapon_thac_adj0} ]]|[[ @{weapon_thac_adj1} ]]|[[ @{weapon_thac_adj2} ]]|[[ @{weapon_thac_adj3} ]]|[[ @{weapon_thac_adj4} ]]|[[ @{weapon_thac_adj5} ]]|[[ @{weapon_thac_adj6} ]]|[[ @{weapon_thac_adj7} ]]|[[ @{weapon_thac_adj8} ]]|[[ @{weapon_thac_adj9} ]]|[[ @{weapon_thac_adj10} ]] }}'
            : '{{ToHitACadj2to10}}';
        setAttrs(output, {silent: true});
      });
    }
  );

  // Matrix or THAC0 Toggle for repeating_weapon
  on('change:toggle_to_hit_table change:repeating_weapon:weapon_name change:repeating_weapon:weapon_whisper_to_hit_select', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(`repeating_weapon_${id}_weapon_whisper_to_hit_select`);
        fields.push(`repeating_weapon_${id}_weapon_whisper_to_hit`);
      });
      getAttrs(['toggle_to_hit_table', ...fields], (v) => {
        const output = {};
        const flag = +v.toggle_to_hit_table || 0;

        _.each(idArray, (id) => {
          let thishitTableSelect = +v[`repeating_weapon_${id}_weapon_whisper_to_hit_select`] || 0;
          let thishitTableMacro = v[`repeating_weapon_${id}_weapon_whisper_to_hit`];
          const noMacro = '&nbsp;';
          const matrixMacro =
            '\n/w gm &{template:attacks-table} {{color=@{color_option}}} {{ToHitAC-10to0=ToHit:[[ @{thac-10} ]]|[[ @{thac-9} ]]|[[ @{thac-8} ]]|[[ @{thac-7} ]]|[[ @{thac-6} ]]|[[ @{thac-5} ]]|[[ @{thac-4} ]]|[[ @{thac-3} ]]|[[ @{thac-2} ]]|[[ @{thac-1} ]]|[[ @{thac0} ]]}} {{ToHitAC1to10=ToHit:[[ @{thac0} ]]|[[ @{thac1} ]]|[[ @{thac2} ]]|[[ @{thac3} ]]|[[ @{thac4} ]]|[[ @{thac5} ]]|[[ @{thac6} ]]|[[ @{thac7} ]]|[[ @{thac8} ]]|[[ @{thac9} ]]|[[ @{thac10} ]] }}';
          const thac0Macro =
            '\n/w gm &{template:attacks-table} {{color=@{color_option}}} {{ToHitAC-10to0=ToHit:@{thac0-10}|@{thac0-9}|@{thac0-8}|@{thac0-7}|@{thac0-6}|@{thac0-5}|@{thac0-4}|@{thac0-3}|@{thac0-2}|@{thac0-1}|**@{thac00}**}} {{ToHitAC1to10=ToHit:**@{thac00}**|@{thac01}|@{thac02}|@{thac03}|@{thac04}|@{thac05}|@{thac06}|@{thac07}|@{thac08}|@{thac09}|@{thac010} }}';

          if (thishitTableSelect === 2) {
            thishitTableMacro = noMacro;
            thishitTableSelect = 2;
          } else if (thishitTableSelect === 0) {
            if (flag === 0) {
              thishitTableMacro = matrixMacro;
              thishitTableSelect = 0;
            } else if (flag === 1) {
              thishitTableMacro = thac0Macro;
              thishitTableSelect = 1;
            }
          } else if (thishitTableSelect === 1) {
            if (flag === 0) {
              thishitTableMacro = matrixMacro;
              thishitTableSelect = 0;
            } else if (flag === 1) {
              thishitTableMacro = thac0Macro;
              thishitTableSelect = 1;
            }
          }
          output[`repeating_weapon_${id}_weapon_whisper_to_hit`] = thishitTableMacro;
          output[`repeating_weapon_${id}_weapon_whisper_to_hit_select`] = thishitTableSelect;
        });
        setAttrs(output, {silent: true});
      });
    });
  });

  // Weapon Proficiency Toggle
  on('change:repeating_weapon:weapon_prof_flag change:weapon_proficiency_initial change:weapon_proficiency_added_per_level change:weapon_proficiency_penalty', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(`repeating_weapon_${id}_weapon_prof_flag`);
      });
      getAttrs(['weapon_proficiency_penalty', ...fields], (v) => {
        // clog('Weapon Proficiency has been re-calculated');
        const output = {};
        _.each(idArray, (id) => {
          const thisflag = +v[`repeating_weapon_${id}_weapon_prof_flag`] || 0;
          const thispenalty = +v.weapon_proficiency_penalty || 0;
          output[`repeating_weapon_${id}_weapon_prof`] = thispenalty;
          output[`repeating_weapon_${id}_weapon_prof_pen`] = thisflag === 0 ? '0' : thispenalty;
        });
        setAttrs(output, {silent: true});
      });
    });
  });

  // Weapon Backstab Toggle
  on('change:repeating_weapon:weapon_backstab_flag change:backstab change:backstab_bonus change:toggle_thief_skills', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapon', (idArray) => {
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(`repeating_weapon_${id}_weapon_backstab_flag`);
      });
      getAttrs(['backstab', 'backstab_bonus', 'toggle_thief_skills', ...fields], (v) => {
        const output = {};
        const thiefSkills = +v.toggle_thief_skills;
        const thisMult = +v.backstab || 1;
        const thisBonus = +v.backstab_bonus || 0;
        _.each(idArray, (id) => {
          const thisFlag = +v[`repeating_weapon_${id}_weapon_backstab_flag`];
          if (thiefSkills === 0) {
            output[`repeating_weapon_${id}_weapon_backstab_var`] = thisFlag === 0 ? 0 : `+${thisBonus}`;
            output[`repeating_weapon_${id}_weapon_backstab_bonus`] = thisFlag === 0 ? 0 : thisBonus;
            output[`repeating_weapon_${id}_weapon_backstab`] = thisFlag === 0 ? 1 : `x${thisMult}`;
            output[`repeating_weapon_${id}_weapon_backstab_mult`] = thisFlag === 0 ? 1 : thisMult;
          }
          if (thiefSkills === 1) {
            output[`repeating_weapon_${id}_weapon_backstab_var`] = 0;
            output[`repeating_weapon_${id}_weapon_backstab_bonus`] = 0;
            output[`repeating_weapon_${id}_weapon_backstab`] = 1;
            output[`repeating_weapon_${id}_weapon_backstab_mult`] = 1;
          }
        });
        setAttrs(output, {silent: true});
      });
    });
  });

  function syncDualPen() {
    getSectionIDs('repeating_weapon', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_dual'));
      });
      getAttrs(['dual_pen_primary', 'dual_pen_secondary', ...fields], (v) => {
        // clog('Weapon Attack Type has been re-calculated');
        const primary = +v.dual_pen_primary || 0;
        const secondary = +v.dual_pen_secondary || 0;
        _.each(idArray, (id) => {
          const attack_type = v[section_attribute('weapon', id, 'weapon_dual')];
          let handed_mod = 0;
          if (attack_type === 'Normal') handed_mod = 0;
          else if (attack_type === 'Primary') handed_mod = primary;
          else if (attack_type === 'Secondary') handed_mod = secondary;
          const thispenalty = Math.min(0, handed_mod);
          output[section_attribute('weapon', id, 'weapon_dual_pen')] = thispenalty;
        });
        setAttrs(output, {silent: true});
      });
    });
  }

  on('change:repeating_weapon:weapon_dual', (eventInfo) => {
    const output = {};
    getAttrs(['dual_pen_primary', 'dual_pen_secondary', 'repeating_weapon_weapon_dual'], (v) => {
      // clog('this weapon attack Type has been re-calculated');
      const primary = +v.dual_pen_primary || 0;
      const secondary = +v.dual_pen_secondary || 0;
      const attack_type = v.repeating_weapon_weapon_dual;
      let handed_mod = 0;
      if (attack_type === 'Normal') handed_mod = 0;
      else if (attack_type === 'Primary') handed_mod = primary;
      else if (attack_type === 'Secondary') handed_mod = secondary;
      const thispenalty = Math.min(0, handed_mod);
      output.repeating_weapon_weapon_dual_pen = thispenalty;
      setAttrs(output, {silent: true});
    });
  });

  // Weapon Dual-Wield Calc Penalty
  on('change:dual_pen_primary change:dual_pen_secondary change:dexterity', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getAttrs(['dexterity'], (v) => {
      // clog('Weapon Attack Type has been re-calculated');
      const output = {};
      const dex = +v.dexterity || 0;
      let dex_mod = 0;
      if (dex < 6) {
        dex_mod = Math.max(-3, dex - 6);
        // clog(`low dex penalty: ${dex_mod}`);
      } else if (dex >= 18) {
        dex_mod = Math.min(5, Math.floor(dex / 3) - 3);
        // clog(`very high dex penalty: ${dex_mod}`);
      } else if (dex > 15) {
        dex_mod = dex - 15;
        // clog(`high dex penalty: ${dex_mod}`);
      }
      const primary_mod = Math.min(0, dex_mod - 2);
      const secondary_mod = Math.min(0, dex_mod - 4);
      output.dual_pen_primary = primary_mod;
      output.dual_pen_secondary = secondary_mod;
      setAttrs(output, {silent: true}, syncDualPen());
    });
  });

  // Weapon Range: Parse Ranges
  calcRange = (id) => {
    const output = {};
    const fields = [
      section_attribute('weapon', id, 'weapon_range'),
      section_attribute('weapon', id, 'weapon_range_short'),
      section_attribute('weapon', id, 'weapon_range_medium'),
      section_attribute('weapon', id, 'weapon_range_long'),
      section_attribute('weapon', id, 'weapon_attack_type'),
      section_attribute('weapon', id, 'weapon_range_error'),
    ];
    getAttrs(fields, (v) => {
      // attack types selector: melee=0, ranged=1, touch=2, ranged_touch=3
      const thisType = +v[section_attribute('weapon', id, 'weapon_attack_type')] || 0;
      if (thisType === 0 || thisType === 2) return;
      let thisRange = v[section_attribute('weapon', id, 'weapon_range')];
      // remove quotes to prevent NaN (ie distance indicators)
      thisRange = thisRange.replace(/'/g, '');
      thisRange = thisRange.replace(/"/g, '');
      // parse ranges
      const thisRangeArray = thisRange.split('/').join(',').split(' ').join(',').split('-').join(',').split(',');
      // clog(`thisRangeArray: ${thisRangeArray}`);
      const thisRangeShort = Number(thisRangeArray[0]);
      let thisRangeMedium = Number(thisRangeArray[1]);
      let thisRangeLong = Number(thisRangeArray[2]);

      // clog(`Attack is Ranged. repeating_weapon_weapon_attack_type = ${thisType}`);

      // if only a single number is entered, make it Long ie Manticore spikes
      if (thisRangeArray.length === 1 && thisRangeShort >= 0 && !thisRangeMedium && !thisRangeLong) {
        thisRangeMedium = thisRangeShort;
        thisRangeLong = thisRangeShort;
      }
      // clog(`thisRangeShort: ${thisRangeShort} |thisRangeMedium: ${thisRangeMedium} |thisRangeLong: ${thisRangeLong}`);

      // check to see if range is in the proper format.
      if (Number.isNaN(thisRangeShort)) {
        output[section_attribute('weapon', id, 'weapon_range_short')] = 0;
        output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
        // clog(`WARNING: Field is not in the proper format.`);
      } else {
        output[section_attribute('weapon', id, 'weapon_range_short')] = thisRangeShort;
      }
      if (Number.isNaN(thisRangeMedium)) {
        output[section_attribute('weapon', id, 'weapon_range_medium')] = 0;
        output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
        // clog(`WARNING: Field is not in the proper format.`);
      } else {
        output[section_attribute('weapon', id, 'weapon_range_medium')] = thisRangeMedium;
      }
      if (Number.isNaN(thisRangeLong)) {
        output[section_attribute('weapon', id, 'weapon_range_long')] = 0;
        output[section_attribute('weapon', id, 'weapon_range_error')] = thisRange === '' ? 1 : 0;
        // clog(`WARNING: Field is not in the proper format.`);
      } else {
        output[section_attribute('weapon', id, 'weapon_range_long')] = thisRangeLong;
      }
      if (!Number.isNaN(thisRangeShort) && !Number.isNaN(thisRangeMedium) && !Number.isNaN(thisRangeLong)) {
        output[section_attribute('weapon', id, 'weapon_range_error')] = 1;
      } else {
        // clog(`Value did not parse.`);
      }
      setAttrs(output, {silent: true});
    });
  };

  on('change:repeating_weapon:weapon_range change:repeating_weapon:weapon_attack_type', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    const id = eventInfo.sourceAttribute.split('_')[2];
    calcRange(id);
  });

  // set flag for css to show/hide fields according to weapon type
  on('change:repeating_weapon:weapon_attack_type', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getAttrs(['repeating_weapon_weapon_attack_type', 'repeating_weapon_weapon_attack_type_flag'], (v) => {
      const output = {};
      const currentType = +v.repeating_weapon_weapon_attack_type || 0;
      const currentTypeFlag = +v.repeating_weapon_weapon_attack_type_flag || 0;
      if (currentType !== currentTypeFlag) {
        output.repeating_weapon_weapon_attack_type_flag = currentType;
      }
      setAttrs(output, {silent: true});
    });
  });

  // HP Calcs
  calcHP = () => {
    // clog('HP re-calculated');
    getAttrs(['hitpoints', 'hitpoints_max', 'sync_hp_flag', 'hitpoints_1_class', 'hitpoints_2_class', 'hitpoints_3_class'], (v) => {
      const output = {};
      const syncHpFlag = +v.sync_hp_flag || 0;
      const hitPointsMax = +v.hitpoints_max || 0;
      const hitpoints_1_class = Math.max(0, +v.hitpoints_1_class || 0);
      const hitpoints_2_class = Math.max(0, +v.hitpoints_2_class || 0);
      const hitpoints_3_class = Math.max(0, +v.hitpoints_3_class || 0);
      const class1 = hitpoints_1_class !== 0 ? 1 : 0;
      const class2 = hitpoints_2_class !== 0 ? 1 : 0;
      const class3 = hitpoints_3_class !== 0 ? 1 : 0;
      const numberOfClasses = class1 + class2 + class3;
      const totalClassHP = int(hitpoints_1_class + hitpoints_2_class + hitpoints_3_class);
      const totalHP = float(totalClassHP / numberOfClasses).toFixed(2);
      output.hitpoints_class_total = totalClassHP;
      output.hp_quotient = numberOfClasses;
      output.hitpoints_total = totalHP;
      output.hitpoints_max = syncHpFlag === 1 ? int(totalHP) : hitPointsMax;
      setAttrs(output, {silent: true});
    });
  };

  on('change:sync_hp_flag change:hitpoints change:hitpoints_max change:hitpoints_1_class change:hitpoints_2_class change:hitpoints_3_class', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    calcHP();
  });

  // AC Calcs
  calcAC = (recalc) => {
    // clog('Armor re-calculated');
    getAttrs(
      [
        'armorclass',
        'armorclass_mod',
        'armorclass_magic',
        'armorbonus',
        'armorbonus_toggle',
        'armorbonus_inverted',
        'unarmored_worn',
        'armortype_worn',
        'armortype2_worn',
        'armorshield_worn',
        'armorhelmet_worn',
        'armorother_worn',
        'armorother2_worn',
        'armorother3_worn',
        'armorother4_worn',
        'armorother5_worn',
        'armorother6_worn',
        'unarmored_base',
        'armortype_base',
        'armortype2_base',
        'armorshield_base',
        'armorother_base',
        'armorother2_base',
        'armorother3_base',
        'armorother4_base',
        'armorother5_base',
        'armorother6_base',
        'unarmored_ac',
        'armortype_ac',
        'armortype2_ac',
        'armorshield_ac',
        'armorhelmet_ac',
        'armorother_ac',
        'armorother2_ac',
        'armorother3_ac',
        'armorother4_ac',
        'armorother5_ac',
        'armorother6_ac',
        'armortype_magic',
        'armortype2_magic',
        'armorshield_magic',
        'armorhelmet_magic',
        'armorother_magic',
        'armorother2_magic',
        'armorother3_magic',
        'armorother4_magic',
        'armorother5_magic',
        'armorother6_magic',
        'armorshield_mod',
        'armorother_mod',
        'armorother2_mod',
        'armorother3_mod',
        'armorother4_mod',
        'armorother5_mod',
        'armorother6_mod',
        'autocalc_ac',
        'armor_rating_flag',
        'current_encumbrance_move',
        'sync_ac_flag',
      ],
      (v) => {
        const autoCalcAcFlag = +v.autocalc_ac || 0;
        if (autoCalcAcFlag + recalc === 0) return;
        // RecalcAC button overrides sync checkbox = continue
        // Or sync is on and an armor change detected = continue
        const output = {};
        const armorClass = +v.armorclass || 0;
        const syncAcFlag = +v.sync_ac_flag || 0;
        const armorRatingFlag = +v.armor_rating_flag || 0;
        const armorShield_mod = +v.armorshield_mod * -1 || 0;
        const armorOther_mod = +v.armorother_mod * -1 || 0;
        const armorOther2_mod = +v.armorother2_mod * -1 || 0;
        const armorOther3_mod = +v.armorother3_mod * -1 || 0;
        const armorOther4_mod = +v.armorother4_mod * -1 || 0;
        const armorOther5_mod = +v.armorother5_mod * -1 || 0;
        const armorOther6_mod = +v.armorother6_mod * -1 || 0;
        const armorType_magic = +v.armortype_magic * -1 || 0;
        const armorType2_magic = +v.armortype2_magic * -1 || 0;
        const armorShield_magic = +v.armorshield_magic * -1 || 0;
        const armorHelmet_magic = +v.armorhelmet_magic * -1 || 0;
        const armorOther_magic = +v.armorother_magic * -1 || 0;
        const armorOther2_magic = +v.armorother2_magic * -1 || 0;
        const armorOther3_magic = +v.armorother3_magic * -1 || 0;
        const armorOther4_magic = +v.armorother4_magic * -1 || 0;
        const armorOther5_magic = +v.armorother5_magic * -1 || 0;
        const armorOther6_magic = +v.armorother6_magic * -1 || 0;
        const unarmored_worn = +v.unarmored_worn || 0;
        const armorType_worn = +v.armortype_worn || 0;
        const armorType2_worn = +v.armortype2_worn || 0;
        const armorShield_worn = +v.armorshield_worn || 0;
        const armorHelmet_worn = +v.armorhelmet_worn || 0;
        const armorOther_worn = +v.armorother_worn || 0;
        const armorOther2_worn = +v.armorother2_worn || 0;
        const armorOther3_worn = +v.armorother3_worn || 0;
        const armorOther4_worn = +v.armorother4_worn || 0;
        const armorOther5_worn = +v.armorother5_worn || 0;
        const armorOther6_worn = +v.armorother6_worn || 0;
        // check encumbrance/bulk for DEX penalty
        const current_encumbrance_move = +v.current_encumbrance_move || 0;
        let armorBonusToggle = +v.armorbonus_toggle || 0;
        let armorBonus = +v.armorbonus || 0;
        let encumbranceConditionFlag = 0;
        // encumbered and has a DEX bonus
        if (current_encumbrance_move === 3 && armorBonus < 0) {
          armorBonusToggle = 0;
          armorBonus = 0;
          encumbranceConditionFlag = 1;
          // toggle off DEX only if there is a DEX bonus
        } else if (armorBonus < 0) {
          armorBonus = +v.armorbonus * armorBonusToggle || 0;
        } else {
          armorBonus = +v.armorbonus || 0;
        }
        output.encumbrance_flag = encumbranceConditionFlag;
        const unarmored_base = +v.unarmored_base || 0;
        const armorType_base = +v.armortype_base || 0;
        const armorType2_base = +v.armortype2_base || 0;
        const armorShield_base = +v.armorshield_base || 0;
        const armorOther_base = +v.armorother_base || 0;
        // must do the extra checks on these to ensure they are bonuses and not flat AC|AR values
        const armorOther2_base = v.armorother2_base >= 0 ? 0 : -Math.abs(v.armorother2_base) || 0;
        const armorOther3_base = v.armorother3_base >= 0 ? 0 : -Math.abs(v.armorother3_base) || 0;
        const armorOther4_base = v.armorother4_base >= 0 ? 0 : -Math.abs(v.armorother4_base) || 0;
        const armorOther5_base = v.armorother5_base >= 0 ? 0 : -Math.abs(v.armorother5_base) || 0;
        const armorOther6_base = v.armorother6_base >= 0 ? 0 : -Math.abs(v.armorother6_base) || 0;
        const unarmored_ac = +v.unarmored_ac || 0;
        const armorType_ac = +v.armortype_ac || 0;
        const armorType2_ac = +v.armortype2_ac || 0;
        const armorShield_ac = +v.armorshield_ac || 0;
        const armorOther_ac = +v.armorother_ac || 0;
        // must do the extra checks on these to ensure they are bonuses and not flat AC|AR values
        const armorOther2_ac = v.armorother2_ac >= 0 ? 0 : -Math.abs(v.armorother2_ac) || 0;
        const armorOther3_ac = v.armorother3_ac >= 0 ? 0 : -Math.abs(v.armorother3_ac) || 0;
        const armorOther4_ac = v.armorother4_ac >= 0 ? 0 : -Math.abs(v.armorother4_ac) || 0;
        const armorOther5_ac = v.armorother5_ac >= 0 ? 0 : -Math.abs(v.armorother5_ac) || 0;
        const armorOther6_ac = v.armorother6_ac >= 0 ? 0 : -Math.abs(v.armorother6_ac) || 0;
        const armorType_baseValue = armorType_worn ? armorType_base : 10;
        const armorType2_baseValue = armorType2_worn ? armorType2_base : 10;
        const armorShield_baseValue = armorShield_worn ? armorShield_base : 0;
        const armorOther_baseValue = armorOther_worn ? armorOther_base : 10;
        const armorOther2_baseValue = armorOther2_worn ? armorOther2_base : 0;
        const armorOther3_baseValue = armorOther3_worn ? armorOther3_base : 0;
        const armorOther4_baseValue = armorOther4_worn ? armorOther4_base : 0;
        const armorOther5_baseValue = armorOther5_worn ? armorOther5_base : 0;
        const armorOther6_baseValue = armorOther6_worn ? armorOther6_base : 0;
        const unArmored_baseValue = unarmored_worn ? unarmored_base : 10;
        const armorType_acValue = armorType_worn ? armorType_ac : 10;
        const armorType2_acValue = armorType2_worn ? armorType2_ac : 10;
        const armorShield_acValue = armorShield_worn ? armorShield_ac : 0;
        const armorOther_acValue = armorOther_worn ? armorOther_ac : 10;
        const armorOther2_acValue = armorOther2_worn ? armorOther2_ac : 0;
        const armorOther3_acValue = armorOther3_worn ? armorOther3_ac : 0;
        const armorOther4_acValue = armorOther4_worn ? armorOther4_ac : 0;
        const armorOther5_acValue = armorOther5_worn ? armorOther5_ac : 0;
        const armorOther6_acValue = armorOther6_worn ? armorOther6_ac : 0;
        const unArmored_acValue = unarmored_worn ? unarmored_ac : 10;
        const shieldModValue = armorShield_worn ? armorShield_mod : 0;
        const shieldMagicValue = armorShield_worn ? armorShield_magic : 0;
        const baseAR_best = int(
          Math.min(armorType_base, armorType2_base, armorOther_base, unarmored_base) +
            armorShield_base +
            armorOther2_base +
            armorOther3_base +
            armorOther4_base +
            armorOther5_base +
            armorOther6_base
        );
        const baseAC_best = int(
          Math.min(armorType_ac, armorType2_ac, armorOther_ac, unarmored_ac) + (armorShield_ac + armorOther2_ac + armorOther3_ac + armorOther4_ac + armorOther5_ac + armorOther6_ac)
        );
        const baseAR = int(
          Math.min(armorType_baseValue, armorType2_baseValue, armorOther_baseValue, unArmored_baseValue) +
            (armorShield_baseValue + armorOther2_baseValue + armorOther3_baseValue + armorOther4_baseValue + armorOther5_baseValue + armorOther6_baseValue)
        );
        const baseAC = int(
          Math.min(armorType_acValue, armorType2_acValue, armorOther_acValue, unArmored_acValue) +
            (armorOther2_acValue + armorOther3_acValue + armorOther4_acValue + armorOther5_acValue + armorOther6_acValue)
        );
        const armorMagicAC_total = int(
          armorType_magic +
            armorType2_magic +
            armorHelmet_magic +
            armorOther_magic +
            armorOther2_magic +
            armorOther3_magic +
            armorOther4_magic +
            armorOther5_magic +
            armorOther6_magic +
            armorShield_magic
        );
        const armorMagicAC = int(
          armorType_worn * armorType_magic +
            armorType2_worn * armorType2_magic +
            armorHelmet_worn * armorHelmet_magic +
            armorOther_worn * armorOther_magic +
            armorOther2_worn * armorOther2_magic +
            armorOther3_worn * armorOther3_magic +
            armorOther4_worn * armorOther4_magic +
            armorOther5_worn * armorOther5_magic +
            armorOther6_worn * armorOther6_magic
        );
        const armorModAC_total = int(armorOther_mod + armorOther2_mod + armorOther3_mod + armorOther4_mod + armorOther5_mod + armorOther6_mod + armorShield_mod) || 0;
        const armorModAC = int(
          armorOther_worn * armorOther_mod +
            armorOther2_worn * armorOther2_mod +
            armorOther3_worn * armorOther3_mod +
            armorOther4_worn * armorOther4_mod +
            armorOther5_worn * armorOther5_mod +
            armorOther6_worn * armorOther6_mod
        );
        const combinedModMagic = int(armorModAC + armorMagicAC);
        const rearAC = int(baseAC + armorModAC + armorMagicAC);
        const shieldlessAC = int(rearAC + armorBonus);
        const combinedShieldModMagic = int(armorShield_acValue + shieldModValue + shieldMagicValue);
        const totalAC = int(shieldlessAC + combinedShieldModMagic);
        // add a plus sign to result (n<=0?"":"+") + n
        const armorclass_magic_with_shield_add_sign = (-1 * (armorMagicAC + shieldMagicValue) <= 0 ? '' : '+') + -1 * (armorMagicAC + shieldMagicValue);
        const armorclass_magic_total_add_sign = (-1 * armorMagicAC_total <= 0 ? '' : '+') + -1 * armorMagicAC_total;
        const armorclass_mod_with_shield_add_sign = (-1 * (armorModAC + shieldModValue) <= 0 ? '' : '+') + -1 * (armorModAC + shieldModValue);
        const armorclass_mod_total_add_sign = (-1 * armorModAC_total <= 0 ? '' : '+') + -1 * armorModAC_total;
        const armorBonusInverted_add_sign = (-1 * armorBonus <= 0 ? '' : '+') + -1 * armorBonus;
        const armorclass_combined_mod_magic_add_sign = (-1 * combinedModMagic <= 0 ? '' : '+') + -1 * combinedModMagic;
        const combinedShieldModMagic_add_sign = (-1 * combinedShieldModMagic <= 0 ? '' : '+') + -1 * combinedShieldModMagic;
        output.armorclass_rating_used = baseAR;
        output.armorclass_rating = armorRatingFlag === 1 ? '-' : baseAR;
        output.armorclass_rating_best = baseAR_best;
        output.armorclass_base_used = baseAC + armorShield_acValue;
        output.armorclass_base = baseAC;
        output.armorclass_base_best = baseAC_best;
        output.armorclass_magic = armorMagicAC;
        output.armorclass_magic_with_shield = armorclass_magic_with_shield_add_sign;
        output.armorclass_magic_total = armorclass_magic_total_add_sign;
        output.armorclass_mod = armorModAC;
        output.armorclass_mod_with_shield = armorclass_mod_with_shield_add_sign;
        output.armorclass_mod_total = armorclass_mod_total_add_sign;
        output.armorclass_combined_mod_magic = combinedModMagic;
        output.armorclass_combined_mod_magic_inverted = armorclass_combined_mod_magic_add_sign;
        output.armorclass_rear = rearAC;
        output.armorbonus_inverted = armorBonusInverted_add_sign;
        output.armorclass_shieldless = shieldlessAC;
        output.armorclass_shield_magic = shieldMagicValue;
        output.armorclass_shield_mod = shieldModValue;
        output.armorclass_combined_shield_mod_magic = combinedShieldModMagic;
        output.armorclass_combined_shield_mod_magic_inverted = combinedShieldModMagic_add_sign;
        output.armorclass_total = totalAC;
        output.armorclass = syncAcFlag ? totalAC : armorClass;
        setAttrs(output, {silent: true});
      }
    );
  };

  on(
    'change:armor_details_show change:armor_rating_flag change:sync_ac_flag change:autocalc_ac change:unarmored change:armortype change:armortype2 change:armorshield change:armorhelmet change:armorother change:armorother2 change:armorother3 change:armorother4 change:armorother5 change:armorother6 change:armorclass_mod change:armorclass_magic change:armorbonus change:armorbonus_toggle change:unarmored_worn change:armortype_worn change:armortype2_worn change:armorshield_worn change:armorhelmet_worn change:armorother_worn change:armorother2_worn change:armorother3_worn change:armorother4_worn change:armorother5_worn change:armorother6_worn change:armortype_base change:armortype2_base change:armorshield_base change:armorother_base change:armorother2_base change:armorother3_base change:armorother4_base change:armorother5_base change:armorother6_base change:unarmored_base change:armortype_ac change:armortype2_ac change:armorshield_ac change:armorhelmet_ac change:armorother_ac change:armorother2_ac change:armorother3_ac change:armorother4_ac change:armorother5_ac change:armorother6_ac change:unarmored_ac change:armorshield_mod change:armorother_mod change:armorother2_mod change:armorother3_mod change:armorother4_mod change:armorother5_mod change:armorother6_mod change:armortype_magic change:armortype2_magic change:armorshield_magic change:armorhelmet_magic change:armorother_magic change:armorother2_magic change:armorother3_magic change:armorother4_magic change:armorother5_magic change:armorother6_magic',
    (eventInfo) => {
      // const thisEvent = eventInfo.sourceAttribute === undefined ? 'sheet opened' : eventInfo.sourceAttribute;
      const recalc = 0;
      // clog(`AC change detected by: ${eventInfo.sourceType}`);
      calcAC(recalc);
    }
  );

  on('clicked:calcac', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    const recalc = 1;
    calcAC(recalc);
  });

  damageMacro = (id) => {
    const output = {};
    output[`repeating_weapon_${id}_weapon_damagesmallmedium_chat_menu`] = `[Roll Damage](~@{character_id}|repeating_weapon_${id}_weapon_damagesmallmedium_roll)`;
    output[`repeating_weapon_${id}_weapon_damagelarge_chat_menu`] = `[Roll Damage vs LG](~@{character_id}|repeating_weapon_${id}_weapon_damagelarge_roll)`;
    output[`repeating_weapon_${id}_weapon_damagesmallmedium_npc_chat_menu`] = `[Damage](~@{character_id}|repeating_weapon_${id}_weapon_damagesmallmedium_npc_roll)`;
    output[`repeating_weapon_${id}_weapon_damagelarge_npc_chat_menu`] = `[Damage vs LG](~@{character_id}|repeating_weapon_${id}_weapon_damagelarge_npc_roll)`;
    output[`repeating_weapon_${id}_weapon_critdamagesmallmedium_chat_menu`] = `[Roll Damage](~@{character_id}|repeating_weapon_${id}_weapon_critdamagesmallmedium_roll)`;
    output[`repeating_weapon_${id}_weapon_critdamagelarge_chat_menu`] = `[Roll Damage vs LG](~@{character_id}|repeating_weapon_${id}_weapon_critdamagelarge_roll)`;
    output[`repeating_weapon_${id}_weapon_critdamagesmallmedium_npc_chat_menu`] = `[Damage](~@{character_id}|repeating_weapon_${id}_weapon_critdamagesmallmedium_npc_roll)`;
    output[`repeating_weapon_${id}_weapon_critdamagelarge_npc_chat_menu`] = `[Damage vs LG](~@{character_id}|repeating_weapon_${id}_weapon_critdamagelarge_npc_roll)`;
    setAttrs(output, {silent: true});
  };

  // Ensures Chat Menu Buttons have updated Damage Rolls
  on(
    'change:repeating_weapon:weapon_name change:repeating_weapon:weapon_damagesmallmedium change:repeating_weapon:weapon_damagelarge change:repeating_weapon:weapon_critdamagesmallmedium change:repeating_weapon:weapon_critdamagelarge change:repeating_weapon:weapon_attackdmgbonus change:repeating_weapon:weapon_critdamage_flag',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      const id = eventInfo.sourceAttribute.split('_')[2];
      damageMacro(id);
    }
  );

  on('change:toggle_critdamage', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapon', (idArray) => {
      const output = {};
      const fields = [];
      _.each(idArray, (id) => {
        fields.push(section_attribute('weapon', id, 'weapon_critdamage_flag'));
      });
      getAttrs(fields, (v) => {
        idArray.forEach((id) => {
          const currentValue = +v[section_attribute('weapon', id, 'weapon_critdamage_flag')];
          output[section_attribute('weapon', id, 'weapon_critdamage_flag')] = 1 - currentValue;
        });
        setAttrs(output);
      });
    });
  });

  function setWeapons(id) {
    const output = {};
    const fields = [
      section_attribute('weapon', id, 'weapon_use'),
      section_attribute('weapon', id, 'weapon_attack_type'),
      section_attribute('weapon', id, 'weapon_attack_type_flag'),
      section_attribute('weapon', id, 'weapon_critdamage_flag'),
      section_attribute('weapon', id, 'weapon_prof_pen'),
      section_attribute('weapon', id, 'weapon_range_error'),
      section_attribute('weapon', id, 'weapon_tohitacadj'),
      section_attribute('weapon', id, 'weapon_dual'),
      section_attribute('weapon', id, 'weapon_whisper_to_hit'),
      section_attribute('weapon', id, 'weapon_whisper_to_hit_select'),
      section_attribute('weapon', id, 'weapon_dual_pen'),
      section_attribute('weapon', id, 'weapon_backstab_var'),
      section_attribute('weapon', id, 'weapon_tohitbonus'),
      section_attribute('weapon', id, 'weapon_magicbonus'),
      section_attribute('weapon', id, 'weapon_prof'),
      section_attribute('weapon', id, 'weapon_backstab'),
      section_attribute('weapon', id, 'weapon_backstab_bonus'),
      section_attribute('weapon', id, 'weapon_backstab_mult'),
      section_attribute('weapon', id, 'weapon_attackdmgbonus'),
      section_attribute('weapon', id, 'weapon_num_attacks'),
      section_attribute('weapon', id, 'weapon_quantity'),
      section_attribute('weapon', id, 'weapon_ammo'),
      section_attribute('weapon', id, 'weapon_ammo_max'),
      section_attribute('weapon', id, 'weapon_weight'),
      section_attribute('weapon', id, 'weapon_cost'),
      section_attribute('weapon', id, 'weapon_range_short'),
      section_attribute('weapon', id, 'weapon_range_medium'),
      section_attribute('weapon', id, 'weapon_range_long'),
      section_attribute('weapon', id, 'weapon_length'),
      section_attribute('weapon', id, 'weapon_space'),
      section_attribute('weapon', id, 'weapon_speed'),
      section_attribute('weapon', id, 'weapon_thac_adj0'),
      section_attribute('weapon', id, 'weapon_thac_adj1'),
      section_attribute('weapon', id, 'weapon_thac_adj2'),
      section_attribute('weapon', id, 'weapon_thac_adj3'),
      section_attribute('weapon', id, 'weapon_thac_adj4'),
      section_attribute('weapon', id, 'weapon_thac_adj5'),
      section_attribute('weapon', id, 'weapon_thac_adj6'),
      section_attribute('weapon', id, 'weapon_thac_adj7'),
      section_attribute('weapon', id, 'weapon_thac_adj8'),
      section_attribute('weapon', id, 'weapon_thac_adj9'),
      section_attribute('weapon', id, 'weapon_thac_adj10'),
      section_attribute('weapon', id, 'weapon_macro_text'),
      section_attribute('weapon', id, 'weapon_damagesmallmedium_chat_menu'),
      section_attribute('weapon', id, 'weapon_damagelarge_chat_menu'),
      section_attribute('weapon', id, 'weapon_damagesmallmedium_npc_chat_menu'),
      section_attribute('weapon', id, 'weapon_damagelarge_npc_chat_menu'),
      section_attribute('weapon', id, 'weapon_critdamagesmallmedium_chat_menu'),
      section_attribute('weapon', id, 'weapon_critdamagelarge_chat_menu'),
      section_attribute('weapon', id, 'weapon_critdamagesmallmedium_npc_chat_menu'),
      section_attribute('weapon', id, 'weapon_critdamagelarge_npc_chat_menu'),
      section_attribute('weapon', id, 'weapon_damage_chat_menu_npc'),
    ];
    getAttrs(fields, (v) => {
      output.repeating_weapon_weapon_use = +v[section_attribute('weapon', id, 'weapon_use')] || 0;
      output.repeating_weapon_weapon_attack_type_flag = +v[section_attribute('weapon', id, 'weapon_attack_type_flag')] || 0;
      output.repeating_weapon_weapon_critdamage_flag = +v[section_attribute('weapon', id, 'weapon_critdamage_flag')] || 1;
      output.repeating_weapon_weapon_prof_pen = +v[section_attribute('weapon', id, 'weapon_prof_pen')] || 0;
      output.repeating_weapon_weapon_range_error = +v[section_attribute('weapon', id, 'weapon_range_error')] || 1;
      output.repeating_weapon_weapon_tohitacadj = +v[section_attribute('weapon', id, 'weapon_tohitacadj')] || 1;
      output.repeating_weapon_weapon_attack_type = +v[section_attribute('weapon', id, 'weapon_attack_type')] || 0;
      output.repeating_weapon_weapon_dual = v[section_attribute('weapon', id, 'weapon_dual')];
      output.repeating_weapon_weapon_whisper_to_hit = v[section_attribute('weapon', id, 'weapon_whisper_to_hit')];
      output.repeating_weapon_weapon_whisper_to_hit_select = +v[section_attribute('weapon', id, 'weapon_whisper_to_hit_select')] || 0;
      output.repeating_weapon_weapon_dual_pen = +v[section_attribute('weapon', id, 'weapon_dual_pen')] || 0;
      output.repeating_weapon_weapon_backstab_var = +v[section_attribute('weapon', id, 'weapon_backstab_var')] || 0;
      output.repeating_weapon_weapon_tohitbonus = +v[section_attribute('weapon', id, 'weapon_tohitbonus')] || 0;
      output.repeating_weapon_weapon_magicbonus = +v[section_attribute('weapon', id, 'weapon_magicbonus')] || 0;
      output.repeating_weapon_weapon_prof = +v[section_attribute('weapon', id, 'weapon_prof')] || 0;
      output.repeating_weapon_weapon_backstab = +v[section_attribute('weapon', id, 'weapon_backstab')] || 0;
      output.repeating_weapon_weapon_backstab_bonus = +v[section_attribute('weapon', id, 'weapon_backstab_bonus')] || 0;
      output.repeating_weapon_weapon_backstab_mult = +v[section_attribute('weapon', id, 'weapon_backstab_mult')] || 0;
      output.repeating_weapon_weapon_attackdmgbonus = +v[section_attribute('weapon', id, 'weapon_attackdmgbonus')] || 0;
      output.repeating_weapon_weapon_num_attacks = +v[section_attribute('weapon', id, 'weapon_num_attacks')] || 0;
      output.repeating_weapon_weapon_quantity = +v[section_attribute('weapon', id, 'weapon_quantity')] || 0;
      output.repeating_weapon_weapon_ammo = +v[section_attribute('weapon', id, 'weapon_ammo')] || 0;
      output.repeating_weapon_weapon_ammo_max = +v[section_attribute('weapon', id, 'weapon_ammo_max')] || 0;
      output.repeating_weapon_weapon_weight = +v[section_attribute('weapon', id, 'weapon_weight')] || 0;
      output.repeating_weapon_weapon_cost = +v[section_attribute('weapon', id, 'weapon_cost')] || 0;
      output.repeating_weapon_weapon_range_short = +v[section_attribute('weapon', id, 'weapon_range_short')] || 0;
      output.repeating_weapon_weapon_range_medium = +v[section_attribute('weapon', id, 'weapon_range_medium')] || 0;
      output.repeating_weapon_weapon_range_long = +v[section_attribute('weapon', id, 'weapon_range_long')] || 0;
      output.repeating_weapon_weapon_length = v[section_attribute('weapon', id, 'weapon_length')];
      output.repeating_weapon_weapon_space = v[section_attribute('weapon', id, 'weapon_space')];
      output.repeating_weapon_weapon_speed = v[section_attribute('weapon', id, 'weapon_speed')];
      output.repeating_weapon_weapon_thac_adj0 = +v[section_attribute('weapon', id, 'weapon_thac_adj0')] || 0;
      output.repeating_weapon_weapon_thac_adj1 = +v[section_attribute('weapon', id, 'weapon_thac_adj1')] || 0;
      output.repeating_weapon_weapon_thac_adj2 = +v[section_attribute('weapon', id, 'weapon_thac_adj2')] || 0;
      output.repeating_weapon_weapon_thac_adj3 = +v[section_attribute('weapon', id, 'weapon_thac_adj3')] || 0;
      output.repeating_weapon_weapon_thac_adj4 = +v[section_attribute('weapon', id, 'weapon_thac_adj4')] || 0;
      output.repeating_weapon_weapon_thac_adj5 = +v[section_attribute('weapon', id, 'weapon_thac_adj5')] || 0;
      output.repeating_weapon_weapon_thac_adj6 = +v[section_attribute('weapon', id, 'weapon_thac_adj6')] || 0;
      output.repeating_weapon_weapon_thac_adj7 = +v[section_attribute('weapon', id, 'weapon_thac_adj7')] || 0;
      output.repeating_weapon_weapon_thac_adj8 = +v[section_attribute('weapon', id, 'weapon_thac_adj8')] || 0;
      output.repeating_weapon_weapon_thac_adj9 = +v[section_attribute('weapon', id, 'weapon_thac_adj9')] || 0;
      output.repeating_weapon_weapon_thac_adj10 = +v[section_attribute('weapon', id, 'weapon_thac_adj10')] || 0;
      output.repeating_weapon_weapon_macro_text = v[section_attribute('weapon', id, 'weapon_macro_text')];
      output.repeating_weapon_weapon_damagesmallmedium_chat_menu = v[section_attribute('weapon', id, 'weapon_damagesmallmedium_chat_menu')];
      output.repeating_weapon_weapon_damagelarge_chat_menu = v[section_attribute('weapon', id, 'weapon_damagelarge_chat_menu')];
      output.repeating_weapon_weapon_damagesmallmedium_npc_chat_menu = v[section_attribute('weapon', id, 'weapon_damagesmallmedium_npc_chat_menu')];
      output.repeating_weapon_weapon_damagelarge_npc_chat_menu = v[section_attribute('weapon', id, 'weapon_damagelarge_npc_chat_menu')];
      output.repeating_weapon_weapon_critdamagesmallmedium_chat_menu = v[section_attribute('weapon', id, 'weapon_critdamagesmallmedium_chat_menu')];
      output.repeating_weapon_weapon_critdamagelarge_chat_menu = v[section_attribute('weapon', id, 'weapon_critdamagelarge_chat_menu')];
      output.repeating_weapon_weapon_critdamagesmallmedium_npc_chat_menu = v[section_attribute('weapon', id, 'weapon_critdamagesmallmedium_npc_chat_menu')];
      output.repeating_weapon_weapon_critdamagelarge_npc_chat_menu = v[section_attribute('weapon', id, 'weapon_critdamagelarge_npc_chat_menu')];
      output.repeating_weapon_weapon_damage_chat_menu_npc = v[section_attribute('weapon', id, 'weapon_damage_chat_menu_npc')];
      setAttrs(output, {silent: true});
    });
  }

  function setEquipment(id) {
    const output = {};
    const nonRep = ['equipment_tabs_type', 'equipment_tabs_carry'];
    const fields = [
      section_attribute('equipment', id, 'equipment_type'),
      section_attribute('equipment', id, 'equipment_show_type'),
      section_attribute('equipment', id, 'equipment_show_carry'),
      section_attribute('equipment', id, 'equipment_current'),
      section_attribute('equipment', id, 'equipment_current_max'),
      section_attribute('equipment', id, 'equipment_carried_select'),
      section_attribute('equipment', id, 'equipment_carried'),
      section_attribute('equipment', id, 'equipment_quantity'),
      section_attribute('equipment', id, 'equipment_quantity_max'),
      section_attribute('equipment', id, 'equipment_weight'),
      section_attribute('equipment', id, 'equipment_cost'),
      section_attribute('equipment', id, 'equipment_armor_type'),
      section_attribute('equipment', id, 'equipment_armor_worn'),
      section_attribute('equipment', id, 'equipment_armor_ac'),
      section_attribute('equipment', id, 'equipment_armor_base'),
      section_attribute('equipment', id, 'equipment_armor_magic'),
      section_attribute('equipment', id, 'equipment_armor_mod'),
      section_attribute('equipment', id, 'equipment_armor_bulk'),
      section_attribute('equipment', id, 'equipment_macro_text'),
      section_attribute('equipment', id, 'equipment_weapon_type'),
      section_attribute('equipment', id, 'equipment_weapon_speed'),
      section_attribute('equipment', id, 'equipment_weapon_length'),
      section_attribute('equipment', id, 'equipment_weapon_space'),
      section_attribute('equipment', id, 'equipment_weapon_damagesmallmedium'),
      section_attribute('equipment', id, 'equipment_weapon_damagelarge'),
      section_attribute('equipment', id, 'equipment_weapon_attackdmgtype'),
      section_attribute('equipment', id, 'equipment_weapon_rateoffire'),
      section_attribute('equipment', id, 'equipment_weapon_range'),
    ];
    const combined = [...nonRep, ...fields];
    getAttrs(combined, (v) => {
      const equipTab = +v.equipment_tabs_type || 0;
      const equipType = +v[section_attribute('equipment', id, 'equipment_type')] || 0;
      clog(`equipType:${equipType}`);
      output.repeating_equipment_equipment_type = equipType <= 0 || equipTab === -1 ? 0 : equipType;
      output.repeating_equipment_equipment_show_type = +v[section_attribute('equipment', id, 'equipment_show_type')] || 0;
      output.repeating_equipment_equipment_current = +v[section_attribute('equipment', id, 'equipment_current')] || 0;
      output.repeating_equipment_equipment_current_max = +v[section_attribute('equipment', id, 'equipment_current_max')] || 0;
      output.repeating_equipment_equipment_carried_select = +v[section_attribute('equipment', id, 'equipment_carried_select')] || 1;
      output.repeating_equipment_equipment_carried = +v[section_attribute('equipment', id, 'equipment_carried')] || 1;
      output.repeating_equipment_equipment_quantity = +v[section_attribute('equipment', id, 'equipment_quantity')] || 1;
      output.repeating_equipment_equipment_quantity_max = +v[section_attribute('equipment', id, 'equipment_quantity_max')] || 1;
      output.repeating_equipment_equipment_weight = +v[section_attribute('equipment', id, 'equipment_weight')] || 0;
      output.repeating_equipment_equipment_cost = +v[section_attribute('equipment', id, 'equipment_cost')] || 0;
      output.repeating_equipment_equipment_armor_type = +v[section_attribute('equipment', id, 'equipment_armor_type')] || 0;
      output.repeating_equipment_equipment_armor_worn = +v[section_attribute('equipment', id, 'equipment_armor_worn')] || 0;
      output.repeating_equipment_equipment_armor_ac = +v[section_attribute('equipment', id, 'equipment_armor_ac')] || 0;
      output.repeating_equipment_equipment_armor_base = +v[section_attribute('equipment', id, 'equipment_armor_base')] || 0;
      output.repeating_equipment_equipment_armor_magic = +v[section_attribute('equipment', id, 'equipment_armor_magic')] || 0;
      output.repeating_equipment_equipment_armor_mod = +v[section_attribute('equipment', id, 'equipment_armor_mod')] || 0;
      output.repeating_equipment_equipment_armor_bulk = +v[section_attribute('equipment', id, 'equipment_armor_bulk')] || 0;
      output.repeating_equipment_equipment_macro_text = v[section_attribute('equipment', id, 'equipment_macro_text')];
      output.repeating_equipment_equipment_weapon_type = +v[section_attribute('equipment', id, 'equipment_weapon_type')] || 0;
      output.repeating_equipment_equipment_weapon_speed = v[section_attribute('equipment', id, 'equipment_weapon_speed')];
      output.repeating_equipment_equipment_weapon_length = v[section_attribute('equipment', id, 'equipment_weapon_length')];
      output.repeating_equipment_equipment_weapon_space = v[section_attribute('equipment', id, 'equipment_weapon_space')];
      output.repeating_equipment_equipment_weapon_damagesmallmedium = v[section_attribute('equipment', id, 'equipment_weapon_damagesmallmedium')];
      output.repeating_equipment_equipment_weapon_damagelarge = v[section_attribute('equipment', id, 'equipment_weapon_damagelarge')];
      output.repeating_equipment_equipment_weapon_attackdmgtype = v[section_attribute('equipment', id, 'equipment_weapon_attackdmgtype')];
      output.repeating_equipment_equipment_weapon_rateoffire = v[section_attribute('equipment', id, 'equipment_weapon_rateoffire')];
      output.repeating_equipment_equipment_weapon_range = v[section_attribute('equipment', id, 'equipment_weapon_range')];
      setAttrs(output, {silent: true});
    });
  }

  // Set repeating attr values for new rows. Makes visible to API
  on('change:repeating_weapon:weapon_name change:repeating_equipment:equipment_item', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    const id = eventInfo.sourceAttribute.split('_')[2];
    // test if API is creating the repeating row and bail
    if (eventInfo.sourceType !== 'player') return;
    if (eventInfo.newValue !== eventInfo.previousValue) return;
    // test for new row name (ie no existing value)
    if (eventInfo.sourceAttribute.includes('equipment_item')) {
      // clog(`new ${eventInfo.sourceAttribute.match(/^[^_]+_[^_]+/)[0]} row added. Setting default values.`);
      setEquipment(id);
    }
    if (eventInfo.sourceAttribute.includes('weapon_name')) {
      // clog(`new ${eventInfo.sourceAttribute.match(/^[^_]+_[^_]+/)[0]} row added. Setting default values.`);
      setWeapons(id);
    }
  });

  // Auto-generates a repeating row as a placeholder
  on('sheet:opened', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    getSectionIDs('repeating_weapon', (weaponID) => {
      getSectionIDs('repeating_ability', (abilityID) => {
        getSectionIDs('repeating_nonweaponproficiencies', (nwpID) => {
          getSectionIDs('repeating_equipment', (equipmentID) => {
            getSectionIDs('repeating_spells', (spellsID) => {
              const output = {};
              const weaponRows = weaponID.length;
              const abilityRows = abilityID.length;
              const nwpRows = nwpID.length;
              const equipmentRows = equipmentID.length;
              const spellsRows = spellsID.length;
              if (weaponRows === 0) {
                const newrowid = generateUniqueRowID();
                output[`repeating_weapon_${newrowid}_weapon_value`] = 1;
              }
              if (abilityRows === 0) {
                const newrowid = generateUniqueRowID();
                output[`repeating_ability_${newrowid}_ability_value`] = 1;
              }
              if (nwpRows === 0) {
                const newrowid = generateUniqueRowID();
                output[`repeating_nonweaponproficiencies_${newrowid}_nwp_value`] = 1;
              }
              if (equipmentRows === 0) {
                const newrowid = generateUniqueRowID();
                output[`repeating_equipment_${newrowid}_equipment_value`] = 1;
              }
              if (spellsRows === 0) {
                const newrowid = generateUniqueRowID();
                output[`repeating_spells_${newrowid}_spell_value`] = 1;
              } else {
                return;
              }
              setAttrs(output, {silent: true});
            });
          });
        });
      });
    });
  });

  // Reset Macros to default
  on('clicked:resetallmacros clicked:resetequipmentmacros clicked:resetweaponsmacros clicked:resetabilitiesmacros clicked:resetnwpsmacros clicked:resetspellsmacros', (eventInfo) => {
    const eventTrigger = eventInfo.triggerName;
    // Use a regular expression to match and capture the word after "clicked:"
    const match = eventTrigger.match(/clicked:(\w+)/);
    // Check if there is a match and extract the captured word
    const clickedWord = match ? match[1] : null;
    // clog(`Change Detected:${JSON.stringify(eventInfo)}`);
    // clog(`reset macros detected: ${clickedWord}`);
    getSectionIDs('repeating_equipment', (idequipment) => {
      getSectionIDs('repeating_weapon', (idweapons) => {
        getSectionIDs('repeating_ability', (idabilities) => {
          getSectionIDs('repeating_nonweaponproficiencies', (idnwps) => {
            getSectionIDs('repeating_spells', (idspells) => {
              const output = {};
              const attrsEquipment = [];
              const attrsWeapon = [];
              const attrsAbility = [];
              const attrsNWP = [];
              const attrsSpells = [];
              _.each(idequipment, (itemid) => {
                attrsEquipment.push(`repeating_equipment_${itemid}_equipment_macro_text`);
              });
              _.each(idweapons, (itemid) => {
                attrsWeapon.push(`repeating_weapon_${itemid}_weapon_macro_text`);
              });
              _.each(idabilities, (itemid) => {
                attrsAbility.push(`repeating_ability_${itemid}_ability_macro_text`);
              });
              _.each(idnwps, (itemid) => {
                attrsNWP.push(`repeating_nonweaponproficiencies_${itemid}_nwp_macro_text`);
              });
              _.each(idspells, (itemid) => {
                attrsSpells.push(`repeating_spells_${itemid}_spell_macro_text`);
              });

              if (clickedWord === 'resetallmacros') {
                output.surprise_macro_text = '';
                output.surprise_others_macro_text = '';
                output.init_macro_text = '';
                _.each(idequipment, (id) => {
                  output[`repeating_equipment_${id}_equipment_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsEquipment}`);
                });
                _.each(idweapons, (id) => {
                  output[`repeating_weapon_${id}_weapon_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsWeapon}`);
                });
                _.each(idabilities, (id) => {
                  output[`repeating_ability_${id}_ability_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsAbility}`);
                });
                _.each(idnwps, (id) => {
                  output[`repeating_nonweaponproficiencies_${id}_nwp_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsNWP}`);
                });
                _.each(idspells, (id) => {
                  output[`repeating_spells_${id}_spell_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsSpells}`);
                });
              }
              if (clickedWord === 'resetequipmentmacros') {
                _.each(idequipment, (id) => {
                  output[`repeating_equipment_${id}_equipment_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsEquipment}`);
                });
              }
              if (clickedWord === 'resetweaponsmacros') {
                _.each(idweapons, (id) => {
                  output[`repeating_weapon_${id}_weapon_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsWeapon}`);
                });
              }
              if (clickedWord === 'resetabilitiesmacros') {
                _.each(idabilities, (id) => {
                  output[`repeating_ability_${id}_ability_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsAbility}`);
                });
              }
              if (clickedWord === 'resetnwpsmacros') {
                _.each(idnwps, (id) => {
                  output[`repeating_nonweaponproficiencies_${id}_nwp_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsNWP}`);
                });
              }
              if (clickedWord === 'resetspellsmacros') {
                _.each(idspells, (id) => {
                  output[`repeating_spells_${id}_spell_macro_text`] = '';
                  // clog(`macro reset completed on: ${attrsSpells}`);
                });
              }
              setAttrs(output, {silent: true});
            });
          });
        });
      });
    });
  });

  // Thief Calcs
  pickpocketsCalc = (migrate) => {
    getAttrs(['pickpockets', 'pickpockets_base', 'pickpockets_racial_mod', 'pickpockets_ability_mod', 'pickpockets_magic'], (v) => {
      const output = {};
      const basePickpockets = +v.pickpockets_base || 0;
      const racialPickpockets = +v.pickpockets_racial_mod || 0;
      const abilityPickpockets = +v.pickpockets_ability_mod || 0;
      const magicPickpockets = +v.pickpockets_magic || 0;
      const oldSkill = +v.pickpockets || 0;
      const newSkill = Math.max(0, int(basePickpockets + racialPickpockets + abilityPickpockets + magicPickpockets));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.pickpockets_base = oldSkill;
          // clog('Old pickpockets copied to Base/Class column');
        } else {
          output.pickpockets = newSkill;
        }
      } else {
        output.pickpockets = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  openlocksCalc = (migrate) => {
    getAttrs(['openlocks', 'openlocks_base', 'openlocks_racial_mod', 'openlocks_ability_mod', 'openlocks_magic'], (v) => {
      const output = {};
      const baseOpenlocks = +v.openlocks_base || 0;
      const racialOpenlocks = +v.openlocks_racial_mod || 0;
      const abilityOpenlocks = +v.openlocks_ability_mod || 0;
      const magicOpenlocks = +v.openlocks_magic || 0;
      const oldSkill = +v.openlocks || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseOpenlocks + racialOpenlocks + abilityOpenlocks + magicOpenlocks)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.openlocks_base = oldSkill;
          // clog('Old openlocks copied to Base/Class column');
        } else {
          output.openlocks = newSkill;
        }
      } else {
        output.openlocks = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  findtrapsCalc = (migrate) => {
    getAttrs(['findtraps', 'findtraps_base', 'findtraps_racial_mod', 'findtraps_ability_mod', 'findtraps_magic'], (v) => {
      const output = {};
      const baseFindtraps = +v.findtraps_base || 0;
      const racialFindtraps = +v.findtraps_racial_mod || 0;
      const abilityFindtraps = +v.findtraps_ability_mod || 0;
      const magicFindtraps = +v.findtraps_magic || 0;
      const oldSkill = +v.findtraps || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseFindtraps + racialFindtraps + abilityFindtraps + magicFindtraps)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.findtraps_base = oldSkill;
          // clog('Old findtraps copied to Base/Class column');
        } else {
          output.findtraps = newSkill;
        }
      } else {
        output.findtraps = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  movequietlyCalc = (migrate) => {
    getAttrs(['movequietly', 'movequietly_base', 'movequietly_racial_mod', 'movequietly_ability_mod', 'movequietly_magic'], (v) => {
      const output = {};
      const baseMovequietly = +v.movequietly_base || 0;
      const racialMovequietly = +v.movequietly_racial_mod || 0;
      const abilityMovequietly = +v.movequietly_ability_mod || 0;
      const magicMovequietly = +v.movequietly_magic || 0;
      const oldSkill = +v.movequietly || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseMovequietly + racialMovequietly + abilityMovequietly + magicMovequietly)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.movequietly_base = oldSkill;
          // clog('Old movequietly copied to Base/Class column');
        } else {
          output.movequietly = newSkill;
        }
      } else {
        output.movequietly = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  hideinshadowsCalc = (migrate) => {
    getAttrs(['hideinshadows', 'hideinshadows_base', 'hideinshadows_racial_mod', 'hideinshadows_ability_mod', 'hideinshadows_magic'], (v) => {
      const output = {};
      const baseHideinshadows = +v.hideinshadows_base || 0;
      const racialHideinshadows = +v.hideinshadows_racial_mod || 0;
      const abilityHideinshadows = +v.hideinshadows_ability_mod || 0;
      const magicHideinshadows = +v.hideinshadows_magic || 0;
      const oldSkill = +v.hideinshadows || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseHideinshadows + racialHideinshadows + abilityHideinshadows + magicHideinshadows)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.hideinshadows_base = oldSkill;
          // clog('Old hideinshadows copied to Base/Class column');
        } else {
          output.hideinshadows = newSkill;
        }
      } else {
        output.hideinshadows = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  hearnoiseCalc = (migrate) => {
    getAttrs(['hearnoise', 'hearnoise_base', 'hearnoise_racial_mod', 'hearnoise_ability_mod', 'hearnoise_magic'], (v) => {
      const output = {};
      const baseHearnoise = +v.hearnoise_base || 0;
      const racialHearnoise = +v.hearnoise_racial_mod || 0;
      const abilityHearnoise = +v.hearnoise_ability_mod || 0;
      const magicHearnoise = +v.hearnoise_magic || 0;
      const oldSkill = +v.hearnoise || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseHearnoise + racialHearnoise + abilityHearnoise + magicHearnoise)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.hearnoise_base = oldSkill;
          // clog('Old hearnoise copied to Base/Class column');
        } else {
          output.hearnoise = newSkill;
        }
      } else {
        output.hearnoise = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  climbwallsCalc = (migrate) => {
    getAttrs(['climbwalls', 'climbwalls_base', 'climbwalls_racial_mod', 'climbwalls_ability_mod', 'climbwalls_magic'], (v) => {
      const output = {};
      const baseClimbwalls = +v.climbwalls_base || 0;
      const racialClimbwalls = +v.climbwalls_racial_mod || 0;
      const abilityClimbwalls = +v.climbwalls_ability_mod || 0;
      const magicClimbwalls = +v.climbwalls_magic || 0;
      const oldSkill = +v.climbwalls || 0;
      const newSkill = Math.max(0, Math.min(100, float(baseClimbwalls).toFixed(1) + int(racialClimbwalls + abilityClimbwalls + magicClimbwalls)));
      const macroNormal =
        '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Climb Walls}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{climbwalls} ]]%}}';
      const macroExceptional =
        '@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Climb Walls}} {{roll_low=[[ 1d100 + [[1d10/10]] ]]%}} {{roll_target=[[ @{climbwalls} ]]%}}';
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.climbwalls_base = oldSkill;
          // clog('Old climbwalls copied to Base/Class column');
        } else {
          output.climbwalls = newSkill;
        }
      } else {
        output.climbwalls = newSkill;
        output.climbwalls_macro_text = newSkill >= 99.1 ? macroExceptional : macroNormal;
      }
      setAttrs(output, {silent: true});
    });
  };

  readlanguagesCalc = (migrate) => {
    getAttrs(['readlanguages', 'readlanguages_base', 'readlanguages_racial_mod', 'readlanguages_ability_mod', 'readlanguages_magic'], (v) => {
      const output = {};
      const baseReadlanguages = +v.readlanguages_base || 0;
      const racialReadlanguages = +v.readlanguages_racial_mod || 0;
      const abilityReadlanguages = +v.readlanguages_ability_mod || 0;
      const magicReadlanguages = +v.readlanguages_magic || 0;
      const oldSkill = +v.readlanguages || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseReadlanguages + racialReadlanguages + abilityReadlanguages + magicReadlanguages)));
      // clog(`oldThiefSkill: ${oldSkill} newThiefSkill: ${newSkill}`);
      if (migrate === 1) {
        if (oldSkill >= 0 && newSkill === 0) {
          output.readlanguages_base = oldSkill;
          // clog('Old readlanguages copied to Base/Class column');
        } else {
          output.readlanguages = newSkill;
        }
      } else {
        output.readlanguages = newSkill;
      }
      setAttrs(output, {silent: true});
    });
  };

  thiefmiscCalc = () => {
    getAttrs(['thiefmisc', 'thiefmisc_base', 'thiefmisc_racial_mod', 'thiefmisc_ability_mod', 'thiefmisc_magic'], (v) => {
      const output = {};
      const baseThiefmisc = +v.thiefmisc_base || 0;
      const racialThiefmisc = +v.thiefmisc_racial_mod || 0;
      const abilityThiefmisc = +v.thiefmisc_ability_mod || 0;
      const magicThiefmisc = +v.thiefmisc_magic || 0;
      // const oldSkill = +v.thiefmisc || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseThiefmisc + racialThiefmisc + abilityThiefmisc + magicThiefmisc)));
      output.thiefmisc = newSkill;
      setAttrs(output, {silent: true});
    });
  };

  thiefmisc1Calc = () => {
    getAttrs(['thiefmisc1', 'thiefmisc1_base', 'thiefmisc1_racial_mod', 'thiefmisc1_ability_mod', 'thiefmisc1_magic'], (v) => {
      const output = {};
      const baseThiefmisc1 = +v.thiefmisc1_base || 0;
      const racialThiefmisc1 = +v.thiefmisc1_racial_mod || 0;
      const abilityThiefmisc1 = +v.thiefmisc1_ability_mod || 0;
      const magicThiefmisc1 = +v.thiefmisc1_magic || 0;
      // const oldSkill = +v.thiefmisc1 || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseThiefmisc1 + racialThiefmisc1 + abilityThiefmisc1 + magicThiefmisc1)));
      output.thiefmisc1 = newSkill;
      setAttrs(output, {silent: true});
    });
  };

  thiefmisc2Calc = () => {
    getAttrs(['thiefmisc2', 'thiefmisc2_base', 'thiefmisc2_racial_mod', 'thiefmisc2_ability_mod', 'thiefmisc2_magic'], (v) => {
      const output = {};
      const baseThiefmisc2 = +v.thiefmisc2_base || 0;
      const racialThiefmisc2 = +v.thiefmisc2_racial_mod || 0;
      const abilityThiefmisc2 = +v.thiefmisc2_ability_mod || 0;
      const magicThiefmisc2 = +v.thiefmisc2_magic || 0;
      // const oldSkill = +v.thiefmisc2 || 0;
      const newSkill = Math.max(0, Math.min(100, int(baseThiefmisc2 + racialThiefmisc2 + abilityThiefmisc2 + magicThiefmisc2)));
      output.thiefmisc2 = newSkill;
      setAttrs(output, {silent: true});
    });
  };

  on('change:pickpockets_base change:pickpockets_racial_mod change:pickpockets_ability_mod change:pickpockets_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    pickpocketsCalc();
  });
  on('change:openlocks_base change:openlocks_racial_mod change:openlocks_ability_mod change:openlocks_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    openlocksCalc();
  });
  on('change:findtraps_base change:findtraps_racial_mod change:findtraps_ability_mod change:findtraps_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    findtrapsCalc();
  });
  on('change:movequietly_base change:movequietly_racial_mod change:movequietly_ability_mod change:movequietly_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    movequietlyCalc();
  });
  on('change:hideinshadows_base change:hideinshadows_racial_mod change:hideinshadows_ability_mod change:hideinshadows_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    hideinshadowsCalc();
  });
  on('change:hearnoise_base change:hearnoise_racial_mod change:hearnoise_ability_mod change:hearnoise_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    hearnoiseCalc();
  });
  on('change:climbwalls_base change:climbwalls_racial_mod change:climbwalls_ability_mod change:climbwalls_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    climbwallsCalc();
  });
  on('change:readlanguages_base change:readlanguages_racial_mod change:readlanguages_ability_mod change:readlanguages_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    readlanguagesCalc();
  });
  on('change:thiefmisc_base change:thiefmisc_racial_mod change:thiefmisc_ability_mod change:thiefmisc_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    thiefmiscCalc();
  });
  on('change:thiefmisc1_base change:thiefmisc1_racial_mod change:thiefmisc1_ability_mod change:thiefmisc1_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    thiefmisc1Calc();
  });
  on('change:thiefmisc2_base change:thiefmisc2_racial_mod change:thiefmisc2_ability_mod change:thiefmisc2_magic', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    thiefmisc2Calc();
  });

  // Save Calcs
  saveparalysispoisondeathCalc = (migrate) => {
    getAttrs(
      [
        'saveparalysispoisondeath',
        'saveparalysispoisondeath_base',
        'saveparalysispoisondeath_racial_mod',
        'saveparalysispoisondeath_ability_mod',
        'saveparalysispoisondeath_misc_mod',
        'saveparalysispoisondeath_temp_mod',
      ],
      (v) => {
        const output = {};
        const baseSaveparalysispoisondeath = +v.saveparalysispoisondeath_base || 0;
        const racialSaveparalysispoisondeath = +v.saveparalysispoisondeath_racial_mod || 0;
        const abilitySaveparalysispoisondeath = +v.saveparalysispoisondeath_ability_mod || 0;
        const miscSaveparalysispoisondeath = +v.saveparalysispoisondeath_misc_mod || 0;
        const tempSaveparalysispoisondeath = +v.saveparalysispoisondeath_temp_mod || 0;
        const oldSave = +v.saveparalysispoisondeath || 0;
        const newSave = int(
          baseSaveparalysispoisondeath + racialSaveparalysispoisondeath + abilitySaveparalysispoisondeath + miscSaveparalysispoisondeath + tempSaveparalysispoisondeath
        );
        // clog(`oldSave: ${oldSave} newSave: ${newSave}`);
        if (migrate === 1) {
          if (oldSave <= 20 && newSave === 20) {
            output.saveparalysispoisondeath_base = oldSave;
            // clog('Old saveparalysispoisondeath copied to Base/Class column');
          } else {
            output.saveparalysispoisondeath = newSave;
          }
        } else {
          output.saveparalysispoisondeath = newSave;
        }
        setAttrs(output, {silent: true});
      }
    );
  };

  savepetrificationpolymorphCalc = (migrate) => {
    getAttrs(
      [
        'savepetrificationpolymorph',
        'savepetrificationpolymorph_base',
        'savepetrificationpolymorph_racial_mod',
        'savepetrificationpolymorph_ability_mod',
        'savepetrificationpolymorph_misc_mod',
        'savepetrificationpolymorph_temp_mod',
      ],
      (v) => {
        const output = {};
        const baseSavepetrificationpolymorph = +v.savepetrificationpolymorph_base || 0;
        const racialSavepetrificationpolymorph = +v.savepetrificationpolymorph_racial_mod || 0;
        const abilitySavepetrificationpolymorph = +v.savepetrificationpolymorph_ability_mod || 0;
        const miscSavepetrificationpolymorph = +v.savepetrificationpolymorph_misc_mod || 0;
        const tempSavepetrificationpolymorph = +v.savepetrificationpolymorph_temp_mod || 0;
        const oldSave = +v.savepetrificationpolymorph || 0;
        const newSave = int(
          baseSavepetrificationpolymorph + racialSavepetrificationpolymorph + abilitySavepetrificationpolymorph + miscSavepetrificationpolymorph + tempSavepetrificationpolymorph
        );
        // clog(`oldSave: ${oldSave} newSave: ${newSave}`);
        if (migrate === 1) {
          if (oldSave <= 20 && newSave === 20) {
            output.savepetrificationpolymorph_base = oldSave;
            // clog('Old savepetrificationpolymorph copied to Base/Class column');
          } else {
            output.savepetrificationpolymorph = newSave;
          }
        } else {
          output.savepetrificationpolymorph = newSave;
        }
        setAttrs(output, {silent: true});
      }
    );
  };

  saverodsstaveswandsCalc = (migrate) => {
    getAttrs(
      [
        'saverodsstaveswands',
        'saverodsstaveswands_base',
        'saverodsstaveswands_racial_mod',
        'saverodsstaveswands_ability_mod',
        'saverodsstaveswands_misc_mod',
        'saverodsstaveswands_temp_mod',
      ],
      (v) => {
        const output = {};
        const baseSaverodsstaveswands = +v.saverodsstaveswands_base || 0;
        const racialSaverodsstaveswands = +v.saverodsstaveswands_racial_mod || 0;
        const abilitySaverodsstaveswands = +v.saverodsstaveswands_ability_mod || 0;
        const miscSaverodsstaveswands = +v.saverodsstaveswands_misc_mod || 0;
        const tempSaverodsstaveswands = +v.saverodsstaveswands_temp_mod || 0;
        const oldSave = +v.saverodsstaveswands || 0;
        const newSave = int(baseSaverodsstaveswands + racialSaverodsstaveswands + abilitySaverodsstaveswands + miscSaverodsstaveswands + tempSaverodsstaveswands);
        // clog(`oldSave: ${oldSave} newSave: ${newSave}`);
        if (migrate === 1) {
          if (oldSave <= 20 && newSave === 20) {
            output.saverodsstaveswands_base = oldSave;
            // clog('Old saverodsstaveswands copied to Base/Class column');
          } else {
            output.saverodsstaveswands = newSave;
          }
        } else {
          output.saverodsstaveswands = newSave;
        }
        setAttrs(output, {silent: true});
      }
    );
  };

  savebreathweaponsCalc = (migrate) => {
    getAttrs(
      ['savebreathweapons', 'savebreathweapons_base', 'savebreathweapons_racial_mod', 'savebreathweapons_ability_mod', 'savebreathweapons_misc_mod', 'savebreathweapons_temp_mod'],
      (v) => {
        const output = {};
        const baseSavebreathweapons = +v.savebreathweapons_base || 0;
        const racialSavebreathweapons = +v.savebreathweapons_racial_mod || 0;
        const abilitySavebreathweapons = +v.savebreathweapons_ability_mod || 0;
        const miscSavebreathweapons = +v.savebreathweapons_misc_mod || 0;
        const tempSavebreathweapons = +v.savebreathweapons_temp_mod || 0;
        const oldSave = +v.savebreathweapons || 0;
        const newSave = int(baseSavebreathweapons + racialSavebreathweapons + abilitySavebreathweapons + miscSavebreathweapons + tempSavebreathweapons);
        // clog(`oldSave: ${oldSave} newSave: ${newSave}`);
        if (migrate === 1) {
          if (oldSave <= 20 && newSave === 20) {
            output.savebreathweapons_base = oldSave;
            // clog('Old savebreathweapons copied to Base/Class column');
          } else {
            output.savebreathweapons = newSave;
          }
        } else {
          output.savebreathweapons = newSave;
        }
        setAttrs(output, {silent: true});
      }
    );
  };

  savespellsCalc = (migrate) => {
    getAttrs(['savespells', 'savespells_base', 'savespells_racial_mod', 'savespells_ability_mod', 'savespells_misc_mod', 'savespells_temp_mod'], (v) => {
      const output = {};
      const baseSavespells = +v.savespells_base || 0;
      const racialSavespells = +v.savespells_racial_mod || 0;
      const abilitySavespells = +v.savespells_ability_mod || 0;
      const miscSavespells = +v.savespells_misc_mod || 0;
      const tempSavespells = +v.savespells_temp_mod || 0;
      const oldSave = +v.savespells || 0;
      const newSave = int(baseSavespells + racialSavespells + abilitySavespells + miscSavespells + tempSavespells);
      // clog(`oldSave: ${oldSave} newSave: ${newSave}`);
      if (migrate === 1) {
        if (oldSave <= 20 && newSave === 20) {
          output.savespells_base = oldSave;
          // clog('Old savespells copied to Base/Class column');
        } else {
          output.savespells = newSave;
        }
      } else {
        output.savespells = newSave;
        // clog('Save row calculated');
      }
      setAttrs(output, {silent: true});
    });
  };

  savemiscCalc = () => {
    getAttrs(['savemisc', 'savemisc_base', 'savemisc_racial_mod', 'savemisc_ability_mod', 'savemisc_misc_mod', 'savemisc_temp_mod'], (v) => {
      const output = {};
      const baseSavemisc = +v.savemisc_base || 0;
      const racialSavemisc = +v.savemisc_racial_mod || 0;
      const abilitySavemisc = +v.savemisc_ability_mod || 0;
      const miscSavemisc = +v.savemisc_misc_mod || 0;
      const tempSavemisc = +v.savemisc_temp_mod || 0;
      const newSave = int(baseSavemisc + racialSavemisc + abilitySavemisc + miscSavemisc + tempSavemisc);
      output.savemisc = newSave;
      setAttrs(output, {silent: true});
    });
  };

  savemisc1Calc = () => {
    getAttrs(['savemisc1', 'savemisc1_base', 'savemisc1_racial_mod', 'savemisc1_ability_mod', 'savemisc1_misc_mod', 'savemisc1_temp_mod'], (v) => {
      const output = {};
      const baseSavemisc1 = +v.savemisc1_base || 0;
      const racialSavemisc1 = +v.savemisc1_racial_mod || 0;
      const abilitySavemisc1 = +v.savemisc1_ability_mod || 0;
      const miscSavemisc1 = +v.savemisc1_misc_mod || 0;
      const tempSavemisc1 = +v.savemisc1_temp_mod || 0;
      // const oldSave = +v.savemisc1 || 0;
      const newSave = int(baseSavemisc1 + racialSavemisc1 + abilitySavemisc1 + miscSavemisc1 + tempSavemisc1);
      output.savemisc1 = newSave;
      setAttrs(output, {silent: true});
    });
  };

  savemisc2Calc = () => {
    getAttrs(['savemisc2', 'savemisc2_base', 'savemisc2_racial_mod', 'savemisc2_ability_mod', 'savemisc2_misc_mod', 'savemisc2_temp_mod'], (v) => {
      const output = {};
      const baseSavemisc2 = +v.savemisc2_base || 0;
      const racialSavemisc2 = +v.savemisc2_racial_mod || 0;
      const abilitySavemisc2 = +v.savemisc2_ability_mod || 0;
      const miscSavemisc2 = +v.savemisc2_misc_mod || 0;
      const tempSavemisc2 = +v.savemisc2_temp_mod || 0;
      // const oldSave = +v.savemisc1 || 0;
      const newSave = int(baseSavemisc2 + racialSavemisc2 + abilitySavemisc2 + miscSavemisc2 + tempSavemisc2);
      output.savemisc2 = newSave;
      setAttrs(output, {silent: true});
    });
  };

  on(
    'change:saveparalysispoisondeath_base change:saveparalysispoisondeath_racial_mod change:saveparalysispoisondeath_ability_mod change:saveparalysispoisondeath_misc_mod change:saveparalysispoisondeath_temp_mod',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      saveparalysispoisondeathCalc();
    }
  );
  on(
    'change:savepetrificationpolymorph_base change:savepetrificationpolymorph_racial_mod change:savepetrificationpolymorph_ability_mod change:savepetrificationpolymorph_misc_mod change:savepetrificationpolymorph_temp_mod',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      savepetrificationpolymorphCalc();
    }
  );
  on(
    'change:saverodsstaveswands_base change:saverodsstaveswands_racial_mod change:saverodsstaveswands_ability_mod change:saverodsstaveswands_misc_mod change:saverodsstaveswands_temp_mod',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      saverodsstaveswandsCalc();
    }
  );
  on(
    'change:savebreathweapons_base change:savebreathweapons_racial_mod change:savebreathweapons_ability_mod change:savebreathweapons_misc_mod change:savebreathweapons_temp_mod',
    (eventInfo) => {
      // clog(`Change Detected:${eventInfo.sourceAttribute}`);
      savebreathweaponsCalc();
    }
  );
  on('change:savespells_base change:savespells_racial_mod change:savespells_ability_mod change:savespells_misc_mod change:savespells_temp_mod', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    savespellsCalc();
  });
  on('change:savemisc_base change:savemisc_racial_mod change:savemisc_ability_mod change:savemisc_misc_mod change:savemisc_temp_mod', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    savemiscCalc();
  });
  on('change:savemisc1_base change:savemisc1_racial_mod change:savemisc1_ability_mod change:savemisc1_misc_mod change:savemisc1_temp_mod', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    savemisc1Calc();
  });
  on('change:savemisc2_base change:savemisc2_racial_mod change:savemisc2_ability_mod change:savemisc2_misc_mod change:savemisc2_temp_mod', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    savemisc2Calc();
  });

  // toggle monster HD selector
  on('change:matrix_class', (eventInfo) => {
    getAttrs(['matrix_class'], (v) => {
      const output = {};
      const classSelected = +v.matrix_class || 0;
      output.toggle_matrixhd = classSelected === 5 ? 1 : 0;
      setAttrs(output, {silent: true});
    });
  });

  // THAC0
  function calcThac0() {
    getAttrs(['thac00', 'autofill_matrix'], (v) => {
      const output = {};
      const autocalcFill = +v.autofill_matrix || 0;
      // bail out if auto-fill is not enabled.
      if (!autocalcFill) return;
      const baseThac0 = +v.thac00 || 20;
      output[`thac0-10`] = baseThac0 + 10;
      output[`thac0-9`] = baseThac0 + 9;
      output[`thac0-8`] = baseThac0 + 8;
      output[`thac0-7`] = baseThac0 + 7;
      output[`thac0-6`] = baseThac0 + 6;
      output[`thac0-5`] = baseThac0 + 5;
      output[`thac0-4`] = baseThac0 + 4;
      output[`thac0-3`] = baseThac0 + 3;
      output[`thac0-2`] = baseThac0 + 2;
      output[`thac0-1`] = baseThac0 + 1;
      output.thac01 = baseThac0 - 1;
      output.thac02 = baseThac0 - 2;
      output.thac03 = baseThac0 - 3;
      output.thac04 = baseThac0 - 4;
      output.thac05 = baseThac0 - 5;
      output.thac06 = baseThac0 - 6;
      output.thac07 = baseThac0 - 7;
      output.thac08 = baseThac0 - 8;
      output.thac09 = baseThac0 - 9;
      output.thac010 = baseThac0 - 10;
      setAttrs(output, {silent: true});
    });
  }

  // Attack Matrix Autofill To-Hit table
  on('change:matrix_class change:matrix_level change:matrix_hitdice change:autofill_matrix', (eventInfo) => {
    // clog(`Matrix Autofill Change Detected:${eventInfo.sourceAttribute}`);
    getAttrs(['matrix_class', 'matrix_level', 'matrix_hitdice', 'autofill_matrix'], (v) => {
      const output = {};
      const autocalcFill = +v.autofill_matrix || 0;
      // bail out if auto-fill is not enabled.
      if (!autocalcFill) return;
      const classSelected = +v.matrix_class || 0;
      const levelSelected = +v.matrix_level || 0;
      const hitdiceSelected = +v.matrix_hitdice || 0;
      // clog('Ready to autofill attack matrix.');
      if (classSelected === 0) return;
      // clerics table
      if (classSelected === 1) {
        if (levelSelected === 0) {
          // clog('Need to choose a class level greater than 0 to continue.');
        } else if (levelSelected < 4) {
          output[`thac-10`] = 25;
          output[`thac-9`] = 24;
          output[`thac-8`] = 23;
          output[`thac-7`] = 22;
          output[`thac-6`] = 21;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 19;
          output.thac2 = 18;
          output.thac3 = 17;
          output.thac4 = 16;
          output.thac5 = 15;
          output.thac6 = 14;
          output.thac7 = 13;
          output.thac8 = 12;
          output.thac9 = 11;
          output.thac10 = 10;
        } else if (levelSelected < 7) {
          output[`thac-10`] = 23;
          output[`thac-9`] = 22;
          output[`thac-8`] = 21;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 19;
          output.thac00 = 18;
          output.thac0 = 18;
          output.thac1 = 17;
          output.thac2 = 16;
          output.thac3 = 15;
          output.thac4 = 14;
          output.thac5 = 13;
          output.thac6 = 12;
          output.thac7 = 11;
          output.thac8 = 10;
          output.thac9 = 9;
          output.thac10 = 8;
        } else if (levelSelected < 10) {
          output[`thac-10`] = 21;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 19;
          output[`thac-2`] = 18;
          output[`thac-1`] = 17;
          output.thac00 = 16;
          output.thac0 = 16;
          output.thac1 = 15;
          output.thac2 = 14;
          output.thac3 = 13;
          output.thac4 = 12;
          output.thac5 = 11;
          output.thac6 = 10;
          output.thac7 = 9;
          output.thac8 = 8;
          output.thac9 = 7;
          output.thac10 = 6;
        } else if (levelSelected < 13) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 19;
          output[`thac-3`] = 18;
          output[`thac-2`] = 17;
          output[`thac-1`] = 16;
          output.thac00 = 16;
          output.thac0 = 15;
          output.thac1 = 14;
          output.thac2 = 13;
          output.thac3 = 12;
          output.thac4 = 10;
          output.thac5 = 9;
          output.thac6 = 8;
          output.thac7 = 7;
          output.thac8 = 6;
          output.thac9 = 5;
          output.thac10 = 4;
        } else if (levelSelected < 16) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 19;
          output[`thac-6`] = 18;
          output[`thac-5`] = 17;
          output[`thac-4`] = 16;
          output[`thac-3`] = 15;
          output[`thac-2`] = 14;
          output[`thac-1`] = 13;
          output.thac00 = 12;
          output.thac0 = 12;
          output.thac1 = 11;
          output.thac2 = 10;
          output.thac3 = 9;
          output.thac4 = 8;
          output.thac5 = 7;
          output.thac6 = 6;
          output.thac7 = 5;
          output.thac8 = 4;
          output.thac9 = 3;
          output.thac10 = 2;
        } else if (levelSelected < 19) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 19;
          output[`thac-8`] = 18;
          output[`thac-7`] = 17;
          output[`thac-6`] = 16;
          output[`thac-5`] = 15;
          output[`thac-4`] = 14;
          output[`thac-3`] = 13;
          output[`thac-2`] = 12;
          output[`thac-1`] = 11;
          output.thac00 = 10;
          output.thac0 = 10;
          output.thac1 = 9;
          output.thac2 = 8;
          output.thac3 = 7;
          output.thac4 = 6;
          output.thac5 = 5;
          output.thac6 = 4;
          output.thac7 = 3;
          output.thac8 = 2;
          output.thac9 = 1;
          output.thac10 = 0;
        } else if (levelSelected >= 19) {
          output[`thac-10`] = 19;
          output[`thac-9`] = 18;
          output[`thac-8`] = 17;
          output[`thac-7`] = 16;
          output[`thac-6`] = 15;
          output[`thac-5`] = 14;
          output[`thac-4`] = 13;
          output[`thac-3`] = 12;
          output[`thac-2`] = 11;
          output[`thac-1`] = 10;
          output.thac00 = 9;
          output.thac0 = 9;
          output.thac1 = 8;
          output.thac2 = 7;
          output.thac3 = 6;
          output.thac4 = 5;
          output.thac5 = 4;
          output.thac6 = 3;
          output.thac7 = 2;
          output.thac8 = 1;
          output.thac9 = 0;
          output.thac10 = -1;
        }
        output.attack_matrix_flag = 0;
      }
      // fighters table
      if (classSelected === 2) {
        if (levelSelected === 0) {
          output[`thac-10`] = 26;
          output[`thac-9`] = 25;
          output[`thac-8`] = 24;
          output[`thac-7`] = 23;
          output[`thac-6`] = 22;
          output[`thac-5`] = 21;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 20;
          output.thac2 = 19;
          output.thac3 = 18;
          output.thac4 = 17;
          output.thac5 = 16;
          output.thac6 = 15;
          output.thac7 = 14;
          output.thac8 = 13;
          output.thac9 = 12;
          output.thac10 = 11;
        } else if (levelSelected < 3) {
          output[`thac-10`] = 25;
          output[`thac-9`] = 24;
          output[`thac-8`] = 23;
          output[`thac-7`] = 22;
          output[`thac-6`] = 21;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 19;
          output.thac2 = 18;
          output.thac3 = 17;
          output.thac4 = 16;
          output.thac5 = 15;
          output.thac6 = 14;
          output.thac7 = 13;
          output.thac8 = 12;
          output.thac9 = 11;
          output.thac10 = 10;
        } else if (levelSelected < 5) {
          output[`thac-10`] = 23;
          output[`thac-9`] = 22;
          output[`thac-8`] = 21;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 19;
          output.thac00 = 18;
          output.thac0 = 18;
          output.thac1 = 17;
          output.thac2 = 16;
          output.thac3 = 15;
          output.thac4 = 14;
          output.thac5 = 13;
          output.thac6 = 12;
          output.thac7 = 11;
          output.thac8 = 10;
          output.thac9 = 9;
          output.thac10 = 8;
        } else if (levelSelected < 7) {
          output[`thac-10`] = 21;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 19;
          output[`thac-2`] = 18;
          output[`thac-1`] = 17;
          output.thac00 = 16;
          output.thac0 = 16;
          output.thac1 = 15;
          output.thac2 = 14;
          output.thac3 = 13;
          output.thac4 = 12;
          output.thac5 = 11;
          output.thac6 = 10;
          output.thac7 = 9;
          output.thac8 = 8;
          output.thac9 = 7;
          output.thac10 = 6;
        } else if (levelSelected < 9) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 19;
          output[`thac-4`] = 18;
          output[`thac-3`] = 17;
          output[`thac-2`] = 16;
          output[`thac-1`] = 15;
          output.thac00 = 14;
          output.thac0 = 14;
          output.thac1 = 13;
          output.thac2 = 12;
          output.thac3 = 11;
          output.thac4 = 10;
          output.thac5 = 9;
          output.thac6 = 8;
          output.thac7 = 7;
          output.thac8 = 6;
          output.thac9 = 5;
          output.thac10 = 4;
        } else if (levelSelected < 11) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 19;
          output[`thac-6`] = 18;
          output[`thac-5`] = 17;
          output[`thac-4`] = 16;
          output[`thac-3`] = 15;
          output[`thac-2`] = 14;
          output[`thac-1`] = 13;
          output.thac00 = 12;
          output.thac0 = 12;
          output.thac1 = 11;
          output.thac2 = 10;
          output.thac3 = 9;
          output.thac4 = 8;
          output.thac5 = 7;
          output.thac6 = 6;
          output.thac7 = 5;
          output.thac8 = 4;
          output.thac9 = 3;
          output.thac10 = 2;
        } else if (levelSelected < 13) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 19;
          output[`thac-8`] = 18;
          output[`thac-7`] = 17;
          output[`thac-6`] = 16;
          output[`thac-5`] = 15;
          output[`thac-4`] = 14;
          output[`thac-3`] = 13;
          output[`thac-2`] = 12;
          output[`thac-1`] = 11;
          output.thac00 = 10;
          output.thac0 = 10;
          output.thac1 = 9;
          output.thac2 = 8;
          output.thac3 = 7;
          output.thac4 = 6;
          output.thac5 = 5;
          output.thac6 = 4;
          output.thac7 = 3;
          output.thac8 = 2;
          output.thac9 = 1;
          output.thac10 = 0;
        } else if (levelSelected < 15) {
          output[`thac-10`] = 18;
          output[`thac-9`] = 17;
          output[`thac-8`] = 16;
          output[`thac-7`] = 15;
          output[`thac-6`] = 14;
          output[`thac-5`] = 13;
          output[`thac-4`] = 12;
          output[`thac-3`] = 11;
          output[`thac-2`] = 10;
          output[`thac-1`] = 9;
          output.thac00 = 8;
          output.thac0 = 8;
          output.thac1 = 7;
          output.thac2 = 6;
          output.thac3 = 5;
          output.thac4 = 4;
          output.thac5 = 3;
          output.thac6 = 2;
          output.thac7 = 1;
          output.thac8 = 0;
          output.thac9 = -1;
          output.thac10 = -2;
        } else if (levelSelected < 17) {
          output[`thac-10`] = 16;
          output[`thac-9`] = 15;
          output[`thac-8`] = 14;
          output[`thac-7`] = 13;
          output[`thac-6`] = 12;
          output[`thac-5`] = 11;
          output[`thac-4`] = 10;
          output[`thac-3`] = 9;
          output[`thac-2`] = 8;
          output[`thac-1`] = 7;
          output.thac00 = 6;
          output.thac0 = 6;
          output.thac1 = 5;
          output.thac2 = 4;
          output.thac3 = 3;
          output.thac4 = 2;
          output.thac5 = 1;
          output.thac6 = 0;
          output.thac7 = -1;
          output.thac8 = -2;
          output.thac9 = -3;
          output.thac10 = -4;
        } else if (levelSelected >= 17) {
          output[`thac-10`] = 14;
          output[`thac-9`] = 13;
          output[`thac-8`] = 12;
          output[`thac-7`] = 11;
          output[`thac-6`] = 10;
          output[`thac-5`] = 9;
          output[`thac-4`] = 8;
          output[`thac-3`] = 7;
          output[`thac-2`] = 6;
          output[`thac-1`] = 5;
          output.thac00 = 4;
          output.thac0 = 4;
          output.thac1 = 3;
          output.thac2 = 2;
          output.thac3 = 1;
          output.thac4 = 0;
          output.thac5 = -1;
          output.thac6 = -2;
          output.thac7 = -3;
          output.thac8 = -4;
          output.thac9 = -5;
          output.thac10 = -6;
        }
        output.attack_matrix_flag = 0;
      }
      // magic-users table
      if (classSelected === 3) {
        if (levelSelected === 0) {
          // clog('Need to choose a class level greater than 0 to continue.');
        } else if (levelSelected < 6) {
          output[`thac-10`] = 26;
          output[`thac-9`] = 25;
          output[`thac-8`] = 24;
          output[`thac-7`] = 23;
          output[`thac-6`] = 22;
          output[`thac-5`] = 21;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 20;
          output.thac2 = 19;
          output.thac3 = 18;
          output.thac4 = 17;
          output.thac5 = 16;
          output.thac6 = 15;
          output.thac7 = 14;
          output.thac8 = 13;
          output.thac9 = 12;
          output.thac10 = 11;
        } else if (levelSelected < 11) {
          output[`thac-10`] = 24;
          output[`thac-9`] = 23;
          output[`thac-8`] = 22;
          output[`thac-7`] = 21;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 19;
          output.thac0 = 19;
          output.thac1 = 18;
          output.thac2 = 17;
          output.thac3 = 16;
          output.thac4 = 15;
          output.thac5 = 14;
          output.thac6 = 13;
          output.thac7 = 12;
          output.thac8 = 11;
          output.thac9 = 10;
          output.thac10 = 9;
        } else if (levelSelected < 16) {
          output[`thac-10`] = 21;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 19;
          output[`thac-2`] = 18;
          output[`thac-1`] = 17;
          output.thac00 = 16;
          output.thac0 = 16;
          output.thac1 = 15;
          output.thac2 = 14;
          output.thac3 = 13;
          output.thac4 = 12;
          output.thac5 = 11;
          output.thac6 = 10;
          output.thac7 = 9;
          output.thac8 = 8;
          output.thac9 = 7;
          output.thac10 = 6;
        } else if (levelSelected < 21) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 19;
          output[`thac-5`] = 18;
          output[`thac-4`] = 17;
          output[`thac-3`] = 16;
          output[`thac-2`] = 15;
          output[`thac-1`] = 14;
          output.thac00 = 13;
          output.thac0 = 13;
          output.thac1 = 12;
          output.thac2 = 11;
          output.thac3 = 10;
          output.thac4 = 9;
          output.thac5 = 8;
          output.thac6 = 7;
          output.thac7 = 6;
          output.thac8 = 5;
          output.thac9 = 4;
          output.thac10 = 3;
        } else if (levelSelected >= 21) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 19;
          output[`thac-7`] = 18;
          output[`thac-6`] = 17;
          output[`thac-5`] = 16;
          output[`thac-4`] = 15;
          output[`thac-3`] = 14;
          output[`thac-2`] = 13;
          output[`thac-1`] = 12;
          output.thac00 = 11;
          output.thac0 = 11;
          output.thac1 = 10;
          output.thac2 = 9;
          output.thac3 = 8;
          output.thac4 = 7;
          output.thac5 = 6;
          output.thac6 = 5;
          output.thac7 = 4;
          output.thac8 = 3;
          output.thac9 = 2;
          output.thac10 = 1;
        }
        output.attack_matrix_flag = 0;
      }
      // thieves table
      if (classSelected === 4) {
        if (levelSelected === 0) {
          // clog('Need to choose a class level greater than 0 to continue.');
        } else if (levelSelected < 5) {
          output[`thac-10`] = 26;
          output[`thac-9`] = 25;
          output[`thac-8`] = 24;
          output[`thac-7`] = 23;
          output[`thac-6`] = 22;
          output[`thac-5`] = 21;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 20;
          output.thac2 = 19;
          output.thac3 = 18;
          output.thac4 = 17;
          output.thac5 = 16;
          output.thac6 = 15;
          output.thac7 = 14;
          output.thac8 = 13;
          output.thac9 = 12;
          output.thac10 = 11;
        } else if (levelSelected < 9) {
          output[`thac-10`] = 24;
          output[`thac-9`] = 23;
          output[`thac-8`] = 22;
          output[`thac-7`] = 21;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 19;
          output.thac0 = 19;
          output.thac1 = 18;
          output.thac2 = 17;
          output.thac3 = 16;
          output.thac4 = 15;
          output.thac5 = 14;
          output.thac6 = 13;
          output.thac7 = 12;
          output.thac8 = 11;
          output.thac9 = 10;
          output.thac10 = 9;
        } else if (levelSelected < 13) {
          output[`thac-10`] = 21;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 19;
          output[`thac-2`] = 18;
          output[`thac-1`] = 17;
          output.thac00 = 16;
          output.thac0 = 16;
          output.thac1 = 15;
          output.thac2 = 14;
          output.thac3 = 13;
          output.thac4 = 12;
          output.thac5 = 11;
          output.thac6 = 10;
          output.thac7 = 9;
          output.thac8 = 8;
          output.thac9 = 7;
          output.thac10 = 6;
        } else if (levelSelected < 17) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 19;
          output[`thac-4`] = 18;
          output[`thac-3`] = 17;
          output[`thac-2`] = 16;
          output[`thac-1`] = 15;
          output.thac00 = 14;
          output.thac0 = 14;
          output.thac1 = 13;
          output.thac2 = 12;
          output.thac3 = 11;
          output.thac4 = 10;
          output.thac5 = 9;
          output.thac6 = 8;
          output.thac7 = 7;
          output.thac8 = 6;
          output.thac9 = 5;
          output.thac10 = 4;
        } else if (levelSelected < 21) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 19;
          output[`thac-6`] = 18;
          output[`thac-5`] = 17;
          output[`thac-4`] = 16;
          output[`thac-3`] = 15;
          output[`thac-2`] = 14;
          output[`thac-1`] = 13;
          output.thac00 = 12;
          output.thac0 = 12;
          output.thac1 = 11;
          output.thac2 = 10;
          output.thac3 = 9;
          output.thac4 = 8;
          output.thac5 = 7;
          output.thac6 = 6;
          output.thac7 = 5;
          output.thac8 = 4;
          output.thac9 = 3;
          output.thac10 = 2;
        } else if (levelSelected >= 21) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 19;
          output[`thac-8`] = 18;
          output[`thac-7`] = 17;
          output[`thac-6`] = 16;
          output[`thac-5`] = 15;
          output[`thac-4`] = 14;
          output[`thac-3`] = 13;
          output[`thac-2`] = 12;
          output[`thac-1`] = 11;
          output.thac00 = 10;
          output.thac0 = 10;
          output.thac1 = 9;
          output.thac2 = 8;
          output.thac3 = 7;
          output.thac4 = 6;
          output.thac5 = 5;
          output.thac6 = 4;
          output.thac7 = 3;
          output.thac8 = 2;
          output.thac9 = 1;
          output.thac10 = 0;
        }
        output.attack_matrix_flag = 0;
      }
      // monsters table
      if (classSelected === 5) {
        if (hitdiceSelected === 0) {
          // clog('Need to select HD to continue.');
        } else if (hitdiceSelected === 1) {
          output[`thac-10`] = 26;
          output[`thac-9`] = 25;
          output[`thac-8`] = 24;
          output[`thac-7`] = 23;
          output[`thac-6`] = 22;
          output[`thac-5`] = 21;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 20;
          output.thac2 = 19;
          output.thac3 = 18;
          output.thac4 = 17;
          output.thac5 = 16;
          output.thac6 = 15;
          output.thac7 = 14;
          output.thac8 = 13;
          output.thac9 = 12;
          output.thac10 = 11;
        } else if (hitdiceSelected === 2) {
          output[`thac-10`] = 25;
          output[`thac-9`] = 24;
          output[`thac-8`] = 23;
          output[`thac-7`] = 22;
          output[`thac-6`] = 21;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 20;
          output.thac0 = 20;
          output.thac1 = 19;
          output.thac2 = 18;
          output.thac3 = 17;
          output.thac4 = 16;
          output.thac5 = 15;
          output.thac6 = 14;
          output.thac7 = 13;
          output.thac8 = 12;
          output.thac9 = 11;
          output.thac10 = 10;
        } else if (hitdiceSelected === 3) {
          output[`thac-10`] = 24;
          output[`thac-9`] = 23;
          output[`thac-8`] = 22;
          output[`thac-7`] = 21;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 20;
          output.thac00 = 19;
          output.thac0 = 19;
          output.thac1 = 18;
          output.thac2 = 17;
          output.thac3 = 16;
          output.thac4 = 15;
          output.thac5 = 14;
          output.thac6 = 13;
          output.thac7 = 12;
          output.thac8 = 11;
          output.thac9 = 10;
          output.thac10 = 9;
        } else if (hitdiceSelected === 4) {
          output[`thac-10`] = 23;
          output[`thac-9`] = 22;
          output[`thac-8`] = 21;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 20;
          output[`thac-2`] = 20;
          output[`thac-1`] = 19;
          output.thac00 = 18;
          output.thac0 = 18;
          output.thac1 = 17;
          output.thac2 = 16;
          output.thac3 = 15;
          output.thac4 = 14;
          output.thac5 = 13;
          output.thac6 = 12;
          output.thac7 = 11;
          output.thac8 = 10;
          output.thac9 = 9;
          output.thac10 = 8;
        } else if (hitdiceSelected === 5) {
          output[`thac-10`] = 21;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 20;
          output[`thac-3`] = 19;
          output[`thac-2`] = 18;
          output[`thac-1`] = 17;
          output.thac00 = 16;
          output.thac0 = 16;
          output.thac1 = 15;
          output.thac2 = 14;
          output.thac3 = 13;
          output.thac4 = 12;
          output.thac5 = 11;
          output.thac6 = 10;
          output.thac7 = 9;
          output.thac8 = 8;
          output.thac9 = 7;
          output.thac10 = 6;
        } else if (hitdiceSelected === 6) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 20;
          output[`thac-5`] = 20;
          output[`thac-4`] = 19;
          output[`thac-3`] = 18;
          output[`thac-2`] = 17;
          output[`thac-1`] = 16;
          output.thac00 = 15;
          output.thac0 = 15;
          output.thac1 = 14;
          output.thac2 = 13;
          output.thac3 = 12;
          output.thac4 = 11;
          output.thac5 = 10;
          output.thac6 = 9;
          output.thac7 = 8;
          output.thac8 = 7;
          output.thac9 = 6;
          output.thac10 = 5;
        } else if (hitdiceSelected === 7) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 20;
          output[`thac-6`] = 19;
          output[`thac-5`] = 18;
          output[`thac-4`] = 17;
          output[`thac-3`] = 16;
          output[`thac-2`] = 15;
          output[`thac-1`] = 14;
          output.thac00 = 13;
          output.thac0 = 13;
          output.thac1 = 12;
          output.thac2 = 11;
          output.thac3 = 10;
          output.thac4 = 9;
          output.thac5 = 8;
          output.thac6 = 7;
          output.thac7 = 6;
          output.thac8 = 5;
          output.thac9 = 4;
          output.thac10 = 3;
        } else if (hitdiceSelected === 8) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 20;
          output[`thac-8`] = 20;
          output[`thac-7`] = 19;
          output[`thac-6`] = 18;
          output[`thac-5`] = 17;
          output[`thac-4`] = 16;
          output[`thac-3`] = 15;
          output[`thac-2`] = 14;
          output[`thac-1`] = 13;
          output.thac00 = 12;
          output.thac0 = 12;
          output.thac1 = 11;
          output.thac2 = 10;
          output.thac3 = 9;
          output.thac4 = 8;
          output.thac5 = 7;
          output.thac6 = 6;
          output.thac7 = 5;
          output.thac8 = 4;
          output.thac9 = 3;
          output.thac10 = 2;
        } else if (hitdiceSelected === 9) {
          output[`thac-10`] = 20;
          output[`thac-9`] = 19;
          output[`thac-8`] = 18;
          output[`thac-7`] = 17;
          output[`thac-6`] = 16;
          output[`thac-5`] = 15;
          output[`thac-4`] = 14;
          output[`thac-3`] = 13;
          output[`thac-2`] = 12;
          output[`thac-1`] = 11;
          output.thac00 = 10;
          output.thac0 = 10;
          output.thac1 = 9;
          output.thac2 = 8;
          output.thac3 = 7;
          output.thac4 = 6;
          output.thac5 = 5;
          output.thac6 = 4;
          output.thac7 = 3;
          output.thac8 = 2;
          output.thac9 = 1;
          output.thac10 = 0;
        } else if (hitdiceSelected === 10) {
          output[`thac-10`] = 19;
          output[`thac-9`] = 18;
          output[`thac-8`] = 17;
          output[`thac-7`] = 16;
          output[`thac-6`] = 15;
          output[`thac-5`] = 14;
          output[`thac-4`] = 13;
          output[`thac-3`] = 12;
          output[`thac-2`] = 11;
          output[`thac-1`] = 10;
          output.thac00 = 9;
          output.thac0 = 9;
          output.thac1 = 8;
          output.thac2 = 7;
          output.thac3 = 6;
          output.thac4 = 5;
          output.thac5 = 4;
          output.thac6 = 3;
          output.thac7 = 2;
          output.thac8 = 1;
          output.thac9 = 0;
          output.thac10 = -1;
        } else if (hitdiceSelected === 11) {
          output[`thac-10`] = 18;
          output[`thac-9`] = 17;
          output[`thac-8`] = 16;
          output[`thac-7`] = 15;
          output[`thac-6`] = 14;
          output[`thac-5`] = 13;
          output[`thac-4`] = 12;
          output[`thac-3`] = 11;
          output[`thac-2`] = 10;
          output[`thac-1`] = 9;
          output.thac00 = 8;
          output.thac0 = 8;
          output.thac1 = 7;
          output.thac2 = 6;
          output.thac3 = 5;
          output.thac4 = 4;
          output.thac5 = 3;
          output.thac6 = 2;
          output.thac7 = 1;
          output.thac8 = 0;
          output.thac9 = -1;
          output.thac10 = -2;
        } else if (hitdiceSelected === 12) {
          output[`thac-10`] = 17;
          output[`thac-9`] = 16;
          output[`thac-8`] = 15;
          output[`thac-7`] = 14;
          output[`thac-6`] = 13;
          output[`thac-5`] = 12;
          output[`thac-4`] = 11;
          output[`thac-3`] = 10;
          output[`thac-2`] = 9;
          output[`thac-1`] = 8;
          output.thac00 = 7;
          output.thac0 = 7;
          output.thac1 = 6;
          output.thac2 = 5;
          output.thac3 = 4;
          output.thac4 = 3;
          output.thac5 = 2;
          output.thac6 = 1;
          output.thac7 = 0;
          output.thac8 = -1;
          output.thac9 = -2;
          output.thac10 = -3;
        }
        output.attack_matrix_flag = 0;
      }
      setAttrs(output, {silent: true});
      calcThac0();
    });
  });

  on('sheet:opened change:thac0 change:thac00 change:autofill_matrix', (eventInfo) => {
    getAttrs(['attack_matrix_flag', 'matrix_class', 'thac0', 'thac1', 'thac2', 'thac00', 'thac01', 'thac02', 'autofill_matrix'], (v) => {
      const output = {};
      const autocalcFill = +v.autofill_matrix || 0;
      // bail out if auto-fill is not enabled.
      if (!autocalcFill) return;
      const attack_matrix_flag = +v.attack_matrix_flag || 0;
      const matrix_class = +v.matrix_class || 0;
      if (attack_matrix_flag === 0 || matrix_class > 0) {
        // clog(`attack_matrix_flag:${attack_matrix_flag} matrix_class:${matrix_class}`);
        output.attack_matrix_flag = 0;
      } else {
        const thac0 = +v.thac0 || 20;
        const thac1 = +v.thac1 || 20;
        const thac2 = +v.thac2 || 20;
        const thac00 = +v.thac00 || 20;
        const thac01 = +v.thac01 || 20;
        const thac02 = +v.thac02 || 20;
        const toHitIsDefaultValue = thac0 + thac1 + thac2;
        const thac0IsDefaultValue = thac00 + thac01 + thac02;
        // clog(`toHitIsDefaultValue:${toHitIsDefaultValue} thac0IsDefaultValue:${thac0IsDefaultValue}`);
        output.attack_matrix_flag = toHitIsDefaultValue === 60 && thac0IsDefaultValue === 60 ? 1 : 0;
      }
      setAttrs(output, {silent: true});
    });
  });

  on('change:thac00', (eventInfo) => {
    calcThac0();
  });

  // Auto-fill Abilities
  function getValidVariable(str_value, string_type = 'UNDEFINED', lower_bound = 3, higher_bound = 25) {
    if (str_value < 3) {
      console.log(`Error: ${string_type} value is not a number or out of range. [${str_value}].\nDefaulting to ${lower_bound}.`);
      return lower_bound;
    }
    if (str_value > 25) {
      console.log(`Error: ${string_type} value is out of range. [${str_value}].\nDefaulting to ${higher_bound}.`);
      return higher_bound;
    }
    // Keep value between lowerbound and higherbound.
    return Math.min(Math.max(str_value, lower_bound), higher_bound);
  }

  // Strength Table Entry
  class StrengthCheck {
    constructor(meleebonus, dmgbonus, encumbrancebonus, minorstrengthfeat, minorstrengthfeat_locked, majorstrengthfeat) {
      this.meleebonus = meleebonus;
      this.dmgbonus = dmgbonus;
      this.majorstrengthfeat = majorstrengthfeat;
      this.minorstrengthfeat = minorstrengthfeat;
      this.minorstrengthfeat_locked = minorstrengthfeat_locked;
      this.encumbrancebonus = encumbrancebonus;
    }

    getMeleeAttackBonus() {
      return this.meleebonus;
    }

    getMeleeDamageBonus() {
      return this.dmgbonus;
    }

    getMajorStrengthCheck() {
      return this.majorstrengthfeat;
    }

    getMinorStrengthCheck(locked = false) {
      if (!locked) return this.minorstrengthfeat;
      return this.minorstrengthfeat_locked;
    }

    getEncumbranceBonus() {
      return this.encumbrancebonus;
    }
  }

  class StrengthAdjustmentTable {
    constructor() {
      // MeleeAttackBonus, MeleeDamageBonus, EncumbranceBonus, MinorStrengthCheck, MinorStrengthCheck(locked), MajorStrengthCheck
      this.strength_dict = {
        3: new StrengthCheck(-3, -1, -350, 15, 0, 0),
        4: new StrengthCheck(-2, -1, -250, 15, 0, 0),
        5: new StrengthCheck(-2, -1, -250, 15, 0, 0),
        6: new StrengthCheck(-1, 0, -150, 15, 0, 0),
        7: new StrengthCheck(-1, 0, -150, 15, 0, 0),
        8: new StrengthCheck(0, 0, 0, 30, 0, 1),
        9: new StrengthCheck(0, 0, 0, 30, 0, 1),
        10: new StrengthCheck(0, 0, 0, 30, 0, 2),
        11: new StrengthCheck(0, 0, 0, 30, 0, 2),
        12: new StrengthCheck(0, 0, 100, 30, 0, 4),
        13: new StrengthCheck(0, 0, 100, 30, 0, 4),
        14: new StrengthCheck(0, 0, 200, 30, 0, 7),
        15: new StrengthCheck(0, 0, 200, 30, 0, 7),
        16: new StrengthCheck(0, 1, 350, 50, 0, 10),
        17: new StrengthCheck(1, 1, 500, 50, 0, 13),
        18: {
          None: new StrengthCheck(1, 2, 750, 50, 0, 16),
          '01-50': new StrengthCheck(1, 3, 1000, 50, 0, 20),
          '51-75': new StrengthCheck(2, 3, 1250, 70, 0, 25),
          '76-90': new StrengthCheck(2, 4, 1500, 70, 0, 30),
          '91-99': new StrengthCheck(2, 5, 2000, 70, 15, 35),
          '00': new StrengthCheck(3, 6, 3000, 85, 30, 40),
        },
        19: new StrengthCheck(3, 7, 4500, 90, 50, 50),
        20: new StrengthCheck(3, 8, 5000, 90, 50, 60),
        21: new StrengthCheck(4, 9, 6000, 90, 70, 70),
        22: new StrengthCheck(4, 10, 7500, 90, 70, 80),
        23: new StrengthCheck(5, 11, 9000, 90, 85, 90),
        24: new StrengthCheck(6, 12, 12000, 95, 87, 100),
        25: new StrengthCheck(7, 14, 15000, 95, 90, 100),
      };
    }

    // Grab the correct data row corresponding to Strength
    getEntry(str_value, str_per_value) {
      const str_value_STR = getValidVariable(str_value, 'strength', 3, 25);
      // Get the normal [1-17],[19-25] table entries.
      if (str_value_STR !== 18) return this.strength_dict[str_value_STR];
      // Get the 18 + percentile table entries
      if (str_per_value <= 0) return this.strength_dict[str_value_STR].None;
      if (str_per_value <= 50) return this.strength_dict[str_value_STR]['01-50'];
      if (str_per_value <= 75) return this.strength_dict[str_value_STR]['51-75'];
      if (str_per_value <= 90) return this.strength_dict[str_value_STR]['76-90'];
      if (str_per_value <= 99) return this.strength_dict[str_value_STR]['91-99'];
      return this.strength_dict[str_value_STR]['00'];
    }

    getStrengthValue(type, str_value_STR, str_per_value = 0, lock_flag = false) {
      switch (type) {
        case 'Attack':
          return this.getEntry(str_value_STR, str_per_value).getMeleeAttackBonus();
        case 'Damage':
          return this.getEntry(str_value_STR, str_per_value).getMeleeDamageBonus();
        case 'Major':
          return this.getEntry(str_value_STR, str_per_value).getMajorStrengthCheck();
        case 'Minor':
          return this.getEntry(str_value_STR, str_per_value).getMinorStrengthCheck(lock_flag);
        case 'Encumbrance':
          return this.getEntry(str_value_STR, str_per_value).getEncumbranceBonus();
        default:
          return 'Invalid Test';
      }
    }
  }

  // Intelligence Table Entry
  class IntelligenceEntry {
    constructor(bonuslanguages, knowspell, minspells, maxspells) {
      this.bonuslanguages = bonuslanguages;
      this.knowspell = knowspell;
      this.minspells = minspells;
      this.maxspells = maxspells;
    }

    getBonusLanguages() {
      return this.bonuslanguages;
    }

    getKnowSpell() {
      return this.knowspell;
    }

    getMinSpells() {
      return this.minspells;
    }

    getMaxSpells() {
      return this.maxspells;
    }
  }

  class IntelligenceAdjustmentTable {
    constructor() {
      // bonuslanguages, knowspell, minspells, maxspells
      this.intelligence_dict = {
        8: new IntelligenceEntry(1, 0, 0, 0),
        9: new IntelligenceEntry(1, 35, 4, 6),
        10: new IntelligenceEntry(2, 45, 5, 7),
        11: new IntelligenceEntry(2, 45, 5, 7),
        12: new IntelligenceEntry(3, 45, 5, 7),
        13: new IntelligenceEntry(3, 55, 6, 9),
        14: new IntelligenceEntry(4, 55, 6, 9),
        15: new IntelligenceEntry(4, 65, 7, 11),
        16: new IntelligenceEntry(5, 65, 7, 11),
        17: new IntelligenceEntry(6, 75, 8, 14),
        18: new IntelligenceEntry(7, 85, 9, 18),
        19: new IntelligenceEntry(8, 95, 10, 99),
        20: new IntelligenceEntry(9, 96, 11, 99),
        21: new IntelligenceEntry(10, 97, 12, 99),
        22: new IntelligenceEntry(11, 98, 13, 99),
        23: new IntelligenceEntry(12, 99, 14, 99),
        24: new IntelligenceEntry(13, 100, 15, 99),
        25: new IntelligenceEntry(14, 100, 16, 99),
      };
    }

    getEntry(str_value) {
      return this.intelligence_dict[getValidVariable(str_value, 'intelligence', 8, 25)];
    }
  }

  // Wisdom Table Entry
  class WisdomEntry {
    constructor(mentalsavebonus, spellbonus, spellfailure) {
      this.mentalsavebonus = mentalsavebonus;
      this.spellbonus = spellbonus;
      this.spellfailure = spellfailure;
    }

    getMentalSaveBonus() {
      return this.mentalsavebonus;
    }

    getSpellBonus() {
      return this.spellbonus;
    }

    getSpellFailure() {
      return this.spellfailure;
    }
  }

  class WisdomAdjustmentTable {
    constructor() {
      // mentalsavebonus, spellbonus, spellfailure
      this.wisdom_dict = {
        3: new WisdomEntry('-3', 'None', 20),
        4: new WisdomEntry('-2', 'None', 20),
        5: new WisdomEntry('-1', 'None', 20),
        6: new WisdomEntry('-1', 'None', 20),
        7: new WisdomEntry('-1', 'None', 20),
        8: new WisdomEntry('0', 'None', 20),
        9: new WisdomEntry('0', 'None', 20),
        10: new WisdomEntry('0', 'None', 15),
        11: new WisdomEntry('0', 'None', 10),
        12: new WisdomEntry('0', 'None', 5),
        13: new WisdomEntry('0', '1/0/0/0/0/0/0', 0),
        14: new WisdomEntry('0', '2/0/0/0/0/0/0', 0),
        15: new WisdomEntry('1', '2/1/0/0/0/0/0', 0),
        16: new WisdomEntry('2', '2/2/0/0/0/0/0', 0),
        17: new WisdomEntry('3', '2/2/1/0/0/0/0', 0),
        18: new WisdomEntry('4', '2/2/1/1/0/0/0', 0),
        19: new WisdomEntry('4', '3/2/1/2/0/0/0', 0),
        20: new WisdomEntry('4', '3/3/1/3/0/0/0', 0),
        21: new WisdomEntry('4', '3/3/2/3/1/0/0', 0),
        22: new WisdomEntry('4', '3/3/2/4/2/0/0', 0),
        23: new WisdomEntry('4', '3/3/2/4/4/0/0', 0),
        24: new WisdomEntry('4', '3/3/2/4/4/2/1', 0),
        25: new WisdomEntry('4', '3/3/2/4/4/3/1', 0),
      };
    }

    getEntry(str_value) {
      return this.wisdom_dict[getValidVariable(str_value, 'wisdom', 3, 25)];
    }
  }

  // Dexterity Class Entry
  class DexterityEntry {
    constructor(surprisebonus, rangedbonus, armorbonus) {
      this.surprisebonus = surprisebonus;
      this.rangedbonus = rangedbonus;
      this.armorbonus = armorbonus;
    }

    getSurpriseBonus() {
      return this.surprisebonus;
    }

    getRangedBonus() {
      return this.rangedbonus;
    }

    getArmorBonus() {
      return this.armorbonus;
    }
  }

  class DexterityAdjustmentTable {
    constructor() {
      // surprisebonus rangedbonus armorbonus
      this.dexterity_dict = {
        3: new DexterityEntry(3, -3, 4),
        4: new DexterityEntry(2, -2, 3),
        5: new DexterityEntry(1, -1, 2),
        6: new DexterityEntry(0, 0, 1),
        7: new DexterityEntry(0, 0, 0),
        8: new DexterityEntry(0, 0, 0),
        9: new DexterityEntry(0, 0, 0),
        10: new DexterityEntry(0, 0, 0),
        11: new DexterityEntry(0, 0, 0),
        12: new DexterityEntry(0, 0, 0),
        13: new DexterityEntry(0, 0, 0),
        14: new DexterityEntry(0, 0, 0),
        15: new DexterityEntry(0, 0, -1),
        16: new DexterityEntry(-1, 1, -2),
        17: new DexterityEntry(-2, 2, -3),
        18: new DexterityEntry(-3, 3, -4),
        19: new DexterityEntry(-3, 3, -4),
        20: new DexterityEntry(-3, 3, -4),
        21: new DexterityEntry(-4, 4, -5),
        22: new DexterityEntry(-4, 4, -5),
        23: new DexterityEntry(-4, 4, -5),
        24: new DexterityEntry(-5, 5, -6),
        25: new DexterityEntry(-5, 5, -6),
      };
    }

    getEntry(str_value) {
      return this.dexterity_dict[getValidVariable(str_value, 'dexterity', 3, 25)];
    }
  }

  class ConstitutionEntry {
    constructor(hitpointbonus, systemshock, resurrectionsurvival) {
      this.hitpointbonus = hitpointbonus;
      this.systemshock = systemshock;
      this.resurrectionsurvival = resurrectionsurvival;
    }

    getHitpointBonus() {
      return this.hitpointbonus;
    }

    getSystemShock() {
      return this.systemshock;
    }

    getResurrectionSurvival() {
      return this.resurrectionsurvival;
    }
  }

  class ConstitutionAdjustmentTable {
    constructor() {
      // hitpointbonus systemshock resurrectionsurvival
      this.constitution_dict = {
        3: new ConstitutionEntry('-2', 35, 40),
        4: new ConstitutionEntry('-1', 40, 45),
        5: new ConstitutionEntry('-1', 45, 50),
        6: new ConstitutionEntry('0', 50, 55),
        7: new ConstitutionEntry('0', 55, 60),
        8: new ConstitutionEntry('0', 60, 65),
        9: new ConstitutionEntry('0', 65, 70),
        10: new ConstitutionEntry('0', 70, 75),
        11: new ConstitutionEntry('0', 75, 80),
        12: new ConstitutionEntry('0', 80, 85),
        13: new ConstitutionEntry('0', 85, 90),
        14: new ConstitutionEntry('0', 88, 92),
        15: new ConstitutionEntry('1', 91, 94),
        16: new ConstitutionEntry('2', 95, 96),
        // *cap @ +2 unless fighter type
        // 17 +3*
        // 18 +4*
        17: new ConstitutionEntry('3', 97, 98),
        18: new ConstitutionEntry('4', 99, 100),
        19: new ConstitutionEntry('5', 99, 100),
        20: new ConstitutionEntry('5', 99, 100),
        21: new ConstitutionEntry('6', 99, 100),
        22: new ConstitutionEntry('6', 99, 100),
        23: new ConstitutionEntry('6', 99, 100),
        24: new ConstitutionEntry('7', 99, 100),
        25: new ConstitutionEntry('7', 99, 100),
      };
    }

    getEntry(str_value) {
      return this.constitution_dict[getValidVariable(str_value, 'constitution', 3, 25)];
    }
  }

  class CharismaEntry {
    constructor(maximumhenchmen, loyaltybonus, reactionbonus, comeliness_cha_adj) {
      this.maximumhenchmen = maximumhenchmen;
      this.loyaltybonus = loyaltybonus;
      this.reactionbonus = reactionbonus;
      this.comeliness = comeliness_cha_adj;
    }

    MaximumHenchmen() {
      return this.maximumhenchmen;
    }

    getLoyaltyBonus() {
      return this.loyaltybonus;
    }

    getReactionBonus() {
      return this.reactionbonus;
    }

    getComeliness() {
      return this.comeliness;
    }
  }

  class CharismaAdjustmentTable {
    constructor() {
      // maximumhenchmen loyaltybonus reactionbonus comeliness_cha_adj
      this.charisma_dict = {
        3: new CharismaEntry(1, -30, -25, -5),
        4: new CharismaEntry(1, -25, -20, -3),
        5: new CharismaEntry(2, -20, -15, -3),
        6: new CharismaEntry(2, -15, -10, -1),
        7: new CharismaEntry(3, -10, -5, -1),
        8: new CharismaEntry(3, -5, 0, -1),
        9: new CharismaEntry(4, 0, 0, 0),
        10: new CharismaEntry(4, 0, 0, 0),
        11: new CharismaEntry(4, 0, 0, 0),
        12: new CharismaEntry(5, 0, 0, 0),
        13: new CharismaEntry(5, 0, 5, 1),
        14: new CharismaEntry(6, 5, 10, 1),
        15: new CharismaEntry(7, 15, 15, 1),
        16: new CharismaEntry(8, 20, 25, 2),
        17: new CharismaEntry(10, 30, 30, 2),
        18: new CharismaEntry(15, 40, 35, 3),
        19: new CharismaEntry(20, 50, 40, 5),
        20: new CharismaEntry(25, 60, 45, 5),
        21: new CharismaEntry(30, 70, 50, 5),
        22: new CharismaEntry(35, 80, 55, 5),
        23: new CharismaEntry(40, 90, 60, 5),
        24: new CharismaEntry(45, 100, 65, 5),
        25: new CharismaEntry(50, 100, 70, 5),
      };
    }

    getEntry(str_value) {
      return this.charisma_dict[getValidVariable(str_value, 'charisma', 3, 25)];
    }
  }

  // Globals for Ability Calcs
  const AT_STR = new StrengthAdjustmentTable();
  const AT_INT = new IntelligenceAdjustmentTable();
  const AT_WIS = new WisdomAdjustmentTable();
  const AT_DEX = new DexterityAdjustmentTable();
  const AT_CON = new ConstitutionAdjustmentTable();
  const AT_CHA = new CharismaAdjustmentTable();

  // Allows easy modification of variables
  const parseValues = (values, stat, type = 'int') => {
    if (type === 'int') return parseInt(values[stat]) || 0;
    if (type === 'float') return parseFloat(values[stat]) || 0;
    if (type === 'str') return values[stat];
    return null;
  };

  // Ability Row Calculations
  strengthCalcs = () => {
    getAttrs(['strength', 'exceptionalstrength'], (values) => {
      const output = {};
      const stat_str = parseValues(values, 'strength', 'int');
      let stat_str_per = parseValues(values, 'exceptionalstrength');
      // Special check for perfect strength
      if (parseValues(values, 'exceptionalstrength', 'str') === '00') stat_str_per = 100;
      output.exceptionalstrength = stat_str_per;
      output.meleebonus = (AT_STR.getStrengthValue('Attack', stat_str, stat_str_per) <= 0 ? '' : '+') + AT_STR.getStrengthValue('Attack', stat_str, stat_str_per);
      output.dmgbonus = (AT_STR.getStrengthValue('Damage', stat_str, stat_str_per) <= 0 ? '' : '+') + AT_STR.getStrengthValue('Damage', stat_str, stat_str_per);
      output.majorstrengthfeat = AT_STR.getStrengthValue('Major', stat_str, stat_str_per);
      output.minorstrengthfeat = AT_STR.getStrengthValue('Minor', stat_str, stat_str_per);
      output.minorstrengthfeat_locked = AT_STR.getStrengthValue('Minor', stat_str, stat_str_per, true);
      output.encumbrancebonus = (AT_STR.getStrengthValue('Encumbrance', stat_str, stat_str_per) <= 0 ? '' : '+') + AT_STR.getStrengthValue('Encumbrance', stat_str, stat_str_per);
      setAttrs(output);
    });
  };

  intelligenceCalcs = () => {
    getAttrs(['intelligence', 'bonuslanguages', 'race'], (values) => {
      const output = {};
      const stat_int = parseValues(values, 'intelligence', 'int');
      // set bonus languages if human
      const race_value = parseValues(values, 'race', 'str');
      if (/human/gi.test(race_value)) {
        output.bonuslanguages = AT_INT.getEntry(stat_int).getBonusLanguages();
      } else {
        // clog('Demi-Human: Bonus Languages Not Set');
        return;
      }
      output.knowspell = AT_INT.getEntry(stat_int).getKnowSpell();
      output.minspells = AT_INT.getEntry(stat_int).getMinSpells();
      output.maxspells = AT_INT.getEntry(stat_int).getMaxSpells();
      setAttrs(output, {silent: true});
    });
  };

  wisdomCalcs = () => {
    getAttrs(['wisdom'], (values) => {
      const output = {};
      const stat_wis = parseValues(values, 'wisdom', 'int');
      output.mentalsavebonus = (AT_WIS.getEntry(stat_wis).getMentalSaveBonus() <= 0 ? '' : '+') + AT_WIS.getEntry(stat_wis).getMentalSaveBonus();
      output.spellbonus = AT_WIS.getEntry(stat_wis).getSpellBonus();
      output.spellfailure = AT_WIS.getEntry(stat_wis).getSpellFailure();
      setAttrs(output, {silent: true});
    });
  };

  dexterityCalcs = () => {
    getAttrs(['dexterity'], (values) => {
      const output = {};
      const stat_dex = parseValues(values, 'dexterity', 'int');
      const surpriseBon = AT_DEX.getEntry(stat_dex).getSurpriseBonus();
      const surprisebonus_add_sign = (-1 * surpriseBon <= 0 ? '' : '+') + -1 * surpriseBon;
      output.surprisebonus = AT_DEX.getEntry(stat_dex).getSurpriseBonus();
      output.surprisebonus_inverted = surprisebonus_add_sign;
      output.rangedbonus = (AT_DEX.getEntry(stat_dex).getRangedBonus() <= 0 ? '' : '+') + AT_DEX.getEntry(stat_dex).getRangedBonus();
      output.armorbonus = (AT_DEX.getEntry(stat_dex).getArmorBonus() <= 0 ? '' : '+') + AT_DEX.getEntry(stat_dex).getArmorBonus();
      setAttrs(output);
    });
  };

  constitutionCalcs = () => {
    getAttrs(['constitution', 'class', 'secondclass', 'thirdclass'], (values) => {
      const output = {};
      const stat_con = parseValues(values, 'constitution', 'int');
      // check classes for FRP otherwise cap at HP bonus at +2
      const classes = [values.class, values.secondclass, values.thirdclass];
      if (/fighter/gi.test(classes) || /paladin/gi.test(classes) || /ranger/gi.test(classes)) {
        // clog(`${classes.join(' ')} class. Using expanded HP bonus.`);
        output.hitpointbonus = (AT_CON.getEntry(stat_con).getHitpointBonus() <= 0 ? '' : '+') + AT_CON.getEntry(stat_con).getHitpointBonus();
      } else {
        output.hitpointbonus = (Math.min(AT_CON.getEntry(stat_con).getHitpointBonus(), 2) <= 0 ? '' : '+') + Math.min(AT_CON.getEntry(stat_con).getHitpointBonus(), 2);
      }
      output.systemshock = AT_CON.getEntry(stat_con).getSystemShock();
      output.resurrectionsurvival = AT_CON.getEntry(stat_con).getResurrectionSurvival();
      setAttrs(output);
    });
  };

  charismaCalcs = () => {
    getAttrs(['charisma'], (values) => {
      const output = {};
      const stat_cha = parseValues(values, 'charisma', 'int');
      output.maximumhenchmen = AT_CHA.getEntry(stat_cha).MaximumHenchmen();
      output.loyaltybonus = (AT_CHA.getEntry(stat_cha).getLoyaltyBonus() <= 0 ? '' : '+') + AT_CHA.getEntry(stat_cha).getLoyaltyBonus();
      output.reactionbonus = (AT_CHA.getEntry(stat_cha).getReactionBonus() <= 0 ? '' : '+') + AT_CHA.getEntry(stat_cha).getReactionBonus();
      output.comeliness_cha_adj = (AT_CHA.getEntry(stat_cha).getComeliness() <= 0 ? '' : '+') + AT_CHA.getEntry(stat_cha).getComeliness();
      setAttrs(output, {silent: true});
    });
  };

  on('change:strength change:exceptionalstrength', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    strengthCalcs();
  });

  // Intelligence Calculations
  on('change:intelligence change:race', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    intelligenceCalcs();
  });

  // Wisdom Calculations
  on('change:wisdom', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    wisdomCalcs();
  });

  // Dexterity Calculations
  on('change:dexterity', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    dexterityCalcs();
  });

  // Constitution Calculations
  on('change:constitution change:class change:secondclass change:thirdclass', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    constitutionCalcs();
  });

  // Charisma Calculations
  on('change:charisma change:comeliness', (eventInfo) => {
    // clog(`Change Detected:${eventInfo.sourceAttribute}`);
    charismaCalcs();
  });

  // uses CRP to auto-update link with sheet_image_src
  on('clicked:postimage', (eventInfo) => {
    getAttrs(['character_avatar', 'sheet_image', 'sheet_image_url', 'toggle_npc'], (v) => {
      const output = {};
      const whisper = +v.toggle_npc === 1 ? '@{whisper_npc}' : '@{whisper_pc}';
      const whichImage = +v.sheet_image;
      const sheetURL = v.sheet_image_url;
      const avatarURL = v.character_avatar;
      output.sheet_image_src = whichImage === 0 ? sheetURL : avatarURL;
      const roll_string = `${whisper} @{sheet_image_src}`;
      startRoll(roll_string, (roll) => {
        finishRoll(roll.rollId);
      });
      setAttrs(output, {silent: true});
    });
  });

  on('change:psionic_ability_strength_max change:psionic_attack change:psionic_defense', (eventInfo) => {
    getAttrs(['psionic_ability_strength_max'], (v) => {
      const output = {};
      const strengthMax = v.psionic_ability_strength_max;
      output.psionic_attack_max = float(strengthMax / 2).toFixed(1);
      output.psionic_defense_max = float(strengthMax / 2).toFixed(1);
      setAttrs(output, {silent: true});
    });
  });
</script>