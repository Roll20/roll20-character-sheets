var It=()=>self.dispatchEvent==null,j=i=>{let r=getActiveCharacterId(),o={id:"0",type:"setActiveCharacter",data:i};if(It()==!1){let e=new CustomEvent("message");e.data=o,self.dispatchEvent(e)}else self.onmessage({data:o});return r},Nt=setInterval;setInterval=function(i,r){let o=getActiveCharacterId();Nt(function(){let e=j(o);i(),j(e)},r)};var Dt=setTimeout;setTimeout=function(i,r){let o=getActiveCharacterId();Dt(function(){let e=j(o);i(),j(e)},r)};var be=i=>new Promise(r=>setTimeout(r,i)),u=i=>{let r=getActiveCharacterId(),o=null;return new Promise((e,n)=>{o=j(r);try{getAttrs(i,a=>{e(a)})}catch{n()}}).finally(()=>{j(o)})},g=(i,r)=>{let o=getActiveCharacterId(),e=null;return new Promise((n,a)=>{e=j(o);try{setAttrs(i,r,t=>{n(t)})}catch{a()}}).finally(()=>{j(e)})},f=i=>{let r=getActiveCharacterId(),o=null;return new Promise((e,n)=>{o=j(r);try{getSectionIDs(i,a=>{e(a)})}catch{n()}}).finally(()=>{j(o)})},q=(i,r=0)=>parseInt(i)||r,E=(i,r=0)=>parseFloat(i)||r,b=(i,r="green")=>{let o=`%c ${i}`;console.log(o,`color: ${r}; font-weight:bold`)},d=(i,r=0)=>typeof i<"u"&&i!==r,$e=(i,r)=>{let o=i;return _.each(Object.entries(r),([e,n])=>{o=o.replace(new RegExp(e.replace("{","{"),"gi"),n)}),o},Ct=async i=>/^[a-zA-Z0-9\s]+$/.test(i)?!0:!/[)|\}]/.test(i),Ot=async i=>/^[-+]?[0-9]+$/.test(i)?1:0,ha={},k=()=>{let i=generateRowID();for(;ha[i]===!0;)i=generateRowID();return ha[i]=!0,i};on("change:character_name",async i=>{let r=await u(["character_name"]),o={},e=r[`${i.sourceAttribute}`],n=await Ct(e);o[`${i.sourceAttribute}_error`]=n,await g(o,{silent:!0})});on("change:armortype_magic change:armortype2_magic change:armorshield_magic change:armorhelmet_magic change:armorother_magic change:armorother2_magic change:armorother3_magic change:armorother4_magic change:armorother5_magic change:armorother6_magic change:armorshield_mod change:armorother_mod change:armorother2_mod change:armorother3_mod change:armorother4_mod change:armorother5_mod change:armorother6_mod change:repeating_equipment:equipment_armor_mod change:repeating_equipment:equipment_armor_magic, change:hitpoints_1_class, change:hitpoints_2_class, change:hitpoints_3_class",async i=>{let r=i.sourceAttribute.split("_")[2],o=await u(["armortype_magic","armortype2_magic","armorshield_magic","armorhelmet_magic","armorother_magic","armorother2_magic","armorother3_magic","armorother4_magic","armorother5_magic","armorother6_magic","armorshield_mod","armorother_mod","armorother2_mod","armorother3_mod","armorother4_mod","armorother5_mod","armorother6_mod",`repeating_equipment_${r}_equipment_armor_magic`,`repeating_equipment_${r}_equipment_armor_mod`,"hitpoints_1_class","hitpoints_2_class","hitpoints_3_class"]),e={},n=o[`${i.sourceAttribute}`],a=await Ot(n);e[`${i.sourceAttribute}_error`]=a,await g(e,{silent:!0})});var ye=["unarmored_row_id","armortype1_row_id","armortype2_row_id","armorshield_row_id","armorhelmet_row_id","armorother1_row_id","armorother2_row_id","armorother3_row_id","armorother4_row_id","armorother5_row_id","armorother6_row_id"],fe=["unarmored_worn","unarmored","unarmored_ac","unarmored_base","unarmored_bulk","unarmored_carried","unarmored_weight","unarmored_cost","armortype_worn","armortype","armortype_ac","armortype_base","armortype_magic","armortype_bulk","armortype_carried","armor_weight","armor_cost","armortype2_worn","armortype2","armortype2_ac","armortype2_base","armortype2_magic","armortype2_bulk","armortype2_carried","armortype2_weight","armortype2_cost","armorshield_worn","armorshield","armorshield_ac","armorshield_base","armorshield_magic","armorshield_mod","armorshield_bulk","armorshield_carried","armorshield_weight","armorshield_cost","armorhelmet_worn","armorhelmet","armorhelmet_ac","armorhelmet_magic","armorhelmet_bulk","armorhelmet_carried","armorhelmet_weight","armorhelmet_cost","armorother_worn","armorother","armorother_ac","armorother_base","armorother_magic","armorother_mod","armorother2_worn","armorother2","armorother2_ac","armorother2_base","armorother2_magic","armorother2_mod","armorother3_worn","armorother3","armorother3_ac","armorother3_base","armorother3_magic","armorother3_mod","armorother4_worn","armorother4","armorother4_ac","armorother4_base","armorother4_magic","armorother4_mod","armorother5_worn","armorother5","armorother5_ac","armorother5_base","armorother5_magic","armorother5_mod","armorother6_worn","armorother6","armorother6_ac","armorother6_base","armorother6_magic","armorother6_mod"],Tt=["unarmored_worn","unarmored","unarmored_ac","unarmored_base","unarmored_bulk","unarmored_carried","unarmored_weight","unarmored_cost"],Et=["armortype_worn","armortype","armortype_ac","armortype_base","armortype_magic","armortype_bulk","armortype_carried","armor_weight","armor_cost"],Lt=["armortype2_worn","armortype2","armortype2_ac","armortype2_base","armortype2_magic","armortype2_bulk","armortype2_carried","armortype2_weight","armortype2_cost"],Rt=["armorshield_worn","armorshield","armorshield_ac","armorshield_base","armorshield_magic","armorshield_mod","armorshield_bulk","armorshield_carried","armorshield_weight","armorshield_cost"],Pt=["armorhelmet_worn","armorhelmet","armorhelmet_ac","armorhelmet_magic","armorhelmet_bulk","armorhelmet_carried","armorhelmet_weight","armorhelmet_cost"],Bt=["armorother_worn","armorother","armorother_ac","armorother_base","armorother_magic","armorother_mod"],jt=["armorother2_worn","armorother2","armorother2_ac","armorother2_base","armorother2_magic","armorother2_mod"],Ut=["armorother3_worn","armorother3","armorother3_ac","armorother3_base","armorother3_magic","armorother3_mod"],Vt=["armorother4_worn","armorother4","armorother4_ac","armorother4_base","armorother4_magic","armorother4_mod"],Wt=["armorother5_worn","armorother5","armorother5_ac","armorother5_base","armorother5_magic","armorother5_mod"],Ht=["armorother6_worn","armorother6","armorother6_ac","armorother6_base","armorother6_magic","armorother6_mod"],re=(i,r,o)=>`repeating_${i}_${r}_${o}`,Ft=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.flatMap(n=>[`repeating_weapon_${n}_DmgBonus`,`repeating_weapon_${n}_macro-text`]);getAttrs([...e],n=>{let a={},t="&{template:attacks} {{name=@{character_name}}} {{subtag=@{WeaponName}}} {{attack1=[[1d20 + @{ToHitBonus}[BON] + @{MagicBonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{DamageSmallMedium} + @{DmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{DamageLarge} + @{DmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{WeaponNotes}}} @{whisper_to-hit}";_.each(o,s=>{let c=n[`repeating_weapon_${s}_macro-text`]||t;a[`repeating_weapon_${s}_macro-text`]=c.replace(/@{DmgBonus}/g,"@{AttackDmgBonus}"),a[`repeating_weapon_${s}_AttackDmgBonus`]=+n[`repeating_weapon_${s}_DmgBonus`]||0}),a.sheet_version=i,b("VERSION UPDATE: dmgSwap completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Gt=(i,r)=>{getSectionIDs("repeating_ability",o=>{let e=o.map(n=>[`repeating_ability_${n}_max`]);getAttrs([...e],n=>{let a={};_.each(o,t=>{a[`repeating_ability_${t}_current_max`]=+n[`repeating_ability_${t}_max`]||0}),a.sheet_version=i,b("VERSION UPDATE: maxSwap completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},zt=(i,r)=>{let o={};getSectionIDs("repeating_nonweaponproficiencies",e=>{let n=e.map(a=>[`repeating_nonweaponproficiencies_${a}_macro-text`]);getAttrs([...n],a=>{let t={nwp_old:"&{template:general} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{=@{short_description}}}{{Success Amount=[[((@{rAttribute})+(@{rSlots}-1)-1d20)cs>1cf<-1]]}}",nwp_new:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{Proficiency Check=[[ 1d20 + [[@{rmodifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{rAttribute}[ATTR] ]]}}{{freetext=@{short_description}}}"};_.each(e,s=>{a[`repeating_nonweaponproficiencies_${s}_macro-text`]&&(o[`repeating_nonweaponproficiencies_${s}_macro-text`]=a[`repeating_nonweaponproficiencies_${s}_macro-text`].replace(t.nwp_old,t.nwp_new))}),o.sheet_version=i,b("VERSION UPDATE: nwpMacroUpdate completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})})})},Kt=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.flatMap(n=>[`repeating_weapon_${n}_roll`,`repeating_weapon_${n}_weaponname`,`repeating_weapon_${n}_tohitbonus`,`repeating_weapon_${n}_magicbonus`,`repeating_weapon_${n}_attackdmgbonus`,`repeating_weapon_${n}_whisper_to-hit`,`repeating_weapon_${n}_macro-text`,`repeating_weapon_${n}_damagesmallmedium`,`repeating_weapon_${n}_damagelarge`,`repeating_weapon_${n}_rateoffire`,`repeating_weapon_${n}_range`,`repeating_weapon_${n}_quantity`,`repeating_weapon_${n}_weight`,`repeating_weapon_${n}_weaponspeed`,`repeating_weapon_${n}_cost`,`repeating_weapon_${n}_weaponnotes`]);getAttrs([...e],n=>{let a={},t={"@{rateoffire}":"@{weapon_rateoffire}","@{weaponname}":"@{weapon_name}","@{tohitbonus}":"@{weapon_tohitbonus}","@{magicbonus}":"@{weapon_magicbonus}","@{attackdmgbonus}":"@{weapon_attackdmgbonus}","@{whisper_to-hit}":"@{weapon_whisper_to_hit}","@{damagesmallmedium}":"@{weapon_damagesmallmedium}","@{damagelarge}":"@{weapon_damagelarge}","@{range}":"@{weapon_range}","@{quantity}":"@{weapon_quantity}","@{weight}":"@{weapon_weight}","@{weaponspeed}":"@{weapon_speed}","@{cost}":"@{weapon_cost}","@{macro-text}":"@{weapon_macro_text}","@{weaponnotes}":"@{weapon_notes}"},s="&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{WeaponName}}} {{attack1=[[1d20 + @{ToHitBonus}[BON] + @{MagicBonus}[MAG] + ?{To Hit Modifier?|0}[MOD]) ]]}} {{damage1vsSM=[[@{DamageSmallMedium} + @{AttackDmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{DamageLarge} + @{AttackDmgBonus}[BON] + @{MagicBonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{WeaponNotes}}} @{whisper_to-hit}";_.each(o,c=>{d(n[`repeating_weapon_${c}_rateoffire`])&&(a[`repeating_weapon_${c}_weapon_rateoffire`]=q(n[`repeating_weapon_${c}_rateoffire`])),d(n[`repeating_weapon_${c}_roll`])&&(a[`repeating_weapon_${c}_weapon_roll`]=n[`repeating_weapon_${c}_roll`]),d(n[`repeating_weapon_${c}_weaponname`])&&(a[`repeating_weapon_${c}_weapon_name`]=n[`repeating_weapon_${c}_weaponname`]),d(n[`repeating_weapon_${c}_tohitbonus`])&&(a[`repeating_weapon_${c}_weapon_tohitbonus`]=q(n[`repeating_weapon_${c}_tohitbonus`])),d(n[`repeating_weapon_${c}_magicbonus`])&&(a[`repeating_weapon_${c}_weapon_magicbonus`]=q(n[`repeating_weapon_${c}_magicbonus`])),d(n[`repeating_weapon_${c}_attackdmgbonus`])&&(a[`repeating_weapon_${c}_weapon_attackdmgbonus`]=q(n[`repeating_weapon_${c}_attackdmgbonus`])),d(n[`repeating_weapon_${c}_whisper_to-hit`])&&(a[`repeating_weapon_${c}_weapon_whisper_to_hit`]=n[`repeating_weapon_${c}_whisper_to-hit`]),d(n[`repeating_weapon_${c}_macro-text`],s)&&(a[`repeating_weapon_${c}_weapon_macro_text`]=$e(n[`repeating_weapon_${c}_macro-text`],t)),d(n[`repeating_weapon_${c}_damagesmallmedium`])&&(a[`repeating_weapon_${c}_weapon_damagesmallmedium`]=n[`repeating_weapon_${c}_damagesmallmedium`]),d(n[`repeating_weapon_${c}_damagelarge`])&&(a[`repeating_weapon_${c}_weapon_damagelarge`]=n[`repeating_weapon_${c}_damagelarge`]),d(n[`repeating_weapon_${c}_range`])&&(a[`repeating_weapon_${c}_weapon_range`]=n[`repeating_weapon_${c}_range`]),d(n[`repeating_weapon_${c}_quantity`])&&(a[`repeating_weapon_${c}_weapon_quantity`]=E(n[`repeating_weapon_${c}_quantity`])),d(n[`repeating_weapon_${c}_weight`])&&(a[`repeating_weapon_${c}_weapon_weight`]=E(n[`repeating_weapon_${c}_weight`])),d(n[`repeating_weapon_${c}_weaponspeed`])&&(a[`repeating_weapon_${c}_weapon_speed`]=q(n[`repeating_weapon_${c}_weaponspeed`])),d(n[`repeating_weapon_${c}_cost`])&&(a[`repeating_weapon_${c}_weapon_cost`]=E(n[`repeating_weapon_${c}_cost`])),d(n[`repeating_weapon_${c}_weaponnotes`])&&(a[`repeating_weapon_${c}_weapon_notes`]=n[`repeating_weapon_${c}_weaponnotes`])}),a.sheet_version=i,b("VERSION UPDATE: weaponNameFix completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Xt=(i,r)=>{getSectionIDs("repeating_spells",o=>{let e=o.flatMap(n=>[`repeating_spells_${n}_roll`,`repeating_spells_${n}_memorized`,`repeating_spells_${n}_level`,`repeating_spells_${n}_name`,`repeating_spells_${n}_school`,`repeating_spells_${n}_range`,`repeating_spells_${n}_duration`,`repeating_spells_${n}_aoe`,`repeating_spells_${n}_components`,`repeating_spells_${n}_ct`,`repeating_spells_${n}_save`,`repeating_spells_${n}_macro-text`,`repeating_spells_${n}_description`,`repeating_spells_${n}_description-show`]);getAttrs([...e],n=>{let a={},t={"@{memorized}":"@{spell_memorized}","@{level}":"@{spell_level}","@{name}":"@{spell_name}","@{school}":"@{spell_school}","@{range}":"@{spell_range}","@{duration}":"@{spell_duration}","@{aoe}":"@{spell_aoe}","@{components}":"@{spell_components}","@{ct}":"@{spell_ct}","@{save}":"@{spell_save}","@{macro-text}":"@{spell_macro_text}","@{description}":"@{spell_description}"},s="&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{name}}} {{Level:=@{level}}} {{Range:=@{range}}} {{Duration:=@{duration}}} {{AOE:=@{aoe}}} {{Comp:=@{components}}} {{CT:=@{ct}}} {{Save:=@{save}}} {{freetext=@{description}}}";_.each(o,c=>{d(n[`repeating_spells_${c}_roll`])&&(a[`repeating_spells_${c}_spell_roll`]=n[`repeating_spells_${c}_roll`]),d(n[`repeating_spells_${c}_memorized`])&&(a[`repeating_spells_${c}_spell_memorized`]=q(n[`repeating_spells_${c}_memorized`])),d(n[`repeating_spells_${c}_level`])&&(a[`repeating_spells_${c}_spell_level`]=n[`repeating_spells_${c}_level`]),d(n[`repeating_spells_${c}_name`])&&(a[`repeating_spells_${c}_spell_name`]=n[`repeating_spells_${c}_name`]),d(n[`repeating_spells_${c}_school`])&&(a[`repeating_spells_${c}_spell_school`]=n[`repeating_spells_${c}_school`]),d(n[`repeating_spells_${c}_range`])&&(a[`repeating_spells_${c}_spell_range`]=n[`repeating_spells_${c}_range`]),d(n[`repeating_spells_${c}_duration`])&&(a[`repeating_spells_${c}_spell_duration`]=n[`repeating_spells_${c}_duration`]),d(n[`repeating_spells_${c}_aoe`])&&(a[`repeating_spells_${c}_spell_aoe`]=n[`repeating_spells_${c}_aoe`]),d(n[`repeating_spells_${c}_components`])&&(a[`repeating_spells_${c}_spell_components`]=n[`repeating_spells_${c}_components`]),d(n[`repeating_spells_${c}_ct`])&&(a[`repeating_spells_${c}_spell_ct`]=n[`repeating_spells_${c}_ct`]),d(n[`repeating_spells_${c}_save`])&&(a[`repeating_spells_${c}_spell_save`]=n[`repeating_spells_${c}_save`]),d(n[`repeating_spells_${c}_macro-text`],s)&&(a[`repeating_spells_${c}_spell_macro_text`]=$e(n[`repeating_spells_${c}_macro-text`],t)),d(n[`repeating_spells_${c}_description`])&&(a[`repeating_spells_${c}_spell_description`]=n[`repeating_spells_${c}_description`]),d(n[`repeating_spells_${c}_description-show`])&&(a[`repeating_spells_${c}_spell_description_show`]=q(n[`repeating_spells_${c}_description-show`]))}),a.sheet_version=i,b("VERSION UPDATE: spellNameFix completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Qt=(i,r)=>{getSectionIDs("repeating_equipment",o=>{let e=o.flatMap(n=>[`repeating_equipment_${n}_item-show`,`repeating_equipment_${n}_item`,`repeating_equipment_${n}_location`,`repeating_equipment_${n}_carried`,`repeating_equipment_${n}_quantity`,`repeating_equipment_${n}_quantity_max`,`repeating_equipment_${n}_weight`,`repeating_equipment_${n}_cos`]);getAttrs([...e],n=>{let a={};_.each(o,t=>{d(n[`repeating_equipment_${t}_item-show`])&&(a[`repeating_equipment_${t}_equipment_item_show`]=n[`repeating_equipment_${t}_item-show`]),d(n[`repeating_equipment_${t}_item`])&&(a[`repeating_equipment_${t}_equipment_item`]=n[`repeating_equipment_${t}_item`]),d(n[`repeating_equipment_${t}_location`])&&(a[`repeating_equipment_${t}_equipment_location`]=n[`repeating_equipment_${t}_location`]),d(n[`repeating_equipment_${t}_carried`])&&(a[`repeating_equipment_${t}_equipment_carried`]=n[`repeating_equipment_${t}_carried`]),d(n[`repeating_equipment_${t}_quantity`])&&(a[`repeating_equipment_${t}_equipment_quantity`]=E(n[`repeating_equipment_${t}_quantity`])),d(n[`repeating_equipment_${t}_quantity_max`])&&(a[`repeating_equipment_${t}_equipment_quantity_max`]=E(n[`repeating_equipment_${t}_quantity_max`])),d(n[`repeating_equipment_${t}_weight`])&&(a[`repeating_equipment_${t}_equipment_weight`]=E(n[`repeating_equipment_${t}_weight`])),d(n[`repeating_equipment_${t}_cost`])&&(a[`repeating_equipment_${t}_equipment_cost`]=E(n[`repeating_equipment_${t}_cost`]))}),a.sheet_version=i,b("VERSION UPDATE: equipmentNameFix completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Yt=(i,r)=>{getSectionIDs("repeating_ability",o=>{let e=o.flatMap(n=>[`repeating_equipment_${n}_roll`,`repeating_equipment_${n}_name`,`repeating_equipment_${n}_short_description`,`repeating_equipment_${n}_current`,`repeating_equipment_${n}_current_max`,`repeating_equipment_${n}_macro-text`,`repeating_equipment_${n}_description`,`repeating_equipment_${n}_description-show`]);getAttrs([...e],n=>{let a={},t={"@{name}":"@{ability_name}","@{current}":"@{ability_current}","@{current_max}":"@{ability_current_max}","@{short_description}":"@{ability_short_description}","@{macro-text}":"@{ability_macro_text}","@{description}":"@{ability_description}"},s="&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{name}}} {{freetext=@{short_description} @{description}}}";_.each(o,c=>{d(n[`repeating_equipment_${c}_roll`])&&(a[`repeating_equipment_${c}_ability_roll`]=n[`repeating_equipment_${c}_roll`]),d(n[`repeating_equipment_${c}_name`])&&(a[`repeating_equipment_${c}_ability_name`]=n[`repeating_equipment_${c}_name`]),d(n[`repeating_equipment_${c}_short_description`])&&(a[`repeating_equipment_${c}_ability_short_description`]=n[`repeating_equipment_${c}_short_description`]),d(n[`repeating_equipment_${c}_current`])&&(a[`repeating_equipment_${c}_ability_current`]=q(n[`repeating_equipment_${c}_current`])),d(n[`repeating_equipment_${c}_current_max`])&&(a[`repeating_equipment_${c}_ability_current_max`]=q(n[`repeating_equipment_${c}_current_max`])),d(n[`repeating_equipment_${c}_macro-text`],s)&&(a[`repeating_equipment_${c}_ability_macro_text`]=$e(n[`repeating_equipment_${c}_macro-text`],t)),d(n[`repeating_equipment_${c}_description`])&&(a[`repeating_equipment_${c}_ability_description`]=n[`repeating_equipment_${c}_description`]),d(n[`repeating_equipment_${c}_description-show`])&&(a[`repeating_equipment_${c}_ability_description_show`]=q(n[`repeating_equipment_${c}_description-show`]))}),a.sheet_version=i,b("VERSION UPDATE: abilityNameFix completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Zt=(i,r)=>{getSectionIDs("repeating_nonweaponproficiencies",o=>{let e=o.flatMap(n=>[`repeating_nonweaponproficiencies_${n}_roll`,`repeating_nonweaponproficiencies_${n}_name`,`repeating_nonweaponproficiencies_${n}_rAttribute`,`repeating_nonweaponproficiencies_${n}_short_description`,`repeating_nonweaponproficiencies_${n}_rSlots`,`repeating_nonweaponproficiencies_${n}_rModifier`,`repeating_nonweaponproficiencies_${n}_macro-text`,`repeating_nonweaponproficiencies_${n}_description-show`,`repeating_nonweaponproficiencies_${n}_description`]);getAttrs([...e],n=>{let a={},t={"@{name}":"@{nwp_name}","@{rAttribute}":"@{nwp_attribute}","@{rSlots}":"@{nwp_slots}","@{rModifier}":"@{nwp_modifier}","@{short_description}":"@{nwp_short_description}","@{macro-text}":"@{nwp_macro_text}","@{description}":"@{nwp_description}"},s="&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{name}}} {{Proficiency Check=[[ 1d20 + [[@{rmodifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{rAttribute}[ATTR] ]]}}{{freetext=@{short_description}}}";_.each(o,c=>{d(n[`repeating_nonweaponproficiencies_${c}_roll`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_roll`]=n[`repeating_nonweaponproficiencies_${c}_roll`]),d(n[`repeating_nonweaponproficiencies_${c}_name`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_name`]=n[`repeating_nonweaponproficiencies_${c}_name`]),d(n[`repeating_nonweaponproficiencies_${c}_rAttribute`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_attribute`]=n[`repeating_nonweaponproficiencies_${c}_rAttribute`].toLowerCase()),d(n[`repeating_nonweaponproficiencies_${c}_short_description`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_short_description`]=n[`repeating_nonweaponproficiencies_${c}_short_description`]),d(n[`repeating_nonweaponproficiencies_${c}_rSlots`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_slots`]=q(n[`repeating_nonweaponproficiencies_${c}_rSlots`])),d(n[`repeating_nonweaponproficiencies_${c}_rModifier`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_modifier`]=q(n[`repeating_nonweaponproficiencies_${c}_rModifier`])),d(n[`repeating_nonweaponproficiencies_${c}_macro-text`],s)&&(a[`repeating_nonweaponproficiencies_${c}_nwp_macro_text`]=$e(n[`repeating_nonweaponproficiencies_${c}_macro-text`],t)),d(n[`repeating_nonweaponproficiencies_${c}_description-show`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_description_show`]=q(n[`repeating_nonweaponproficiencies_${c}_description-show`])),d(n[`repeating_nonweaponproficiencies_${c}_description`])&&(a[`repeating_nonweaponproficiencies_${c}_nwp_description`]=n[`repeating_nonweaponproficiencies_${c}_description`])}),a.sheet_version=i,b("VERSION UPDATE: nwpNameFix completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},Jt=(i,r)=>{let o={};getSectionIDs("repeating_nonweaponproficiencies",e=>{getSectionIDs("repeating_weapon",n=>{getSectionIDs("repeating_ability",a=>{getSectionIDs("repeating_spells",t=>{let s=[],c=[],m=[],h=[];_.each(e,l=>{s.push(`repeating_nonweaponproficiencies_${l}_nwp_macro_text`)}),_.each(n,l=>{c.push(`repeating_weapon_${l}_weapon_macro_text`)}),_.each(a,l=>{m.push(`repeating_ability_${l}_ability_macro_text`)}),_.each(t,l=>{h.push(`repeating_spells_${l}_spell_macro_text`)}),getAttrs([...s,...c,...m,...h],l=>{let p={nwp_old:"&{template:general} {{name=@{character_name}}}",nwp_new:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}",wpn_old:"&{template:attacks} {{name=@{character_name}}}",wpn_new:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}}",abl_old:"&{template:general} {{name=@{character_name}}}",abl_new:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}",spl_old:"&{template:general} {{name=@{character_name}}}",spl_new:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}}"};_.each(e,w=>{l[`repeating_nonweaponproficiencies_${w}_nwp_macro_text`]&&(o[`repeating_nonweaponproficiencies_${w}_nwp_macro_text`]=l[`repeating_nonweaponproficiencies_${w}_nwp_macro_text`].replace(p.nwp_old,p.nwp_new),b("VERSION UPDATE: colorUpdate completed"))}),_.each(n,w=>{l[`repeating_weapon_${w}_weapon_macro_text`]&&(o[`repeating_weapon_${w}_weapon_macro_text`]=l[`repeating_weapon_${w}_weapon_macro_text`].replace(p.wpn_old,p.wpn_new),b("VERSION UPDATE: colorUpdate completed"))}),_.each(a,w=>{l[`repeating_ability_${w}_ability_macro_text`]&&(o[`repeating_ability_${w}_ability_macro_text`]=l[`repeating_ability_${w}_ability_macro_text`].replace(p.abl_old,p.abl_new),b("VERSION UPDATE: colorUpdate completed"))}),_.each(t,w=>{l[`repeating_spells_${w}_spell_macro_text`]&&(o[`repeating_spells_${w}_spell_macro_text`]=l[`repeating_spells_${w}_spell_macro_text`].replace(p.spl_old,p.spl_new),b("VERSION UPDATE: colorUpdate completed"))}),o.sheet_version=i,setAttrs(o,{silent:!0},()=>{versionator(i,r)})})})})})})},qa=()=>{za(),Ka(),Xa(),Qa(),Ya(),Za()},er=(i,r)=>{let o={};qa(),o.sheet_version=i,b("VERSION UPDATE: autoCalcAbilityRows completed"),setAttrs(o,()=>{versionator(i,r)})},ar=(i,r)=>{let o={};Ua(1),Va(1),Wa(1),Ha(1),Fa(1),o.sheet_version=i,b("VERSION UPDATE: autoCalcSaveRows(migrate) completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},tr=(i,r)=>{let o={};Na(1),Da(1),Ca(1),Oa(1),Ta(1),Ea(1),La(1),Ra(1),Pa(),Ba(),ja(),o.sheet_version=i,b("VERSION UPDATE: autoCalcThiefRows(migrate) completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},rr=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.map(n=>[`repeating_weapon_${n}_weapon_macro_text`]);getAttrs([...e],n=>{let a={},t="&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}} @{weapon_whisper_to_hit}";_.each(o,s=>{let c=n[`repeating_weapon_${s}_weapon_macro_text`]||t;a[`repeating_weapon_${s}_weapon_macro_text`]=c.replace(/} @{weapon_whisper_to_hit}/g,"}")}),a.sheet_version=i,b("VERSION UPDATE: removeWhisper completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},_r=(i,r)=>{getAttrs(["hitpoints_max","hitpoints_1_class","hitpoints_2_class","hitpoints_3_class"],o=>{let e={},n=+o.hitpoints_max||0,a=+o.hitpoints_1_class||0,t=+o.hitpoints_2_class||0,s=+o.hitpoints_3_class||0;q(Math.max(0,a)+Math.max(0,t)+Math.max(0,s))===0&&n>0&&(e.hitpoints_1_class=n),e.sheet_version=i,b("VERSION UPDATE: migrate HP completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)},Aa())})},nr=(i,r)=>{getAttrs(["armorclass","armortype_ac","armorclass_total","armorbonus","armorshield"],o=>{let e={},a=+o.armorclass||0,t=-Math.abs(o.armorbonus)||0,s=+o.armorclass_total||0,c=+o.armortype_ac||0;o.armorshield?c===10&&a<10&&(a+=1,e.armortype_ac=a,e.armortype_base=a,e.armortype_worn=1,e.armortype_carried=1,e.armorshield_ac=-1,e.armorshield_base=-1,e.armorshield_worn=1,e.armorshield_carried=1):c===10&&a<10&&(e.armortype_ac=a,e.armortype_base=a,e.armortype_worn=1,e.armortype_carried=1),e.sheet_version=i,b("VERSION UPDATE: Migrate AC completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)},_e(0))})},Ce=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.map(n=>[`repeating_weapon_${n}_weapon_macro_text`]);getAttrs([...e],n=>{let a={},t={weapon_old:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD] ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}}",weapon_old_v2:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{attack1=[[1d20 + @{weapon_tohitbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{To Hit Modifier?|0}[MOD]) ]]}} {{damage1vsSM=[[@{weapon_damagesmallmedium} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{damage1vsL=[[@{weapon_damagelarge} + @{weapon_attackdmgbonus}[BON] + @{weapon_magicbonus}[MAG] + ?{Damage Modifier?|0}[MOD] ]]}} {{WeaponNotes=@{weapon_notes}}}",weapon_old_v3:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} @{weapon_tohitacadj}",weapon_old_v4:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{crit=@{toggle_critdamage}}} @{weapon_tohitacadj}",weapon_old_v5:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=@{toggle_critdamage}}} @{weapon_tohitacadj}",weapon_old_v6:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=[[ @{toggle_critdamage} ]]}} @{weapon_tohitacadj}",weapon_current:"&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + ( @{weapon_backstab_bonus}[BACKSTAB] ) + ( @{weapon_tohitbonus}[HIT_BON] ) + ( @{weapon_prof_pen}[PROF_PEN] ) + ( @{weapon_dual_pen}[DUAL_PEN] ) + ( @{weapon_magicbonus}[MAG_BON] ) + ( ?{To Hit Modifier?|0}[MISC_MOD] ) ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{critdamagevsSMchatmenu=@{weapon_critdamagesmallmedium_chat_menu}}} {{critdamagevsLchatmenu=@{weapon_critdamagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} {{ammo=[[ @{weapon_ammo} ]]/[[ @{weapon_ammo|max} ]]}} {{crit=[[ @{toggle_critdamage} ]]}} @{weapon_tohitacadj}"};_.each(o,s=>{n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old_v6?a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old_v6,t.weapon_current):n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old_v5?a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old_v5,t.weapon_current):n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old_v4?a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old_v4,t.weapon_current):n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old_v3?a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old_v3,t.weapon_current):n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old_v2?a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old_v2,t.weapon_current):n[`repeating_weapon_${s}_weapon_macro_text`]===t.weapon_old&&(a[`repeating_weapon_${s}_weapon_macro_text`]=n[`repeating_weapon_${s}_weapon_macro_text`].replace(t.weapon_old,t.weapon_current))}),a.sheet_version=i,b("VERSION UPDATE: weaponMacroUpdate completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},ga=(i,r)=>{getSectionIDs("repeating_ability",o=>{let e=o.map(n=>[`repeating_ability_${n}_ability_macro_text`]);getAttrs([...e],n=>{let a={},t={ability_old:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{freetext=@{ability_short_description} @{ability_description}}}",ability_old_v2:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=@{ability_current|max}}}",ability_old_v3:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}",ability_old_v4:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}",ability_old_v5:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ @{ability_die} + @{ability_mod}[MOD] ]]}} {{link=@{ability_link}}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[@{ability_current|max}]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}",ability_current:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Special Ability: @{ability_name}}} {{roll= [[ 0 + @{ability_die} + @{ability_mod}[MOD] ]]}} {{link=@{ability_link}}} {{freetext=@{ability_short_description} @{ability_description}}} {{uses=@{ability_current}}} {{uses_max=[[ 0 + @{ability_current|max} ]]}} {{effect_type=@{ability_effect_type}}} {{spell_level=@{ability_level}}} {{casting_time=@{ability_ct}}} {{range=@{ability_range}}} {{duration=@{ability_duration}}} {{saving_throw=@{ability_save}}} {{area_of_effect=@{ability_aoe}}} {{save_type=@{ability_save_type}}}"};_.each(o,s=>{n[`repeating_ability_${s}_ability_macro_text`]===t.ability_old_v5&&(a[`repeating_ability_${s}_ability_macro_text`]=n[`repeating_ability_${s}_ability_macro_text`].replace(t.ability_old_v5,t.ability_current)),n[`repeating_ability_${s}_ability_macro_text`]===t.ability_old_v4&&(a[`repeating_ability_${s}_ability_macro_text`]=n[`repeating_ability_${s}_ability_macro_text`].replace(t.ability_old_v4,t.ability_current)),n[`repeating_ability_${s}_ability_macro_text`]===t.ability_old_v3&&(a[`repeating_ability_${s}_ability_macro_text`]=n[`repeating_ability_${s}_ability_macro_text`].replace(t.ability_old_v3,t.ability_current)),n[`repeating_ability_${s}_ability_macro_text`]===t.ability_old_v2&&(a[`repeating_ability_${s}_ability_macro_text`]=n[`repeating_ability_${s}_ability_macro_text`].replace(t.ability_old_v2,t.ability_current)),n[`repeating_ability_${s}_ability_macro_text`]===t.ability_old&&(a[`repeating_ability_${s}_ability_macro_text`]=n[`repeating_ability_${s}_ability_macro_text`].replace(t.ability_old,t.ability_current))}),a.sheet_version=i,b("VERSION UPDATE: abilityMacroUpdate completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},or=(i,r)=>{getSectionIDs("repeating_nonweaponproficiencies",o=>{let e=o.map(n=>[`repeating_nonweaponproficiencies_${n}_nwp_macro_text`]);getAttrs([...e],n=>{let a={},t={nwp_old:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{Proficiency Check=[[ 1d20 + [[@{nwp_modifier}]][MOD] + [[?{Additional modifier?|0}]][MOD] ]] vs [[ @{nwp_attribute}[ATTR] ]]}}{{freetext=@{nwp_short_description}}}",nwp_old_v2:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{roll_low=[[ 1d20 + [[ @{nwp_modifier} ]][MOD] + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[ @{nwp_attribute}[ATTR] ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{NWP Mod Applied=[[ @{nwp_modifier} ]]}} {{freetext=@{nwp_short_description}}}",nwp_current:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Non Weapon Proficiency: @{nwp_name}}} {{roll_low=[[ 1d20 + [[ @{nwp_modifier} ]][MOD] + [[ ?{Modifier?|0} ]][MOD] ]]}} {{roll_target=[[ @{nwp_attribute}[ATTR] ]]}} {{mod_applied=[[ ?{Modifier?|0} ]]}} {{nwp_mod_applied=[[ @{nwp_modifier} ]]}} {{link=@{nwp_link}}} {{freetext=@{nwp_short_description} @{nwp_description}}}"};_.each(o,s=>{n[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`]===t.nwp_old_2&&(a[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`]=n[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`].replace(t.nwp_old_2,t.nwp_current)),n[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`]===t.nwp_old&&(a[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`]=n[`repeating_nonweaponproficiencies_${s}_nwp_macro_text`].replace(t.nwp_old,t.nwp_current))}),a.sheet_version=i,b("VERSION UPDATE: nwpMacroUpdate2 completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},ir=(i,r)=>{getSectionIDs("repeating_spells",o=>{let e=o.map(n=>[`repeating_spells_${n}_spell_macro_text`]);getAttrs([...e],n=>{let a={},t={spell_old:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{Level:=@{spell_level}}} {{Range:=@{spell_range}}} {{Duration:=@{spell_duration}}} {{AOE:=@{spell_aoe}}} {{Comp:=@{spell_components}}} {{CT:=@{spell_ct}}} {{Save:=@{spell_save}}} {{freetext=@{spell_description}}}",spell_old_v2:"&{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{Range:=@{spell_range}}} {{Duration:=@{spell_duration}}} {{AOE:=@{spell_aoe}}} {{Save:=@{spell_save}}}",spell_old_v3:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{school=@{spell_school}}} {{spell_level=@{spell_level}}} {{range=@{spell_range}}} {{duration=@{spell_duration}}} {{area_of_effect=@{spell_aoe}}} {{components=@{spell_components}}} {{casting_time=@{spell_ct}}} {{saving_throw=@{spell_save}}} {{freetext=@{spell_description}}}",spell_current:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Casts: @{spell_name}}} {{school=@{spell_school}}} {{spell_level=@{spell_level}}} {{spell_class=@{spell_caster_class_name}}} {{spell_class_level=@{spell_caster_class_level}}} {{range=@{spell_range}}} {{duration=@{spell_duration}}} {{area_of_effect=@{spell_aoe}}} {{components=@{spell_components}}} {{casting_time=@{spell_ct}}} {{saving_throw=@{spell_save}}} {{save_type=@{spell_save_type}}} {{link=@{spell_link}}} {{freetext=@{spell_description}}}"};_.each(o,s=>{n[`repeating_spells_${s}_spell_macro_text`]===t.spell_old_v3&&(a[`repeating_spells_${s}_spell_macro_text`]=n[`repeating_spells_${s}_spell_macro_text`].replace(t.spell_old_v3,t.spell_current)),n[`repeating_spells_${s}_spell_macro_text`]===t.spell_old_v2&&(a[`repeating_spells_${s}_spell_macro_text`]=n[`repeating_spells_${s}_spell_macro_text`].replace(t.spell_old_v2,t.spell_current)),n[`repeating_spells_${s}_spell_macro_text`]===t.spell_old&&(a[`repeating_spells_${s}_spell_macro_text`]=n[`repeating_spells_${s}_spell_macro_text`].replace(t.spell_old,t.spell_current))}),a.sheet_version=i,b("VERSION UPDATE: spellsMacroUpdate completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},sr=(i,r)=>{getSectionIDs("repeating_equipment",o=>{let e=o.map(n=>[`repeating_equipment_${n}_equipment_macro_text`]);getAttrs([...e],n=>{let a={},t={equipment_old:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Item/Equipment: @{equipment_item}}} {{freetext=@{equipment_description}}} {{quantity= @{equipment_quantity}}} {{quantity_max=@{equipment_quantity|max}}} {{uses=@{equipment_current}}} {{uses_max=[[ @{equipment_current|max} ]]}}",equipment_current:"@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Item/Equipment: @{equipment_item}}} {{link=@{equipment_link}}} {{freetext=@{equipment_description}}} {{quantity=@{equipment_quantity}}} {{quantity_max=@{equipment_quantity|max}}} {{uses=@{equipment_current}}} {{uses_max=[[ @{equipment_current|max} ]]}}"};_.each(o,s=>{n[`repeating_equipment_${s}_equipment_macro_text`]===t.equipment_old&&(a[`repeating_equipment_${s}_equipment_macro_text`]=n[`repeating_equipment_${s}_equipment_macro_text`].replace(t.equipment_old,t.equipment_current))}),a.sheet_version=i,b("VERSION UPDATE: equipmentMacroUpdate completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},cr=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e={},n=o.flatMap(a=>[`repeating_weapon_${a}_weapon_range`,`repeating_weapon_${a}_weapon_range_short`,`repeating_weapon_${a}_weapon_range_medium`,`repeating_weapon_${a}_weapon_range_long`,`repeating_weapon_${a}_weapon_attack_type`,`repeating_weapon_${a}_weapon_range_error`]);getAttrs(n,a=>{_.each(o,t=>{let s=+a[`repeating_weapon_${t}_weapon_attack_type`]||0;if(s===0||s===2)return;let c=a[`repeating_weapon_${t}_weapon_range`];c=c.replace(/'/g,""),c=c.replace(/"/g,"");let m=c.split("/").join(",").split(" ").join(",").split("-").join(",").split(","),h=Number(m[0]),l=Number(m[1]),p=Number(m[2]);m.length===1&&h>=0&&!l&&!p&&(l=h,p=h),Number.isNaN(h)?(e[`repeating_weapon_${t}_weapon_range_short`]=0,e[`repeating_weapon_${t}_weapon_range_error`]=c===""?1:0):e[`repeating_weapon_${t}_weapon_range_short`]=h,Number.isNaN(l)?(e[`repeating_weapon_${t}_weapon_range_medium`]=0,e[`repeating_weapon_${t}_weapon_range_error`]=c===""?1:0):e[`repeating_weapon_${t}_weapon_range_medium`]=l,Number.isNaN(p)?(e[`repeating_weapon_${t}_weapon_range_long`]=0,e[`repeating_weapon_${t}_weapon_range_error`]=c===""?1:0):e[`repeating_weapon_${t}_weapon_range_long`]=p,!Number.isNaN(h)&&!Number.isNaN(l)&&!Number.isNaN(p)&&(e[`repeating_weapon_${t}_weapon_range_error`]=1)}),e.sheet_version=i,b("VERSION UPDATE: updateRange completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})})},pr=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.map(n=>[`repeating_weapon_${n}_weapon_macro_text`]);getAttrs([...e],n=>{let a={},t="&{template:attacks} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=@{weapon_name}}} {{dual=@{weapon_dual}}} {{attack1=[[ 1d20 + @{weapon_backstab_bonus}[BACKSTAB] + @{weapon_tohitbonus}[HIT_BON] + @{weapon_prof_pen}[PROF_PEN] + @{weapon_dual_pen}[DUAL_PEN]+ @{weapon_magicbonus}[MAG_BON] + ?{To Hit Modifier?|0}[MISC_MOD] ]]}} {{damagevsSMchatmenu=@{weapon_damagesmallmedium_chat_menu}}} {{damagevsLchatmenu=@{weapon_damagelarge_chat_menu}}} {{WeaponNotes=@{weapon_notes}}} {{backstab=[[ @{weapon_backstab_mult} ]]}} {{damagetype=@{weapon_attackdmgtype}}} {{rate=@{weapon_rateoffire}}} {{range=@{weapon_range}}} {{length=@{weapon_length}}} {{space=@{weapon_space}}} {{speed=@{weapon_speed}}} @{weapon_tohitacadj}";_.each(o,s=>{let c=n[`repeating_weapon_${s}_weapon_macro_text`]||t;a[`repeating_weapon_${s}_weapon_macro_text`]=c.replace(/@{weapon_attack_type_pen}/g,"@{weapon_dual_pen}"),a[`repeating_weapon_${s}_weapon_macro_text`]=c.replace(/{{attacktype=@{weapon_attack_type}}} /g,"")}),a.sheet_version=i,b("VERSION UPDATE: updateAttackTypeMacro completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},mr=(i,r)=>{getAttrs(["hitdice","monsterHD"],o=>{let e={},n=o.monsterHD,a=o.hitdice;n===""&&(e.monsterHD=a),e.monsterHD=n,e.sheet_version=i,b("VERSION UPDATE: monsterHD completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})},lr=(i,r)=>{let o={};o.armorother_cost=0,o.armorother2_cost=0,o.armorother3_cost=0,o.armorother4_cost=0,o.armorother5_cost=0,o.armorother6_cost=0,o.armorother_weight=0,o.armorother2_weight=0,o.armorother3_weight=0,o.armorother4_weight=0,o.armorother5_weight=0,o.armorother6_weight=0,o.armorother_carried=0,o.armorother2_carried=0,o.armorother3_carried=0,o.armorother4_carried=0,o.armorother5_carried=0,o.armorother6_carried=0,o.armorother_bulk=0,o.armorother2_bulk=0,o.armorother3_bulk=0,o.armorother4_bulk=0,o.armorother5_bulk=0,o.armorother6_bulk=0,b("VERSION UPDATE: clearArmorOther completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},hr=fe.concat(ye),Ue=async(i,r,o,e)=>{let n=await u(hr),a={},t="",s=i;s=s!==null?i.toLowerCase():s;let c=n.unarmored_row_id.toString(),m=n.armortype1_row_id.toString(),h=n.armortype2_row_id.toString(),l=n.armorshield_row_id.toString(),p=n.armorhelmet_row_id.toString(),w=n.armorother1_row_id.toString(),$=n.armorother2_row_id.toString(),D=n.armorother3_row_id.toString(),O=n.armorother4_row_id.toString(),x=n.armorother5_row_id.toString(),L=n.armorother6_row_id.toString(),v=[c,m,h,l,p,w,$,D,O,x,L].map(V=>V?V.toString().toLowerCase():"0");function U(V){let R=Object.entries({unarmoredAttrs:Tt,armor1Attrs:Et,armor2Attrs:Lt,shieldAttrs:Rt,helmetAttrs:Pt,other1Attrs:Bt,other2Attrs:jt,other3Attrs:Ut,other4Attrs:Vt,other5Attrs:Wt,other6Attrs:Ht}).find(([xe,he])=>he.includes(V));return R?R[0]:null}let y=U(r),me=n.unarmored.trim(),le=n.armortype.trim(),oe=n.armortype2.trim(),ie=n.armorshield.trim(),z=n.armorhelmet.trim(),ke=n.armorother.trim(),K=n.armorother2.trim(),X=n.armorother3.trim(),Q=n.armorother4.trim(),Y=n.armorother5.trim(),Z=n.armorother6.trim(),J={unarmoredAttrs:0,armor1Attrs:1,armor2Attrs:2,shieldAttrs:3,helmetAttrs:4,other1Attrs:5,other2Attrs:6,other3Attrs:7,other4Attrs:8,other5Attrs:9,other6Attrs:10};if(s===null){let V=J[y];V!==void 0&&(s=v[V])}(y==="unarmoredAttrs"||s===v[0]||e)&&(y==="unarmoredAttrs"||e?me?c.length===20?(rowId=c.toLowerCase(),a.unarmored_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=0,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.unarmored_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.unarmored.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.unarmored_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.unarmored_base||0,a[`repeating_equipment_${rowId}_equipment_armor_bulk`]=+n.unarmored_bulk||0,(+n.unarmored_worn||0)==1&&(+n.unarmored_carried||0)==0?(a[`repeating_equipment_${rowId}_equipment_carried_select`]=1,a.unarmored_carried=1):a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.unarmored_carried||0,a[`repeating_equipment_${rowId}_equipment_weight`]=+n.unarmored_weight||0,a[`repeating_equipment_${rowId}_equipment_cost`]=+n.unarmored_cost||0):(t=k(),a.unarmored_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=0,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.unarmored_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.unarmored.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.unarmored_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.unarmored_base||0,a[`repeating_equipment_${t}_equipment_armor_bulk`]=+n.unarmored_bulk||0,(+n.unarmored_worn||0)==1&&(+n.unarmored_carried||0)==0?(a[`repeating_equipment_${t}_equipment_carried_select`]=1,a.unarmored_carried=1):a[`repeating_equipment_${t}_equipment_carried_select`]=+n.unarmored_carried||0,a[`repeating_equipment_${t}_equipment_weight`]=+n.unarmored_weight||0,a[`repeating_equipment_${t}_equipment_cost`]=+n.unarmored_cost||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):c===v[0]&&(a.unarmored_row_id=0,a.unarmored_worn=+n.unarmored_worn||0,a.unarmored="",a.unarmored_ac=+n.unarmored_ac||0,a.unarmored_base=+n.unarmored_base||0,a.unarmored_bulk=+n.unarmored_bulk||0,a.unarmored_weight=+n.unarmored_weight||0,a.unarmored_cost=+n.unarmored_cost||0,(+n.unarmored_worn||0)==1&&(+n.unarmored_carried||0)==0?a.unarmored_carried=1:a.unarmored_carried=+n.unarmored_carried||0):y===null&&o&&(a.unarmored_row_id=0,a.unarmored_worn=1,a.unarmored="",a.unarmored_ac=10,a.unarmored_base=10,a.unarmored_bulk=0,a.unarmored_weight=0,a.unarmored_cost=0,a.unarmored_carried=1)),(y==="armor1Attrs"||s===v[1]||e)&&(y==="armor1Attrs"||e?le?m.length===20?(rowId=m.toLowerCase(),a.armortype1_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=1,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armortype_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armortype.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armortype_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armortype_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armortype_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_bulk`]=+n.armortype_bulk||0,(+n.armortype_worn||0)==1&&(+n.armortype_carried||0)==0?(a[`repeating_equipment_${rowId}_equipment_carried_select`]=1,a.armortype_carried=1):a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armortype_carried||0,a[`repeating_equipment_${rowId}_equipment_weight`]=+n.armor_weight||0,a[`repeating_equipment_${rowId}_equipment_cost`]=+n.armor_cost||0):(t=k(),a.armortype1_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=1,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armortype_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armortype.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armortype_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armortype_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armortype_magic||0,a[`repeating_equipment_${t}_equipment_armor_bulk`]=+n.armortype_bulk||0,a[`repeating_equipment_${t}_equipment_carried_select`]=+n.armortype_carried||0,a[`repeating_equipment_${t}_equipment_weight`]=+n.armor_weight||0,a[`repeating_equipment_${t}_equipment_cost`]=+n.armor_cost||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):m===v[1]&&(a.armortype1_row_id=0,a.armortype_worn=0,a.armortype="",a.armortype_ac=10,a.armortype_base=10,a.armortype_magic=0,a.armortype_bulk=0,a.armortype_weight=0,a.armortype_cost=0,a.armortype_carried=1):y===null&&o&&(a.armortype1_row_id=0,a.armortype_worn=0,a.armortype="",a.armortype_ac=10,a.armortype_base=10,a.armortype_magic=0,a.armortype_bulk=0,a.armortype_weight=0,a.armortype_cost=0,a.armortype_carried=1)),(y==="armor2Attrs"||s===v[2]||e)&&(y==="armor2Attrs"||e?oe?h.length===20?(rowId=h.toLowerCase(),a.armortype2_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armortype2_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armortype2.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armortype2_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armortype2_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armortype2_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_bulk`]=+n.armortype2_bulk||0,(+n.armortype2_worn||0)==1&&(+n.armortype2_carried||0)==0?(a[`repeating_equipment_${rowId}_equipment_carried_select`]=1,a.armortype2_carried=1):a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armortype2_carried||0,a[`repeating_equipment_${rowId}_equipment_weight`]=+n.armortype2_weight||0,a[`repeating_equipment_${rowId}_equipment_cost`]=+n.armortype2_cost||0):(t=k(),a.armortype2_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=2,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armortype2_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armortype2.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armortype2_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armortype2_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armortype2_magic||0,a[`repeating_equipment_${t}_equipment_armor_bulk`]=+n.armortype2_bulk||0,a[`repeating_equipment_${t}_equipment_carried_select`]=+n.armortype2_carried||0,a[`repeating_equipment_${t}_equipment_weight`]=+n.armortype2_weight||0,a[`repeating_equipment_${t}_equipment_cost`]=+n.armortype2_cost||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):h===v[2]&&(a.armortype2_row_id=0,a.armortype2_worn=0,a.armortype2="",a.armortype2_ac=10,a.armortype2_base=10,a.armortype2_magic=0,a.armortype2_bulk=0,a.armortype2_weight=0,a.armortype2_cost=0,a.armortype2_carried=1):y===null&&o&&(a.armortype2_row_id=0,a.armortype2_worn=0,a.armortype2="",a.armortype2_ac=10,a.armortype2_base=10,a.armortype2_magic=0,a.armortype2_bulk=0,a.armortype2_weight=0,a.armortype2_cost=0,a.armortype2_carried=1)),(y==="shieldAttrs"||s===v[3]||e)&&(y==="shieldAttrs"||e?ie?l.length===20?(rowId=l.toLowerCase(),a.armorshield_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=3,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorshield_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorshield.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorshield_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorshield_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=n.armorshield_magic,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=n.armorshield_mod,a[`repeating_equipment_${rowId}_equipment_armor_bulk`]=+n.armorshield_bulk||0,(+n.armorshield_worn||0)==1&&(+n.armorshield_carried||0)==0?(a[`repeating_equipment_${rowId}_equipment_carried_select`]=1,a.armorshield_carried=1):a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorshield_carried||0,a[`repeating_equipment_${rowId}_equipment_weight`]=+n.armorshield_weight||0,a[`repeating_equipment_${rowId}_equipment_cost`]=+n.armorshield_cost||0):(t=k(),a.armorshield_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=3,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorshield_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorshield.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorshield_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorshield_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=n.armorshield_magic,a[`repeating_equipment_${t}_equipment_armor_mod`]=n.armorshield_mod,a[`repeating_equipment_${t}_equipment_armor_bulk`]=+n.armorshield_bulk||0,a[`repeating_equipment_${t}_equipment_carried_select`]=+n.armorshield_carried||0,a[`repeating_equipment_${t}_equipment_weight`]=+n.armorshield_weight||0,a[`repeating_equipment_${t}_equipment_cost`]=+n.armorshield_cost||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):l===v[3]&&(a.armorshield_row_id=0,a.armorshield_worn=0,a.armorshield="",a.armorshield_ac=0,a.armorshield_base=0,a.armorshield_magic=0,a.armorshield_mod=0,a.armorshield_bulk=0,a.armorshield_weight=0,a.armorshield_cost=0,a.armorshield_carried=1):y===null&&o&&(a.armorshield_row_id=0,a.armorshield_worn=0,a.armorshield="",a.armorshield_ac=0,a.armorshield_base=0,a.armorshield_magic=0,a.armorshield_mod=0,a.armorshield_bulk=0,a.armorshield_weight=0,a.armorshield_cost=0,a.armorshield_carried=1)),(y==="helmetAttrs"||s===v[4]||e)&&(y==="helmetAttrs"||e?z?p.length===20?(rowId=p.toLowerCase(),a.armorhelmet_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=4,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorhelmet_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorhelmet.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorhelmet_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=n.armorhelmet_magic,(+n.armorhelmet_worn||0)==1&&(+n.armorhelmet_carried||0)==0?(a[`repeating_equipment_${rowId}_equipment_carried_select`]=1,a.armorhelmet_carried=1):a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorhelmet_carried||0,a[`repeating_equipment_${rowId}_equipment_weight`]=+n.armorhelmet_weight||0,a[`repeating_equipment_${rowId}_equipment_cost`]=+n.armorhelmet_cost||0):(t=k(),a.armorhelmet_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=4,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorhelmet_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorhelmet.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorhelmet_ac||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=n.armorhelmet_magic,a[`repeating_equipment_${t}_equipment_carried_select`]=+n.armorhelmet_carried||0,a[`repeating_equipment_${t}_equipment_weight`]=+n.armorhelmet_weight||0,a[`repeating_equipment_${t}_equipment_cost`]=+n.armorhelmet_cost||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):p===v[4]&&(a.armorhelmet_row_id=0,a.armorhelmet_worn=0,a.armorhelmet="",a.armorhelmet_ac=10,a.armorhelmet_base=10,a.armorhelmet_magic=0,a.armorhelmet_bulk=0,a.armorhelmet_weight=0,a.armorhelmet_cost=0,a.armorhelmet_carried=1):y===null&&o&&(a.armorhelmet_row_id=0,a.armorhelmet_worn=0,a.armorhelmet="",a.armorhelmet_ac=10,a.armorhelmet_base=10,a.armorhelmet_magic=0,a.armorhelmet_bulk=0,a.armorhelmet_weight=0,a.armorhelmet_cost=0,a.armorhelmet_carried=1)),(y==="other1Attrs"||s===v[5]||e)&&(y==="other1Attrs"||e?ke?w.length===20?(rowId=w.toLowerCase(),a.armorother1_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=5,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother_worn==1?1:0):(t=k(),a.armorother1_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=5,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):w===v[5]&&(a.armorother1_row_id=0,a.armorother_worn=0,a.armorother="",a.armorother_ac=10,a.armorother_base=10,a.armorother_magic=0,a.armorother_mod=0,a.armorother_bulk=0):y===null&&o&&(a.armorother1_row_id=0,a.armorother_worn=0,a.armorother="",a.armorother_ac=10,a.armorother_base=10,a.armorother_magic=0,a.armorother_mod=0,a.armorother_bulk=0)),(y==="other2Attrs"||s===v[6]||e)&&(y==="other2Attrs"||e?K?$.length===20?(rowId=$.toLowerCase(),a.armorother2_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=6,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother2_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother2.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother2_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother2_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother2_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother2_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother2_worn==1?1:0):(t=k(),a.armorother2_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=6,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother2_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother2.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother2_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother2_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother2_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother2_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):$===v[6]&&(a.armorother2_row_id=0,a.armorother2_worn=0,a.armorother2="",a.armorother2_ac=0,a.armorother2_base=0,a.armorother2_magic=0,a.armorother2_mod=0,a.armorother2_bulk=0):y===null&&o&&(a.armorother2_row_id=0,a.armorother2_worn=0,a.armorother2="",a.armorother2_ac=0,a.armorother2_base=0,a.armorother2_magic=0,a.armorother2_mod=0,a.armorother2_bulk=0)),(y==="other3Attrs"||s===v[7]||e)&&(y==="other3Attrs"||e?X?D.length===20?(rowId=D.toLowerCase(),a.armorother3_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=7,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother3_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother3.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother3_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother3_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother3_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother3_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother3_worn==1?1:0):(t=k(),a.armorother3_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=7,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother3_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother3.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother3_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother3_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother3_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother3_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):D===v[7]&&(a.armorother3_row_id=0,a.armorother3_worn=0,a.armorother3="",a.armorother3_ac=0,a.armorother3_base=0,a.armorother3_magic=0,a.armorother3_mod=0,a.armorother3_bulk=0):y===null&&o&&(a.armorother3_row_id=0,a.armorother3_worn=0,a.armorother3="",a.armorother3_ac=0,a.armorother3_base=0,a.armorother3_magic=0,a.armorother3_mod=0,a.armorother3_bulk=0)),(y==="other4Attrs"||s===v[8]||e)&&(y==="other4Attrs"||e?Q?O.length===20?(rowId=O.toLowerCase(),a.armorother4_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=8,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother4_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother4.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother4_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother4_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother4_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother4_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother4_worn==1?1:0):(t=k(),a.armorother4_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=8,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother4_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother4.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother4_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother4_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother4_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother4_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):O===v[8]&&(a.armorother4_row_id=0,a.armorother4_worn=0,a.armorother4="",a.armorother4_ac=0,a.armorother4_base=0,a.armorother4_magic=0,a.armorother4_mod=0,a.armorother4_bulk=0):y===null&&o&&(a.armorother4_row_id=0,a.armorother4_worn=0,a.armorother4="",a.armorother4_ac=0,a.armorother4_base=0,a.armorother4_magic=0,a.armorother4_mod=0,a.armorother4_bulk=0)),(y==="other5Attrs"||s===v[9]||e)&&(y==="other5Attrs"||e?Y?x.length===20?(rowId=x.toLowerCase(),a.armorother5_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=9,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother5_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother5.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother5_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother5_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother5_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother5_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother5_worn==1?1:0):(t=k(),a.armorother5_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=9,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother5_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother5.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother5_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother5_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother5_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother5_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):x===v[9]&&(a.armorother5_row_id=0,a.armorother5_worn=0,a.armorother5="",a.armorother5_ac=0,a.armorother5_base=0,a.armorother5_magic=0,a.armorother5_mod=0,a.armorother5_bulk=0):y===null&&o&&(a.armorother5_row_id=0,a.armorother5_worn=0,a.armorother5="",a.armorother5_ac=0,a.armorother5_base=0,a.armorother5_magic=0,a.armorother5_mod=0,a.armorother5_bulk=0)),(y==="other6Attrs"||s===v[10]||e)&&(y==="other6Attrs"||e?Z?L.length===20?(rowId=L.toLowerCase(),a.armorother6_row_id=rowId,a[`repeating_equipment_${rowId}_equipment_type`]=2,a[`repeating_equipment_${rowId}_equipment_armor_type`]=10,a[`repeating_equipment_${rowId}_equipment_armor_worn`]=+n.armorother6_worn||0,a[`repeating_equipment_${rowId}_equipment_item`]=n.armorother6.trim(),a[`repeating_equipment_${rowId}_equipment_armor_ac`]=+n.armorother6_ac||0,a[`repeating_equipment_${rowId}_equipment_armor_base`]=+n.armorother6_base||0,a[`repeating_equipment_${rowId}_equipment_armor_magic`]=+n.armorother6_magic||0,a[`repeating_equipment_${rowId}_equipment_armor_mod`]=+n.armorother6_mod||0,a[`repeating_equipment_${rowId}_equipment_carried_select`]=+n.armorother6_worn==1?1:0):(t=k(),a.armorother6_row_id=t.toLowerCase(),a[`repeating_equipment_${t}_equipment_type`]=2,a[`repeating_equipment_${t}_equipment_armor_type`]=10,a[`repeating_equipment_${t}_equipment_armor_worn`]=+n.armorother6_worn||0,a[`repeating_equipment_${t}_equipment_item`]=n.armorother6.trim(),a[`repeating_equipment_${t}_equipment_armor_ac`]=+n.armorother6_ac||0,a[`repeating_equipment_${t}_equipment_armor_base`]=+n.armorother6_base||0,a[`repeating_equipment_${t}_equipment_armor_magic`]=+n.armorother6_magic||0,a[`repeating_equipment_${t}_equipment_armor_mod`]=+n.armorother6_mod||0,a[`repeating_equipment_${t}_equipment_sync_armor_flag`]=1):L===v[10]&&(a.armorother6_row_id=0,a.armorother6_worn=0,a.armorother6="",a.armorother6_ac=0,a.armorother6_base=0,a.armorother6_magic=0,a.armorother6_mod=0,a.armorother6_bulk=0):y===null&&o&&(a.armorother6_row_id=0,a.armorother6_worn=0,a.armorother6="",a.armorother6_ac=0,a.armorother6_base=0,a.armorother6_magic=0,a.armorother6_mod=0,a.armorother6_bulk=0)),await g(a,{silent:!0}),await fa(s),_e()},gr=(i,r)=>{let o={};Ue(null,null,0,1),o.sheet_version=i,b("VERSION UPDATE: migrateArmorDetails completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},ur=(i,r)=>{getSectionIDs("repeating_equipment",o=>{let e={},n=o.flatMap(a=>[`repeating_equipment_${a}_equipment_type`,`repeating_equipment_${a}_equipment_current`,`repeating_equipment_${a}_equipment_current_max`,`repeating_equipment_${a}_equipment_carried_select`,`repeating_equipment_${a}_equipment_carried`,`repeating_equipment_${a}_equipment_quantity`,`repeating_equipment_${a}_equipment_quantity_max`,`repeating_equipment_${a}_equipment_weight`,`repeating_equipment_${a}_equipment_cost`,`repeating_equipment_${a}_equipment_armor_type`,`repeating_equipment_${a}_equipment_armor_worn`,`repeating_equipment_${a}_equipment_armor_ac`,`repeating_equipment_${a}_equipment_armor_base`,`repeating_equipment_${a}_equipment_armor_magic`,`repeating_equipment_${a}_equipment_armor_mod`,`repeating_equipment_${a}_equipment_armor_bulk`,`repeating_equipment_${a}_equipment_macro_text`]);getAttrs(n,a=>{_.each(o,t=>{e[`repeating_equipment_${t}_equipment_type`]=+a[`repeating_equipment_${t}_equipment_type`]||0,e[`repeating_equipment_${t}_equipment_current`]=+a[`repeating_equipment_${t}_equipment_current`]||0,e[`repeating_equipment_${t}_equipment_current_max`]=+a[`repeating_equipment_${t}_equipment_current_max`]||0,e[`repeating_equipment_${t}_equipment_carried_select`]=+a[`repeating_equipment_${t}_equipment_carried`]||0,e[`repeating_equipment_${t}_equipment_carried`]=+a[`repeating_equipment_${t}_equipment_carried`]||0,e[`repeating_equipment_${t}_equipment_quantity`]=+a[`repeating_equipment_${t}_equipment_quantity`]||0,e[`repeating_equipment_${t}_equipment_quantity_max`]=+a[`repeating_equipment_${t}_equipment_quantity_max`]||0,e[`repeating_equipment_${t}_equipment_weight`]=+a[`repeating_equipment_${t}_equipment_weight`]||0,e[`repeating_equipment_${t}_equipment_cost`]=+a[`repeating_equipment_${t}_equipment_cost`]||0,e[`repeating_equipment_${t}_equipment_armor_type`]=+a[`repeating_equipment_${t}_equipment_armor_type`]||0,e[`repeating_equipment_${t}_equipment_armor_worn`]=+a[`repeating_equipment_${t}_equipment_armor_worn`]||0,e[`repeating_equipment_${t}_equipment_armor_ac`]=+a[`repeating_equipment_${t}_equipment_armor_ac`]||0,e[`repeating_equipment_${t}_equipment_armor_base`]=+a[`repeating_equipment_${t}_equipment_armor_base`]||0,e[`repeating_equipment_${t}_equipment_armor_magic`]=+a[`repeating_equipment_${t}_equipment_armor_magic`]||0,e[`repeating_equipment_${t}_equipment_armor_mod`]=+a[`repeating_equipment_${t}_equipment_armor_mod`]||0,e[`repeating_equipment_${t}_equipment_armor_bulk`]=+a[`repeating_equipment_${t}_equipment_armor_bulk`]||0,e[`repeating_equipment_${t}_equipment_macro_text`]=a[`repeating_equipment_${t}_equipment_macro_text`]}),e.sheet_version=i,b("VERSION UPDATE: setEquipmentUpdate completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})})},wr=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e={},n=o.flatMap(a=>[`repeating_weapon_${a}_weapon_attack_type`,`repeating_weapon_${a}_weapon_dual`,`repeating_weapon_${a}_weapon_whisper_to_hit`,`repeating_weapon_${a}_weapon_whisper_to_hit_select`,`repeating_weapon_${a}_weapon_dual_pen`,`repeating_weapon_${a}_weapon_backstab_var`,`repeating_weapon_${a}_weapon_tohitbonus`,`repeating_weapon_${a}_weapon_magicbonus`,`repeating_weapon_${a}_weapon_prof`,`repeating_weapon_${a}_weapon_backstab`,`repeating_weapon_${a}_weapon_backstab_bonus`,`repeating_weapon_${a}_weapon_backstab_mult`,`repeating_weapon_${a}_weapon_attackdmgbonus`,`repeating_weapon_${a}_weapon_num_attacks`,`repeating_weapon_${a}_weapon_quantity`,`repeating_weapon_${a}_weapon_ammo`,`repeating_weapon_${a}_weapon_ammo_max`,`repeating_weapon_${a}_weapon_weight`,`repeating_weapon_${a}_weapon_cost`,`repeating_weapon_${a}_weapon_range_short`,`repeating_weapon_${a}_weapon_range_medium`,`repeating_weapon_${a}_weapon_range_long`,`repeating_weapon_${a}_weapon_length`,`repeating_weapon_${a}_weapon_space`,`repeating_weapon_${a}_weapon_speed`,`repeating_weapon_${a}_weapon_misc`,`repeating_weapon_${a}_weapon_thac_adj0`,`repeating_weapon_${a}_weapon_thac_adj1`,`repeating_weapon_${a}_weapon_thac_adj2`,`repeating_weapon_${a}_weapon_thac_adj3`,`repeating_weapon_${a}_weapon_thac_adj4`,`repeating_weapon_${a}_weapon_thac_adj5`,`repeating_weapon_${a}_weapon_thac_adj6`,`repeating_weapon_${a}_weapon_thac_adj7`,`repeating_weapon_${a}_weapon_thac_adj8`,`repeating_weapon_${a}_weapon_thac_adj9`,`repeating_weapon_${a}_weapon_thac_adj10`,`repeating_weapon_${a}_weapon_macro_text`,`repeating_weapon_${a}_weapon_damagesmallmedium_chat_menu`,`repeating_weapon_${a}_weapon_damagelarge_chat_menu`,`repeating_weapon_${a}_weapon_damagesmallmedium_npc_chat_menu`,`repeating_weapon_${a}_weapon_damagelarge_npc_chat_menu`,`repeating_weapon_${a}_weapon_critdamagesmallmedium_chat_menu`,`repeating_weapon_${a}_weapon_critdamagelarge_chat_menu`,`repeating_weapon_${a}_weapon_critdamagesmallmedium_npc_chat_menu`,`repeating_weapon_${a}_weapon_critdamagelarge_npc_chat_menu`,`repeating_weapon_${a}_weapon_damage_chat_menu_npc`]);getAttrs(n,a=>{_.each(o,t=>{e[`repeating_weapon_${t}_weapon_attack_type`]=+a[`repeating_weapon_${t}_weapon_attack_type`]||0,e[`repeating_weapon_${t}_weapon_dual`]=a[`repeating_weapon_${t}_weapon_dual`],e[`repeating_weapon_${t}_weapon_whisper_to_hit`]=a[`repeating_weapon_${t}_weapon_whisper_to_hit`],e[`repeating_weapon_${t}_weapon_whisper_to_hit_select`]=+a[`repeating_weapon_${t}_weapon_whisper_to_hit_select`]||0,e[`repeating_weapon_${t}_weapon_dual_pen`]=+a[`repeating_weapon_${t}_weapon_dual_pen`]||0,e[`repeating_weapon_${t}_weapon_backstab_var`]=+a[`repeating_weapon_${t}_weapon_backstab_var`]||0,e[`repeating_weapon_${t}_weapon_tohitbonus`]=+a[`repeating_weapon_${t}_weapon_tohitbonus`]||0,e[`repeating_weapon_${t}_weapon_magicbonus`]=+a[`repeating_weapon_${t}_weapon_magicbonus`]||0,e[`repeating_weapon_${t}_weapon_prof`]=+a[`repeating_weapon_${t}_weapon_prof`]||0,e[`repeating_weapon_${t}_weapon_backstab`]=+a[`repeating_weapon_${t}_weapon_backstab`]||0,e[`repeating_weapon_${t}_weapon_backstab_bonus`]=+a[`repeating_weapon_${t}_weapon_backstab_bonus`]||0,e[`repeating_weapon_${t}_weapon_backstab_mult`]=+a[`repeating_weapon_${t}_weapon_backstab_mult`]||0,e[`repeating_weapon_${t}_weapon_attackdmgbonus`]=+a[`repeating_weapon_${t}_weapon_attackdmgbonus`]||0,e[`repeating_weapon_${t}_weapon_num_attacks`]=+a[`repeating_weapon_${t}_weapon_num_attacks`]||0,e[`repeating_weapon_${t}_weapon_quantity`]=+a[`repeating_weapon_${t}_weapon_quantity`]||0,e[`repeating_weapon_${t}_weapon_ammo`]=+a[`repeating_weapon_${t}_weapon_ammo`]||0,e[`repeating_weapon_${t}_weapon_ammo_max`]=+a[`repeating_weapon_${t}_weapon_ammo_max`]||0,e[`repeating_weapon_${t}_weapon_weight`]=+a[`repeating_weapon_${t}_weapon_weight`]||0,e[`repeating_weapon_${t}_weapon_cost`]=+a[`repeating_weapon_${t}_weapon_cost`]||0,e[`repeating_weapon_${t}_weapon_range_short`]=+a[`repeating_weapon_${t}_weapon_range_short`]||0,e[`repeating_weapon_${t}_weapon_range_medium`]=+a[`repeating_weapon_${t}_weapon_range_medium`]||0,e[`repeating_weapon_${t}_weapon_range_long`]=+a[`repeating_weapon_${t}_weapon_range_long`]||0,e[`repeating_weapon_${t}_weapon_length`]=a[`repeating_weapon_${t}_weapon_length`],e[`repeating_weapon_${t}_weapon_space`]=a[`repeating_weapon_${t}_weapon_space`],e[`repeating_weapon_${t}_weapon_speed`]=a[`repeating_weapon_${t}_weapon_speed`],e[`repeating_weapon_${t}_weapon_misc`]=a[`repeating_weapon_${t}_weapon_misc`],e[`repeating_weapon_${t}_weapon_thac_adj0`]=+a[`repeating_weapon_${t}_weapon_thac_adj0`]||0,e[`repeating_weapon_${t}_weapon_thac_adj1`]=+a[`repeating_weapon_${t}_weapon_thac_adj1`]||0,e[`repeating_weapon_${t}_weapon_thac_adj2`]=+a[`repeating_weapon_${t}_weapon_thac_adj2`]||0,e[`repeating_weapon_${t}_weapon_thac_adj3`]=+a[`repeating_weapon_${t}_weapon_thac_adj3`]||0,e[`repeating_weapon_${t}_weapon_thac_adj4`]=+a[`repeating_weapon_${t}_weapon_thac_adj4`]||0,e[`repeating_weapon_${t}_weapon_thac_adj5`]=+a[`repeating_weapon_${t}_weapon_thac_adj5`]||0,e[`repeating_weapon_${t}_weapon_thac_adj6`]=+a[`repeating_weapon_${t}_weapon_thac_adj6`]||0,e[`repeating_weapon_${t}_weapon_thac_adj7`]=+a[`repeating_weapon_${t}_weapon_thac_adj7`]||0,e[`repeating_weapon_${t}_weapon_thac_adj8`]=+a[`repeating_weapon_${t}_weapon_thac_adj8`]||0,e[`repeating_weapon_${t}_weapon_thac_adj9`]=+a[`repeating_weapon_${t}_weapon_thac_adj9`]||0,e[`repeating_weapon_${t}_weapon_thac_adj10`]=+a[`repeating_weapon_${t}_weapon_thac_adj10`]||0,e[`repeating_weapon_${t}_weapon_macro_text`]=a[`repeating_weapon_${t}_weapon_macro_text`],e[`repeating_weapon_${t}_weapon_damagesmallmedium_chat_menu`]=a[`repeating_weapon_${t}_weapon_damagesmallmedium_chat_menu`],e[`repeating_weapon_${t}_weapon_damagelarge_chat_menu`]=a[`repeating_weapon_${t}_weapon_damagelarge_chat_menu`],e[`repeating_weapon_${t}_weapon_damagesmallmedium_npc_chat_menu`]=a[`repeating_weapon_${t}_weapon_damagesmallmedium_npc_chat_menu`],e[`repeating_weapon_${t}_weapon_damagelarge_npc_chat_menu`]=a[`repeating_weapon_${t}_weapon_damagelarge_npc_chat_menu`],e[`repeating_weapon_${t}_weapon_critdamagesmallmedium_chat_menu`]=a[`repeating_weapon_${t}_weapon_critdamagesmallmedium_chat_menu`],e[`repeating_weapon_${t}_weapon_critdamagelarge_chat_menu`]=a[`repeating_weapon_${t}_weapon_critdamagelarge_chat_menu`],e[`repeating_weapon_${t}_weapon_critdamagesmallmedium_npc_chat_menu`]=a[`repeating_weapon_${t}_weapon_critdamagesmallmedium_npc_chat_menu`],e[`repeating_weapon_${t}_weapon_critdamagelarge_npc_chat_menu`]=a[`repeating_weapon_${t}_weapon_critdamagelarge_npc_chat_menu`],e[`repeating_weapon_${t}_weapon_damage_chat_menu_npc`]=a[`repeating_weapon_${t}_weapon_damage_chat_menu_npc`]}),e.sheet_version=i,b("VERSION UPDATE: setWeaponsUpdate completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})})},dr=(i,r)=>{getSectionIDs("nonweaponproficiencies",o=>{let e={},n=o.flatMap(a=>[`repeating_nonweaponproficiencies_${a}_nwp_attribute`,`repeating_nonweaponproficiencies_${a}_nwp_slots`,`repeating_nonweaponproficiencies_${a}_nwp_modifier`,`repeating_nonweaponproficiencies_${a}_nwp_macro_text`]);getAttrs(n,a=>{_.each(o,t=>{e[`repeating_nonweaponproficiencies_${t}_nwp_attribute`]=a[`repeating_nonweaponproficiencies_${t}_nwp_attribute`],e[`repeating_nonweaponproficiencies_${t}_nwp_slots`]=+a[`repeating_nonweaponproficiencies_${t}_nwp_slots`]||0,e[`repeating_nonweaponproficiencies_${t}_nwp_modifier`]=+a[`repeating_nonweaponproficiencies_${t}_nwp_modifier`]||0,e[`repeating_nonweaponproficiencies_${t}_nwp_macro_text`]=a[`repeating_nonweaponproficiencies_${t}_nwp_macro_text`]}),e.sheet_version=i,b("VERSION UPDATE: setNWPUpdate completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})})},qr=()=>{getSectionIDs("repeating_weapon",i=>{let r={},o=i.flatMap(e=>[`repeating_weapon_${e}_weapon_quantity`,`repeating_weapon_${e}_weapon_weight`,`repeating_weapon_${e}_weapon_cost`]);getAttrs(o,e=>{_.each(i,n=>{r[`repeating_weapon_${n}_weapon_quantity`]=+e[`repeating_weapon_${n}_weapon_quantity`]||0,r[`repeating_weapon_${n}_weapon_weight`]=0,r[`repeating_weapon_${n}_weapon_cost`]=0}),setAttrs(r)})})},br=()=>{getSectionIDs("repeating_weapon",i=>{getSectionIDs("repeating_equipment",r=>{let o={},e=[],n=[],a=[...e,...n];_.each(i,t=>{a.push(`repeating_weapon_${t}_weapon_name`),a.push(`repeating_weapon_${t}_weapon_quantity`),a.push(`repeating_weapon_${t}_weapon_weight`),a.push(`repeating_weapon_${t}_weapon_cost`)}),_.each(r,t=>{a.push(`repeating_equipment_${t}_equipment_item`),a.push(`repeating_equipment_${t}_equipment_quantity`),a.push(`repeating_equipment_${t}_equipment_weight`),a.push(`repeating_equipment_${t}_equipment_cost`)}),getAttrs(a,t=>{let s=[],c=[],m=[],h=[],l="";_.each(i,p=>{let w=t[`repeating_weapon_${p}_weapon_name`],$=t[`repeating_weapon_${p}_weapon_quantity`],D=t[`repeating_weapon_${p}_weapon_weight`],O=t[`repeating_weapon_${p}_weapon_cost`];if(_.each(r,x=>{let L=x;h.push(L);let v=t[`repeating_equipment_${x}_equipment_item`];s.push(v);let U=t[`repeating_equipment_${x}_equipment_weight`];c.push(U);let ne=t[`repeating_equipment_${x}_equipment_cost`];m.push(ne)}),D!==0||O!==0){let x=s.indexOf(w);x===-1?(l=k(),o[`repeating_equipment_${l}_equipment_type`]=1,o[`repeating_equipment_${l}_equipment_item`]=w,o[`repeating_equipment_${l}_equipment_quantity`]=$,o[`repeating_equipment_${l}_equipment_quantity_max`]=$,o[`repeating_equipment_${l}_equipment_weight`]=D,o[`repeating_equipment_${l}_equipment_cost`]=O):c[x]==="0"&&m[x]==="0"?(l=h[x],o[`repeating_equipment_${l}_equipment_type`]=1,o[`repeating_equipment_${l}_equipment_quantity`]=$,o[`repeating_equipment_${l}_equipment_quantity_max`]=$,o[`repeating_equipment_${l}_equipment_weight`]=D,o[`repeating_equipment_${l}_equipment_cost`]=O):c[x]!=="0"&&m[x]==="0"?(l=h[x],o[`repeating_equipment_${l}_equipment_type`]=1,o[`repeating_equipment_${l}_equipment_cost`]=O):c[x]==="0"&&m[x]!=="0"?(l=h[x],o[`repeating_equipment_${l}_equipment_type`]=1,o[`repeating_equipment_${l}_equipment_weight`]=D):c[x]!=="0"&&m[x]}}),setAttrs(o,{silent:!0},qr)})})})},$r=(i,r)=>{let o={};br(),o.sheet_version=i,b("VERSION UPDATE: migrateWeaponWtCost completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},yr=(i,r)=>{getSectionIDs("repeating_equipment",o=>{let e={},n=o.map(a=>[`repeating_equipment_${a}_equipment_type`]);getAttrs(n,a=>{_.each(o,t=>{(+a[`repeating_equipment_${t}_equipment_type`]||0)>=0||(e[`repeating_equipment_${t}_equipment_type`]=0)}),e.sheet_version=i,b("VERSION UPDATE: setEquipmentType completed"),setAttrs(e,{silent:!0},()=>{versionator(i,r)})})})},fr=(i,r)=>{let o={};va(),o.sheet_version=i,b("VERSION UPDATE: migrateSetSpellsCasterClass completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},vr=(i,r)=>{let o={};_e(0),o.sheet_version=i,b("VERSION UPDATE: recalcAC completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},kr=(i,r)=>{let o={};o.init_macro_text="",o.sheet_version=i,b("VERSION UPDATE: recalcAC completed"),setAttrs(o,{silent:!0},()=>{versionator(i,r)})},Ar=(i,r)=>{getSectionIDs("repeating_weapon",o=>{let e=o.flatMap(n=>[`repeating_weapon_${n}_weapon_critdamagesmallmedium`,`repeating_weapon_${n}_weapon_critdamagelarge`]);getAttrs([...e],n=>{let a={},t="(@{weapon_damagesmallmedium})*2",s="(@{weapon_damagelarge})*2";_.each(o,c=>{let m=n[`repeating_weapon_${c}_weapon_critdamagesmallmedium`]||t,h=n[`repeating_weapon_${c}_weapon_critdamagelarge`]||s;a[`repeating_weapon_${c}_weapon_critdamagesmallmedium`]=m.replace(/@{weapon_damagesmallmedium}*2/g,"(@{weapon_damagesmallmedium})*2"),a[`repeating_weapon_${c}_weapon_critdamagelarge`]=h.replace(/@{weapon_damagelarge}*2/g,"(@{weapon_damagelarge})*2")}),a.sheet_version=i,b("VERSION UPDATE: updateCriticalDamageMacro completed"),setAttrs(a,{silent:!0},()=>{versionator(i,r)})})})},xr=async()=>{let i=await u(["hitdice","armorclass","strength","intelligence","wisdom","dexterity","constitution","charisma","old_character"]),r={};if((+i.old_character||0)===1)return;let e=+i.hitdice||0,n=+i.armorclass||0,a=+i.strength||0,t=+i.intelligence||0,s=+i.wisdom||0,c=+i.dexterity||0,m=+i.constitution||0,h=+i.charisma||0,l=a+t+s+c+m+h;e===0&&n===10&&l===60?(r.strength=a===10?8:a,r.intelligence=t===10?8:t,r.wisdom=s===10?8:s,r.dexterity=c===10?8:c,r.constitution=m===10?8:m,r.charisma=h===10?8:h,r.old_character=1,qa()):r.old_character=1,await g(r,{silent:!0})},Mr=async(i,r)=>{let o=await f("equipment"),e=o.map(s=>`repeating_equipment_${s}_equipment_armor_type`),n=await u([...ye,...e]),a={};if(o.length===0){a.sheet_version=i,b("VERSION UPDATE: updateSyncArmorFlag completed (No rows to check)"),await g(a,{silent:!0}),versionator(i,r);return}let t=o.map(async s=>{let c=+n[`repeating_equipment_${s}_equipment_armor_type`]||0,{isMatch:m}=await ve(s),h=`repeating_equipment_${s}_equipment_sync_armor_flag`;c!==99&&m?a[h]=1:a[h]=0});await Promise.all(t),a.sheet_version=i,b(`VERSION UPDATE: updateSyncArmorFlag completed (${o.length} rows checked)`),await g(a,{silent:!0}),versionator(i,r)};versionator=async(i,r)=>{i<.1?Ft(.1,r):i<1.2?Gt(1.2,r):i<1.5?zt(1.5,r):i<1.52?Kt(1.52,r):i<1.53?Xt(1.53,r):i<1.54?Qt(1.54,r):i<1.55?Yt(1.55,r):i<1.56?Zt(1.56,r):i<1.57?Jt(1.57,r):i<1.591?er(1.591,r):i<1.592?ar(1.592,r):i<1.593?tr(1.593,r):i<1.594?rr(1.594,r):i<1.595?Ce(1.595,r):i<1.596?ga(1.596,r):i<1.597?or(1.597,r):i<1.598?ir(1.598,r):i<1.61?cr(1.61,r):i<1.62?pr(1.62,r):i<1.634?Ce(1.634,r):i<1.635?_r(1.635,r):i<1.636?nr(1.636,r):i<1.637?Ce(1.637,r):i<1.638?mr(1.638,r):i<1.639?lr(1.639,r):i<1.64?gr(1.641,r):i<1.642?sr(1.643,r):i<1.644?ur(1.644,r):i<1.645?wr(1.645,r):i<1.646?$r(1.646,r):i<1.648?yr(1.648,r):i<1.65?fr(1.65,r):i<1.652?ga(1.652,r):i<1.654?vr(1.654,r):i<1.656?kr(1.656,r):i<1.658?Ar(1.658,r):i<1.659?dr(1.66,r):i<1.681?await Mr(1.69,r):i<r?(output.sheet_version=r,await g(output,{silent:!0})):i===r&&await xr()};on("sheet:opened",async()=>{let r=await u(["sheet_version","old_character"]),o={},e=E(r.sheet_version);(+r.old_character||0)==0&&e===0&&(e=1.69,o.sheet_version=1.69),await g(o,{silent:!0}),b(`Current sheet data version:${e}, Sheet code version:${1.69}`),versionator(e,1.69)});on("change:abilities_info_show change:toggle_exceptional change:intelligence change:wisdom change:dexterity change:constitution change:charisma change:comeliness",async i=>{let r=await u(["intelligence","wisdom","dexterity","constitution","charisma","comeliness","toggle_exceptional"]),o={};(+r.toggle_exceptional||0)!==1&&(o.exceptional_intelligence_flag=1,o.exceptional_wisdom_flag=1,o.exceptional_dexterity_flag=1,o.exceptional_constitution_flag=1,o.exceptional_charisma_flag=1,o.exceptional_comeliness_flag=1,await g(o,{silent:!0}))});on("change:abilities_info_show change:toggle_exceptional change:strength",i=>{let r={};r.exceptional_strength_flag=1,setAttrs(r,{silent:!0})});on("change:is_npc",async i=>{let r=await u(["is_npc","toggle_npc"]),o={},e=+r.is_npc||0,n=+r.toggle_npc||0;n=e===0?0:1,o.toggle_npc=n,await g(o,{silent:!0})});var Sr=async()=>{let i=await f("equipment"),r={},o=i.flatMap(t=>[`repeating_equipment_${t}_equipment_quantity`,`repeating_equipment_${t}_equipment_cost`]),e=await u(o),n=[];_.each(i,t=>{let s=+e[`repeating_equipment_${t}_equipment_quantity`]||0,c=+e[`repeating_equipment_${t}_equipment_cost`]||0;c=s>0?c*s:0,n.push(c)});let a=n.reduce((t,s)=>t+s,0);r.total_equipment_cost=a.toFixed(2),r.total_cost=a.toFixed(2),await g(r,{silent:!0})};on("change:repeating_equipment:equipment_quantity change:repeating_equipment:equipment_cost remove:repeating_equipment",i=>{Sr()});var Ir=async()=>{let i=await u(["pp","gp","ep","sp","cp","toggle_lbs"]),r={},e=+i.toggle_lbs||0?10:1,a=((E(i.pp)+E(i.gp)+E(i.ep)+E(i.sp)+E(i.cp))/e).toFixed(2);r.total_coin_weight=a,await g(r,{silent:!0})},ba=async()=>{let i=await f("equipment"),r={},o=i.flatMap(w=>[`repeating_equipment_${w}_equipment_type`,`repeating_equipment_${w}_equipment_weight`,`repeating_equipment_${w}_equipment_quantity`,`repeating_equipment_${w}_equipment_carried`,`repeating_equipment_${w}_equipment_carried_select`]);await Ir();let e=await u(["total_coin_weight",...o]),n=[],a=[],t=[],s=+e.total_coin_weight||0;_.each(i,w=>{let $=+e[`repeating_equipment_${w}_equipment_type`]||0,D=0,O=+e[`repeating_equipment_${w}_equipment_carried_select`]||0;r[`repeating_equipment_${w}_equipment_carried`]=O===1?1:0,D=O===1?1:0;let x=+e[`repeating_equipment_${w}_equipment_quantity`]||0,L=+e[`repeating_equipment_${w}_equipment_weight`]||0,v=0,U=0;L=L*x*D,$===1&&(v=L),$===2&&(U=L),n.push(v),a.push(U),t.push(L)});let c=n.reduce((w,$)=>w+$,0),m=a.reduce((w,$)=>w+$,0),h=t.reduce((w,$)=>w+$,0),l=h-m-c,p=Math.round(E(s)+E(h));r.total_weapon_weight=c.toFixed(2),r.total_armor_weight=m.toFixed(2),r.total_equipment_weight=h.toFixed(2),r.total_equipment_weight_adjusted=l.toFixed(2),r.total_weight=p,await g(r,{silent:!0}),Nr()},Nr=async()=>{let i=await u(["encumbrancebonus","toggle_lbs"]),r={},o=+i.toggle_lbs||0,e=o?.1:1,n=350*e,a=+i.encumbrancebonus||0,t=E(a*e),c=n+(o?t:a),m=c+n,h=m+n,l=h;r.encumbrancebonus_lbs=t,r.normal_load=n,r.normal_load_adjusted=c,r.heavy_load=m,r.very_heavy_load=h,r.max_load=l+1,await g(r,{silent:!0}),Dr()},Dr=async()=>{let i=await u(["normal_load_adjusted","heavy_load","very_heavy_load","total_weight","autocalc_movement_flag","current_bulk","current_encumbrance_move"]),r={},o=+i.autocalc_movement_flag||0,e=+i.normal_load_adjusted||0,n=+i.heavy_load||0,a=+i.very_heavy_load||0,t=+i.total_weight||0,s=+i.current_bulk||0,c=0;t<=e?(r.current_encumbrance_label="Unencumbered",c=0,r.current_encumbrance=c,r.current_encumbrance_move=o===1?Math.max(c,s):+i.current_encumbrance_move||0):t>e&&t<=n?(r.current_encumbrance_label="Heavy",c=1,r.current_encumbrance=c,r.current_encumbrance_move=o===1?Math.max(c,s):+i.current_encumbrance_move||0):t>n&&t<=a?(r.current_encumbrance_label="Very Heavy",c=2,r.current_encumbrance=c,r.current_encumbrance_move=o===1?Math.max(c,s):+i.current_encumbrance_move||0):(r.current_encumbrance_label="Encumbered",c=3,r.current_encumbrance=c,r.current_encumbrance_move=o===1?Math.max(c,s):+i.current_encumbrance_move||0),await g(r,{silent:!0})};on("change:repeating_equipment:equipment_weight change:repeating_equipment:equipment_quantity change:repeating_equipment:equipment_carried change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_armor_worn remove:repeating_equipment change:pp change:gp change:ep change:sp change:cp change:encumbrancebonus change:normal_load change:toggle_lbs",i=>{ba()});var Cr=async()=>{let i=await u(["current_encumbrance_move","movement"]),r={},o=+i.movement.toString().replace(/[^0-9]/g,""),e=+i.current_encumbrance_move||0,n=0;e===0?n=o:e===1?n=q(o-3):e===2?n=q(o-6):n=q(o-9),r.movement_normal=n,r.movement_known=n*5,r.movement_run=n*10,await g(r,{silent:!0})};on("change:movement change:current_encumbrance change:current_encumbrance_move change:autocalc_movement_flag",async i=>{let r=await u(["movement"]),o={},e=0,n=+r.movement.toString().replace(/[^0-9]/g,"")||0;o.movement_heavy=Math.max(n-3,0),o.movement_load=Math.max(n-6,0),o.movement_max=Math.max(n-9,0),await g(o,{silent:!0}),await Cr(),await _e(e)});var Or=async()=>{let i=await u(["unarmored_bulk","armortype_bulk","armortype2_bulk","armorshield_bulk","unarmored_worn","armortype_worn","armortype2_worn","armorshield_worn","armorshield_carried"]),r={},o=+i.unarmored_worn||0,e=+i.armortype_worn||0,n=+i.armortype2_worn||0,a=+i.armorshield_worn||0,t=+i.armorshield_carried||0,s=Math.max(a,t),c=(+i.unarmored_bulk||0)*o,m=(+i.armortype_bulk||0)*e,h=(+i.armortype2_bulk||0)*n,l=(+i.armorshield_bulk||0)*s;switch(Math.max(c,m,h,l)){case 0:r.current_bulk_label="Not Bulky",r.current_bulk=0;break;case 1:r.current_bulk_label="Not Bulky/Light",r.current_bulk=0;break;case 2:r.current_bulk_label="Fairly/Moderate",r.current_bulk=1;break;case 3:r.current_bulk_label="Bulky/Heavy",r.current_bulk=2;break;default:console.log("WARNING: failure in bulk calculation.");break}await g(r,{silent:!0}),ba()};on("change:unarmored_bulk change:armortype_bulk change:armortype2_bulk change:armorshield_bulk change:armorhelmet_bulk change:unarmored_worn change:armortype_worn change:armortype2_worn change:armorshield_worn change:armorhelmet_worn change:armorshield_carried remove:repeating_equipment",i=>{Or()});on("change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_type change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_magical",async i=>{let r=i.sourceAttribute.split("_")[2],o=`${i.sourceAttribute}`,n=/equipment_type/.test(o),a=[`repeating_equipment_${r}_equipment_type`,`repeating_equipment_${r}_equipment_carried_select`],t=await u(["equipment_tabs_type","equipment_tabs_carry",...a]);await g(s,{silent:!0});let s={},c=+t.equipment_tabs_carry||0,m=+t.equipment_tabs_type||0,h=+t[`repeating_equipment_${r}_equipment_type`]||0,l=+t[`repeating_equipment_${r}_equipment_carried_select`]||0;s[`repeating_equipment_${r}_equipment_carried`]=l===1?1:0,s.equipment_tabs_type=m!==-1&&n?h:m,s.equipment_tabs_carry=c===-1||c===l?-1:l,await g(s)});on("change:equipment_tabs_type change:equipment_tabs_carry",async i=>{let r=await f("equipment"),o={},e=r.flatMap(s=>[`repeating_equipment_${s}_equipment_type`,`repeating_equipment_${s}_equipment_carried_select`,`repeating_equipment_${s}_equipment_magical`]),n=await u(["equipment_tabs_type","equipment_tabs_carry","equipment_magical",...e]),a=+n.equipment_tabs_type||0,t=+n.equipment_tabs_carry||0;_.each(r,s=>{let c=+n[`repeating_equipment_${s}_equipment_magical`]||0,m=+n[`repeating_equipment_${s}_equipment_type`]||0,h=+n[`repeating_equipment_${s}_equipment_carried_select`]||0;if(a===-1||a===m||a===3&&c)return o[`repeating_equipment_${s}_equipment_show_carry`]=t===-1||t===h?1:0,o[`repeating_equipment_${s}_equipment_show_type`]=1;o[`repeating_equipment_${s}_equipment_show_carry`]=t===-1||t===h?1:0,o[`repeating_equipment_${s}_equipment_show_type`]=0}),await g(o)});var Tr=async()=>{let i=await f("equipment"),r={},o=i.flatMap(a=>[`repeating_equipment_${a}_equipment_armor_type`]),[e,n]=await Promise.all([u(o),ya()]);console.log(n),_.each(i,a=>{let t=+e[`repeating_equipment_${a}_equipment_armor_type`]||0;if(t===99)return;let s=n.map((c,m)=>c===a?`${Math.floor(m)+1}`:null).filter(c=>c!==null);s.length>1&&(rowType=t+1,s.join(",").split(",").filter(l=>l!==String(rowType)).forEach(l=>{switch(l){case"1":r.unarmored="",r.unarmored_worn=0,r.unarmored_row_id=0;break;case"2":r.armortype="",r.armortype_worn=0,r.armortype1_row_id=0;break;case"3":r.armortype2="",r.armortype2_worn=0,r.armortype2_row_id=0;break;case"4":r.armorshield="",r.armorshield_worn=0,r.armorshield_row_id=0;break;case"5":r.armorhelmet="",r.armorhelmet_worn=0,r.armorhelmet_row_id=0;break;case"6":r.armorother="",r.armorother_worn=0,r.armorother1_row_id=0;break;case"7":r.armorother2="",r.armorother2_worn=0,r.armorother2_row_id=0;break;case"8":r.armorother3="",r.armorother3_worn=0,r.armorother3_row_id=0;break;case"9":r.armorother4="",r.armorother4_worn=0,r.armorother4_row_id=0;break;case"10":r.armorother5="",r.armorother5_worn=0,r.armorother5_row_id=0;break;case"11":r.armorother6="",r.armorother6_worn=0,r.armorother6_row_id=0;break;default:console.log("WARNING: NOTHING TO DELETE/RESET.");break}}))}),await g(r)},Er=`${fe.map(i=>`change:${i}`).join(" ")}`;on(Er,async i=>{if(i.sourceType==="sheetworker")return;let r=i.sourceAttribute,o=i.previousValue,e=i.newValue,n=0,a=await u(fe),t={},s="";o===void 0&&(r==="unarmored"&&(s=k(),t.unarmored_row_id=s.toLowerCase(),t.unarmored_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=0,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.unarmored.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.unarmored_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.unarmored_base||0,t[`repeating_equipment_${s}_equipment_carried_select`]=1,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armortype"&&(s=k(),t.armortype1_row_id=s.toLowerCase(),t.armortype_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=1,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armortype.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armortype_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armortype_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armortype_magic||0,t[`repeating_equipment_${s}_equipment_armor_bulk`]=+a.armortype_bulk||0,t[`repeating_equipment_${s}_equipment_carried_select`]=+a.armortype_carried||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1,t[`repeating_equipment_${s}_equipment_weight`]=+a.armor_weight||0,t[`repeating_equipment_${s}_equipment_cost`]=+a.armor_cost||0),r==="armortype2"&&(s=k(),t.armortype2_row_id=s.toLowerCase(),t.armortype2_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=2,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armortype2.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armortype2_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armortype2_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armortype2_magic||0,t[`repeating_equipment_${s}_equipment_armor_bulk`]=+a.armortype2_bulk||0,t[`repeating_equipment_${s}_equipment_carried_select`]=+a.armortype2_carried||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1,t[`repeating_equipment_${s}_equipment_weight`]=+a.armortype2_weight||0,t[`repeating_equipment_${s}_equipment_cost`]=+a.armortype2_cost||0),r==="armorshield"&&(s=k(),t.armorshield_row_id=s.toLowerCase(),t.armorshield_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=3,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorshield.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorshield_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorshield_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorshield_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorshield_mod||0,t[`repeating_equipment_${s}_equipment_armor_bulk`]=+a.armorshield_bulk||0,t[`repeating_equipment_${s}_equipment_carried_select`]=+a.armorshield_carried||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1,t[`repeating_equipment_${s}_equipment_weight`]=+a.armorshield_weight||0,t[`repeating_equipment_${s}_equipment_cost`]=+a.armorshield_cost||0),r==="armorhelmet"&&(s=k(),t.armorhelmet_row_id=s.toLowerCase(),t.armorhelmet_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=4,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorhelmet.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorhelmet_ac||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorhelmet_magic||0,t[`repeating_equipment_${s}_equipment_carried_select`]=+a.armorhelmet_carried||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1,t[`repeating_equipment_${s}_equipment_weight`]=+a.armorhelmet_weight||0,t[`repeating_equipment_${s}_equipment_cost`]=+a.armorhelmet_cost||0),r==="armorother"&&(s=k(),t.armorother1_row_id=s.toLowerCase(),t.armorother1_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=5,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armorother2"&&(s=k(),t.armorother2_row_id=s.toLowerCase(),t.armorother2_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=6,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother2.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother2_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother2_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother2_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother2_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armorother3"&&(s=k(),t.armorother3_row_id=s.toLowerCase(),t.armorother3_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=7,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother3.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother3_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother3_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother3_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother3_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armorother4"&&(s=k(),t.armorother4_row_id=s.toLowerCase(),t.armorother4_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=8,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother4.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother4_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother4_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother4_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother4_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armorother5"&&(s=k(),t.armorother5_row_id=s.toLowerCase(),t.armorother5_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=9,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother5.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother5_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother5_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother5_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother5_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1),r==="armorother6"&&(s=k(),t.armorother6_row_id=s.toLowerCase(),t.armorother6_worn=1,t[`repeating_equipment_${s}_equipment_type`]=2,t[`repeating_equipment_${s}_equipment_armor_type`]=10,t[`repeating_equipment_${s}_equipment_armor_worn`]=1,t[`repeating_equipment_${s}_equipment_item`]=a.armorother6.trim(),t[`repeating_equipment_${s}_equipment_armor_ac`]=+a.armorother6_ac||0,t[`repeating_equipment_${s}_equipment_armor_base`]=+a.armorother6_base||0,t[`repeating_equipment_${s}_equipment_armor_magic`]=+a.armorother6_magic||0,t[`repeating_equipment_${s}_equipment_armor_mod`]=+a.armorother6_mod||0,t[`repeating_equipment_${s}_equipment_sync_armor_flag`]=1)),await g(t,{silent:!0}),Ue(null,r,n)});var $a=async i=>{let r=await u([`repeating_equipment_${i}_equipment_armor_type`,`repeating_equipment_${i}_equipment_item`,`repeating_equipment_${i}_equipment_armor_worn`,`repeating_equipment_${i}_equipment_armor_ac`,`repeating_equipment_${i}_equipment_armor_base`,`repeating_equipment_${i}_equipment_armor_magic`,`repeating_equipment_${i}_equipment_armor_mod`,`repeating_equipment_${i}_equipment_armor_bulk`,`repeating_equipment_${i}_equipment_carried_select`,`repeating_equipment_${i}_equipment_carried`,`repeating_equipment_${i}_equipment_weight`,`repeating_equipment_${i}_equipment_cost`]),o={},e=0,n=+r[`repeating_equipment_${i}_equipment_armor_type`]||0,a=r[`repeating_equipment_${i}_equipment_item`],t=+r[`repeating_equipment_${i}_equipment_armor_worn`]||0,s=+r[`repeating_equipment_${i}_equipment_armor_ac`]||0,c=+r[`repeating_equipment_${i}_equipment_armor_base`]||0,m=+r[`repeating_equipment_${i}_equipment_armor_magic`]||0,h=+r[`repeating_equipment_${i}_equipment_armor_mod`]||0,l=+r[`repeating_equipment_${i}_equipment_armor_bulk`]||0,p=+r[`repeating_equipment_${i}_equipment_carried_select`]||0,w=+r[`repeating_equipment_${i}_equipment_weight`]||0,$=+r[`repeating_equipment_${i}_equipment_cost`]||0;t===1?(p=1,o[`repeating_equipment_${i}_equipment_carried_select`]=1):t===0&&(p===0||p===2)&&(o[`repeating_equipment_${i}_equipment_carried_select`]=p);let D=[`fillArmorDetails - id:${i} item:${a} type:${n} worn:${t} ac:${s} base:${c} magic:${m} mod:${h} bulk:${l} carried:${p} weight:${w} cost:${$} UPDATED:`];switch(n){case 99:break;case 0:o.unarmored_worn=t,o.unarmored=a,o.unarmored_ac=s,o.unarmored_base=c,o.unarmored_bulk=l,o.unarmored_carried=p,o.unarmored_row_id=i;break;case 1:o.armortype_worn=t,o.armortype=a,o.armortype_ac=s,o.armortype_base=c,o.armortype_magic=m,o.armortype_bulk=l,o.armortype_carried=p,o.armor_weight=w,o.armor_cost=$,o.armortype1_row_id=i;break;case 2:o.armortype2_worn=t,o.armortype2=a,o.armortype2_ac=s,o.armortype2_base=c,o.armortype2_magic=m,o.armortype2_bulk=l,o.armortype2_carried=p,o.armortype2_weight=w,o.armortype2_cost=$,o.armortype2_row_id=i;break;case 3:o.armorshield_worn=t,o.armorshield=a,o.armorshield_ac=s>=0?0:-Math.abs(s),o.armorshield_base=c>=0?0:-Math.abs(c),o.armorshield_magic=m,o.armorshield_mod=h,o.armorshield_bulk=l,o.armorshield_carried=p,o.armorshield_weight=w,o.armorshield_cost=$,o.armorshield_row_id=i;break;case 4:o.armorhelmet_worn=t,o.armorhelmet=a,o.armorhelmet_base=c,o.armorhelmet_magic=m,o.armorhelmet_carried=p,o.armorhelmet_weight=w,o.armorhelmet_cost=$,o.armorhelmet_row_id=i;break;case 5:o.armorother_worn=t,o.armorother=a,o.armorother_ac=s,o.armorother_base=c,o.armorother_magic=m,o.armorother_mod=h,o.armorother1_row_id=i;break;case 6:o.armorother2_worn=t,o.armorother2=a,o.armorother2_ac=s>=0?0:-Math.abs(s),o.armorother2_base=c>=0?0:-Math.abs(c),o.armorother2_magic=m,o.armorother2_mod=h,o.armorother2_row_id=i;break;case 7:o.armorother3_worn=t,o.armorother3=a,o.armorother3_ac=s>=0?0:-Math.abs(s),o.armorother3_base=c>=0?0:-Math.abs(c),o.armorother3_magic=m,o.armorother3_mod=h,o.armorother3_row_id=i;break;case 8:o.armorother4_worn=t,o.armorother4=a,o.armorother4_ac=s>=0?0:-Math.abs(s),o.armorother4_base=c>=0?0:-Math.abs(c),o.armorother4_magic=m,o.armorother4_mod=h,o.armorother4_row_id=i;break;case 9:o.armorother5_worn=t,o.armorother5=a,o.armorother5_ac=s>=0?0:-Math.abs(s),o.armorother5_base=c>=0?0:-Math.abs(c),o.armorother5_magic=m,o.armorother5_mod=h,o.armorother5_row_id=i;break;case 10:o.armorother6_worn=t,o.armorother6=a,o.armorother6_ac=s>=0?0:-Math.abs(s),o.armorother6_base=c>=0?0:-Math.abs(c),o.armorother6_magic=m,o.armorother6_mod=h,o.armorother6_row_id=i;break;default:console.log("WARNING: Armor row is out of range.");break}await g(o,{silent:!0}),_e(e)},Lr=async i=>{let r=await u([`repeating_equipment_${i}_equipment_item`,`repeating_equipment_${i}_equipment_weapon_type`,`repeating_equipment_${i}_equipment_weapon_speed`,`repeating_equipment_${i}_equipment_weapon_length`,`repeating_equipment_${i}_equipment_weapon_space`,`repeating_equipment_${i}_equipment_weapon_misc`,`repeating_equipment_${i}_equipment_weapon_damagesmallmedium`,`repeating_equipment_${i}_equipment_weapon_damagelarge`,`repeating_equipment_${i}_equipment_weapon_attackdmgtype`,`repeating_equipment_${i}_equipment_weapon_rateoffire`,`repeating_equipment_${i}_equipment_weapon_range`,`repeating_equipment_${i}_equipment_quantity`,`repeating_equipment_${i}_equipment_description`]),o={},e=k();o[`repeating_weapon_${e}_weapon_name`]=r[`repeating_equipment_${i}_equipment_item`],o[`repeating_weapon_${e}_weapon_type`]=+r[`repeating_equipment_${i}_equipment_weapon_type`]||0,o[`repeating_weapon_${e}_weapon_speed`]=r[`repeating_equipment_${i}_equipment_weapon_speed`],o[`repeating_weapon_${e}_weapon_length`]=r[`repeating_equipment_${i}_equipment_weapon_length`],o[`repeating_weapon_${e}_weapon_space`]=r[`repeating_equipment_${i}_equipment_weapon_space`],o[`repeating_weapon_${e}_weapon_misc`]=r[`repeating_equipment_${i}_equipment_weapon_misc`],o[`repeating_weapon_${e}_weapon_damagesmallmedium`]=r[`repeating_equipment_${i}_equipment_weapon_damagesmallmedium`],o[`repeating_weapon_${e}_weapon_damagelarge`]=r[`repeating_equipment_${i}_equipment_weapon_damagelarge`],o[`repeating_weapon_${e}_weapon_attackdmgtype`]=r[`repeating_equipment_${i}_equipment_weapon_attackdmgtype`],o[`repeating_weapon_${e}_weapon_rateoffire`]=r[`repeating_equipment_${i}_equipment_weapon_rateoffire`],o[`repeating_weapon_${e}_weapon_range`]=r[`repeating_equipment_${i}_equipment_weapon_range`],o[`repeating_weapon_${e}_weapon_quantity`]=+r[`repeating_equipment_${i}_equipment_quantity`]||0,o[`repeating_weapon_${e}_weapon_notes`]=r[`repeating_equipment_${i}_equipment_description`],await g(o,{silent:!0}),await Ia(e),Ve(e)},ya=async()=>{let i=await u(ye);return[unarmored0_ID=i.unarmored_row_id.toString(),armortype1_ID=i.armortype1_row_id.toString(),armortype2_ID=i.armortype2_row_id.toString(),armorshield_ID=i.armorshield_row_id.toString(),armorhelmet_ID=i.armorhelmet_row_id.toString(),armorother1_ID=i.armorother1_row_id.toString(),armorother2_ID=i.armorother2_row_id.toString(),armorother3_ID=i.armorother3_row_id.toString(),armorother4_ID=i.armorother4_row_id.toString(),armorother5_ID=i.armorother5_row_id.toString(),armorother6_ID=i.armorother6_row_id.toString()].map(o=>o?o.toString().toLowerCase():"0")},ve=async i=>{let r=await ya(),o="";return o=r.includes(i)?1:0,{isMatch:o,armorDetailsArray:r}},fa=async i=>{let r={},{isMatch:o,armorDetailsArray:e}=await ve(i);r.armordetails_array=[`${e}`],await g(r,{silent:!0})},Rr=`${ye.map(i=>`change:${i}`).join(" ")}`;on(Rr,async i=>{let r=i.sourceAttribute,e=(await u([`${r}`,"armordetails_array"]))[`${i.sourceAttribute}`];fa(e)});on("change:repeating_equipment:equipment_item change:repeating_equipment:equipment_armor_worn change:repeating_equipment:equipment_armor_ac change:repeating_equipment:equipment_armor_base change:repeating_equipment:equipment_armor_magic change:repeating_equipment:equipment_armor_mod change:repeating_equipment:equipment_armor_bulk change:repeating_equipment:equipment_carried_select change:repeating_equipment:equipment_weight change:repeating_equipment:equipment_cost",async i=>{let r=i.sourceAttribute.split("_")[2].toLowerCase();if(i.sourceType==="sheetworker")return;let{isMatch:o}=await ve(r);o&&$a(r)});on("clicked:repeating_equipment:addarmor change:repeating_equipment:equipment_armor_type",async i=>{let o=i.sourceAttribute.toLowerCase().split("_"),e=o[2],n=o.slice(3).join("_"),a=`repeating_equipment_${e}_equipment_armor_type`,t=`repeating_equipment_${e}_equipment_sync_armor_flag`,s=await u([a,t]),c={},m=+s[a]||0,h=+s[t]||0;(n==="addarmor"&&m!==99||n==="equipment_armor_type"&&h===1)&&(await $a(e),await Tr(),h!==1&&(c[t]=1,await g(c,{silent:!0})))});on("clicked:repeating_equipment:addattack",i=>{let r=i.sourceAttribute.split("_")[2];Lr(r)});on("remove:repeating_equipment",async i=>{let r=i.sourceAttribute.split("_")[2].toLowerCase(),o=1,{isMatch:e}=await ve(r);e&&Ue(r,null,o)});on("clicked:addturnundead",i=>{let r={},o=k();r[`repeating_ability_${o}_ability_name`]="Turn Undead by Type",r[`repeating_ability_${o}_ability_short_description`]="[Turn Undead by Type](~selected|turn_undead_roll)",setAttrs(r,{silent:!0})});on("clicked:addturnundead2",i=>{let r={},o=k();r[`repeating_ability_${o}_ability_name`]="Turn Undead by HD",r[`repeating_ability_${o}_ability_short_description`]="[Turn Undead by HD](~selected|turn_undead2_roll)",setAttrs(r,{silent:!0})});on("change:spell_tabs change:toggle_show_memorized change:spell_caster_tabs change:toggle_caster2",async i=>{let r=await f("spells"),o={},e=r.flatMap(m=>[`repeating_spells_${m}_spell_memorized`,`repeating_spells_${m}_spell_show_all`,`repeating_spells_${m}_spell_level`,`repeating_spells_${m}_spell_caster_class`]),n=await u(["spell_tabs","toggle_show_memorized","spell_caster_tabs","toggle_caster2",...e]),a=+n.toggle_show_memorized||0,t=+n.spell_caster_tabs||0,s=+n.toggle_caster2||0,c=+n.spell_tabs||0;_.each(r,m=>{let h=+n[`repeating_spells_${m}_spell_memorized`]||0,l=+n[`repeating_spells_${m}_spell_caster_class`]||0,p=n[`repeating_spells_${m}_spell_level`];o[`repeating_spells_${m}_spell_show_memorized`]=a===1&&h>0?1:0,o[`repeating_spells_${m}_spell_show_all`]=a===1?0:1,c===-1||c===p?s===1?o[`repeating_spells_${m}_spell_show`]=1:s===0&&(t===-1||l===0?o[`repeating_spells_${m}_spell_show`]=1:t===0&&l===1?o[`repeating_spells_${m}_spell_show`]=1:t===1&&l===2?o[`repeating_spells_${m}_spell_show`]=1:o[`repeating_spells_${m}_spell_show`]=0):o[`repeating_spells_${m}_spell_show`]=0}),await g(o,{silent:!0})});on("change:repeating_spells:spell_level change:repeating_spells:spell_caster_class",async i=>{if(i.sourceType!=="player")return;let r=i.sourceAttribute.split("_")[2],o=await u([`repeating_spells_${r}_spell_level`,`repeating_spells_${r}_spell_caster_class`,"spell_caster_tabs","spell_tabs"]),e={},n=+o.spell_caster_tabs||0,a=+o[`repeating_spells_${r}_spell_caster_class`]||0,t=o[`repeating_spells_${r}_spell_level`],s=+o.spell_tabs||0;e.spell_tabs=s>=0&&s!==t?t:s,e.spell_caster_tabs=n!==-1&&a<=1?0:1,await g(e,{silent:!0})});var va=async()=>{let i=await f("spells"),r={},o=i.flatMap(c=>[`repeating_spells_${c}_spell_caster_class`]),e=await u(["caster_class1_name","caster_class2_name","caster_class1_level","caster_class2_level",...o]),n=e.caster_class1_name,a=e.caster_class2_name,t=+e.caster_class1_level||0,s=+e.caster_class2_level||0;_.each(i,c=>{switch(+e[`repeating_spells_${c}_spell_caster_class`]||0){case 0:r[`repeating_spells_${c}_spell_caster_class_name`]="";break;case 1:r[`repeating_spells_${c}_spell_caster_class_name`]=n,r[`repeating_spells_${c}_spell_caster_class_level`]=t;break;case 2:r[`repeating_spells_${c}_spell_caster_class_name`]=a,r[`repeating_spells_${c}_spell_caster_class_level`]=s;break;default:console.log("WARNING: spell_caster_class value not recognized.");break}}),await g(r,{silent:!0})};on("change:caster_class1_name change:caster_class2_name change:caster_class1_level change:caster_class2_level",async i=>{await va()});on("change:repeating_spells:spell_name change:repeating_spells:spell_caster_class",async i=>{if(i.sourceType!=="player")return;let r=i.sourceAttribute.split("_")[2],o=i.previousValue,e=i.sourceAttribute.split("_").slice(3).join("_"),n=o===void 0&&e==="spell_name"?1:0,a=await u([`repeating_spells_${r}_spell_caster_class`,"caster_class1_name","caster_class1_level","caster_class2_name","caster_class2_level","spell_caster_tabs","toggle_caster2"]),t={},s=a.caster_class1_name,c=a.caster_class2_name,m=+a.caster_class1_level||0,h=+a.caster_class2_level||0,l=+a.toggle_caster2||0,p=+a.spell_caster_tabs||0,w=+a[`repeating_spells_${r}_spell_caster_class`]||0;switch(l===0&&n===1&&p!==-1&&(w=p===0?1:2),w){case 0:t[`repeating_spells_${r}_spell_caster_class_name`]="";break;case 1:t[`repeating_spells_${r}_spell_caster_class_name`]=s,t[`repeating_spells_${r}_spell_caster_class_level`]=m;break;case 2:t[`repeating_spells_${r}_spell_caster_class_name`]=c,t[`repeating_spells_${r}_spell_caster_class_level`]=h;break;default:console.log("WARNING: spell_caster_class value not recognized.");break}await g(t,{silent:!0})});on("change:repeating_spells:spell_name",async i=>{if(i.sourceType!=="player")return;let r=i.sourceAttribute.split("_")[2],o=await u([`repeating_spells_${r}_spell_level`,"spell_tabs"]),e={},n=+o.spell_tabs||0,a=o[`repeating_spells_${r}_spell_level`];n===-1||a!="?"||(e[`repeating_spells_${r}_spell_level`]=n,await g(e,{silent:!0}))});on("change:repeating_weapon:weapon_tohitacadj_flag change:repeating_weapon:weapon_thac_adj0 change:repeating_weapon:weapon_thac_adj1 change:repeating_weapon:weapon_thac_adj2 change:repeating_weapon:weapon_thac_adj3 change:repeating_weapon:weapon_thac_adj4 change:repeating_weapon:weapon_thac_adj5 change:repeating_weapon:weapon_thac_adj6 change:repeating_weapon:weapon_thac_adj7 change:repeating_weapon:weapon_thac_adj8 change:repeating_weapon:weapon_thac_adj9 change:repeating_weapon:weapon_thac_adj10",async i=>{let r=i.sourceAttribute.split("_")[2],o=await u([`repeating_weapon_${r}_weapon_ToHitACadj_flag`,`repeating_weapon_${r}_weapon_ToHitACadj`]),e={},n=+o[`repeating_weapon_${r}_weapon_ToHitACadj_flag`]||0;e.repeating_weapon_weapon_ToHitACadj=n===1?"{{ToHitACadj2to10=HitAdj:[[ @{weapon_thac_adj0} ]]|[[ @{weapon_thac_adj1} ]]|[[ @{weapon_thac_adj2} ]]|[[ @{weapon_thac_adj3} ]]|[[ @{weapon_thac_adj4} ]]|[[ @{weapon_thac_adj5} ]]|[[ @{weapon_thac_adj6} ]]|[[ @{weapon_thac_adj7} ]]|[[ @{weapon_thac_adj8} ]]|[[ @{weapon_thac_adj9} ]]|[[ @{weapon_thac_adj10} ]] }}":"{{ToHitACadj2to10}}",await g(e,{silent:!0})});var ka=(i,r)=>{let o={},e=+i.toggle_to_hit_table||0,n=`repeating_weapon_${r}_weapon_whisper_to_hit_select`,a=`repeating_weapon_${r}_weapon_whisper_to_hit`,t=+i[n]||0,s="";return t===2?s="&nbsp;":e===0?(s="%NEWLINE%/w gm &{template:attacks-table} {{color=@{color_option}}} {{ToHitAC-10to0=ToHit:[[ @{thac-10} ]]|[[ @{thac-9} ]]|[[ @{thac-8} ]]|[[ @{thac-7} ]]|[[ @{thac-6} ]]|[[ @{thac-5} ]]|[[ @{thac-4} ]]|[[ @{thac-3} ]]|[[ @{thac-2} ]]|[[ @{thac-1} ]]|[[ @{thac0} ]]}} {{ToHitAC1to10=ToHit:[[ @{thac0} ]]|[[ @{thac1} ]]|[[ @{thac2} ]]|[[ @{thac3} ]]|[[ @{thac4} ]]|[[ @{thac5} ]]|[[ @{thac6} ]]|[[ @{thac7} ]]|[[ @{thac8} ]]|[[ @{thac9} ]]|[[ @{thac10} ]] }}",t=0):(s="%NEWLINE%/w gm &{template:attacks-table} {{color=@{color_option}}} {{ToHitAC-10to0=ToHit:[[ @{thac0-10} ]]|[[ @{thac0-9} ]]|[[ @{thac0-8} ]]|[[ @{thac0-7} ]]|[[ @{thac0-6} ]]|[[ @{thac0-5} ]]|[[ @{thac0-4} ]]|[[ @{thac0-3} ]]|[[ @{thac0-2} ]]|[[ @{thac0-1} ]]|[[ @{thac00} ]]}} {{ToHitAC1to10=ToHit:[[ @{thac00} ]]|[[ @{thac01} ]]|[[ @{thac02} ]]|[[ @{thac03} ]]|[[ @{thac04} ]]|[[ @{thac05} ]]|[[ @{thac06} ]]|[[ @{thac07} ]]|[[ @{thac08} ]]|[[ @{thac09} ]]|[[ @{thac010} ]] }}",t=1),o[a]=s,o[n]=t,o};on("change:toggle_to_hit_table",async i=>{let r=await f("weapon"),o=r.flatMap(a=>[`repeating_weapon_${a}_weapon_whisper_to_hit_select`,`repeating_weapon_${a}_weapon_whisper_to_hit`]),e=await u(["toggle_to_hit_table",...o]),n={};r.forEach(a=>{let t=ka(e,a);n={...n,...t}}),await g(n,{silent:!0})});on("change:repeating_weapon:weapon_whisper_to_hit_select",async i=>{let r=i.sourceAttribute.split("_")[2],o=await u(["toggle_to_hit_table",`repeating_weapon_${r}_weapon_whisper_to_hit_select`,`repeating_weapon_${r}_weapon_whisper_to_hit`]),e=ka(o,r);await g(e,{silent:!0})});on("change:weapon_proficiency_initial change:weapon_proficiency_added_per_level change:weapon_proficiency_penalty",async i=>{let r=await f("weapon"),o={},e=r.flatMap(t=>[`repeating_weapon_${t}_weapon_prof_flag`]),n=await u(["weapon_proficiency_penalty",...e]),a=+n.weapon_proficiency_penalty||0;_.each(r,t=>{let s=+n[`repeating_weapon_${t}_weapon_prof_flag`]||0;o[`repeating_weapon_${t}_weapon_prof`]=a,o[`repeating_weapon_${t}_weapon_prof_pen`]=s===0?"0":a}),await g(o,{silent:!0})});on("change:repeating_weapon:weapon_prof_flag",async i=>{let r=i.sourceAttribute.split("_")[2],o={},e=await u(["weapon_proficiency_penalty",`repeating_weapon_${r}_weapon_prof_flag`]),n=+e.weapon_proficiency_penalty||0,a=+e[`repeating_weapon_${r}_weapon_prof_flag`]||0;o[`repeating_weapon_${r}_weapon_prof`]=n,o[`repeating_weapon_${r}_weapon_prof_pen`]=a===0?"0":n,await g(o,{silent:!0})});on("change:backstab change:backstab_bonus change:toggle_thief_skills",async i=>{let r=await f("weapon"),o={},e=r.flatMap(c=>[`repeating_weapon_${c}_weapon_backstab_flag`]),n=await u(["backstab","backstab_bonus","toggle_thief_skills",...e]),a=+n.toggle_thief_skills||0,t=+n.backstab||0,s=+n.backstab_bonus||0;_.each(r,c=>{let m=+n[`repeating_weapon_${c}_weapon_backstab_flag`]||0;a===0&&(o[`repeating_weapon_${c}_weapon_backstab_var`]=m===0?0:`+${s}`,o[`repeating_weapon_${c}_weapon_backstab_bonus`]=m===0?0:s,o[`repeating_weapon_${c}_weapon_backstab`]=m===0?1:`x${t}`,o[`repeating_weapon_${c}_weapon_backstab_mult`]=m===0?1:t),a===1&&(o[`repeating_weapon_${c}_weapon_backstab_var`]=0,o[`repeating_weapon_${c}_weapon_backstab_bonus`]=0,o[`repeating_weapon_${c}_weapon_backstab`]=1,o[`repeating_weapon_${c}_weapon_backstab_mult`]=1)}),await g(o,{silent:!0})});on("change:repeating_weapon:weapon_backstab_flag",async i=>{let r=i.sourceAttribute.split("_")[2],o={},e=await u(["backstab","backstab_bonus","toggle_thief_skills",`repeating_weapon_${r}_weapon_backstab_flag`]),n=+e.toggle_thief_skills||0,a=+e.backstab||0,t=+e.backstab_bonus||0,s=+e[`repeating_weapon_${r}_weapon_backstab_flag`]||0;n===0&&(o[`repeating_weapon_${r}_weapon_backstab_var`]=s===0?0:`+${t}`,o[`repeating_weapon_${r}_weapon_backstab_bonus`]=s===0?0:t,o[`repeating_weapon_${r}_weapon_backstab`]=s===0?1:`x${a}`,o[`repeating_weapon_${r}_weapon_backstab_mult`]=s===0?1:a),n===1&&(o[`repeating_weapon_${r}_weapon_backstab_var`]=0,o[`repeating_weapon_${r}_weapon_backstab_bonus`]=0,o[`repeating_weapon_${r}_weapon_backstab`]=1,o[`repeating_weapon_${r}_weapon_backstab_mult`]=1),await g(o,{silent:!0})});on("change:repeating_weapon:weapon_dual",async i=>{let r=i.sourceAttribute.split("_")[2],o={},e=await u(["dual_pen_primary","dual_pen_secondary",`repeating_weapon_${r}_weapon_dual`]),n=+e.dual_pen_primary||0,a=+e.dual_pen_secondary||0,t=e[`repeating_weapon_${r}_weapon_dual`],s=0;t==="Normal"?s=0:t==="Primary"?s=n:t==="Secondary"&&(s=a);let c=Math.min(0,s);o[`repeating_weapon_${r}_weapon_dual_pen`]=c,await g(o,{silent:!0})});var Pr=async()=>{let i=await f("weapon"),r={},o=i.flatMap(t=>[`repeating_weapon_${t}_weapon_critdamage_flag`,`repeating_weapon_${t}_weapon_critdamage_mult`]),e=await u(["dual_pen_primary","dual_pen_secondary",...o]),n=+e.dual_pen_primary||0,a=+e.dual_pen_secondary||0;_.each(i,t=>{let s=e[`repeating_weapon_${t}_weapon_dual`],c=0;s==="Primary"?c=n:s==="Secondary"&&(c=a);let m=Math.min(0,c);r[`repeating_weapon_${t}_weapon_dual_pen`]=m}),await g(r)};on("change:dual_pen_primary change:dual_pen_secondary change:dexterity",async i=>{let r=await u(["dexterity"]),o={},e=+r.dexterity||0,n=0;e<6?n=Math.max(-3,e-6):e>=18?n=Math.min(5,Math.floor(e/3)-3):e>15&&(n=e-15);let a=Math.min(0,n-2),t=Math.min(0,n-4);o.dual_pen_primary=a,o.dual_pen_secondary=t,await g(o,{silent:!0}),Pr()});var Br=async i=>{let r=[`repeating_weapon_${i}_weapon_range`,`repeating_weapon_${i}_weapon_range_short`,`repeating_weapon_${i}_weapon_range_medium`,`repeating_weapon_${i}_weapon_range_long`,`repeating_weapon_${i}_weapon_attack_type`,`repeating_weapon_${i}_weapon_range_error`],o=await u(r),e={},n=+o[`repeating_weapon_${i}_weapon_attack_type`]||0;if(n===0||n===2)return;let a=o[`repeating_weapon_${i}_weapon_range`];a=a.replace(/'/g,""),a=a.replace(/"/g,"");let t=a.split("/").join(",").split(" ").join(",").split("-").join(",").split(","),s=Number(t[0]),c=Number(t[1]),m=Number(t[2]);t.length===1&&s>=0&&!c&&!m&&(c=s,m=s),Number.isNaN(s)?(e[`repeating_weapon_${i}_weapon_range_short`]=0,e[`repeating_weapon_${i}_weapon_range_error`]=a===""?1:0):e[`repeating_weapon_${i}_weapon_range_short`]=s,Number.isNaN(c)?(e[`repeating_weapon_${i}_weapon_range_medium`]=0,e[`repeating_weapon_${i}_weapon_range_error`]=a===""?1:0):e[`repeating_weapon_${i}_weapon_range_medium`]=c,Number.isNaN(m)?(e[`repeating_weapon_${i}_weapon_range_long`]=0,e[`repeating_weapon_${i}_weapon_range_error`]=a===""?1:0):e[`repeating_weapon_${i}_weapon_range_long`]=m,!Number.isNaN(s)&&!Number.isNaN(c)&&!Number.isNaN(m)&&(e[`repeating_weapon_${i}_weapon_range_error`]=1),await g(e,{silent:!0})};on("change:repeating_weapon:weapon_range change:repeating_weapon:weapon_attack_type",i=>{let r=i.sourceAttribute.split("_")[2];Br(r)});on("change:repeating_weapon:weapon_attack_type",async i=>{let r=i.sourceAttribute.split("_")[2],o=await u([`repeating_weapon_${r}_weapon_attack_type`,`repeating_weapon_${r}_weapon_attack_type_flag`]),e={},n=+o[`repeating_weapon_${r}_weapon_attack_type`]||0,a=+o[`repeating_weapon_${r}_weapon_attack_type_flag`]||0;n!==a&&(e[`repeating_weapon_${r}_weapon_attack_type_flag`]=n),await g(e,{silent:!0})});var Aa=async()=>{let i=await u(["hitpoints","hitpoints_max","sync_hp_flag","hitpoints_1_class","hitpoints_2_class","hitpoints_3_class"]),r={},o=+i.sync_hp_flag||0,e=+i.hitpoints_max||0,n=Math.max(0,+i.hitpoints_1_class),a=Math.max(0,+i.hitpoints_2_class),t=Math.max(0,+i.hitpoints_3_class),s=n!==0?1:0,c=a!==0?1:0,m=t!==0?1:0,h=s+c+m,l=q(n+a+t),p=E(l/h).toFixed(2);r.hitpoints_class_total=l,r.hp_quotient=h,r.hitpoints_total=p,r.hitpoints_max=o===1?q(p):e,await g(r,{silent:!0})};on("change:sync_hp_flag change:hitpoints change:hitpoints_max change:hitpoints_1_class change:hitpoints_2_class change:hitpoints_3_class",i=>{Aa()});var _e=async i=>{let r=await u([...fe,"armor_rating_flag","armorbonus","armorbonus_inverted","armorbonus_toggle","armorclass","armorclass_magic","armorclass_mod","autocalc_ac","current_encumbrance_move","sync_ac_flag"]);if((+r.autocalc_ac||0)+i===0)return;let e={},n=+r.armorclass||0,a=+r.sync_ac_flag||0,t=+r.armor_rating_flag||0,s=(+r.armorshield_mod||0)*-1,c=(+r.armorother_mod||0)*-1,m=(+r.armorother2_mod||0)*-1,h=(+r.armorother3_mod||0)*-1,l=(+r.armorother4_mod||0)*-1,p=(+r.armorother5_mod||0)*-1,w=(+r.armorother6_mod||0)*-1,$=(+r.armortype_magic||0)*-1,D=(+r.armortype2_magic||0)*-1,O=(+r.armorshield_magic||0)*-1,x=(+r.armorhelmet_magic||0)*-1,L=(+r.armorother_magic||0)*-1,v=(+r.armorother2_magic||0)*-1,U=(+r.armorother3_magic||0)*-1,ne=(+r.armorother4_magic||0)*-1,y=(+r.armorother5_magic||0)*-1,me=(+r.armorother6_magic||0)*-1,le=+r.unarmored_worn||0,oe=+r.armortype_worn||0,ie=+r.armortype2_worn||0,z=+r.armorshield_worn||0,ke=+r.armorhelmet_worn||0,K=+r.armorother_worn||0,X=+r.armorother2_worn||0,Q=+r.armorother3_worn||0,Y=+r.armorother4_worn||0,Z=+r.armorother5_worn||0,J=+r.armorother6_worn||0,V=+r.current_encumbrance_move||0,Ae=+r.armorbonus_toggle||0,R=+r.armorbonus||0,xe=0;V===3&&R<0?(Ae=0,R=0,xe=1):R<0?R=(+r.armorbonus||0)*Ae:R=+r.armorbonus||0,e.encumbrance_flag=xe;let he=+r.unarmored_base||0,We=+r.armortype_base||0,He=+r.armortype2_base||0,Fe=+r.armorshield_base||0,Ge=+r.armorother_base||0,ze=r.armorother2_base>=0?0:-Math.abs(r.armorother2_base),Ke=r.armorother3_base>=0?0:-Math.abs(r.armorother3_base),Xe=r.armorother4_base>=0?0:-Math.abs(r.armorother4_base),Qe=r.armorother5_base>=0?0:-Math.abs(r.armorother5_base),Ye=r.armorother6_base>=0?0:-Math.abs(r.armorother6_base),Ze=+r.unarmored_ac||0,Je=+r.armortype_ac||0,ea=+r.armortype2_ac||0,aa=+r.armorshield_ac||0,ta=+r.armorother_ac||0,ra=r.armorother2_ac>=0?0:-Math.abs(r.armorother2_ac),_a=r.armorother3_ac>=0?0:-Math.abs(r.armorother3_ac),na=r.armorother4_ac>=0?0:-Math.abs(r.armorother4_ac),oa=r.armorother5_ac>=0?0:-Math.abs(r.armorother5_ac),ia=r.armorother6_ac>=0?0:-Math.abs(r.armorother6_ac),at=oe?We:10,tt=ie?He:10,rt=z?Fe:0,_t=K?Ge:10,nt=X?ze:0,ot=Q?Ke:0,it=Y?Xe:0,st=Z?Qe:0,ct=J?Ye:0,pt=le?he:10,mt=oe?Je:10,lt=ie?ea:10,sa=z?aa:0,ht=K?ta:10,gt=X?ra:0,ut=Q?_a:0,wt=Y?na:0,dt=Z?oa:0,qt=J?ia:0,bt=le?Ze:10,ge=z?s:0,ue=z?O:0,$t=q(Math.min(We,He,Ge,he)+Fe+ze+Ke+Xe+Qe+Ye),yt=q(Math.min(Je,ea,ta,Ze)+(aa+ra+_a+na+oa+ia)),ca=q(Math.min(at,tt,_t,pt)+(rt+nt+ot+it+st+ct)),Me=q(Math.min(mt,lt,ht,bt)+(gt+ut+wt+dt+qt)),pa=q($+D+x+L+v+U+ne+y+me+O),se=q(oe*$+ie*D+ke*x+K*L+X*v+Q*U+Y*ne+Z*y+J*me),ma=q(c+m+h+l+p+w+s)||0,ce=q(K*c+X*m+Q*h+Y*l+Z*p+J*w),Se=q(ce+se),Ie=q(Me+ce+se),la=1;R>0&&Ie>=10&&(la=0);let Ne=q(Ie+R*la),ee=q(sa+ge+ue),De=q(Ne+ee);R>0&&ee>=10&&(De=q(Ne+R+ee));let ft=(-1*(se+ue)<=0?"":"+")+-1*(se+ue),vt=(-1*pa<=0?"":"+")+-1*pa,kt=(-1*(ce+ge)<=0?"":"+")+-1*(ce+ge),At=(-1*ma<=0?"":"+")+-1*ma,xt=(-1*R<=0?"":"+")+-1*R,Mt=(-1*Se<=0?"":"+")+-1*Se,St=(-1*ee<=0?"":"+")+-1*ee;e.armorclass_rating_used=ca,e.armorclass_rating=t===1?"-":ca,e.armorclass_rating_best=$t,e.armorclass_base_used=Me+sa,e.armorclass_base=Me,e.armorclass_base_best=yt,e.armorclass_magic=se,e.armorclass_magic_with_shield=ft,e.armorclass_magic_total=vt,e.armorclass_mod=ce,e.armorclass_mod_with_shield=kt,e.armorclass_mod_total=At,e.armorclass_combined_mod_magic=Se,e.armorclass_combined_mod_magic_inverted=Mt,e.armorclass_rear=Ie,e.armorbonus_inverted=xt,e.armorclass_shieldless=Ne,e.armorclass_shield_magic=ue,e.armorclass_shield_mod=ge,e.armorclass_combined_shield_mod_magic=ee,e.armorclass_combined_shield_mod_magic_inverted=St,e.armorclass_total=De,e.armorclass=a?De:n,await g(e,{silent:!0})};on("change:armor_details_show change:armor_rating_flag change:sync_ac_flag change:autocalc_ac change:unarmored change:armortype change:armortype2 change:armorshield change:armorhelmet change:armorother change:armorother2 change:armorother3 change:armorother4 change:armorother5 change:armorother6 change:armorclass_mod change:armorclass_magic change:armorbonus change:armorbonus_toggle change:unarmored_worn change:armortype_worn change:armortype2_worn change:armorshield_worn change:armorhelmet_worn change:armorother_worn change:armorother2_worn change:armorother3_worn change:armorother4_worn change:armorother5_worn change:armorother6_worn change:armortype_base change:armortype2_base change:armorshield_base change:armorother_base change:armorother2_base change:armorother3_base change:armorother4_base change:armorother5_base change:armorother6_base change:unarmored_base change:armortype_ac change:armortype2_ac change:armorshield_ac change:armorhelmet_ac change:armorother_ac change:armorother2_ac change:armorother3_ac change:armorother4_ac change:armorother5_ac change:armorother6_ac change:unarmored_ac change:armorshield_mod change:armorother_mod change:armorother2_mod change:armorother3_mod change:armorother4_mod change:armorother5_mod change:armorother6_mod change:armortype_magic change:armortype2_magic change:armorshield_magic change:armorhelmet_magic change:armorother_magic change:armorother2_magic change:armorother3_magic change:armorother4_magic change:armorother5_magic change:armorother6_magic clicked:calcac",i=>{let o=i.triggerName==="clicked:calcac"?1:0;_e(o)});var Ve=async(i,r)=>{let o;r==null?o=+(await u(["toggle_auto_damage"])).toggle_auto_damage||0:o=r;let e={},n=`Damage vs S/M [[ (@{repeating_weapon_${i}_weapon_damagesmallmedium}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,a=` vs LG [[ (@{repeating_weapon_${i}_weapon_damagelarge}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,t=`Damage vs S/M [[ (@{repeating_weapon_${i}_weapon_damagesmallmedium}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,s=` vs LG [[ (@{repeating_weapon_${i}_weapon_damagelarge}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,c=`Damage vs S/M [[ (@{repeating_weapon_${i}_weapon_critdamagesmallmedium}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,m=` vs LG [[ (@{repeating_weapon_${i}_weapon_critdamagelarge}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,h=`Damage vs S/M [[ (@{repeating_weapon_${i}_weapon_critdamagesmallmedium}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`,l=` vs LG [[ (@{repeating_weapon_${i}_weapon_critdamagelarge}) * @{repeating_weapon_${i}_weapon_backstab_mult}[MULT] + ( @{repeating_weapon_${i}_weapon_attackdmgbonus}[DMG_BON] ) + ( @{repeating_weapon_${i}_weapon_magicbonus}[MAG_BON] ) + ( ?{Damage Modifier?|0}[MISC_MOD] ) ]]`;return o===0?(e[`repeating_weapon_${i}_weapon_damagesmallmedium_chat_menu`]=`[Roll Damage](~@{character_id}|repeating_weapon_${i}_weapon_damagesmallmedium_roll)`,e[`repeating_weapon_${i}_weapon_damagelarge_chat_menu`]=`[Roll Damage vs LG](~@{character_id}|repeating_weapon_${i}_weapon_damagelarge_roll)`,e[`repeating_weapon_${i}_weapon_damagesmallmedium_npc_chat_menu`]=`[Damage](~@{character_id}|repeating_weapon_${i}_weapon_damagesmallmedium_npc_roll)`,e[`repeating_weapon_${i}_weapon_damagelarge_npc_chat_menu`]=`[Damage vs LG](~@{character_id}|repeating_weapon_${i}_weapon_damagelarge_npc_roll)`,e[`repeating_weapon_${i}_weapon_critdamagesmallmedium_chat_menu`]=`[Roll Damage](~@{character_id}|repeating_weapon_${i}_weapon_critdamagesmallmedium_roll)`,e[`repeating_weapon_${i}_weapon_critdamagelarge_chat_menu`]=`[Roll Damage vs LG](~@{character_id}|repeating_weapon_${i}_weapon_critdamagelarge_roll)`,e[`repeating_weapon_${i}_weapon_critdamagesmallmedium_npc_chat_menu`]=`[Damage](~@{character_id}|repeating_weapon_${i}_weapon_critdamagesmallmedium_npc_roll)`,e[`repeating_weapon_${i}_weapon_critdamagelarge_npc_chat_menu`]=`[Damage vs LG](~@{character_id}|repeating_weapon_${i}_weapon_critdamagelarge_npc_roll)`):(e[`repeating_weapon_${i}_weapon_damagesmallmedium_chat_menu`]=n,e[`repeating_weapon_${i}_weapon_damagelarge_chat_menu`]=a,e[`repeating_weapon_${i}_weapon_damagesmallmedium_npc_chat_menu`]=t,e[`repeating_weapon_${i}_weapon_damagelarge_npc_chat_menu`]=s,e[`repeating_weapon_${i}_weapon_critdamagesmallmedium_chat_menu`]=c,e[`repeating_weapon_${i}_weapon_critdamagelarge_chat_menu`]=m,e[`repeating_weapon_${i}_weapon_critdamagesmallmedium_npc_chat_menu`]=h,e[`repeating_weapon_${i}_weapon_critdamagelarge_npc_chat_menu`]=l),e};on("change:repeating_weapon:weapon_name change:repeating_weapon:weapon_damagesmallmedium change:repeating_weapon:weapon_damagelarge change:repeating_weapon:weapon_critdamagesmallmedium change:repeating_weapon:weapon_critdamagelarge change:repeating_weapon:weapon_attackdmgbonus change:repeating_weapon:weapon_critdamage_flag",async i=>{let r=i.sourceAttribute.split("_")[2],o=await Ve(r);await g(o,{silent:!0})});on("change:toggle_critdamage change:toggle_auto_damage",async i=>{let r=await f("weapon"),o=r.map(c=>`repeating_weapon_${c}_weapon_critdamage_flag`),e=await u(["toggle_auto_damage",...o]),n={},a=+e.toggle_auto_damage||0,t=r.map(async c=>{let m=`repeating_weapon_${c}_weapon_critdamage_flag`,h=+e[m]||0;return n[m]=1-h,await Ve(c,a)});(await Promise.all(t)).forEach(c=>{Object.assign(n,c)}),await g(n,{silent:!0})});var xa=["weapon_use","weapon_attack_type","weapon_attack_type_flag","weapon_critdamage_flag","weapon_prof_pen","weapon_whisper_to_hit_select","weapon_dual_pen","weapon_backstab_var","weapon_tohitbonus","weapon_magicbonus","weapon_prof","weapon_backstab","weapon_backstab_bonus","weapon_backstab_mult","weapon_attackdmgbonus","weapon_num_attacks","weapon_quantity","weapon_ammo","weapon_ammo_max","weapon_weight","weapon_cost","weapon_range_short","weapon_range_medium","weapon_range_long","weapon_thac_adj0","weapon_thac_adj1","weapon_thac_adj2","weapon_thac_adj3","weapon_thac_adj4","weapon_thac_adj5","weapon_thac_adj6","weapon_thac_adj7","weapon_thac_adj8","weapon_thac_adj9","weapon_thac_adj10"],jr=["weapon_range_error","weapon_dual","weapon_tohitacadj","weapon_whisper_to_hit","weapon_length","weapon_space","weapon_speed","weapon_misc","weapon_macro_text","weapon_damagesmallmedium_chat_menu","weapon_damagelarge_chat_menu","weapon_damagesmallmedium_npc_chat_menu","weapon_damagelarge_npc_chat_menu","weapon_critdamagesmallmedium_chat_menu","weapon_critdamagelarge_chat_menu","weapon_critdamagesmallmedium_npc_chat_menu","weapon_critdamagelarge_npc_chat_menu","weapon_damage_chat_menu_npc"],ua=[...xa,...jr],Ma=["equipment_type","equipment_magical","equipment_show_type","equipment_current","equipment_current_max","equipment_carried_select","equipment_carried","equipment_quantity","equipment_quantity_max","equipment_weight","equipment_cost","equipment_armor_type","equipment_armor_worn","equipment_armor_ac","equipment_armor_base","equipment_armor_magic","equipment_armor_mod","equipment_armor_bulk","equipment_sync_armor_flag","equipment_weapon_type"],Ur=["equipment_macro_text","equipment_weapon_speed","equipment_weapon_misc","equipment_weapon_length","equipment_weapon_space","equipment_weapon_damagesmallmedium","equipment_weapon_damagelarge","equipment_weapon_attackdmgtype","equipment_weapon_rateoffire","equipment_weapon_range"],wa=[...Ma,...Ur],Sa=["nwp_slots","nwp_modifier"],Vr=["nwp_attribute","nwp_attribute_value","nwp_macro_text"],da=[...Sa,...Vr],Ia=async i=>{let r=ua.map(n=>re("weapon",i,n)),o=await u(r),e=ua.reduce((n,a)=>{let t=re("weapon",i,a);return rawValue=o[t],xa.includes(a)?n[t]=+rawValue||0:n[t]=rawValue||"",n},{});await g(e,{silent:!0})},Wr=async i=>{let r=["equipment_tabs_type","equipment_tabs_carry"],o=wa.map(m=>re("equipment",i,m)),e=[...r,...o],n=await u(e),a=+n.equipment_tabs_type||0,t=`repeating_equipment_${i}_equipment_type`,s=+n[t]||0,c=wa.reduce((m,h)=>{let l=re("equipment",i,h),p=n[l];return Ma.includes(h)?h==="equipment_type"?m[l]=a!==-1?a:s:h==="equipment_magical"?m[l]=s===3||a===3?1:+p||0:m[l]=+p||0:m[l]=p||"",m},{});await g(c,{silent:!0})},Hr=async i=>{let r=da.map(n=>re("nonweaponproficiencies",i,n)),o=await u(r),e=da.reduce((n,a)=>{let t=re("nonweaponproficiencies",i,a),s=o[t];return Sa.includes(a)?n[t]=+s||0:n[t]=s||"",n},{});await g(e,{silent:!0})};on("change:repeating_weapon:weapon_name change:repeating_equipment:equipment_item change:repeating_nonweaponproficiencies:nwp_name",async i=>{if(i.sourceType!=="player"||i.previousValue!==void 0)return;let r=i.sourceAttribute.split("_")[2];i.sourceAttribute.includes("equipment_item")&&await Wr(r),i.sourceAttribute.includes("weapon_name")&&await Ia(r),i.sourceAttribute.includes("nwp_name")&&await Hr(r)});on("sheet:opened",async i=>{let r={},o=await f("weapon"),e=await f("ability"),n=await f("nonweaponproficiencies"),a=await f("equipment"),t=await f("spells");if(o.length===0){let s=k();r[`repeating_weapon_${s}_weapon_value`]=1}if(e.length===0){let s=k();r[`repeating_ability_${s}_ability_value`]=1}if(n.length===0){let s=k();r[`repeating_nonweaponproficiencies_${s}_nwp_value`]=1}if(a.length===0){let s=k();r[`repeating_equipment_${s}_equipment_value`]=1}if(t.length===0){let s=k();r[`repeating_spells_${s}_spell_value`]=1}await g(r,{silent:!0})});on("clicked:resetallmacros clicked:resetequipmentmacros clicked:resetweaponsmacros clicked:resetabilitiesmacros clicked:resetnwpsmacros clicked:resetspellsmacros",async i=>{let o=i.triggerName.match(/clicked:(\w+)/),e=o?o[1]:null,n={};if(e==="resetallmacros"){n.surprise_macro_text="",n.surprise_others_macro_text="",n.init_macro_text="";let a=await f("equipment");_.each(a,h=>{n[`repeating_equipment_${h}_equipment_macro_text`]=""});let t=await f("weapon");_.each(t,h=>{n[`repeating_weapon_${h}_weapon_macro_text`]=""});let s=await f("ability");_.each(s,h=>{n[`repeating_ability_${h}_ability_macro_text`]=""});let c=await f("nonweaponproficiencies");_.each(c,h=>{n[`repeating_nonweaponproficiencies_${h}_nwp_macro_text`]=""});let m=await f("spells");_.each(m,h=>{n[`repeating_spells_${h}_spell_macro_text`]=""})}if(e==="resetequipmentmacros"){let a=await f("equipment");_.each(a,t=>{n[`repeating_equipment_${t}_equipment_macro_text`]=""})}if(e==="resetweaponsmacros"){let a=await f("weapon");_.each(a,t=>{n[`repeating_weapon_${t}_weapon_macro_text`]=""})}if(e==="resetabilitiesmacros"){let a=await f("ability");_.each(a,t=>{n[`repeating_ability_${t}_ability_macro_text`]=""})}if(e==="resetnwpsmacros"){let a=await f("nonweaponproficiencies");_.each(a,t=>{n[`repeating_nonweaponproficiencies_${t}_nwp_macro_text`]=""})}if(e==="resetspellsmacros"){let a=await f("spells");_.each(a,t=>{n[`repeating_spells_${t}_spell_macro_text`]=""})}g(n,{silent:!0})});var Na=async i=>{let r=await u(["pickpockets","pickpockets_base","pickpockets_racial_mod","pickpockets_ability_mod","pickpockets_magic"]),o={},e=+r.pickpockets_base||0,n=+r.pickpockets_racial_mod||0,a=+r.pickpockets_ability_mod||0,t=+r.pickpockets_magic||0,s=+r.pickpockets||0,c=Math.max(0,q(e+n+a+t));i===1&&s>=0&&c===0?o.pickpockets_base=s:o.pickpockets=c,g(o,{silent:!0})},Da=async i=>{let r=await u(["openlocks","openlocks_base","openlocks_racial_mod","openlocks_ability_mod","openlocks_magic"]),o={},e=+r.openlocks_base||0,n=+r.openlocks_racial_mod||0,a=+r.openlocks_ability_mod||0,t=+r.openlocks_magic||0,s=+r.openlocks||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.openlocks_base=s:o.openlocks=c,g(o,{silent:!0})},Ca=async i=>{let r=await u(["findtraps","findtraps_base","findtraps_racial_mod","findtraps_ability_mod","findtraps_magic"]),o={},e=+r.findtraps_base||0,n=+r.findtraps_racial_mod||0,a=+r.findtraps_ability_mod||0,t=+r.findtraps_magic||0,s=+r.findtraps||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.findtraps_base=s:o.findtraps=c,g(o,{silent:!0})},Oa=async i=>{let r=await u(["movequietly","movequietly_base","movequietly_racial_mod","movequietly_ability_mod","movequietly_magic"]),o={},e=+r.movequietly_base||0,n=+r.movequietly_racial_mod||0,a=+r.movequietly_ability_mod||0,t=+r.movequietly_magic||0,s=+r.movequietly||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.movequietly_base=s:o.movequietly=c,g(o,{silent:!0})},Ta=async i=>{let r=await u(["hideinshadows","hideinshadows_base","hideinshadows_racial_mod","hideinshadows_ability_mod","hideinshadows_magic"]),o={},e=+r.hideinshadows_base||0,n=+r.hideinshadows_racial_mod||0,a=+r.hideinshadows_ability_mod||0,t=+r.hideinshadows_magic||0,s=+r.hideinshadows||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.hideinshadows_base=s:o.hideinshadows=c,g(o,{silent:!0})},Ea=async i=>{let r=await u(["hearnoise","hearnoise_base","hearnoise_racial_mod","hearnoise_ability_mod","hearnoise_magic"]),o={},e=+r.hearnoise_base||0,n=+r.hearnoise_racial_mod||0,a=+r.hearnoise_ability_mod||0,t=+r.hearnoise_magic||0,s=+r.hearnoise||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.hearnoise_base=s:o.hearnoise=c,g(o,{silent:!0})},La=async i=>{let r=await u(["climbwalls","climbwalls_base","climbwalls_racial_mod","climbwalls_ability_mod","climbwalls_magic"]),o={},e=+r.climbwalls_base||0;e=e>=99.1?e.toFixed(1):Math.floor(e);let n=+r.climbwalls_racial_mod||0,a=+r.climbwalls_ability_mod||0,t=+r.climbwalls_magic||0,s=+r.climbwalls||0,c=Math.max(0,Math.min(100,e+q(n+a+t))),m="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Climb Walls}} {{roll_low=[[ 1d100 ]]%}} {{roll_target=[[ @{climbwalls} ]]%}}",h="@{whisper_pc} &{template:general} {{color=@{color_option}}} {{name=@{character_name}}} {{subtag=Climb Walls}} {{roll_low=[[ 1d100 + [[1d10/10]] ]]%}} {{roll_target=[[ @{climbwalls} ]]%}}";i===1?s>=0&&c===0?o.climbwalls_base=s:o.climbwalls=c:(o.climbwalls=c,o.climbwalls_macro_text=c>=99.1?h:m),g(o,{silent:!0})},Ra=async i=>{let r=await u(["readlanguages","readlanguages_base","readlanguages_racial_mod","readlanguages_ability_mod","readlanguages_magic"]),o={},e=+r.readlanguages_base||0,n=+r.readlanguages_racial_mod||0,a=+r.readlanguages_ability_mod||0,t=+r.readlanguages_magic||0,s=+r.readlanguages||0,c=Math.max(0,Math.min(100,q(e+n+a+t)));i===1&&s>=0&&c===0?o.readlanguages_base=s:o.readlanguages=c,g(o,{silent:!0})},Pa=async()=>{let i=await u(["thiefmisc","thiefmisc_base","thiefmisc_racial_mod","thiefmisc_ability_mod","thiefmisc_magic"]),r={},o=+i.thiefmisc_base||0,e=+i.thiefmisc_racial_mod||0,n=+i.thiefmisc_ability_mod||0,a=+i.thiefmisc_magic||0,t=Math.max(0,Math.min(100,q(o+e+n+a)));r.thiefmisc=t,g(r,{silent:!0})},Ba=async()=>{let i=await u(["thiefmisc1","thiefmisc1_base","thiefmisc1_racial_mod","thiefmisc1_ability_mod","thiefmisc1_magic"]),r={},o=+i.thiefmisc1_base||0,e=+i.thiefmisc1_racial_mod||0,n=+i.thiefmisc1_ability_mod||0,a=+i.thiefmisc1_magic||0,t=Math.max(0,Math.min(100,q(o+e+n+a)));r.thiefmisc1=t,g(r,{silent:!0})},ja=async()=>{let i=await u(["thiefmisc2","thiefmisc2_base","thiefmisc2_racial_mod","thiefmisc2_ability_mod","thiefmisc2_magic"]),r={},o=+i.thiefmisc2_base||0,e=+i.thiefmisc2_racial_mod||0,n=+i.thiefmisc2_ability_mod||0,a=+i.thiefmisc2_magic||0,t=Math.max(0,Math.min(100,q(o+e+n+a)));r.thiefmisc2=t,g(r,{silent:!0})};on("change:pickpockets_base change:pickpockets_racial_mod change:pickpockets_ability_mod change:pickpockets_magic",i=>{Na()});on("change:openlocks_base change:openlocks_racial_mod change:openlocks_ability_mod change:openlocks_magic",i=>{Da()});on("change:findtraps_base change:findtraps_racial_mod change:findtraps_ability_mod change:findtraps_magic",i=>{Ca()});on("change:movequietly_base change:movequietly_racial_mod change:movequietly_ability_mod change:movequietly_magic",i=>{Oa()});on("change:hideinshadows_base change:hideinshadows_racial_mod change:hideinshadows_ability_mod change:hideinshadows_magic",i=>{Ta()});on("change:hearnoise_base change:hearnoise_racial_mod change:hearnoise_ability_mod change:hearnoise_magic",i=>{Ea()});on("change:climbwalls_base change:climbwalls_racial_mod change:climbwalls_ability_mod change:climbwalls_magic",i=>{La()});on("change:readlanguages_base change:readlanguages_racial_mod change:readlanguages_ability_mod change:readlanguages_magic",i=>{Ra()});on("change:thiefmisc_base change:thiefmisc_racial_mod change:thiefmisc_ability_mod change:thiefmisc_magic",i=>{Pa()});on("change:thiefmisc1_base change:thiefmisc1_racial_mod change:thiefmisc1_ability_mod change:thiefmisc1_magic",i=>{Ba()});on("change:thiefmisc2_base change:thiefmisc2_racial_mod change:thiefmisc2_ability_mod change:thiefmisc2_magic",i=>{ja()});on("change:thief_level change:autofill_thief change:sync_thief_class change:thief_class_selected change:class change:secondclass change:thirdclass change:level change:level_2 change:level_3",async i=>{let r=await u(["thief_level","autofill_thief","sync_thief_class","thief_class_selected","class","secondclass","thirdclass","level","level_2","level_3"]);if(!(+r.autofill_thief||0))return;let e={},n=["pickpockets_base","openlocks_base","findtraps_base","movequietly_base","hideinshadows_base","hearnoise_base","climbwalls_base","readlanguages_base"],a={0:[0,0,0,0,0,0,0,0],1:[30,25,20,15,10,10,85,0],2:[35,29,25,21,15,10,86,0],3:[40,33,30,27,20,15,87,0],4:[45,37,35,33,25,15,88,20],5:[50,42,40,40,31,20,90,25],6:[55,47,45,47,37,20,92,30],7:[60,52,50,55,43,25,94,35],8:[65,57,55,62,49,25,96,40],9:[70,62,60,70,56,30,98,45],10:[80,67,65,78,63,30,99,50],11:[90,72,70,86,70,35,99.1,55],12:[100,77,75,94,77,35,99.2,60],13:[105,82,80,99,85,40,99.3,65],14:[110,87,85,99,93,40,99.4,70],15:[115,92,90,99,99,50,99.5,75],16:[125,97,95,99,99,50,99.6,80],17:[125,99,99,99,99,55,99.7,80]},t=+r.sync_thief_class||0,s=+r.thief_class_selected||0,c=+r.thief_level||0;if(t===1&&s>=1&&s<=3){let l=[r.class,r.secondclass,r.thirdclass],p=[r.level,r.level_2,r.level_3],w=s-1,$=(l[w]||"").trim(),D=+p[w]||0,O=qe($);c=D,e.thief_level=O===4?c:0}let m=Math.min(Math.max(c,0),17),h=a[m];n.forEach((l,p)=>{e[l]=h[p]}),await g(e,{silent:!0})});var Ua=async i=>{let r=await u(["saveparalysispoisondeath","saveparalysispoisondeath_base","saveparalysispoisondeath_racial_mod","saveparalysispoisondeath_ability_mod","saveparalysispoisondeath_misc_mod","saveparalysispoisondeath_temp_mod"]),o={},e=+r.saveparalysispoisondeath_base||0,n=+r.saveparalysispoisondeath_racial_mod||0,a=+r.saveparalysispoisondeath_ability_mod||0,t=+r.saveparalysispoisondeath_misc_mod||0,s=+r.saveparalysispoisondeath_temp_mod||0,c=+r.saveparalysispoisondeath||0,m=q(e+n+a+t+s);i===1&&c<=20&&m===20?o.saveparalysispoisondeath_base=c:o.saveparalysispoisondeath=m,await g(o,{silent:!0})},Va=async i=>{let r=await u(["savepetrificationpolymorph","savepetrificationpolymorph_base","savepetrificationpolymorph_racial_mod","savepetrificationpolymorph_ability_mod","savepetrificationpolymorph_misc_mod","savepetrificationpolymorph_temp_mod"]),o={},e=+r.savepetrificationpolymorph_base||0,n=+r.savepetrificationpolymorph_racial_mod||0,a=+r.savepetrificationpolymorph_ability_mod||0,t=+r.savepetrificationpolymorph_misc_mod||0,s=+r.savepetrificationpolymorph_temp_mod||0,c=+r.savepetrificationpolymorph||0,m=q(e+n+a+t+s);i===1&&c<=20&&m===20?o.savepetrificationpolymorph_base=c:o.savepetrificationpolymorph=m,await g(o,{silent:!0})},Wa=async i=>{let r=await u(["saverodsstaveswands","saverodsstaveswands_base","saverodsstaveswands_racial_mod","saverodsstaveswands_ability_mod","saverodsstaveswands_misc_mod","saverodsstaveswands_temp_mod"]),o={},e=+r.saverodsstaveswands_base||0,n=+r.saverodsstaveswands_racial_mod||0,a=+r.saverodsstaveswands_ability_mod||0,t=+r.saverodsstaveswands_misc_mod||0,s=+r.saverodsstaveswands_temp_mod||0,c=+r.saverodsstaveswands||0,m=q(e+n+a+t+s);i===1&&c<=20&&m===20?o.saverodsstaveswands_base=c:o.saverodsstaveswands=m,await g(o,{silent:!0})},Ha=async i=>{let r=await u(["savebreathweapons","savebreathweapons_base","savebreathweapons_racial_mod","savebreathweapons_ability_mod","savebreathweapons_misc_mod","savebreathweapons_temp_mod"]),o={},e=+r.savebreathweapons_base||0,n=+r.savebreathweapons_racial_mod||0,a=+r.savebreathweapons_ability_mod||0,t=+r.savebreathweapons_misc_mod||0,s=+r.savebreathweapons_temp_mod||0,c=+r.savebreathweapons||0,m=q(e+n+a+t+s);i===1&&c<=20&&m===20?o.savebreathweapons_base=c:o.savebreathweapons=m,await g(o,{silent:!0})},Fa=async i=>{let r=await u(["savespells","savespells_base","savespells_racial_mod","savespells_ability_mod","savespells_misc_mod","savespells_temp_mod"]),o={},e=+r.savespells_base||0,n=+r.savespells_racial_mod||0,a=+r.savespells_ability_mod||0,t=+r.savespells_misc_mod||0,s=+r.savespells_temp_mod||0,c=+r.savespells||0,m=q(e+n+a+t+s);i===1&&c<=20&&m===20?o.savespells_base=c:o.savespells=m,await g(o,{silent:!0})},Fr=async()=>{let i=await u(["savemisc","savemisc_base","savemisc_racial_mod","savemisc_ability_mod","savemisc_misc_mod","savemisc_temp_mod"]),r={},o=+i.savemisc_base||0,e=+i.savemisc_racial_mod||0,n=+i.savemisc_ability_mod||0,a=+i.savemisc_misc_mod||0,t=+i.savemisc_temp_mod||0,s=q(o+e+n+a+t);r.savemisc=s,await g(r,{silent:!0})},Gr=async()=>{let i=await u(["savemisc1","savemisc1_base","savemisc1_racial_mod","savemisc1_ability_mod","savemisc1_misc_mod","savemisc1_temp_mod"]),r={},o=+i.savemisc1_base||0,e=+i.savemisc1_racial_mod||0,n=+i.savemisc1_ability_mod||0,a=+i.savemisc1_misc_mod||0,t=+i.savemisc1_temp_mod||0,s=q(o+e+n+a+t);r.savemisc1=s,await g(r,{silent:!0})},zr=async()=>{let i=await u(["savemisc2","savemisc2_base","savemisc2_racial_mod","savemisc2_ability_mod","savemisc2_misc_mod","savemisc2_temp_mod"]),r={},o=+i.savemisc2_base||0,e=+i.savemisc2_racial_mod||0,n=+i.savemisc2_ability_mod||0,a=+i.savemisc2_misc_mod||0,t=+i.savemisc2_temp_mod||0,s=q(o+e+n+a+t);r.savemisc2=s,await g(r,{silent:!0})};on("change:saveparalysispoisondeath_base change:saveparalysispoisondeath_racial_mod change:saveparalysispoisondeath_ability_mod change:saveparalysispoisondeath_misc_mod change:saveparalysispoisondeath_temp_mod",i=>{Ua()});on("change:savepetrificationpolymorph_base change:savepetrificationpolymorph_racial_mod change:savepetrificationpolymorph_ability_mod change:savepetrificationpolymorph_misc_mod change:savepetrificationpolymorph_temp_mod",i=>{Va()});on("change:saverodsstaveswands_base change:saverodsstaveswands_racial_mod change:saverodsstaveswands_ability_mod change:saverodsstaveswands_misc_mod change:saverodsstaveswands_temp_mod",i=>{Wa()});on("change:savebreathweapons_base change:savebreathweapons_racial_mod change:savebreathweapons_ability_mod change:savebreathweapons_misc_mod change:savebreathweapons_temp_mod",i=>{Ha()});on("change:savespells_base change:savespells_racial_mod change:savespells_ability_mod change:savespells_misc_mod change:savespells_temp_mod",i=>{Fa()});on("change:savemisc_base change:savemisc_racial_mod change:savemisc_ability_mod change:savemisc_misc_mod change:savemisc_temp_mod",i=>{Fr()});on("change:savemisc1_base change:savemisc1_racial_mod change:savemisc1_ability_mod change:savemisc1_misc_mod change:savemisc1_temp_mod",i=>{Gr()});on("change:savemisc2_base change:savemisc2_racial_mod change:savemisc2_ability_mod change:savemisc2_misc_mod change:savemisc2_temp_mod",i=>{zr()});on("change:saves_class change:saves_level change:autofill_saves",async i=>{let r=await u(["saves_class","saves_level","autofill_saves"]);if(!(+r.autofill_saves||0))return;let e=+r.saves_class||0;if(!e)return;let n=["saveparalysispoisondeath_base","savepetrificationpolymorph_base","saverodsstaveswands_base","savebreathweapons_base","savespells_base"],a={assassin:[{lvl:5,s:[13,12,14,16,15]},{lvl:9,s:[12,11,12,15,13]},{lvl:13,s:[11,10,10,14,11]},{lvl:16,s:[10,9,8,13,9]},{lvl:99,s:[10,9,8,13,9]}],cleric:[{lvl:4,s:[10,13,14,16,15]},{lvl:7,s:[9,12,13,15,14]},{lvl:10,s:[7,10,11,13,12]},{lvl:13,s:[6,9,10,12,11]},{lvl:16,s:[5,8,9,11,10]},{lvl:19,s:[4,7,8,10,9]},{lvl:99,s:[2,5,6,8,7]}],druid:[{lvl:4,s:[10,13,14,16,15]},{lvl:7,s:[9,12,13,15,14]},{lvl:10,s:[7,10,11,13,12]},{lvl:13,s:[6,9,10,12,11]},{lvl:15,s:[5,8,9,11,10]},{lvl:99,s:[5,8,9,11,10]}],fighter:[{lvl:1,s:[16,17,18,20,19]},{lvl:3,s:[14,15,16,17,17]},{lvl:5,s:[13,14,15,16,16]},{lvl:7,s:[11,12,13,13,14]},{lvl:9,s:[10,11,12,12,13]},{lvl:11,s:[8,9,10,9,11]},{lvl:13,s:[7,8,9,8,10]},{lvl:15,s:[5,6,7,5,8]},{lvl:17,s:[4,5,6,4,7]},{lvl:99,s:[3,4,5,4,6]}],magicuser:[{lvl:6,s:[14,13,11,15,12]},{lvl:11,s:[13,11,9,13,10]},{lvl:16,s:[11,9,7,11,8]},{lvl:21,s:[10,7,5,9,6]},{lvl:99,s:[8,5,3,7,4]}],thief:[{lvl:5,s:[13,12,14,16,15]},{lvl:9,s:[12,11,12,15,13]},{lvl:13,s:[11,10,10,14,11]},{lvl:17,s:[10,9,8,13,9]},{lvl:21,s:[9,8,6,12,7]},{lvl:99,s:[8,7,4,11,5]}]},s={1:a.cleric,2:a.druid,3:a.fighter,4:a.magicuser,5:a.thief,6:a.thief,7:a.assassin,8:a.fighter}[e];if(!s)return;let c=+r.saves_level||0,m=s.find(l=>c<l.lvl)||s[s.length-1],h={};n.forEach((l,p)=>{h[l]=m.s[p]}),await g(h)});on("change:matrix_class",async i=>{let r=await u(["matrix_class"]),o={},e=+r.matrix_class||0;o.toggle_matrixhd=e===5?1:0,await g(o,{silent:!0})});var qe=async i=>{let r=i.trim().toLowerCase();return/cleric|druid|monk/.test(r)?1:/fighter|paladin|ranger|bard|cavalier|barbarian/.test(r)?2:/magic-user|illusionist|magic|mage|wizard/.test(r)?3:/thief|assassin|rogue|thief-acrobat|acrobat/.test(r)?4:99},Ga=async()=>{let i=await u(["thac00","autofill_matrix"]);if(!(+i.autofill_matrix||0))return;let o={},e=+i.thac00||0;o["thac0-10"]=e+10,o["thac0-9"]=e+9,o["thac0-8"]=e+8,o["thac0-7"]=e+7,o["thac0-6"]=e+6,o["thac0-5"]=e+5,o["thac0-4"]=e+4,o["thac0-3"]=e+3,o["thac0-2"]=e+2,o["thac0-1"]=e+1,o.thac01=e-1,o.thac02=e-2,o.thac03=e-3,o.thac04=e-4,o.thac05=e-5,o.thac06=e-6,o.thac07=e-7,o.thac08=e-8,o.thac09=e-9,o.thac010=e-10,await g(o,{silent:!0})};on("change:matrix_class change:matrix_level change:matrix_hitdice change:autofill_matrix change:sync_matrix_class change:toggle_fighter5 change:class_selected change:class change:secondclass change:thirdclass change:level change:level_2 change:level_3",async i=>{let r=await u(["matrix_class","matrix_level","matrix_hitdice","autofill_matrix","toggle_fighter5","sync_matrix_class","class_selected","class","secondclass","thirdclass","level","level_2","level_3"]);if(!(+r.autofill_matrix||0))return;let e={},n=+r.sync_matrix_class||0,a=+r.class_selected||0,t=+r.matrix_level||0,s=+r.matrix_class||0,c=(r.class||"").trim(),m=(r.secondclass||"").trim(),h=(r.thirdclass||"").trim(),l=+r.matrix_hitdice||0,p=+r.toggle_fighter5||0;n===1&&(a===1&&(s=await qe(c),t=+r.level||0,e.matrix_level=t,e.matrix_class=s),a===2&&(s=await qe(m),t=+r.level_2||0,e.matrix_level=t,e.matrix_class=s),a===3&&(s=await qe(h),t=+r.level_3||0,e.matrix_level=t,e.matrix_class=s)),s!==0&&(s===1&&(t===0||(t<4?(e["thac-10"]=25,e["thac-9"]=24,e["thac-8"]=23,e["thac-7"]=22,e["thac-6"]=21,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=19,e.thac2=18,e.thac3=17,e.thac4=16,e.thac5=15,e.thac6=14,e.thac7=13,e.thac8=12,e.thac9=11,e.thac10=10):t<7?(e["thac-10"]=23,e["thac-9"]=22,e["thac-8"]=21,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=19,e.thac00=18,e.thac0=18,e.thac1=17,e.thac2=16,e.thac3=15,e.thac4=14,e.thac5=13,e.thac6=12,e.thac7=11,e.thac8=10,e.thac9=9,e.thac10=8):t<10?(e["thac-10"]=21,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=19,e["thac-2"]=18,e["thac-1"]=17,e.thac00=16,e.thac0=16,e.thac1=15,e.thac2=14,e.thac3=13,e.thac4=12,e.thac5=11,e.thac6=10,e.thac7=9,e.thac8=8,e.thac9=7,e.thac10=6):t<13?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=19,e["thac-4"]=18,e["thac-3"]=17,e["thac-2"]=16,e["thac-1"]=15,e.thac00=14,e.thac0=14,e.thac1=13,e.thac2=12,e.thac3=11,e.thac4=10,e.thac5=9,e.thac6=8,e.thac7=7,e.thac8=6,e.thac9=5,e.thac10=4):t<16?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=19,e["thac-6"]=18,e["thac-5"]=17,e["thac-4"]=16,e["thac-3"]=15,e["thac-2"]=14,e["thac-1"]=13,e.thac00=12,e.thac0=12,e.thac1=11,e.thac2=10,e.thac3=9,e.thac4=8,e.thac5=7,e.thac6=6,e.thac7=5,e.thac8=4,e.thac9=3,e.thac10=2):t<19?(e["thac-10"]=20,e["thac-9"]=19,e["thac-8"]=18,e["thac-7"]=17,e["thac-6"]=16,e["thac-5"]=15,e["thac-4"]=14,e["thac-3"]=13,e["thac-2"]=12,e["thac-1"]=11,e.thac00=10,e.thac0=10,e.thac1=9,e.thac2=8,e.thac3=7,e.thac4=6,e.thac5=5,e.thac6=4,e.thac7=3,e.thac8=2,e.thac9=1,e.thac10=0):t>=19&&(e["thac-10"]=19,e["thac-9"]=18,e["thac-8"]=17,e["thac-7"]=16,e["thac-6"]=15,e["thac-5"]=14,e["thac-4"]=13,e["thac-3"]=12,e["thac-2"]=11,e["thac-1"]=10,e.thac00=9,e.thac0=9,e.thac1=8,e.thac2=7,e.thac3=6,e.thac4=5,e.thac5=4,e.thac6=3,e.thac7=2,e.thac8=1,e.thac9=0,e.thac10=-1)),e.attack_matrix_flag=0),(s===2||s===6)&&(t===0?(e["thac-10"]=26,e["thac-9"]=25,e["thac-8"]=24,e["thac-7"]=23,e["thac-6"]=22,e["thac-5"]=21,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=20,e.thac2=19,e.thac3=18,e.thac4=17,e.thac5=16,e.thac6=15,e.thac7=14,e.thac8=13,e.thac9=12,e.thac10=11):t<3?(e["thac-10"]=25-p,e["thac-9"]=24-p,e["thac-8"]=23-p,e["thac-7"]=22-p,e["thac-6"]=21-p,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20-p,e.thac0=20-p,e.thac1=19-p,e.thac2=18-p,e.thac3=17-p,e.thac4=16-p,e.thac5=15-p,e.thac6=14-p,e.thac7=13-p,e.thac8=12-p,e.thac9=11-p,e.thac10=10-p):t<5?(e["thac-10"]=23-p,e["thac-9"]=22-p,e["thac-8"]=21-p,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20-p,e["thac-1"]=19-p,e.thac00=18-p,e.thac0=18-p,e.thac1=17-p,e.thac2=16-p,e.thac3=15-p,e.thac4=14-p,e.thac5=13-p,e.thac6=12-p,e.thac7=11-p,e.thac8=10-p,e.thac9=9-p,e.thac10=8-p):t<7?(e["thac-10"]=21-p,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20-p,e["thac-3"]=19-p,e["thac-2"]=18-p,e["thac-1"]=17-p,e.thac00=16-p,e.thac0=16-p,e.thac1=15-p,e.thac2=14-p,e.thac3=13-p,e.thac4=12-p,e.thac5=11-p,e.thac6=10-p,e.thac7=9-p,e.thac8=8-p,e.thac9=7-p,e.thac10=6-p):t<9?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20-p,e["thac-5"]=19-p,e["thac-4"]=18-p,e["thac-3"]=17-p,e["thac-2"]=16-p,e["thac-1"]=15-p,e.thac00=14-p,e.thac0=14-p,e.thac1=13-p,e.thac2=12-p,e.thac3=11-p,e.thac4=10-p,e.thac5=9-p,e.thac6=8-p,e.thac7=7-p,e.thac8=6-p,e.thac9=5-p,e.thac10=4-p):t<11?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20-p,e["thac-7"]=19-p,e["thac-6"]=18-p,e["thac-5"]=17-p,e["thac-4"]=16-p,e["thac-3"]=15-p,e["thac-2"]=14-p,e["thac-1"]=13-p,e.thac00=12-p,e.thac0=12-p,e.thac1=11-p,e.thac2=10-p,e.thac3=9-p,e.thac4=8-p,e.thac5=7-p,e.thac6=6-p,e.thac7=5-p,e.thac8=4-p,e.thac9=3-p,e.thac10=2-p):t<13?(e["thac-10"]=20-p,e["thac-9"]=19-p,e["thac-8"]=18-p,e["thac-7"]=17-p,e["thac-6"]=16-p,e["thac-5"]=15-p,e["thac-4"]=14-p,e["thac-3"]=13-p,e["thac-2"]=12-p,e["thac-1"]=11-p,e.thac00=10-p,e.thac0=10-p,e.thac1=9-p,e.thac2=8-p,e.thac3=7-p,e.thac4=6-p,e.thac5=5-p,e.thac6=4-p,e.thac7=3-p,e.thac8=2-p,e.thac9=1-p,e.thac10=0-p):t<15?(e["thac-10"]=18-p,e["thac-9"]=17-p,e["thac-8"]=16-p,e["thac-7"]=15-p,e["thac-6"]=14-p,e["thac-5"]=13-p,e["thac-4"]=12-p,e["thac-3"]=11-p,e["thac-2"]=10-p,e["thac-1"]=9-p,e.thac00=8-p,e.thac0=8-p,e.thac1=7-p,e.thac2=6-p,e.thac3=5-p,e.thac4=4-p,e.thac5=3-p,e.thac6=2-p,e.thac7=1-p,e.thac8=0-p,e.thac9=-1-p,e.thac10=-2-p):t<17?(e["thac-10"]=16-p,e["thac-9"]=15-p,e["thac-8"]=14-p,e["thac-7"]=13-p,e["thac-6"]=12-p,e["thac-5"]=11-p,e["thac-4"]=10-p,e["thac-3"]=9-p,e["thac-2"]=8-p,e["thac-1"]=7-p,e.thac00=6-p,e.thac0=6-p,e.thac1=5-p,e.thac2=4-p,e.thac3=3-p,e.thac4=2-p,e.thac5=1-p,e.thac6=0-p,e.thac7=-1-p,e.thac8=-2-p,e.thac9=-3-p,e.thac10=-4-p):t>=17&&(e["thac-10"]=14-p,e["thac-9"]=13-p,e["thac-8"]=12-p,e["thac-7"]=11-p,e["thac-6"]=10-p,e["thac-5"]=9-p,e["thac-4"]=8-p,e["thac-3"]=7-p,e["thac-2"]=6-p,e["thac-1"]=5-p,e.thac00=4-p,e.thac0=4-p,e.thac1=3-p,e.thac2=2-p,e.thac3=1-p,e.thac4=0-p,e.thac5=-1-p,e.thac6=-2-p,e.thac7=-3-p,e.thac8=-4-p,e.thac9=-5-p,e.thac10=-6-p),e.attack_matrix_flag=0),s===3&&(t===0||(t<6?(e["thac-10"]=26,e["thac-9"]=25,e["thac-8"]=24,e["thac-7"]=23,e["thac-6"]=22,e["thac-5"]=21,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=20,e.thac2=19,e.thac3=18,e.thac4=17,e.thac5=16,e.thac6=15,e.thac7=14,e.thac8=13,e.thac9=12,e.thac10=11):t<11?(e["thac-10"]=24,e["thac-9"]=23,e["thac-8"]=22,e["thac-7"]=21,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=19,e.thac0=19,e.thac1=18,e.thac2=17,e.thac3=16,e.thac4=15,e.thac5=14,e.thac6=13,e.thac7=12,e.thac8=11,e.thac9=10,e.thac10=9):t<16?(e["thac-10"]=21,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=19,e["thac-2"]=18,e["thac-1"]=17,e.thac00=16,e.thac0=16,e.thac1=15,e.thac2=14,e.thac3=13,e.thac4=12,e.thac5=11,e.thac6=10,e.thac7=9,e.thac8=8,e.thac9=7,e.thac10=6):t<21?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=19,e["thac-5"]=18,e["thac-4"]=17,e["thac-3"]=16,e["thac-2"]=15,e["thac-1"]=14,e.thac00=13,e.thac0=13,e.thac1=12,e.thac2=11,e.thac3=10,e.thac4=9,e.thac5=8,e.thac6=7,e.thac7=6,e.thac8=5,e.thac9=4,e.thac10=3):t>=21&&(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=19,e["thac-7"]=18,e["thac-6"]=17,e["thac-5"]=16,e["thac-4"]=15,e["thac-3"]=14,e["thac-2"]=13,e["thac-1"]=12,e.thac00=11,e.thac0=11,e.thac1=10,e.thac2=9,e.thac3=8,e.thac4=7,e.thac5=6,e.thac6=5,e.thac7=4,e.thac8=3,e.thac9=2,e.thac10=1)),e.attack_matrix_flag=0),s===4&&(t===0||(t<5?(e["thac-10"]=26,e["thac-9"]=25,e["thac-8"]=24,e["thac-7"]=23,e["thac-6"]=22,e["thac-5"]=21,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=20,e.thac2=19,e.thac3=18,e.thac4=17,e.thac5=16,e.thac6=15,e.thac7=14,e.thac8=13,e.thac9=12,e.thac10=11):t<9?(e["thac-10"]=24,e["thac-9"]=23,e["thac-8"]=22,e["thac-7"]=21,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=19,e.thac0=19,e.thac1=18,e.thac2=17,e.thac3=16,e.thac4=15,e.thac5=14,e.thac6=13,e.thac7=12,e.thac8=11,e.thac9=10,e.thac10=9):t<13?(e["thac-10"]=21,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=19,e["thac-2"]=18,e["thac-1"]=17,e.thac00=16,e.thac0=16,e.thac1=15,e.thac2=14,e.thac3=13,e.thac4=12,e.thac5=11,e.thac6=10,e.thac7=9,e.thac8=8,e.thac9=7,e.thac10=6):t<17?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=19,e["thac-4"]=18,e["thac-3"]=17,e["thac-2"]=16,e["thac-1"]=15,e.thac00=14,e.thac0=14,e.thac1=13,e.thac2=12,e.thac3=11,e.thac4=10,e.thac5=9,e.thac6=8,e.thac7=7,e.thac8=6,e.thac9=5,e.thac10=4):t<21?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=19,e["thac-6"]=18,e["thac-5"]=17,e["thac-4"]=16,e["thac-3"]=15,e["thac-2"]=14,e["thac-1"]=13,e.thac00=12,e.thac0=12,e.thac1=11,e.thac2=10,e.thac3=9,e.thac4=8,e.thac5=7,e.thac6=6,e.thac7=5,e.thac8=4,e.thac9=3,e.thac10=2):t>=21&&(e["thac-10"]=20,e["thac-9"]=19,e["thac-8"]=18,e["thac-7"]=17,e["thac-6"]=16,e["thac-5"]=15,e["thac-4"]=14,e["thac-3"]=13,e["thac-2"]=12,e["thac-1"]=11,e.thac00=10,e.thac0=10,e.thac1=9,e.thac2=8,e.thac3=7,e.thac4=6,e.thac5=5,e.thac6=4,e.thac7=3,e.thac8=2,e.thac9=1,e.thac10=0)),e.attack_matrix_flag=0),s===5&&(l===0||(l===1?(e["thac-10"]=26,e["thac-9"]=25,e["thac-8"]=24,e["thac-7"]=23,e["thac-6"]=22,e["thac-5"]=21,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=20,e.thac2=19,e.thac3=18,e.thac4=17,e.thac5=16,e.thac6=15,e.thac7=14,e.thac8=13,e.thac9=12,e.thac10=11):l===2?(e["thac-10"]=25,e["thac-9"]=24,e["thac-8"]=23,e["thac-7"]=22,e["thac-6"]=21,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=19,e.thac2=18,e.thac3=17,e.thac4=16,e.thac5=15,e.thac6=14,e.thac7=13,e.thac8=12,e.thac9=11,e.thac10=10):l===3?(e["thac-10"]=24,e["thac-9"]=23,e["thac-8"]=22,e["thac-7"]=21,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=19,e.thac0=19,e.thac1=18,e.thac2=17,e.thac3=16,e.thac4=15,e.thac5=14,e.thac6=13,e.thac7=12,e.thac8=11,e.thac9=10,e.thac10=9):l===4?(e["thac-10"]=23,e["thac-9"]=22,e["thac-8"]=21,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=19,e.thac00=18,e.thac0=18,e.thac1=17,e.thac2=16,e.thac3=15,e.thac4=14,e.thac5=13,e.thac6=12,e.thac7=11,e.thac8=10,e.thac9=9,e.thac10=8):l===5?(e["thac-10"]=21,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=19,e["thac-2"]=18,e["thac-1"]=17,e.thac00=16,e.thac0=16,e.thac1=15,e.thac2=14,e.thac3=13,e.thac4=12,e.thac5=11,e.thac6=10,e.thac7=9,e.thac8=8,e.thac9=7,e.thac10=6):l===6?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=19,e["thac-3"]=18,e["thac-2"]=17,e["thac-1"]=16,e.thac00=15,e.thac0=15,e.thac1=14,e.thac2=13,e.thac3=12,e.thac4=11,e.thac5=10,e.thac6=9,e.thac7=8,e.thac8=7,e.thac9=6,e.thac10=5):l===7?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=19,e["thac-5"]=18,e["thac-4"]=17,e["thac-3"]=16,e["thac-2"]=15,e["thac-1"]=14,e.thac00=13,e.thac0=13,e.thac1=12,e.thac2=11,e.thac3=10,e.thac4=9,e.thac5=8,e.thac6=7,e.thac7=6,e.thac8=5,e.thac9=4,e.thac10=3):l===8?(e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=19,e["thac-6"]=18,e["thac-5"]=17,e["thac-4"]=16,e["thac-3"]=15,e["thac-2"]=14,e["thac-1"]=13,e.thac00=12,e.thac0=12,e.thac1=11,e.thac2=10,e.thac3=9,e.thac4=8,e.thac5=7,e.thac6=6,e.thac7=5,e.thac8=4,e.thac9=3,e.thac10=2):l===9?(e["thac-10"]=20,e["thac-9"]=19,e["thac-8"]=18,e["thac-7"]=17,e["thac-6"]=16,e["thac-5"]=15,e["thac-4"]=14,e["thac-3"]=13,e["thac-2"]=12,e["thac-1"]=11,e.thac00=10,e.thac0=10,e.thac1=9,e.thac2=8,e.thac3=7,e.thac4=6,e.thac5=5,e.thac6=4,e.thac7=3,e.thac8=2,e.thac9=1,e.thac10=0):l===10?(e["thac-10"]=19,e["thac-9"]=18,e["thac-8"]=17,e["thac-7"]=16,e["thac-6"]=15,e["thac-5"]=14,e["thac-4"]=13,e["thac-3"]=12,e["thac-2"]=11,e["thac-1"]=10,e.thac00=9,e.thac0=9,e.thac1=8,e.thac2=7,e.thac3=6,e.thac4=5,e.thac5=4,e.thac6=3,e.thac7=2,e.thac8=1,e.thac9=0,e.thac10=-1):l===11?(e["thac-10"]=18,e["thac-9"]=17,e["thac-8"]=16,e["thac-7"]=15,e["thac-6"]=14,e["thac-5"]=13,e["thac-4"]=12,e["thac-3"]=11,e["thac-2"]=10,e["thac-1"]=9,e.thac00=8,e.thac0=8,e.thac1=7,e.thac2=6,e.thac3=5,e.thac4=4,e.thac5=3,e.thac6=2,e.thac7=1,e.thac8=0,e.thac9=-1,e.thac10=-2):l===12&&(e["thac-10"]=17,e["thac-9"]=16,e["thac-8"]=15,e["thac-7"]=14,e["thac-6"]=13,e["thac-5"]=12,e["thac-4"]=11,e["thac-3"]=10,e["thac-2"]=9,e["thac-1"]=8,e.thac00=7,e.thac0=7,e.thac1=6,e.thac2=5,e.thac3=4,e.thac4=3,e.thac5=2,e.thac6=1,e.thac7=0,e.thac8=-1,e.thac9=-2,e.thac10=-3)),e.attack_matrix_flag=0),s===99&&(console.error("Error: Class not recognized or class name is empty."),e["thac-10"]=20,e["thac-9"]=20,e["thac-8"]=20,e["thac-7"]=20,e["thac-6"]=20,e["thac-5"]=20,e["thac-4"]=20,e["thac-3"]=20,e["thac-2"]=20,e["thac-1"]=20,e.thac00=20,e.thac0=20,e.thac1=20,e.thac2=20,e.thac3=20,e.thac4=20,e.thac5=20,e.thac6=20,e.thac7=20,e.thac8=20,e.thac9=20,e.thac10=20,e.attack_matrix_flag=0),await g(e,{silent:!0}),Ga())});on("sheet:opened change:thac0 change:thac00 change:autofill_matrix",async i=>{let r=await u(["attack_matrix_flag","matrix_class","thac0","thac1","thac2","thac00","thac01","thac02","autofill_matrix"]);if(!(+r.autofill_matrix||0))return;let e={},n=+r.attack_matrix_flag||0,a=+r.matrix_class||0;if(n===0||a>0)e.attack_matrix_flag=0;else{let t=+r.thac0||0,s=+r.thac1||0,c=+r.thac2||0,m=+r.thac00||0,h=+r.thac01||0,l=+r.thac02||0,p=t+s+c,w=m+h+l;e.attack_matrix_flag=p===60&&w===60?1:0}await g(e,{silent:!0})});on("change:thac00",i=>{Ga()});var F=(i,r,o,e)=>i<o?(console.log(`WARNING: ${r} value is not a number or out of range. [${i}].
Defaulting to ${o}.`),o):i>e?(console.log(`WARNING: ${r} value is out of range. [${i}].
Defaulting to ${e}.`),e):Math.min(Math.max(i,o),e),A=class{constructor(r,o,e,n,a,t){this.meleebonus=r,this.dmgbonus=o,this.majorstrengthfeat=t,this.minorstrengthfeat=n,this.minorstrengthfeat_locked=a,this.encumbrancebonus=e}getMeleeAttackBonus(){return this.meleebonus}getMeleeDamageBonus(){return this.dmgbonus}getMajorStrengthCheck(){return this.majorstrengthfeat}getMinorStrengthCheck(r=!1){return r?this.minorstrengthfeat_locked:this.minorstrengthfeat}getEncumbranceBonus(){return this.encumbrancebonus}},Oe=class{constructor(){this.strength_dict={3:new A(-3,-1,-350,1,0,0),4:new A(-2,-1,-250,1,0,0),5:new A(-2,-1,-250,1,0,0),6:new A(-1,0,-150,1,0,0),7:new A(-1,0,-150,1,0,0),8:new A(0,0,0,2,0,1),9:new A(0,0,0,2,0,1),10:new A(0,0,0,2,0,2),11:new A(0,0,0,2,0,2),12:new A(0,0,100,2,0,4),13:new A(0,0,100,2,0,4),14:new A(0,0,200,2,0,7),15:new A(0,0,200,2,0,7),16:new A(0,1,350,3,0,10),17:new A(1,1,500,3,0,13),18:{None:new A(1,2,750,3,0,16),"01-50":new A(1,3,1e3,3,0,20),"51-75":new A(2,3,1250,4,0,25),"76-90":new A(2,4,1500,4,0,30),"91-99":new A(2,5,2e3,4,1,35),"00":new A(3,6,3e3,5,2,40)},19:new A(3,7,4500,7,3,50),20:new A(3,8,5e3,7,3,60),21:new A(4,9,6e3,9,4,70),22:new A(4,10,7500,11,4,80),23:new A(5,11,9e3,11,5,90),24:new A(6,12,12e3,19,7,100),25:new A(7,14,15e3,23,9,100)}}getEntry(r,o){let e=F(r,"strength",3,25);return e!==18?this.strength_dict[e]:o<=0?this.strength_dict[e].None:o<=50?this.strength_dict[e]["01-50"]:o<=75?this.strength_dict[e]["51-75"]:o<=90?this.strength_dict[e]["76-90"]:o<=99?this.strength_dict[e]["91-99"]:this.strength_dict[e]["00"]}getStrengthValue(r,o,e=0,n=!1){switch(r){case"Attack":return this.getEntry(o,e).getMeleeAttackBonus();case"Damage":return this.getEntry(o,e).getMeleeDamageBonus();case"Major":return this.getEntry(o,e).getMajorStrengthCheck();case"Minor":return this.getEntry(o,e).getMinorStrengthCheck(n);case"Encumbrance":return this.getEntry(o,e).getEncumbranceBonus();default:return console.log("WARNING: Invalid Test."),"Invalid Test"}}},C=class{constructor(r,o,e,n){this.bonuslanguages=r,this.knowspell=o,this.minspells=e,this.maxspells=n}getBonusLanguages(){return this.bonuslanguages}getKnowSpell(){return this.knowspell}getMinSpells(){return this.minspells}getMaxSpells(){return this.maxspells}},Te=class{constructor(){this.intelligence_dict={8:new C(1,0,0,0),9:new C(1,35,4,6),10:new C(2,45,5,7),11:new C(2,45,5,7),12:new C(3,45,5,7),13:new C(3,55,6,9),14:new C(4,55,6,9),15:new C(4,65,7,11),16:new C(5,65,7,11),17:new C(6,75,8,14),18:new C(7,85,9,18),19:new C(8,95,10,99),20:new C(9,96,11,99),21:new C(10,97,12,99),22:new C(11,98,13,99),23:new C(12,99,14,99),24:new C(13,100,15,99),25:new C(14,100,16,99)}}getEntry(r){return this.intelligence_dict[F(r,"intelligence",8,25)]}},M=class{constructor(r,o,e){this.mentalsavebonus=r,this.spellbonus=o,this.spellfailure=e}getMentalSaveBonus(){return this.mentalsavebonus}getSpellBonus(){return this.spellbonus}getSpellFailure(){return this.spellfailure}},Ee=class{constructor(){this.wisdom_dict={3:new M("-3","None",20),4:new M("-2","None",20),5:new M("-1","None",20),6:new M("-1","None",20),7:new M("-1","None",20),8:new M("0","None",20),9:new M("0","None",20),10:new M("0","None",15),11:new M("0","None",10),12:new M("0","None",5),13:new M("0","1/0/0/0/0/0/0",0),14:new M("0","2/0/0/0/0/0/0",0),15:new M("1","2/1/0/0/0/0/0",0),16:new M("2","2/2/0/0/0/0/0",0),17:new M("3","2/2/1/0/0/0/0",0),18:new M("4","2/2/1/1/0/0/0",0),19:new M("4","3/2/1/2/0/0/0",0),20:new M("4","3/3/1/3/0/0/0",0),21:new M("4","3/3/2/3/1/0/0",0),22:new M("4","3/3/2/4/2/0/0",0),23:new M("4","3/3/2/4/4/0/0",0),24:new M("4","3/3/2/4/4/2/1",0),25:new M("4","3/3/2/4/4/3/1",0)}}getEntry(r){return this.wisdom_dict[F(r,"wisdom",3,25)]}},S=class{constructor(r,o,e){this.surprisebonus=r,this.rangedbonus=o,this.armorbonus=e}getSurpriseBonus(){return this.surprisebonus}getRangedBonus(){return this.rangedbonus}getArmorBonus(){return this.armorbonus}},Le=class{constructor(){this.dexterity_dict={3:new S(3,-3,4),4:new S(2,-2,3),5:new S(1,-1,2),6:new S(0,0,1),7:new S(0,0,0),8:new S(0,0,0),9:new S(0,0,0),10:new S(0,0,0),11:new S(0,0,0),12:new S(0,0,0),13:new S(0,0,0),14:new S(0,0,0),15:new S(0,0,-1),16:new S(-1,1,-2),17:new S(-2,2,-3),18:new S(-3,3,-4),19:new S(-3,3,-4),20:new S(-3,3,-4),21:new S(-4,4,-5),22:new S(-4,4,-5),23:new S(-4,4,-5),24:new S(-5,5,-6),25:new S(-5,5,-6)}}getEntry(r){return this.dexterity_dict[F(r,"dexterity",3,25)]}},I=class{constructor(r,o,e){this.hitpointbonus=r,this.systemshock=o,this.resurrectionsurvival=e}getHitpointBonus(){return this.hitpointbonus}getSystemShock(){return this.systemshock}getResurrectionSurvival(){return this.resurrectionsurvival}},Re=class{constructor(){this.constitution_dict={3:new I("-2",35,40),4:new I("-1",40,45),5:new I("-1",45,50),6:new I("0",50,55),7:new I("0",55,60),8:new I("0",60,65),9:new I("0",65,70),10:new I("0",70,75),11:new I("0",75,80),12:new I("0",80,85),13:new I("0",85,90),14:new I("0",88,92),15:new I("1",91,94),16:new I("2",95,96),17:new I("3",97,98),18:new I("4",99,100),19:new I("5",99,100),20:new I("5",99,100),21:new I("6",99,100),22:new I("6",99,100),23:new I("6",99,100),24:new I("7",99,100),25:new I("7",99,100)}}getEntry(r){return this.constitution_dict[F(r,"constitution",3,25)]}},N=class{constructor(r,o,e,n){this.maximumhenchmen=r,this.loyaltybonus=o,this.reactionbonus=e,this.comeliness=n}MaximumHenchmen(){return this.maximumhenchmen}getLoyaltyBonus(){return this.loyaltybonus}getReactionBonus(){return this.reactionbonus}getComeliness(){return this.comeliness}},Pe=class{constructor(){this.charisma_dict={3:new N(1,-30,-25,-5),4:new N(1,-25,-20,-3),5:new N(2,-20,-15,-3),6:new N(2,-15,-10,-1),7:new N(3,-10,-5,-1),8:new N(3,-5,0,-1),9:new N(4,0,0,0),10:new N(4,0,0,0),11:new N(4,0,0,0),12:new N(5,0,0,0),13:new N(5,0,5,1),14:new N(6,5,10,1),15:new N(7,15,15,1),16:new N(8,20,25,2),17:new N(10,30,30,2),18:new N(15,40,35,3),19:new N(20,50,40,5),20:new N(25,60,45,5),21:new N(30,70,50,5),22:new N(35,80,55,5),23:new N(40,90,60,5),24:new N(45,100,65,5),25:new N(50,100,70,5)}}getEntry(r){return this.charisma_dict[F(r,"charisma",3,25)]}},T=class{constructor(r,o,e,n,a){this.pickPockets=r,this.openLocks=o,this.findRemoveTraps=e,this.moveSilently=n,this.hideInShadows=a}getPickPockets(){return this.pickPockets}getOpenLocks(){return this.openLocks}getFindRemoveTraps(){return this.findRemoveTraps}getMoveSilently(){return this.moveSilently}getHideInShadows(){return this.hideInShadows}},Be=class{constructor(){this.dexterity_dict={9:new T(-15,-10,-10,-20,-10),10:new T(-10,-5,-10,-15,-5),11:new T(-5,0,-5,-10,0),12:new T(0,0,0,-5,0),13:new T(0,0,0,0,0),14:new T(0,0,0,0,0),15:new T(0,0,0,0,0),16:new T(0,5,0,0,0),17:new T(5,10,0,5,5),18:new T(10,15,5,10,10),19:new T(15,20,10,12,12),20:new T(20,25,15,15,15),21:new T(25,30,20,18,18),22:new T(30,35,25,20,20),23:new T(35,40,30,23,23),24:new T(40,45,35,25,25),25:new T(45,50,40,30,30)}}getEntry(r){return this.dexterity_dict[F(r,"dexterity",9,25)]}},B=class{constructor(r,o,e,n,a,t,s,c){this.pickPockets=r,this.openLocks=o,this.findRemoveTraps=e,this.moveSilently=n,this.hideInShadows=a,this.hearNoise=t,this.climbWalls=s,this.readLanguages=c}getPickPockets(){return this.pickPockets}getOpenLocks(){return this.openLocks}getFindRemoveTraps(){return this.findRemoveTraps}getMoveSilently(){return this.moveSilently}getHideInShadows(){return this.hideInShadows}getHearNoise(){return this.hearNoise}getClimbWalls(){return this.climbWalls}getReadLanguages(){return this.readLanguages}},je=class{constructor(){this.dexterity_dict={0:new B(0,0,0,0,0,0,0,0),1:new B(0,0,0,0,0,0,0,0),2:new B(0,10,15,0,0,0,-10,-5),3:new B(5,-5,0,5,10,5,0,0),4:new B(0,5,10,5,5,10,-15,0),5:new B(10,0,0,0,5,0,0,0),6:new B(5,5,5,10,15,5,-15,-5),7:new B(-5,5,5,0,0,5,5,-10)}}getEntry(r){return this.dexterity_dict[F(r,"thief_race_selected",0,7)]}},W=new Oe,we=new Te,de=new Ee,ae=new Le,te=new Re,G=new Pe,pe=new Be,H=new je,P=(i,r,o="int")=>o==="int"?parseInt(i[r])||0:o==="float"?parseFloat(i[r])||0:o==="str"?i[r]:null,za=async()=>{let i=await u(["strength","exceptionalstrength"]),r={},o=await P(i,"strength","int"),e=await P(i,"exceptionalstrength");await P(i,"exceptionalstrength","str")==="00"&&(e=100),r.exceptionalstrength=e,r.meleebonus=(W.getStrengthValue("Attack",o,e)<=0?"":"+")+W.getStrengthValue("Attack",o,e),r.dmgbonus=(W.getStrengthValue("Damage",o,e)<=0?"":"+")+W.getStrengthValue("Damage",o,e),r.majorstrengthfeat=W.getStrengthValue("Major",o,e),r.minorstrengthfeat=W.getStrengthValue("Minor",o,e),r.minorstrengthfeat_locked=W.getStrengthValue("Minor",o,e,!0),r.encumbrancebonus=(W.getStrengthValue("Encumbrance",o,e)<=0?"":"+")+W.getStrengthValue("Encumbrance",o,e),await g(r)},Ka=async()=>{let i=await u(["intelligence","bonuslanguages","race"]),r={},o=await P(i,"intelligence","int"),e=await P(i,"race","str"),n=+we.getEntry(o).getBonusLanguages();/human/gi.test(e)?r.bonuslanguages=n:/dwarf/gi.test(e)||/gnome/gi.test(e)||/orc/gi.test(e)?r.bonuslanguages=Math.min(n,2):/half-elf/gi.test(e)||/halfling/gi.test(e)||/hobbit/gi.test(e)?(n<=5?n=0:n===6?n=1:n===7?n=2:n===8?n=3:n===9?n=4:n===10?n=5:n===11?n=6:n===12?n=7:n===13?n=8:n>=14&&(n=9),r.bonuslanguages=n):/elf/gi.test(e)?(n<=4?n=0:n===5?n=1:n==6?n=2:n===7?n=3:n===8?n=4:n===9?n=5:n===10?n=6:n===11?n=7:n===12?n=8:n===13?n=9:n>=14&&(n=10),r.bonuslanguages=n):r.bonuslanguages=0,r.knowspell=we.getEntry(o).getKnowSpell(),r.minspells=we.getEntry(o).getMinSpells(),r.maxspells=we.getEntry(o).getMaxSpells(),await g(r,{silent:!0})},Xa=async()=>{let i=await u(["wisdom"]),r={},o=await P(i,"wisdom","int");r.mentalsavebonus=(de.getEntry(o).getMentalSaveBonus()<=0?"":"+")+de.getEntry(o).getMentalSaveBonus(),r.spellbonus=de.getEntry(o).getSpellBonus(),r.spellfailure=de.getEntry(o).getSpellFailure(),await g(r,{silent:!0})},Qa=async()=>{let i=await u(["dexterity"]),r={},o=await P(i,"dexterity","int"),e=ae.getEntry(o).getSurpriseBonus(),n=(-1*e<=0?"":"+")+-1*e;r.surprisebonus=ae.getEntry(o).getSurpriseBonus(),r.surprisebonus_inverted=n,r.rangedbonus=(ae.getEntry(o).getRangedBonus()<=0?"":"+")+ae.getEntry(o).getRangedBonus(),r.armorbonus=(ae.getEntry(o).getArmorBonus()<=0?"":"+")+ae.getEntry(o).getArmorBonus(),await g(r)},Ya=async()=>{let i=await u(["constitution","class","secondclass","thirdclass"]),r={},o=await P(i,"constitution","int"),e=[i.class,i.secondclass,i.thirdclass];/fighter/gi.test(e)||/paladin/gi.test(e)||/ranger/gi.test(e)?r.hitpointbonus=(te.getEntry(o).getHitpointBonus()<=0?"":"+")+te.getEntry(o).getHitpointBonus():r.hitpointbonus=(Math.min(te.getEntry(o).getHitpointBonus(),2)<=0?"":"+")+Math.min(te.getEntry(o).getHitpointBonus(),2),r.systemshock=te.getEntry(o).getSystemShock(),r.resurrectionsurvival=te.getEntry(o).getResurrectionSurvival(),await g(r)},Za=async()=>{let i=await u(["charisma"]),r={},o=await P(i,"charisma","int");r.maximumhenchmen=G.getEntry(o).MaximumHenchmen(),r.loyaltybonus=(G.getEntry(o).getLoyaltyBonus()<=0?"":"+")+G.getEntry(o).getLoyaltyBonus(),r.reactionbonus=(G.getEntry(o).getReactionBonus()<=0?"":"+")+G.getEntry(o).getReactionBonus(),r.comeliness_cha_adj=(G.getEntry(o).getComeliness()<=0?"":"+")+G.getEntry(o).getComeliness(),await setAttrs(r,{silent:!0})},Kr=async i=>{let r=await u(["dexterity"]),o={},e=await P(r,"dexterity","int"),n=pe.getEntry(e).getPickPockets(),a=pe.getEntry(e).getOpenLocks(),t=pe.getEntry(e).getFindRemoveTraps(),s=pe.getEntry(e).getMoveSilently(),c=pe.getEntry(e).getHideInShadows();o.pickpockets_ability_mod=i===1?n:0,o.openlocks_ability_mod=i===1?a:0,o.findtraps_ability_mod=i===1?t:0,o.movequietly_ability_mod=i===1?s:0,o.hideinshadows_ability_mod=i===1?c:0,await g(o)},Xr=async i=>{let r=await u(["thief_race_selected"]),o={},e=await P(r,"thief_race_selected","int"),n=H.getEntry(e).getPickPockets(),a=H.getEntry(e).getOpenLocks(),t=H.getEntry(e).getFindRemoveTraps(),s=H.getEntry(e).getMoveSilently(),c=H.getEntry(e).getHideInShadows(),m=H.getEntry(e).getHearNoise(),h=H.getEntry(e).getClimbWalls(),l=H.getEntry(e).getReadLanguages();o.pickpockets_racial_mod=i===1?n:0,o.openlocks_racial_mod=i===1?a:0,o.findtraps_racial_mod=i===1?t:0,o.movequietly_racial_mod=i===1?s:0,o.hideinshadows_racial_mod=i===1?c:0,o.hearnoise_racial_mod=i===1?m:0,o.climbwalls_racial_mod=i===1?h:0,o.readlanguages_racial_mod=i===1?l:0,await g(o)};on("change:autofill_thief_dex change:dexterity",async i=>{let o=+(await u(["autofill_thief_dex"])).autofill_thief_dex||0;await Kr(o)});var Qr=i=>{let r=i.trim().toLowerCase();return/human/.test(r)?1:/dwarf/.test(r)?2:/half-elf/.test(r)?5:/elf/.test(r)?3:/gnome/.test(r)?4:/halfling|hobbit/.test(r)?6:/half-orc/.test(r)?7:0};on("change:race change:autofill_thief_race change:thief_race_selected",async i=>{let r=i.sourceAttribute,o=await u(["race","autofill_thief_race"]),e={},n=+o.autofill_thief_race||0,a=(o.race||"human").trim();(r==="autofill_thief_race"||r==="race")&&(e.thief_race_selected=Qr(a)),await g(e,{silent:!0}),Xr(n)});on("change:strength change:exceptionalstrength",i=>{za()});on("change:intelligence change:race",i=>{Ka()});on("change:wisdom",i=>{Xa()});on("change:dexterity",i=>{Qa()});on("change:constitution change:class change:secondclass change:thirdclass",i=>{Ya()});on("change:charisma change:comeliness",i=>{Za()});var Ja=async()=>{let i=await u(["character_avatar","sheet_image","sheet_image_url"]),r={},o=+i.sheet_image||0,e=(function(t){let s=/(\.png|\.jpg|\.gif)/i,c=t.match(s);return c?t.slice(0,c.index+c[0].length):t})(i.character_avatar),n=i.sheet_image_url||e;o===0&&(r.sheet_image_src=n),o===1&&(r.sheet_image_src=e),o===2&&(r.sheet_image_src=""),await g(r,{silent:!0})};on("change:character_avatar change:sheet_image change:sheet_image_url",i=>{Ja()});on("clicked:postimage",async i=>{await Ja();let r="?{Display the portrait image?|YES,@{sheet_image_src}|NO,&nbsp;}";await new Promise(o=>{startRoll(r,e=>{finishRoll(e.rollId),o()})})});on("change:psionic_ability_strength_max change:psionic_attack change:psionic_defense",async i=>{let r=await u(["psionic_ability_strength_max"]),o={},e=+r.psionic_ability_strength_max||0;o.psionic_attack_max=E(e/2).toFixed(1),o.psionic_defense_max=E(e/2).toFixed(1),await g(o,{silent:!0})});var Yr=async()=>{let i=await f("weapon"),r={};if(i.length===0){r.weapon_in_use="",r.weapon_in_use_speed="",r.weapon_in_use_misc="",await g(r,{silent:!0});return}let o=[],e=i.flatMap(a=>[`repeating_weapon_${a}_weapon_name`,`repeating_weapon_${a}_weapon_use`,`repeating_weapon_${a}_weapon_speed`,`repeating_weapon_${a}_weapon_misc`]),n=await u(e);if(i.forEach(a=>{let t=parseInt(n[`repeating_weapon_${a}_weapon_use`])||0;if(t===1){let s=n[`repeating_weapon_${a}_weapon_name`]||"Unknown",m=String(n[`repeating_weapon_${a}_weapon_speed`]||"0").match(/\d+/),h=m?parseInt(m[0]):0,l=n[`repeating_weapon_${a}_weapon_misc`]||"";o.push({id:a,name:s,inUse:t,speed:h,misc:l})}}),o.length>0){o.sort((t,s)=>t.speed-s.speed);let a=o[0];r.weapon_in_use=a.name,r.weapon_in_use_speed=a.speed,r.weapon_in_use_misc=a.misc}else r.weapon_in_use="",r.weapon_in_use_speed="",r.weapon_in_use_misc="";await g(r,{silent:!0})};on("change:repeating_weapon:weapon_name change:repeating_weapon:weapon_use change:repeating_weapon:weapon_speed change:repeating_weapon:weapon_misc remove:repeating_weapon",i=>{Yr()});var et=async i=>{let r=await f(i),e=(await u([`_reporder_repeating_${i}`]))[`_reporder_repeating_${i}`]||"",a=(e?e.split(","):[]).filter(s=>r.includes(s.toLowerCase()));return[...new Set([...a,...r])]};on("clicked:spell-sort-alphabetical clicked:spell-sort-level",async i=>{let r=i.triggerName.replace("clicked:","");if(+(await u(["spells_sheet_busy"])).spells_sheet_busy!=1){await g({spells_sheet_busy:1});try{let e="spells",n=await et(e),a=await f(e);if(a.length>0){let t=a.flatMap(w=>[`repeating_spells_${w}_spell_caster_class`,`repeating_spells_${w}_spell_level`,`repeating_spells_${w}_spell_name`]),s=await u(t),c={},m=a.map(w=>({id:w,casterClass:s[`repeating_spells_${w}_spell_caster_class`]||0,level:s[`repeating_spells_${w}_spell_level`],name:(s[`repeating_spells_${w}_spell_name`]||"").trim()})),h=w=>w==="?"?-1:w||0;r==="spell-sort-alphabetical"?m.sort((w,$)=>w.name.localeCompare($.name,void 0,{sensitivity:"base"})):r==="spell-sort-level"&&m.sort((w,$)=>{let D=h(w.level),O=h($.level);return w.casterClass-$.casterClass||D-O||w.name.localeCompare($.name,void 0,{sensitivity:"base"})});let l=m.map(w=>`${w.id}`);setSectionOrder("spells",l),l.length>35?await be(100):await be(20);let p=[...new Set(n.map(w=>w.toLowerCase()))];c.spells_previous_order_array=p.join(","),await g(c,{silent:!0})}}catch(e){console.error("Error: Sort failed.",e)}finally{await g({spells_sheet_busy:0})}}});on("clicked:spell-sort-undo",async i=>{if(+(await u(["spells_sheet_busy"])).spells_sheet_busy!=1){await g({spells_sheet_busy:1});try{let o="spells",[e,n]=await Promise.all([u(["spells_previous_order_array"]),f(o)]),a=e.spells_previous_order_array||"";if(a){let t=new Set(n.map(c=>c.toLowerCase())),s=[...new Set(a.split(",").map(c=>c.toLowerCase()).filter(c=>t.has(c)))];setSectionOrder(o,s),await g({spells_previous_order_array:""},{silent:!0})}}catch(o){console.error("Error: Undo failed",o)}finally{await g({spells_sheet_busy:0})}}});on("clicked:equipment-sort-alphabetical clicked:equipment-sort-location",async i=>{let r=i.triggerName.replace("clicked:","");if(+(await u(["equipment_sheet_busy"])).equipment_sheet_busy!=1){await g({equipment_sheet_busy:1});try{let e="equipment",n=await et(e),a=await f(e);if(a.length>0){let t=a.flatMap(p=>[`repeating_equipment_${p}_equipment_item`,`repeating_equipment_${p}_equipment_location`]),s=await u(t),c={},m=a.map(p=>({id:p,name:(s[`repeating_equipment_${p}_equipment_item`]||"").trim(),location:(s[`repeating_equipment_${p}_equipment_location`]||"").trim()}));r==="equipment-sort-alphabetical"?m.sort((p,w)=>p.name.localeCompare(w.name,void 0,{sensitivity:"base"})):r==="equipment-sort-location"&&m.sort((p,w)=>{let $=p.location.localeCompare(w.location,void 0,{sensitivity:"base"});return $!==0?$:p.name.localeCompare(w.name,void 0,{sensitivity:"base"})});let h=m.map(p=>p.id);setSectionOrder(e,h),h.length>35?await be(100):await be(20);let l=[...new Set(n.map(p=>p.toLowerCase()))];c.equipment_previous_order_array=l.join(","),await g(c,{silent:!0})}}catch(e){console.error("Error: Sort failed.",e)}finally{await g({equipment_sheet_busy:0})}}});on("clicked:equipment-sort-undo",async i=>{if(+(await u(["equipment_sheet_busy"])).equipment_sheet_busy!=1){await g({equipment_sheet_busy:1});try{let o="equipment",[e,n]=await Promise.all([u(["equipment_previous_order_array"]),f(o)]),a=e.equipment_previous_order_array||"";if(a){let t=new Set(n.map(c=>c.toLowerCase())),s=[...new Set(a.split(",").map(c=>c.toLowerCase()).filter(c=>t.has(c)))];setSectionOrder(o,s),await g({equipment_previous_order_array:""},{silent:!0})}}catch(o){console.error("Error: Undo failed.",o)}finally{await g({equipment_sheet_busy:0})}}});
