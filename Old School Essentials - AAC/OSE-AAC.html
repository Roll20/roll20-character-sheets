<!-- Hidden Inputs -->
<input type="hidden" name="attr_BonusSTR" value="0" />
<input type="hidden" name="attr_BonusDEX" value="0" />
<input type="hidden" name="attr_ArmorBenefitTotal" value="0" />
<input type="hidden" name="attr_ArmorWeightTotal" value="0" />
<input type="hidden" name="attr_ItemWeightTotal" value="0" />
<input type="hidden" name="attr_WeaponWeightTotal" value="0" />
<input type="hidden" name="attr_sheetTab" value="character" />

<!-- Deprecated Attributes -->
<input type="hidden" name="attr_ac" value="0" />
<input type="hidden" name="attr_Saving-1" value="0" />
<input type="hidden" name="attr_Saving-2" value="0" />
<input type="hidden" name="attr_Saving-3" value="0" />
<input type="hidden" name="attr_Saving-4" value="0" />
<input type="hidden" name="attr_Saving-5" value="0" />

<!-- Sheet Selector -->
<div class="sheet-button-select">
  <button type="action" name="act_character" data-i18n="character">Character</button>
  <button type="action" name="act_monster" data-i18n="monster">Monster</button>
  <button type="action" name="act_notes" data-i18n="notes">Notes</button>
  <button type="action" name="act_settings" data-i18n="settings">Settings</button>
</div>

<!-- Character Sheet -->
<div class="sheet-character">
  <div class="info-grid">
    <div class="logo">
      <img src="https://i84.servimg.com/u/f84/13/24/51/43/logone12.png" />
    </div>
    <div class="infos">
      <div class="flex">
        <label class="inline-flex">
          <span data-i18n="name-pc-abbr">PC</span>
          <input type="text" name="attr_character_name" data-i18n-placeholder="character-name"
            placeholder="Character name" />
        </label>
        <label class="inline-flex">
          <span data-i18n="alignment-abbr">AL</span>
          <input type="text" name="attr_alignment" data-i18n-placeholder="alignment" placeholder="Alignment" />
        </label>
      </div>
      <div class="flex">
        <label class="inline-flex">
          <span data-i18n="class">Class</span>
          <select name="attr_class">
            <option>Cleric</option>
            <option>Dwarf</option>
            <option>Elf</option>
            <option>Fighter</option>
            <option>Halfling</option>
            <option>Magic-User</option>
            <option>Thief</option>
            <option>Acrobat</option>
            <option>Assassin</option>
            <option>Barbarian</option>
            <option>Bard</option>
            <option>Drow</option>
            <option>Druid</option>
            <option>Duergar</option>
            <option>Gnome</option>
            <option>Half-Elf</option>
            <option>Half-Orc</option>
            <option>Illusionist</option>
            <option>Knight</option>
            <option>Paladin</option>
            <option>Ranger</option>
            <option>Svirfneblin</option>
            <option>Monster</option>
            <option>Normal Human</option>
            <option>Custom</option>
          </select>
        </label>
        <label class="inline-flex">
          <span data-i18n="level">Level</span>
          <input type="number" name="attr_level" value="1" />
        </label>
        <label class="inline-flex">
          <span data-i18n="title">Title</span>
          <input type="text" name="attr_title" data-i18n-placeholder="title" placeholder="Title" />
        </label>
      </div>
      <div class="flex roll">
        <label class="inline-flex">
          <span data-i18n="experience-abbr">XP</span>
          <input type="number" name="attr_XP" value="0" />
        </label>
        <label class="inline-flex">
          <span data-i18n="next">Next</span>
          <input type="number" name="attr_Next" data-i18n-title="experience-next" title="Experience to Next Level"
            value="0" />
        </label>
        <label class="inline-flex">
          <span>+%</span>
          <input type="number" name="attr_ExpPercentage" value="0" />
        </label>
        <label class="inline-flex">
          <button type="roll" data-i18n="hit-dice-abbr" title="Hit Dice" data-i18n-title="hit-dice"
            value="&{template:simple} {{roll=HP for @{character_name}}} {{result=[[@{hitdice}+[[@{HPConMod}*{@{level}, 9}kl1]]]]}}">HD</button>
          <input type="text" name="attr_hitdice" value="0" placeholder="9d6+2" class="input-as-number double" />
          <span data-i18n="constitution-abbr-mod">± CON</span>
          <input readonly type="number" name="attr_HPConMod" value="0" />
        </label>
      </div>
    </div>
  </div>

  <div>
    <h1 data-i18n="ability-scores">Ability Scores</h1>
    <div class="scores roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSTR"
          value="&{template:less} {{roll=^{strength}}} {{result=[[ [[1d20]]<@{str}+@{modquery} ]]}} {{check=[[@{str}+@{modquery}]]}}"
          data-i18n="strength-abbr">
          STR
        </button>
        <input type="number" name="attr_str" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollINT"
          value="&{template:less} {{roll=^{intelligence}}} {{result=[[ [[1d20]]<@{int}+@{modquery} ]]}} {{check=[[@{int}+@{modquery}]]}}"
          data-i18n="intelligence-abbr">
          INT
        </button>
        <input type="number" name="attr_int" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollWIS"
          value="&{template:less} {{roll=^{wisdom}}} {{result=[[ [[1d20]]<@{wis}+@{modquery} ]]}} {{check=[[@{wis}+@{modquery}]]}}"
          data-i18n="wisdom-abbr">
          WIS
        </button>
        <input type="number" name="attr_wis" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollDEX"
          value="&{template:less} {{roll=^{dexterity}}} {{result=[[ [[1d20]]<@{dex}+@{modquery} ]]}} {{check=[[@{dex}+@{modquery}]]}}"
          data-i18n="dexterity-abbr">
          DEX
        </button>
        <input type="number" name="attr_dex" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollCON"
          value="&{template:less} {{roll=^{constitution}}} {{result=[[ [[1d20]]<@{con}+@{modquery} ]]}} {{check=[[@{con}+@{modquery}]]}}"
          data-i18n="constitution-abbr">
          CON
        </button>
        <input type="number" name="attr_con" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollCHA"
          value="&{template:less} {{roll=^{charisma}}} {{result=[[ [[1d20]]<@{cha}+@{modquery} ]]}} {{check=[[@{cha}+@{modquery}]]}}"
          data-i18n="charisma-abbr">
          CHA
        </button>
        <input type="number" name="attr_cha" value="0" />
      </label>
    </div>
  </div>

  <div>
    <h1 data-i18n="exploration">Exploration</h1>
    <div class="exploration roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollListenDoor"
          value="&{template:less} {{roll=^{listen-at-door-full}}} {{result=[[ [[1d6]]<@{ListenDoor}+@{modquery} ]]}} {{check=[[@{ListenDoor}+@{modquery}]]}}"
          data-i18n="listen-at-door">
          Listen at door
        </button>
        <input type="number" name="attr_ListenDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollOpenDoor"
          value="&{template:less} {{roll=^{open-stuck-door-full}}} {{result=[[ [[1d6]]<@{OpenDoor}+@{modquery} ]]}} {{check=[[@{OpenDoor}+@{modquery}]]}}"
          data-i18n="open-stuck-door">
          Open stuck door
        </button>
        <input type="number" name="attr_OpenDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollFindSecretDoor"
          value="&{template:less} {{roll=^{find-secret-door-full}}} {{result=[[ [[1d6]]<@{FindSecretDoor}+@{modquery} ]]}} {{check=[[@{FindSecretDoor}+@{modquery}]]}}"
          data-i18n="find-secret-door">
          Find secret door
        </button>
        <input type="number" name="attr_FindSecretDoor" value="1" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollFindRoomTrap"
          value="&{template:less} {{roll=^{find-room-trap-full}}} {{result=[[ [[1d6]]<@{FindRoomTrap}+@{modquery} ]]}} {{check=[[@{FindRoomTrap}+@{modquery}]]}}"
          data-i18n="find-room-trap">
          Find room trap
        </button>
        <input type="number" name="attr_FindRoomTrap" value="1" />
      </label>
    </div>
  </div>

  <div class="sheet-saves">
    <h1 data-i18n="saving-throws">Saving Throws</h1>
    <div class="saving roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveD"
          value="&{template:greater} {{roll=^{death-poison-full}}} {{result=[[ [[1d20]]>@{saveD}+@{modquery} ]]}} {{check=[[@{saveD}+@{modquery}]]}}"
          data-i18n="death-poison">
          Death, Poison
        </button>
        <input type="number" name="attr_saveD" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveW"
          value="&{template:greater} {{roll=^{magic-wands-full}}} {{result=[[ [[1d20]]>@{saveW}+@{modquery} ]]}} {{check=[[@{saveW}+@{modquery}]]}}"
          data-i18n="magic-wands">
          Magic wands
        </button>
        <input type="number" name="attr_saveW" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveP"
          value="&{template:greater} {{roll=^{paralysis-petrification-full}}} {{result=[[ [[1d20]]>@{saveP}+@{modquery} ]]}} {{check=[[@{saveP}+@{modquery}]]}}"
          data-i18n="paralysis-petrification">
          Paralysis, Petrification
        </button>
        <input type="number" name="attr_saveP" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveB"
          value="&{template:greater} {{roll=^{breath-attacks-full}}} {{result=[[ [[1d20]]>@{saveB}+@{modquery} ]]}} {{check=[[@{saveB}+@{modquery}]]}}"
          data-i18n="breath-attacks">
          Breath attacks
        </button>
        <input type="number" name="attr_saveB" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveS"
          value="&{template:greater} {{roll=^{spells-rods-staves-full}}} {{result=[[ [[1d20]]>@{saveS}+@{modquery} ]]}} {{check=[[@{saveS}+@{modquery}]]}}"
          data-i18n="spells-rods-staves">
          Spells, Rods, Staves
        </button>
        <input type="number" name="attr_saveS" value="0" />
      </label>
    </div>
  </div>

  <div class="sheet-abilities sheet-repeat">
    <h1 data-i18n="abilities-and-skills">Abilities & Skills</h1>
    <div class="abilities-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="roll">Roll</span>
      <span data-i18n="abbr-versus">vs</span>
      <span data-i18n="threshold">Threshold</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_abilities">
      <div class="abilities-grid">
        <button type="roll" name="abilityRoll"
          value="&{template:skill} {{name=@{}}} {{symbol=[[@{abilityDirection}]]}} {{roll=@{abilityName}}} {{result=[[@{abilityRoll}]]}} {{check=[[0+@{abilityThreshold}]]}} {{description=@{abilityDescription}}}"></button>
        <input type="text" name="attr_abilityName" placeholder="Name" data-i18n="name" />
        <input type="text" class="half-input" name="attr_abilityRoll" placeholder="2d6" />
        <select name="attr_abilityDirection" class="half-input">
          <option value="0"></option>
          <option value="1">&lt;</option>
          <option value="2">&gt;</option>
        </select>
        <input type="number" name="attr_abilityThreshold" placeholder="7" />
        <input type="text" name="attr_abilityDescription" data-i18n-placeholder="description"
          placeholder="Description" />
      </div>
    </fieldset>
  </div>

  <div>
    <input type="hidden" name="attr_armor_class_method" value="aac" />
    <h1 data-i18n="combat">Combat</h1>
    <div class="roll combat">
      <div>
        <div class="flex hp">
          <label class="inline-flex">
            <span data-i18n="hit-points-abbr">HP</span>
            <input type="number" name="attr_HP" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="max">Max</span>
            <input type="number" name="attr_HP_max" value="0" />
          </label>
        </div>
        <!-- Armor Class Fields are dependent on AAC vs DAC -->
        <input type="hidden" name="attr_armorClassType" value="aac">
        <div class="flex armor armor-aac">
          <label class="inline-flex">
            <span data-i18n="armor-class-abbr" title="Armor Class" data-i18n-title="armor-class">AC</span>
            <input readonly type="number" name="attr_aacAc" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="unarmored" class="double">Unarmored</span>
            <input readonly type="number" name="attr_aacAcUnarmored" />
          </label>
          <label class="inline-flex">
            <span data-i18n="dexterity-abbr-mod">± DEX</span>
            <input readonly type="number" name="attr_ACDexMod" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="base-attack-bonus-abbr" title="Base Attack Bonus"
              data-i18n-title="base-attack-bonus">BAB</span>
            <input type="number" name="attr_bab" value="0" />
          </label>
        </div>
        <div class="flex armor armor-dac">
          <label class="inline-flex">
            <span data-i18n="armor-class-abbr" title="Armor Class" data-i18n-title="armor-class">AC</span>
            <input readonly type="number" name="attr_dacAc" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="unarmored" class="double">Unarmored</span>
            <input readonly type="number" name="attr_dacAcUnarmored" />
          </label>
          <label class="inline-flex">
            <span data-i18n="dexterity-abbr-mod">± DEX</span>
            <input readonly type="number" name="attr_ACDexMod" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="thac0" class="double">THAC0</span>
            <input type="number" name="attr_thac0" value="0" />
          </label>
        </div>
      </div>
      <div class="sheet-col movement">
        <table>
          <caption data-i18n="movement">Movement</caption>
          <thead>
            <tr>
              <th data-i18n="movement-en">Encounter</th>
              <th data-i18n="movement-ex">Exploration</th>
              <th data-i18n="movement-ov">Overland</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input readonly type="number" name="attr_movementEncounter" data-i18n-title="movement-encounter"
                  title="Movement - Encounter" value="" />
              </td>
              <td>
                <input type="number" name="attr_movementExploration" data-i18n-title="movement-exploration"
                  title="Movement - Exploration" value="120" />
              </td>
              <td>
                <input readonly type="number" name="attr_movementOverland" data-i18n-title="movement-overland"
                  title="Movement - Overland" value="" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="sheet-col initiative">
        <label class="inline-flex">
          <button type="roll" name="attr_rollInit"
            value="&{template:simple} {{roll=^{initiative}}} {{result=[[1d6 &{tracker}]]}}" data-i18n="initiative-init">
            Init.
          </button>
          <input type="number" name="attr_initiative" value="0" />
        </label>
        <label class="inline-flex">
          <span data-i18n="dexterity-abbr-mod">± DEX</span>
          <input readonly type="number" name="attr_InitDexMod" value="0" />
        </label>
      </div>
    </div>
  </div>

  <div class="sheet-weapons sheet-repeat">
    <h1 data-i18n="weapons">Weapons</h1>
    <div class="weapons-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="attribute">Attribute</span>
      <span data-i18n="typeofattack">Type of Attack</span>
      <span data-i18n="attack-modifier">+Attack</span>
      <span data-i18n="damage-die">Damage Die</span>
      <span data-i18n="damage-modifier">+Damage</span>
      <span data-i18n="weight">Weight</span>
    </div>
    <fieldset class="repeating_weapons">
      <input class="expand" type="checkbox" name="attr_expandWeapon" data-i18n-title="expand-collapse"
        title="Expand/Collapse" /><span></span>
      <div class="weapons-grid">
        <div>
          <input type="hidden" name="attr_armorClassType" value="aac">
          <!-- AAC Attack -->
          <button type="roll" class="attack-roll attack-roll-aac"
            value="&{template:simple} {{roll=Attack with @{weaponName}}} {{attack=[[1d20+@{weaponAttributeBonus}+@{weaponAttackBonus}+@{bab}+@{modquery}]]}} {{damage=[[{[[@{weaponDamageDie}+@{weaponDamageBonus}+@{weaponAttributeBonusDamage}]], 1}kh1]]}} {{description=@{weaponDescription}}}"></button>
          <!-- DAC Attack (no BAB added) -->
          <button type="roll" class="attack-roll attack-roll-dac"
            value="&{template:simple} {{roll=Attack with @{weaponName}}} {{attack=[[1d20+@{weaponAttributeBonus}+@{weaponAttackBonus}+@{modquery}]]}} {{damage=[[{[[@{weaponDamageDie}+@{weaponDamageBonus}+@{weaponAttributeBonusDamage}]], 1}kh1]]}} {{description=@{weaponDescription}}}"></button>
        </div>
        <input type="text" name="attr_weaponName" placeholder="Weapon" />
        <select name="attr_weaponAttributeBonus">
          <option selected value="[[@{BonusSTR}]]">Strength</option>
          <option value="[[@{BonusDEX}]]">Dexterity</option>
        </select>
        <select name="attr_weaponAttributeBonusDamage">
          <option selected value="[[@{BonusSTR}]]">Melee</option>
          <option value="0">Ranged</option>
        </select>
        <input type="number" name="attr_weaponAttackBonus" value="0" />
        <select name="attr_weaponDamageDie" class="half-input">
          <option value="d4">d4</option>
          <option selected value="d6">d6</option>
          <option value="d8">d8</option>
          <option value="d10">d10</option>
          <option value="d12">d12</option>
        </select>
        <input type="number" name="attr_weaponDamageBonus" value="0" />
        <input type="number" name="attr_weaponWeight" placeholder="100" />
      </div>
      <input type="text" name="attr_weaponDescription" class="weapon-description" value="" placeholder="Description"
        data-i18n-placeholder="description" />
    </fieldset>
  </div>

  <div class="sheet-spells sheet-repeat">
    <h1>Spells</h1>
    <div class="spells-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="duration">Duration</span>
      <span data-i18n="range">Range</span>
      <span data-i18n="description">Description</span>
      <span data-i18n="effect-roll">Effect Roll</span>
    </div>
    <fieldset class="repeating_spells">
      <div class="spells-grid">
        <div>
          <input type="hidden" name="attr_spellRollType" value="describe" />
          <button type="roll" class="roll"
            value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}} {{effect=[[@{spellEffect}]]}}"></button>
          <button type="roll" class="roll-describe"
            value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}}"></button>
        </div>
        <input type="text" name="attr_spellName" placeholder="Magic Missile"
          data-i18n-placeholder="spell-name-placeholder" />
        <input type="text" name="attr_spellDuration" placeholder="1 turn"
          data-i18n-placeholder="spell-duration-placeholder" />
        <input type="text" name="attr_spellRange" placeholder="150'" />
        <input type="text" name="attr_spellDescription"
          placeholder="This spell conjures a glowing dart of energy that the caster may choose to shoot at a visible target within range."
          data-i18n-placeholder="spell-description-placeholder" />
        <input type="text" class="half-input" name="attr_spellEffect" placeholder="1d6+1" />
      </div>
    </fieldset>
  </div>

  <div>
    <h1 data-i18n="items-equipment">Items & Equipment</h1>
    <div class="equip">
      <h2>Gear</h2>
      <div class="items-grid">
        <span data-i18n="quantity-abbr">Qty</span>
        <span data-i18n="name">Name</span>
        <span data-i18n="description">Description</span>
        <span data-i18n="weight">Weight</span>
      </div>
      <div class="sheet-items sheet-repeat">
        <fieldset class="repeating_items">
          <div class="items-grid">
            <input type="number" name="attr_ItemQuantity" value="1" />
            <input type="text" name="attr_ItemName" data-i18n-placeholder="name" placeholder="Name" />
            <input type="text" name="attr_ItemDescription" data-i18n-placeholder="description"
              placeholder="Description" />
            <input type="number" name="attr_ItemWeight" value="0" />
          </div>
        </fieldset>
      </div>
      <h2>Armor</h2>
      <div class="armor-grid">
        <span data-i18n="name">Name</span>
        <span data-i18n="armor-benefit">AC Benefit</span>
        <span data-i18n="armor-weight">Armor Weight</span>
        <span data-i18n="worn-question">Worn?</span>
      </div>
      <div class="sheet-armor sheet-repeat">
        <fieldset class="repeating_armor">
          <div class="armor-grid">
            <input type="text" name="attr_armorName" placeholder="Leather"
              data-i18n-placeholder="armor-name-placeholder" />
            <input type="text" name="attr_armorBenefit" placeholder="2" />
            <input type="number" name="attr_armorWeight" placeholder="200" />
            <div class="checkbox">
              <input type="checkbox" checked name="attr_armorWorn" />
            </div>
          </div>
        </fieldset>
      </div>
    </div>
    <h2>Coins</h2>
    <div class="coins flex">
      <label class="inline-flex">
        <span data-i18n="platinum-piece-abbr">PP</span>
        <input type="number" name="attr_PP" title="Platinum" data-i18n-placeholder="platinum-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="gold-piece-abbr">GP</span>
        <input type="number" name="attr_GP" title="Gold" data-i18n-placeholder="gold-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="electrum-piece-abbr">EP</span>
        <input type="number" name="attr_EP" title="Electrum" data-i18n-placeholder="electrum-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="silver-piece-abbr">SP</span>
        <input type="number" name="attr_SP" title="Silver" data-i18n-placeholder="silver-placeholder" value="0" />
      </label>
      <label class="inline-flex">
        <span data-i18n="copper-piece-abbr">CP</span>
        <input type="number" name="attr_CP" title="Copper" data-i18n-placeholder="copper-placeholder" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label" style="width: 150%">
        <span data-i18n="encumbrance">Encumbrance</span>
        <input readonly type="number" name="attr_encumbrance" value="0" />
      </label>
    </div>
  </div>

  <div class="sheet-notes-section">
    <h1 data-i18n="notes">Notes</h1>
    <textarea name="attr_characterNotes"></textarea>
  </div>
</div>

<!-- Monster Sheet -->
<div class="sheet-monster">
  <div class="flex roll">
    <label class="inline-flex">
      <span data-i18n="name">Name</span>
      <input type="text" name="attr_character_name" />
    </label>
    <label class="inline-flex">
      <span class="double" data-i18n="description">Description</span>
      <input type="text" name="attr_monsterDescription" />
    </label>
  </div>
  <div class="flex roll">
    <label class="inline-flex">
      <span class="double" data-i18n="saves-as">Saves As</span>
      <select name="attr_class">
        <option>Monster</option>
        <option>Normal Human</option>
        <option>Custom</option>
        <option>Cleric</option>
        <option>Dwarf</option>
        <option>Elf</option>
        <option>Fighter</option>
        <option>Halfling</option>
        <option>Magic-User</option>
        <option>Thief</option>
        <option>Acrobat</option>
        <option>Assassin</option>
        <option>Barbarian</option>
        <option>Bard</option>
        <option>Drow</option>
        <option>Druid</option>
        <option>Duergar</option>
        <option>Gnome</option>
        <option>Half-Elf</option>
        <option>Half-Orc</option>
        <option>Illusionist</option>
        <option>Knight</option>
        <option>Paladin</option>
        <option>Ranger</option>
        <option>Svirfneblin</option>
      </select>
      <input type="hidden" name="attr_savesAs" value="character" />
      <input type="number" name="attr_level" value="1" />
    </label>
    <label class="inline-flex">
      <span data-i18n="alignment-abbr">AL</span>
      <input type="text" name="attr_alignment" data-i18n-placeholder="alignment" placeholder="Alignment" />
    </label>
  </div>
  <div class="flex roll">
    <label class="inline-flex">
      <button type="roll"
        value="/w gm &{template:simple} {{roll=Number of @{character_name} appearing}} {{Dungeon-Wandering=[[@{numberAppearingWandering}]]}} {{Dungeon-Lair=[[@{numberAppearingLair}]]}} {{Wilderness-Wandering=[[@{numberAppearingLair}]]}} {{Wilderness-Lair=[[@{numberAppearingLair}*5]]}}">NA</button>
      <input type="text" class="input-as-number" name="attr_numberAppearingWandering" value="0" placeholder="1d4" />
      <input type="text" class="input-as-number" name="attr_numberAppearingLair" value="0" placeholder="2d4+2" />
    </label>
    <label class="inline-flex">
      <button type="roll"
        value="/w gm &{template:simple} {{roll=Morale of @{character_name}}} {{morale=[[{2d6+0, 0d0+13}<@{monsterMorale}]]}}"
        title="Morale" data-i18n-title="morale" data-i18n="morale-abbr">ML</button>
      <input type="number" name="attr_monsterMorale" value="7" />
    </label>
    <label class="inline-flex">
      <span data-i18n="experience-abbr">XP</span>
      <input type="number" name="attr_monsterXPValue" />
    </label>
    <label class="inline-flex">
      <span data-i18n="treasure-type-abbr">TT</span>
      <input type="text" class="input-as-number" name="attr_monsterTreasureTypeGroup" />
      <input type="text" class="input-as-number" name="attr_monsterTreasureTypeIndividual" />
    </label>
  </div>

  <div>
    <input type="hidden" name="attr_armor_class_method" value="aac" />
    <h1 data-i18n="combat">Combat</h1>
    <div class="roll monster-combat">
      <div>
        <div class="flex hp">
          <label class="inline-flex">
            <button type="roll" data-i18n="hit-dice-number-abbr" title="Hit Dice" data-i18n-title="hit-dice-number"
              value="/w gm &{template:simple} {{roll=HP for @{character_name}}} {{result=[[@{monsterHitDice}d8+@{monsterHitDiceModifier}]]}}">#
              HD</button>
            <input type="number" name="attr_monsterHitDice" value="1" />
            <span>+</span>
            <input type="number" name="attr_monsterHitDiceModifier" value="0" />
          </label>
          <label class="inline-flex">
            <button type="action" name="act_setAverageHP" class="double" data-i18n="hit-points-average">Average
              HP</button>
            <input disabled type="number" name="attr_averageHP"
              value="floor(@{monsterHitDice}*4.5+@{monsterHitDiceModifier})" />
          </label>
          <label class="inline-flex">
            <span data-i18n="hit-points-abbr">HP</span>
            <input type="number" name="attr_HP" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="hit-points-max-abbr">Max</span>
            <input type="number" name="attr_HP_max" value="0" />
          </label>
        </div>
        <div class="flex">
          <input type="hidden" name="attr_armorClassType" value="aac">
          <label class="inline-flex show-aac">
            <span data-i18n="base-attack-bonus-abbr" title="Base Attack Bonus"
              data-i18n-title="base-attack-bonus">BAB</span>
            <input type="number" name="attr_monsterBAB" value="0" />
          </label>
          <label class="inline-flex show-dac">
            <span data-i18n="thac0" class="double">THAC0</span>
            <input type="number" name="attr_monsterThac0" value="0" />
          </label>
          <label class="inline-flex">
            <span data-i18n="armor-class-abbr" title="Armor Class" data-i18n-title="armor-class">AC</span>
            <input type="number" name="attr_monsterAc" value="0" />
          </label>
        </div>
      </div>
      <div class="sheet-col movement">
        <table>
          <caption data-i18n="movement">Movement</caption>
          <thead>
            <tr>
              <th data-i18n="movement-encounter">Encounter</th>
              <th data-i18n="movement-exploration">Exploration</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <input readonly type="number" name="attr_movementEncounter" value="" />
              </td>
              <td>
                <input type="number" name="attr_movementExploration" value="120" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="sheet-weapons sheet-repeat">
    <h1 data-i18n="attacks">Attacks</h1>
    <div class="weapons-grid">
      <span></span>
      <span data-i18n="number-abbr" title="Number" data-i18n-title="number">#</span>
      <span data-i18n="name">Name</span>
      <span data-i18n="damage">Damage</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_weapons">
      <div class="weapons-grid">
        <button type="roll"
          value="&{template:simple} {{roll=Attack with @{weaponName}}} {{attack=[[1d20+@{monsterBAB}+@{modquery}]]}} {{damage=[[@{weaponDamageDie}]]}} {{description=@{weaponDescription}}}"></button>
        <input type="number" name="attr_weaponAttacks" value="1">
        <input type="text" name="attr_weaponName" placeholder="Weapon" data-i18n-placeholder="weapon" />
        <input type="text" name="attr_weaponDamageDie" value="1d6+1" />
        <input type="text" name="attr_weaponDescription" value="" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-abilities sheet-repeat">
    <h1 data-i18n="abilities-and-skills">Abilities & Skills</h1>
    <div class="abilities-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="description">Description</span>
    </div>
    <fieldset class="repeating_abilities">
      <div class="abilities-grid">
        <button type="roll"
          value="&{template:simple} {{roll=@{abilityName}}} {{description=@{abilityDescription}}}"></button>
        <input type="text" name="attr_abilityName" placeholder="Name" data-i18n-placeholder="name" />
        <input type="text" name="attr_abilityDescription" data-i18n-placeholder="description"
          placeholder="Description" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-spells sheet-repeat">
    <h1 data-i18n="spells">Spells</h1>
    <div class="spells-grid">
      <span></span>
      <span data-i18n="name">Name</span>
      <span data-i18n="duration">Duration</span>
      <span data-i18n="range">Range</span>
      <span data-i18n="description">Description</span>
      <span data-i18n="effect-roll">Effect Roll</span>
    </div>
    <fieldset class="repeating_spells">
      <div class="spells-grid">
        <div>
          <input type="hidden" name="attr_spellRollType" value="describe" />
          <button type="roll" class="roll"
            value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}} {{effect=[[@{spellEffect}]]}}"></button>
          <button type="roll" class="roll-describe"
            value="&{template:simple} {{roll=Casts @{spellName}}} {{duration=@{spellDuration}}} {{range=@{spellRange}}} {{description=@{spellDescription}}}"></button>
        </div>
        <input type="text" name="attr_spellName" placeholder="Magic Missile"
          data-i18n-placeholder="spell-name-placeholder" />
        <input type="text" name="attr_spellDuration" placeholder="1 turn"
          data-i18n-placeholder="spell-duration-placeholder" />
        <input type="text" name="attr_spellRange" placeholder="150'" />
        <input type="text" name="attr_spellDescription"
          placeholder="This spell conjures a glowing dart of energy that the caster may choose to shoot at a visible target within range."
          data-i18n-placeholder="spell-description-placeholder" />
        <input type="text" class="half-input" name="attr_spellEffect" placeholder="1d6+1" />
      </div>
    </fieldset>
  </div>

  <div class="sheet-saves">
    <h1 data-i18n="saving-throws">Saving Throws</h1>
    <div class="saving roll flex">
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveD"
          value="&{template:greater} {{roll=^{death-poison-full}}} {{result=[[ [[1d20]]>@{saveD}+@{modquery} ]]}} {{check=[[@{saveD}+@{modquery}]]}}"
          data-i18n="death-poison">
          Death, Poison
        </button>
        <input type="number" name="attr_saveD" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveW"
          value="&{template:greater} {{roll=^{magic-wands-full}}} {{result=[[ [[1d20]]>@{saveW}+@{modquery} ]]}} {{check=[[@{saveW}+@{modquery}]]}}"
          data-i18n="magic-wands">
          Magic wands
        </button>
        <input type="number" name="attr_saveW" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveP"
          value="&{template:greater} {{roll=^{paralysis-petrification-full}}} {{result=[[ [[1d20]]>@{saveP}+@{modquery} ]]}} {{check=[[@{saveP}+@{modquery}]]}}"
          data-i18n="paralysis-petrification">
          Paralysis, Petrification
        </button>
        <input type="number" name="attr_saveP" value="0" />
      </label>

      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveB"
          value="&{template:greater} {{roll=^{breath-attacks-full}}} {{result=[[ [[1d20]]>@{saveB}+@{modquery} ]]}} {{check=[[@{saveB}+@{modquery}]]}}"
          data-i18n="breath-attacks">
          Breath attacks
        </button>
        <input type="number" name="attr_saveB" value="0" />
      </label>
      <label class="inline-flex inline-flex-wide-label">
        <button type="roll" name="attr_rollSaveS"
          value="&{template:greater} {{roll=^{spells-rods-staves-full}}} {{result=[[ [[1d20]]>@{saveS}+@{modquery} ]]}} {{check=[[@{saveS}+@{modquery}]]}}"
          data-i18n="spells-rods-staves">
          Spells, Rods, Staves
        </button>
        <input type="number" name="attr_saveS" value="0" />
      </label>
    </div>
  </div>

  <div class="sheet-notes-section">
    <h1 data-i18n="notes">Notes</h1>
    <textarea name="attr_monsterNotes"></textarea>
  </div>
</div>

<!-- Notes Sheet -->
<div class="sheet-notes">
  <div class="sheet-notes-section">
    <h1 data-i18n="notes">Notes</h1>
    <textarea name="attr_generalNotes"></textarea>
  </div>
</div>

<!-- Settings Sheet -->
<div class="sheet-settings">
  <h1 data-i18n="settings">Settings</h1>
  <label class="setting">
    <span data-i18n="armor-class-type">Armor Class Type</span>
    <select name="attr_armorClassType">
      <option value="aac" selected data-i18n="ascending-armor-class">Ascending Armor Class</option>
      <option value="dac" data-i18n="descending-armor-class">Descending Armor Class</option>
    </select>
  </label>
  <label class="setting">
    <span data-i18n="threshold-modifier-enabled">Threshold Modifier Enabled?</span>
    <select name="attr_thresholdModifierEnabled">
      <option value="enabled" selected data-i18n="enabled">Enabled</option>
      <option value="disabled" data-i18n="disabled">Disabled</option>
    </select>
  </label>
</div>

<!-- Attack roll translation -->
<span style="display: none;" data-i18n="typeofattack">Type of attack</span>
<span style="display: none;" data-i18n="modifier">Threshold modifier</span>
<span style="display: none;" data-i18n="modifier-mod">Modif</span>
<span style="display: none;" data-i18n="attack">Attack</span>
<span style="display: none;" data-i18n="attack">Damage</span>

<!-- Other translation -->
<span style="display: none;" data-i18n="initiative">Initiative</span>
<span style="display: none;" data-i18n="strength">Strength</span>
<span style="display: none;" data-i18n="intelligence">Intelligence</span>
<span style="display: none;" data-i18n="wisdom">Wisdom</span>
<span style="display: none;" data-i18n="dexterity">Dexterity</span>
<span style="display: none;" data-i18n="constitution">Constitution</span>
<span style="display: none;" data-i18n="charisma">Charisma</span>
<span style="display: none;" data-i18n="morale">Morale</span>

<span style="display: none;" data-i18n="death-poison-full">Death or poison</span>
<span style="display: none;" data-i18n="magic-wands-full">Magic wands</span>
<span style="display: none;" data-i18n="paralysis-petrification-full">Paralysis or petrification</span>
<span style="display: none;" data-i18n="breath-attacks-full">Breath attacks</span>
<span style="display: none;" data-i18n="spells-rods-staves-full">Spells, rods or staves</span>
<span style="display: none;" data-i18n="listen-at-door-full">Listen at door</span>
<span style="display: none;" data-i18n="open-stuck-door-full">Open stuck door</span>
<span style="display: none;" data-i18n="find-secret-room-full">Find secret room</span>
<span style="display: none;" data-i18n="find-room-trap-full">Find room trap</span>

<rolltemplate class="sheet-rolltemplate-simple">
  <div>
    <h3>{{roll}}</h3>
    {{#result}}
    <span class="sheet-template-result-only">{{result}}</span>
    {{/result}}
    {{#allprops() roll result description morale}}
    <div class="sheet-template-row">
      <span class="sheet-template-term">{{key}}:</span>
      <span class="sheet-template-result">{{value}}</span>
    </div>
    {{/allprops() roll result description morale}}
    {{#description}}
    <div class="sheet-template-description">{{description}}</div>
    {{/description}}

    <!-- Morale Specific -->
    {{#rollGreater() morale 0}}
    <span class="sheet-template-result-only fullcrit" data-i18n="morale-continue-fighting">Continue Fighting!</span>
    {{/rollGreater() morale 0}}
    {{#rollLess() morale 1}}
    <span class="sheet-template-result-only fullfail" data-i18n="morale-surrender-or-flee">Surrender or Flee!</span>
    {{/rollLess() morale 1}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-greater">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white; display: none;">{{check}}</span>
    <span style="background: white;">{{result}}</span>
    {{#rollLess() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollLess() result check}}

    {{#rollGreater() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollGreater() result check}}

    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-less">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white; display: none;">{{check}}</span>
    <span style="background: white;">{{result}}</span>

    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}

    {{#rollLess() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollLess() result check}}

    {{#rollGreater() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollGreater() result check}}
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-skill">
  <div>
    <h3>{{roll}}</h3>
    <span style="background: white;">{{result}}</span>
    {{#rollTotal() symbol 2}}
    {{#rollLess() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollLess() result check}}
    {{#rollGreater() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollGreater() result check}}
    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
    {{/rollTotal() symbol 2}}

    {{#rollTotal() symbol 1}}
    {{#rollTotal() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollTotal() result check}}
    {{#rollLess() result check}}
    <span class="rollresult rollsuccess" data-i18n="success">Success</span>
    {{/rollLess() result check}}
    {{#rollGreater() result check}}
    <span class="rollresult rollfail" data-i18n="fail">Fail</span>
    {{/rollGreater() result check}}
    {{/rollTotal() symbol 1}}

    {{#description}}
    <div class="sheet-template-description">
      {{description}}
    </div>
    {{/description}}
  </div>
</rolltemplate>

<script type="text/worker">
  /* ===== PARAMETERS ==========
  destination = the name of the attribute that stores the total quantity
  section = name of repeating fieldset, without the repeating_
  fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
  multiplier (optional) = a multiplier to the entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
  */
  const repeatingSum = (destination, section, fields, { multiplier = 1, callback = Function.prototype }) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
      const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
      getAttrs(attrArray, v => {
        console.log("===== values of v: " + JSON.stringify(v) + " =====");
        // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
        const getValue = (section, id, field) => parseFloat(v[`repeating_${section}_${id}_${field}`]) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0);
        const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal, field) => subtotal * getValue(section, id, field), 1), 0);
        setAttrs({ [destination]: sumTotal * multiplier }, callback);
      });
    });
  };

  on("sheet:opened change:thresholdModifierEnabled", function (eventInfo) {
    // Check for threshold modifier enabled
    getAttrs(['thresholdModifierEnabled'], function(values) {
      if (values.thresholdModifierEnabled.toLowerCase() === "disabled") {
        setAttrs({ modquery: "0" })
      } else {
        setAttrs({
          modquery: "?{" + getTranslationByKey("modifier") + "|0}[" + getTranslationByKey("modifier-mod") + "]",
        });
      }
    })

    // Update saving throws
    getAttrs(["Saving-1", "Saving-2", "Saving-3", "Saving-4", "Saving-5"], function(values) {
      setAttrs({
        saveD: values["Saving-1"],
        saveW: values["Saving-2"],
        saveP: values["Saving-3"],
        saveB: values["Saving-4"],
        saveS: values["Saving-5"],
      })
    })
  });


  // Attribute Changes
  on("sheet:opened change:dex", function () {
    getAttrs(["ACDexMod", "InitDexMod", "BonusDEX", "dex"], function (values) {
      let acBonus = 0;
      let initMod = 0;

      if (values.dex == 3) {
        acBonus = -3;
        initMod = -2;
      } else if (values.dex > 3 && values.dex <= 5) {
        acBonus = -2;
        initMod = -1;
      } else if (values.dex >= 6 && values.dex <= 8) {
        acBonus = -1;
        initMod = -1;
      } else if (values.dex >= 9 && values.dex <= 12) {
        acBonus = 0;
        initMod = 0;
      } else if (values.dex >= 13 && values.dex <= 15) {
        acBonus = 1;
        initMod = 1;
      } else if (values.dex >= 16 && values.dex <= 17) {
        acBonus = 2;
        initMod = 1;
      } else if (values.dex == 18) {
        acBonus = 3;
        initMod = 2;
      }

      setAttrs({
        ACDexMod: acBonus,
        BonusDEX: acBonus,
        InitDexMod: initMod,
        acUnarmored: 10 + acBonus, // todo deprecate
        aacAcUnarmored: 10 + acBonus,
        dacAcUnarmored: 9 - acBonus,
      });
    });
  });
  on("change:str", function () {
    getAttrs(["BonusSTR", "OpenDoor", "str"], function (values) {
      if (values.str == 3) {
        setAttrs({
          BonusSTR: -3,
          OpenDoor: 1
        });
      } else if (values.str > 3 && values.str <= 5) {
        setAttrs({
          BonusSTR: -2,
          OpenDoor: 1
        });
      } else if (values.str >= 6 && values.str <= 8) {
        setAttrs({
          BonusSTR: -1,
          OpenDoor: 1
        });
      } else if (values.str >= 9 && values.str <= 12) {
        setAttrs({
          BonusSTR: 0,
          OpenDoor: 2
        });
      } else if (values.str >= 13 && values.str <= 15) {
        setAttrs({
          BonusSTR: 1,
          OpenDoor: 3
        });
      } else if (values.str >= 16 && values.str <= 17) {
        setAttrs({
          BonusSTR: 2,
          OpenDoor: 4
        });
      } else if (values.str == 18) {
        setAttrs({
          BonusSTR: 3,
          OpenDoor: 5
        });
      }
    });
  });
  on("change:con", function () {
    getAttrs(["HPConMod", "con"], function (values) {
      if (values.con == 3) {
        setAttrs({ HPConMod: -3 });
      } else if (values.con > 3 && values.con <= 5) {
        setAttrs({ HPConMod: -2 });
      } else if (values.con >= 6 && values.con <= 8) {
        setAttrs({ HPConMod: -1 });
      } else if (values.con >= 9 && values.con <= 12) {
        setAttrs({ HPConMod: 0 });
      } else if (values.con >= 13 && values.con <= 15) {
        setAttrs({ HPConMod: 1 });
      } else if (values.con >= 16 && values.con <= 17) {
        setAttrs({ HPConMod: 2 });
      } else if (values.con == 18) {
        setAttrs({ HPConMod: 3 });
      }
    });
  });

  // Set speeds based on Exploration Speed
  on('sheet:opened change:movementExploration', function() {
    getAttrs(['movementExploration'], function(values) {
      const explorationSpeed = values.movementExploration;
      setAttrs({
        movementEncounter: Math.floor(explorationSpeed/3),
        movementOverland: Math.floor(explorationSpeed/5)
      });
    });
  });

  // Armor Calculation
  on('sheet:opened change:repeating_armor remove:repeating_armor', function () {
    repeatingSum(
      "ArmorBenefitTotal",
      "armor",
      ["armorBenefit", "armorWorn"],
      {
        callback: function () {
          getAttrs(["ArmorBenefitTotal", "aacAcUnarmored"], function (values) {
            setAttrs({
              aacAc: Object.values(values)
                .map(value => parseInt(value, 10))
                .reduce((sum, cur) => sum + cur)
            });
          });
          getAttrs(["ArmorBenefitTotal", "dacAcUnarmored"], function (values) {
            setAttrs({
              dacAc: parseInt(values.dacAcUnarmored, 10) - values.ArmorBenefitTotal
            });
          });
        }
      }
    );
  });

  // Monster Average HP Button
  on('clicked:setAverageHP', function () {
    getAttrs(['monsterHitDice', 'monsterHitDiceModifier'], function (values) {
      const averageHP = Math.floor(
        (parseInt(values.monsterHitDice, 10) * 4.5) + parseInt(values.monsterHitDiceModifier, 10)
      );
      setAttrs({
        HP: averageHP,
        HP_max: averageHP
      });
    });
  });

  // Recalculate encumbrance
  on([
    "sheet:opened",
    "change:repeating_armor",
    "remove:repeating_armor",
    "change:repeating_items",
    "remove:repeating_items",
    "change:repeating_weapons",
    "remove:repeating_weapons",
    "change:PP",
    "change:EP",
    "change:GP",
    "change:SP",
    "change:CP"
  ].join(' '), function () {
    repeatingSum("ArmorWeightTotal", "armor", "armorWeight", {
      callback: () => {
        repeatingSum("ItemWeightTotal", "items", "ItemWeight", {
          callback: () => {
            repeatingSum("WeaponWeightTotal", "weapons", "weaponWeight", {
              callback: () => {
                getAttrs(['PP', 'EP', 'GP', 'SP', 'CP', 'ArmorWeightTotal', 'WeaponWeightTotal', 'ItemWeightTotal'], (weights) => {
                  setAttrs({
                    Encumbrance: Object.values(weights)
                      .map(weight => parseInt(weight, 10))
                      .reduce((sum, cur) => sum + cur)
                  })
                })
              }
            });
          }
        });
      }
    });
  })

  // Tabs
  const buttonlist = ["character", "monster", "notes", "settings"];
  buttonlist.forEach(button => {
    on(`clicked:${button}`, function (event) {
      console.log(button, 'clicked!')
      setAttrs({ sheetTab: button });
    });
  });

  // Calculate THAC0 from BAB
  on('change:bab', function() {
    getAttrs(['bab'], function(values) {
      setAttrs({ thac0: 19 - values.bab });
    });
  });
  // Calculate BAB from THAC0
  on('change:thac0', function() {
    getAttrs(['thac0'], function(values) {
      setAttrs({ bab: 19 - values.thac0 });
    });
  });

  // Set saving throws, BAB, THAC0, HD, Next Level Experience
  on('change:level change:class change:monsterhitdice', function() {
    const classData = {
      "cleric": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 1500,    hd: "2d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 3000,    hd: "3d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 6000,    hd: "4d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 12000,   hd: "5d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 25000,   hd: "6d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 50000,   hd: "7d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 100000,  hd: "8d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 200000,  hd: "9d6",    bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 300000,  hd: "9d6+1",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 400000,  hd: "9d6+2",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 500000,  hd: "9d6+3",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 600000,  hd: "9d6+4",  bab:  7, thac0: 12, saves: [ 3,  5,  7,  8,  7] },
        { xp: 760000,  hd: "9d6+5",  bab:  7, thac0: 12, saves: [ 3,  5,  7,  8,  7] },
      ],
      "dwarf": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 2200,    hd: "2d8",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 4400,    hd: "3d8",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 8800,    hd: "4d8",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 17000,   hd: "5d8",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 35000,   hd: "6d8",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 70000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 140000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 270000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 400000,  hd: "9d8+3",  bab:  7, thac0: 12, saves: [ 2,  3,  4,  4,  6] },
        { xp: 530000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 2,  3,  4,  4,  6] },
        { xp: 660000,  hd: "9d8+9",  bab:  7, thac0: 12, saves: [ 2,  3,  4,  4,  6] },
      ],
      "elf": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 4000,    hd: "2d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 8000,    hd: "3d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 16000,   hd: "4d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 12] },
        { xp: 32000,   hd: "5d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 12] },
        { xp: 64000,   hd: "6d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 12] },
        { xp: 120000,  hd: "7d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 250000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 400000,  hd: "9d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 600000,  hd: "9d6+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8,  8] },
      ],
      "fighter": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 2000,    hd: "2d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 4000,    hd: "3d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 8000,    hd: "4d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 16000,   hd: "5d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 32000,   hd: "6d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 64000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 120000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 240000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 360000,  hd: "9d8+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 480000,  hd: "9d8+4",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 600000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 720000,  hd: "9d8+8",  bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
        { xp: 840000,  hd: "9d8+10", bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
      ],
      "halfling": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 2000,    hd: "2d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 4000,    hd: "3d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 8000,    hd: "4d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 16000,   hd: "5d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 32000,   hd: "6d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 64000,   hd: "7d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 120000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
      ],
      "magic-user": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 2500,    hd: "2d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 5000,    hd: "3d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 10000,   hd: "4d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 20000,   hd: "5d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 40000,   hd: "6d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 80000,   hd: "7d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 150000,  hd: "8d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 300000,  hd: "9d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 450000,  hd: "9d4+1",  bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 600000,  hd: "9d4+2",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 750000,  hd: "9d4+3",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 900000,  hd: "9d4+4",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 1050000, hd: "9d4+5",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
      ],
      "thief": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 1200,    hd: "2d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 2400,    hd: "3d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 4800,    hd: "4d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 9600,    hd: "5d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 20000,   hd: "6d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 40000,   hd: "7d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 80000,   hd: "8d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 160000,  hd: "9d4",    bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 280000,  hd: "9d4+2",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 400000,  hd: "9d4+4",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 520000,  hd: "9d4+6",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 640000,  hd: "9d4+8",  bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
        { xp: 760000,  hd: "9d4+10", bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
      ],
      "acrobat": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 1200,    hd: "2d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 2400,    hd: "3d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 4800,    hd: "4d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 9600,    hd: "5d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 20000,   hd: "6d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 40000,   hd: "7d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 80000,   hd: "8d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 160000,  hd: "9d4",    bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 280000,  hd: "9d4+2",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 400000,  hd: "9d4+4",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 520000,  hd: "9d4+6",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 640000,  hd: "9d4+8",  bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
        { xp: 760000,  hd: "9d4+10", bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
      ],
      "assassin": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 1500,    hd: "2d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 3000,    hd: "3d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 6000,    hd: "4d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 12000,   hd: "5d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 25000,   hd: "6d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 50000,   hd: "7d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 100000,  hd: "8d4",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 200000,  hd: "9d4",    bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 300000,  hd: "9d4+2",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 425000,  hd: "9d4+4",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 575000,  hd: "9d4+6",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 750000,  hd: "9d4+8",  bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
        { xp: 900000,  hd: "9d4+10", bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
      ],
      "barbarian": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [10, 13, 12, 15, 16] },
        { xp: 2500,    hd: "2d8",    bab:  0, thac0: 19, saves: [10, 13, 12, 15, 16] },
        { xp: 5000,    hd: "3d8",    bab:  0, thac0: 19, saves: [10, 13, 12, 15, 16] },
        { xp: 10000,   hd: "4d8",    bab:  2, thac0: 17, saves: [ 8, 11, 10, 13, 13] },
        { xp: 18500,   hd: "5d8",    bab:  2, thac0: 17, saves: [ 8, 11, 10, 13, 13] },
        { xp: 37000,   hd: "6d8",    bab:  2, thac0: 17, saves: [ 8, 11, 10, 13, 13] },
        { xp: 85000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 6,  9,  8, 10, 10] },
        { xp: 140000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 6,  9,  8, 10, 10] },
        { xp: 270000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 6,  9,  8, 10, 10] },
        { xp: 400000,  hd: "9d8+3",  bab:  7, thac0: 12, saves: [ 4,  7,  6,  8,  7] },
        { xp: 530000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 4,  7,  6,  8,  7] },
        { xp: 660000,  hd: "9d8+9",  bab:  7, thac0: 12, saves: [ 4,  7,  6,  8,  7] },
        { xp: 790000,  hd: "9d8+12", bab:  9, thac0: 10, saves: [ 3,  5,  4,  5,  5] },
        { xp: 920000,  hd: "9d8+15", bab:  9, thac0: 10, saves: [ 3,  5,  4,  5,  5] },
      ],
      "bard": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 2000,    hd: "2d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 4000,    hd: "3d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 8000,    hd: "4d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 16000,   hd: "5d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 32000,   hd: "6d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 64000,   hd: "7d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 120000,  hd: "8d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 240000,  hd: "9d6",    bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 360000,  hd: "9d6+2",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 480000,  hd: "9d6+4",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 600000,  hd: "9d6+6",  bab:  5, thac0: 14, saves: [10, 11,  9, 12, 10] },
        { xp: 720000,  hd: "9d6+8",  bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
        { xp: 840000,  hd: "9d6+10", bab:  7, thac0: 12, saves: [ 8,  9,  7, 10,  8] },
      ],
      "drow": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 12] },
        { xp: 4000,    hd: "2d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 12] },
        { xp: 8000,    hd: "3d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 12] },
        { xp: 16000,   hd: "4d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 10] },
        { xp: 32000,   hd: "5d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 10] },
        { xp: 64000,   hd: "6d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 10] },
        { xp: 120000,  hd: "7d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10,  8] },
        { xp: 250000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10,  8] },
        { xp: 400000,  hd: "9d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10,  8] },
        { xp: 600000,  hd: "9d6+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8,  6] },
      ],
      "druid": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 2000,    hd: "2d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 4000,    hd: "3d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 7500,    hd: "4d6",    bab:  0, thac0: 19, saves: [11, 12, 14, 16, 15] },
        { xp: 12500,   hd: "5d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 20000,   hd: "6d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 35000,   hd: "7d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 60000,   hd: "8d6",    bab:  2, thac0: 17, saves: [ 9, 10, 12, 14, 12] },
        { xp: 90000,   hd: "9d6",    bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 125000,  hd: "9d6+2",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 200000,  hd: "9d6+4",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 300000,  hd: "9d6+6",  bab:  5, thac0: 14, saves: [ 6,  7,  9, 11,  9] },
        { xp: 750000,  hd: "9d6+8",  bab:  7, thac0: 12, saves: [ 3,  5,  7,  8,  7] },
        { xp: 1500000, hd: "9d6+10", bab:  7, thac0: 12, saves: [ 3,  5,  7,  8,  7] },
      ],
      "duergar": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 2800,    hd: "2d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 5600,    hd: "3d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 13, 12] },
        { xp: 11200,   hd: "4d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 23000,   hd: "5d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 46000,   hd: "6d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 10, 10] },
        { xp: 100000,  hd: "7d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 200000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 300000,  hd: "9d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  7,  8] },
        { xp: 400000,  hd: "9d6+3",  bab:  7, thac0: 12, saves: [ 2,  3,  4,  4,  6] },
      ],
      "gnome": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 3000,    hd: "2d4",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 6000,    hd: "3d4",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 12000,   hd: "4d4",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 30000,   hd: "5d4",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 60000,   hd: "6d4",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
        { xp: 120000,  hd: "7d4",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
        { xp: 240000,  hd: "8d4",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
      ],
      "half-elf": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 2500,    hd: "2d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 5000,    hd: "3d6",    bab:  0, thac0: 19, saves: [12, 13, 13, 15, 15] },
        { xp: 10000,   hd: "4d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 11] },
        { xp: 20000,   hd: "5d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 11] },
        { xp: 40000,   hd: "6d6",    bab:  2, thac0: 17, saves: [10, 11, 11, 13, 11] },
        { xp: 80000,   hd: "7d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 150000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 300000,  hd: "9d6",    bab:  5, thac0: 14, saves: [ 8,  9,  9, 10, 10] },
        { xp: 450000,  hd: "9d6+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8,  8] },
        { xp: 600000,  hd: "9d6+4",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8,  8] },
        { xp: 750000,  hd: "9d6+6",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8,  8] },
      ],
      "half-orc": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 1800,    hd: "2d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 3600,    hd: "3d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 7000,    hd: "4d6",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 14000,   hd: "5d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 28000,   hd: "6d6",    bab:  2, thac0: 17, saves: [12, 13, 11, 14, 13] },
        { xp: 60000,   hd: "7d6",    bab:  5, thac0: 14, saves: [12, 13, 11, 14, 13] },
        { xp: 120000,  hd: "8d6",    bab:  5, thac0: 14, saves: [12, 13, 11, 14, 13] },
      ],
      "illusionist": [
        { xp: 0,       hd: "1d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 2500,    hd: "2d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 5000,    hd: "3d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 10000,   hd: "4d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 20000,   hd: "5d4",    bab:  0, thac0: 19, saves: [13, 14, 13, 16, 15] },
        { xp: 40000,   hd: "6d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 80000,   hd: "7d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 150000,  hd: "8d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 300000,  hd: "9d4",    bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 450000,  hd: "9d4+1",  bab:  2, thac0: 17, saves: [11, 12, 11, 14, 12] },
        { xp: 600000,  hd: "9d4+2",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 750000,  hd: "9d4+3",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 900000,  hd: "9d4+4",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
        { xp: 1050000, hd: "9d4+5",  bab:  5, thac0: 14, saves: [ 8,  9,  8, 11,  8] },
      ],
      "knight": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 2500,    hd: "2d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 5000,    hd: "3d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 10000,   hd: "4d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 18500,   hd: "5d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 37000,   hd: "6d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 85000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 140000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 270000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 400000,  hd: "9d8+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 530000,  hd: "9d8+4",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 660000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 790000,  hd: "9d8+8",  bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
        { xp: 920000,  hd: "9d8+10", bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
      ],
      "paladin": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [10, 11, 12, 13, 14] },
        { xp: 2750,    hd: "2d8",    bab:  0, thac0: 19, saves: [10, 11, 12, 13, 14] },
        { xp: 5500,    hd: "3d8",    bab:  0, thac0: 19, saves: [10, 11, 12, 13, 14] },
        { xp: 12000,   hd: "4d8",    bab:  2, thac0: 17, saves: [ 8,  9, 10, 11, 12] },
        { xp: 24000,   hd: "5d8",    bab:  2, thac0: 17, saves: [ 8,  9, 10, 11, 12] },
        { xp: 45000,   hd: "6d8",    bab:  2, thac0: 17, saves: [ 8,  9, 10, 11, 12] },
        { xp: 95000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 6,  7,  8,  8, 10] },
        { xp: 175000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 6,  7,  8,  8, 10] },
        { xp: 350000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 6,  7,  8,  8, 10] },
        { xp: 500000,  hd: "9d8+2",  bab:  7, thac0: 12, saves: [ 4,  5,  6,  6,  8] },
        { xp: 650000,  hd: "9d8+4",  bab:  7, thac0: 12, saves: [ 4,  5,  6,  6,  8] },
        { xp: 800000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 4,  5,  6,  6,  8] },
        { xp: 950000,  hd: "9d8+8",  bab:  9, thac0: 10, saves: [ 2,  3,  4,  3,  6] },
        { xp: 1100000, hd: "9d8+10", bab:  9, thac0: 10, saves: [ 2,  3,  4,  3,  6] },
      ],
      "ranger": [
        { xp: 0,       hd: "1d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 2250,    hd: "2d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 4500,    hd: "3d8",    bab:  0, thac0: 19, saves: [12, 13, 14, 15, 16] },
        { xp: 10000,   hd: "4d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 20000,   hd: "5d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 40000,   hd: "6d8",    bab:  2, thac0: 17, saves: [10, 11, 12, 13, 14] },
        { xp: 90000,   hd: "7d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 150000,  hd: "8d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 300000,  hd: "9d8",    bab:  5, thac0: 14, saves: [ 8,  9, 10, 10, 12] },
        { xp: 425000,  hd: "9d8+2",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 550000,  hd: "9d8+4",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 675000,  hd: "9d8+6",  bab:  7, thac0: 12, saves: [ 6,  7,  8,  8, 10] },
        { xp: 800000,  hd: "9d8+8",  bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
        { xp: 925000,  hd: "9d8+10", bab:  9, thac0: 10, saves: [ 4,  5,  6,  5,  8] },
      ],
      "svirfneblin": [
        { xp: 0,       hd: "1d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 2400,    hd: "2d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 4800,    hd: "3d6",    bab:  0, thac0: 19, saves: [ 8,  9, 10, 14, 11] },
        { xp: 10000,   hd: "4d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
        { xp: 20000,   hd: "5d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
        { xp: 40000,   hd: "6d6",    bab:  2, thac0: 17, saves: [ 6,  7,  8, 11,  9] },
        { xp: 80000,   hd: "7d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  9,  7] },
        { xp: 160000,  hd: "8d6",    bab:  5, thac0: 14, saves: [ 4,  5,  6,  9,  7] },
      ],
      "normal human": [
        { xp: 0,       hd: "2",      bab: -1, thac0: 20, saves: [14, 15, 16, 17, 18] },
      ],
      "monster": [
        { bab:  0,  thac0: 19, saves: [12, 13, 14, 15, 16] }, // 1
        { bab:  1,  thac0: 18, saves: [12, 13, 14, 15, 16] }, // 2
        { bab:  2,  thac0: 17, saves: [12, 13, 14, 15, 16] }, // 3
        { bab:  3,  thac0: 16, saves: [10, 11, 12, 13, 14] }, // 4
        { bab:  4,  thac0: 15, saves: [10, 11, 12, 13, 14] }, // 5
        { bab:  5,  thac0: 14, saves: [10, 11, 12, 13, 14] }, // 6
        { bab:  6,  thac0: 13, saves: [ 8,  9, 10, 10, 12] }, // 7
        { bab:  7,  thac0: 12, saves: [ 8,  9, 10, 10, 12] }, // 8
        { bab:  7,  thac0: 12, saves: [ 8,  9, 10, 10, 12] }, // 9
        { bab:  8,  thac0: 11, saves: [ 6,  7,  8,  8, 10] }, // 10
        { bab:  8,  thac0: 11, saves: [ 6,  7,  8,  8, 10] }, // 11
        { bab:  9,  thac0: 10, saves: [ 6,  7,  8,  8, 10] }, // 12
        { bab:  9,  thac0: 10, saves: [ 4,  5,  6,  5,  8] }, // 13
        { bab: 10,  thac0:  9, saves: [ 4,  5,  6,  5,  8] }, // 14
        { bab: 10,  thac0:  9, saves: [ 4,  5,  6,  5,  8] }, // 15
        { bab: 11,  thac0:  8, saves: [ 2,  3,  4,  3,  6] }, // 16
        { bab: 11,  thac0:  8, saves: [ 2,  3,  4,  3,  6] }, // 17
        { bab: 12,  thac0:  7, saves: [ 2,  3,  4,  3,  6] }, // 18
        { bab: 12,  thac0:  7, saves: [ 2,  2,  2,  2,  4] }, // 19
        { bab: 13,  thac0:  6, saves: [ 2,  2,  2,  2,  4] }, // 20
        { bab: 13,  thac0:  6, saves: [ 2,  2,  2,  2,  4] }, // 21
        { bab: 14,  thac0:  5, saves: [ 2,  2,  2,  2,  2] }, // 22+
      ]
    };

    getAttrs(["level", "class", "monsterHitDice"], function(values) {
      const charClass = values.class.toLowerCase();

      // Do not modify if using custom class
      if (charClass === "custom") return;

      const level = parseInt(values.level, 10);
      const monsterHitDice = Math.ceil(values.monsterHitDice); // Round up

      if (charClass === "monster" && Number.isInteger(monsterHitDice)) {
        // Ensure we always use the highest saves and such for HD 22+
        const clampedMonsterHitDice =
          monsterHitDice > 22 ? 22 : monsterHitDice;
        const { bab, thac0, saves } = classData["monster"][clampedMonsterHitDice - 1];
        setAttrs({
          monsterBab: bab,
          monsterThac0: thac0,
          saveD: saves[0],
          saveW: saves[1],
          saveP: saves[2],
          saveB: saves[3],
          saveS: saves[4]
        })
      } else if (charClass === "normal human") {
        const { hd, bab, thac0, saves } = classData["normal human"][0];
        setAttrs({
          hd: hd,
          bab: bab,
          thac0: thac0,
          saveD: saves[0],
          saveW: saves[1],
          saveP: saves[2],
          saveB: saves[3],
          saveS: saves[4]
        })
      } else if (classData[charClass] && classData[charClass][level - 1]) {
        const nextXp = classData[charClass][level] ? classData[charClass][level].xp : "";
        const { hd, bab, thac0, saves } = classData[charClass][level - 1];
        setAttrs({
          Next: nextXp,
          hd: hd,
          bab: bab,
          thac0: thac0,
          saveD: saves[0],
          saveW: saves[1],
          saveP: saves[2],
          saveB: saves[3],
          saveS: saves[4]
        });
      }
    });
  });

  // Show/hide Roll/Describe buttons for spells
  on("change:repeating_spells:spellEffect", function(eventInfo) {
    if (eventInfo.newValue && eventInfo.newValue !== "") {
      setAttrs({ repeating_spells_spellRollType: "roll" })
    } else {
      setAttrs({ repeating_spells_spellRollType: "describe" })
    }
  })

  // Set roll buttons for spells depending on effect having a value
  on("sheet:opened", function () {
    getSectionIDs("repeating_spells", function(idArray) {
      idArray.forEach(function(id) {
        getAttrs([`repeating_spells_${id}_spellEffect`], function(values) {
          if (values[`repeating_spells_${id}_spellEffect`] !== "") {
            setAttrs({ [`repeating_spells_${id}_spellRollType`]: "roll" })
          } else {
            setAttrs({ [`repeating_spells_${id}_spellRollType`]: "describe" })
          }
        });
      });
    });
  });

  on("sheet:opened change:class", function() {
    getAttrs(["class"], function(values) {
      if (['monster', 'normal human', 'custom'].indexOf(values.class.toLowerCase()) >= 0) {
        setAttrs({ savesAs: "monster" })
      } else {
        setAttrs({ savesAs: "character" })
      }
    })
  })
</script>
