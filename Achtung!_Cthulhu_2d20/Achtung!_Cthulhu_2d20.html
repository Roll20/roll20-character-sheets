<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="main_char" />
<div>
  <button type="action" class="tab_button" id="act_main_char" name="act_main_char">
    Main
  </button>
  <button type="action" class="tab_button" id="act_equipment" name="act_equipment">
    Equipment/Talents
  </button>
  <button type="action" class="tab_button" id="act_spells" name="act_spells">
    Spells
  </button>
  <button type="action" class="tab_button settings_button" id="act_settings" name="act_settings">
    settings
  </button>
</div>

<div class="sheet-main_char">
  <section class="mc_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="common f-row wrap">
    <div>
      <label>Name:</label>
      <input name="attr_character_name" type="text" style="width: 350px" />
    </div>
    <div>
      <label>Nationality:</label>
      <input name="attr_nationality" type="text" style="width: 200px" />
    </div>
    <div>
      <label>Rank:</label>
      <input name="attr_rank" type="text" style="width: 200px" />
    </div>
    <div>
      <label>Archetype:</label>
      <input name="attr_archetype" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Background:</label>
      <input name="attr_background" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Characteristic:</label>
      <input name="attr_characteristic" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Personal Truths & Scars:</label>
      <div class="f-row nowrap truth_text">
        <textarea name="attr_truth_1"></textarea>
        <textarea name="attr_truth_2"></textarea>
        <textarea name="attr_truth_3"></textarea>
        <textarea name="attr_truth_4"></textarea>
        <textarea name="attr_truth_5"></textarea>
      </div>
    </div>
  </section>

  <section class="stress">
    <div>
      <div class="nowrap">
        <label>Stress:</label>
      </div>
      <div class="f-row nowrap">
        <span class="f1 stress_sublabel">Attributes:</span>
        <span class="f1 stress_sublabel">Bonus:</span>
        <span class="f1 stress_sublabel">Fatigue:</span>
        <span class="f1 stress_sublabel">Total:</span>
      </div>
      <div class="f-row nowrap">
        <div class="f1">
          <input type="number" id="attr_stress_attributes" name="attr_stress_attributes" value="0" />
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_bonus" name="attr_stress_bonus" value="0" />
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_fatigue" name="attr_stress_fatigue" value="0" />
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_total" name="attr_stress_total" value="0" />
        </div>
      </div>
      <div class="stress_box_row">
        <input name="attr_stress_1" id="attr_stress_1" type="checkbox" />
        <input name="attr_stress_2" id="attr_stress_2" type="checkbox" />
        <input name="attr_stress_3" id="attr_stress_3" type="checkbox" />
        <input name="attr_stress_4" id="attr_stress_4" type="checkbox" />
        <input name="attr_stress_5" id="attr_stress_5" type="checkbox" />
        <input name="attr_stress_6" id="attr_stress_6" type="checkbox" />
        <input name="attr_stress_7" id="attr_stress_7" type="checkbox" />
        <input name="attr_stress_8" id="attr_stress_8" type="checkbox" />
        <input name="attr_stress_9" id="attr_stress_9" type="checkbox" />
        <input name="attr_stress_10" id="attr_stress_10" type="checkbox" />
      </div>
      <div class="stress_box_row">
        <input name="attr_stress_11" id="attr_stress_11" type="checkbox" />
        <input name="attr_stress_12" id="attr_stress_12" type="checkbox" />
        <input name="attr_stress_13" id="attr_stress_13" type="checkbox" />
        <input name="attr_stress_14" id="attr_stress_14" type="checkbox" />
        <input name="attr_stress_15" id="attr_stress_15" type="checkbox" />
        <input name="attr_stress_16" id="attr_stress_16" type="checkbox" />
        <input name="attr_stress_17" id="attr_stress_17" type="checkbox" />
        <input name="attr_stress_18" id="attr_stress_18" type="checkbox" />
        <input name="attr_stress_19" id="attr_stress_19" type="checkbox" />
        <input name="attr_stress_20" id="attr_stress_20" type="checkbox" />
      </div>
    </div>
    <div>
      <label>Languages:</label>
      <textarea style="margin-top: 3px;" name="attr_lnaguages"></textarea>
    </div>
  </section>

  <section class="soak f-col nowrap">
    <div style="display: inline-flex">
      <div>
        <label>Fortune</label>
        <input type="number" name="attr_fortune" value="3" />
      </div>
      <div>
        <label>Exp</label>
        <input type="number" name="attr_exp" value="0" />
      </div>
    </div>
    <div style="display: inline-flex">
      <div>
        <label>Courage</label>
        <input type="number" name="attr_courage" value="0" />
      </div>
      <div>
        <label>Armour</label>
        <input type="number" name="attr_armour" value="0" />
      </div>
    </div>
  </section>

  <section class="injuries">
    <label>Injuries:</label>
    <div class="f-row nowrap">
      <textarea name="attr_injury_1"></textarea>
      <textarea name="attr_injury_2"></textarea>
      <textarea name="attr_injury_3"></textarea>
    </div>
  </section>

  <section class="attr f-row nowrap">
    <div class="f-col">
      <h3>Attributes</h3>
      <label>Rating</label>
      <label>Bonus Damage</label>
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Agility</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_agility" value="@{agility_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_agility-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_agility_action" value="">
      </span>
      <input type="number" id="attr_agility" name="attr_agility" value="6" min="0" max="20" />
      <input type="number" name="attr_agility_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Brawn</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_brawn" value="@{brawn_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_brawn-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_brawn_action" value="">
      </span>
      <input type="number" id="attr_brawn" name="attr_brawn" value="6" min="0" max="20" />
      <input type="number" name="attr_brawn_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Coordination</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_coordination" value="@{coordination_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_coordination-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_coordination_action" value="">
      </span>
      <input type="number" id="attr_coordination" name="attr_coordination" value="6" min="0" max="20" />
      <input type="number" name="attr_coordination_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Insight</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_insight" value="@{insight_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_insight-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_insight_action" value="">
      </span>
      <input type="number" id="attr_insight" name="attr_insight" value="6" min="0" max="20" />
      <input type="number" name="attr_insight_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Reason</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_reason" value="@{reason_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_reason-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_reason_action" value="">
      </span>
      <input type="number" id="attr_reason" name="attr_reason" value="6" min="0" max="20" />
      <input type="number" name="attr_reason_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Will</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_will" value="@{will_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_will-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_will_action" value="">
      </span>
      <input type="number" id="attr_will" name="attr_will" value="6" min="0" max="20" />
      <input type="number" name="attr_will_bonus_dmg" value="0" />
    </div>
  </section>

  <section class="skills f-col">
    <div class="f-row">
      <h3 class="f2">Skills</h3>
      <label class="f1">Ranks</label>
      <label class="f8">Focuses</label>
    </div>
    <div class="f-row">
      <label class="f2">Academia</label>
      <input class="f1" type="number" id="attr_skill_academia" name="attr_skill_academia" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div><input name="attr_foc_art" type="checkbox" /><span>Art</span></div>
        <div>
          <input name="attr_foc_cryptography" type="checkbox" /><span>Cryptography</span>
        </div>
        <div>
          <input name="attr_foc_finance" type="checkbox" /><span>Finance</span>
        </div>
        <div>
          <input name="attr_foc_history" type="checkbox" /><span>History</span>
        </div>
        <div>
          <input name="attr_foc_linguistics" type="checkbox" /><span>Linguistics</span>
        </div>
        <div>
          <input name="attr_foc_occultism" type="checkbox" /><span>Occultism</span>
        </div>
        <div>
          <input name="attr_foc_science" type="checkbox" /><span>Science</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Athletics</label>
      <input class="f1" type="number" id="attr_skill_athletics" name="attr_skill_athletics" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_climbing" type="checkbox" /><span>Climbing</span>
        </div>
        <div>
          <input name="attr_foc_lifting" type="checkbox" /><span>Lifting</span>
        </div>
        <div>
          <input name="attr_foc_phsyical_training" type="checkbox" /><span>Phsyical Training</span>
        </div>
        <div>
          <input name="attr_foc_running" type="checkbox" /><span>Running</span>
        </div>
        <div>
          <input name="attr_foc_swimming" type="checkbox" /><span>Swimming</span>
        </div>
        <div>
          <input name="attr_foc_throwing" type="checkbox" /><span>Throwing</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Engineering</label>
      <input class="f1" type="number" id="attr_skill_engineering" name="attr_skill_engineering" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_architecture" type="checkbox" /><span>Architecture</span>
        </div>
        <div>
          <input name="attr_foc_combat_engineering" type="checkbox" /><span>Combat Engineering</span>
        </div>
        <div>
          <input name="attr_foc_electronics" type="checkbox" /><span>Electronics</span>
        </div>
        <div>
          <input name="attr_foc_explosives" type="checkbox" /><span>Explosives</span>
        </div>
        <div>
          <input name="attr_foc_mechanical_engineering" type="checkbox" /><span>Mechanical Engineering</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Fighting</label>
      <input class="f1" type="number" id="attr_skill_fighting" name="attr_skill_fighting" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_close_quarters" type="checkbox" /><span>Close Quarters</span>
        </div>
        <div>
          <input name="attr_foc_handguns" type="checkbox" /><span>Handguns</span>
        </div>
        <div>
          <input name="attr_foc_hand_to_hand" type="checkbox" /><span>Hand-to-Hand</span>
        </div>
        <div>
          <input name="attr_foc_heavy_weapons" type="checkbox" /><span>Heavy Weapons</span>
        </div>
        <div>
          <input name="attr_foc_melee_weapons" type="checkbox" /><span>Melee Weapons</span>
        </div>
        <div>
          <input name="attr_foc_rifles" type="checkbox" /><span>Rifles</span>
        </div>
        <div>
          <input name="attr_foc_threat_awareness" type="checkbox" /><span>Threat Awareness</span>
        </div>
        <div>
          <input name="attr_foc_exotic" type="checkbox" /><span>Exotic</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Medicine</label>
      <input class="f1" type="number" id="attr_skill_medicine" name="attr_skill_medicine" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_close_first_aid" type="checkbox" /><span>First Aid</span>
        </div>
        <div>
          <input name="attr_foc_infectious_diseases" type="checkbox" /><span>Infectious Diseases</span>
        </div>
        <div>
          <input name="attr_foc_pharmacology" type="checkbox" /><span>Pharmacology</span>
        </div>
        <div>
          <input name="attr_foc_psychiarty" type="checkbox" /><span>Psychiarty</span>
        </div>
        <div>
          <input name="attr_foc_surgey" type="checkbox" /><span>Surgey</span>
        </div>
        <div>
          <input name="attr_foc_toxicology" type="checkbox" /><span>Toxicology</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Observation</label>
      <input class="f1" type="number" id="attr_skill_observation" name="attr_skill_observation" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_hearing" type="checkbox" /><span>Hearing</span>
        </div>
        <div>
          <input name="attr_foc_instincts" type="checkbox" /><span>Instincts</span>
        </div>
        <div>
          <input name="attr_foc_sight" type="checkbox" /><span>Sight</span>
        </div>
        <div>
          <input name="attr_foc_smell_and_taste" type="checkbox" /><span>Smell and Taste</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Persuasion</label>
      <input class="f1" type="number" id="attr_skill_persuasion" name="attr_skill_persuasion" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_charm" type="checkbox" /><span>Charm</span>
        </div>
        <div>
          <input name="attr_foc_inneuendo" type="checkbox" /><span>Inneuendo</span>
        </div>
        <div>
          <input name="attr_foc_intimidation" type="checkbox" /><span>Intimidation</span>
        </div>
        <div>
          <input name="attr_foc_negotiation" type="checkbox" /><span>Negotiation</span>
        </div>
        <div>
          <input name="attr_foc_rhetoric" type="checkbox" /><span>Rhetoric</span>
        </div>
        <div>
          <input name="attr_foc_deceive" type="checkbox" /><span>Deceive</span>
        </div>
        <div>
          <input name="attr_foc_invocation" type="checkbox" /><span>Invocation</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Resilience</label>
      <input class="f1" type="number" id="attr_skill_resilience" name="attr_skill_resilience" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_fortitude" type="checkbox" /><span>Fortitude</span>
        </div>
        <div>
          <input name="attr_foc_discipline" type="checkbox" /><span>Discipline</span>
        </div>
        <div>
          <input name="attr_foc_immunity" type="checkbox" /><span>Immunity</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Stealth</label>
      <input class="f1" type="number" id="attr_skill_stealth" name="attr_skill_stealth" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_camouflage" type="checkbox" /><span>Camouflage</span>
        </div>
        <div>
          <input name="attr_foc_disguise" type="checkbox" /><span>Disguise</span>
        </div>
        <div>
          <input name="attr_foc_rural_stealth" type="checkbox" /><span>Rural Stealth</span>
        </div>
        <div>
          <input name="attr_foc_urban_stealth" type="checkbox" /><span>Urban Stealth</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Survival</label>
      <input class="f1" type="number" id="attr_skill_survival" name="attr_skill_survival" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_animal_handling" type="checkbox" /><span>Animal Handling</span>
        </div>
        <div>
          <input name="attr_foc_foraging" type="checkbox" /><span>Foraging</span>
        </div>
        <div>
          <input name="attr_foc_hunting" type="checkbox" /><span>Hunting</span>
        </div>
        <div>
          <input name="attr_foc_mysticism" type="checkbox" /><span>Mysticism</span>
        </div>
        <div>
          <input name="attr_foc_orienteering" type="checkbox" /><span>Orienteering</span>
        </div>
        <div>
          <input name="attr_foc_tracking" type="checkbox" /><span>Tracking</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Tactics</label>
      <input class="f1" type="number" id="attr_skill_tactics" name="attr_skill_tactics" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_air_force" type="checkbox" /><span>Air Force</span>
        </div>
        <div>
          <input name="attr_foc_army" type="checkbox" /><span>Army</span>
        </div>
        <div>
          <input name="attr_foc_covert_operations" type="checkbox" /><span>Covert Operations</span>
        </div>
        <div>
          <input name="attr_foc_leadership" type="checkbox" /><span>Leadership</span>
        </div>
        <div>
          <input name="attr_foc_navy" type="checkbox" /><span>Navy</span>
        </div>
        <div>
          <input name="attr_foc_technical_projects" type="checkbox" /><span>Technical Projects</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Vehicles</label>
      <input class="f1" type="number" id="attr_skill_vehicles" name="attr_skill_vehicles" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_cars" type="checkbox" /><span>Cars</span>
        </div>
        <div>
          <input name="attr_foc_motorcycles" type="checkbox" /><span>Motorcycles</span>
        </div>
        <div>
          <input name="attr_foc_heavy_vehicles" type="checkbox" /><span>Heavy Vehicles</span>
        </div>
        <div>
          <input name="attr_foc_tanks" type="checkbox" /><span>Tanks</span>
        </div>
        <div>
          <input name="attr_foc_aircraft" type="checkbox" /><span>Aircraft</span>
        </div>
        <div>
          <input name="attr_foc_technical_watercraft" type="checkbox" /><span>Watercraft</span>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sheet-equipment">
  <section class="e_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="equip f-col">
    <div class="f-row">
      <h3>Equipment of Note</h3>
    </div>
    <hr>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_1"></textarea>
      <textarea class="f1" name="attr_equip_desc_2"></textarea>
      <textarea class="f1" name="attr_equip_desc_3"></textarea>
      <textarea class="f1" name="attr_equip_desc_4"></textarea>
    </div>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_5"></textarea>
      <textarea class="f1" name="attr_equip_desc_6"></textarea>
      <textarea class="f1" name="attr_equip_desc_7"></textarea>
      <textarea class="f1" name="attr_equip_desc_8"></textarea>
    </div>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_9"></textarea>
      <textarea class="f1" name="attr_equip_desc_10"></textarea>
      <textarea class="f1" name="attr_equip_desc_11"></textarea>
      <textarea class="f1" name="attr_equip_desc_12"></textarea>
    </div>
  </section>

  <section class="weapons f-col">
    <div class="f-row">
      <h3>Weapons</h3>
    </div>
    <hr>

    <fieldset class="repeating_weapons">
      <div class="f-row weapons_row1">
        <div class="f1 weapons-chat">
          <button type="roll" name="roll_weapon" class="chat_button"
            value="@{whisper}&{template:weapon} {{title=@{character_name}}} {{name=@{weapons_name}}} {{type=@{weapons_type}}} {{focus=@{weapons_focus}}} {{range=@{weapons_range}}} {{damage=@{weapons_damage}}} {{ammo=@{weapons_ammo}}} {{salvo=@{weapons_salvo}}} {{size=@{weapons_size}}} {{qualities=@{weapons_qualities}}}"></button>
          <!-- The visible and draggable button for the macro bar -->
          <button type="roll" name="roll_attack" value="@{attack_action}"></button>
          <!-- The invisible button allowing the use of custom roll parsing -->
          <button type="action" name="act_attack-action" class="hidden"></button>
          <!-- The invisible field for the attribute which contains the ability call -->
          <input type="hidden" name="attr_attack_action" value="">
        </div>
        <div class="f8">
          <label>Name:</label>
          <input name="attr_weapons_name" type="text" style="width: 250px" />
        </div>
        <div class="f6">
          <label>Type:</label>
          <select name="attr_weapons_type">
            <option value="None" selected></option>
            <option value="Melee">Melee</option>
            <option value="Ranged">Ranged</option>
            <option value="Mental">Mental</option>
          </select>
        </div>
        <div class="f6">
          <label>Focus:</label>
          <select name="attr_weapons_focus">
            <option value="None" selected></option>
            <option value="Hand to Hand">Hand to Hand</option>
            <option value="Close Quarters">Close Quarters</option>
            <option value="Melee Weapons">Melee Weapons</option>
            <option value="Handguns">Handguns</option>
            <option value="Rifles">Rifles</option>
            <option value="Heavy Weapons">Heavy Weapons</option>
            <option value="Exotic">Exotic</option>
            <option value="Throwing">Throwing</option>
          </select>
        </div>
      </div>
      <div class="f-row weapons_row2">
        <div class="f1">
          <label>Range</label>
          <textarea name="attr_weapons_range"></textarea>
        </div>
        <div class="f1">
          <label>Damage</label>
          <textarea name="attr_weapons_damage"></textarea>
        </div>
        <div class="f1">
          <label>Ammo</label>
          <textarea name="attr_weapons_ammo"></textarea>
        </div>
        <div class="f1">
          <label>Salvo</label>
          <textarea name="attr_weapons_salvo"></textarea>
        </div>
        <div class="f1">
          <label>Size</label>
          <textarea name="attr_weapons_size"></textarea>
        </div>
        <div class="f1">
          <label>Qualities</label>
          <textarea name="attr_weapons_qualities"></textarea>
        </div>
      </div>
      <hr>
    </fieldset>
  </section>

  <section class="talents f-col">
    <div class="f-row">
      <h3>Talents</h3>
    </div>
    <hr>

    <div class="f-row">
      <span class="f1">&nbsp;</span>
      <label class="f3">Name</label>
      <label class="f3">Keywords</label>
      <label class="f12">Effect</label>
    </div>

    <fieldset class="repeating_talents">
      <div class="f-row talent_row">
        <div class="f1 talents-chat">
          <button type="roll" name="roll_talent" class="chat_button"
            value="@{whisper}&{template:talent} {{title=@{character_name}}} {{name=@{talents_name}}} {{keywords=@{talents_keywords}}} {{effect=@{talents_effect}}}"></button>
        </div>
        <textarea class="f3" name="attr_talents_name"></textarea>
        <textarea class="f3" name="attr_talents_keywords"></textarea>
        <textarea class="f12" name="attr_talents_effect"></textarea>
      </div>
    </fieldset>
  </section>
</div>

<div class="sheet-spells">
  <section class="s_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="magic f-col">
    <div class="f-row">
      <div class="f3">
        <label>Spellcaster Type</label>
        <select name="attr_spell_skill">
          <option value="None" selected></option>
          <option value="Traditional">Traditional</option>
          <option value="Researcher">Researcher</option>
          <option value="Dabbler">Dabbler</option>
        </select>
      </div>
      <span id="NoTradition" name="NoTradition" class="f4">&nbsp;</span>
      <div id="YesTradition" name="YesTradition" class="f4 hide_element">
        <label>Tradition</label>
        <input name="attr_spell_tradition" type="text" style="width: 150px" />
      </div>
      <div class="f2">
        <label>Power</label>
        <input type="number" name="attr_spells_power" value="0" />
      </div>
    </div>
  </section>

  <section class="spells f-col">
    <div class="f-row">
      <h3>Spells</h3>
    </div>
    <hr>

    <fieldset class="repeating_spells">
      <div class="f-row spell_row1">
        <div class="f1 spells-chat">
          <span style="display: block">&nbsp;</span>
          <button type="roll" name="roll_spell" class="chat_button"
            value="@{whisper}&{template:spell} {{title=@{character_name}}} {{name=@{spell_name}}} {{skill=@{spell_skill}}} {{difficulty=@{spell_difficulty}}} {{cost=@{spell_cost}}} {{duration=@{spell_duration}}} {{effect=@{spell_effect}}} {{momentum=@{spell_momentum}}}"></button>
        </div>
        <div class="f8">
          <label>Name:</label>
          <input name="attr_spell_name" type="text" style="width: 200px" />
        </div>
        <div class="f4">
          <label>Skill:</label>
          <select name="attr_spell_skill">
            <option value="None" selected></option>
            <option value="Academia">Academia</option>
            <option value="Athletics">Athletics</option>
            <option value="Engineering">Engineering</option>
            <option value="Fighting">Fighting</option>
            <option value="Medicine">Medicine</option>
            <option value="Observation">Observation</option>
            <option value="Persuasion">Persuasion</option>
            <option value="Resilience">Resilience</option>
            <option value="Stealth">Stealth</option>
            <option value="Survival">Survival</option>
            <option value="Tactics">Tactics</option>
            <option value="Vehicles">Vehicles</option>
          </select>
        </div>
        <div class="f4">
          <label>Difficulty</label>
          <input type="number" name="attr_spell_difficulty" value="0" />
        </div>
        <div class="f4">
          <label>Cost</label>
          <input name="attr_spell_cost" type="text" style="width: 100px" />
        </div>
        <div class="f4">
          <label>Duration</label>
          <input name="attr_spell_duration" type="text" style="width: 100px" />
        </div>
      </div>
      <div class="f-row spell_row2">
        <div class="f1">
          <label>Effect</label>
          <textarea name="attr_spell_effect"></textarea>
        </div>
        <div class="f1">
          <label>Momentum</label>
          <textarea name="attr_spell_momentum"></textarea>
        </div>
      </div>
      <hr>
    </fieldset>
  </section>
</div>

<div class="sheet-settings">
  <section class="st_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="settings_left f-col">
    <div>
      <label>Whisper roles to GM:</label>
      <select name="attr_whisper">
        <option value="" selected>Never</option>
        <option value="/w gm ">Always</option>
      </select>
    </div>
  </section>

  <section class="settings_right f-col">
  </section>
</div>

<!-- roll templates -->
<rolltemplate class="sheet-rolltemplate-skill">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#subtitle}}
      <div class="sheet-subtitle">{{subtitle}}</div>
      {{/subtitle}}
      {{#description}}
      <div class="sheet-description">{{description}}</div>
      {{/description}}
    </div>
    <div class="sheet-result">
      {{#rollTotal() computed::outcome 1}}
      <div class="sheet-success">Success!</div>
      {{/rollTotal() computed::outcome 1}}
      {{#rollTotal() computed::outcome 0}}
      <div class="sheet-failure">Failure!</div>
      {{/rollTotal() computed::outcome 0}}
    </div>
    <div class="sheet-content">
      <span>Dice rolled:</span>
      <span class="sheet-roll-bold-highlight">{{computed::roll1}}</span>
      <span>Number of successes:</span>
      <span class="sheet-roll-bold">{{computed::successes}}</span>
      <span>Bonus momentum:</span>
      <span class="sheet-roll-bold">{{computed::bonus_momentum}}</span>
      <span>Number of complications:</span>
      <span class="sheet-roll-bold">{{computed::complications}}</span>
    </div>
    <div class="sheet-show-details">
      Show Details
    </div>
    <div class="sheet-details-wrapper">
      <div class="sheet-details">
        <span class="sheet-roll-normal-nopad">{{computed::attribute_text}} value is:</span>
        <span class="sheet-roll-normal">{{computed::target_attribute}}</span>
        <span class="sheet-roll-normal-nopad">{{computed::skill_text}} value is:</span>
        <span class="sheet-roll-normal">{{computed::target_skill}}</span>
        <span>Target number is:</span>
        <span class="sheet-roll-normal">{{computed::target_number}}</span>
        {{#rollTotal() computed::focus_apply 0}}
        <span>Does a focus apply:</span>
        <span class="sheet-roll-normal">No</span>
        {{/rollTotal() computed::focus_apply 0}}
        {{#rollTotal() computed::focus_apply 1}}
        <span>Does a focus apply:</span>
        <span class="sheet-roll-normal">Yes</span>
        {{/rollTotal() computed::focus_apply 1}}
        <span>Difficulty is:</span>
        <span class="sheet-roll-normal">{{computed::difficulty}}</span>
        <span>Crit range is:</span>
        <span class="sheet-roll-normal">{{computed::crit_range}}</span>
        <span>Normal success is:</span>
        <span class="sheet-roll-normal">{{computed::success_range}}</span>
        <span>Complication range is:</span>
        <span class="sheet-roll-normal">{{computed::complication_range}}</span>
        <span>Dice rolled:</span>
        <span class="sheet-roll-normal">{{computed::dice_text}}</span>
      </div>
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-talent">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
      {{#keywords}}
      <div class="sheet-keywords">{{keywords}}</div>
      {{/keywords}}
    </div>
    <div class="sheet-content">
      <div>{{effect}}</div>
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-spell">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
    </div>
    <div class="sheet-content">
      {{#skill}}
      <span>Skill:</span>
      <span>{{skill}}</span>
      {{/skill}}
      {{#difficulty}}
      <span>Difficulty:</span>
      <span>{{difficulty}}</span>
      {{/difficulty}}
      {{#cost}}
      <span>Cost:</span>
      <span>{{cost}}</span>
      {{/cost}}
      {{#duration}}
      <span>Duration:</span>
      <span>{{duration}}</span>
      {{/duration}}
    </div>
    <div class="sheet-content2">
      {{#effect}}
      <span>Effect:</span>
      <span>{{effect}}</span>
      {{/effect}}
      {{#momentum}}
      <span>Momentum:</span>
      <span>{{momentum}}</span>
      {{/momentum}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-weapon">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
      {{#type}}
      <div class="sheet-name">{{type}}</div>
      {{/type}}
      {{#focus}}
      <div class="sheet-name">{{focus}}</div>
      {{/focus}}
    </div>
    <div class="sheet-content">
      {{#range}}
      <span>Range:</span>
      <span>{{range}}</span>
      {{/range}}
      {{#damage}}
      <span>Damage:</span>
      <span>{{damage}}</span>
      {{/damage}}
      {{#ammo}}
      <span>Ammo:</span>
      <span>{{ammo}}</span>
      {{/ammo}}
      {{#salvo}}
      <span>Salvo:</span>
      <span>{{salvo}}</span>
      {{/salvo}}
      {{#size}}
      <span>Size:</span>
      <span>{{size}}</span>
      {{/size}}
      {{#qualities}}
      <span>Qualities:</span>
      <span>{{qualities}}</span>
      {{/qualities}}
    </div>
  </div>
</rolltemplate>

<!-- scripts -->

<script type="text/worker">

  const stats = ["agility", "brawn", "coordination", "insight", "reason", "will"];
  const skills = ["skill_academia", "skill_athletics", "skill_engineering", "skill_fighting", "skill_medicine", "skill_observation", "skill_persuasion", "skill_resilience", "skill_stealth", "skill_survival", "skill_tactics", "skill_vehicles"];
  const int = score => parseInt(score, 10) || 0;

  const hideShowSpellTradition = () => {
    getAttrs(["spell_skill"], function(values) {
      $20("#NoTradition").removeClass("show_element").addClass("hide_element");
      $20("#YesTradition").removeClass("show_element").addClass("hide_element");;

      if (values.spell_skill == "Traditional")
        $20("#YesTradition").removeClass("hide_element").addClass("show_element");
      else
        $20("#NoTradition").removeClass("hide_element").addClass("show_element");
  
    });
  };

  const calcualteStressValues = () => {
    getAttrs(["brawn","will","skill_resilience","stress_bonus","stress_fatigue"], function(values) {
      let brawn = parseInt(values.brawn)||0;
      let will = parseInt(values.will)||0;
      let resilience = parseInt(values.skill_resilience)||0;
      let bonus = parseInt(values.stress_bonus)||0;
      let fatigue = parseInt(values.stress_fatigue)||0;
      let stress_brawn = brawn + resilience;
      let stress_will = will + resilience;
      let stress_attributes = stress_brawn >= stress_will ? stress_brawn: stress_will;
      let stress_total = stress_attributes + bonus - fatigue;
      setAttrs({                            
        "stress_attributes": stress_attributes,
        "stress_total": stress_total
      });

      for (let i = 1; i < 21; i++) {
        $20("#attr_stress_" + i).removeClass("disableStressBox");
        if (i > stress_total)
          $20("#attr_stress_" + i).addClass("disableStressBox");
      }
    });
  };

  const setAttributesBounds = (attributeValue,attribute) => {
    $20(`#attr_${attribute}`).removeClass('attributeOutOfBounds');
    if ((attributeValue > 12) || (attributeValue < 6))
      $20(`#attr_${attribute}`).addClass('attributeOutOfBounds');
  };

  const checkAttributesBounds = () => {
    stats.forEach(stat => {
      getAttrs([stat], values => {
        let attributeValue = parseInt(values[stat])||0;
        setAttributesBounds(attributeValue,stat);
      });
    });
  };

  const setSkillsBounds = (skillValue,skill) => {
    $20(`#attr_${skill}`).removeClass('attributeOutOfBounds');
    if (skillValue > 5)
      $20(`#attr_${skill}`).addClass('attributeOutOfBounds');
  };

  const checkSkillsBounds = () => {
    skills.forEach(skill => {
      getAttrs([skill], values => {
        let skillValue = parseInt(values[skill])||0;
        setSkillsBounds(skillValue,skill);
      });
    });
  };

  <!-- Add on change or onclick events -->

  on("change:spell_skill", function() {  
    hideShowSpellTradition();
  });

  const buttonlist = ["main_char","equipment","spells","settings"];
  buttonlist.forEach(button => {
      on(`clicked:${button}`, function() {
      $20(".tab_button_selected").removeClass('tab_button_selected');
      $20("#act_" + button).addClass('tab_button_selected');
      setAttrs({
        sheetTab: button
      });
    });
  });

  stats.forEach(stat => {
    on(`change:${stat}`, () => {
      getAttrs([stat], values => {
        const stat_base = int(values[stat]);
        let stat_mod = 0;
        if (stat_base >= 16) stat_mod = 5;
        else if (stat_base >= 14) stat_mod = 4;
        else if (stat_base >= 12) stat_mod = 3;
        else if (stat_base >= 10) stat_mod = 2;
        else if (stat_base >= 9) stat_mod = 1;
        
        setAttrs({
            [`${stat}_bonus_dmg`]: stat_mod
        });

        setAttributesBounds(stat_base,stat);
      });
    });
  });

  skills.forEach(skill => {
    on(`change:${skill}`, () => {
      getAttrs([skill], values => {
        const stat_base = int(values[skill]);
        setSkillsBounds(stat_base,skill);
      });
    });
  });

  on("change:brawn change:will change:skill_resilience change:stress_bonus change:stress_fatigue", function() {  
    calcualteStressValues();
  });

  <!-- Custom Roll Parsing -->

// abilities
  stats.forEach(button => {
    on(`clicked:${button}-action`, () => {
      getAttrs(skills, async function(values) {
        const results = await startRoll(`@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${button}}} {{num_dice=[[?{Dice|2}]]}} {{target_skill=[[?{Relevant Skill|None,0|Acedemia,1|Athletics,2|Engineering,3|Fighting,4|Medicine,5|Observation,6|Persuasion,7|Resilience,8|Stealth,9|Survival,10|Tactics,11|Vehicles,12}]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[@{${button}}]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`);

        const target_skill = results.results.target_skill.result; //int select value 
        let target_skill_text = ""; //string of skill
        let skill_value = 0; //numeric skill value
    
        switch(target_skill) {
          case 1:
            skill_value = parseInt(values.skill_academia)||0;
            target_skill_text = "Academia";
            break;
          case 2:
            skill_value = parseInt(values.skill_athletics)||0;
            target_skill_text = "Athletics";
            break;
          case 3:
            skill_value = parseInt(values.skill_engineering)||0;
            target_skill_text = "Engineering";
            break;
          case 4:
            skill_value = parseInt(values.skill_fighting)||0;
            target_skill_text = "Fighting";
            break;
          case 5:
            skill_value = parseInt(values.skill_medicine)||0;
            target_skill_text = "Medicine";
            break;
          case 6:
            skill_value = parseInt(values.skill_observation)||0;
            target_skill_text = "Observation";
            break;
          case 7:
            skill_value = parseInt(values.skill_persuasion)||0;
            target_skill_text = "Persuasion";
            break;
          case 8:
            skill_value = parseInt(values.skill_resilience)||0;
            target_skill_text = "Resilience";
            break;
          case 9:
            skill_value = parseInt(values.skill_stealth)||0;
            target_skill_text = "Stealth";
            break;
          case 10:
            skill_value = parseInt(values.skill_survival)||0;
            target_skill_text = "Survival";
            break;
          case 11:
            skill_value = parseInt(values.skill_tactics)||0;
            target_skill_text = "Tactics";
            break;
          case 12:
            skill_value = parseInt(values.skill_vehicles)||0;
            target_skill_text = "Vehicles";
            break;
          default:
            skill_value = 0;
            target_skill_text = "None";
            break;
        }

        const number_dice = results.results.num_dice.result;
        const difficulty = results.results.difficulty.result;
        const target_attribute = results.results.target_attribute.result;
        const focus_apply = results.results.focus_apply.result;
        const focus_target = focus_apply == 1 ? skill_value : 1;
  
        let target_number = target_attribute + skill_value;
        let complication_range = 21 - difficulty;
        const complication_range_text = `${complication_range} - 20`;
  
        const dice = results.results.roll1.dice;
        let successCount = dice.filter(d => d <= target_number).length;
        successCount += dice.filter(d => d <= focus_target).length;
        let complicationCount = dice.filter(d => d >= complication_range).length;

        const success_range_text = `${focus_target + 1} - ${target_number}`;
        const crit_range_text = `1 - ${focus_target}`;

        let target_attribute_text = `${button}`;
        target_attribute_text = target_attribute_text[0].toUpperCase() + target_attribute_text.slice(1);

        let bonus_momentum = successCount - difficulty;
        bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
        let outcome = successCount >= difficulty ? 1 : 0;

        const dice_text = results.results.roll1.dice.toString();
  
        finishRoll(
          results.rollId,
          {
            roll1: number_dice,
            successes: successCount,
            complications: complicationCount,
            target_number: target_number,
            target_attribute: target_attribute,
            target_skill: skill_value,
            skill_text: target_skill_text,
            attribute_text: target_attribute_text,
            difficulty: difficulty,
            complication_range: complication_range_text,
            success_range: success_range_text,
            crit_range: crit_range_text,
            bonus_momentum: bonus_momentum,
            outcome: outcome,
            dice_text: dice_text,
            focus_apply: focus_apply
            
          }
        );      
      });
    });
  });

// attacks
  const attackSkills = ["repeating_weapons_weapons_type", "repeating_weapons_weapons_focus", "repeating_weapons_weapons_name", "brawn", "coordination", "will", "skill_fighting", "foc_close_quarters", "foc_handguns", "foc_hand_to_hand", "foc_heavy_weapons", "foc_melee_weapons", "foc_rifles", "foc_exotic", "foc_throwing"];
  on("clicked:repeating_weapons:attack-action", function () {
    getAttrs(attackSkills, async function(values) {
      let weaponType = values.repeating_weapons_weapons_type || "";
      let weaponFocus = values.repeating_weapons_weapons_focus || "";
      const subTitle = ((weaponType == "None" || weaponType == "") ? 'Attack' : `${weaponType} - Attack`);
      const description = values.repeating_weapons_weapons_name || "";

      let rollString = "";
      if ((weaponType == "None" || weaponType == "") && (weaponFocus == "None" || weaponFocus == "")) {
        //neither selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[?{Weapon type|Melee,0|Ranged,1|Mental,2}]]}} {{target_skill=[[0]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (weaponType == "None" || weaponType == "") {
        //type not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[?{Weapon type|Melee,0|Ranged,1|Mental,2}]]}} {{target_skill=[[0]]}} {{focus_apply=[[0]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (weaponFocus == "None" || weaponFocus == "") {
        // focus not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[0}]]}} {{target_skill=[[0]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else {
        //both selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[0}]]}} {{target_skill=[[0]]}} {{focus_apply=[[0]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      }

      const results = await startRoll(rollString);

      const target_skill_text = "Fighting"; //string of skill
      const skill_value = parseInt(values.skill_fighting)||0; //numeric skill value

      weaponType = ((weaponType == "None" || weaponType == "") ? results.results.weapon_type.result : weaponType);
      let target_attribute_text = "";
      let attribute_value = 0;

      switch(weaponType) {
        case "Melee":
        case 0:
          attribute_value = parseInt(values.brawn)||0;
          target_attribute_text = "Brawn";
          break;
        case "Ranged":
        case 1:
          attribute_value = parseInt(values.coordination)||0;
          target_attribute_text = "Coordination";
          break;
        case "Mental":
        case 2:
          attribute_value = parseInt(values.will)||0;
          target_attribute_text = "Will";
          break;
        default:
          attribute_value = parseInt(values.brawn)||0;
          target_attribute_text = "Brawn";
          break;
      }

      const number_dice = results.results.num_dice.result;
      const difficulty = results.results.difficulty.result;
      let focus_apply = results.results.focus_apply.result;

      if ((weaponFocus != "None" && weaponFocus != "")) {

        switch(weaponFocus) {
          case "Hand to Hand":
            focus_apply =  (values.foc_hand_to_hand == "on" ? 1 : 0);
            break;
          case "Close Quarters":
            focus_apply =  (values.foc_close_quarters == "on" ? 1 : 0);
            break;
          case "Melee Weapons":
            focus_apply =  (values.foc_melee_weapons == "on" ? 1 : 0);
            break;
          case "Handguns":
            focus_apply =  (values.foc_handguns == "on" ? 1 : 0);
            break;
          case "Rifles":
            focus_apply =  (values.foc_rifles == "on" ? 1 : 0);
            break;
          case "Heavy Weapons":
            focus_apply =  (values.foc_heavy_weapons == "on" ? 1 : 0);
            break;
          case "Exotic":
            focus_apply =  (values.foc_exotic == "on" ? 1 : 0);
            break;
          case "Throwing":
            focus_apply =  (values.foc_throwing == "on" ? 1 : 0);
            break;
          default:
            focus_apply =  (values.foc_hand_to_hand == "on" ? 1 : 0);
            break;
        }
      }

      const focus_target = focus_apply == 1 ? skill_value : 1;

      let target_number = attribute_value + skill_value;
      let complication_range = 21 - difficulty;
      const complication_range_text = `${complication_range} - 20`;

      const dice = results.results.roll1.dice;
      let successCount = dice.filter(d => d <= target_number).length;
      successCount += dice.filter(d => d <= focus_target).length;
      let complicationCount = dice.filter(d => d >= complication_range).length;

      const success_range_text = `${focus_target + 1} - ${target_number}`;
      const crit_range_text = `1 - ${focus_target}`;

      target_attribute_text = target_attribute_text[0].toUpperCase() + target_attribute_text.slice(1);

      let bonus_momentum = successCount - difficulty;
      bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
      let outcome = successCount >= difficulty ? 1 : 0;

      const dice_text = results.results.roll1.dice.toString();

      finishRoll(
        results.rollId,
        {
          roll1: number_dice,
          successes: successCount,
          complications: complicationCount,
          target_number: target_number,
          target_attribute: attribute_value,
          target_skill: skill_value,
          skill_text: target_skill_text,
          attribute_text: target_attribute_text,
          difficulty: difficulty,
          complication_range: complication_range_text,
          success_range: success_range_text,
          crit_range: crit_range_text,
          bonus_momentum: bonus_momentum,
          outcome: outcome,
          dice_text: dice_text,
          focus_apply: focus_apply
        }
      );      
    });
  });




















  <!-- Some stuff to run everytime the sheet opens -->

  on('sheet:opened',function(){
  	$20("#act_main_char").addClass('tab_button_selected');
  	setAttrs({
  		sheetTab: "main_char"
  	});
    hideShowSpellTradition();
    calcualteStressValues();
    checkAttributesBounds();
    checkSkillsBounds();
  });


  <!-- set the attributes and buttons correct so roll buttons trigger action buttons -->

  //A function to combine getting repeating and non repeating attributes.
const getAllAttrs = function(props,sectionDetails,callback){
  getSections(sectionDetails,(repeats,sections)=>{
    getAttrs([...props,...repeats],(attributes)=>{
      callback(attributes,sections);
    })
  });
};
//Iterates over the provided repeating sections and assembles an array of attributes to get from those sections for each row.
const getSections = function(section_details,callback){
  let queueClone = _.clone(section_details);
  const worker = (queue,repeatAttrs=[],sections={})=>{
    let detail = queue.shift();
    getSectionIDs(detail.section,(IDs)=>{
      sections[detail.section] = IDs;
      IDs.forEach((id)=>{
        detail.fields.forEach((f)=>{
          repeatAttrs.push(`${detail.section}_${id}_${f}`);
        });
      });
      repeatAttrs.push(`_reporder_${detail.section}`);
      if(queue.length){
        worker(queue,repeatAttrs,sections);
      }else{
        callback(repeatAttrs,sections);
      }
    });
  };
  if(!queueClone[0]){
    callback([],{});
  }
  worker(queueClone);
};

const repeatingSections = [{section:'repeating_weapons',fields:['attack_action']}];//Replace these with your sheet's repeating sections
const actionRefs = ['character_name', 'agility_action', 'brawn_action', 'coordination_action', 'insight_action', 'reason_action', 'will_action'];//Replace these with the non repeating attributes for your sheet.
const actionCallUpdate = function(){
  getAllAttrs(['character_name',...actionRefs],repeatingSections,(attributes,sections)=>{
    let actions = Object.keys(attributes).filter((key)=>key!=='character_name');
    const setObj = actions.reduce((accumulator,actionName)=>{
      accumulator[actionName] = `%{${attributes.character_name}|${actionName.replace(/_([^_]*)$/,'-' + '$1')}}`;//Update the action call
      return accumulator;//The memo (accumulator in this case) must always be returned when using a reduce function
    },{});
    setAttrs(setObj,{silent:true});//Apply the changes
  });
};

on('sheet:opened change:character_name',actionCallUpdate);










</script>