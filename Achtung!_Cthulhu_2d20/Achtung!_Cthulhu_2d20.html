<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="main_char" />
<div style="width: 800px;">
  <button type="action" class="tab_button" id="act_main_char" name="act_main_char">
    Main
  </button>
  <button type="action" class="tab_button" id="act_equipment" name="act_equipment">
    Equipment/Talents
  </button>
  <button type="action" class="tab_button" id="act_spells" name="act_spells">
    Spells
  </button>
  <button type="action" class="tab_button settings_button" id="act_settings" name="act_settings">
    settings
  </button>

  <!-- The visible and draggable button for the macro bar -->
  <button type="roll" name="roll_genericDamage" value="@{genericDamage_action}" class="helper_button">Damage Dice</button>
  <!-- The invisible button allowing the use of custom roll parsing -->
  <button type="action" name="act_genericDamage-action" class="hidden"></button>
  <!-- The invisible field for the attribute which contains the ability call -->
  <input type="hidden" name="attr_genericDamage_action" value="">

  <!-- The visible and draggable button for the macro bar -->
  <button type="roll" name="roll_genericSkill" value="@{genericSkill_action}" class="helper_button">Skill Check</button>
  <!-- The invisible button allowing the use of custom roll parsing -->
  <button type="action" name="act_genericSkill-action" class="hidden"></button>
  <!-- The invisible field for the attribute which contains the ability call -->
  <input type="hidden" name="attr_genericSkill_action" value="">
</div>

<div class="sheet-main_char">
  <section class="mc_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="common f-row wrap">
    <div>
      <label>Name</label>
      <input name="attr_character_name" type="text" style="width: 350px" />
    </div>
    <div>
      <label>Nationality</label>
      <input name="attr_nationality" type="text" style="width: 200px" />
    </div>
    <div>
      <label>Rank</label>
      <input name="attr_rank" type="text" style="width: 200px" />
    </div>
    <div>
      <label>Archetype</label>
      <input name="attr_archetype" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Background</label>
      <input name="attr_background" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Characteristic</label>
      <input name="attr_characteristic" type="text" style="width: 250px" />
    </div>
    <div>
      <label>Personal Truths & Scars</label>
      <div class="f-row nowrap truth_text">
        <textarea name="attr_truth_1"></textarea>
        <textarea name="attr_truth_2"></textarea>
        <textarea name="attr_truth_3"></textarea>
        <textarea name="attr_truth_4"></textarea>
        <textarea name="attr_truth_5"></textarea>
      </div>
    </div>
  </section>

  <section class="stress">
    <div>
      <div class="nowrap">
        <label>Stress</label>
      </div>
      <div class="f-row nowrap">
        <span class="f1 stress_sublabel">Attributes</span>
        <span class="f1 stress_sublabel">Bonus</span>
        <span class="f1 stress_sublabel">Fatigue</span>
        <span class="f1 stress_sublabel">Total</span>
      </div>
      <div class="f-row nowrap">
        <div class="f1">
          <input type="number" id="attr_stress_attributes" name="attr_stress_attributes" value="0" />+
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_bonus" name="attr_stress_bonus" value="0" />-
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_fatigue" name="attr_stress_fatigue" value="0" />=
        </div>
        <div class="f1">
          <input type="number" id="attr_stress_total" name="attr_stress_total" value="0" />
        </div>
      </div>
      <div class="stress_box_row">
        <input name="attr_stress_1" id="attr_stress_1" type="checkbox" />
        <input name="attr_stress_2" id="attr_stress_2" type="checkbox" />
        <input name="attr_stress_3" id="attr_stress_3" type="checkbox" />
        <input name="attr_stress_4" id="attr_stress_4" type="checkbox" />
        <input name="attr_stress_5" id="attr_stress_5" type="checkbox" />
        <input name="attr_stress_6" id="attr_stress_6" type="checkbox" />
        <input name="attr_stress_7" id="attr_stress_7" type="checkbox" />
        <input name="attr_stress_8" id="attr_stress_8" type="checkbox" />
        <input name="attr_stress_9" id="attr_stress_9" type="checkbox" />
        <input name="attr_stress_10" id="attr_stress_10" type="checkbox" />
      </div>
      <div class="stress_box_row">
        <input name="attr_stress_11" id="attr_stress_11" type="checkbox" />
        <input name="attr_stress_12" id="attr_stress_12" type="checkbox" />
        <input name="attr_stress_13" id="attr_stress_13" type="checkbox" />
        <input name="attr_stress_14" id="attr_stress_14" type="checkbox" />
        <input name="attr_stress_15" id="attr_stress_15" type="checkbox" />
        <input name="attr_stress_16" id="attr_stress_16" type="checkbox" />
        <input name="attr_stress_17" id="attr_stress_17" type="checkbox" />
        <input name="attr_stress_18" id="attr_stress_18" type="checkbox" />
        <input name="attr_stress_19" id="attr_stress_19" type="checkbox" />
        <input name="attr_stress_20" id="attr_stress_20" type="checkbox" />
      </div>
    </div>
    <div>
      <label>Languages</label>
      <textarea style="margin-top: 3px;" name="attr_lnaguages"></textarea>
    </div>
  </section>

  <section class="soak f-col nowrap">
    <div style="display: inline-flex">
      <div>
        <label>Fortune</label>
        <input type="number" name="attr_fortune" value="3" />
      </div>
      <div>
        <label>Exp</label>
        <input type="number" name="attr_exp" value="0" />
      </div>
    </div>
    <div style="display: inline-flex">
      <div>
        <label>Courage</label>
        <input type="number" name="attr_courage" value="0" />
      </div>
      <div>
        <label>Armour</label>
        <input type="number" name="attr_armour" value="0" />
      </div>
    </div>
  </section>

  <section class="injuries">
    <label>Injuries</label>
    <div class="f-row nowrap">
      <textarea name="attr_injury_1"></textarea>
      <textarea name="attr_injury_2"></textarea>
      <textarea name="attr_injury_3"></textarea>
    </div>
  </section>

  <section class="attr f-row nowrap">
    <div class="f-col">
      <h3>Attributes</h3>
      <label>Rating</label>
      <label>Bonus Damage</label>
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Agility</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_agility" value="@{agility_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_agility-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_agility_action" value="">
      </span>
      <input type="number" id="attr_agility" name="attr_agility" value="6" min="0" max="20" />
      <input type="number" name="attr_agility_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Brawn</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_brawn" value="@{brawn_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_brawn-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_brawn_action" value="">
      </span>
      <input type="number" id="attr_brawn" name="attr_brawn" value="6" min="0" max="20" />
      <input type="number" name="attr_brawn_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Coordination</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_coordination" value="@{coordination_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_coordination-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_coordination_action" value="">
      </span>
      <input type="number" id="attr_coordination" name="attr_coordination" value="6" min="0" max="20" />
      <input type="number" name="attr_coordination_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Insight</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_insight" value="@{insight_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_insight-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_insight_action" value="">
      </span>
      <input type="number" id="attr_insight" name="attr_insight" value="6" min="0" max="20" />
      <input type="number" name="attr_insight_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Reason</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_reason" value="@{reason_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_reason-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_reason_action" value="">
      </span>
      <input type="number" id="attr_reason" name="attr_reason" value="6" min="0" max="20" />
      <input type="number" name="attr_reason_bonus_dmg" value="0" />
    </div>
    <div class="f-col">
      <span class="attribute_header">
        <label>Will</label>
        <!-- The visible and draggable button for the macro bar -->
        <button type="roll" name="roll_will" value="@{will_action}"></button>
        <!-- The invisible button allowing the use of custom roll parsing -->
        <button type="action" name="act_will-action" class="hidden"></button>
        <!-- The invisible field for the attribute which contains the ability call -->
        <input type="hidden" name="attr_will_action" value="">
      </span>
      <input type="number" id="attr_will" name="attr_will" value="6" min="0" max="20" />
      <input type="number" name="attr_will_bonus_dmg" value="0" />
    </div>
  </section>

  <section class="skills f-col">
    <div class="f-row">
      <h3 class="f2">Skills</h3>
      <label class="f1">Ranks</label>
      <label class="f8">Focuses</label>
    </div>
    <div class="f-row">
      <label class="f2">Academia</label>
      <input class="f1" type="number" id="attr_skill_academia" name="attr_skill_academia" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div><input name="attr_foc_art" type="checkbox" /><span>Art</span></div>
        <div>
          <input name="attr_foc_cryptography" type="checkbox" /><span>Cryptography</span>
        </div>
        <div>
          <input name="attr_foc_finance" type="checkbox" /><span>Finance</span>
        </div>
        <div>
          <input name="attr_foc_history" type="checkbox" /><span>History</span>
        </div>
        <div>
          <input name="attr_foc_linguistics" type="checkbox" /><span>Linguistics</span>
        </div>
        <div>
          <input name="attr_foc_occultism" type="checkbox" /><span>Occultism</span>
        </div>
        <div>
          <input name="attr_foc_science" type="checkbox" /><span>Science</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Athletics</label>
      <input class="f1" type="number" id="attr_skill_athletics" name="attr_skill_athletics" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_climbing" type="checkbox" /><span>Climbing</span>
        </div>
        <div>
          <input name="attr_foc_lifting" type="checkbox" /><span>Lifting</span>
        </div>
        <div>
          <input name="attr_foc_phsyical_training" type="checkbox" /><span>Phsyical Training</span>
        </div>
        <div>
          <input name="attr_foc_running" type="checkbox" /><span>Running</span>
        </div>
        <div>
          <input name="attr_foc_swimming" type="checkbox" /><span>Swimming</span>
        </div>
        <div>
          <input name="attr_foc_throwing" type="checkbox" /><span>Throwing</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Engineering</label>
      <input class="f1" type="number" id="attr_skill_engineering" name="attr_skill_engineering" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_architecture" type="checkbox" /><span>Architecture</span>
        </div>
        <div>
          <input name="attr_foc_combat_engineering" type="checkbox" /><span>Combat Engineering</span>
        </div>
        <div>
          <input name="attr_foc_electronics" type="checkbox" /><span>Electronics</span>
        </div>
        <div>
          <input name="attr_foc_explosives" type="checkbox" /><span>Explosives</span>
        </div>
        <div>
          <input name="attr_foc_mechanical_engineering" type="checkbox" /><span>Mechanical Engineering</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Fighting</label>
      <input class="f1" type="number" id="attr_skill_fighting" name="attr_skill_fighting" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_close_quarters" type="checkbox" /><span>Close Quarters</span>
        </div>
        <div>
          <input name="attr_foc_handguns" type="checkbox" /><span>Handguns</span>
        </div>
        <div>
          <input name="attr_foc_hand_to_hand" type="checkbox" /><span>Hand-to-Hand</span>
        </div>
        <div>
          <input name="attr_foc_heavy_weapons" type="checkbox" /><span>Heavy Weapons</span>
        </div>
        <div>
          <input name="attr_foc_melee_weapons" type="checkbox" /><span>Melee Weapons</span>
        </div>
        <div>
          <input name="attr_foc_rifles" type="checkbox" /><span>Rifles</span>
        </div>
        <div>
          <input name="attr_foc_threat_awareness" type="checkbox" /><span>Threat Awareness</span>
        </div>
        <div>
          <input name="attr_foc_exotic" type="checkbox" /><span>Exotic</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Medicine</label>
      <input class="f1" type="number" id="attr_skill_medicine" name="attr_skill_medicine" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_close_first_aid" type="checkbox" /><span>First Aid</span>
        </div>
        <div>
          <input name="attr_foc_infectious_diseases" type="checkbox" /><span>Infectious Diseases</span>
        </div>
        <div>
          <input name="attr_foc_pharmacology" type="checkbox" /><span>Pharmacology</span>
        </div>
        <div>
          <input name="attr_foc_psychiarty" type="checkbox" /><span>Psychiarty</span>
        </div>
        <div>
          <input name="attr_foc_surgey" type="checkbox" /><span>Surgey</span>
        </div>
        <div>
          <input name="attr_foc_toxicology" type="checkbox" /><span>Toxicology</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Observation</label>
      <input class="f1" type="number" id="attr_skill_observation" name="attr_skill_observation" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_hearing" type="checkbox" /><span>Hearing</span>
        </div>
        <div>
          <input name="attr_foc_instincts" type="checkbox" /><span>Instincts</span>
        </div>
        <div>
          <input name="attr_foc_sight" type="checkbox" /><span>Sight</span>
        </div>
        <div>
          <input name="attr_foc_smell_and_taste" type="checkbox" /><span>Smell and Taste</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Persuasion</label>
      <input class="f1" type="number" id="attr_skill_persuasion" name="attr_skill_persuasion" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_charm" type="checkbox" /><span>Charm</span>
        </div>
        <div>
          <input name="attr_foc_inneuendo" type="checkbox" /><span>Inneuendo</span>
        </div>
        <div>
          <input name="attr_foc_intimidation" type="checkbox" /><span>Intimidation</span>
        </div>
        <div>
          <input name="attr_foc_negotiation" type="checkbox" /><span>Negotiation</span>
        </div>
        <div>
          <input name="attr_foc_rhetoric" type="checkbox" /><span>Rhetoric</span>
        </div>
        <div>
          <input name="attr_foc_deceive" type="checkbox" /><span>Deceive</span>
        </div>
        <div>
          <input name="attr_foc_invocation" type="checkbox" /><span>Invocation</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Resilience</label>
      <input class="f1" type="number" id="attr_skill_resilience" name="attr_skill_resilience" value="0" min="0"
        max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_fortitude" type="checkbox" /><span>Fortitude</span>
        </div>
        <div>
          <input name="attr_foc_discipline" type="checkbox" /><span>Discipline</span>
        </div>
        <div>
          <input name="attr_foc_immunity" type="checkbox" /><span>Immunity</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Stealth</label>
      <input class="f1" type="number" id="attr_skill_stealth" name="attr_skill_stealth" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_camouflage" type="checkbox" /><span>Camouflage</span>
        </div>
        <div>
          <input name="attr_foc_disguise" type="checkbox" /><span>Disguise</span>
        </div>
        <div>
          <input name="attr_foc_rural_stealth" type="checkbox" /><span>Rural Stealth</span>
        </div>
        <div>
          <input name="attr_foc_urban_stealth" type="checkbox" /><span>Urban Stealth</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Survival</label>
      <input class="f1" type="number" id="attr_skill_survival" name="attr_skill_survival" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_animal_handling" type="checkbox" /><span>Animal Handling</span>
        </div>
        <div>
          <input name="attr_foc_foraging" type="checkbox" /><span>Foraging</span>
        </div>
        <div>
          <input name="attr_foc_hunting" type="checkbox" /><span>Hunting</span>
        </div>
        <div>
          <input name="attr_foc_mysticism" type="checkbox" /><span>Mysticism</span>
        </div>
        <div>
          <input name="attr_foc_orienteering" type="checkbox" /><span>Orienteering</span>
        </div>
        <div>
          <input name="attr_foc_tracking" type="checkbox" /><span>Tracking</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Tactics</label>
      <input class="f1" type="number" id="attr_skill_tactics" name="attr_skill_tactics" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_air_force" type="checkbox" /><span>Air Force</span>
        </div>
        <div>
          <input name="attr_foc_army" type="checkbox" /><span>Army</span>
        </div>
        <div>
          <input name="attr_foc_covert_operations" type="checkbox" /><span>Covert Operations</span>
        </div>
        <div>
          <input name="attr_foc_leadership" type="checkbox" /><span>Leadership</span>
        </div>
        <div>
          <input name="attr_foc_navy" type="checkbox" /><span>Navy</span>
        </div>
        <div>
          <input name="attr_foc_technical_projects" type="checkbox" /><span>Technical Projects</span>
        </div>
      </div>
    </div>
    <div class="f-row">
      <label class="f2">Vehicles</label>
      <input class="f1" type="number" id="attr_skill_vehicles" name="attr_skill_vehicles" value="0" min="0" max="10" />
      <div class="f8 f-row wrap skill_row">
        <div>
          <input name="attr_foc_cars" type="checkbox" /><span>Cars</span>
        </div>
        <div>
          <input name="attr_foc_motorcycles" type="checkbox" /><span>Motorcycles</span>
        </div>
        <div>
          <input name="attr_foc_heavy_vehicles" type="checkbox" /><span>Heavy Vehicles</span>
        </div>
        <div>
          <input name="attr_foc_tanks" type="checkbox" /><span>Tanks</span>
        </div>
        <div>
          <input name="attr_foc_aircraft" type="checkbox" /><span>Aircraft</span>
        </div>
        <div>
          <input name="attr_foc_technical_watercraft" type="checkbox" /><span>Watercraft</span>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sheet-equipment">
  <section class="e_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="equip f-col">
    <div class="f-row">
      <h3>Equipment of Note</h3>
    </div>
    <hr>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_1"></textarea>
      <textarea class="f1" name="attr_equip_desc_2"></textarea>
      <textarea class="f1" name="attr_equip_desc_3"></textarea>
      <textarea class="f1" name="attr_equip_desc_4"></textarea>
    </div>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_5"></textarea>
      <textarea class="f1" name="attr_equip_desc_6"></textarea>
      <textarea class="f1" name="attr_equip_desc_7"></textarea>
      <textarea class="f1" name="attr_equip_desc_8"></textarea>
    </div>
    <div class="f-row">
      <textarea class="f1" name="attr_equip_desc_9"></textarea>
      <textarea class="f1" name="attr_equip_desc_10"></textarea>
      <textarea class="f1" name="attr_equip_desc_11"></textarea>
      <textarea class="f1" name="attr_equip_desc_12"></textarea>
    </div>
  </section>

  <section class="weapons f-col">
    <div class="f-row">
      <h3>Weapons</h3>
    </div>
    <hr>

    <fieldset class="repeating_weapons">
      <div class="f-row weapons_row1">
        <div class="f1 weapons-chat">
          <button type="roll" name="roll_weapon" class="chat_button"
            value="@{whisper}&{template:weapon} {{title=@{character_name}}} {{name=@{weapons_name}}} {{type=@{weapons_type}}} {{focus=@{weapons_focus}}} {{range=@{weapons_range}}} {{damage=@{weapons_damage}}} {{ammo=@{weapons_ammo}}} {{salvo=@{weapons_salvo}}} {{size=@{weapons_size}}} {{qualities=@{weapons_qualities}}} {{stressDice=@{stress_dice}}}"></button>
          <!-- The visible and draggable button for the macro bar -->
          <button type="roll" name="roll_attack" value="@{attack_action}"></button>
          <!-- The invisible button allowing the use of custom roll parsing -->
          <button type="action" name="act_attack-action" class="hidden"></button>
          <!-- The invisible field for the attribute which contains the ability call -->
          <input type="hidden" name="attr_attack_action" value="">
        </div>
        <div class="f4">
          <label>Name</label>
          <input name="attr_weapons_name" type="text" />
        </div>
        <div class="f3">
          <label>Type</label>
          <select name="attr_weapons_type">
            <option value="None" selected></option>
            <option value="Melee">Melee</option>
            <option value="Ranged">Ranged</option>
            <option value="Mental">Mental</option>
          </select>
        </div>
        <div class="f3">
          <label>Focus</label>
          <select name="attr_weapons_focus">
            <option value="None" selected></option>
            <option value="Hand to Hand">Hand to Hand</option>
            <option value="Close Quarters">Close Quarters</option>
            <option value="Melee Weapons">Melee Weapons</option>
            <option value="Handguns">Handguns</option>
            <option value="Rifles">Rifles</option>
            <option value="Heavy Weapons">Heavy Weapons</option>
            <option value="Exotic">Exotic</option>
            <option value="Throwing">Throwing</option>
            <option value="Occultism">Occultism</option>
          </select>
        </div>
        <div class="f1" style="text-align: right;">
          <span style="width:25px; height:29px;display: inline-block;">&nbsp;</span>
          <!-- The visible and draggable button for the macro bar -->
          <button type="roll" name="roll_damage" value="@{damage_action}"></button>
          <!-- The invisible button allowing the use of custom roll parsing -->
          <button type="action" name="act_damage-action" class="hidden"></button>
          <!-- The invisible field for the attribute which contains the ability call -->
          <input type="hidden" name="attr_damage_action" value="">
        </div>
        <div class="f2">
          <label>Stress</label>
          <input type="number" id="attr_stress_dice" name="attr_stress_dice" value="0" min="0" />
        </div>
        <div class="f3 stress_effects">
          <label>Stress Effects</label>
          <textarea name="attr_weapons_damage"></textarea>
        </div>
      </div>
      <div class="f-row weapons_row2">
        <div class="f1">
          <label>Ammo</label>
          <textarea name="attr_weapons_ammo"></textarea>
        </div>
        <div class="f1">
          <label>Salvo Effects</label>
          <textarea name="attr_weapons_salvo"></textarea>
        </div>
        <div class="f1">
          <label>Range</label>
          <textarea name="attr_weapons_range"></textarea>
        </div>
        <div class="f1">
          <label>Size</label>
          <textarea name="attr_weapons_size"></textarea>
        </div>
        <div class="f1">
          <label>Qualities</label>
          <textarea name="attr_weapons_qualities"></textarea>
        </div>
      </div>
      <hr>
    </fieldset>
  </section>

  <section class="talents f-col">
    <div class="f-row">
      <h3>Talents</h3>
    </div>
    <hr>

    <div class="f-row">
      <span class="f1">&nbsp;</span>
      <label class="f3">Name</label>
      <label class="f3">Keywords</label>
      <label class="f12">Effect</label>
    </div>

    <fieldset class="repeating_talents">
      <div class="f-row talent_row">
        <div class="f1 talents-chat">
          <button type="roll" name="roll_talent" class="chat_button"
            value="@{whisper}&{template:talent} {{title=@{character_name}}} {{name=@{talents_name}}} {{keywords=@{talents_keywords}}} {{effect=@{talents_effect}}}"></button>
        </div>
        <textarea class="f3" name="attr_talents_name"></textarea>
        <textarea class="f3" name="attr_talents_keywords"></textarea>
        <textarea class="f12" name="attr_talents_effect"></textarea>
      </div>
    </fieldset>
  </section>
</div>

<div class="sheet-spells">
  <section class="s_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="magic f-col">
    <div class="f-row">
      <div class="f3">
        <label>Spellcaster Type</label>
        <select name="attr_spell_skill">
          <option value="None" selected></option>
          <option value="Traditional">Traditional</option>
          <option value="Researcher">Researcher</option>
          <option value="Dabbler">Dabbler</option>
        </select>
      </div>
      <span id="NoTradition" name="NoTradition" class="f4">&nbsp;</span>
      <div id="YesTradition" name="YesTradition" class="f4 hide_element">
        <label>Tradition</label>
        <input name="attr_spell_tradition" type="text" style="width: 150px" />
      </div>
      <div class="f4">

        <div class="nowrap">
          <label>Power</label>
        </div>
        <div class="f-row nowrap">
          <span class="f1 spells_sublabel">Attributes</span>
          <span class="f1 spells_sublabel">Bonus</span>
          <span class="f2 spells_sublabel">Total</span>
        </div>
        <div class="f-row nowrap">
          <div class="f1">
            <input type="number" id="attr_spells_power_attributes" name="attr_spells_power_attributes" value="0" />+
          </div>
          <div class="f1">
            <input type="number" id="attr_spells_power_bonus" name="attr_spells_power_bonus" value="0" />=
          </div>
          <div class="f2">
            <input type="number" id="attr_spells_power_total" name="attr_spells_power_total" value="0" />
            <!-- The visible and draggable button for the macro bar -->
            <button type="roll" name="roll_spell_power" value="@{spell_power_action}"></button>
            <!-- The invisible button allowing the use of custom roll parsing -->
            <button type="action" name="act_spell_power-action" class="hidden"></button>
            <!-- The invisible field for the attribute which contains the ability call -->
            <input type="hidden" name="attr_spell_power_action" value="">
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="spells f-col">
    <div class="f-row">
      <h3>Spells</h3>
    </div>
    <hr>
    <fieldset class="repeating_spells">
      <div class="f-row spell_row1">
        <div class="f1 spells-chat">
          <button type="roll" name="roll_spell" class="chat_button"
            value="@{whisper}&{template:spell} {{title=@{character_name}}} {{name=@{spell_name}}} {{skill=@{spell_skill}}} {{difficulty=@{spell_difficulty}}} {{cost=@{spell_cost}}} {{duration=@{spell_duration}}} {{effect=@{spell_effect}}} {{momentum=@{spell_momentum}}}"></button>
          <!-- The visible and draggable button for the macro bar -->
          <button type="roll" name="roll_spell" value="@{spell_action}"></button>
          <!-- The invisible button allowing the use of custom roll parsing -->
          <button type="action" name="act_spell-action" class="hidden"></button>
          <!-- The invisible field for the attribute which contains the ability call -->
          <input type="hidden" name="attr_spell_action" value="">
        </div>
        <div class="f5">
          <label>Name:</label>
          <input name="attr_spell_name" type="text" style="width: 150px" />
        </div>
        <div class="f4">
          <label>Skill:</label>
          <select name="attr_spell_skill">
            <option value="None" selected></option>
            <option value="Academia">Academia</option>
            <option value="Athletics">Athletics</option>
            <option value="Engineering">Engineering</option>
            <option value="Fighting">Fighting</option>
            <option value="Medicine">Medicine</option>
            <option value="Observation">Observation</option>
            <option value="Persuasion">Persuasion</option>
            <option value="Resilience">Resilience</option>
            <option value="Stealth">Stealth</option>
            <option value="Survival">Survival</option>
            <option value="Tactics">Tactics</option>
            <option value="Vehicles">Vehicles</option>
          </select>
        </div>
        <div class="f3">
          <label>Difficulty</label>
          <input type="number" name="attr_spell_difficulty" value="0" />
        </div>
        <div class="f2">
          <label>Cost</label>
          <input type="number" name="attr_spell_cost_dice" value="0" />
        </div>
        <div class="f4">
          <label>Cost Effects</label>
          <input name="attr_spell_cost" type="text" style="width: 100px" />
        </div>
        <div class="f3">
          <label>Duration</label>
          <input name="attr_spell_duration" type="text" style="width: 100px" />
        </div>
      </div>
      <div class="f-row spell_row2">
        <div class="f1">
          <label>Effect</label>
          <textarea name="attr_spell_effect"></textarea>
        </div>
        <div class="f1">
          <label>Momentum</label>
          <textarea name="attr_spell_momentum"></textarea>
        </div>
      </div>
      <hr>
    </fieldset>
  </section>
</div>

<div class="sheet-settings">
  <section class="st_header f-row f-center">
    <h1>Achtung! Cthulhu</h1>
    <span>Character Record Sheet</span>
    <span>2d20</span>
  </section>

  <section class="settings_left f-col">
    <div>
      <label>Whisper roles to GM?</label>
      <select name="attr_whisper">
        <option value="" selected>Never</option>
        <option value="/w gm ">Always</option>
      </select>
    </div>
  </section>

  <section class="settings_right f-col">
    <div>
      <label>Use optional increased complication range based on difficulty (page 22)?</label>
      <select name="attr_increasedComplication">
        <option value="Y" selected>Yes</option>
        <option value="N">No</option>
      </select>
    </div>
  </section>
</div>

<!-- roll templates -->
<rolltemplate class="sheet-rolltemplate-skill">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#subtitle}}
      <div class="sheet-subtitle">{{subtitle}}</div>
      {{/subtitle}}
      {{#description}}
      <div class="sheet-description">{{description}}</div>
      {{/description}}
    </div>
    <div class="sheet-result">
      {{#rollTotal() computed::outcome 1}}
      <div class="sheet-success">Success!</div>
      {{/rollTotal() computed::outcome 1}}
      {{#rollTotal() computed::outcome 0}}
      <div class="sheet-failure">Failure!</div>
      {{/rollTotal() computed::outcome 0}}
    </div>
    <div class="sheet-content">
      <span>Dice rolled:</span>
      <span class="sheet-roll-bold-highlight">{{computed::roll1}}</span>
      <span>Number of successes:</span>
      <span class="sheet-roll-bold">{{computed::successes}}</span>
      <span>Bonus momentum:</span>
      <span class="sheet-roll-bold">{{computed::bonus_momentum}}</span>
      <span>Number of complications:</span>
      <span class="sheet-roll-bold">{{computed::complications}}</span>
    </div>
    <div class="sheet-show-details">
      Show Details
    </div>
    <div class="sheet-details-wrapper">
      <div class="sheet-details">
        <span class="sheet-roll-normal-nopad">{{computed::attribute_text}} value is:</span>
        <span class="sheet-roll-normal">{{computed::target_attribute}}</span>
        <span class="sheet-roll-normal-nopad">{{computed::skill_text}} value is:</span>
        <span class="sheet-roll-normal">{{computed::target_skill}}</span>
        <span>Target number is:</span>
        <span class="sheet-roll-normal">{{computed::target_number}}</span>
        {{#rollTotal() computed::focus_apply 0}}
        <span>Does a focus apply:</span>
        <span class="sheet-roll-normal">No</span>
        {{/rollTotal() computed::focus_apply 0}}
        {{#rollTotal() computed::focus_apply 1}}
        <span>Does a focus apply:</span>
        <span class="sheet-roll-normal">Yes</span>
        {{/rollTotal() computed::focus_apply 1}}
        <span>Difficulty is:</span>
        <span class="sheet-roll-normal">{{computed::difficulty}}</span>
        <span>Crit range is:</span>
        <span class="sheet-roll-normal">{{computed::crit_range}}</span>
        <span>Normal success is:</span>
        <span class="sheet-roll-normal">{{computed::success_range}}</span>
        <span>Complication range is:</span>
        <span class="sheet-roll-normal">{{computed::complication_range}}</span>
        <span>Dice rolled:</span>
        <span class="sheet-roll-normal">{{computed::dice_text}}</span>
      </div>
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-damage">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#subtitle}}
      <div class="sheet-subtitle">{{subtitle}}</div>
      {{/subtitle}}
      {{#description}}
      <div class="sheet-description">{{description}}</div>
      {{/description}}
    </div>
    <div class="sheet-content">
      <span>Dice rolled:</span>
      <span class="sheet-roll-bold-highlight">{{computed::roll1}}</span>
      <span>Number of stress:</span>
      <span class="sheet-roll-bold">{{computed::total_stress}}</span>
      <span>Number of effects:</span>
      <span class="sheet-roll-bold">{{computed::total_effects}}</span>
      {{#stress_effects}}
      <span>Stress effects:</span>
      <span>{{stress_effects}}</span>
      {{/stress_effects}}
      {{#salvo_effects}}
      <span>Salvo effects:</span>
      <span>{{salvo_effects}}</span>
      {{/salvo_effects}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-talent">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
      {{#keywords}}
      <div class="sheet-keywords">{{keywords}}</div>
      {{/keywords}}
    </div>
    <div class="sheet-content">
      <div>{{effect}}</div>
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-spell">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
    </div>
    <div class="sheet-content">
      {{#skill}}
      <span>Skill:</span>
      <span>{{skill}}</span>
      {{/skill}}
      {{#difficulty}}
      <span>Difficulty:</span>
      <span>{{difficulty}}</span>
      {{/difficulty}}
      {{#cost}}
      <span>Cost:</span>
      <span>{{cost}}</span>
      {{/cost}}
      {{#duration}}
      <span>Duration:</span>
      <span>{{duration}}</span>
      {{/duration}}
    </div>
    <div class="sheet-content2">
      {{#effect}}
      <span>Effect:</span>
      <span>{{effect}}</span>
      {{/effect}}
      {{#momentum}}
      <span>Momentum:</span>
      <span>{{momentum}}</span>
      {{/momentum}}
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-weapon">
  <div class="sheet-container">
    <div class="sheet-header">
      {{#title}}
      <div class="sheet-title">{{title}}</div>
      {{/title}}
      {{#name}}
      <div class="sheet-name">{{name}}</div>
      {{/name}}
      {{#type}}
      <div class="sheet-name">{{type}}</div>
      {{/type}}
      {{#focus}}
      <div class="sheet-name">{{focus}}</div>
      {{/focus}}
    </div>
    <div class="sheet-content">
      {{#stressDice}}
      <span>Stress Dice:</span>
      <span>{{stressDice}}</span>
      {{/stressDice}}
      {{#damage}}
      <span>Stress Effects:</span>
      <span>{{damage}}</span>
      {{/damage}}
      {{#ammo}}
      <span>Ammo:</span>
      <span>{{ammo}}</span>
      {{/ammo}}
      {{#salvo}}
      <span>Salvo Effects:</span>
      <span>{{salvo}}</span>
      {{/salvo}}
      {{#range}}
      <span>Range:</span>
      <span>{{range}}</span>
      {{/range}}
      {{#size}}
      <span>Size:</span>
      <span>{{size}}</span>
      {{/size}}
      {{#qualities}}
      <span>Qualities:</span>
      <span>{{qualities}}</span>
      {{/qualities}}
    </div>
  </div>
</rolltemplate>

<!-- scripts -->

<script type="text/worker">

  const stats = ["agility", "brawn", "coordination", "insight", "reason", "will"];
  const skills = ["skill_academia", "skill_athletics", "skill_engineering", "skill_fighting", "skill_medicine", "skill_observation", "skill_persuasion", "skill_resilience", "skill_stealth", "skill_survival", "skill_tactics", "skill_vehicles"];
  const int = score => parseInt(score, 10) || 0;

  const hideShowSpellTradition = () => {
    getAttrs(["spell_skill"], function(values) {
      $20("#NoTradition").removeClass("show_element").addClass("hide_element");
      $20("#YesTradition").removeClass("show_element").addClass("hide_element");;

      if (values.spell_skill == "Traditional")
        $20("#YesTradition").removeClass("hide_element").addClass("show_element");
      else
        $20("#NoTradition").removeClass("hide_element").addClass("show_element");
  
    });
  };

  const calcualteStressValues = () => {
    getAttrs(["brawn","will","skill_resilience","stress_bonus","stress_fatigue"], function(values) {
      let brawn = int(values.brawn);
      let will = int(values.will);
      let resilience = int(values.skill_resilience);
      let bonus = int(values.stress_bonus);
      let fatigue = int(values.stress_fatigue);
      let stress_brawn = brawn + resilience;
      let stress_will = will + resilience;
      let stress_attributes = stress_brawn >= stress_will ? stress_brawn: stress_will;
      let stress_total = stress_attributes + bonus - fatigue;
      setAttrs({                            
        "stress_attributes": stress_attributes,
        "stress_total": stress_total
      });

      for (let i = 1; i < 21; i++) {
        $20("#attr_stress_" + i).removeClass("disableStressBox");
        if (i > stress_total)
          $20("#attr_stress_" + i).addClass("disableStressBox");
      }
    });
  };
  
  const calcualteSpellPower = () => {
    getAttrs(["reason_bonus_dmg","will_bonus_dmg","insight_bonus_dmg","spell_skill", "spells_power_bonus"], function(values) {

      let spellSkill = values.spell_skill || '';
      let spellBonus = int(values.spells_power_bonus);
      let reasonBonus = int(values.reason_bonus_dmg);
      let willBonus = int(values.will_bonus_dmg);
      let insightBonus = int(values.insight_bonus_dmg);
      let attributePower = 0;
      let totalPower = 0;

      switch(spellSkill) {
        case "Traditional":
          attributePower = 2 + insightBonus;
          break;
        case "Researcher":
          attributePower = 2 + reasonBonus;
          break;
        case "Dabbler":
          attributePower = 1 + willBonus;
          break;
        default:
          attributePower += 0;
          break;
      }
      totalPower = attributePower + spellBonus;

      setAttrs({                            
        "spells_power_attributes": attributePower,
        "spells_power_total": totalPower
      });
    });
  };

  const setAttributesBounds = (attributeValue,attribute) => {
    $20(`#attr_${attribute}`).removeClass('attributeOutOfBounds');
    if ((attributeValue > 12) || (attributeValue < 6))
      $20(`#attr_${attribute}`).addClass('attributeOutOfBounds');
  };

  const checkAttributesBounds = () => {
    stats.forEach(stat => {
      getAttrs([stat], values => {
        let attributeValue = int(values[stat]);
        setAttributesBounds(attributeValue,stat);
      });
    });
  };

  const setSkillsBounds = (skillValue,skill) => {
    $20(`#attr_${skill}`).removeClass('attributeOutOfBounds');
    if (skillValue > 5)
      $20(`#attr_${skill}`).addClass('attributeOutOfBounds');
  };

  const checkSkillsBounds = () => {
    skills.forEach(skill => {
      getAttrs([skill], values => {
        let skillValue = int(values[skill]);
        setSkillsBounds(skillValue,skill);
      });
    });
  };

  <!-- Add on change or onclick events -->

  on("change:spell_skill", function() {  
    hideShowSpellTradition();
  });

  const buttonlist = ["main_char","equipment","spells","settings"];
  buttonlist.forEach(button => {
      on(`clicked:${button}`, function() {
      $20(".tab_button_selected").removeClass('tab_button_selected');
      $20("#act_" + button).addClass('tab_button_selected');
      setAttrs({
        sheetTab: button
      });
    });
  });

  stats.forEach(stat => {
    on(`change:${stat}`, () => {
      getAttrs([stat], values => {
        const stat_base = int(values[stat]);
        let stat_mod = 0;
        if (stat_base >= 16) stat_mod = 5;
        else if (stat_base >= 14) stat_mod = 4;
        else if (stat_base >= 12) stat_mod = 3;
        else if (stat_base >= 10) stat_mod = 2;
        else if (stat_base >= 9) stat_mod = 1;
        
        setAttrs({
            [`${stat}_bonus_dmg`]: stat_mod
        });

        setAttributesBounds(stat_base,stat);
      });
    });
  });

  skills.forEach(skill => {
    on(`change:${skill}`, () => {
      getAttrs([skill], values => {
        const stat_base = int(values[skill]);
        setSkillsBounds(stat_base,skill);
      });
    });
  });

  on("change:brawn change:will change:skill_resilience change:stress_bonus change:stress_fatigue", function() {  
    calcualteStressValues();
  });

  on("change:reason_bonus_dmg change:insight_bonus_dmg change:will_bonus_dmg change:spell_skill change:spells_power_bonus", function() {  
    calcualteSpellPower();
  });

  <!-- Custom Roll Parsing -->

// abilities
  stats.forEach(button => {
    on(`clicked:${button}-action`, () => {
      getAttrs([...skills,'increasedComplication'], async function(values) {
        const results = await startRoll(`@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${button}}} {{num_dice=[[?{Dice|2}]]}} {{target_skill=[[?{Relevant Skill|None,0|Academia,1|Athletics,2|Engineering,3|Fighting,4|Medicine,5|Observation,6|Persuasion,7|Resilience,8|Stealth,9|Survival,10|Tactics,11|Vehicles,12}]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[@{${button}}]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`);

        const target_skill = results.results.target_skill.result; //int select value 
        let target_skill_text = ""; //string of skill
        let skill_value = 0; //numeric skill value
    
        switch(target_skill) {
          case 1:
            skill_value = int(values.skill_academia);
            target_skill_text = "Academia";
            break;
          case 2:
            skill_value = int(values.skill_athletics);
            target_skill_text = "Athletics";
            break;
          case 3:
            skill_value = int(values.skill_engineering);
            target_skill_text = "Engineering";
            break;
          case 4:
            skill_value = int(values.skill_fighting);
            target_skill_text = "Fighting";
            break;
          case 5:
            skill_value = int(values.skill_medicine);
            target_skill_text = "Medicine";
            break;
          case 6:
            skill_value = int(values.skill_observation);
            target_skill_text = "Observation";
            break;
          case 7:
            skill_value = int(values.skill_persuasion);
            target_skill_text = "Persuasion";
            break;
          case 8:
            skill_value = int(values.skill_resilience);
            target_skill_text = "Resilience";
            break;
          case 9:
            skill_value = int(values.skill_stealth);
            target_skill_text = "Stealth";
            break;
          case 10:
            skill_value = int(values.skill_survival);
            target_skill_text = "Survival";
            break;
          case 11:
            skill_value = int(values.skill_tactics);
            target_skill_text = "Tactics";
            break;
          case 12:
            skill_value = int(values.skill_vehicles);
            target_skill_text = "Vehicles";
            break;
          default:
            skill_value = 0;
            target_skill_text = "None";
            break;
        }

        const number_dice = results.results.num_dice.result;
        const difficulty = results.results.difficulty.result;
        const target_attribute = results.results.target_attribute.result;
        const focus_apply = results.results.focus_apply.result;
        const focus_target = focus_apply == 1 ? skill_value : 1;
  
        let target_number = target_attribute + skill_value;

        let optionalComplication = values.increasedComplication === 'N' ? 'N' : 'Y';
        let complication_range = 21 - difficulty;
        if (optionalComplication === 'N') {
          complication_range = 20;
        }
        const complication_range_text = `${complication_range} - 20`;
  
        const dice = results.results.roll1.dice;
        let successCount = dice.filter(d => d <= target_number).length;
        successCount += dice.filter(d => d <= focus_target).length;
        let complicationCount = dice.filter(d => d >= complication_range).length;

        const success_range_text = `${focus_target + 1} - ${target_number}`;
        const crit_range_text = `1 - ${focus_target}`;

        let target_attribute_text = `${button}`;
        target_attribute_text = target_attribute_text[0].toUpperCase() + target_attribute_text.slice(1);

        let bonus_momentum = successCount - difficulty;
        bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
        let outcome = successCount >= difficulty ? 1 : 0;

        const dice_text = results.results.roll1.dice.toString();
  
        finishRoll(
          results.rollId,
          {
            roll1: number_dice,
            successes: successCount,
            complications: complicationCount,
            target_number: target_number,
            target_attribute: target_attribute,
            target_skill: skill_value,
            skill_text: target_skill_text,
            attribute_text: target_attribute_text,
            difficulty: difficulty,
            complication_range: complication_range_text,
            success_range: success_range_text,
            crit_range: crit_range_text,
            bonus_momentum: bonus_momentum,
            outcome: outcome,
            dice_text: dice_text,
            focus_apply: focus_apply
          }
        );      
      });
    });
  });

// attacks
  const attackSkills = ["repeating_weapons_weapons_type", "repeating_weapons_weapons_focus", "repeating_weapons_weapons_name", "agility", "coordination", "will", "skill_fighting", "skill_academia", "foc_close_quarters", "foc_handguns", "foc_hand_to_hand", "foc_heavy_weapons", "foc_melee_weapons", "foc_rifles", "foc_exotic", "foc_throwing", "foc_occultism","increasedComplication"];
  on("clicked:repeating_weapons:attack-action", function () {
    getAttrs(attackSkills, async function(values) {
      let weaponType = values.repeating_weapons_weapons_type || "";
      let weaponFocus = values.repeating_weapons_weapons_focus || "";
      const subTitle = ((weaponType == "None" || weaponType == "") ? 'Attack' : `${weaponType} - Attack`);
      const description = values.repeating_weapons_weapons_name || "";

      let rollString = "";
      if ((weaponType == "None" || weaponType == "") && (weaponFocus == "None" || weaponFocus == "")) {
        //neither selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[?{Weapon type|Melee,0|Ranged,1|Mental,2}]]}} {{target_skill=[[0]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (weaponType == "None" || weaponType == "") {
        //type not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[?{Weapon type|Melee,0|Ranged,1|Mental,2}]]}} {{target_skill=[[0]]}} {{focus_apply=[[0]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (weaponFocus == "None" || weaponFocus == "") {
        // focus not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[0}]]}} {{target_skill=[[0]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else {
        //both selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{weapon_type=[[0}]]}} {{target_skill=[[0]]}} {{focus_apply=[[0]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      }

      const results = await startRoll(rollString);

      weaponType = ((weaponType == "None" || weaponType == "") ? results.results.weapon_type.result : weaponType);
      let target_attribute_text = "";
      let attribute_value = 0;
      let target_skill_text = ""; //string of skill
      let skill_value = 0; //numeric skill value

      switch(weaponType) {
        case "Melee":
        case 0:
          attribute_value = int(values.agility);
          target_attribute_text = "Agility";
          target_skill_text = "Fighting"; //string of skill
          skill_value = int(values.skill_fighting); //numeric skill value
          break;
        case "Ranged":
        case 1:
          attribute_value = int(values.coordination);
          target_attribute_text = "Coordination";
          target_skill_text = "Fighting"; //string of skill
          skill_value = int(values.skill_fighting); //numeric skill value
              break;
        case "Mental":
        case 2:
          attribute_value = int(values.will);
          target_attribute_text = "Will";
          target_skill_text = "Academia"; //string of skill
          skill_value = int(values.skill_academia); //numeric skill value
              break;
        default:
          attribute_value = int(values.agility);
          target_attribute_text = "Agility";
          target_skill_text = "Fighting"; //string of skill
          skill_value = int(values.skill_fighting); //numeric skill value
          break;
      }

      const number_dice = results.results.num_dice.result;
      const difficulty = results.results.difficulty.result;
      let focus_apply = results.results.focus_apply.result;

      if ((weaponFocus != "None" && weaponFocus != "")) {

        switch(weaponFocus) {
          case "Hand to Hand":
            focus_apply = (values.foc_hand_to_hand == "on" ? 1 : 0);
            break;
          case "Close Quarters":
            focus_apply = (values.foc_close_quarters == "on" ? 1 : 0);
            break;
          case "Melee Weapons":
            focus_apply = (values.foc_melee_weapons == "on" ? 1 : 0);
            break;
          case "Handguns":
            focus_apply = (values.foc_handguns == "on" ? 1 : 0);
            break;
          case "Rifles":
            focus_apply = (values.foc_rifles == "on" ? 1 : 0);
            break;
          case "Heavy Weapons":
            focus_apply = (values.foc_heavy_weapons == "on" ? 1 : 0);
            break;
          case "Exotic":
            focus_apply = (values.foc_exotic == "on" ? 1 : 0);
            break;
          case "Throwing":
            focus_apply = (values.foc_throwing == "on" ? 1 : 0);
            break;
          case "Occultism":
            focus_apply = (values.foc_occultism == "on" ? 1 : 0);
            break;
          default:
            focus_apply = (values.foc_hand_to_hand == "on" ? 1 : 0);
            break;
        }
      }

      const focus_target = focus_apply == 1 ? skill_value : 1;

      let target_number = attribute_value + skill_value;

      let optionalComplication = values.increasedComplication === 'N' ? 'N' : 'Y';
      let complication_range = 21 - difficulty;
      if (optionalComplication === 'N') {
        complication_range = 20;
      }
      const complication_range_text = `${complication_range} - 20`;

      const dice = results.results.roll1.dice;
      let successCount = dice.filter(d => d <= target_number).length;
      successCount += dice.filter(d => d <= focus_target).length;
      let complicationCount = dice.filter(d => d >= complication_range).length;

      const success_range_text = `${focus_target + 1} - ${target_number}`;
      const crit_range_text = `1 - ${focus_target}`;

      target_attribute_text = target_attribute_text[0].toUpperCase() + target_attribute_text.slice(1);

      let bonus_momentum = successCount - difficulty;
      bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
      let outcome = successCount >= difficulty ? 1 : 0;

      const dice_text = results.results.roll1.dice.toString();

      finishRoll(
        results.rollId,
        {
          roll1: number_dice,
          successes: successCount,
          complications: complicationCount,
          target_number: target_number,
          target_attribute: attribute_value,
          target_skill: skill_value,
          skill_text: target_skill_text,
          attribute_text: target_attribute_text,
          difficulty: difficulty,
          complication_range: complication_range_text,
          success_range: success_range_text,
          crit_range: crit_range_text,
          bonus_momentum: bonus_momentum,
          outcome: outcome,
          dice_text: dice_text,
          focus_apply: focus_apply
        }
      );      
    });
  });

  // cast spell
  const spellSkills = ["spell_skill", "repeating_spells_spell_name", "repeating_spells_spell_skill", "repeating_spells_spell_difficulty", "reason", "insight", "will", "foc_occultism", "foc_instincts", "foc_invocation", "foc_discipline", "foc_mysticism"];
  on("clicked:repeating_spells:spell-action", function () {
    getAttrs([...skills,...spellSkills], async function(values) {

      let casterType = values.spell_skill || "";
      let spellSkill = values.repeating_spells_spell_skill || "";
      const subTitle = 'Spell Cast';
      const description = values.repeating_spells_spell_name || "";
      const defaultDifficulty = int(values.repeating_spells_spell_difficulty);

      let focus_apply = 0;
      let focusString = '[[?{Does A Focus Apply|No,0|Yes,1}]]'

      switch(spellSkill) {
        case "Academia":
          focus_apply = (values.foc_occultism == "on" ? 1 : 0);
          break;
        case "Observation":
          focus_apply = (values.foc_instincts == "on" ? 1 : 0);
          break;
        case "Persuasion":
          focus_apply = (values.foc_invocation == "on" ? 1 : 0);
          break;
        case "Resilience":
          focus_apply = (values.foc_discipline == "on" ? 1 : 0);
          break;
        case "Survival":
          focus_apply = (values.foc_mysticism == "on" ? 1 : 0);
          break;
        default:
          focus_apply = 0;
          break;
      }

      if (focus_apply == 1) {
        focusString = '[[?{Does A Focus Apply|Yes,1|No,0}]]'
      }

      let rollString = "";

      if ((spellSkill == "None" || spellSkill == "") && (casterType == "None" || casterType == "")) {
        //neither selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{spellcaster_type=[[?{Spellcaster type|Traditional,0|Researcher,1|Dabbler,2}]]}} {{target_skill=[[?{Relevant Skill|None,0|Academia,1|Athletics,2|Engineering,3|Fighting,4|Medicine,5|Observation,6|Persuasion,7|Resilience,8|Stealth,9|Survival,10|Tactics,11|Vehicles,12}]]}} {{focus_apply=${focusString}}} {{difficulty=[[?{Difficulty|${defaultDifficulty}}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (casterType == "None" || casterType == "") {
        //caster type not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{spellcaster_type=[[?{Spellcaster type|Traditional,0|Researcher,1|Dabbler,2}]]}} {{target_skill=[[0]]}} {{focus_apply=${focusString}}} {{difficulty=[[?{Difficulty|${defaultDifficulty}}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else if (spellSkill == "None" || spellSkill == "") {
        // spell skill not selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{spellcaster_type=[[0}]]}} {{target_skill=[[?{Relevant Skill|None,0|Academia,1|Athletics,2|Engineering,3|Fighting,4|Medicine,5|Observation,6|Persuasion,7|Resilience,8|Stealth,9|Survival,10|Tactics,11|Vehicles,12}]]}} {{focus_apply=${focusString}}} {{difficulty=[[?{Difficulty|${defaultDifficulty}}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      } else {
        //both selected
        rollString = `@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{description=${description}}} {{num_dice=[[?{Dice|2}]]}} {{spellcaster_type=[[0}]]}} {{target_skill=[[0]]}} {{focus_apply=${focusString}}} {{difficulty=[[?{Difficulty|${defaultDifficulty}}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`;
      }

      const results = await startRoll(rollString);

      casterType = ((casterType == "None" || casterType == "") ? results.results.spellcaster_type.result : casterType);
      let target_attribute_text = "";
      let attribute_value = 0;
      let target_skill_text = ""; //string of skill
      let skill_value = 0; //numeric skill value

      switch(casterType) {
        case "Traditional":
        case 0:
          attribute_value = int(values.insight);
          target_attribute_text = "Insight";
          break;
        case "Researcher":
        case 1:
          attribute_value = int(values.reason);
          target_attribute_text = "Reason";
          break;
        case "Dabbler":
        case 2:
          attribute_value = int(values.will);
          target_attribute_text = "Will";
          break;
        default:
          attribute_value = int(values.reason);
          target_attribute_text = "Reason";
        break;
      }

      spellSkill = ((spellSkill == "None" || spellSkill == "") ? results.results.target_skill.result : spellSkill);
      switch(spellSkill) {
        case "None":
        case 0:
          target_skill_text = "None"; //string of skill
          skill_value = 0; //numeric skill value
          break;
        case "Academia":
        case 1:
          target_skill_text = "Academia"; //string of skill
          skill_value = int(values.skill_academia); //numeric skill value
          break;
        case "Athletics":
        case 2:
          target_skill_text = "Athletics"; //string of skill
          skill_value = int(values.skill_athletics); //numeric skill value
          break;
        case "Engineering":
        case 3:
          target_skill_text = "Engineering"; //string of skill
          skill_value = int(values.skill_engineering); //numeric skill value
          break;
        case "Fighting":
        case 4:
          target_skill_text = "Fighting"; //string of skill
          skill_value = int(values.skill_fighting); //numeric skill value
          break;
        case "Medicine":
        case 5:
          target_skill_text = "Medicine"; //string of skill
          skill_value = int(values.skill_medicine); //numeric skill value
          break;
        case "Observation":
        case 6:
          target_skill_text = "Observation"; //string of skill
          skill_value = int(values.skill_observation); //numeric skill value
          break;
        case "Persuasion":
        case 7:
          target_skill_text = "Persuasion"; //string of skill
          skill_value = int(values.skill_persuasion); //numeric skill value
          break;
        case "Resilience":
        case 8:
          target_skill_text = "Resilience"; //string of skill
          skill_value = int(values.skill_resilience); //numeric skill value
          break;
        case "Stealth":
        case 9:
          target_skill_text = "Stealth"; //string of skill
          skill_value = int(values.skill_stealth); //numeric skill value
          break;
        case "Survival":
        case 10:
          target_skill_text = "Survival"; //string of skill
          skill_value = int(values.skill_survival); //numeric skill value
          break;
        case "Tactics":
        case 11:
          target_skill_text = "Tactics"; //string of skill
          skill_value = int(values.skill_tactics); //numeric skill value
          break;
        case "Vehicles":
        case 12:
          target_skill_text = "Vehicles"; //string of skill
          skill_value = int(values.skill_vehicles); //numeric skill value
          break;
        default:
          target_skill_text = "None"; //string of skill
          skill_value = 0; //numeric skill value
          break;
      }

      const number_dice = results.results.num_dice.result;
      const difficulty = results.results.difficulty.result;
      focus_apply = results.results.focus_apply.result;

      const focus_target = focus_apply == 1 ? skill_value : 1;

      let target_number = attribute_value + skill_value;

      //spell casting always uses increased complications, page 141
      //let optionalComplication = values.increasedComplication === 'N' ? 'N' : 'Y';
      let complication_range = 21 - difficulty;
      //if (optionalComplication === 'N') {
        //complication_range = 20;
      //}
      const complication_range_text = `${complication_range} - 20`;

      const dice = results.results.roll1.dice;
      let successCount = dice.filter(d => d <= target_number).length;
      successCount += dice.filter(d => d <= focus_target).length;
      let complicationCount = dice.filter(d => d >= complication_range).length;

      const success_range_text = `${focus_target + 1} - ${target_number}`;
      const crit_range_text = `1 - ${focus_target}`;

      target_attribute_text = target_attribute_text[0].toUpperCase() + target_attribute_text.slice(1);

      let bonus_momentum = successCount - difficulty;
      bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
      let outcome = successCount >= difficulty ? 1 : 0;

      const dice_text = results.results.roll1.dice.toString();

      finishRoll(
        results.rollId,
        {
          roll1: number_dice,
          successes: successCount,
          complications: complicationCount,
          target_number: target_number,
          target_attribute: attribute_value,
          target_skill: skill_value,
          skill_text: target_skill_text,
          attribute_text: target_attribute_text,
          difficulty: difficulty,
          complication_range: complication_range_text,
          success_range: success_range_text,
          crit_range: crit_range_text,
          bonus_momentum: bonus_momentum,
          outcome: outcome,
          dice_text: dice_text,
          focus_apply: focus_apply
        }
      );      
    });
  });

// generic skill check
on(`clicked:genericSkill-action`, () => {
  getAttrs([...skills,...stats], async function(values) {
    const subTitle = 'Skill Check';
    const results = await startRoll(`@{whisper}&{template:skill} {{title=@{character_name}}} {{subtitle=${subTitle}}} {{num_dice=[[?{Dice|2}]]}} {{relevant_attribute=[[?{Relevant Attribute|Agility,1|Brawn,2|Coordination,3|Insight,4|Reason,5|Will,6}]]}} {{target_skill=[[?{Relevant Skill|None,0|Academia,1|Athletics,2|Engineering,3|Fighting,4|Medicine,5|Observation,6|Persuasion,7|Resilience,8|Stealth,9|Survival,10|Tactics,11|Vehicles,12}]]}} {{focus_apply=[[?{Does A Focus Apply|No,0|Yes,1}]]}} {{difficulty=[[?{Difficulty|1}]]}} {{target_attribute=[[0]]}} {{roll1=[[?{Dice}d20cs<0cf>21]]}} {{skill_text=[[0]]}} {{attribute_text=[[0]]}} {{target_number=[[0]]}} {{successes=[[0]]}} {{complications=[[0]]}} {{complication_range=[[0]]}} {{success_range=[[0]]}} {{crit_range=[[0]]}} {{bonus_momentum=[[0]]}} {{outcome=[[0]]}} {{dice_text=[[0]]}} }`);

    const target_skill = results.results.target_skill.result; //int select value 
    let target_skill_text = ""; //string of skill
    let skill_value = 0; //numeric skill value

    switch(target_skill) {
      case 1:
        skill_value = int(values.skill_academia);
        target_skill_text = "Academia";
        break;
      case 2:
        skill_value = int(values.skill_athletics);
        target_skill_text = "Athletics";
        break;
      case 3:
        skill_value = int(values.skill_engineering);
        target_skill_text = "Engineering";
        break;
      case 4:
        skill_value = int(values.skill_fighting);
        target_skill_text = "Fighting";
        break;
      case 5:
        skill_value = int(values.skill_medicine);
        target_skill_text = "Medicine";
        break;
      case 6:
        skill_value = int(values.skill_observation);
        target_skill_text = "Observation";
        break;
      case 7:
        skill_value = int(values.skill_persuasion);
        target_skill_text = "Persuasion";
        break;
      case 8:
        skill_value = int(values.skill_resilience);
        target_skill_text = "Resilience";
        break;
      case 9:
        skill_value = int(values.skill_stealth);
        target_skill_text = "Stealth";
        break;
      case 10:
        skill_value = int(values.skill_survival);
        target_skill_text = "Survival";
        break;
      case 11:
        skill_value = int(values.skill_tactics);
        target_skill_text = "Tactics";
        break;
      case 12:
        skill_value = int(values.skill_vehicles);
        target_skill_text = "Vehicles";
        break;
      default:
        skill_value = 0;
        target_skill_text = "None";
        break;
    }

    const relevant_attribute = results.results.relevant_attribute.result;
    let target_attribute = 0;
    let target_attribute_text = "";

    switch(relevant_attribute) {
      case 1:
        target_attribute = int(values.agility);
        target_attribute_text = "Agility";
        break;
      break;
      case 2:
        target_attribute = int(values.brawn);
        target_attribute_text = "Brawn";
        break;
      case 3:
        target_attribute = int(values.coordination);
        target_attribute_text = "Coordination";
        break;
      case 4:
        target_attribute = int(values.insight);
        target_attribute_text = "Insight";
        break;
      case 5:
        target_attribute = int(values.reason);
        target_attribute_text = "Reason";
        break;
      case 6:
        target_attribute = int(values.will);
        target_attribute_text = "Will";
        break;
      default:
        target_attribute = 0;
        target_attribute_text = "None";
        break;
    }

    const number_dice = results.results.num_dice.result;
    const difficulty = results.results.difficulty.result;
    const focus_apply = results.results.focus_apply.result;
    const focus_target = focus_apply == 1 ? skill_value : 1;

    let target_number = target_attribute + skill_value;

    let optionalComplication = values.increasedComplication === 'N' ? 'N' : 'Y';
    let complication_range = 21 - difficulty;
    if (optionalComplication === 'N') {
      complication_range = 20;
    }
    const complication_range_text = `${complication_range} - 20`;

    const dice = results.results.roll1.dice;
    let successCount = dice.filter(d => d <= target_number).length;
    successCount += dice.filter(d => d <= focus_target).length;
    let complicationCount = dice.filter(d => d >= complication_range).length;

    const success_range_text = `${focus_target + 1} - ${target_number}`;
    const crit_range_text = `1 - ${focus_target}`;

    let bonus_momentum = successCount - difficulty;
    bonus_momentum = bonus_momentum < 0 ? 0 : bonus_momentum;
    let outcome = successCount >= difficulty ? 1 : 0;

    const dice_text = results.results.roll1.dice.toString();

    finishRoll(
      results.rollId,
      {
        roll1: number_dice,
        successes: successCount,
        complications: complicationCount,
        target_number: target_number,
        target_attribute: target_attribute,
        target_skill: skill_value,
        skill_text: target_skill_text,
        attribute_text: target_attribute_text,
        difficulty: difficulty,
        complication_range: complication_range_text,
        success_range: success_range_text,
        crit_range: crit_range_text,
        bonus_momentum: bonus_momentum,
        outcome: outcome,
        dice_text: dice_text,
        focus_apply: focus_apply
      }
    );      
  });
});

// weapons damage
const damageSkills = ["repeating_weapons_weapons_type", "repeating_weapons_stress_dice", "repeating_weapons_weapons_name", "repeating_weapons_weapons_damage", "repeating_weapons_weapons_salvo", "brawn_bonus_dmg", "insight_bonus_dmg", "will_bonus_dmg"];
on("clicked:repeating_weapons:damage-action", function () {
  getAttrs(damageSkills, async function(values) {

    let numDice = 0;
    let stressDice = int(values.repeating_weapons_stress_dice);
    let bonusdice = 0;

    const weaponType = values.repeating_weapons_weapons_type || "";
    switch(weaponType) {
      case "Melee":
        bonusdice = int(values.brawn_bonus_dmg);
        break;
      case "Ranged":
        bonusdice = int(values.insight_bonus_dmg);
        break;
      case "Mental":
        bonusdice = int(values.brawn_bonus_dmg);
        break;
      default:
        bonusdice = 0;
        break;
    }

    numDice = stressDice + bonusdice;

    const description = values.repeating_weapons_weapons_name || "";
    const stressEffects = values.repeating_weapons_weapons_damage || "";
    const salvoEffects = values.repeating_weapons_weapons_salvo || "";
    const rollString = `@{whisper}&{template:damage} {{title=@{character_name}}} {{subtitle=Damage Roll}} {{description=${description}}} {{num_dice=[[?{Dice|${numDice}}]]}} {{roll1=[[?{Dice}d6cs<0cf>21]]}} {{total_stress=[[0]]}} {{total_effects=[[0]]}} {{stress_effects=${stressEffects}}} {{salvo_effects=${salvoEffects}}} }`;
    const results = await startRoll(rollString);

    const number_dice = results.results.num_dice.result;
    const dice = results.results.roll1.dice;
    let nmbrStress = 0;
    let nmbrEffects = 0;
    
    dice.forEach(die => {
      switch(die) {
        case 1:
          nmbrStress += 1;
          break;
        case 2:
          nmbrStress += 2;
          break;
        case 3:
          break;
        case 4:
          break;
        case 5:
          nmbrStress += 1;
          nmbrEffects += 1;
          break;
        case 6:
          nmbrStress += 1;
          nmbrEffects += 1;
          break;
      }
    });

    finishRoll(
      results.rollId,
      {
        roll1: number_dice,
        total_stress: nmbrStress,
        total_effects: nmbrEffects
      }
    );      
  });
});

// spell damage
const spellDamageSkills = ["spells_power_total"];
on("clicked:spell_power-action", function () {
  getAttrs(spellDamageSkills, async function(values) {

    let numDice = int(values.spells_power_total);

    const description = "Spell Damage";
    const stressEffects = "";
    const salvoEffects = "";
    const rollString = `@{whisper}&{template:damage} {{title=@{character_name}}} {{subtitle=Damage Roll}} {{description=${description}}} {{num_dice=[[?{Dice|${numDice}}]]}} {{roll1=[[?{Dice}d6cs<0cf>21]]}} {{total_stress=[[0]]}} {{total_effects=[[0]]}} {{stress_effects=${stressEffects}}} {{salvo_effects=${salvoEffects}}} }`;
    const results = await startRoll(rollString);

    const number_dice = results.results.num_dice.result;
    const dice = results.results.roll1.dice;
    let nmbrStress = 0;
    let nmbrEffects = 0;
    
    dice.forEach(die => {
      switch(die) {
        case 1:
          nmbrStress += 1;
          break;
        case 2:
          nmbrStress += 2;
          break;
        case 3:
          break;
        case 4:
          break;
        case 5:
          nmbrStress += 1;
          nmbrEffects += 1;
          break;
        case 6:
          nmbrStress += 1;
          nmbrEffects += 1;
          break;
      }
    });

    finishRoll(
      results.rollId,
      {
        roll1: number_dice,
        total_stress: nmbrStress,
        total_effects: nmbrEffects
      }
    );      
  });
});

// generic damage
on("clicked:genericDamage-action", async function () {
  let numDice = 1;

  const description = "Generic Damage";
  const stressEffects = "";
  const salvoEffects = "";
  const rollString = `@{whisper}&{template:damage} {{title=@{character_name}}} {{subtitle=Damage Roll}} {{description=${description}}} {{num_dice=[[?{Dice|${numDice}}]]}} {{roll1=[[?{Dice}d6cs<0cf>21]]}} {{total_stress=[[0]]}} {{total_effects=[[0]]}} {{stress_effects=${stressEffects}}} {{salvo_effects=${salvoEffects}}} }`;
  const results = await startRoll(rollString);

  const number_dice = results.results.num_dice.result;
  const dice = results.results.roll1.dice;
  let nmbrStress = 0;
  let nmbrEffects = 0;
  
  dice.forEach(die => {
    switch(die) {
      case 1:
        nmbrStress += 1;
        break;
      case 2:
        nmbrStress += 2;
        break;
      case 3:
        break;
      case 4:
        break;
      case 5:
        nmbrStress += 1;
        nmbrEffects += 1;
        break;
      case 6:
        nmbrStress += 1;
        nmbrEffects += 1;
        break;
    }
  });

  finishRoll(
    results.rollId,
    {
      roll1: number_dice,
      total_stress: nmbrStress,
      total_effects: nmbrEffects
    }
  );      
});

<!-- Some stuff to run everytime the sheet opens -->

  on('sheet:opened',function(){
  	$20("#act_main_char").addClass('tab_button_selected');
  	setAttrs({
  		sheetTab: "main_char"
  	});
    hideShowSpellTradition();
    calcualteStressValues();
    calcualteSpellPower();
    checkAttributesBounds();
    checkSkillsBounds();
  });


  <!-- set the attributes and buttons correct so roll buttons trigger action buttons -->

  //A function to combine getting repeating and non repeating attributes.
const getAllAttrs = function(props,sectionDetails,callback){
  getSections(sectionDetails,(repeats,sections)=>{
    getAttrs([...props,...repeats],(attributes)=>{
      callback(attributes,sections);
    })
  });
};
//Iterates over the provided repeating sections and assembles an array of attributes to get from those sections for each row.
const getSections = function(section_details,callback){
  let queueClone = _.clone(section_details);
  const worker = (queue,repeatAttrs=[],sections={})=>{
    let detail = queue.shift();
    getSectionIDs(detail.section,(IDs)=>{
      sections[detail.section] = IDs;
      IDs.forEach((id)=>{
        detail.fields.forEach((f)=>{
          repeatAttrs.push(`${detail.section}_${id}_${f}`);
        });
      });
      repeatAttrs.push(`_reporder_${detail.section}`);
      if(queue.length){
        worker(queue,repeatAttrs,sections);
      }else{
        callback(repeatAttrs,sections);
      }
    });
  };
  if(!queueClone[0]){
    callback([],{});
  }
  worker(queueClone);
};


const repeatingSections = [{section:'repeating_weapons',fields:['attack_action', 'damage_action']},{section:'repeating_spells',fields:['spell_action']}];//Replace these with your sheet's repeating sections
const actionRefs = ['character_name', 'agility_action', 'brawn_action', 'coordination_action', 'insight_action', 'reason_action', 'will_action', 'spell_power_action','genericDamage_action', 'genericSkill_action'];//Replace these with the non repeating attributes for your sheet.
const actionCallUpdate = function(){
  getAllAttrs(['character_name',...actionRefs],repeatingSections,(attributes,sections)=>{
    let actions = Object.keys(attributes).filter((key)=>key!=='character_name');
    const setObj = actions.reduce((accumulator,actionName)=>{
      accumulator[actionName] = `%{${attributes.character_name}|${actionName.replace(/_([^_]*)$/,'-' + '$1')}}`;//Update the action call
      return accumulator;//The memo (accumulator in this case) must always be returned when using a reduce function
    },{});
    setAttrs(setObj,{silent:true});//Apply the changes
  });
};

on('sheet:opened change:character_name change:repeating_weapons:weapons_type',actionCallUpdate);

</script>