<div class="container">
    <!-- HEADER -->
    <div class="flex-row header">
        <div class="w-3 flex-column name justify-end align-end">
            <input type="text" class="w-8 visible-input" name="attr_character_name">
            <label class="w-8 label"><span data-i18n="header.character.name">Nom</span></label>
        </div>
        <div class="w-9 flex-column charbox justify-se">
            <div class="flex-row">
                <div class="flex-column w-6">
                    <input type="text" class="visible-input w-12" name="attr_class_level" readonly>
                    <label class="label"><span data-i18n="header.character.classes_levels">Classes & Niveaux</span></label>
                </div>
                <div class="flex-column w-2">
                    <input type="text" class="visible-input w-12" name="attr_alignement">
                    <label class="label"><span data-i18n="header.character.alignment">Alignement</span></label>
                </div>
            </div>
            <div class="flex-row">
                <div class="flex-column w-3">
                    <input type="text" class="visible-input" name="attr_race">
                    <label class="label"><span data-i18n="header.character.race">Race</span></label>
                </div>
                <div class="flex-column w-2">
                    <input type="text" class="visible-input" name="attr_sexe">
                    <label class="label"><span data-i18n="header.character.sex">Sexe</span></label>
                </div>
                <div class="flex-column w-2">
                    <input type="text" class="visible-input" name="attr_peau">
                    <label class="label"><span data-i18n="header.character.skin">Peau</span></label>
                </div>
                <div class="flex-column w-2">
                    <input type="text" class="visible-input" name="attr_cheveux">
                    <label class="label"><span data-i18n="header.character.hair">Cheveux</span></label>
                </div>
                <div class="flex-column w-2">
                    <input type="text" class="visible-input" name="attr_yeux">
                    <label class="label"><span data-i18n="header.character.eyes">Yeux</span></label>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="main"/>
    <input type="hidden" class="charactertoogle" name="attr_characterType" value="pc"/>
    <div class="button-row flex-row justify-end">
        <button type="action" name="act_character" class="button0"><span data-i18n="header.buttons.principal">Principal</span></button>
        <button type="action" name="act_journal" class="button1"><span data-i18n="header.buttons.bio">Bio</span></button>
        <button type="action" name="act_spells" class="button2"><span data-i18n="header.buttons.spells">Sorts</span></button>
        <button type="action" name="act_configuration" class="button3"><span data-i18n="header.buttons.configuration">Configuration</span></button>
    </div>

    <!-- PC Core-->
    <div class="flex-row pc-core">
        <div class="flex-column gap-2 w-4">
            <div class="flex-row gap-3 align-stretch">
                <!-- ATTRIBUTES !-->
                
                <div class="attributes w-3">
                  <div class="attribute">
                    <button class="button-label" value="@{for_rollvalue}" type="roll"><span data-i18n="attribute.for">for</span></button><span class="mod" type="text" name="attr_for_mod"></span>
                    <input type="hidden" name="attr_for_rollvalue" value="&amp;{template:main} {{titre=^{attribute.for.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{for_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_for_modified" value="false"/>
                      <input class="base" type="number" name="attr_for_base" value="10"/><span name="attr_for_total">10</span>
                    </div>
                  </div>
                  <div class="attribute">
                    <button class="button-label" value="@{dex_rollvalue}" type="roll"><span data-i18n="attribute.dex">dex</span></button><span class="mod" type="text" name="attr_dex_mod"></span>
                    <input type="hidden" name="attr_dex_rollvalue" value="&amp;{template:main} {{titre=^{attribute.dex.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{dex_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_dex_modified" value="false"/>
                      <input class="base" type="number" name="attr_dex_base" value="10"/><span name="attr_dex_total">10</span>
                    </div>
                  </div>
                  <div class="attribute">
                    <button class="button-label" value="@{int_rollvalue}" type="roll"><span data-i18n="attribute.int">int</span></button><span class="mod" type="text" name="attr_int_mod"></span>
                    <input type="hidden" name="attr_int_rollvalue" value="&amp;{template:main} {{titre=^{attribute.int.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{int_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_int_modified" value="false"/>
                      <input class="base" type="number" name="attr_int_base" value="10"/><span name="attr_int_total">10</span>
                    </div>
                  </div>
                  <div class="attribute">
                    <button class="button-label" value="@{con_rollvalue}" type="roll"><span data-i18n="attribute.con">con</span></button><span class="mod" type="text" name="attr_con_mod"></span>
                    <input type="hidden" name="attr_con_rollvalue" value="&amp;{template:main} {{titre=^{attribute.con.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{con_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_con_modified" value="false"/>
                      <input class="base" type="number" name="attr_con_base" value="10"/><span name="attr_con_total">10</span>
                    </div>
                  </div>
                  <div class="attribute">
                    <button class="button-label" value="@{sag_rollvalue}" type="roll"><span data-i18n="attribute.sag">sag</span></button><span class="mod" type="text" name="attr_sag_mod"></span>
                    <input type="hidden" name="attr_sag_rollvalue" value="&amp;{template:main} {{titre=^{attribute.sag.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{sag_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_sag_modified" value="false"/>
                      <input class="base" type="number" name="attr_sag_base" value="10"/><span name="attr_sag_total">10</span>
                    </div>
                  </div>
                  <div class="attribute">
                    <button class="button-label" value="@{cha_rollvalue}" type="roll"><span data-i18n="attribute.cha">cha</span></button><span class="mod" type="text" name="attr_cha_mod"></span>
                    <input type="hidden" name="attr_cha_rollvalue" value="&amp;{template:main} {{titre=^{attribute.cha.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{cha_mod}]]}}"/>
                    <div class="base">
                      <input type="hidden" name="attr_cha_modified" value="false"/>
                      <input class="base" type="number" name="attr_cha_base" value="10"/><span name="attr_cha_total">10</span>
                    </div>
                  </div>
                </div>
                <!-- JDS & Compétences !-->
                <div class="flex-column gap-2 w-9">
                    <div class="saves frame-ct">
                        <h4 class="top-title"><span data-i18n="saves.title">Jets de sauvegardes</span></h4>
                        <div class="flex-row save">
                            <label class="label w-3"><span data-i18n="common.total">Total</span></label>
                            <label class="label w-6"></label>
                        </div>
                        <div class="flex-row save">
                            <input type="hidden" name="attr_ref_base">
                            <input type="hidden" class="input w-3" name="attr_ref_modified">
                            <input type="number" class="input w-3" name="attr_ref_total" readonly>
                            <input type="hidden" name="attr_ref_roll_value"
                                   value="&{template:main} {{titre=Test de Réflexes}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{dex_mod}+@{ref_base}+@{ref_mod}]]}}">
                            <button type="roll" name="attr_ref_roll" value="@{ref_roll_value}"
                                    class="button-label bold w-6"><span data-i18n="saves.reflex">Réflexes</span>
                            </button>
                        </div>
                        <div class="flex-row save">
                            <input type="hidden" name="attr_vig_base">
                            <input type="hidden" class="input w-3" name="attr_vig_modified">
                            <input type="hidden" class="input w-3" name="attr_vig_rollvalue">
                            <input type="number" class="input w-3" name="attr_vig_total" readonly>
                            <input type="hidden" name="attr_vig_roll_value"
                                   value="&{template:main} {{titre=Test de Vigueur}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{con_mod}+@{vig_base}+@{vig_mod}]]}}">
                            <button type="roll" name="attr_vig_roll" value="@{vig_roll_value}"
                                    class="button-label bold w-6"><span data-i18n="saves.fortitude">Vigueur</span>
                            </button>
                        </div>
                        <div class="flex-row save">
                            <input type="hidden" name="attr_vol_base">
                            <input type="hidden" class="input w-3" name="attr_vol_modified">
                            <input type="hidden" class="input w-3" name="attr_vol_rollvalue">
                            <input type="number" class="input w-3" name="attr_vol_total" readonly>
                            <input type="hidden" name="attr_vol_roll_value"
                                   value="&{template:main} {{titre=Test de Volonté}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{sag_mod}+@{vol_base}+@{vol_mod}]]}}">
                            <button type="roll" name="attr_vol_roll" value="@{vol_roll_value}"
                                    class="button-label bold w-6"><span data-i18n="saves.willpower">Volonté</span>
                            </button>
                        </div>
                    </div>
                    <div class="skills frame-cm">
                        <h4 class="top-title"><span data-i18n="skills.title">Skills</span></h4>
                        <div class="flex-column">
                            <div class="flex-row skill-header-row">
                                <label class="label w-2 text-center"><span data-i18n="skills.total">Tot.</span></label>
                                <label class="label w-10"><span data-i18n="skills.name">Name</span></label>
                            </div>
                            <input type="hidden" name="attr_skills_malus">
                            <fieldset class="repeating_skills">
                                <div class="skill">
                                    <input class="options-flag" type="checkbox" name="attr_options-flag"
                                           checked><span>y</span>
                                    <div class="flex-row align-center">
                                        <input type="hidden" name="attr_modified">
                                        <input type="number" class="input w-2" name="attr_total" value="0" readonly>
                                        <div class="wa">
                                            <input type="hidden" name="attr_skillrollvalue"
                                                   value="&{template:main} {{titre=Test de '@{name}'}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{total}]]}}">
                                            <button name="attr_skillroll" type="roll" value="@{skillrollvalue}"
                                                    class="button-label bold w-10 text-left">
                                                <span name="attr_name"></span>&nbsp;<span name="attr_caracname"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex-column options-options border-bottom">
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.name">Name</span> :</label>
                                            <input type="text" class="w-7 visible-input" name="attr_name">
                                        </div>
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.ranks">Rangs</span> :</label>
                                            <input type="number" class="visible-input w-7" name="attr_ranks">
                                        </div>
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.caracteristics">Carac.</span> :</label>
                                            <select class="w-7" name="attr_carac">
                                                <option value="@{for_mod}" data-i18n="attribute.strength.long">Force</option>
                                                <option value="@{dex_mod}" data-i18n="attribute.dexterity.long">Dextérité</option>
                                                <option value="@{con_mod}" data-i18n="attribute.constitution.long">Constitution</option>
                                                <option value="@{int_mod}" data-i18n="attribute.intelligence.long">Intelligence</option>
                                                <option value="@{sag_mod}" data-i18n="attribute.wisdom.long">Sagesse</option>
                                                <option value="@{cha_mod}" data-i18n="attribute.charisma.long">Charisme</option>
                                            </select>
                                            <input type="hidden" name="attr_caracname">
                                        </div>
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.malus">Malus*</span> :</label>
                                            <select class="w-7" name="attr_has_armor_malus">
                                                <option value="off" data-i18n="common.no">Non</option>
                                                <option value="on" data-i18n="common.yes">Oui</option>
                                                <option value="double" data-i18n="skills.x2">x2</option>
                                            </select>
                                        </div>
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.modifier">Mod</span> :</label>
                                            <input type="number" class="visible-input w-7" name="attr_mod">
                                        </div>
                                        <div class="flex-row align-center">
                                            <label class="skill-label w-5"><span data-i18n="skills.synergy">Synergie</span> :</label>
                                            <input type="number" class="visible-input w-7" name="attr_synergy">
                                        </div>
                                        <label class="skill-label w-5"><span data-i18n="common.notes">Notes</span> :</label>
                                        <input type="text" class="w-12 visible-input" name="attr_notes">
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-column">
                <!-- Autres Maitrises !-->
                <div class="flex-column masteries frame-cm">
                    <h4 class="top-title"><span data-i18n="masteries.title">Maitrises</span></h4>
                    <div class="flex-row">
                        <label class="label text-center w-4"><span data-i18n="masteries.type">Type</span></label>
                        <label class="label text-left w-7"><span data-i18n="masteries.description">Description</span></label>
                        <span class="picto invisible w-1"></span>
                    </div>
                    <fieldset class="repeating_masteries">
                        <div class="flex-row">
                            <input type="text" class="visible-input text-center w-4"
                                   name="attr_mastery-type">
                            <input type="text" class="visible-input w-7" name="attr_mastery-desc">
                            <input type="hidden" name="attr_masteryrollvalue"
                                   value="&{template:main} {{titre=^{rolltemplate.mastery} (@{mastery-type})}} {{subtitle=@{character_name} }} {{description=@{mastery-desc}}}">
                            <button name="attr_skillroll" type="roll" value="@{masteryrollvalue}"
                                    class="button-roll picto w-1">w
                            </button>
                        </div>
                    </fieldset>
                </div>
                <!-- Armures -->
                <div class="flex-column masteries frame-cb">
                    <div class="armor flex-column">
                        <input class="options-flag" type="checkbox" name="attr_armor_options-flag"
                               checked><span>y</span>
                        <label class="w-12 label">
                            <span class="bold"><span class="bold" data-i18n="defenses.armor">Armure</span> :</span> <span name="attr_armor_name"></span>&nbsp;
                        </label>
                        <div class="flex-column options-options">
                            <div class="flex-row align-center">
                                <label class="label text-right w-3"><span data-i18n="defenses.name">Nom</span> :</label>
                                <input type="text" class="visible-input w-9 " name="attr_armor_name">
                            </div>
                            <label class="label text-left w-12"><span data-i18n="defenses.properties">Caractéristiques</span> :</label>
                            <div class="flex-row gap05">
                                <div class="flex-column w-3">
                                    <input type="number" class="visible-input w-12" name="attr_armor_bonus">
                                    <label class="label text-center"><span data-i18n="defenses.bonus">Bonus</span></label>
                                </div>
                                <div class="flex-column w-3">
                                    <input type="number" class="visible-input w-12" name="attr_armor_max_dex">
                                    <label class="label text-center"><span data-i18n="defenses.maximum.dexterity">Dex Max</span></label>
                                </div>
                                <div class="flex-column w-3">
                                    <input type="number" class="visible-input w-12" name="attr_armor_malus">
                                    <label class="label text-center"><span data-i18n="defenses.malus">Malus</span></label>
                                </div>
                                <div class="flex-column w-4 justify-end">
                                    <input type="checkbox" class="visible-input w-12" name="attr_armor_equipe">
                                    <label class="label text-center"><span data-i18n="defenses.equiped">Équipé?</span></label>
                                </div>
                            </div>
                            <label class="label text-left w-3"><span data-i18n="common.notes">Notes</span> :</label>
                            <input type="text" class="visible-input w-12 " name="attr_armor_notes">
                        </div>
                    </div>
                    <div class="armor flex-column">
                        <input class="options-flag" type="checkbox" name="attr_shield_options-flag"
                               checked><span>y</span>
                        <label class="w-12 label">
                            <span class="bold"><span class="bold" data-i18n="defenses.shield">Bouclier </span>:</span> <span name="attr_shield_name"></span>&nbsp;
                        </label>
                        <div class="flex-column options-options">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="defenses.name">Nom</span> :</label>
                                <input type="text" class="visible-input w-9 " name="attr_shield_name">
                            </div>
                            <div class="flex-row gap05">
                                <div class="flex-column w-4">
                                    <input type="number" class="visible-input w-12" name="attr_shield_bonus">
                                    <label class="label text-center"><span data-i18n="defenses.bonus">Bonus</span></label>
                                </div>
                                <div class="flex-column w-4">
                                    <input type="number" class="visible-input w-12" name="attr_shield_malus">
                                    <label class="label text-center"><span data-i18n="defenses.malus">Malus</span></label>
                                </div>
                                <div class="flex-column w-4 justify-end">
                                    <input type="checkbox" class="visible-input w-12" name="attr_shield_equipe">
                                    <label class="label text-center"><span data-i18n="defenses.equiped">Équipé?</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h4 class="bottom-title"><span data-i18n="defenses.title">Armure</span></h4>
                </div>
            </div>
        </div>
        <div class="flex-column w-4">
            <div class="flex-column gray-bg-b">
                <!-- AC Récapitulatif !-->
                <div class="flex-row AC-Recap">
                    <div class="w-3 AC">
                        <input type="number" class="input" name="attr_ac_tot" readonly>
                        <label class="label"><span data-i18n="defenses.ac">Classe d'armure</span></label>
                    </div>
                    <div class="w-3 AC">
                        <input type="number" class="input" name="attr_ac_tot_ff" readonly>
                        <label class="label"><span data-i18n="defenses.ac.flatfooted">Pris au Dépourvu</label>
                    </div>
                    <div class="w-3 AC">
                        <input type="number" class="input" name="attr_ac_tot_t" readonly>
                        <label class="label"><span data-i18n="defenses.ac.touch">CA de<br>contact</span></label>
                    </div>
                </div>
                <!-- Init Rd Vitesse  !-->
                <div class="flex-row stats">
                    <div class="w-4 stat">
                        <input type="hidden" name="attr_init_modified" value="false">
                        <input type="number" class="input" name="attr_init_tot" step="0.01" readonly>
                        <input type="hidden" name="attr_init_rol_value"
                               value="&{template:main} {{titre=^{stats.initiative} }} {{subtitle=@{character_name}}} {{Jet=[[1D20+@{init_tot} &{tracker}]]}}">
                        <button name="attr_init_roll" type="roll" value="@{init_rol_value}"
                                class="button-label bold text-center">
                            <span data-i18n="stats.initiative">Initiative</span>
                        </button>
                    </div>
                    <div class="w-4 stat">
                        <input type="number" class="input" name="attr_rd">
                        <label class="label"><span data-i18n="stats.dr">RD</span></label>
                    </div>
                    <div class="w-4 stat">
                        <div class="speed-container">
                            <input type="hidden" name="attr_vit_modified">
                            <span name="attr_vit_total"></span>
                            <input type="number" class="input" name="attr_vit_base">
                        </div>
                        <label class="label"><span data-i18n="stats.speed">Vitesse</span></label>
                    </div>
                </div>
    
                <div class="flex-column HP frame-ct">
                    <div class="flex-row justify-center align-center">
                        <label class="label-secondary text-right w-6"><span data-i18n="health.max">Points de vie max</span></label>
                        <input type="number" class="visible-input w-6" name="attr_pv_max">
                    </div>
                    <input type="number" class="input" name="attr_pv">
                    <h4 class="bottom-title"><span data-i18n="health.current">Points de vies Actuels</span></h4>
                </div>
                <div class="flex-column HP frame-cb">
                    <input type="number" class="input" name="attr_pv_tmp">
                    <h4 class="bottom-title"><span data-i18n="health.temporary">Points de vies temporaires</span></h4>
                </div>
            </div>
            <!-- Attaques -->
            <div class="flex-column attaques frame-c">
                <div class="flex-row top">
                    <label class="label-secondary w-6"><span data-i18n="common.name">Nom</span></label>
                    <label class="label-secondary w-2 text-center"><span data-i18n="attacks.attack.long">Att</span></label>
                    <label class="label-secondary w-4 text-center"><span data-i18n="attacks.damage.long">Dégats</label>
                </div>
                <fieldset class="repeating_attaques">
                    <div class="attq">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked><span>y</span>
                        <div class="flex-row align-center">
                            <input type="hidden" name="attr_atq-rollvalue"
                                   value="&{template:main} {{titre=Attaque avec @{name}}} {{subtitle=@{character_name}}} {{Attaque=[[1d20+@{bba}+@{atq-carac-val}+@{atq-bonus}+@{atq-bonus-2}]]}} {{Dégats=[[@{dgt-base}+@{dgt-carac-val}+@{dgt-bonus}]]}}">
                            <button type="roll" name="attr_atq-roll" value="@{atq-rollvalue}"
                                    class="gray-line flex-row bold w-12 button-label">
                                <span class="w-6" name="attr_name"></span>
                                <span class="w-2 text-center" name="attr_atq-total"></span>
                                <span class="w-4 text-center" name="attr_degats"></span>
                            </button>
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="common.name">Nom</span> :</label>
                                <input type="text" class="visible-input text-left w-9" name="attr_name">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.attack.long">Atq</span> :</label>
                                <select class="w-3" name="attr_atq-carac">
                                    <option value="-">-</option>
                                    <option value="FOR" data-i18n="attribute.strength.short">FOR</option>
                                    <option value="DEX" data-i18n="attribute.dexterity.short">DEX</option>
                                </select>
                                +
                                <input type="number" class="visible-input w-2" name="attr_atq-bonus">
                                +
                                <input type="number" class="visible-input w-2" name="attr_atq-bonus-2">
                                <input type="hidden" name="attr_atq-total">
                                <input type="hidden" name="attr_atq-carac-val">
                                <input type="hidden" name="attr_degats">
                                <input type="hidden" name="attr_dgt-carac-val">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.damage.long">Dgt</span> :</label>
                                <input type="text" class="visible-input w-2" name="attr_dgt-base"
                                       placeholder="1d4">
                                +
                                <select class="w-4" name="attr_dgt-carac">
                                    <option value="-">-</option>
                                    <option value="FOR" data-i18n="attribute.strength.short">FOR</option>
                                    <option value="DEX" data-i18n="attribute.dexterity.short">DEX</option>
                                    <option value="1,5FOR" data-i18n="attribute.strength.onehalf">1,5 x FOR</option>
                                    <option value="1/2FOR" data-i18n="attribute.strength.half">1/2 xFOR</option>
                                </select>
                                +
                                <input type="number" class="visible-input w-2" name="attr_dgt-bonus">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.range">Portée </span> :</label>
                                <input type="text" class="visible-input text-left w-9" name="attr_range">
                            </div>
                            <div class="flex-column w-12">
                                <label class="skill-label w-3"><span data-i18n="common.notes">Notes</span> :</label>
                                <input type="text" class="visible-input w-12" name="attr_notes">
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div class="flex-row align-center">
                    <label class="label-secondary text-right w-3"><span data-i18n="attacks.bab">BBA</span> :</label>
                    <input type="number" class="visible-input w-9 " readonly name="attr_bba">
                </div>
                <div class="flex-column modifiers">
                    <label class="label-secondary text-center w-12">
                        <span data-i18n="attacks.globalModifiers">Modificateurs globaux</span>
                    </label>
                    <div class="flex-row w-12">
                        <label class="w-1 text-center"></label>
                        <label class="w-5 text-left"><span data-i18n="common.name">Nom</span></label>
                        <label class="w-3 text-center"><span data-i18n="attacks.attack.long">Attaque</span></label>
                        <label class="w-3 text-center"><span data-i18n="attacks.damage.long">Dégats</span></label>
                    </div>
                    <fieldset class="repeating_attaques-modifiers">
                        <div class="modifier">
                            <input class="options-flag" type="checkbox" name="attr_options-flag" checked><span>y</span>
                            <div class="flex-row align-center">
                                <div class="w-1">
                                    <input type="checkbox" name="attr_enabled" checked>
                                </div>
                                <label class="w-5 text-left">
                                    <span name="attr_name"></span>
                                </label>
                                <div class="gray-line flex-row bold align-center justify-center w-3">
                                    <span name="attr_attack-mod"></span>
                                </div>
                                <div class="gray-line flex-row bold align-center justify-center w-3">
                                    <span name="attr_damage-mod"></span>
                                </div>
                            </div>
                            <div class="flex-column options-options border-bottom">
                                <div class="flex-row align-center">
                                    <label class="attq-label w-3"><span data-i18n="common.name">Nom</span> :</label>
                                    <input type="text" class="visible-input text-left w-9" name="attr_name">
                                </div><div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.attack.long">Attaques</span> :</label>
                                <input type="number" class="visible-input text-center w-9" name="attr_attack-mod">
                            </div><div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.damage.long">Dégats</span> :</label>
                                <input type="text" class="visible-input text-center w-9" name="attr_damage-mod">
                            </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <h4 class="h4"><span data-i18n="attacks.title">Attaques</span></h4>
            </div>
            
            <!-- Inventaire -->
            <div class="flex-column inventory-list frame-c">
                <!-- Inventory -->
                <fieldset class="repeating_inventaire">
                    <div class="inventory">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_skillroll" type="roll" value="@{rollvalue}"
                                    class="button-label  text-left">
                                <span class="bold" span name="attr_btn-bold-text"> </span> <span
                                    name="attr_btn-text"></span>
                            </button>
                            <input type="hidden" name="attr_btn-text"/>
                            <input type="hidden" name="attr_btn-bold-text" val="New item"/>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{^{inventory.quantity}=@{qte}}} {{^{inventory.weight}=@{poids}kg}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row align-center">
                                <label class="label text-right w-3"><span data-i18n="inventory.name">Nom</span> : </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <div class="flex-row align-center">
                                <label class="label text-right w-3"><span data-i18n="inventory.quantity">Qté</span> : </label>
                                <input type="number" class="visible-input w-9 " name="attr_qte">
                            </div>
                            <div class="flex-row align-center">
                                <label class="label text-right w-3"><span data-i18n="inventory.weight">Poids</span> : </label>
                                <input type="number" class="visible-input w-9 " name="attr_poids">
                            </div>
                            <label class="label"><span data-i18n="inventory.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
                <h4 class="bottom-title"><span data-i18n="inventory.title">Inventaire</span></h4>
            </div>
        </div>
        <div class="flex-column gap-1 w-4">
            <!-- Capacités Raciales -->
            <div class="flex-column list frame-ct">
                <fieldset class="repeating_racial">
                    <div class="list-element">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_roll" type="roll" value="@{rollvalue}"
                                    class="button-label bold text-left">
                                <span name="attr_name"></span>&nbsp;
                            </button>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="common.name">Nom </span>: </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <label class="label"><span data-i18n="common.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
                <h4 class="bottom-title"><span data-i18n="abilities.racials">Dons</span></h4>
            </div>
            <!-- Capacités classes -->
            <div class="flex-column list frame-cm">
                <fieldset class="repeating_class">
                    <div class="list-element">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_roll" type="roll" value="@{rollvalue}"
                                    class="button-label bold text-left">
                                <span name="attr_name"></span>&nbsp;
                            </button>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="common.name">Nom </span>: </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <label class="label"><span data-i18n="common.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
                <h4 class="bottom-title"><span data-i18n="abilities.class">Dons</span></h4>
            </div>
            <!-- Dons -->
            <div class="flex-column list frame-cm">
                <fieldset class="repeating_feat">
                    <div class="list-element">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_roll" type="roll" value="@{rollvalue}"
                                    class="button-label bold text-left">
                                <span name="attr_name"></span>&nbsp;
                            </button>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="common.name">Nom </span>: </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <label class="label"><span data-i18n="common.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
                <h4 class="bottom-title"><span data-i18n="abilities.feats">Dons</span></h4>
            </div>
            <div class="flex-column list modifiers frame-cb">
                <div class="flex-row top align-center">
                    <label class="w-1"></label>
                    <label class="w-5"><span data-i18n="common.name">Nom</span></label>
                    <label class="w-4 text-center"><span data-i18n="modifiers.applyTo.short">Appli.</span></label>
                    <label class="w-2 text-center"><span data-i18n="common.value">Valeur</span></label>
                </div>
                <fieldset class="repeating_modifiers">
                    <div class="list-element modifier">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row gray-line align-center">
                            <div class="w-1 flex-row justify-center align-center">
                                <input type="checkbox" name="attr_enabled">
                            </div>
                            <label class="w-5"> <span name="attr_name"></span></label>
                            <label class="w-4 text-center"><span name="attr_apply-to-desc"></span></label>
                            <label class="w-2 text-center"><span name="attr_value"></span></label>
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row align-center">
                                <label class="label w-4 text-right"><span data-i18n="common.name">Nom</span> :</label>
                                <input name="attr_name" type="text" class="visible-input w-8" />
                            </div>
                            <div class="flex-row align-center">
                                <label class="label w-4 text-right"><span data-i18n="common.value">Valeur</span> :</label>
                                <input name="attr_value" type="number" class="visible-input w-8" />
                            </div>
                            <div class="flex-row align-center">
                                <label class="label w-4 text-right"><span data-i18n="modifiers.type">Type</span> : </label>
                                <select class="w-8" name="attr_type">
                                    <option value="alchemical" data-i18n="modifiers.type.alchemical">Alchemical Bonus</option>
                                    <option value="circumstance" data-i18n="modifiers.type.circumstance">Circumstance Modifier</option>
                                    <option value="competence" data-i18n="modifiers.type.competence">Competence Modifier</option>
                                    <option value="enhancement" data-i18n="modifiers.type.enhancement">Enhancement Bonus</option>
                                    <option value="insight" data-i18n="modifiers.type.insight">Insight Bonus</option>
                                    <option value="luck" data-i18n="modifiers.type.luck">Luck Modifier</option>
                                    <option value="morale" data-i18n="modifiers.type.morale">Morale Modifier</option>
                                    <option value="profane" data-i18n="modifiers.type.profane">Profane Modifier</option>
                                    <option value="racial" data-i18n="modifiers.type.racial">Racial Bonus</option>
                                    <option value="resistance" data-i18n="modifiers.type.resistance">Resistance Bonus</option>
                                    <option value="sacred" data-i18n="modifiers.type.sacred">Sacred Modifier</option>
                                    <option value="divine" data-i18n="modifiers.type.divine">Divine bonus</option>
                                    <option value="epic" data-i18n="modifiers.type.epic">Epic bonus</option>
                                    <option value="dodge" data-i18n="modifiers.type.dodge">Dodge Bonus</option>
                                    <option value="deflection" data-i18n="modifiers.type.deflection">Deflection Bonus</option>
                                    <option value="natural_armor" data-i18n="modifiers.type.natural_armor">Natural Armor Bonus</option>
                                    <option value="untyped" data-i18n="modifiers.type.untyped">Untyped Bonus</option>
                                </select>
                            </div>
                            <div class="flex-row align-center">
                                <label class="label w-4 text-right"><span data-i18n="modifiers.applyTo.long">Appliqué à</span> :</label>
                                <select class="w-8" name="attr_apply-to">
                                    <option value="carac_all" data-i18n="modifiers.applyTo.carac_all">Caractéristiques (Toutes)</option>
                                    <option value="carac_other" data-i18n="modifiers.applyTo.carac_other">Caractéristiques</option>
                                    <option value="init" data-i18n="modifiers.applyTo.init">Initiative</option>
                                    <option value="speed" data-i18n="modifiers.applyTo.speed">Vitesse</option>
                                    <option value="skill_all" data-i18n="modifiers.applyTo.skill_all">Compétences (Toutes)</option>
                                    <option value="skill_other" data-i18n="modifiers.applyTo.skill_other">Compétences</option>
                                    <option value="save_all" data-i18n="modifiers.applyTo.save_all">Sauvegardes (Toutes)</option>
                                    <option value="save_ref" data-i18n="modifiers.applyTo.save_ref">Réflexe</option>
                                    <option value="save_vig" data-i18n="modifiers.applyTo.save_vig">Vigueur</option>
                                    <option value="save_vol" data-i18n="modifiers.applyTo.save_vol">Volonté</option>
                                    <option value="armor_ca" data-i18n="modifiers.applyTo.armor_ca">CA (Universel)</option>
                                    <option value="armor_cac" data-i18n="modifiers.applyTo.armor_cac">CA (Contact)</option>
                                    <option value="armor_cad" data-i18n="modifiers.applyTo.armor_cad">CA (Dépourvu)</option>
                                </select>
                            </div>
                            <input type="hidden" class="apply_to_switch" name="attr_apply-to">
                            <div class="flex-row align-center apply_to_other">
                                <label class="label w-4 text-right"><span data-i18n="modifiers.applyTo.specify">Spécifiez</span> :</label>
                                <input type="text" class="visible-input w-8" placeholder="skill 1;skill2;..." name="attr_apply-to-other">
                            </div>
                        </div>
            
                    </div>
                </fieldset>
                <h4 class="bottom-title"><span data-i18n="modifiers.title">Modificateurs</span></h4>
            </div>
            
        </div>
    </div>
    

    <!-- NPC -->
    <div class="flex-row npc-core">
        <div class="flex-column w-6">
            <div class="flex-column frame-c npc-colu">
                <h4 class="h4"><span data-i18n="attribute.title">Caractéristiques</span></h4>
                <div class="flex-row justify-center">
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.for.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{for_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.for">FOR</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_for_base">
                    </div>
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.dex.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{dex_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.dex">DEX</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_dex_base">
                    </div>
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.con.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{con_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.con">CON</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_con_base">
                    </div>
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.int.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{int_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.int">INT</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_int_base">
                    </div>
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.sag.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{sag_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.sag">SAG</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_sag_base">
                    </div>
                    <div class="flex-column w-2">
                        <button type="roll" value="&{template:main} {{titre=^{attribute.cha.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{cha_mod}]]}}"
                                class="button-label text-center"><span data-i18n="attribute.cha">CHA</span>
                        </button>
                        <input type="number" class="w-12 visible-input" name="attr_cha_base">
                    </div>
                </div>
                <br>
                <h4 class="h4"><span data-i18n="health.hp">Points de vie</span></h4>
                <div class="flex-row justify-center align-center">
    
                    <input type="number" class="visible-input w-2" name="attr_pv" placeholder="actuel">
                    /
                    <input type="number" class="visible-input w-2" name="attr_pv_max" placeholder="max.">
                    (
                    <input type="number" class="visible-input w-2" name="attr_pv_temp" placeholder="temp.">
                    )
                    <input type="text" class="visible-input w-6" name="attr_pv_desc" placeholder="12d8+42">
                </div>
                <br/>
                <h4 class="h4"><span data-i18n="defenses.ac">Classe d'armure</span></h4>
                <div class="flex-row align-center">
                    <button type="roll"
                            value="&{template:main} {{titre=^{defenses.ac}}} {{subtitle=@{character_name} }} {{CA=@{npc_ca} }}{{description=@{npc_ca_text} }}"
                            class="button-label w-3 text-right"><span data-i18n="defenses.ac.normal">Normal</span> :
                    </button>
                    <input type="number" class="w-2 visible-input" name="attr_npc_ca">
                    <input type="text" class="w-7 visible-input" name="attr_npc_ca_text">
                </div>
                <div class="flex-row align-center">
                    <button type="roll"
                            value="&{template:main} {{titre=^{defenses.ac}(^{defenses.ac.flatfooted}) }} {{subtitle=@{character_name} }} {{CA=@{npc_caff} }}{{description=@{npc_caff_text} }}"
                            class="button-label w-3 text-right"><span data-i18n="defenses.ac.flatfooted">Au dépourvu</span> :
                    </button>
                    <input type="number" class="w-2 visible-input" name="attr_npc_caff">
                    <input type="text" class="w-7 visible-input" name="attr_npc_caff_text">
                </div>
                <div class="flex-row align-center">
                    <button type="roll"
                            value="&{template:main} {{titre=^{defenses.ac}(^{defenses.ac.touch})}} {{subtitle=@{character_name} }} {{CA=@{npc_cat} }}{{description=@{npc_cat_text} }}"
                            class="button-label w-3 text-right"><span data-i18n="defenses.ac.touch">De contact</span> :
                    </button>
                    <input type="number" class="w-2 visible-input" name="attr_npc_cat">
                    <input type="text" class="w-7 visible-input" name="attr_npc_cat_text">
                </div>
                <br>
                <h4 class="h4"><span data-i18n="saves.title">Jets de sauvegarde</span></h4>
                <div class="flex-row save">
                    <label class="label w-3 text-center"><span data-i18n="saves.base">Base</span></label>
                    <label class="label w-3 text-center"><span data-i18n="saves.mod">Mod.</span></label>
                    <label class="label w-6"></label>
                </div>
                <div class="flex-row save">
                    <input type="number" class="input w-3" name="attr_ref_base">
                    <input type="number" class="input w-3" name="attr_ref_mod">
                    <input type="hidden" name="attr_ref_roll_value"
                           value="&{template:main} {{titre=^{save.ref.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{dex_mod}+@{ref_base}+@{ref_mod}]]}}">
                    <button type="roll" name="attr_ref_roll" value="@{ref_roll_value}"
                            class="button-label bold w-6"><span data-i18n="saves.reflex">Réflexes</span>
                    </button>
                </div>
                <div class="flex-row save">
                    <input type="number" class="input w-3" name="attr_vig_base">
                    <input type="number" class="input w-3" name="attr_vig_mod">
                    <input type="hidden" name="attr_vig_roll_value"
                           value="&{template:main} {{titre=^{save.vig.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{con_mod}+@{vig_base}+@{vig_mod}]]}}">
                    <button type="roll" name="attr_vig_roll" value="@{vig_roll_value}"
                            class="button-label bold w-6"><span data-i18n="saves.fortitude">Vigueur</span>
                    </button>
                </div>
                <div class="flex-row save">
                    <input type="number" class="input w-3" name="attr_vol_base">
                    <input type="number" class="input w-3" name="attr_vol_mod">
                    <input type="hidden" name="attr_vol_roll_value"
                           value="&{template:main} {{titre=^{save.vol.roll}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{sag_mod}+@{vol_base}+@{vol_mod}]]}}">
                    <button type="roll" name="attr_vol_roll" value="@{vol_roll_value}"
                            class="button-label bold w-6"><span data-i18n="saves.willpower">Volonté</span>
                    </button>
                </div>
            </div>
            <div class="flex-column frame-c npc-colu">
                <h4 class="h4"><span data-i18n="abilities.npc">Capacités spécifiques</span></h4>
                <fieldset class="repeating_npc-capacite">
                    <div class="skill">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_roll" type="roll" value="@{rollvalue}"
                                    class="button-label bold text-left">
                                <span name="attr_name"></span>&nbsp;
                            </button>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="common.name">Nom</span> : </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <label class="label"><span data-i18n="common.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
                <br>
                <h4 class="h4"><span data-i18n="npc.misc">Divers & Notes</span></h4>
                <div class="flex-row align-center justify-start">
                    <label class="label text-right w-1"><span data-i18n="npc.cr">CR</span> : </label>
                    <div class="w-2">
                        <input type="text" class="visible-input text-left" name="attr_npc_cr">
                    </div>
                    <div>(</div>
                    <div class="w-3">
                        <input type="text" class="visible-input text-left" name="attr_npc_xp">
                    </div>
                    <div><span data-i18n="npc.xp">XP</span>)</div>
                </div>
                <label class="label"><span data-i18n="common.notes">Notes</span> :</label>
                <textarea class="textarea" name="attr_npc_notes"></textarea>
            </div>
        </div>
        <div class="flex-column w-6">
            <div class="flex-column frame-c list npc-colu">
                <h4 class="h4"><span data-i18n="abilities.npc.actions">Actions spécifiques</span></h4>
                <fieldset class="repeating_npc-actions">
                    <div class="list-element">
                        <input class="options-flag" type="checkbox" name="attr_options-flag"
                               checked><span>y</span>
                        <div class="flex-row align-center">
                            <button name="attr_roll" type="roll" value="@{rollvalue}"
                                    class="button-label bold text-left">
                                <span name="attr_name"></span>&nbsp;
                            </button>
                            <input type="hidden" name="attr_rollvalue"
                                   value="&{template:main} {{titre=@{name}}} {{subtitle=@{character_name}}} {{description=@{description}}}">
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row">
                                <label class="label text-right w-3"><span data-i18n="common.name">Nom</span> : </label>
                                <input type="text" class="visible-input w-9 " name="attr_name">
                            </div>
                            <label class="label"><span data-i18n="common.description">Description</span></label>
                            <textarea class="textarea" name="attr_description"></textarea>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="flex-column attaques frame-c">
                <div class="flex-row top">
                    <label class="label-secondary w-6"><span data-i18n="common.name">Nom</span></label>
                    <label class="label-secondary w-2 text-center"><span data-i18n="attacks.attack.long">Att</span></label>
                    <label class="label-secondary w-4 text-center"><span data-i18n="attacks.damage.long">Dégats</label>
                </div>
                <fieldset class="repeating_attaques">
                    <div class="attq">
                        <input class="options-flag" type="checkbox" name="attr_options-flag" checked><span>y</span>
                        <div class="flex-row align-center">
                            <input type="hidden" name="attr_atq-rollvalue"
                                   value="&{template:main} {{titre=Attaque avec @{name}}} {{subtitle=@{character_name}}} {{Attaque=[[1d20+@{bba}+@{atq-carac-val}+@{atq-bonus}+@{atq-bonus-2}]]}} {{Dégats=[[@{dgt-base}+@{dgt-carac-val}+@{dgt-bonus}]]}}">
                            <button type="roll" name="attr_atq-roll" value="@{atq-rollvalue}"
                                    class="gray-line flex-row bold w-12 button-label">
                                <span class="w-6" name="attr_name"></span>
                                <span class="w-2 text-center" name="attr_atq-total"></span>
                                <span class="w-4 text-center" name="attr_degats"></span>
                            </button>
                        </div>
                        <div class="flex-column options-options border-bottom">
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="common.name">Nom</span> :</label>
                                <input type="text" class="visible-input text-left w-9" name="attr_name">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.attack.long">Atq</span> :</label>
                                <select class="w-3" name="attr_atq-carac">
                                    <option value="-">-</option>
                                    <option value="FOR" data-i18n="attribute.strength.short">FOR</option>
                                    <option value="DEX" data-i18n="attribute.dexterity.short">DEX</option>
                                </select>
                                +
                                <input type="number" class="visible-input w-2" name="attr_atq-bonus">
                                +
                                <input type="number" class="visible-input w-2" name="attr_atq-bonus-2">
                                <input type="hidden" name="attr_atq-total">
                                <input type="hidden" name="attr_atq-carac-val">
                                <input type="hidden" name="attr_degats">
                                <input type="hidden" name="attr_dgt-carac-val">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.damage.long">Dgt</span> :</label>
                                <input type="text" class="visible-input w-2" name="attr_dgt-base"
                                       placeholder="1d4">
                                +
                                <select class="w-4" name="attr_dgt-carac">
                                    <option value="-">-</option>
                                    <option value="FOR" data-i18n="attribute.strength.short">FOR</option>
                                    <option value="DEX" data-i18n="attribute.dexterity.short">DEX</option>
                                    <option value="1,5FOR" data-i18n="attribute.strength.onehalf">1,5 x FOR</option>
                                    <option value="1/2FOR" data-i18n="attribute.strength.half">1/2 xFOR</option>
                                </select>
                                +
                                <input type="number" class="visible-input w-2" name="attr_dgt-bonus">
                            </div>
                            <div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.range">Portée </span> :</label>
                                <input type="text" class="visible-input text-left w-9" name="attr_range">
                            </div>
                            <div class="flex-column w-12">
                                <label class="skill-label w-3"><span data-i18n="common.notes">Notes</span> :</label>
                                <input type="text" class="visible-input w-12" name="attr_notes">
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div class="flex-row align-center">
                    <label class="label-secondary text-right w-3"><span data-i18n="attacks.bab">BBA</span> :</label>
                    <input type="number" class="visible-input w-9 " readonly name="attr_bba">
                </div>
                <div class="flex-column modifiers">
                    <label class="label-secondary text-center w-12">
                        <span data-i18n="attacks.globalModifiers">Modificateurs globaux</span>
                    </label>
                    <div class="flex-row w-12">
                        <label class="w-1 text-center"></label>
                        <label class="w-5 text-left"><span data-i18n="common.name">Nom</span></label>
                        <label class="w-3 text-center"><span data-i18n="attacks.attack.long">Attaque</span></label>
                        <label class="w-3 text-center"><span data-i18n="attacks.damage.long">Dégats</span></label>
                    </div>
                    <fieldset class="repeating_attaques-modifiers">
                        <div class="modifier">
                            <input class="options-flag" type="checkbox" name="attr_options-flag" checked><span>y</span>
                            <div class="flex-row align-center">
                                <div class="w-1">
                                    <input type="checkbox" name="attr_enabled" checked>
                                </div>
                                <label class="w-5 text-left">
                                    <span name="attr_name"></span>
                                </label>
                                <div class="gray-line flex-row bold align-center justify-center w-3">
                                    <span name="attr_attack-mod"></span>
                                </div>
                                <div class="gray-line flex-row bold align-center justify-center w-3">
                                    <span name="attr_damage-mod"></span>
                                </div>
                            </div>
                            <div class="flex-column options-options border-bottom">
                                <div class="flex-row align-center">
                                    <label class="attq-label w-3"><span data-i18n="common.name">Nom</span> :</label>
                                    <input type="text" class="visible-input text-left w-9" name="attr_name">
                                </div><div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.attack.long">Attaques</span> :</label>
                                <input type="number" class="visible-input text-center w-9" name="attr_attack-mod">
                            </div><div class="flex-row align-center">
                                <label class="attq-label w-3"><span data-i18n="attacks.damage.long">Dégats</span> :</label>
                                <input type="text" class="visible-input text-center w-9" name="attr_damage-mod">
                            </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <h4 class="h4"><span data-i18n="attacks.title">Attaques</span></h4>
            </div>
            
            <div class="flex-column frame-c npc-colu">
                <h4 class="h4"><span data-i18n="skills.title">Compétences</span></h4>
                <div class="npc-skills">
                    <fieldset class="repeating_skills">
                        <div class="skill">
                            <input class="options-flag" type="checkbox" name="attr_options-flag"
                                   checked><span>y</span>
                            <div class="flex-row align-center">
                                <div class="w-12">
                                    <input type="hidden" name="attr_skillrollvalue"
                                           value="&{template:main} {{titre=Test de '@{name}'}} {{subtitle=@{character_name} }} {{Jet=[[1d20+@{total}]]}}">
                                    <button name="attr_skillroll" type="roll" value="@{skillrollvalue}"
                                            class="button-label text-left">
                                        <span name="attr_name"></span>&nbsp;<span name="attr_caracname"></span>,&nbsp;&nbsp;
                                    </button>
                                </div>
                            </div>
                            <div class="flex-column options-options border-bottom">
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.name">Name</span> :</label>
                                    <input type="text" class="w-7 visible-input" name="attr_name">
                                </div>
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.ranks">Rangs</span> :</label>
                                    <input type="number" class="visible-input w-7" name="attr_ranks">
                                </div>
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.caracteristics">Carac.</span> :</label>
                                    <select class="w-7" name="attr_carac">
                                        <option value="@{for_mod}" data-i18n="attribute.strength.long">Force</option>
                                        <option value="@{dex_mod}" data-i18n="attribute.dexterity.long">Dextérité</option>
                                        <option value="@{con_mod}" data-i18n="attribute.constitution.long">Constitution</option>
                                        <option value="@{int_mod}" data-i18n="attribute.intelligence.long">Intelligence</option>
                                        <option value="@{sag_mod}" data-i18n="attribute.wisdom.long">Sagesse</option>
                                        <option value="@{cha_mod}" data-i18n="attribute.charisma.long">Charisme</option>
                                    </select>
                                    <input type="hidden" name="attr_caracname">
                                </div>
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.malus">Malus*</span> :</label>
                                    <select class="w-7" name="attr_has_armor_malus">
                                        <option value="off" data-i18n="common.no">Non</option>
                                        <option value="on" data-i18n="common.yes">Oui</option>
                                        <option value="double" data-i18n="skills.x2">x2</option>
                                    </select>
                                </div>
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.modifier">Mod</span> :</label>
                                    <input type="number" class="visible-input w-7" name="attr_mod">
                                </div>
                                <div class="flex-row align-center">
                                    <label class="skill-label w-5"><span data-i18n="skills.synergy">Synergie</span> :</label>
                                    <input type="number" class="visible-input w-7" name="attr_synergy">
                                </div>
                                <label class="skill-label w-5"><span data-i18n="common.notes">Notes</span> :</label>
                                <input type="text" class="w-12 visible-input" name="attr_notes">
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>

    <!-- PC bio-->
    <div class="journal flex-row">
        <div class="flex-column w-6">
            <div class="flex-column bio frame-ctl">
                <textarea class="textarea" name="attr_char_description"></textarea>
                <h4 class="h4"><span data-i18n="bio.physical">Description Physique</span></h4>
            </div>
            <div class="flex-column bio frame-cbl">
                <textarea class="textarea" name="attr_char_notes"></textarea>
                <h4 class="h4"><span data-i18n="common.notes">Notes</span></h4>
            </div>
        </div>
        <div class="flex-column w-6">
            <div class="flex-column bio frame-ctr">
                <textarea class="textarea" name="attr_char_bg"></textarea>
                <h4 class="h4"><span data-i18n="bio.background">Background</span></h4>
            </div>
            <div class="flex-column bio frame-cbr">
                <textarea class="textarea" name="attr_tresor"></textarea>
                <h4 class="h4"><span data-i18n="bio.treasury">Trésor</span></h4>
            </div>
        </div>
    
    </div>

    <!-- PC spells-->
    
    <div class="spells flex-column w-12">
      <div class="flex-row">
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">0</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_0_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_0_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells0">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=0}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">1</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_1_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_1_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells1">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=1}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">2</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_2_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_2_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells2">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=2}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
      <div class="flex-row">
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">3</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_3_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_3_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells3">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=3}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">4</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_4_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_4_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells4">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=4}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">5</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_5_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_5_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells5">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=5}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
      <div class="flex-row">
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">6</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_6_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_6_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells6">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=6}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">7</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_7_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_7_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells7">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=7}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">8</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_8_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_8_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells8">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=8}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
      <div class="flex-row">
        <div class="spell-group w-4">
          <div class="spell-header flex-row">
            <label class="w-2">9</label>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_9_total"/>
            </div>
            <div class="w-5">
              <input class="input" type="number" name="attr_spell_9_left"/>
            </div>
          </div>
          <div class="spells-list flex-column">
            <fieldset class="repeating_spells9">
              <div class="spell border-bottom">
                <input class="options-flag" type="checkbox" name="attr_options-flag"/><span>y</span>
                <div class="flex-row align-center">
                  <input type="checkbox" name="attr_prepared"/>
                  <button class="spell-button" name="attr_roll" type="roll" value="@{rollvalue}"><span class="spell-name" name="attr_name"></span><span>&nbsp;</span><span class="spell-innate" name="attr_innate"></span></button>
                  <input type="hidden" name="attr_rollvalue" value="&{template:spell} {{name=^{spells.spell}: @{name}}} {{school=@{school}}} {{casting-time=@{casting-time}}} {{range=@{range}}} {{duration=@{duration}}} {{innate=@{innate}}} {{subtitle=@{character_name}}} {{level=9}}  {{description=@{description}}}"/>
                </div>
                <div class="flex-column options-options">
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="common.name">Nom</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_name"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.school">Ecole</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_school"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.incantation">incantation</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_casting-time"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.range">Portée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_range"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.duration">Durée</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_duration"/>
                  </div>
                  <div class="flex-row">
                    <label class="text-right w-4"><span data-i18n="spells.innate">Inné</span> :</label>
                    <input class="visible-input w-8" type="text" name="attr_innate"/>
                  </div>
                  <label><span data-i18n="common.description">Inné</span></label>
                  <textarea class="textarea" name="attr_description"></textarea>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
    </div>

    <!-- PC config-->
    <div class="flex-column configuration">
        <div class="flex-row">
            <div class="flex-column w-4 list config frame">
                <h4 class="title"><span data-i18n="config.classes">Classes</span></h4>
                <label><span data-i18n="config.class">Class</span> 1</label>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="common.name">Nom</span> : </label>
                    <input class="visible-input w-8" type="text" name="attr_class1_name">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.level">Niveau</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class1_lvl">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.bab">BBA</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class1_bab">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.reflex">Réflexes</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class1_ref">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.fortitude">Vigueur</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class1_vig">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.willpower">Volonte</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class1_vol">
                </div>
                <label><span data-i18n="config.class">Class</span> 2</label>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="common.name">Nom</span> : </label>
                    <input class="visible-input w-8" type="text" name="attr_class2_name">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.level">Niveau</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class2_lvl">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.bab">BBA</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class2_bab">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.reflex">Réflexes</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class2_ref">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.fortitude">Vigueur</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class2_vig">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.willpower">Volonte</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class2_vol">
                </div>
                <label><span data-i18n="config.class">Class</span> 3</label>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="common.name">Nom</span> : </label>
                    <input class="visible-input w-8" type="text" name="attr_class3_name">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.level">Niveau</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class3_lvl">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="config.bab">BBA</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class3_bab">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.reflex">Réflexes</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class3_ref">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.fortitude">Vigueur</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class3_vig">
                </div>
                <div class="flex-row">
                    <label class="label text-right w-4"><span data-i18n="saves.willpower">Volonte</span> : </label>
                    <input class="visible-input w-8" type="number" name="attr_class3_vol">
                </div>
            </div>
            <div class="flex-column w-4 config frame">
                <h4 class="title"><span data-i18n="config.simple_modifiers">Simple Modifiers</span></h4>
                <label><span data-i18n="config.sm.abilities">Caracs</span></label>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.strength">Mod. Force</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_for_bonus">
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.dexterity">Mod. Dextérité</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_dex_bonus">
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.constitution">Mod. Constit.</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_con_bonus">
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.intelligence">Mod. Intel.</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_int_bonus">
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.wisdom">Mod. Sagesse</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_sag_bonus">
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.charisma">Mod. Charisme</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_cha_bonus">
                </div>
                <label><span data-i18n="config.sm.initiative">Init</span></label>
                <div class="flex-row align-center ">
                    <label class="label text-right w-5"><span data-i18n="config.sm.init.modifier">Mod. Init.</span> :</label>
                    <input type="number" class="visible-input w-9" name="attr_init_bonus">
                </div>
                <label><span data-i18n="config.sm.ac">AC</span></label>
                <div class="flex-row gap05">
                    <div class="flex-column w-4">
                        <input type="number" class="visible-input w-12" name="attr_touch_bonus">
                        <label class="label text-center"><span data-i18n="config.sm.ac.touch">Bonus<br/>au contact</span></label>
                    </div>
                    <div class="flex-column w-4">
                        <input type="number" class="visible-input w-12" name="attr_flatfooted_bonus">
                        <label class="label text-center"><span data-i18n="config.sm.ac.flatfooted">Bonus<br/>au dépourvu</span></label>
                    </div>
                    <div class="flex-column w-4">
                        <input type="number" class="visible-input w-12" name="attr_universal_armor_bonus">
                        <label class="label text-center"><span data-i18n="config.sm.ac.universal">Bonus<br/>Universel</span></label>
                    </div>
                </div>
    
                <label><span data-i18n="config.sm.saves">Saves</span></label>
                <div class="flex-row align-center">
                    <label class="label w-5 text-right"><span data-i18n="config.sm.saves.reflex">Mod. Réflexes</span> :</label>
                    <input type="number" class="visible-input w-7" name="attr_ref_mod">
                </div>
                <div class="flex-row align-center">
                    <label class="label w-5 text-right"><span data-i18n="config.sm.saves.fortitude">Mod. Vigueur</span> :</label>
                    <input type="number" class="visible-input w-7" name="attr_vig_mod">
                </div>
                <div class="flex-row align-center">
                    <label class="label w-5 text-right"><span data-i18n="config.sm.saves.willpower">Mod. Volonté</span> :</label>
                    <input type="number" class="visible-input w-7" name="attr_vol_mod">
                </div>
            </div>
            <div class="flex-column w-4 config frame">
                <div class="flex-row">
                    <label class="label"><span data-i18n="sheet-version"></span> :</label><div><span name="attr_sheet_version"></span></div>
                </div>
                <div class="flex-row align-center ">
                    <label class="label text-right w-7"><span data-i18n="config.character-type">Type de personnage</span> :</label>
                    <select class="w-5" name="attr_characterType">
                        <option value="pc" data-i18n="config.ct.player">Joueur</option>
                        <option value="npc" data-i18n="config.ct.nonplayer">Pnj</option>
                    </select>
                </div>
                <!-- Unused
                <div class="flex-row">
                    <button type="action" name="act_inv_refresh" class="w-12">Rafraichir l'inventaire</button>
                </div>-->
            </div>
        </div>
    </div>

    <!-- ROLL TEMPLATES -->
    <div class="roll-templates">
        <rolltemplate class="sheet-rolltemplate-main">
            <div class="sheet-colu sheet-cadre sheet-template">
                <h4 class="sheet-h4">{{titre}}</h4>
                {{#subtitle}}
                <label class="sheet-w12 sheet-label sheet-text-center">{{subtitle}}</label>
                {{/subtitle}}
                {{#Jet}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-colu sheet-align-center">
                    <div class="sheet-roll sheet-w12 sheet-bold sheet-result sheet-text-center">{{Jet}}</div>
                    <label class="sheet-label sheet-bold sheet-w12 sheet-text-center"><span data-i18n="rolltemplate.result">Résultat</span></label>
                </div>
                {{/Jet}}
                {{#Attaque}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-colu sheet-align-center">
                    <div class="sheet-roll sheet-w12 sheet-bold sheet-result sheet-text-center">{{Attaque}}</div>
                    <label class="sheet-label sheet-bold sheet-w12 sheet-text-center"><span data-i18n="rolltemplate.attack">Toucher</span></label>
                </div>
                {{/Attaque}}
                {{#Dégats}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-colu sheet-align-center">
                    <div class="sheet-roll sheet-w12 sheet-bold sheet-result sheet-text-center">{{Dégats}}</div>
                    <label class="sheet-label sheet-bold sheet-w12 sheet-text-center"><span data-i18n="rolltemplate.damage">Dégats</span></label>
                </div>
                {{/Dégats}}
                {{#allprops() titre subtitle description Attaque Dégats Jet}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-line sheet-align-center">
                    <label class="sheet-label sheet-bold sheet-w4 sheet-text-right">{{key}} :</label>
                    <div class="sheet-w8 sheet-colu sheet-justify-center sheet-align-center">{{value}}</div>
                </div>
                {{/allprops() titre subtitle description Attaque Dégats Jet}}
                {{#description}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-line">
                    <div>
                        {{description}}
                    </div>
                </div>
                {{/description}}
            </div>
        </rolltemplate>
    
        <rolltemplate class="sheet-rolltemplate-attack">
            <div class="sheet-colu sheet-cadre sheet-template">
                <h4 class="sheet-h4">{{titre}}</h4>
                {{#subtitle}}
                <label class="sheet-w12 sheet-label sheet-text-center">{{subtitle}}</label>
                {{/subtitle}}
                {{#attack}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-colu sheet-align-center">
                    <div class="sheet-roll sheet-w12 sheet-bold sheet-result sheet-text-center">{{attack}}</div>
                    <label class="sheet-label sheet-bold sheet-w12 sheet-text-center"><span data-i18n="rolltemplate.attack">Toucher</span></label>
                </div>
                {{/attack}}
                {{#damage}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-colu sheet-align-center">
                    <div class="sheet-roll sheet-w12 sheet-bold sheet-result sheet-text-center">{{damage}}</div>
                    <label class="sheet-label sheet-bold sheet-w12 sheet-text-center"><span data-i18n="rolltemplate.damage">Dégats</span></label>
                </div>
                {{/damage}}
                {{#notes}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-line">
                    <div>
                        {{notes}}
                    </div>
                </div>
                {{/notes}}
            </div>
        </rolltemplate>
    
        <rolltemplate class="sheet-rolltemplate-spell">
            <div class="sheet-colu sheet-cadre sheet-template">
                <h4 class="sheet-h4">{{name}} ({{level}})</h4>
                <label class="sheet-w12 sheet-label sheet-text-center">{{subtitle}}</label>
                {{#school}}
                <label class="sheet-w-12"><span class="sheet-bold"><span class="sheet-bold" data-i18n="spells.school">École</span> : </span>{{school}}</label>
                {{/school}}
                {{#casting-time}}
                <label class="sheet-w-12"><span class="sheet-bold"><span class="sheet-bold" data-i18n="spells.incantation">Temps d'incantation</span> : </span>{{casting-time}}</label>
                {{/casting-time}}
                {{#range}}
                <label class="sheet-w-12"><span class="sheet-bold"><span class="sheet-bold" data-i18n="spells.range">Portée</span> : </span>{{range}}</label>
                {{/range}}
                {{#duration}}
                <label class="sheet-w-12"><span class="sheet-bold"><span class="sheet-bold" data-i18n="spells.duration">Durée</span> : </span>{{duration}}</label>
                {{/duration}}
                {{#innate}}
                <label class="sheet-w-12"><span class="sheet-bold"><span class="sheet-bold" data-i18n="spells.innate">Inné</span> : </span>{{innate}}</label>
                {{/innate}}
                {{#allprops() name subtitle description school casting-time range duration innate level}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-line sheet-align-center">
                    <label class="sheet-label sheet-bold sheet-w4 sheet-text-right">{{key}} :</label>
                    <div class="sheet-w8 sheet-colu sheet-justify-center sheet-align-center">{{value}}</div>
                </div>
                {{/allprops() name subtitle description school casting-time range duration innate level}}
                {{#description}}
                <div class="sheet-line sheet-border-bottom"></div>
                <div class="sheet-line">
                    <div>
                        {{description}}
                    </div>
                </div>
                {{/description}}
            </div>
        </rolltemplate>
    </div>
</div>

<!-- WORKERS -->
<script type="text/worker">
    const buttonlist = ["character", "journal","spells", "configuration"];
    
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
    
    const modifiersTypes = ["alchemical", "circumstance", "competence", "enhancement", "insight", "luck", "morale",
        "profane", "racial", "resistance", "sacred", "divine", "epic", "untyped","dodge","deflection","natural_armor"];
    const modifiersApplicationSubTypes = ["carac_all", "carac_other", "init", "speed", "skill_all", "skill_other",
        "save_all", "save_ref", "save_vig", "save_vol", "armor_ca", "armor_cac", "armor_cad"];
    
    const characteristics = {
        for:"for",
        dex:"dex",
        con:"con",
        int:"int",
        sag:"sag",
        cha:"cha",
    }
    
    const allCharacteristics = [
        characteristics.for,
        characteristics.dex,
        characteristics.con,
        characteristics.int,
        characteristics.sag,
        characteristics.cha
    ]
    
    const applicationTypes = {
        carac: "carac",
        init: "init",
        speed: "speed",
        skill: "skill",
        save: "save",
        armor: "armor"
    }
    
    const allApplicationTypes = [
        applicationTypes.carac,
        applicationTypes.init,
        applicationTypes.speed,
        applicationTypes.skill,
        applicationTypes.save,
        applicationTypes.armor
    ];
    
    /* CARACTERISTICS UPDATE */
    on("change:for_base change:for_bonus " +
        "change:dex_base change:dex_bonus " +
        "change:con_base change:con_bonus " +
        "change:int_base change:int_bonus " +
        "change:sag_base change:sag_bonus " +
        "change:cha_base change:cha_bonus", (eventInfo) => {
        getModifiersByTypeAndUpdateValues(applicationTypes.carac, updateAllCharacteristics, eventInfo.triggerName.split("_")[0]);
    });
    
    
    let updateAllCharacteristics = (modifierList, characteristic_name) => {
        if (characteristic_name) {
            return updateCharacteristicsList([characteristic_name], modifierList);
        }
        return updateCharacteristicsList(allCharacteristics, modifierList);
    }
    let updateCharacteristicsList = (characteristicList, modifierList) => {
        let toGet = [];
        for (let characteristic of characteristicList) {
            toGet.push(characteristic + "_base");
            toGet.push(characteristic + "_bonus")
        }
        getAttrs(toGet, (values) => {
            let toUpdate = {}
            for (let characteristic of characteristicList) {
                let base = parseInt(values[characteristic + "_base"]) || 0;
                let bonus = parseInt(values[characteristic + "_bonus"]) || 0;
                let total = base + bonus;
                let filteredModifierList = getLargestModifierOfEachTypeFor(modifierList, characteristic);
                for (let modifier of filteredModifierList) {
                    total += modifier.value;
                }
    
                let modded = total !== base;
                let effective_total = total;
                if (effective_total % 2 == 1) {
                    effective_total--;
                }
                let mod = (effective_total - 10) / 2;
                toUpdate[characteristic + "_modified"] = modded ? "true" : "false";
                toUpdate[characteristic + "_mod"] = mod;
                toUpdate[characteristic + "_total"] = "" + total;
            }
            setAttrs(toUpdate);
        });
    }
    
    on("change:for_mod change:dex_mod change:con_mod change:int_mod change:sag_mod change:cha_mod change:skills_malus", function () {
        getModifiersByTypeAndUpdateValues(applicationTypes.skill,updateAllSkills);
        getModifiersByTypeAndUpdateValues(applicationTypes.save,updateAllSaves);
        getAttacksModifiersAndUpdateValues();
    });
    
    /*Update init*/
    on("change:dex_mod change:init_bonus",function(){
        getModifiersByTypeAndUpdateValues(applicationTypes.init, updateInitiative, null);
    });
    
    let updateInitiative = (modifierList) => {
        getAttrs(["dex_total","dex_mod","init_bonus"],function(values){
            let dex_mod = parseInt(values.dex_mod)||0;
            let init_bonus = parseInt(values.init_bonus)||0;
            let dex_total = parseInt(values.dex_total)||0;
            let filteredModifiersList = getLargestModifierOfEachTypeFor(modifierList,null);
            let roll = `1d20+${dex_mod}[dex]+${init_bonus}[legacy bonus]`;
            for(let modifier of filteredModifiersList){
                let str_mod = (modifier.value < 0) ? ""+modifier.value : "+"+modifier.value;
                roll+=`${str_mod}[${modifier.name}(${modifier.type})]`;
                init_bonus += modifier.value;
            }
            const init_tot = dex_mod+init_bonus+(dex_total/100);
            const init_roll = `&{template:main} {{titre=Initiative}} {{subtitle=@{character_name}}} {{Jet=[[${roll} &{tracker}]]}}`;
            setAttrs({
                "init_modified": ""+(init_bonus !== 0),
                "init_rol_value":init_roll,
                "init_tot":init_tot
            });
        });
    }
    
    on("change:vit_base", () =>{
        getModifiersByTypeAndUpdateValues(applicationTypes.speed, updateSpeed, null);
    });
    
    let updateSpeed = (modifierList) =>{
        getAttrs(["vit_base"], (attrs) => {
            let vit_base = parseFloat(attrs.vit_base)||0;
            let vit_total = vit_base;
            let filteredModifierList = getLargestModifierOfEachTypeFor(modifierList,null);
            for(let modifier of filteredModifierList){
                vit_total += modifier.value;
            }
            let toUpdate = {};
            toUpdate.vit_total = vit_total;
            toUpdate.vit_modified = ""+(vit_total !== vit_base);
            setAttrs(toUpdate,{silent:true});
        });
    }
    
    /*Update armor*/
    on("change:armor_bonus change:armor_malus change:armor_max_dex change:armor_equipe change:shield_bonus change:shield_malus change:shield_equipe change:touch_bonus change:flatfooted_bonus change:universal_armor_bonus change:dex_mod",function(){
        getModifiersByTypeAndUpdateValues(applicationTypes.armor, updateArmor, null);
    });
    
    let updateArmor = (modifierList) => {
        getAttrs(["armor_bonus","armor_malus","armor_max_dex","size","armor_equipe","shield_bonus","shield_malus","shield_equipe","touch_bonus","flatfooted_bonus","universal_armor_bonus","dex_mod"],function(values){
            let armor_equipe = values.armor_equipe === "on";
            let armor_bonus = armor_equipe ? parseInt(values.armor_bonus) || 0 : 0;
            let armor_malus = armor_equipe ? parseInt(values.armor_malus) || 0 : 0;
            let armor_max_dex = armor_equipe ? parseInt(values.armor_max_dex) || 0 : 0;
            let size = parseInt(values.size) || 0;
            if(armor_max_dex < 0) armor_max_dex = 1000;
            let shield_equipe = values.shield_equipe === "on";
            let shield_bonus = shield_equipe ? (parseInt(values.shield_bonus) || 0) : 0;
            let shield_malus = shield_equipe ? (parseInt(values.shield_malus) || 0) : 0;
            let touch_bonus = parseInt(values.touch_bonus) || 0;
            let flatfooted_bonus = parseInt(values.flatfooted_bonus) || 0;
            let universal_armor_bonus = parseInt(values.universal_armor_bonus) || 0;
            let dex_mod = parseInt(values.dex_mod) || 0;
            let dex = dex_mod
            if(armor_equipe && armor_max_dex < dex_mod){
                dex = armor_max_dex;
            }
            let universalArmorModifier = 0;
            let touchArmorModifier = 0;
            let flatArmorModifier = 0;
            if(modifierList?.length) {
                let universalArmorModifierList = ([...modifierList]).filter(modifier => modifier.applyTo === "armor_ca");
                universalArmorModifierList = getLargestModifierOfEachTypeFor(universalArmorModifierList, null);
                for (let modifier of universalArmorModifierList) {
                    universalArmorModifier += modifier.value;
                }
                let touchArmorModifierList = ([...modifierList]).filter(modifier => modifier.applyTo === "armor_cac");
                touchArmorModifierList = getLargestModifierOfEachTypeFor(touchArmorModifierList, null);
                for (let modifier of touchArmorModifierList) {
                    touchArmorModifier += modifier.value;
                }
                let flatArmorModifierList = ([...modifierList]).filter(modifier => modifier.applyTo === "armor_cad");
                flatArmorModifierList = getLargestModifierOfEachTypeFor(flatArmorModifierList, null);
                for (let modifier of flatArmorModifierList) {
                    flatArmorModifier += modifier.value;
                }
            }
            let AC = 10 + armor_bonus + dex + shield_bonus + touch_bonus + flatfooted_bonus + universal_armor_bonus
                + universalArmorModifier + touchArmorModifier + flatArmorModifier;
            let TAC = 10 +dex + touch_bonus + universal_armor_bonus + universalArmorModifier + touchArmorModifier;
            let FFAC = 10 + armor_bonus + shield_bonus + flatfooted_bonus + universal_armor_bonus + universalArmorModifier + flatArmorModifier;
            let skill_malus = (shield_malus > 0 ? -shield_malus : shield_malus) - (armor_malus < 0 ? -armor_malus : armor_malus);
            setAttrs({
                "ac_tot":AC,
                "ac_tot_t":TAC,
                "ac_tot_ff":FFAC,
                "skills_malus":skill_malus
            });
        });
    }
    
    /*Update resume */
    on('clicked:inv_refresh',function() {
        getSectionIDs("inventaire", function (idarray) {
            for (var i = 0; i < idarray.length; i++) {
                updateSkill("repeating_inventaire_"+idarray[i]);
            }
        });
    });
    
    on("change:repeating_inventaire",function(eventInfo){
        let invId= eventInfo.triggerName;
        if(eventInfo.sourceAttribute.includes("options-flag")){
            return;
        }
        updateInv(invId);
    });
    
    function updateInv(invId){
        /* A recup */
        const nom = invId+"_name";
        const qte = invId+"_qte";
        const poids = invId+"_poids";
        const description = invId+"_description";
        /* A Set 34 Caracteres */
        const resume = invId+"_btn-text";
        const nom_bold = invId+"_btn-bold-text";
        getAttrs([nom,qte,poids,description],function (values){
            const vNom = values[nom];
            const vQte = values[qte];
            const vPoids = values[poids];
            const vDesc = values[description];
            let boldText = "Objet non défini";
            let normalText = "";
            let charLeft = 35;
            if(!!vNom){
                boldText = vNom;
                charLeft -= vNom.length;
            }
    
            let vQteInt = parseInt(vQte)||0;
            let vPoidsFloat = parseFloat(vPoids)||0.0;
            let vPoidsTotal = (vQteInt * vPoidsFloat).toFixed(2);
    
            let text = "";
            if(!!vQte && !!vPoids){
                text = " ("+vPoidsTotal+"Kg)";
            }
            else if(!!vQte){
                text = " ("+vQteInt+"x)";
            }
            else if(!!vPoids){
                text = " ("+vPoidsFloat.toFixed(2)+"Kg)";
            }
            boldText += text;
            charLeft -= text.length;
            if(!!vDesc){
                if(vDesc.length < charLeft){
                    normalText = vDesc;
                }
                else{
                    normalText = vDesc.substring(0,charLeft-3)+"...";
                }
            }
            let update = {};
            update[nom_bold]= boldText;
            update[resume] = normalText;
            setAttrs(update,{silent:true});
        });
    }
    /*Update attaques*/
    on("change:bba", (eventInfo) => {
        getSectionIDs("repeating_attaques-modifiers", (idArray) => {
            getNextModifierFromList(idArray, [], null);
        });
    });
    
    on("change:repeating_attaques", (eventInfo) => {
        let attackId = eventInfo.triggerName;
        if (eventInfo.sourceAttribute.includes("options-flag")
            || eventInfo.sourceAttribute.includes("rollvalue")) {
            return;
        }
        getSectionIDs("repeating_attaques-modifiers", (idArray) => {
            getNextModifierFromList(idArray, [], attackId);
        });
    });
    on("change:repeating_attaques-modifiers",  (eventInfo) => {
        let attackId = eventInfo.triggerName;
        if (eventInfo.sourceAttribute.includes("options-flag")) {
            return;
        }
        getAttacksModifiersAndUpdateValues();
    });
    
    let getAttacksModifiersAndUpdateValues = () =>{
        getSectionIDs("repeating_attaques-modifiers", (idArray) => {
            getNextModifierFromList(idArray, [], null);
        });
    }
    let getNextModifierFromList = (modifierList, modifiers, attackId) => {
        let modifierListToChange = [... modifierList];
        if (!modifierListToChange.length) {
            return updateAttacks(attackId, modifiers);
        }
        let id = "repeating_attaques-modifiers_" + modifierListToChange.pop();
        let nom = id + "_name";
        let enabled = id + "_enabled";
        let attack_mod = id + "_attack-mod";
        let damage_mod = id + "_damage-mod";
        /*Récupérer les Attributs*/
        getAttrs([nom, enabled, attack_mod, damage_mod], (attrs) => {
            let modifier = {
                nom: attrs[nom],
                enabled: attrs[enabled],
                attack_mod: attrs[attack_mod],
                damage_mod: attrs[damage_mod],
            }
            modifiers.push(modifier)
            getNextModifierFromList(modifierListToChange, modifiers, attackId);
        });
    }
    
    let updateAttacks = (attackId, modifiers) => {
        if (!attackId) {
            getSectionIDs("repeating_attaques", (idArray) => {
                for (let id of idArray) {
                    updateAttack("repeating_attaques_" + id, modifiers);
                }
            });
            return;
        }
        updateAttack(attackId, modifiers);
    };
    
    
    let updateAttack = (attackId, modifiers) => {
        /*A Récup */
        const bbaAttr = "bba";
        const atqCaracAttr = attackId + "_atq-carac";
        const atqModAttr = attackId + "_atq-bonus";
        const atqMod2Attr = attackId + "_atq-bonus-2";
        const dgtBaseAttr = attackId + "_dgt-base";
        const dgtCaracAttr = attackId + "_dgt-carac";
        const dgtBonusAttr = attackId + "_dgt-bonus";
        /* A Set */
        const atqRollValue = attackId + "_atq-rollvalue";
        const atqCaracValAttr = attackId + "_atq-carac-val";
        const dgtCaracValAttr = attackId + "_dgt-carac-val";
        const dgtTotalAttk = attackId + "_degats";
        const atqTotalAttk = attackId + "_atq-total";
        getAttrs([bbaAttr, atqCaracAttr, atqModAttr, atqMod2Attr, dgtBaseAttr, dgtCaracAttr, dgtBonusAttr, "for_mod", "dex_mod"], function (values) {
            const bba = parseInt(values[bbaAttr]) || 0;
            const atqCarac = values[atqCaracAttr];
            const atqMod = parseInt(values[atqModAttr]) || 0;
            const atqMod2 = parseInt(values[atqMod2Attr]) || 0;
            const dgtBase = values[dgtBaseAttr];
            const dgtCarac = values[dgtCaracAttr];
            const dgtBonus = parseInt(values[dgtBonusAttr]) || 0;
            const formod = parseInt(values.for_mod) || 0;
            const dexmod = parseInt(values.dex_mod) || 0;
            let caracAtk = 0;
            if ("FOR" === atqCarac) {
                caracAtk = formod;
            } else if ("DEX" === atqCarac) {
                caracAtk = dexmod
            }
            let caracDgt = 0;
            if ("FOR" === dgtCarac) {
                caracDgt = formod;
            } else if ("DEX" === dgtCarac) {
                caracDgt = dexmod;
            } else if ("1,5FOR" === dgtCarac) {
                caracDgt = Math.floor(1.5 * formod);
            } else if ("1/2FOR" === dgtCarac) {
                caracDgt = Math.floor(formod / 2);
            }
            let degatsBonus = caracDgt + dgtBonus;
            let atqBonus = bba + caracAtk + atqMod + atqMod2;
            if (atqBonus > 0) {
                atqBonus = "+" + atqBonus;
            } else if (atqBonus < 0) {
                atqBonus = "-" + atqBonus;
            }
            let degats = dgtBase + " + " + degatsBonus;
            let rollValue = getRollFromModifiers(modifiers);
            let update = {};
            update[dgtTotalAttk] = degats;
            update[atqTotalAttk] = atqBonus;
            update[atqCaracValAttr] = caracAtk;
            update[dgtCaracValAttr] = caracDgt;
            update[atqRollValue] = rollValue;
            setAttrs(update, {silent: true});
        });
    }
    
    let getRollFromModifiers = (modifiers) => {
        let baseRoll = `&{template:attack} {{titre=^{rolltemplate.attack.with} @{name}}} {{subtitle=@{character_name}}}`;
        let attackRoll = "1d20+@{bba}[BAB]+@{atq-carac-val}[Caracteristic]+@{atq-bonus}[Enhancement Bonus]+@{atq-bonus-2}[Misc Bonus]";
        let damageRoll = "@{dgt-base}[Base Damage]+@{dgt-carac-val}[Caracteristic]+@{dgt-bonus}[Enhancement Bonus]";
        for(let modifier of modifiers){
            if(modifier.enabled !== "on" || (!modifier.attack_mod && !modifier.damage_mod)){
                continue;
            }
            if(modifier.attack_mod) {
                let sign = (modifier.attack_mod.startsWith("-") || modifier.attack_mod.startsWith("+")) ? "" : "+";
                attackRoll += sign + modifier.attack_mod+"["+modifier.nom+"]"
            }
            if(modifier.damage_mod) {
                let sign = (modifier.damage_mod.startsWith("-") || modifier.damage_mod.startsWith("+")) ? "" : "+";
                damageRoll += sign + modifier.damage_mod+"["+modifier.nom+"]"
            }
        }
        return `${baseRoll} {{attack=[[${attackRoll}]]}} {{damage=[[${damageRoll}]]}} {{notes=@{notes}}}`
    }
    /*Update Skills*/
    on("change:repeating_skills", function(eventInfo) {
        let skillId= eventInfo.triggerName;
        if(eventInfo.sourceAttribute.includes("options-flag")){
            return;
        }
        getModifiersByTypeAndUpdateValues(applicationTypes.skill,updateAllSkills,skillId);
    });
    
    let updateAllSkills = (modifierList, skillId) => {
        if (skillId) {
            return updateSkillList([skillId], modifierList);
        }
        getSectionIDs("repeating_skills", function (idarray) {
            return updateSkillList(idarray.map(id => "repeating_skills_"+id), modifierList);
        });
    }
    function updateSkillList(skillList,modifierList){
        let toGet = [];
        for(let skillId of skillList) {
            toGet.push(skillId + "_name");
            toGet.push(skillId + "_ranks");
            toGet.push(skillId + "_mod");
            toGet.push(skillId + "_mod");
            toGet.push(skillId + "_carac");
            toGet.push(skillId + "_total");
            toGet.push(skillId + "_has_armor_malus");
            toGet.push(skillId + "_caracname");
        }
        toGet.push("skills_malus");
        toGet.push("for_mod");
        toGet.push("dex_mod");
        toGet.push("con_mod");
        toGet.push("int_mod");
        toGet.push("sag_mod");
        toGet.push("cha_mod");
    
        getAttrs(toGet,function (values){
            let skills_malus = parseInt(values.skills_malus) || 0;
            let caracs = {};
            caracs["for_mod"] = parseInt(values.for_mod) || 0;
            caracs["dex_mod"] = parseInt(values.dex_mod) || 0;
            caracs["con_mod"] = parseInt(values.con_mod) || 0;
            caracs["int_mod"] = parseInt(values.int_mod) || 0;
            caracs["sag_mod"] = parseInt(values.sag_mod) || 0;
            caracs["cha_mod"] = parseInt(values.cha_mod) || 0;
    
            let toUpdate = {};
            for(let skillId of skillList) {
                let name = values[`${skillId}_name`];
                //Si pas de nom on continue
                if(!name){
                    continue;
                }
                let malus = values[`${skillId}_has_armor_malus`];
                let skill_malus = 0;
                if(malus === "on"){
                    skill_malus = skills_malus;
                }
                if(malus === "double"){
                    skill_malus = skills_malus * 2;
                }
                let rank = parseInt(values[`${skillId}_ranks`]) || 0;
                let carac = values[`${skillId}_carac`];
                let mod = parseInt(values[`${skillId}_mod`]) || 0;
                let synergy = parseInt(values[`${skillId}_synergy`]) || 0;
                carac = carac.replace("@{", "").replace("}", "");
                let caracname = carac.split("_")[0];
                caracname = caracname.charAt(0).toUpperCase() + caracname.slice(1);
                caracname = "(" + caracname + ")";
                let caracVal = caracs[carac] || 0;
                let mods = 0;
                let total = rank + caracVal + skill_malus + synergy + mod;
                let roll = `${rank}[rank] + ${caracVal}[${carac}] + ${mod}[General Modifier] + ${synergy}[Synergy]`;
                if(skill_malus){
                    roll += ` ${skill_malus}[Armor Malus]`
                }
                let filteredModifiers = getLargestModifierOfEachTypeFor(modifierList,name);
                for(let modifier of filteredModifiers){
                    mods+= modifier.value;
                    roll += `+${modifier.value}[${modifier.name}(${modifier.type})]`;
                }
                toUpdate[`${skillId}_modified`] = (!!mods);
                toUpdate[`${skillId}_total`] = total+mods;
                toUpdate[`${skillId}_skillrollvalue`] = `&{template:main} {{titre=^{rolltemplate.rollof} '@{name}'}} {{subtitle=@{character_name} }} {{Jet=[[1d20+${roll}]]}}`;
                toUpdate[`${skillId}_caracname`] = caracname;
            }
            setAttrs(toUpdate, {silent: true});
        });
    }
    
    for(let i = 0 ; i < 10; i++) {
        on("change:repeating_spells"+i,  (eventInfo) => {
            let id = eventInfo.triggerName;
            if (eventInfo.sourceAttribute.includes("options-flag")) {
                return;
            }
            update_spell(id,i);
        });
    }
    
    
    let baseSpell = "&{template:spell} {{name=^{spells.spell}: @{name}}}";
    let update_spell = (id,level) =>{
        let school = id+"_school";
        let casting = id+"_casting-time";
        let range = id+"_range";
        let duration = id+"_duration";
        let innate = id+"_innate";
        let description = id+"_description";
        getAttrs([school,casting,range,duration,innate,description], (attrs) =>{
            let rollValue = baseSpell+" {{level="+level+"}}";
            for(let key in attrs){
                if(attrs[key]){
                    let attr_name = key.split("_")[3];
                    rollValue += ` {{${attr_name}=@{${attr_name}}}}`;
                }
            }
            let update= {};
            update[`${id}_rollvalue`] = rollValue;
            setAttrs(update,false);
        })
    }
    on("change:class1_name change:class2_name change:class3_name "
        +"change:class1_lvl change:class2_lvl change:class3_lvl", () => {
        updateClassLevel();
        updateBAB();
        updateClassSaves();
    });
    
    on("change:class1_bab change:class2_bab change:class3_bab", () => {
       updateBAB();
    });
    
    
    on("change:class1_ref change:class2_ref change:class3_ref change:class1_vig change:class2_vig change:class3_vig"
        +" change:class1_vol change:class2_vol change:class3_vol", () => {
        updateClassSaves();
    });
    
    let updateClassLevel = () => {
        getAttrs(["class1_name","class2_name","class3_name","class1_lvl","class2_lvl","class3_lvl"], (attrs) => {
            let class1_name = attrs.class1_name;
            let class2_name = attrs.class2_name;
            let class3_name = attrs.class3_name;
            let class1_lvl = parseInt(attrs.class1_lvl) || 0;
            let class2_lvl = parseInt(attrs.class2_lvl) || 0;
            let class3_lvl = parseInt(attrs.class3_lvl) || 0;
            let class_level = "";
            if(class1_lvl){
                class_level = class1_name + " " + class1_lvl;
            }
            if(class2_lvl){
                class_level += (class_level.length? ", ":"") + class2_name+ " " +class2_lvl;
            }
            if(class3_lvl){
                class_level += (class_level.length? ", ":"") + class3_name+ " " +class3_lvl;
            }
            setAttrs({class_level:class_level});
        })
    }
    
    let updateBAB = () => {
        getAttrs(["class1_bab","class2_bab","class3_bab","class1_lvl","class2_lvl","class3_lvl"], (attrs) =>{
            let class1_bab = parseInt(attrs.class1_bab) || 0;
            let class2_bab = parseInt(attrs.class2_bab) || 0;
            let class3_bab = parseInt(attrs.class3_bab) || 0;
            let class1_lvl = parseInt(attrs.class1_lvl) || 0;
            let class2_lvl = parseInt(attrs.class2_lvl) || 0;
            let class3_lvl = parseInt(attrs.class3_lvl) || 0;
            let bab = 0;
            if(class1_lvl) bab+=class1_bab;
            if(class2_lvl) bab+=class2_bab;
            if(class3_lvl) bab+=class3_bab;
            setAttrs({bba:bab});
        });
    }
    const modmap = {
        "str":"for",
        "wis":"sag",
    }
    
    on("change:repeating_modifiers", (eventInfo) => {
        let modifierId = eventInfo.triggerName;
        if (eventInfo.sourceAttribute.includes("options-flag")) {
            return;
        }
        updateModifierAndApplyChanges(modifierId);
    });
    
    //Update Modifier Description, then call getModifiersByTypeAndUpdateValue
    let updateModifierAndApplyChanges = (modifier_id) => {
        const attr_applyTo = modifier_id + "_apply-to";
        const attr_applyToOther = modifier_id + "_apply-to-other";
        getAttrs([attr_applyTo, attr_applyToOther], (attrs) => {
            let applyTo = attrs[attr_applyTo]
            let applyToOther = attrs[attr_applyToOther]
            let applicationType = applyTo?.split("_")[0];
            let applyToDesc = applicationType;
            if(applyTo.endsWith("_other")){
                applyToDesc += " x"+applyToOther.split(/[,;]/).length;
            }
            if(applyTo.endsWith("_all")){
                applyToDesc += " (Toutes)";
            }
            //Get the method associated with this modifier ApplicationType
            let callback = getModifierCallBackByApplicationType(applicationType);
            let toUpdate= {};
            toUpdate[modifier_id+"_apply-to-desc"] = applyToDesc;
            setAttrs(toUpdate,{silent:true}, () =>{
                getModifiersByTypeAndUpdateValues(applicationType,callback,null);
            });
        });
    }
    
    //Get all modifiers Id then call a recursive method to build a list of modifiers
    let getModifiersByTypeAndUpdateValues = (applicationType,callback,callback_id) => {
        getSectionIDs("repeating_modifiers", (idArray) => {
            getNextModifierByTypeAndUpdateValues(idArray, [], applicationType,callback,callback_id);
        });
    }
    
    /*
        - Get the last entry of modifierToGetList and remove it from the list
        - if last entry is enabled and is of type applicationType, add it to modifierList as an object.
        - If modifierToGetList is empty,call callback with modifiers and callback_id
     */
    let getNextModifierByTypeAndUpdateValues = (modifierToGetList,modifierList,applicationType,callback,callback_id) =>{
        if(!modifierToGetList?.length){
            return callback(modifierList,callback_id);
        }
        let newModifierToGetList = [...modifierToGetList];
    
        let id = "repeating_modifiers_" + newModifierToGetList.pop();
        let name = id + "_name";
        let enabled = id + "_enabled";
        let value = id + "_value";
        let type = id + "_type";
        let applyTo = id + "_apply-to";
        let applyToOther = id + "_apply-to-other";
        getAttrs([id,name,enabled,value,type,applyTo,applyToOther],(attrs) => {
            let modifier = {
                name : attrs[name],
                enabled : attrs[enabled],
                value : Number(attrs[value]),
                type : attrs[type],
                applyTo : attrs[applyTo],
                applyToOther : attrs[applyToOther]?.split(/[,;]/)
            };
            if(modifier.enabled === "on" && modifier.applyTo?.startsWith(applicationType)){
                modifierList.push(modifier)
            }
            getNextModifierByTypeAndUpdateValues(newModifierToGetList,modifierList,applicationType,callback,callback_id);
        });
    }
    
    let getLargestModifierOfEachTypeFor = (modifiersList,attr_name) =>{
        let types = {};
        let _name = attr_name?.toLowerCase();
        let filteredModifierList = [];
        for(let modifier of modifiersList){
            const applyToOther = modifier.applyToOther?.map(apply => apply?.toLowerCase());
            const applyToOtherMap = modifier.applyToOther?.map(apply => modmap[apply?.toLowerCase()]);
            if(modifier.applyTo.endsWith("_all") || !_name || modifier.applyTo.endsWith(_name) ||
                (modifier.applyTo.endsWith("_other") && applyToOther?.includes(_name)) ||
                (modifier.applyTo.endsWith("_other") && applyToOtherMap?.includes(_name))
            ){
                let type = modifier.type;
                //Untyped && circumstance always apply
                if(type === "untyped" || type === "circumstance" || type === "dodge"){
                    filteredModifierList.push(modifier);
                    continue;
                }
                let val = modifier.value;
                if(!types[type] || types[type].value < modifier.value){
                    types[type] = modifier;
                }
            }
        }
        for(let key in types){
            filteredModifierList.push(types[key]);
        }
        return filteredModifierList;
    }
    let getModifierCallBackByApplicationType = (applicationType) =>{
        switch (applicationType) {
            case "carac":
                return updateAllCharacteristics;
            case "init":
                return updateInitiative;
            case "speed":
                return updateSpeed;
            case "skill":
                return updateAllSkills;
            case "save":
                return updateAllSaves;
            case "armor":
                return updateArmor;
            default:
                return () => {};
        }
    }
    
    let updateClassSaves = () => {
        getAttrs(["class1_lvl", "class2_lvl", "class3_lvl", "class1_ref", "class2_ref", "class3_ref"
            , "class1_vig", "class2_vig", "class3_vig", "class1_vol", "class2_vol", "class3_vol"], (attrs) => {
            let class1_lvl = parseInt(attrs.class1_lvl) || 0;
            let class2_lvl = parseInt(attrs.class2_lvl) || 0;
            let class3_lvl = parseInt(attrs.class3_lvl) || 0;
            let class1_ref = parseInt(attrs.class1_ref) || 0;
            let class2_ref = parseInt(attrs.class2_ref) || 0;
            let class3_ref = parseInt(attrs.class3_ref) || 0;
            let class1_vig = parseInt(attrs.class1_vig) || 0;
            let class2_vig = parseInt(attrs.class2_vig) || 0;
            let class3_vig = parseInt(attrs.class3_vig) || 0;
            let class1_vol = parseInt(attrs.class1_vol) || 0;
            let class2_vol = parseInt(attrs.class2_vol) || 0;
            let class3_vol = parseInt(attrs.class3_vol) || 0;
            let base_ref = 0;
            let base_vol = 0;
            let base_vig = 0;
            if (class1_lvl) {
                base_ref += class1_ref;
                base_vig += class1_vig;
                base_vol += class1_vol;
            }
            if (class2_lvl) {
                base_ref += class2_ref;
                base_vig += class2_vig;
                base_vol += class2_vol;
            }
            if (class3_lvl) {
                base_vol += class3_vol;
                base_ref += class3_ref;
                base_vig += class3_vig;
            }
            setAttrs({ref_base: base_ref, vig_base: base_vig, vol_base: base_vol});
        });
    }
    
    
    on("change:ref_base change:ref_mod change:vig_base change:vig_mod change:vol_base change:vol_mod", function(eventInfo) {
        getModifiersByTypeAndUpdateValues(applicationTypes.save,updateAllSaves);
    });
    
    let updateAllSaves = (modifierList) => {
        let saves = ["ref","vig","vol"];
        getAttrs(["dex_mod","con_mod","sag_mod","ref_base","ref_mod","vig_base","vig_mod","vol_base","vol_mod"], (values) => {
            for(let save of saves){
                let carac = 0;
                let caracName = 0;
                switch (save){
                    case "ref":
                        carac = parseInt(values[`dex_mod`]) || 0;
                        caracName = `dex_mod`;
                        break;
                    case "vig":
                        carac = parseInt(values[`con_mod`]) || 0;
                        caracName = `con_mod`;
                        break;
                    case "vol":
                        carac = parseInt(values[`sag_mod`]) || 0;
                        caracName = `sag_mod`;
                        break;
                }
                let base = parseInt(values[`${save}_base`]) || 0;
                let mod = parseInt(values[`${save}_mod`]) || 0;
                let save_name = `^{saves.${save}.roll}`
                let total = base+carac;
                let mods = mod;
                let roll = `${carac}[${caracName}] + ${base}[${save}_base] + ${mod}[${save}_mod]`
                let filteredModifierList = getLargestModifierOfEachTypeFor(modifierList,save);
                for(let modifier of filteredModifierList){
                    mods += modifier.value;
                    roll += `+${modifier.value}[${modifier.name}(${modifier.type})]`
                }
                let toUpdate = {};
                toUpdate[`${save}_total`] = total + mods;
                toUpdate[`${save}_roll_value`] = `&{template:main} {{titre=${save_name}}} {{subtitle=@{character_name} }} {{Jet=[[1d20+${roll}]]}}`;
                toUpdate[`${save}_modified`] = !!mods;
                setAttrs(toUpdate);
            }
        });
    }
    
    
    const current_version = "1.0.0";
    
    on("sheet:opened",(eventInfo) =>{
        getAttrs(["sheet_version"], function(attrs) {
            let version = attrs["sheet_version"];
            update(version);
        });
    });
    
    let update = (fromVersion) => {
        let newVersion
        switch (fromVersion){
            case "1.0.0":
                return;
            default:
                init();
        }
    }
    
    let init = () => {
        setAttrs({
            "sheet_version":current_version,
            "vit_base":0,
            "rd":0,
            "sheetTab":"character"
        },true,() => {
            updateAllCharacteristics([]);
        });
    
    }
    
    
</script>