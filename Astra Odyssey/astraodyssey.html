<div class="sheet-charasheet-wrap">
  <div class="sheet-conrow">
    <input type="text" name="attr_player" placeholder="플레이어" style="width:100px;" />
    <!-- 캐릭터 정보, 프로필 이미지 -->
    <div class="sheet-col sheet-section-character">
      <input type="text" name="attr_character_name" placeholder="이름" />
      <div class="sheet-profile-image">
        <img name="attr_character_avatar" class="sheet-chara-avatar"/>
      </div>
    </div>
      
    <!-- 캐릭터 속성 섹션 -->
    <div class="sheet-col sheet-section-info">
      <div class="sheet-fatality">
        <input type="text" name="attr_fatality" class="sheet-input" placeholder="숙명" />
      </div>
      <div class="sheet-stat stat-hp">
        <label class="smlbl" for="hp">체력</label>
        <input type="hidden" class="sheet-bar" name="attr_hp_bar" />
        <div class="sheet-hp-bar">
          <input type="hidden" name="attr_injury_bar" /><span name="attr_hp_injury" title="중상"></span>
        </div>
        <div class="sheet-stat-input">
          <input id="hp" type="number" name="attr_hp" title="체력" />
          <span>/</span>
          <input type="number" name="attr_hp_max" title="최대체력" />
          <span>|</span>
          <input type="number" name="attr_hp_injury" title="중상" />
        </div>
        <input type="text" name="attr_hp_debuf" placeholder="상태" />
      </div>
      <div class="sheet-stat stat-san">
        <label class="smlbl" for="san">정신력</label>
        <input type="hidden" class="sheet-bar" name="attr_san_bar" />
        <div class="sheet-san-bar"></div>
        <div class="sheet-stat-input">
          <input id="san" type="number" name="attr_san" title="정신력" />
          <span>/</span>
          <input type="number" name="attr_san_max" title="최대정신력" />
        </div>
        <input type="text" name="attr_san_debuf" placeholder="상태" />
      </div>

      <div class="sheet-stat stat-mp">
        <label class="smlbl" for="mp">마력</label>
        <input type="hidden" class="sheet-bar" name="attr_mp_bar" />
        <div class="sheet-mp-bar"></div>
        <div class="sheet-stat-input">
          <input id="mp" type="number" name="attr_mp" title="마력" />
          <span>/</span>
          <input type="number" name="attr_mp_max" title="최대마력" />
        </div>
        <div class="sheet-section-add">
          <label class="smlbl">
            <span style="padding-left: 5px;">난이도</span>
            <select name="attr_diff" title="난이도">
              <option value="6">쉬움</option>
              <option value="8" selected>보통</option>
              <option value="10">어려움</option>
            </select>
          </label>
          <div class="section-mod">
            <select name="attr_mod_type">
              <option>+</option>
              <option>-</option>
            </select>
            <input type="number" name="attr_mod_dice" min="0" value="0" />
          </div>
        </div>
      </div>


      <div class="sheet-box">
        <label class="box-label" for="debuf">상태이상</label>
        <textarea name="attr_etc_debuf" id="debuf">기타 상태이상</textarea>
      </div>
      
      <div class="sheet-stress-reaction sheet-box">
        <label class="box-label">

          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=스트레스}} {{stress=[[1d2]]}} {{titleA=@{stress_a_title}}} {{titleB=@{stress_b_title}}} {{descA=@{stress_a_desc}}} {{descB=@{stress_b_desc}}}">스트레스 반응</button>
        </label>
        <div>
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=스트레스}} {{title=@{stress_a_title}}} {{desc=@{stress_a_desc}}}"></button>
          <input type="text" name="attr_stress_a_title" placeholder="A" />
          <textarea name="attr_stress_a_desc" rows="1" placeholder="스트레스 반응 설명"></textarea>
        </div>
        <div>
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=스트레스}} {{title=@{stress_b_title}}} {{desc=@{stress_b_desc}}}"></button>
          <input type="text" name="attr_stress_b_title" placeholder="B"  />
          <textarea name="attr_stress_b_desc" rows="1" placeholder="스트레스 반응 설명"></textarea>
        </div>
      </div>

    </div>
  </div>

  <!-- 면모와 장비/아이템 span 3 칸-->
  <div class="sheet-conrow">
    <div class="sheet-aspect sheet-box">
      <h3 class="box-label">면모</h3>
      <div class="sheet-rep-item rep-aspect">
        <div>
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=면모}} {{title=@{aspect_title_1}}} {{desc=@{aspect_desc_1}\n*@{aspect_effect_1}*}}"></button>
          <input class="sheet-rep-title" type="text" name="attr_aspect_title_1" placeholder="면모 이름" />
        </div>
        <div>
          <textarea class="sheet-rep-desc" name="attr_aspect_desc_1" placeholder="면모 설명" rows="2"></textarea>
        </div>
        <div>
          <textarea class="sheet-rep-desc" name="attr_aspect_effect_1" placeholder="면모 효과" rows="2"></textarea>
        </div>
      </div>
      <fieldset class="repeating_aspect">
        <div class="sheet-rep-item rep-aspect">
          <div>
            <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=면모}} {{title=@{aspect_title}}} {{desc=@{aspect_desc}\n*@{aspect_effect}*}}"></button>
            <input class="sheet-rep-title" type="text" name="attr_aspect_title" placeholder="면모 이름" />
          </div>
          <div>
            <textarea class="sheet-rep-desc" name="attr_aspect_desc" placeholder="면모 설명" rows="2"></textarea>
          </div>
          <div>
            <textarea class="sheet-rep-desc" name="attr_aspect_effect" placeholder="면모 효과" rows="2"></textarea>
          </div>
        </div>
      </fieldset>
    </div>

    <div class="sheet-gear sheet-box">
      <h3 class="box-label">장비와 아이템</h3>
      <fieldset class="repeating_gear">
        <div class="sheet-rep-item rep-gear">
          <div>
            <select name="attr_gear_type">
              <option selected>분류</option>
              <option>장비: 무기</option>
              <option>장비: 착용</option>
              <option>장비: 미착용</option>
              <option>소모품</option>
              <option>수집품</option>
              <option>소지품</option>
              <option>특수</option>
              <option>기타</option>
            </select>
            <input class="sheet-rep-title" type="text" name="attr_gear_title" placeholder="장비/아이템 이름" />
          </div>
          <div>
            <textarea class="sheet-rep-desc" name="attr_gear_desc" placeholder="장비/아이템 설명" rows="1"></textarea>
          </div>
        </div>
      </fieldset>
    </div>
  </div>


  <!-- 탐색 통찰 기술 -->
  <div class="sheet-conrow sheet-skill">
    <!-- 한칸, 메뉴 -->
    <div class="sheet-skill-menu">
      <div class="label-menu">
        <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{title=탐색}} {{dice=[[ [[2d6]][2D6]+@{search}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}" class="smlbl">탐색</button>
        <input type="number" name="attr_search" value="0"  />
      </div>
      <div class="label-menu">
        <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{title=통찰}} {{dice=[[ [[2d6]][2D6]+@{insight}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}" class="smlbl">통찰</button>
        <input type="number" name="attr_insight" value="0" />
      </div>
      <div class="label-menu-skill">
        <span class="smlbl" style="height:22px;">기술</span>
      </div>
    
      <div class="sheet-section-add sheet-box">
        <div class="add-grid">
          <label class="smlbl" for="diff">난이도</label>
          <select id="diff" name="attr_diff" title="난이도">
            <option value="6">쉬움</option>
            <option value="8" selected>보통</option>
            <option value="10">어려움</option>
          </select>
        </div>
        <div class="add-grid">
          <label class="smlbl" for="mod">수정치</label>
          <select name="attr_mod_type">
            <option>+</option>
            <option>-</option>
          </select>
          <input type="number" id="mod" name="attr_mod_dice" min="0" value="0" />
        </div>
        <div class="add-grid">
          <button class="smlbl" type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=주사위}} {{title=1D6}} {{dice=[[1D6]]}} {{rawdice=[[3]]}} {{nodesc=1}}">1D6</button>
          <button class="smlbl" type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=주사위}} {{title=2D6}} {{dice=[[2D6]]}} {{rawdice=[[3]]}} {{nodesc=1}}">2D6</button>
        </div>
      </div>
    </div>
    <!-- 다섯칸 / 4, 기술리스트 -->
    <div class="sheet-skill-listbox sheet-box">
      <div class="skill-each communication">
        <h4>커뮤니케이션</h4>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=설득}} {{dice=[[ [[2d6]][2D6]+@{skill_co_1_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title">설득</div>
          <input type="number" name="attr_skill_co_1_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=조련}} {{dice=[[ [[2d6]][2D6]+@{skill_co_2_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">조련</div>
          <input type="number" name="attr_skill_co_2_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=현혹}} {{dice=[[ [[2d6]][2D6]+@{skill_co_3_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">현혹</div>
          <input type="number" name="attr_skill_co_3_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=위협}} {{dice=[[ [[2d6]][2D6]+@{skill_co_4_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">위협</div>
          <input type="number" name="attr_skill_co_4_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=눈치}} {{dice=[[ [[2d6]][2D6]+@{skill_co_5_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">눈치</div>
          <input type="number" name="attr_skill_co_5_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=속임수}} {{dice=[[ [[2d6]][2D6]+@{skill_co_6_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">속임수</div>
          <input type="number" name="attr_skill_co_6_level" value="0" />
        </div>
        <fieldset class="repeating_skill-communication">
          <div class="rep-skill">
            <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=@{skill_title}}} {{dice=[[ [[2d6]][2D6]+@{skill_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
            <input class="sheet-rep-title" type="text" name="attr_skill_title" placeholder="기술 이름" />
            <input type="number" name="attr_skill_level" placeholder="레벨" />
          </div>
        </fieldset>
      </div>

      <div class="skill-each knowledge">
        <h4>학문/지식</h4>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=외국어}} {{dice=[[ [[2d6]][2D6]+@{skill_kn_1_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">외국어</div>
          <input type="number" name="attr_skill_kn_1_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=자연}} {{dice=[[ [[2d6]][2D6]+@{skill_kn_2_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">자연</div>
          <input type="number" name="attr_skill_kn_2_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=문화}} {{dice=[[ [[2d6]][2D6]+@{skill_kn_3_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">문화</div>
          <input type="number" name="attr_skill_kn_3_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=역사/신화}} {{dice=[[ [[2d6]][2D6]+@{skill_kn_4_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">역사/신화</div>
          <input type="number" name="attr_skill_kn_4_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=공학}} {{dice=[[ [[2d6]][2D6]+@{skill_kn_5_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">공학</div>
          <input type="number" name="attr_skill_kn_5_level" value="0" />
        </div>
        <fieldset class="repeating_skill-knowledge">
          <div class="rep-skill">
            <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=@{skill_title}}} {{dice=[[ [[2d6]][2D6]+@{skill_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
            <input class="sheet-rep-title" type="text" name="attr_skill_title" placeholder="기술 이름" />
            <input type="number" name="attr_skill_level" placeholder="레벨" />
          </div>
        </fieldset>
      </div>

      <div class="skill-each battle">
        <h4>전투</h4>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=사격}} {{dice=[[ [[2d6]][2D6]+@{skill_ba_1_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">사격</div>
          <input type="number" name="attr_skill_ba_1_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=근접전}} {{dice=[[ [[2d6]][2D6]+@{skill_ba_2_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">근접전</div>
          <input type="number" name="attr_skill_ba_2_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=회피}} {{dice=[[ [[2d6]][2D6]+@{skill_ba_3_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">회피</div>
          <input type="number" name="attr_skill_ba_3_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=방어}} {{dice=[[ [[2d6]][2D6]+@{skill_ba_4_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">방어</div>
          <input type="number" name="attr_skill_ba_4_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=스텔스}} {{dice=[[ [[2d6]][2D6]+@{skill_ba_5_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">스텔스</div>
          <input type="number" name="attr_skill_ba_5_level" value="0" />
        </div>
        <fieldset class="repeating_skill-battle">
          <div class="rep-skill">
            <button type="roll" value="&{template:astra} {{character=@{character_name}}}"></button>
            <input class="sheet-rep-title" type="text" name="attr_skill_title" placeholder="기술 이름" />
            <input type="number" name="attr_skill_level" placeholder="레벨" />
          </div>
        </fieldset>
      </div>

      <div class="skill-each operation">
        <h4>재주 및 조작</h4>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=해킹/프로그래밍}} {{dice=[[ [[2d6]][2D6]+@{skill_op_1_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text" style="font-size:0.9em;">해킹/프로그래밍</div>
          <input type="number" name="attr_skill_op_1_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=기계 수리}} {{dice=[[ [[2d6]][2D6]+@{skill_op_2_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">기계 수리</div>
          <input type="number" name="attr_skill_op_2_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=제작}} {{dice=[[ [[2d6]][2D6]+@{skill_op_3_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">제작</div>
          <input type="number" name="attr_skill_op_3_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=운전}} {{dice=[[ [[2d6]][2D6]+@{skill_op_4_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">운전</div>
          <input type="number" name="attr_skill_op_4_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=손놀림}} {{dice=[[ [[2d6]][2D6]+@{skill_op_6_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">손놀림</div>
          <input type="number" name="attr_skill_op_5_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=요리}} {{dice=[[ [[2d6]][2D6]+@{skill_op_6_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">요리</div>
          <input type="number" name="attr_skill_op_6_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=공연}} {{dice=[[ [[2d6]][2D6]+@{skill_op_7_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">공연</div>
          <input type="number" name="attr_skill_op_7_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=치료}} {{dice=[[ [[2d6]][2D6]+@{skill_op_8_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">치료</div>
          <input type="number" name="attr_skill_op_8_level" value="0" />
        </div>
        <div class="rep-skill">
          <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=무브먼트}} {{dice=[[ [[2d6]][2D6]+@{skill_op_9_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
          <div class="sheet-rep-title" type="text">무브먼트</div>
          <input type="number" name="attr_skill_op_9_level" value="0" />
        </div>
        <fieldset class="repeating_skill-operation">
          <div class="rep-skill">
            <button type="roll" value="&{template:astra} {{character=@{character_name}}} {{type=기술}} {{title=@{skill_title}}} {{dice=[[ [[2d6]][2D6]+@{skill_level}@{mod_type}@{mod_dice}[수정치] ]]}} {{rawdice=$[[0]]}} {{diff=[[@{diff}]]}} {{nodesc=1}}"></button>
            <input class="sheet-rep-title" type="text" name="attr_skill_title" placeholder="기술 이름" />
            <input type="number" name="attr_skill_level" placeholder="레벨" />
          </div>
        </fieldset>
      </div>

    </div>

  </div>

  <!-- 카르마, 텍스트입력 -->
  <!-- 카르마 부분을 span3으로 할지 -->
  <div class="sheet-conrow">

    <div class="sheet-karma sheet-box">
      <label class="box-label">카르마</label>
      <div>
        <!-- 이 영역 1:1 -->
        <div>
          <!-- <button type="roll" value="&{template:astra} {{character=@{character_name}}}"></button> -->
          <div class="smlbl">
            <span>+</span>
            <input type="text" name="attr_karma_a_title" placeholder="카르마 이름" />
          </div>
          <input type="number" name="attr_karma_a" value="0" />
        </div>
        <div>
          <!-- <button type="roll" value="&{template:astra} {{character=@{character_name}}}"></button> -->
          <div class="smlbl">
            <span>-</span>
            <input type="text" name="attr_karma_b_title" placeholder="카르마 이름" />
          </div>
          <input type="number" name="attr_karma_b" value="0" />
        </div>
      </div>
    </div>

    <div class="sheet-box">
      <label class="box-label">핵심적인 기억/사건/키워드</label>
      <textarea name="attr_keyword"></textarea>
    </div>

  </div>

  <!-- 관계 / 평판묘사 -->
  <div class="sheet-conrow">
    <div class="sheet-relationship sheet-box">
      <label class="box-label">관계
      </label>
      <div class="reputation">
        <div></div>
        <div></div>
        <span>평판</span>
        <input type="text" name="attr_reputation" placeholder="인물에 대한 평판" />
      </div>
      <fieldset class="repeating_relationship">
        <div class="sheet-rep-item rep-relationship">
          <!-- <button type="roll" value="&{template:astra} {{character=@{character_name}}}"></button> -->
          <input class="sheet-rep-title" type="text" name="attr_relationship_name" placeholder="이름" />
          <input type="text" name="attr_relationship_brief" placeholder="관계 요약" />
          <input type="text" name="attr_relationship_desc" placeholder="관계에 대한 설명" />
        </div>
      </fieldset>
    </div>
  </div>
</div>



<!-- 롤템플릿 -->
<rolltemplate class="sheet-rolltemplate-astra">
  <div class="sheet-rt-wrap">
    <div class="sheet-rt-top">
      <div class="sheet-rt-charaname">{{character}}</div>
      {{#type}}{{#diff}}<div class="sheet-rt-type">{{type}} | {{#rollTotal() diff 10}}어려움{{/rollTotal() diff 10}}{{#rollTotal() diff 8}}보통{{/rollTotal() diff 8}}{{#rollTotal() diff 6}}쉬움{{/rollTotal() diff 6}}{{diff}}</div>{{/diff}}{{/type}}
      {{#type}}{{^diff}}<div class="sheet-rt-type">{{type}}</div>{{/diff}}{{/type}}
      {{^type}}{{#diff}}<div class="sheet-rt-type">{{#rollTotal() diff 10}}어려움{{/rollTotal() diff 10}}{{#rollTotal() diff 8}}보통{{/rollTotal() diff 8}}{{#rollTotal() diff 6}}쉬움{{/rollTotal() diff 6}}{{diff}}</div>{{/diff}}{{/type}}
    </div>
    <h4 class="sheet-rt-title">
      {{title}}
      {{#rollTotal() stress 1}}{{titleA}}{{/rollTotal() stress 1}}
      {{#rollTotal() stress 2}}{{titleB}}{{/rollTotal() stress 2}}
    </h4>
    {{#dice}}
    <div class="sheet-rt-dicebox">
      {{#rollTotal() rawdice 2}}<div class="sheet-rt-dice sheet-rt-fullfail">{{dice}}</div>{{/rollTotal() rawdice 2}}
      {{#rollTotal() rawdice 12}}<div class="sheet-rt-dice sheet-rt-fullcrit">{{dice}}</div>{{/rollTotal() rawdice 12}}
      {{#rollBetween() rawdice 3 11}}<div class="sheet-rt-dice">{{dice}}</div>{{/rollBetween() rawdice 3 11}}
      {{#diff}}
      <!-- 대성공 대실패 먼저 처리 -->
      {{#rollTotal() rawdice 2}}<div class="sheet-rt-result sheet-rt-fumble">펌블</div>{{/rollTotal() rawdice 2}}
      {{#rollTotal() rawdice 12}}<div class="sheet-rt-result sheet-rt-critical">특별성공</div>{{/rollTotal() rawdice 12}}
      <!-- 일반성공 실패 처리 -->
      {{#rollBetween() rawdice 3 11}}
        {{#rollLess() dice diff}}<div class="sheet-rt-result sheet-rt-fail">실패</div>{{/rollLess() dice diff}}
        {{#^rollLess() dice diff}}<div class="sheet-rt-result sheet-rt-success">성공</div>{{/^rollLess() dice diff}}
      {{/rollBetween() rawdice 3 11}}
      {{/diff}}
    </div>
    {{/dice}}
    {{^nodesc}}
    <div class="sheet-rt-desc">{{desc}}{{#rollTotal() stress 1}}{{descA}}{{/rollTotal() stress 1}}{{#rollTotal() stress 2}}{{descB}}{{/rollTotal() stress 2}}</div>
    {{/nodesc}}
  </div>
</rolltemplate>

<!-- 시트워커 -->
<script type="text/worker">
  // 함수
const calculateBarPercentage = (current, max) => {
  if (!current || !max || max <= 0) return 0;
  return Math.max(0, Math.min(100, (current / max) * 100));
};

const set_debuf = (hp,hpmax,san,sanmax) => {
  let hpStatus = '';
  let sanStatus = '';

  // HP
  const hpCurrent = (hp === '' || hp == null) ? null : Number(hp);
  const hpMax = (hpmax === '' || hpmax == null) ? null : Number(hpmax);
  if (hpCurrent == null || hpMax == null) {
    hpStatus = "신체 상태";
  } else if (hpCurrent >= hpMax) {
    hpStatus = "건강함";
  } else if (hpCurrent === 1) {
    hpStatus = "빈사: 행동 불능";
  } else if (hpCurrent < hpMax / 4) {
    hpStatus = "치명상: 행동 페널티";
  } else if (hpCurrent >= hpMax * 0.5) {
    hpStatus = "경미한 부상";
  } else if (hpCurrent >= 2) {
    hpStatus = "심한 부상";
  } else {
    hpStatus = "신체 상태";
  }

  // SAN
  const sanCurrent = (san === '' || san == null) ? null : Number(san);
  const sanMax = (sanmax === '' || sanmax == null) ? null : Number(sanmax);

  if (sanCurrent == null || sanMax == null) {
    sanStatus = "정신 상태";
  } else if (sanCurrent >= sanMax) {
    sanStatus = "평이함";
  } else if (sanCurrent < sanMax / 4) {
    sanStatus = "극도의 스트레스 상태: 상해 또는 자해";
  } else if (sanCurrent <= sanMax * 0.75) {
    sanStatus = "긴장 상태";
  } else if (sanCurrent < sanMax) {
    sanStatus = "심란함";
  } else {
    sanStatus = "정신 상태";
  }
  setAttrs({
    hp_debuf: hpStatus,
    san_debuf: sanStatus
  });
};

// EVENT
on("sheet:opened change:hp change:hp_max change:mp change:mp_max change:san change:san_max",
function () {
  getAttrs(["hp", "hp_max", "mp", "mp_max", "san", "san_max"], function (values) {
    const hp_bar = calculateBarPercentage(values.hp, values.hp_max);
    const mp_bar = calculateBarPercentage(values.mp, values.mp_max);
    const san_bar = calculateBarPercentage(values.san, values.san_max);

    setAttrs({
      hp_bar: Math.round(hp_bar).toString(),
      mp_bar: Math.round(mp_bar).toString(),
      san_bar: Math.round(san_bar).toString()
    });
    
    set_debuf(values.hp, values.hp_max, values.san, values.san_max);
  });
});

on("sheet:opened change:hp_injury change:hp_max change:hp", function () {
  getAttrs(["hp_injury", "hp_max", "hp"], function (values) {
    const injury_bar = calculateBarPercentage(values.hp_injury, values.hp_max);
    setAttrs({
      injury_bar: Math.round(injury_bar).toString()
    });
  });
});

</script>