<div class="container">
    <div class="pc">
        <div class="header">
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content two-columns"><label for="attr_character_name" data-i18n="name-and-pronouns">Name
                            & Pronouns</label><input type="text" id="attr_character_name"
                            name="attr_character_name" /><label for="attr_class" data-i18n="class">Class</label><input
                            type="text" id="attr_class" name="attr_class" list="class-list" data-i18n-dynamic />
                        <datalist id="class-list">
                            <option data-i18n="bard">Bard</option>
                            <option data-i18n="dungeoneer">Dungeoneer</option>
                            <option data-i18n="gnome">Gnome</option>
                            <option data-i18n="knight-errant">Knight-Errant</option>
                            <option data-i18n="loyal-chum">Loyal Chum</option>
                            <option data-i18n="rascal">Rascal</option>
                        </datalist>
                    </div>
                </div>
            </div>
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content two-columns"><label for="attr_folk" data-i18n="folk">Folk</label><input
                            type="text" id="attr_folk" name="attr_folk" /><label for="attr_homeland"
                            data-i18n="homeland">Homeland</label><input type="text" id="attr_homeland"
                            name="attr_homeland" /></div>
                </div>
            </div>
            <div class="xp-rows">
                <img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/xp.png"
                    class="xp-background" />
                <div class="corner-box-wrapper">
                    <div class="corner-box">
                        <div class="content two-columns"><label for="attr_lv" data-i18n="lv">LV</label><input
                                type="number" name="attr_lv" /></div>
                    </div>
                </div>
                <div class="corner-box-wrapper">
                    <div class="corner-box">
                        <div class="content two-columns"><label for="attr_xp" data-i18n="xp">XP</label><input
                                type="number" name="attr_xp" /></div>
                    </div>
                </div>
            </div>
            <img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/logo-flat.png"
                alt="Land of Eem Logo" class="logo" />
        </div>
        <!--********* NAV BAR **********-->
        <input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="attributes" />
        <div class="nav-bar">
            <button type="action" name="act_attributes" class="sheet-button0"
                data-i18n="attributes-and-abilities">Attributes</button>
            <button type="action" name="act_inventory" class="sheet-button1"
                data-i18n="inventory-and-crafting">Inventory</button>
            <button type="action" name="act_background" class="sheet-button2"
                data-i18n="personality-and-backstory">Background</button>
            <button type="action" name="act_notes" class="sheet-button3" data-i18n="notes-and-portrait">Journal</button>
        </div>
        <!--********* SHEET - ATTRIBUTES & ABILITIES **********-->
        <div class="sheet-attributes">
            <div class="attribute-box">
                <div>
                    <button type="action" name="act_vim">
                        <h2 data-i18n="vim">Vim</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_vim" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_charm" /></li>
                    <li><input type="text" name="attr_inspire" /></li>
                    <li><input type="text" name="attr_mettle" /></li>
                    <li><input type="text" name="attr_perception" /></li>
                </ul>
                <ul>
                    <li><button type="action" name="act_charm" data-i18n="charm">Charm</button></li>
                    <li><button type="action" name="act_inspire" data-i18n="inspire">Inspire</button></li>
                    <li><button type="action" name="act_mettle" data-i18n="mettle">Mettle</button></li>
                    <li><button type="action" name="act_perception" data-i18n="perception">Perception</button></li>
                </ul>
            </div>
            <div class="stat-box stat-courage">
                <h2 data-i18n="courage">Courage</h2>
                <input type="number" name="attr_courage_max" class="big" />
                <input type="number" name="attr_courage" class="small" />
                <label data-i18n="current" class="small">Current</label>
            </div>
            <div class="corner-box-wrapper side" style="grid-row-end: span 3;">
                <label class="corner-box-header" data-i18n="proficiencies">Proficiencies</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_proficiencies" rows="3"></textarea></div>
                </div>
                <label class="corner-box-header" data-i18n="conditions">Conditions</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_conditions" rows="3"></textarea></div>
                </div>
            </div>
            <div class="corner-box-wrapper side" style="grid-row-end: span 3;">
                <label class="corner-box-header" data-i18n="deficiencies">Deficiencies</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_deficiencies" rows="3"></textarea></div>
                </div>
                <label class="corner-box-header" data-i18n="heroic-titles">Heroic Titles</label>
                <div class="corner-box">
                    <div class=content><textarea name="attr_heroic_titles" rows="3"></textarea></div>
                </div>
            </div>
            <div class="separator"></div>
            <div></div>
            <div class="attribute-box">
                <div>
                    <button type="action" name="act_vigor">
                        <h2 data-i18n="vigor">Vigor</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_vigor" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_athletics" /></li>
                    <li><input type="text" name="attr_intimidate" /></li>
                    <li><input type="text" name="attr_might" /></li>
                    <li><input type="text" name="attr_vitality" /></li>
                </ul>
                <ul>
                    <li><button type="action" name="act_athletics" data-i18n="athletics">Athletics</button></li>
                    <li><button type="action" name="act_intimidate" data-i18n="intimidate">Intimidate</button></li>
                    <li><button type="action" name="act_might" data-i18n="might">Might</button></li>
                    <li><button type="action" name="act_vitality" data-i18n="vitality">Vitality</button></li>
                </ul>
            </div>
            <div class="stat-box stat-attack">
                <button type="action" name="act_attack">
                    <h2 data-i18n="attack">Attack</h2>
                </button>
                <input type="text" name="attr_attack" class="big" />
                <input type="text" name="attr_dread" class="small" />
                <label data-i18n="dread" for="attr_dread" class="small">Dread</label>
                <div style="display:block; width: 0; height: 0; overflow: visible;"><img
                        style="opacity: 0.2; min-width: 97px ; min-height: 97px;"
                        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/stats_2.png" /></div>
            </div>
            <div class="separator"></div>
            <div></div>
            <div style="grid-column-end: span 2; grid-row-end: span 4;" class="note-box">
                <div style="margin-top: -6px;">
                    <h2 data-i18n="perks-and-abilities">Perks & Abilities</h2>
                    <textarea name="attr_abilities" rows="9"></textarea>
                </div>
            </div>
            <div class="attribute-box">
                <div>
                    <button type="action" name="act_knack">
                        <h2 data-i18n="knack">Knack</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_knack" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_nimbleness" /></li>
                    <li><input type="text" name="attr_search" /></li>
                    <li><input type="text" name="attr_sneak" /></li>
                    <li><input type="text" name="attr_trickery" /></li>
                </ul>
                <ul>
                    <li><button type="action" name="act_nimbleness" data-i18n="nimbleness">Nimbleness</button></li>
                    <li><button type="action" name="act_search" data-i18n="search">Search</button></li>
                    <li><button type="action" name="act_sneak" data-i18n="sneak">Sneak</button></li>
                    <li><button type="action" name="act_trickery" data-i18n="trickery">Trickery</button></li>
                </ul>
            </div>
            <div class="stat-box stat-defense">
                <h2 data-i18n="defense">Defense</h2>
                <input type="text" name="attr_defense" class="big" />
                <input type="number" name="attr_block" class="small" />
                <label data-i18n="block" for="attr_block" class="small">Block</label>
            </div>
            <div class="separator"></div>
            <div></div>
            <div class="attribute-box">
                <div>
                    <button type="action" name="act_knowhow">
                        <h2 data-i18n="knowhow">Knowhow</h2>
                    </button>
                    <div class="dice-field"><input type="text" name="attr_knowhow" /></div>
                </div>
                <ul>
                    <li><input type="text" name="attr_lore" /></li>
                    <li><input type="text" name="attr_realms" /></li>
                    <li><input type="text" name="attr_tinker" /></li>
                    <li><input type="text" name="attr_wilderness" /></li>
                </ul>
                <ul>
                    <li><button type="action" name="act_lore" data-i18n="lore">Lore</button></li>
                    <li><button type="action" name="act_realms" data-i18n="realms">Realms</button></li>
                    <li><button type="action" name="act_tinker" data-i18n="tinker">Tinker</button></li>
                    <li><button type="action" name="act_wilderness" data-i18n="wilderness">Wilderness</button></li>
                </ul>
            </div>
            <div class="stat-box stat-quest">
                <h2 data-i18n="quest">Quest Pts.</h2>
                <input type="number" name="attr_quest_pts" class="big" />
            </div>
        </div>
        <!--********* SHEET - INVENTORY AND CRAFTING **********-->
        <div class="sheet-inventory">
            <div class="stripe upper">
                <section>
                    <h2 class="inventory" data-i18n="inventory">Inventory</h2>
                    <h2 data-i18n="slots">Slots:</h2>
                    <input class="small" type="number" name="attr_inventory_slots" />
                    <h2 class="small">/</h2><input class="small" type="number" name="attr_inventory_slots_max" />
                    <div class="checkbox-group">
                        <input type="checkbox" name="attr_overburdened" />
                        <label data-i18n="overburdened" for="attr_overburdened">Overburdened</label>
                        <input type="checkbox" name="attr_tired" />
                        <label data-i18n="tired" for="attr_tired">Tired</label>
                    </div>
                </section>
                <section>
                    <div class="treasure"><input type="text" name="attr_treasure_hunting" /></div>
                    <button class="treasure" type="action" name="act_treasure_hunting">
                        <h2 class="treasure" data-i18n="treasure-hunting">Treasure Hunting:</h2>
                    </button>
                </section>
            </div>
            <div class="inventory-upper">
                <div class="note-box">
                    <div>
                        <h2 class="worn" data-i18n="worn">Worn</h2>
                        <textarea rows="6" name="attr_worn"></textarea>
                        <div class="watermark worn"><img class="worn"
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/worn.png" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <h2 class="carried" data-i18n="carried">Carried</h2>
                        <textarea rows="6" name="attr_carried"></textarea>
                        <div class="watermark carried"><img class="carried"
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/carried.png" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="stripe lower">
                <section>
                    <img class="crafting"
                        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/crafting.png" />
                    <h2 data-i18n="crafting">Crafting</h2>
                    <div class="corner-box-wrapper">
                        <div class="corner-box-wrapper">
                            <div class="corner-box">
                                <div class="content two-columns"><label data-i18n="num-materials">No. of
                                        materials</label><input type="number" name="attr_material_number" /></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <img class="coins"
                        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/coins.png" />
                    <h2 data-i18n="coins">Coins</h2>
                    <section class="hint" data-i18n="tradeup">3:1 tradeup</section>
                </section>
                <section>
                    <img class="rations"
                        src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/rations.png" />
                    <h2 data-i18n="rations">Rations</h2>
                </section>
            </div>
            <div class="inventory-lower">
                <div class="note-box">
                    <div>
                        <div class="crafting fake-textarea">
                            <textarea rows="2" name="attr_material_elemental"></textarea>
                            <textarea rows="2" name="attr_material_fish"></textarea>
                            <textarea rows="2" name="attr_material_beast"></textarea>
                            <textarea rows="2" name="attr_material_herb"></textarea>
                        </div>
                        <div class="crafting-icons">
                            <img
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/material_elemental.png" />
                            <img
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/material_fish.png" />
                            <img
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/material_beast.png" />
                            <img
                                src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/LandOfEem/images/material_herb.png" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <div class="coins fake-textarea">
                            <section class="small" data-i18n="copper">Copper</section>
                            <section class="hint">d6</section><input type="number" name="attr_coins_copper" />
                            <section class="small" data-i18n="silver">Silver</section>
                            <section class="hint">d8</section><input type="number" name="attr_coins_silver" />
                            <section class="small" data-i18n="gold">Gold</section>
                            <section class="hint">d10</section><input type="number" name="attr_coins_gold" />
                            <section class="small" data-i18n="ancient">Ancient</section>
                            <section class="hint">d12</section><input type="number" name="attr_coins_ancient" />
                        </div>
                    </div>
                </div>
                <div class="vertical-line"></div>
                <div class="note-box">
                    <div>
                        <div class="rations fake-textarea">
                            <section class="hint">d6</section><input type="number" name="attr_rations_d6" />
                            <section class="hint">d8</section><input type="number" name="attr_rations_d8" />
                            <section class="hint">d10</section><input type="number" name="attr_rations_d10" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--********* SHEET - BACKGROUND AND NOTES **********-->
        <div class="sheet-background">
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content">
                        <label class="hint" data-i18n="ideals">Ideals</label>
                        <section class="sparkle">&#x1F7C5;</section>
                        <section data-i18n="ideals-hint" class="hint">Gain individual XP if you demonstrate your ideals
                        </section>
                        <textarea rows="3" name="attr_ideals"></textarea>
                    </div>
                </div>
            </div>
            <div class="corner-box-wrapper">
                <div class="corner-box">
                    <div class="content">
                        <label class="hint" data-i18n="flaws">Flaws</label>
                        <section class="sparkle">&#x1F7C5;</section>
                        <section data-i18n="flaws-hint" class="hint">Gain individual XP if you demonstrate your flaws
                        </section>
                        <textarea rows="3" name="attr_flaws"></textarea>
                    </div>
                </div>
            </div>
            <div style="grid-column-end: span 2;"></div>
            <div class="note-box">
                <div>
                    <h2 data-i18n="personal-quest" class="hint">Personal Quest</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="personal-quest-hint" class="hint">Gain party XP if you pursue your personal
                        quest</section>
                    <textarea rows="5" name="attr_personal_quest"></textarea>
                </div>
            </div>
            <div class="note-box" style="grid-row-end: span 2;">
                <div>
                    <h2 data-i18n="backstory" class="hint">Backstory</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="backstory-hint" class="hint">Gain individual XP if you tell a story about your
                        past</section>
                    <textarea rows="13" name="attr_backstory"></textarea>
                </div>
            </div>
            <div class="note-box">
                <div style="margin-top: 12px;">
                    <h2 data-i18n="relationships" class="hint">Relationships</h2>
                    <section class="sparkle">&#x1F7C5;</section>
                    <section data-i18n="relationships-hint" class="hint">Gain party XP if you build on a relationship
                    </section>
                    <textarea rows="6" name="attr_relationships"></textarea>
                </div>
            </div>
        </div>
        <!--********* NOTES **********-->
        <div class="sheet-notes">
            <div class="note-box">
                <div>
                    <h2 data-i18n="other-notes" class="hint">Notes</h2>
                    <textarea rows="18" name="attr_other_notes"></textarea>
                </div>
            </div>
        </div>
    </div>
    <!--********* FOOTER **********-->
    <div class="footer">
        <span>Character Sheet (v.<span name="attr_version"></span>) by </span><a
            href="https://github.com/blaze-sanecki/LandOfEem">Blaze
            Sanecki</a>, made with a blessing from <span>by Ben Costa & James Parks</span> - creators of the <a
            href="https://landofeem.com/"><b>Land of Eem</b></a>.
    </div>
</div>
<!--********* HIDDEN ATTRIBUTES **********-->
<input type="hidden" name="attr_version" value="1.0.0" />

<!--********* ROLL TEMPLATES **********-->
<rolltemplate class="sheet-rolltemplate-attack">
    <div class="template-container">
        <h2><span data-i18n="{{name}}">Name</span><i> ({{character}})</i></h2>
        <div class="results attack">
            <ul>
                <li>
                    {{#rollGreater() computed::roll 11}}
                    <span class="critical-hit">
                    {{/rollGreater() computed::roll 11}}
                    <h3><span data-i18n="attack">Attack</span>: {{computed::roll}} &nbsp;&nbsp;&nbsp; <span data-i18n="damage">Damage</span>:&nbsp;{{computed::damage}}</h3>
                    {{#rollGreater() computed::roll 11}}
                    </span>
                    {{/rollGreater() computed::roll 11}}
                </li>
                {{#rollTotal() computed::roll roll}}
                <div style="display:none">
                    {{/rollTotal() computed::roll roll}}
                    <li>
                        <h5 data-i18n="modifier-clamped">Modifier clamped to [-3..3] range.</h5>
                    </li>
                    {{#rollTotal() computed::roll roll}}
                </div>
                {{/rollTotal() computed::roll roll}}
                {{#rollLess() computed::roll 3}}
                <li>
                    <h4><b>[1-2]: </b></span> <span data-i18n="critical-miss">Critical Miss.</span></h4>
                </li>
                <li>
                    <h4><b><span data-i18n="fumble-example">Fumble Example</span>: </b><span data-i18n="fumble_example_{{random_index}}">EXAMPLE</span></h4>
                </li>
                {{/rollLess() computed::roll 3}}
                {{#rollBetween() computed::roll 3 5}}
                <li>
                    <h4><b>[3-5]: </b></span><span data-i18n="miss-with-a-plus">Miss with a Plus.</span></h4>
                </li>
                <li>
                    <h4><b><span data-i18n="plus-example">Plus Example</span>: </b><span data-i18n="plus_example_{{random_index}}">EXAMPLE</span></h4>
                </li>
                {{/rollBetween() computed::roll 3 5}}
                {{#rollBetween() computed::roll 6 8}}
                <li>
                    <h4><b>[6-8] (<span data-i18n="melee">Melee</span>): </b></span><span data-i18n="hit-with-a-counterattack">Hit with a Counterattack.</span></h4>
                    <h4><b>[6-8] (<span data-i18n="ranged">Ranged</span>): </b></span><span data-i18n="grazing-shot">Grazing Shot.</span></h4>
                </li>
                {{/rollBetween() computed::roll 6 8}}
                {{#rollBetween() computed::roll 9 11}}
                <li>
                    <h4><b>[9-11]: </b></span><span data-i18n="hit">Hit.</span></h4>
                </li>
                {{/rollBetween() computed::roll 9 11}}
                {{#rollGreater() computed::roll 11}}
                <li>
                    <h4><b>[12+]: </b></span><span data-i18n="critical-hit">Critical Hit.</span></h4>
                </li>
                {{/rollGreater() computed::roll 11}}
            </ul>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-check">
    <div class="template-container">
        <h2><span data-i18n="{{name}}">Name</span><i> ({{character}})</i></h2>
        <div class="results check">
            <ul>
                <li>
                    {{#rollGreater() computed::roll 11}}
                    <span class="critical-hit">
                    {{/rollGreater() computed::roll 11}}
                    <h3><span data-i18n="result">Result</span>:&nbsp;{{computed::roll}}</h3>
                    {{#rollGreater() computed::roll 11}}
                    </span>
                    {{/rollGreater() computed::roll 11}}
                </li>
                {{#rollTotal() computed::roll roll}}
                <div style="display:none">
                {{/rollTotal() computed::roll roll}}
                    <li>
                        <h5><span data-i18n="modifier-clamped">Modifier clamped to [-3..3] range.</span></h5>
                    </li>
                {{#rollTotal() computed::roll roll}}
                </div>
                {{/rollTotal() computed::roll roll}}
                {{#rollLess() computed::roll 3}}
                <li>
                    <h4><b>[1-2]: </b></span> <span data-i18n="complete-failure">Complete Failure.</span></h4>
                </li>
                {{/rollLess() computed::roll 3}}
                {{#rollBetween() computed::roll 3 5}}
                <li>
                    <h4><b>[3-5]: </b></span><span data-i18n="failure-with-a-plus">Failure with a Plus.</span></h4>
                </li>
                {{/rollBetween() computed::roll 3 5}}
                {{#rollBetween() computed::roll 6 8}}
                <li>
                    <h4><b>[6-8]: </b></span><span data-i18n="success-with-a-twist">Success with a Twist.</span></h4>
                </li>
                {{/rollBetween() computed::roll 6 8}}
                {{#rollBetween() computed::roll 9 11}}
                <li>
                    <h4><b>[9-11]: </b></span><span data-i18n="success">Success.</span></h4>
                </li>
                {{/rollBetween() computed::roll 9 11}}
                {{#rollGreater() computed::roll 11}}
                <li>
                    <h4><b>[12+]: </b></span><span data-i18n="complete-success">Complete Success.</span></h4>
                </li>
                {{/rollGreater() computed::roll 11}}
            </ul>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-hidden">
    <div class="sheet-template-container" style="display: none;"></div>
</rolltemplate>

<!--********* SCRIPTS **********-->
<script type="text/worker">
//********* TAB BUTTONS **********/
const buttonlist = ["attributes", "inventory", "background", "notes"]
buttonlist.forEach(button => {
    on(`clicked:${button}`, function() {
        setAttrs({
            sheetTab: button
        })
    })
})

//********* DEFINE SIGNED AND UNSIGNED ATTRIBUTES **********/
const signed = ["attack", "defense", "vim", "charm", "inspire", "mettle", "perception", "vigor", "athletics", "intimidate", "might", "vitality", "knack", "nimbleness", "search", "sneak", "trickery", "knowhow", "lore", "realms", "tinker", "wilderness", "treasure_hunting"];
const unsigned = ["courage", "courage_max", "quest_pts", "block", "inventory_slots", "inventory_slots_max", "material_number", "coins_copper", "coins_silver", "coins_gold", "coins_ancient", "rations_d6", "rations_d8", "rations_d10", "lv", "xp"];
const regular = ["vim", "charm", "inspire", "mettle", "perception", "vigor", "athletics", "intimidate", "might", "vitality", "knack", "nimbleness", "search", "sneak", "trickery", "knowhow", "lore", "realms", "tinker", "wilderness", "treasure_hunting"];

//********* DEFINE CUSTOM FUNCTIONS **********/
const updateStats = (statNames, difference) => {
    const result = {}
    getAttrs(statNames, (vals) => {
        statNames.forEach(stat => {
            let statVal = parseInt(vals[stat]) + difference
            statVal = (statVal >= 3 ? 3 : (statVal <= -3 ? -3 : statVal))
            result[stat] = statVal>=0 ? "+" + statVal : statVal
            setAttrs({
                [stat]: result[stat]
            })
        })
    })
    return result
}

//********* VALIDATE SIGNED NUMBER VALUES ON CHANGE **********/
on(signed.map(field => "change:" + field).join(" "), (eventinfo) => {
    const fieldName = eventinfo.sourceAttribute
    getAttrs([fieldName], (values) => {
        //********* IGNORE SHEETWORKER EVENTS **********/
        if(eventinfo.sourceType === "sheetworker") {
            return
        }
        //********* CLAMP TO -3 +3 AND SET THE VALUE **********/
        let oldValue = parseInt(eventinfo.previousValue)||0
        let val = parseInt(values[fieldName])
        if(isNaN(val)) {
            val = "+0"
        }
        else if(val < -3) {
            val = "-3"
        }
        else if(val > 3) {
            val = "+3"
        }
        else if(val >= 0) {
            val =  "+" + val
        }
        setAttrs({
          [fieldName]: val
        })
        const difference = (parseInt(val) - oldValue)
        //********* SYNC ABILITIES AND STATS WITH THEIR ATTRIBUTES **********/
        if(fieldName === "vim"){
            updateStats(["charm", "inspire", "mettle", "perception"], difference)
            getAttrs(["courage", "courage_max"], (vals) => {
                setAttrs({
                    courage_max: parseInt(vals["courage_max"]) + difference,
                    courage: parseInt(vals["courage"]) + difference
                })
            })
            
        }
        else if(fieldName === "vigor"){
            const newVals = updateStats(["athletics", "intimidate", "might", "vitality"], difference)
            getAttrs(["might", "vitality"], (vals) => {
                setAttrs({
                    attack: val,
                    inventory_slots_max: 20 + parseInt(newVals["might"])+parseInt(newVals["vitality"])
                })
            })
            
        }
        else if(fieldName === "knack"){
            updateStats(["nimbleness", "search", "sneak", "trickery"], difference)
            setAttrs({
                defense: parseInt(val)>0 ? -parseInt(val) : "+" +(-parseInt(val)),
            })
        }
        else if(fieldName === "knowhow"){
            updateStats(["lore", "realms", "tinker", "wilderness"], difference)
            setAttrs({
                quest_pts: parseInt(val)+3
            })
        }
        else if(fieldName === "might"){
            getAttrs(["vitality"], (vals) => {
                setAttrs({
                    inventory_slots_max: 20 + parseInt(val)+parseInt(vals["vitality"])
                })
            })
        }
        else if(fieldName === "vitality"){
            getAttrs(["might"], (vals) => {
                setAttrs({
                    inventory_slots_max: 20 + parseInt(val)+parseInt(vals["might"])
                })
            })
        }
    })
})
//********* VALIDATE UNSIGNED NUMBER VALUES ON CHANGE (FOR FIREFOX BROWSER) **********/
on(unsigned.map(field => "change:" + field).join(" "), (eventinfo) => {
    const fieldName = eventinfo.sourceAttribute
    getAttrs([fieldName], (values) => {
        let val = parseInt(values[fieldName])
        if(isNaN(val)) {
            setAttrs({
                [fieldName]: eventinfo.previousValue || 0
            })
        }
    })
})
//********* VALIDATE ALL NUMBER VALUES ON CHARACTER SHEET OPEN **********/
on("sheet:opened", (eventinfo) => {
    signed.forEach((fieldName) => {
        getAttrs([fieldName], (values) => {
            let val = parseInt(values[fieldName])
            if(isNaN(val)) {
                setAttrs({
                [fieldName]: "+0"
                })
            }
            else if(val < -3) {
                setAttrs({
                [fieldName]: "-3"
                })
            }
            else if(val > 3) {
                setAttrs({
                [fieldName]: "+3"
                })
            }
            else if(val >= 0) {
                setAttrs({
                    [fieldName]: "+" + val
                })
            }
            else {
                setAttrs({
                    [fieldName]: val
                })
            }
        })
    })
    unsigned.forEach((fieldName) => {
        getAttrs([fieldName], (values) => {
            if(values[fieldName] === "") {
                if(fieldName === "inventory_slots_max") {
                    setAttrs({
                        [fieldName]: 20
                    })
                }
                else if (fieldName === "courage_max" || fieldName === "courage") {
                    setAttrs({
                        [fieldName]: 12
                    })
                }
                else if (fieldName === "quest_pts") {
                    setAttrs({
                        [fieldName]: 3
                    })
                }
                else {
                    setAttrs({
                        [fieldName]: 0
                    })
                }
            }
        })
    })
    //********* SET DEFAULT VALUE FOR DREAD **********/
    getAttrs(["dread"], (values) => {
        const val = values["dread"]
        if(val === undefined || val === "") {
            setAttrs({
                dread: "1d4"
            })
        }
    })
})
//********* CLASS CHANGE HANDLER **********/
on("change:class", (eventinfo) => {
    let key = eventinfo.newValue
    if(key === getTranslationByKey('bard')) {
        key = "bard";
    }
    else if(key === getTranslationByKey('dungeoneer')) {
        key = "dungeoneer";
    }
    else if(key === getTranslationByKey('gnome')) {
        key = "gnome";
    }
    else if(key === getTranslationByKey('knight-errant')) {
        key = "knight-errant";
    }
    else if(key === getTranslationByKey('loyal-chum')) {
        key = "loyal-chum";
    }
    else if(key === getTranslationByKey('rascal')) {
        key = "rascal";
    }
    
    getAttrs(["hidden_class", "vim"], (values) => {
        // Same class - no change needed
        if(values["hidden_class"] === key) return

        const v = parseInt(values["vim"]) 
        let dread = "1d4"
        let courage_max = 12+v
        
        if(key === "bard") {dread = "1d4"; courage_max = v+12; }
        else if(key === "dungeoneer") { dread = "1d6"; courage_max = v+13; }
        else if(key === "gnome") { dread = "1d8"; courage_max = v+14; }
        else if(key === "knight-errant") { dread = "1d10"; courage_max = v+15; }
        else if(key === "loyal-chum") { dread = "1d6"; courage_max = v+13; }
        else if(key === "rascal") { dread = "1d8"; courage_max = v+14; }
        else return

        setAttrs({
            dread: dread,
            courage_max: courage_max,
            courage: courage_max,
            hidden_class: key
        })
    })
})

//********* SET ROLL EVENT LISTENERS *********/
regular.forEach((s) => {
    on(`clicked:${s}`, () => {
        getAttrs([s], values => {
            let v = parseInt(values[s])
            if(v >= 0) v = "+" + v

            const strCheckType = getTranslationByKey('check-type')
            const strCheckStandard = getTranslationByKey('check-standard')
            const strCheckAdvantage = getTranslationByKey('check-advantage')
            const strCheckDisadvantage = getTranslationByKey('check-disadvantage')
            const strModifier = getTranslationByKey('modifier')

            startRoll(`&{template:check} {{character=@{character_name}}} {{name=${s}}} {{roll=[[?{${strCheckType}|${strCheckStandard}, 1d12|${strCheckAdvantage}, 2d12kh1|${strCheckDisadvantage}, 2d12kl1}?{${strModifier}|${v}}]]}}`, (checkResult) => {
                let modifier = checkResult.results.roll.dice[0]
                let expression = checkResult.results.roll.expression
                if(expression.startsWith("2d12kl1")){
                    if(modifier > checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
                }
                else if (expression.startsWith("2d12kh1")){
                    if(modifier < checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
                }
                modifier = checkResult.results.roll.result - modifier
                let computedResult = checkResult.results.roll.result
                if(modifier > 3)
                    computedResult = computedResult - modifier + 3
                else if(modifier < -3)
                    computedResult = computedResult - modifier - 3
                finishRoll(checkResult.rollId, {
                    roll: computedResult
                })
            })
        })
    })
})

//********* ATTACK **********/
on("clicked:attack", () => {
    getAttrs(["attack", "last_opponent_defense"], values => {
        let v = parseInt(values["attack"])
        if(v >= 0) v = "+" + v
        let lastDefense = values["last_opponent_defense"] || "+0"

        const strCheckType = getTranslationByKey('check-type')
        const strCheckStandard = getTranslationByKey('check-standard')
        const strCheckAdvantage = getTranslationByKey('check-advantage')
        const strCheckDisadvantage = getTranslationByKey('check-disadvantage')
        const strModifier = getTranslationByKey('modifier')
        const strDefense = getTranslationByKey("opponents-defense")

        startRoll(`&{template:attack} {{character=@{character_name}}} {{random_index=[[[{1d6}]]]}} {{name=attack}} {{damage=[[@{dread}]]}} {{roll=[[?{${strCheckType}|${strCheckStandard}, 1d12|${strCheckAdvantage}, 2d12kh1|${strCheckDisadvantage}, 2d12kl1}?{${strModifier}|${v}}?{${strDefense}|${lastDefense}}]]}} {{hint=[[0]]}}`, (checkResult) => {
            let modifier = checkResult.results.roll.dice[0]
            let expression = checkResult.results.roll.expression
            let expressionParts = expression.split(/([+-])/)
            lastDefense = (expressionParts[expressionParts.length - 2]+expressionParts[expressionParts.length - 1])
            setAttrs({
                last_opponent_defense: lastDefense,
            })
            if(expression.startsWith("2d12kl1")){
                if(modifier > checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
            }
            else if (expression.startsWith("2d12kh1")){
                if(modifier < checkResult.results.roll.dice[1]) modifier = checkResult.results.roll.dice[1]
            }
            modifier = checkResult.results.roll.result - modifier
            let computedResult = checkResult.results.roll.result
            if(modifier > 3)
                computedResult = computedResult - modifier + 3
            else if(modifier < -3)
                computedResult = computedResult - modifier - 3
            let computedDamage = checkResult.results.damage.result
            if(computedResult > 11) {
                computedDamage *= 2
            }
            finishRoll(checkResult.rollId, {
                roll: computedResult,
                damage: computedDamage
            })
        })
    })
})
</script>