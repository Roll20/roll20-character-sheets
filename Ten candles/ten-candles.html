<!----------------------->			
<!-- [CHARACTER SHEET] -->
<!----------------------->	
<input type="hidden" name="attr_conflict" value="">
<button type="action" name="act_conflict-action" data-i18n-title="conflict_dice" title="Conflict Dice" class="hidden"></button>
<div class=main>
	<!-- Logo -->
	<div class="logo">
		<img class="img" src="https://raw.githubusercontent.com/ctotone/JdR/main/Ten%20candles/img/logo_official_dark.png"/>
		<button type="roll" name="roll_conflict" value="@{conflict}" data-i18n-title="conflict_dice" title="Conflict Dice" class="d6"></button>
	</div>
	<br>

	<!-- TAB -->
	<input type="radio" name="attr_sheet-type" value="1" class="onglconcept" checked /><span data-i18n="TAB_concept">Concept</span>
	<input type="radio" name="attr_sheet-type" value="0" class="onglcard" /><span data-i18n="TAB_card">Card</span>
	<input type="radio" name="attr_sheet-type" value="2" class="onglrule" /><span data-i18n="TAB_rule">Rules</span>
	<input type="radio" name="attr_sheet-type" value="3" class="onglgm" /><span data-i18n="TAB_gm">GM Sheet</span>
			
			
	<!-- Carte Tab -->			
	<div class="card">
		<div class="section-profile">
			<div class="profile-text">
				<p></p>
				<input type="hidden" class="vertu_check" name="attr_vertu_check" value='0'>
				<p><input type="checkbox" name="attr_vertu_check" data-i18n-title="burn" title="Check when the card is burned"><span class="receiver-vertu_check" data-i18n="virtue">Virtue : </span><input class="virtue" type="text" name="attr_vertu"><input class="virtue_rank" type="text" name="attr_vertu_rank"></p>
				<input type="hidden" class="vice_check" name="attr_vice_check" value='0'>
				<p><input type="checkbox" name="attr_vice_check" data-i18n-title="burn" title="Check when the card is burned"><span class="receiver-vice_check" data-i18n="vice">Vice : </span><input class="vice" type="text" name="attr_vice"><input class="vice_rank" type="text" name="attr_vice_rank"></p>
				<input type="hidden" class="moment_check" name="attr_moment_check" value='0'>
				<p><input type="checkbox" name="attr_moment_check" data-i18n-title="burn" title="Check when the card is burned"><span class="receiver-moment_check" data-i18n="moment">Moment : "I will find hope..."</p>
				<p><button type="roll" name="roll_Hope" data-i18n-title="hope_dice" title="Hope Dice" value="&{template:tencandles-hope} {{title=^{roll_hope_dice_title}}} {{name=@{character_name}}}{{hope=[[1d6>5]]}}" class="dicehope"></button><input class="card1" type="text" name="attr_moment"></textarea></span><input class="moment_rank" type="text" name="attr_moment_rank"></p>
				<input type="hidden" class="extremite_check" name="attr_extremite_check" value='0'>
				<p><input type="checkbox" name="attr_extremite_check" data-i18n-title="burn" title="Check when the card is burned"><span class="receiver-extremite_check" data-i18n="brink">Brink : "Someone seen you..."</span></p>
				<p><input class="card2" type="text" name="attr_extremite"></p>				
				<p><input class="card2" type="text" name="attr_extremite1"></p>
			</div>
		</div>
	</div>
	<!-- Concept Tab -->
	<div class="concept">
		<div class="section-abilities">	
			<div class="profile-text">
				<p></p>
				<p><span data-i18n="name">Name : </span><input class="name" type="text" name="attr_character_name"></p>
				<p><span data-i18n="look">Look : </span><input class="look" type="text" name="attr_apparence"></p>
				<p><span data-i18n="age">Age : </span><input class="age" type="text" name="attr_age"></p>
				<p></p>
				<p><span data-i18n="background">Background</span></p>
				<p><textarea class="notes" name="attr_bg"></textarea></p>
			</div>
		</div>

	</div>

	<!-- Rules Tab -->
	<div class="rule">
		<div class="section-regle">	
			<div class="profile-text">
				<p><span data-i18n="vice_virtue">Vice and Virtue : Once the card is burned, allows you to reroll all 1s.</span></p>
				<p></p>
				<p><span data-i18n="moment_rule">Moment : Burn this card and resolve a conflict roll. If successful, gain your hope dice.</span></p>
				<p></p>
				<p><span data-i18n="brink_rule">Brink : Reroll all the dice. Keep the card in case of success, but on a failure, burn the card and lose your Hope dice.</span></p>
			</div>
		</div>
	</div>

	<!-- GM Tab -->
	<div class="gm">
		<div class="section-GM">	
			<div class="profile-text">
						<div class="border-character-up"></div>
						<div class="border-character">
							<br>
							<p><span data-i18n="player_name">Character's name</span><input class="card" type="text" name="attr_player1_name"></p>
							<p><input type="checkbox" name="attr_moment_player1_check"><span data-i18n="moment_gm">Moment : </span><input class="card" type="text" name="attr_player1_moment"></p>
							<p><input type="checkbox" name="attr_extremite_player1_check"><span data-i18n="brink_gm">Brink : </span><input class="card" type="text" name="attr_player1_extremite"></p>
						</div>
						<div class="border-character">
							<br>
							<p><span data-i18n="player_name">Character's name</span><input class="card" type="text" name="attr_player2_name"></p>
							<p><input type="checkbox" name="attr_moment_player2_check"><span data-i18n="moment_gm">Moment : </span><input class="card" type="text" name="attr_player2_moment"></p>
							<p><input type="checkbox" name="attr_extremite_player2_check"><span data-i18n="brink_gm">Brink : </span><input class="card" type="text" name="attr_player2_extremite"></p>
						</div>
						<div class="border-character">
							<br>
							<p><span data-i18n="player_name">Character's name</span><input class="card" type="text" name="attr_player3_name"></p>
							<p><input type="checkbox" name="attr_moment_player3_check"><span data-i18n="moment_gm">Moment : </span><input class="card" type="text" name="attr_player3_moment"></p>
							<p><input type="checkbox" name="attr_extremite_player3_check"><span data-i18n="brink_gm">Brink : </span><input class="card" type="text" name="attr_player3_extremite"></p>
						</div>
					<fieldset class="repeating_player-gm">
						<div class="border-character">
							<br>
							<p><span data-i18n="player_name">Character's name</span><input class="card" type="text" name="attr_namegm"></p>
							<p><input type="checkbox" name="attr_moment_check_rep"><span data-i18n="moment_gm">Moment : </span><input class="card" type="text" name="attr_moment_rep"></p>
							<p><input type="checkbox" name="attr_extremite_check_rep"><span data-i18n="brink_gm">Brink : </span><input class="card" type="text" name="attr_extremite_rep"></p>
						</div>
					</fieldset>
			</div>
		</div>
	</div>
</div>
			
			
<!---------------------->			
<!-- [ROLL TEMPLATES] -->
<!---------------------->	
<!-- Conflict Dice -->
<rolltemplate class="sheet-rolltemplate-tencandles">
	<div class="sheet-ecart-top"></div>
	<div class="sheet-container sheet-color-{{color}}">
		<div class="sheet-header">
		{{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
		{{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
		</div>
		<div class="sheet-content">
			{{#rollWasCrit() roll}}
				{{#^rollTotal() computed::low 0}}
					<div class="reussite" data-i18n="success">Success</div>
					<div class="reussite-result">{{roll}}</div>
					{{#rollTotal() computed::low 1}}
					<div class="echec" data-i18n="lost_dice" style="border-radius: 0px 0px 0px 10px;">Lost Dice</div>
					{{/rollTotal() computed::low 1}}
					{{#^rollTotal() computed::low 1}}
					<div class="echec" data-i18n="lost_dices" style="border-radius: 0px 0px 0px 10px;">Lost Dices</div>
					{{/^rollTotal() computed::low 1}}
					<div class="echec-result-lost" style="border-radius: 0px 0px 10px 0px;">{{computed::low}}</div>
				{{/^rollTotal() computed::low 0}}

				{{#rollTotal() computed::low 0}}
					<div class="reussite" data-i18n="success">Success</div>
					<div class="reussite-result">{{roll}}</div>
				{{/rollTotal() computed::low 0}}
			{{/rollWasCrit() roll}}
			{{#^rollWasCrit() roll}}
				{{#^rollTotal() computed::low 0}}
					<div class="echec" data-i18n="failure">Failure</div>
					<div class="echec-result">{{roll}}</div>
					{{#rollTotal() computed::low 1}}
					<div class="echec" data-i18n="lost_dice" style="border-radius: 0px 0px 0px 10px;">Lost Dice</div>
					{{/rollTotal() computed::low 1}}
					{{#^rollTotal() computed::low 1}}
					<div class="echec" data-i18n="lost_dices" style="border-radius: 0px 0px 0px 10px;">Lost Dices</div>
					{{/^rollTotal() computed::low 1}}
					<div class="echec-result-lost" style="border-radius: 0px 0px 10px 0px;">{{computed::low}}</div>
				{{/^rollTotal() computed::low 0}}
				{{#rollTotal() computed::low 0}}
					<div class="echec" data-i18n="failure">Failure</div>
					<div class="echec-result">{{roll}}</div>
				{{/rollTotal() computed::low 0}}  
			{{/^rollWasCrit() roll}}
			{{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}  
		</div>
  </div>
</rolltemplate>

<!-- Hope Dice -->
<rolltemplate class="sheet-rolltemplate-tencandles-hope">
	<div class="sheet-ecart-top"></div>
		<div class="sheet-container sheet-color-{{color}}">
			<div class="sheet-header">
			{{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
			{{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
			</div>
			<div class="sheet-content">
			{{#allprops() title subtitle desc}}
			{{#rollGreater() hope 0}}
			<div class="sheet-key" data-i18n="success">Success</div>
			<div class="sheet-value">{{value}}</div>
			{{/rollGreater() hope 0}}
			{{/allprops() title subtitle desc}}
			{{#allprops() title subtitle desc}}
			{{#^rollGreater() hope 0}}
			<div class="sheet-key-failure" data-i18n="failure">Failure</div>
			<div class="sheet-value">{{value}}</div>
			{{/^rollGreater() hope 0}}
			{{/allprops() title subtitle desc}}
			{{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
			</div>
		</div>
</rolltemplate>

<script type="text/worker">
    on('clicked:conflict-action', (info) => {
        startRoll("&{template:tencandles} {{title=^{roll_d6_title}}} {{name=@{character_name}}} {{roll=[[@{rollmodifier}d6s=6]]}} {{high=[[0]]}} {{low=[[0]]}}", (diceroll) => {
            const total = diceroll.results.roll.result
            const dice = diceroll.results.roll.dice; //This will be an array of the values rolled on all the dice
            let total6s = 0;
            let total1s = 0;
            for(let i = 0; i < dice.length; i++) {
                total6s += dice[i] > 5 ? 1 : 0;
                total1s += dice[i] < 2 ? 1 : 0;
            }
            finishRoll(
                diceroll.rollId, // this is where you save the computed values into something that can be passed to rolltemplates.
                {
                    roll: total,
                    high: total6s,
                    low: total1s
                }
            );
        });
    });

	on("sheet:opened", function(eventInfo){
        setAttrs({
            rollmodifier: "?{" + getTranslationByKey("how_many_dice") + "|1}",
        });
    });	
	

	on("sheet:opened change:character_name", function(eventInfo) {
		getAttrs(["character_name", "conflict"], function(v) {
			var attrsToChange = {};
			attrsToChange["conflict"] = "%{" + v["character_name"] + "|conflict-action}";
			setAttrs(attrsToChange);
		});
	});
</script>
