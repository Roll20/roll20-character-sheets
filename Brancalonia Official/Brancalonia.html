
<!-- PC-->
<input name="attr_version" type="hidden" value="4.2"/>
<input name="attr_appliedUpdates" type="hidden" value=""/>
<input name="attr_monster_confirm_flag" type="hidden" value=""/>
<input name="attr_mancer_confirm_flag" type="hidden" value=""/>
<input name="attr_d20" type="hidden" value="1d20"/>
<input name="attr_level" type="hidden" value="1"/>
<input name="attr_pb" type="hidden" value="2"/>
<input name="attr_pbd_safe" type="hidden" value=""/>
<input name="attr_jack" type="hidden" value="1"/>
<input name="attr_jack_attr" type="hidden" value=""/>
<input name="attr_jack_bonus" type="hidden" value=""/>
<input name="attr_passive_wisdom" type="hidden" value="10"/>
<input name="attr_hitdie_final" type="hidden" value=""/>
<input name="attr_globalsavingthrowbonus" type="hidden" value=""/>
<input name="attr_death_save_bonus" type="hidden" value="0"/>
<input name="attr_initiative_bonus" type="hidden" value="0"/>
<input name="attr_spell_save_dc" type="hidden" value="0"/>
<input name="attr_spell_attack_bonus" type="hidden" value="0"/>
<input name="attr_spell_attack_mod" type="hidden" value="0"/>
<input name="attr_npc_legendary_actions_desc" type="hidden" value="The creature can take 3 legendary actions, choosing from the options below. Only one legendary option can be used at a time and only at the end of another creature's turn. The creature regains spent legendary actions at the start of its turn."/>
<input name="attr_global_damage_mod_crit" type="hidden" value="0"/>
<input name="attr_global_damage_mod_roll" type="hidden" value="0"/>
<input name="attr_global_damage_mod_type" type="hidden" value=""/>
<input name="attr_global_attack_mod" type="hidden" value=""/>
<input name="attr_global_save_mod" type="hidden" value=""/>
<input name="attr_global_skill_mod" type="hidden" value=""/>
<input name="attr_exhaustion_1" type="hidden" value=""/>
<input name="attr_exhaustion_2" type="hidden" value=""/>
<input name="attr_exhaustion_3" type="hidden" value=""/>
<input name="attr_exhaustion_4" type="hidden" value=""/>
<input name="attr_exhaustion_5" type="hidden" value=""/>
<input name="attr_exhaustion_6" type="hidden" value=""/>
<input name="attr_strength_mod" type="hidden" value="0"/>
<input name="attr_dexterity_mod" type="hidden" value="0"/>
<input name="attr_constitution_mod" type="hidden" value="0"/>
<input name="attr_intelligence_mod" type="hidden" value="0"/>
<input name="attr_wisdom_mod" type="hidden" value="0"/>
<input name="attr_charisma_mod" type="hidden" value="0"/>
<input name="attr_honor_mod" type="hidden" value="0"/>
<input name="attr_sanity_mod" type="hidden" value="0"/>
<input name="attr_strength_save_bonus" type="hidden" value="0"/>
<input name="attr_dexterity_save_bonus" type="hidden" value="0"/>
<input name="attr_constitution_save_bonus" type="hidden" value="0"/>
<input name="attr_intelligence_save_bonus" type="hidden" value="0"/>
<input name="attr_wisdom_save_bonus" type="hidden" value="0"/>
<input name="attr_charisma_save_bonus" type="hidden" value="0"/>
<input name="attr_honor_save_bonus" type="hidden" value="0"/>
<input name="attr_sanity_save_bonus" type="hidden" value="0"/>
<input name="attr_strength_maximum" type="hidden" value="20"/>
<input name="attr_dexterity_maximum" type="hidden" value="20"/>
<input name="attr_constitution_maximum" type="hidden" value="20"/>
<input name="attr_intelligence_maximum" type="hidden" value="20"/>
<input name="attr_wisdom_maximum" type="hidden" value="20"/>
<input name="attr_charisma_maximum" type="hidden" value="20"/>
<input name="attr_honor_maximum" type="hidden" value="20"/>
<input name="attr_sanity_maximum" type="hidden" value="20"/>
<input name="attr_acrobatics_bonus" type="hidden" value="0"/>
<input name="attr_animal_handling_bonus" type="hidden" value="0"/>
<input name="attr_arcana_bonus" type="hidden" value="0"/>
<input name="attr_athletics_bonus" type="hidden" value="0"/>
<input name="attr_deception_bonus" type="hidden" value="0"/>
<input name="attr_history_bonus" type="hidden" value="0"/>
<input name="attr_insight_bonus" type="hidden" value="0"/>
<input name="attr_intimidation_bonus" type="hidden" value="0"/>
<input name="attr_investigation_bonus" type="hidden" value="0"/>
<input name="attr_medicine_bonus" type="hidden" value="0"/>
<input name="attr_nature_bonus" type="hidden" value="0"/>
<input name="attr_perception_bonus" type="hidden" value="0"/>
<input name="attr_performance_bonus" type="hidden" value="0"/>
<input name="attr_persuasion_bonus" type="hidden" value="0"/>
<input name="attr_religion_bonus" type="hidden" value="0"/>
<input name="attr_sleight_of_hand_bonus" type="hidden" value="0"/>
<input name="attr_stealth_bonus" type="hidden" value="0"/>
<input name="attr_survival_bonus" type="hidden" value="0"/>
<input name="attr_lvl1_slots_total" type="hidden" value="0"/>
<input name="attr_lvl2_slots_total" type="hidden" value="0"/>
<input name="attr_lvl3_slots_total" type="hidden" value="0"/>
<input name="attr_lvl4_slots_total" type="hidden" value="0"/>
<input name="attr_lvl5_slots_total" type="hidden" value="0"/>
<input name="attr_lvl6_slots_total" type="hidden" value="0"/>
<input name="attr_lvl7_slots_total" type="hidden" value="0"/>
<input name="attr_lvl8_slots_total" type="hidden" value="0"/>
<input name="attr_lvl9_slots_total" type="hidden" value="0"/>
<input name="attr_l1mancer_status" type="hidden" value=""/>
<input name="attr_lpmancer_status" type="hidden" value=""/>
<input name="attr_queryadvantage" type="hidden" value=""/>
<div class="compendium-drop-target monsters">
  <input class="npc_toggle" name="attr_npc" type="hidden" value="0"/>
  <input class="npcspellcastingflag" name="attr_npcspellcastingflag" type="hidden"/>
  <input class="toggleflag" name="attr_rtype" type="hidden"/>
  <input class="toggleflag" name="attr_confirm" type="hidden"/>
  <input class="toggleflag" name="attr_cancel" type="hidden"/>
  <input accept="Category" name="attr_drop_category" type="hidden"/>
  <input accept="Name" name="attr_drop_name" type="hidden"/>
  <input accept="data" name="attr_drop_data" type="hidden"/>
  <input accept="Content" name="attr_drop_content" type="hidden"/>
  <!-- Drag and Drop Warning-->
  <input class="monster_confirm_flag" name="attr_monster_confirm_flag" type="hidden"/>
  <div class="dialog dialog--confirmnpc">
    <div class="dialog__wrapper">
      <div class="dialog__explain"><span data-i18n="replace-sheet-with"></span><span class="dialog__newname" name="attr_drop_name"></span></div>
      <div class="dialog__buttonrow">
        <button class="dialog__button" data-i18n="Confirm" name="act_confirm_npc" type="action"></button>
        <button class="dialog__button" data-i18n="Reject" name="act_reject_npc" type="action"></button>
      </div>
    </div>
  </div>
  <div class="dialog dialog--warning">
    <div class="dialog__wrapper">
      <div class="dialog__explain" data-i18n="accept-compendium-drop"></div>
    </div>
  </div>
  <div class="container npc">
    <input class="npc__flag--options" type="hidden" name="attr_npc_options-flag" value="on"/>
    <input class="npc_ui_flags" type="hidden" name="attr_ui_flags" value=""/>
    <div class="options npc__options">
      <div class="options__row--title"><span data-i18n="npc-options-u">NPC OPTIONS</span></div>
      <div class="options__row"><span data-i18n="name-u">NAME</span>
        <input type="text" name="attr_npc_name"/>
      </div>
      <div class="options__row"><span data-i18n="npc-type-u">NPC TYPE</span>
        <input type="text" name="attr_npc_type" placeholder="Medium fiend, any evil alignment" data-i18n-placeholder="npc-type-place"/>
      </div>
      <div class="options__row"><span data-i18n="armor-class-u">ARMOR CLASS</span>
        <input type="text" name="attr_npc_ac" placeholder="10"/><span data-i18n="type-u">TYPE</span>
        <input type="text" name="attr_npc_actype" placeholder="scale mail" data-i18n-placeholder="npc-armor-place" value=""/>
      </div>
      <div class="options__row"><span data-i18n="hit-points-u">HIT POINTS</span>
        <input type="text" name="attr_hp_max" placeholder="82"/><span data-i18n="formula-u">FORMULA</span>
        <input type="text" name="attr_npc_hpformula" placeholder="11d8 + 33"/>
      </div>
      <div class="options__row"><span data-i18n="speed-u">SPEED</span>
        <input type="text" name="attr_npc_speed" placeholder="30 ft., fly 60ft." data-i18n-placeholder="npc-speed-place"/>
      </div>
      <div class="spacer"></div>
      <div class="options__row--title"><span data-i18n="attributes-u">ATTRIBUTES</span></div>
      <div class="options__row"><span data-i18n="str-u">STR</span>
            <input type="text" name="attr_strength_base" value="10"/><span data-i18n="dex-u">DEX</span>
            <input type="text" name="attr_dexterity_base" value="10"/><span data-i18n="con-u">CON</span>
            <input type="text" name="attr_constitution_base" value="10"/><span data-i18n="int-u">INT</span>
            <input type="text" name="attr_intelligence_base" value="10"/><span data-i18n="wis-u">WIS</span>
            <input type="text" name="attr_wisdom_base" value="10"/><span data-i18n="cha-u">CHA</span>
            <input type="text" name="attr_charisma_base" value="10"/>
      </div>
      <div class="spacer"></div>
      <div class="options__row--title"><span data-i18n="saves-u">SAVES</span></div>
      <div class="options__row"><span data-i18n="str-u">STR</span>
            <input type="text" name="attr_npc_str_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_str_save" value="@{strength_mod}"/><span data-i18n="dex-u">DEX</span>
            <input type="text" name="attr_npc_dex_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_dex_save" value="@{dexterity_mod}"/><span data-i18n="con-u">CON</span>
            <input type="text" name="attr_npc_con_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_con_save" value="@{constitution_mod}"/><span data-i18n="int-u">INT</span>
            <input type="text" name="attr_npc_int_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_int_save" value="@{intelligence_mod}"/><span data-i18n="wis-u">WIS</span>
            <input type="text" name="attr_npc_wis_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_wis_save" value="@{wisdom_mod}"/><span data-i18n="cha-u">CHA</span>
            <input type="text" name="attr_npc_cha_save_base" placeholder="0"/>
            <input type="hidden" name="attr_npc_cha_save" value="@{charisma_mod}"/>
      </div>
      <div class="spacer"></div>
      <div class="options__row--title"><span data-i18n="skills-u">SKILLS</span></div>
      <div class="options__row skills-list" data-i18n-list="skills-list">
        <div class="col">
              <div class="options__row options__row--noborder" data-i18n-list-item="acrobatics"><span class="options__flex" data-i18n="acrobatics-u">ACROBATICS</span>
                <input class="options__flex--2" type="text" name="attr_npc_acrobatics_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_acrobatics" value="@{dexterity_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="animal_handling"><span class="options__flex" data-i18n="animal_handling-u">ANIMAL HANDLING</span>
                <input class="options__flex--2" type="text" name="attr_npc_animal_handling_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_animal_handling" value="@{wisdom_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="arcana"><span class="options__flex" data-i18n="arcana-u">ARCANA</span>
                <input class="options__flex--2" type="text" name="attr_npc_arcana_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_arcana" value="@{intelligence_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="athletics"><span class="options__flex" data-i18n="athletics-u">ATHLETICS</span>
                <input class="options__flex--2" type="text" name="attr_npc_athletics_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_athletics" value="@{strength_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="deception"><span class="options__flex" data-i18n="deception-u">DECEPTION</span>
                <input class="options__flex--2" type="text" name="attr_npc_deception_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_deception" value="@{charisma_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="history"><span class="options__flex" data-i18n="history-u">HISTORY</span>
                <input class="options__flex--2" type="text" name="attr_npc_history_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_history" value="@{intelligence_mod}"/>
              </div>
        </div>
        <div class="col" data-i18n-list-sublist="">
              <div class="options__row options__row--noborder" data-i18n-list-item="insight"><span class="options__flex" data-i18n="insight-u">INSIGHT</span>
                <input class="options__flex--2" type="text" name="attr_npc_insight_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_insight" value="@{wisdom_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="intimidation"><span class="options__flex" data-i18n="intimidation-u">INTIMIDATION</span>
                <input class="options__flex--2" type="text" name="attr_npc_intimidation_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_intimidation" value="@{charisma_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="investigation"><span class="options__flex" data-i18n="investigation-u">INVESTIGATION</span>
                <input class="options__flex--2" type="text" name="attr_npc_investigation_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_investigation" value="@{intelligence_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="medicine"><span class="options__flex" data-i18n="medicine-u">MEDICINE</span>
                <input class="options__flex--2" type="text" name="attr_npc_medicine_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_medicine" value="@{wisdom_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="nature"><span class="options__flex" data-i18n="nature-u">NATURE</span>
                <input class="options__flex--2" type="text" name="attr_npc_nature_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_nature" value="@{intelligence_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="perception"><span class="options__flex" data-i18n="perception-u">PERCEPTION</span>
                <input class="options__flex--2" type="text" name="attr_npc_perception_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_perception" value="@{wisdom_mod}"/>
              </div>
        </div>
        <div class="col" data-i18n-list-sublist="">
              <div class="options__row options__row--noborder" data-i18n-list-item="performance"><span class="options__flex" data-i18n="performance-u">PERFORMANCE</span>
                <input class="options__flex--2" type="text" name="attr_npc_performance_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_performance" value="@{charisma_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="persuasion"><span class="options__flex" data-i18n="persuasion-u">PERSUASION</span>
                <input class="options__flex--2" type="text" name="attr_npc_persuasion_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_persuasion" value="@{charisma_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="religion"><span class="options__flex" data-i18n="religion-u">RELIGION</span>
                <input class="options__flex--2" type="text" name="attr_npc_religion_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_religion" value="@{intelligence_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="sleight_of_hand"><span class="options__flex" data-i18n="sleight_of_hand-u">SLEIGHT_OF_HAND</span>
                <input class="options__flex--2" type="text" name="attr_npc_sleight_of_hand_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_sleight_of_hand" value="@{dexterity_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="stealth"><span class="options__flex" data-i18n="stealth-u">STEALTH</span>
                <input class="options__flex--2" type="text" name="attr_npc_stealth_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_stealth" value="@{dexterity_mod}"/>
              </div>
              <div class="options__row options__row--noborder" data-i18n-list-item="survival"><span class="options__flex" data-i18n="survival-u">SURVIVAL</span>
                <input class="options__flex--2" type="text" name="attr_npc_survival_base" placeholder="0"/>
                <input type="hidden" name="attr_npc_survival" value="@{wisdom_mod}"/>
              </div>
        </div>
      </div>
      <div class="options__row options__row--noborder"><span data-i18n="damage-vuln-u">DAMAGE VULNERABILITIES</span>
        <input type="text" name="attr_npc_vulnerabilities" placeholder="fire" data-i18n-placeholder="npc-dmg-vuln-place"/>
      </div>
      <div class="options__row options__row--noborder"><span data-i18n="damage-res-u">DAMAGE RESISTANCES</span>
        <input type="text" name="attr_npc_resistances" placeholder="cold" data-i18n-placeholder="npc-dmg-res-place"/>
      </div>
      <div class="options__row options__row--noborder"><span data-i18n="damage-imm-u">DAMAGE IMMUNITIES</span>
        <input type="text" name="attr_npc_immunities" placeholder="lighting, thunder" data-i18n-placeholder="npc-dmg-imm-place"/>
      </div>
      <div class="options__row options__row--noborder"><span data-i18n="cond-imm-u">CONDITION IMMUNITIES</span>
        <input type="text" name="attr_npc_condition_immunities" placeholder="charmed" data-i18n-placeholder="npc-cond-imm-place"/>
      </div>
      <div class="options__row"><span data-i18n="senses-u">SENSES</span>
        <input type="text" name="attr_npc_senses" placeholder="darkvision 120ft., passive Perception 16" data-i18n-placeholder="npc-senses-place"/>
      </div>
      <div class="options__row"><span data-i18n="langs-u">LANGUAGES</span>
        <input type="text" name="attr_npc_languages" placeholder="Abyssal, Common, Infernal" value="—" data-i18n-placeholder="npc-langs-place"/>
      </div>
      <div class="options__row"><span data-i18n="challenge-u">CHALLENGE</span>
        <input type="text" name="attr_npc_challenge" placeholder="1"/><span data-i18n="xp-u">XP</span>
        <input type="text" name="attr_npc_xp" placeholder="250"/>
      </div>
      <div class="options__row"><span data-i18n="token_size-u">TOKEN SIZE</span>
        <input name="attr_token_size" value="1" placeholder="1"/>
      </div>
      <input class="npc__flag--spellcasting" type="hidden" name="attr_npcspellcastingflag" value="1"/>
      <div class="options__row">
        <input class="options__flex--1" type="checkbox" name="attr_npcspellcastingflag" value="1"/><span class="options__flex--9" data-i18n="spellcast-npc-u">SPELLCASTING NPC<span data-i18n="spell-ability-u">SPELLCASTING ABILITY</span>
          <select name="attr_spellcasting_ability">
            <option value="0*" data-i18n="none-u">NONE</option>
            <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
            <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
            <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
            <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
            <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
            <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
          </select></span>
      </div>
      <div class="options__row npc__hidden--spellcasting">   <span data-i18n="glob-atk-mod:-u">GLOBAL MAGIC ATTACK MODIFIER:</span>
        <input type="text" name="attr_globalmagicmod" placeholder="0" value="0"/><span data-i18n="magic-caster-lvl:-u">MAGIC CASTER LEVEL:</span>
        <input type="text" name="attr_caster_level"/><span data-i18n="spell_dc_mod:-u">SPELL SAVE DC MOD:</span>
        <input type="text" name="attr_spell_dc_mod" placeholder="0" value="0"/>
      </div>
      <div class="options__row">
        <input class="options__flex--1" type="checkbox" name="attr_npcbonusactionsflag" value="1"/><span class="options__flex--4" data-i18n="has-bonusaction-u">HAS BONUS ACTIONS</span>
        <input class="options__flex--1" type="checkbox" name="attr_npcreactionsflag" value="1"/><span class="options__flex--4" data-i18n="has-reaction-u">HAS REACTIONS</span>
      </div>
      <div class="options__row"><span data-i18n="leg-actions:-u">LEGENDARY ACTIONS:</span>
        <input type="text" name="attr_npc_legendary_actions" value="0" placeholder="0"/>
      </div>
      <div class="options__row">
        <input type="checkbox" name="attr_npc_mythic_actions" value="1"/><span data-i18n="myt-actions:-u">MYTHIC ACTIONS:</span>
        <textarea class="mythic-rules" name="attr_npc_mythic_actions_desc" placeholder="Mythic Action Rules. This creature can use the options below..."></textarea>
      </div>
      <div class="options__row--title"><span data-i18n="gen-opts-u">GENERAL OPTIONS</span></div>
      <div class="options__row options__row--center">
        <input class="options__flex--1" type="checkbox" name="attr_npc" value="1"/><span class="options__flex--1" data-i18n="npc-u">NPC</span>
      </div>
      <div class="options__row"><span data-i18n="roll-queries:-u">ROLL QUERIES:</span>
        <select name="attr_rtype">
          <option value="{{always=1}} {{r2=[[@{d20}" data-i18n="always-adv">Always Roll Advantage</option>
          <option value="@{advantagetoggle}" data-i18n="adv-toggle">Advantage Toggle</option>
          <option value="@{queryadvantage}" data-i18n="query-adv">Query Advantage</option>
          <option value="{{normal=1}} {{r2=[[0d20" data-i18n="never-adv">Never Roll Advantage</option>
        </select><span data-i18n="whisp-rolls-gm:-u">WHISPER ROLLS TO GM:</span>
        <select name="attr_wtype">
          <option value="" data-i18n="never-whisper-roll">Never Whisper Rolls</option>
          <option value="@{whispertoggle}" data-i18n="toggle-roll-whisper">Whisper Toggle</option>
          <option value="?{Whisper?|Public Roll,|Whisper Roll,/w gm }" data-i18n="query-whisper-roll">Query Whisper</option>
          <option value="/w gm " data-i18n="always-whisper-roll">Always Whisper Rolls</option>
        </select>
      </div>
      <div class="options__row"><span data-i18n="auto-dmg-roll:-u">AUTO DAMAGE ROLL:</span>
        <select class="dtype" name="attr_dtype">
          <option value="pick" data-i18n="never-dmg">Don&apos;t Auto Roll Damage</option>
          <option value="full" data-i18n="always-dmg">Auto Roll Damage &amp; Crit</option>
        </select><span data-i18n="npc-name-in-rolls:-u">NPC NAME IN ROLLS:</span>
        <select name="attr_npc_name_flag">
          <option value="{{name=@{npc_name}}}" data-i18n="show">Show</option>
          <option value="0" data-i18n="hide">Hide</option>
        </select>
      </div>
      <div class="options__row options__row--center">
        <input class="options__flex--1" type="checkbox" name="attr_init_tiebreaker" value="@{dexterity}/100"/><span class="options__flex--4" data-i18n="add-dex-tiebreaker-u">ADD DEX TIEBREAKER TO INITIATIVE</span>
      </div>
    </div>
    <div class="npc__grid">
      <div class="npc__column">
        <div class="display npc__statblock">
          <div class="npc__settings">
            <input class="npc__flag--options" type="checkbox" name="attr_npc_options-flag" checked="checked"/><span>y</span>
          </div>
          <div class="npc__row options__title">
            <button type="roll" name="roll_npc_init" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{init}}} {{mod=[[[[@{initiative_bonus}]][DEX]]]}} {{r1=[[@{d20}+[[@{initiative_bonus}]][DEX] &{tracker}]]}} {{normal=1}} {{type=Initiative}}"><span class="npc__title" name="attr_npc_name"></span></button>
          </div>
          <div class="npc__row"><span class="npc__subtitle" name="attr_npc_type"></span></div>
          <hr class="npc__rule--thin"/>
          <div class="npc__row"><span class="npc__label" data-i18n="ac">Armor Class</span><span name="attr_npc_ac"></span>
            <input class="npc__flag--actype" type="hidden" name="attr_npc_actype" value=""/><span class="npc__ac-type" name="attr_npc_actype"></span>
          </div>
          <div class="npc__row"><span class="npc__label" data-i18n="hp">Hit Points</span><span name="attr_hp_max"></span>
            <button type="roll" name="roll_npc_hpformula" value="@{wtype}&{template:npc} {{type=Hit Points}} {{normal=1}} @{npc_name_flag} {{rname=^{hp}}} {{mod=@{npc_hpformula}}} {{r1=[[@{npc_hpformula}]]}} charname=@{character_name}"><span class="npc__hitpoints-formula" name="attr_npc_hpformula"></span></button>
          </div>
          <div class="npc__row"><span class="npc__label" data-i18n="speed">Speed</span><span name="attr_npc_speed"></span></div>
          <hr class="npc__rule--thick-top"/>
          <div class="npc__row npc__row--space-between">
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_str" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{strength}}} {{mod=[[[[@{strength_mod}]][STR]]]}} {{r1=[[@{d20}+[[@{strength_mod}]][STR]]]}} @{rtype}+[[@{strength_mod}]][STR]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="str-u">STR</span><span class="npc__attribute-score" name="attr_strength"></span><span>(</span><span class="npc__attribute-mod" name="attr_strength_mod"></span><span>)</span></button>
                </div>
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_dex" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{dexterity}}} {{mod=[[[[@{dexterity_mod}]][DEX]]]}} {{r1=[[@{d20}+[[@{dexterity_mod}]][DEX]]]}} @{rtype}+[[@{dexterity_mod}]][DEX]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="dex-u">DEX</span><span class="npc__attribute-score" name="attr_dexterity"></span><span>(</span><span class="npc__attribute-mod" name="attr_dexterity_mod"></span><span>)</span></button>
                </div>
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_con" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{constitution}}} {{mod=[[[[@{constitution_mod}]][CON]]]}} {{r1=[[@{d20}+[[@{constitution_mod}]][CON]]]}} @{rtype}+[[@{constitution_mod}]][CON]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="con-u">CON</span><span class="npc__attribute-score" name="attr_constitution"></span><span>(</span><span class="npc__attribute-mod" name="attr_constitution_mod"></span><span>)</span></button>
                </div>
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_int" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{intelligence}}} {{mod=[[[[@{intelligence_mod}]][INT]]]}} {{r1=[[@{d20}+[[@{intelligence_mod}]][INT]]]}} @{rtype}+[[@{intelligence_mod}]][INT]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="int-u">INT</span><span class="npc__attribute-score" name="attr_intelligence"></span><span>(</span><span class="npc__attribute-mod" name="attr_intelligence_mod"></span><span>)</span></button>
                </div>
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_wis" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{wisdom}}} {{mod=[[[[@{wisdom_mod}]][WIS]]]}} {{r1=[[@{d20}+[[@{wisdom_mod}]][WIS]]]}} @{rtype}+[[@{wisdom_mod}]][WIS]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="wis-u">WIS</span><span class="npc__attribute-score" name="attr_wisdom"></span><span>(</span><span class="npc__attribute-mod" name="attr_wisdom_mod"></span><span>)</span></button>
                </div>
                <div class="npc__attribute-container">
                  <button class="npc__attribute-button" type="roll" name="roll_npc_cha" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{charisma}}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{d20}+[[@{charisma_mod}]][CHA]]]}} @{rtype}+[[@{charisma_mod}]][CHA]]]}} {{type=Ability}}"><span class="npc__attribute-title" data-i18n="cha-u">CHA</span><span class="npc__attribute-score" name="attr_charisma"></span><span>(</span><span class="npc__attribute-mod" name="attr_charisma_mod"></span><span>)</span></button>
                </div>
          </div>
          <hr class="npc__rule--thick-bottom"/>
          <input class="npc__flag--next" type="hidden" name="attr_npc_saving_flag" value=""/>
          <div class="npc__row"><span class="npc__label" data-i18n="saving-throw">Saving Throws</span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_str_save"/>
                <button class="npc__save" type="roll" name="roll_npc_str_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{strength-save}}} {{mod=[[[[@{npc_str_save}]][STR SAVE]]]}} {{r1=[[@{d20}+[[@{npc_str_save}]][STR SAVE]]]}} @{rtype}+[[@{npc_str_save}]][STR SAVE]]]}} {{type=Save}}"><span data-i18n="str">Str</span><span class="stat" name="attr_npc_str_save"></span></button>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_dex_save"/>
                <button class="npc__save" type="roll" name="roll_npc_dex_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{dexterity-save}}} {{mod=[[[[@{npc_dex_save}]][DEX SAVE]]]}} {{r1=[[@{d20}+[[@{npc_dex_save}]][DEX SAVE]]]}} @{rtype}+[[@{npc_dex_save}]][DEX SAVE]]]}} {{type=Save}}"><span data-i18n="dex">Dex</span><span class="stat" name="attr_npc_dex_save"></span></button>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_con_save"/>
                <button class="npc__save" type="roll" name="roll_npc_con_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{constitution-save}}} {{mod=[[[[@{npc_con_save}]][CON SAVE]]]}} {{r1=[[@{d20}+[[@{npc_con_save}]][CON SAVE]]]}} @{rtype}+[[@{npc_con_save}]][CON SAVE]]]}} {{type=Save}}"><span data-i18n="con">Con</span><span class="stat" name="attr_npc_con_save"></span></button>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_int_save"/>
                <button class="npc__save" type="roll" name="roll_npc_int_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{intelligence-save}}} {{mod=[[[[@{npc_int_save}]][INT SAVE]]]}} {{r1=[[@{d20}+[[@{npc_int_save}]][INT SAVE]]]}} @{rtype}+[[@{npc_int_save}]][INT SAVE]]]}} {{type=Save}}"><span data-i18n="int">Int</span><span class="stat" name="attr_npc_int_save"></span></button>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_wis_save"/>
                <button class="npc__save" type="roll" name="roll_npc_wis_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{wisdom-save}}} {{mod=[[[[@{npc_wis_save}]][WIS SAVE]]]}} {{r1=[[@{d20}+[[@{npc_wis_save}]][WIS SAVE]]]}} @{rtype}+[[@{npc_wis_save}]][WIS SAVE]]]}} {{type=Save}}"><span data-i18n="wis">Wis</span><span class="stat" name="attr_npc_wis_save"></span></button>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_cha_save"/>
                <button class="npc__save" type="roll" name="roll_npc_cha_save" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{charisma-save}}} {{mod=[[[[@{npc_cha_save}]][CHA SAVE]]]}} {{r1=[[@{d20}+[[@{npc_cha_save}]][CHA SAVE]]]}} @{rtype}+[[@{npc_cha_save}]][CHA SAVE]]]}} {{type=Save}}"><span data-i18n="cha">Cha</span><span class="stat" name="attr_npc_cha_save"></span></button>
          </div>
          <input class="npc__flag--next" type="hidden" name="attr_npc_skills_flag" value=""/>
          <div class="npc__row skills skills-list" data-i18n-list="skills-list"><span class="npc__label" data-i18n="skills">Skills</span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_acrobatics"/><span data-i18n-list-item="acrobatics">
                  <button class="npc__skill" type="roll" name="roll_npc_acrobatics" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{acrobatics}}} {{mod=@{npc_acrobatics}}} {{r1=[[@{d20}+@{npc_acrobatics}]]}} @{rtype}+@{npc_acrobatics}]]}} {{type=Skill}}"><span data-i18n="acrobatics">Acrobatics</span><span class="stat" name="attr_npc_acrobatics"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_animal_handling"/><span data-i18n-list-item="animal_handling">
                  <button class="npc__skill" type="roll" name="roll_npc_animal_handling" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{animal_handling}}} {{mod=@{npc_animal_handling}}} {{r1=[[@{d20}+@{npc_animal_handling}]]}} @{rtype}+@{npc_animal_handling}]]}} {{type=Skill}}"><span data-i18n="animal_handling">Animal handling</span><span class="stat" name="attr_npc_animal_handling"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_arcana"/><span data-i18n-list-item="arcana">
                  <button class="npc__skill" type="roll" name="roll_npc_arcana" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{arcana}}} {{mod=@{npc_arcana}}} {{r1=[[@{d20}+@{npc_arcana}]]}} @{rtype}+@{npc_arcana}]]}} {{type=Skill}}"><span data-i18n="arcana">Arcana</span><span class="stat" name="attr_npc_arcana"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_athletics"/><span data-i18n-list-item="athletics">
                  <button class="npc__skill" type="roll" name="roll_npc_athletics" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{athletics}}} {{mod=@{npc_athletics}}} {{r1=[[@{d20}+@{npc_athletics}]]}} @{rtype}+@{npc_athletics}]]}} {{type=Skill}}"><span data-i18n="athletics">Athletics</span><span class="stat" name="attr_npc_athletics"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_deception"/><span data-i18n-list-item="deception">
                  <button class="npc__skill" type="roll" name="roll_npc_deception" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{deception}}} {{mod=@{npc_deception}}} {{r1=[[@{d20}+@{npc_deception}]]}} @{rtype}+@{npc_deception}]]}} {{type=Skill}}"><span data-i18n="deception">Deception</span><span class="stat" name="attr_npc_deception"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_history"/><span data-i18n-list-item="history">
                  <button class="npc__skill" type="roll" name="roll_npc_history" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{history}}} {{mod=@{npc_history}}} {{r1=[[@{d20}+@{npc_history}]]}} @{rtype}+@{npc_history}]]}} {{type=Skill}}"><span data-i18n="history">History</span><span class="stat" name="attr_npc_history"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_insight"/><span data-i18n-list-item="insight">
                  <button class="npc__skill" type="roll" name="roll_npc_insight" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{insight}}} {{mod=@{npc_insight}}} {{r1=[[@{d20}+@{npc_insight}]]}} @{rtype}+@{npc_insight}]]}} {{type=Skill}}"><span data-i18n="insight">Insight</span><span class="stat" name="attr_npc_insight"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_intimidation"/><span data-i18n-list-item="intimidation">
                  <button class="npc__skill" type="roll" name="roll_npc_intimidation" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{intimidation}}} {{mod=@{npc_intimidation}}} {{r1=[[@{d20}+@{npc_intimidation}]]}} @{rtype}+@{npc_intimidation}]]}} {{type=Skill}}"><span data-i18n="intimidation">Intimidation</span><span class="stat" name="attr_npc_intimidation"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_investigation"/><span data-i18n-list-item="investigation">
                  <button class="npc__skill" type="roll" name="roll_npc_investigation" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{investigation}}} {{mod=@{npc_investigation}}} {{r1=[[@{d20}+@{npc_investigation}]]}} @{rtype}+@{npc_investigation}]]}} {{type=Skill}}"><span data-i18n="investigation">Investigation</span><span class="stat" name="attr_npc_investigation"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_medicine"/><span data-i18n-list-item="medicine">
                  <button class="npc__skill" type="roll" name="roll_npc_medicine" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{medicine}}} {{mod=@{npc_medicine}}} {{r1=[[@{d20}+@{npc_medicine}]]}} @{rtype}+@{npc_medicine}]]}} {{type=Skill}}"><span data-i18n="medicine">Medicine</span><span class="stat" name="attr_npc_medicine"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_nature"/><span data-i18n-list-item="nature">
                  <button class="npc__skill" type="roll" name="roll_npc_nature" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{nature}}} {{mod=@{npc_nature}}} {{r1=[[@{d20}+@{npc_nature}]]}} @{rtype}+@{npc_nature}]]}} {{type=Skill}}"><span data-i18n="nature">Nature</span><span class="stat" name="attr_npc_nature"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_perception"/><span data-i18n-list-item="perception">
                  <button class="npc__skill" type="roll" name="roll_npc_perception" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{perception}}} {{mod=@{npc_perception}}} {{r1=[[@{d20}+@{npc_perception}]]}} @{rtype}+@{npc_perception}]]}} {{type=Skill}}"><span data-i18n="perception">Perception</span><span class="stat" name="attr_npc_perception"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_performance"/><span data-i18n-list-item="performance">
                  <button class="npc__skill" type="roll" name="roll_npc_performance" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{performance}}} {{mod=@{npc_performance}}} {{r1=[[@{d20}+@{npc_performance}]]}} @{rtype}+@{npc_performance}]]}} {{type=Skill}}"><span data-i18n="performance">Performance</span><span class="stat" name="attr_npc_performance"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_persuasion"/><span data-i18n-list-item="persuasion">
                  <button class="npc__skill" type="roll" name="roll_npc_persuasion" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{persuasion}}} {{mod=@{npc_persuasion}}} {{r1=[[@{d20}+@{npc_persuasion}]]}} @{rtype}+@{npc_persuasion}]]}} {{type=Skill}}"><span data-i18n="persuasion">Persuasion</span><span class="stat" name="attr_npc_persuasion"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_religion"/><span data-i18n-list-item="religion">
                  <button class="npc__skill" type="roll" name="roll_npc_religion" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{religion}}} {{mod=@{npc_religion}}} {{r1=[[@{d20}+@{npc_religion}]]}} @{rtype}+@{npc_religion}]]}} {{type=Skill}}"><span data-i18n="religion">Religion</span><span class="stat" name="attr_npc_religion"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_sleight_of_hand"/><span data-i18n-list-item="sleight_of_hand">
                  <button class="npc__skill" type="roll" name="roll_npc_sleight_of_hand" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{sleight_of_hand}}} {{mod=@{npc_sleight_of_hand}}} {{r1=[[@{d20}+@{npc_sleight_of_hand}]]}} @{rtype}+@{npc_sleight_of_hand}]]}} {{type=Skill}}"><span data-i18n="sleight_of_hand">Sleight_of_hand</span><span class="stat" name="attr_npc_sleight_of_hand"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_stealth"/><span data-i18n-list-item="stealth">
                  <button class="npc__skill" type="roll" name="roll_npc_stealth" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{stealth}}} {{mod=@{npc_stealth}}} {{r1=[[@{d20}+@{npc_stealth}]]}} @{rtype}+@{npc_stealth}]]}} {{type=Skill}}"><span data-i18n="stealth">Stealth</span><span class="stat" name="attr_npc_stealth"></span></button></span>
                <input class="npc__flag--mod" type="hidden" name="attr_npc_survival"/><span data-i18n-list-item="survival">
                  <button class="npc__skill" type="roll" name="roll_npc_survival" value="@{wtype}&{template:npc} @{npc_name_flag} {{rname=^{survival}}} {{mod=@{npc_survival}}} {{r1=[[@{d20}+@{npc_survival}]]}} @{rtype}+@{npc_survival}]]}} {{type=Skill}}"><span data-i18n="survival">Survival</span><span class="stat" name="attr_npc_survival"></span></button></span>
          </div>
          <input class="npc__flag--next" type="hidden" name="attr_npc_vulnerabilities"/>
          <div class="npc__row npc__hidden vulnerabilities"><span class="npc__label" data-i18n="dmg-vuln">Damage Vulnerabilities</span><span name="attr_npc_vulnerabilities"></span></div>
          <input class="npc__flag--next" type="hidden" name="attr_npc_resistances"/>
          <div class="npc__row npc__hidden resistances"><span class="npc__label" data-i18n="dmg-res">Damage Resistances</span><span name="attr_npc_resistances"></span></div>
          <input class="npc__flag--next" type="hidden" name="attr_npc_immunities"/>
          <div class="npc__row npc__hidden immunities"><span class="npc__label" data-i18n="dmg-imm">Damage Immunities</span><span name="attr_npc_immunities"></span></div>
          <input class="npc__flag--next" type="hidden" name="attr_npc_condition_immunities"/>
          <div class="npc__row npc__hidden condition_immunities"><span class="npc__label" data-i18n="cond-imm">Condition Immunities</span><span name="attr_npc_condition_immunities"></span></div>
          <div class="npc__row senses"><span class="npc__label" data-i18n="senses">Senses</span><span name="attr_npc_senses"></span></div>
          <div class="npc__row languages"><span class="npc__label" data-i18n="langs">Languages</span><span class="languages" name="attr_npc_languages" value="—"></span></div>
          <div class="npc__row"><span class="npc__label" data-i18n="challenge">Challenge</span><span name="attr_npc_challenge"></span><span class="npc__challenge--brackets" name="attr_npc_xp"></span></div>
          <hr class="npc__rule--thin"/>
        </div>
        <div class="npc__traits">
          <fieldset class="repeating_npctrait">
            <div class="trait">
                  <input class="toggle__input" name="attr_edit_trait" type="hidden" value="on"/>
                  <div class="toggle npc__toggle">
                    <input name="attr_edit_trait" type="checkbox" checked="checked"/><span>y</span>
                  </div>
              <div class="trait__options options toggle__options">
                <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                  <input type="text" name="attr_name" placeholder="False Appearance." data-i18n-placeholder="npc-trait-name-place"/>
                </div>
                <div class="options__row">
                  <textarea name="attr_description" placeholder="If the dragon fails..." data-i18n-placeholder="npc-trait-desc-place"></textarea>
                </div>
              </div>
              <div class="trait__display toggle__display">
                <button class="trait__name btn ui-draggable" type="roll" name="roll_npc_roll_output" value="@{wtype}&amp;{template:traits} @{charname_output} {{name=@{name}}} {{description=@{description}}}"><span name="attr_name"></span></button><span class="trait__description" name="attr_description"></span>
              </div>
            </div>
          </fieldset>
        </div>
        <!--BONUS ACTIONS-->
        <input class="bonusaction_flag" type="hidden" name="attr_npcbonusactionsflag"/>
        <div class="npc__bonus-actions">
          <hr class="npc__rule--thin"/><span class="npc__section-header" data-i18n="bonus-actions">Bonus Actions</span>
          <fieldset class="repeating_npcbonusaction">
            <div class="action">
                  <input class="toggle__input" name="attr_edit" type="hidden" value="on"/>
                  <div class="toggle npc__toggle">
                    <input name="attr_edit" type="checkbox" checked="checked"/><span>y</span>
                  </div>
              <div class="action__options toggle__options options">
                <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                  <input type="text" name="attr_name"/>
                </div>
                <div class="options__row options__row--center">
                  <input class="options__flex--1" type="checkbox" name="attr_attack_flag" value="on"/><span class="options__flex--4" data-i18n="attack-u">ATTACK</span>
                </div>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag" value="0"/>
                <div class="options__row flag__display--attack"><span data-i18n="type:-u">TYPE:</span>
                  <select name="attr_attack_type">
                    <option value="Melee" data-i18n="melee">Melee</option>
                    <option value="Ranged" data-i18n="ranged">Ranged</option>
                  </select><span data-i18n="range-reach:-u">RANGE/REACH:</span>
                  <input type="text" name="attr_attack_range" placeholder="5 ft." data-i18n-placeholder="range-reach-place"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="to-hit:-u">TO HIT:</span>
                  <input type="text" name="attr_attack_tohit" value="0" placeholder="5"/><span data-i18n="target:-u">TARGET:</span>
                  <input type="text" name="attr_attack_target" placeholder="One target" data-i18n-placeholder="to-hit-place"/>
                </div>
                <input type="hidden" name="attr_damage_flag"/>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit:-u">ON HIT:</span>
                  <input type="text" name="attr_attack_damage" placeholder="1d10"/>
                  <input type="text" name="attr_attack_damagetype" placeholder="slashing" data-i18n-placeholder="on-hit-place"/>
                  <input type="hidden" name="attr_attack_crit"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit2:-u">ON HIT 2:</span>
                  <input type="text" name="attr_attack_damage2" placeholder="2d6+5"/>
                  <input type="text" name="attr_attack_damagetype2" placeholder="fire" data-i18n-placeholder="on-hit-2-place"/>
                  <input type="hidden" name="attr_attack_crit2"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="desc:-u">DESCRIPTION:</span>
                  <select name="attr_show_desc">
                    <option value="@{description}" data-i18n="show">Show</option>
                    <option value=" " data-i18n="hide">Hide</option>
                  </select>
                </div>
                <div class="options__row">
                  <textarea name="attr_description"></textarea>
                </div>
                <div class="options__row flag__display--attack flag__hide--attack"><span data-i18n="damage:-u">DAMAGE:</span>
                  <input type="text" name="attr_attack_damage" placeholder="1d10"/>
                  <input type="text" name="attr_attack_damagetype" placeholder="slashing" data-i18n-placeholder="on-hit-place"/>
                  <input type="hidden" name="attr_attack_crit"/>
                </div>
              </div>
              <div class="action__display toggle__display">
                <div class="npc__row">
                  <button class="action__name" type="roll" name="roll_npc_action" value="@{rollbase}"><span name="attr_name"></span></button>
                </div>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag"/>
                <div class="npc__row attack flag__display--attack"><span name="attr_attack_type"></span><span> Weapon Attack:</span><span name="attr_attack_tohitrange"></span></div>
                <div class="npc__row attack flag__display--attack"><span data-i18n="hit:">Hit:</span><span name="attr_attack_onhit"></span></div><span class="action__description" name="attr_description"></span>
              </div>
              <input type="hidden" name="attr_rollbase"/>
              <button type="roll" name="roll_npc_dmg" value="@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{description=@{show_desc}}}"></button>
              <button type="roll" name="roll_npc_crit" value="@{wtype}&{template:npcdmg} @{damage_flag} {{crit=1}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}}"></button>
            </div>
          </fieldset>
        </div>
      </div>
      <div class="npc__column--right">
        <div class="npc__actions"><span class="npc__section-header" data-i18n="actions">Actions</span>
          <fieldset class="repeating_npcaction">
            <div class="action">
                  <input class="toggle__input" name="attr_edit" type="hidden" value="on"/>
                  <div class="toggle npc__toggle">
                    <input name="attr_edit" type="checkbox" checked="checked"/><span>y</span>
                  </div>
              <div class="action__options toggle__options options">
                <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                  <input type="text" name="attr_name"/>
                </div>
                <div class="options__row options__row--center">
                  <input class="options__flex-1" type="checkbox" name="attr_attack_flag"/><span class="options__flex-4" data-i18n="attack-u">ATTACK</span>
                </div>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag" value="0"/>
                <div class="options__row flag__display--attack"><span data-i18n="type:-u">TYPE:</span>
                  <select name="attr_attack_type">
                    <option value="Melee" data-i18n="melee">Melee</option>
                    <option value="Ranged" data-i18n="ranged">Ranged</option>
                  </select><span data-i18n="range-reach:-u">RANGE/REACH:</span>
                  <input type="text" name="attr_attack_range" placeholder="5 ft." data-i18n-placeholder="range-reach-place"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="to-hit:-u">TO HIT:</span>
                  <input type="text" name="attr_attack_tohit" value="0" placeholder="5"/><span data-i18n="target:-u">TARGET:</span>
                  <input type="text" name="attr_attack_target" placeholder="One target" data-i18n-placeholder="to-hit-place"/>
                </div>
                <input type="hidden" name="attr_damage_flag"/>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit:-u">ON HIT:</span>
                  <input type="text" name="attr_attack_damage" placeholder="1d10"/>
                  <input type="text" name="attr_attack_damagetype" placeholder="slashing" data-i18n-placeholder="on-hit-place"/>
                  <input type="hidden" name="attr_attack_crit"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit2:-u">ON HIT 2:</span>
                  <input type="text" name="attr_attack_damage2" placeholder="2d6+5"/>
                  <input type="text" name="attr_attack_damagetype2" placeholder="fire" data-i18n-placeholder="on-hit-2-place"/>
                  <input type="hidden" name="attr_attack_crit2"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="desc:-u">DESCRIPTION:</span>
                  <select name="attr_show_desc">
                    <option value="@{description}" data-i18n="show">Show</option>
                    <option value=" " data-i18n="hide">Hide</option>
                  </select>
                </div>
                <div class="options__row">
                  <textarea name="attr_description"></textarea>
                </div>
                <div class="options__row flag__display--attack flag__hide--attack"><span data-i18n="damage:-u">DAMAGE:</span>
                  <input type="text" name="attr_attack_damage" placeholder="1d10"/>
                  <input type="text" name="attr_attack_damagetype" placeholder="slashing" data-i18n-placeholder="on-hit-place"/>
                  <input type="hidden" name="attr_attack_crit"/>
                </div>
              </div>
              <div class="action__display toggle__display">
                <div class="npc__row">
                  <button class="action__name" type="roll" name="roll_npc_action" value="@{rollbase}"><span name="attr_name"></span></button>
                </div>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag"/>
                <div class="npc__row flag__display--attack"><span name="attr_attack_type"></span><span> Weapon Attack:</span><span name="attr_attack_tohitrange"></span></div>
                <div class="npc__row flag__display--attack"><span data-i18n="hit:">Hit:</span><span name="attr_attack_onhit"></span></div><span class="action__description" name="attr_description"></span>
              </div>
              <input type="hidden" name="attr_rollbase"/>
              <button type="roll" name="roll_npc_dmg" value="@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{description=@{show_desc}}}"></button>
              <button type="roll" name="roll_npc_crit" value="@{wtype}&{template:npcdmg} @{damage_flag} {{crit=1}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}}"></button>
            </div>
          </fieldset>
        </div>
        <input class="reaction_flag" type="hidden" name="attr_npcreactionsflag"/>
        <div class="npc__reactions">
          <hr class="npc__rule--thin"/><span class="npc__section-header" data-i18n="reactions">Reactions</span>
          <fieldset class="repeating_npcreaction">
            <div class="reaction">
                  <input class="toggle__input" name="attr_edit" type="hidden" value="on"/>
                  <div class="toggle npc__toggle">
                    <input name="attr_edit" type="checkbox" checked="checked"/><span>y</span>
                  </div>
              <div class="reaction__options toggle__options options">
                <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                  <input type="text" name="attr_name" placeholder="Parry." data-i18n-placeholder="npc-repeating-name-place"/>
                </div>
                <div class="options__row">
                  <textarea name="attr_description" placeholder="The creature adds 2 to its AC against..." data-i18n-placeholder="npc-repeating-desc-place"></textarea>
                </div>
              </div>
              <div class="reaction__display toggle__display">
                <div class="reaction__row">
                  <button class="reaction__name" type="roll" name="npc_roll_output" value="@{wtype}&amp;{template:traits} @{charname_output} {{name=@{name}}} {{description=@{description}}}"><span name="attr_name"></span></button>
                </div><span class="reaction__description" name="attr_description"></span>
              </div>
            </div>
          </fieldset>
        </div>
        <input class="legendary_flag" type="hidden" name="attr_npc_legendary_actions" value="0"/>
        <div class="npc_legactions">
          <hr class="npc__rule--thin"/><span class="npc__section-header" data-i18n="leg-actions">Legendary Actions</span>
          <div class="npc_description"><span name="attr_npc_legendary_actions_desc"></span></div>
          <fieldset class="repeating_npcaction-l">
            <div class="legaction">
                  <input class="toggle__input" name="attr_edit" type="hidden" value="on"/>
                  <div class="toggle npc__toggle">
                    <input name="attr_edit" type="checkbox" checked="checked"/><span>y</span>
                  </div>
              <div class="legaction__options toggle__options options">
                <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                  <input type="text" name="attr_name"/>
                </div>
                <div class="options__row">
                  <input type="checkbox" name="attr_attack_flag" value="on"/><span data-i18n="attack-u">ATTACK</span>
                </div>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag" value="0"/>
                <div class="options__row flag__display--attack"><span data-i18n="type:-u">TYPE:</span>
                  <select name="attr_attack_type">
                    <option value="Melee" data-i18n="melee">Melee</option>
                    <option value="Ranged" data-i18n="ranged">Ranged</option>
                  </select><span data-i18n="range-reach:-u">RANGE/REACH:</span>
                  <input type="text" name="attr_attack_range" placeholder="5 ft." data-i18n-placeholder="range-reach-place"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="to-hit:-u">TO HIT:</span>
                  <input type="text" name="attr_attack_tohit" value="0" placeholder="5"/><span data-i18n="target:-u">TARGET:</span>
                  <input type="text" name="attr_attack_target" placeholder="One target" data-i18n-placeholder="to-hit-place"/>
                </div>
                <input type="hidden" name="attr_damage_flag"/>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit:-u">ON HIT:</span>
                  <input type="text" name="attr_attack_damage" placeholder="1d10"/>
                  <input type="text" name="attr_attack_damagetype" placeholder="slashing" data-i18n-placeholder="on-hit-place"/>
                  <input type="hidden" name="attr_attack_crit"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="on-hit2:-u">ON HIT 2:</span>
                  <input type="text" name="attr_attack_damage2" placeholder="2d6+5"/>
                  <input type="text" name="attr_attack_damagetype2" placeholder="fire" data-i18n-placeholder="on-hit-2-place"/>
                  <input type="hidden" name="attr_attack_crit2"/>
                </div>
                <div class="options__row flag__display--attack"><span data-i18n="desc:-u">DESCRIPTION:</span>
                  <select name="attr_show_desc">
                    <option value="@{description}" data-i18n="show">Show</option>
                    <option value=" " data-i18n="hide">Hide</option>
                  </select>
                </div>
                <div class="options__row">
                  <textarea name="attr_description"></textarea>
                </div>
              </div>
              <div class="legaction__display toggle__display">
                <button class="legaction__name pick" type="roll" name="roll_npc_action" value="@{rollbase}"><span name="attr_name"></span></button>
                <input class="flag__toggle--attack" type="hidden" name="attr_attack_flag"/>
                <div class="npc__row flag__display--attack"><span name="attr_attack_type"></span><span> Weapon Attack:</span><span name="attr_attack_tohitrange"></span></div>
                <div class="npc__row flag__display--attack"><span data-i18n="hit:">Hit:</span><span name="attr_attack_onhit"></span></div><span class="legaction__description" name="attr_description"></span>
              </div>
              <input type="hidden" name="attr_rollbase"/>
              <button type="roll" name="roll_npc_dmg" value="@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}}"></button>
              <button type="roll" name="roll_npc_crit" value="@{wtype}&{template:npcdmg} @{damage_flag} {{crit=1}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}}"></button>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>
  <div class="container pc">
    <div class="header">
      <div class="alignment">
        <input class="alignment__value" name="attr_alignment" type="text"/>
        <div class="alignment__label" data-i18n="Alignment">Alignment</div>
      </div>
      <div class="playername">
        <input class="playername__value" name="attr_playername" type="text"/>
        <div class="playername__label" data-i18n="Player Name">Player Name</div>
      </div>
      <div class="logo"></div>
      <div class="classlevel">
        <div class="class">
          <input class="class__value" type="text" name="attr_class" title="@{class}"/>
          <div class="class__label" data-i18n="Class">Class</div>
        </div>
        <div class="level">
          <input class="level__value" type="text" name="attr_level" title="@{level}"/>
          <div class="level__label" data-i18n="Level">Level</div>
        </div>
      </div>
      <div class="background">
        <input class="background__value" name="attr_background" type="text"/>
        <div class="background__label" data-i18n="Background">Background</div>
      </div>
      <div class="name">
        <input class="name__value" name="attr_character_name" type="text"/>
        <div class="name__label" data-i18n="Character Name">Character Name</div>
      </div>
      <div class="race">
        <input class="race__value" name="attr_race" type="text"/>
        <div class="race__label" data-i18n="Race">Race</div>
      </div>
    </div>
    <div class="navigation">
      <div class="navigation__toggles">
        <input class="toggleflag" name="attr_rtype" type="hidden"/>
        <div class="navigation__toggle-group">
          <div class="navigation__toggle">
            <input type="radio" name="attr_advantagetoggle" value="{{query=1}} {{advantage=1}} {{r2=[[@{d20}"/><span data-i18n="ADVANTAGE"></span>
          </div>
          <div class="navigation__toggle">
            <input class="toggle-center" type="radio" name="attr_advantagetoggle" value="{{query=1}} {{normal=1}} {{r2=[[0d20" checked="checked"/><span data-i18n="NORMAL"></span>
          </div>
          <div class="navigation__toggle">
            <input class="toggle-right" type="radio" name="attr_advantagetoggle" value="{{query=1}} {{disadvantage=1}} {{r2=[[@{d20}"/><span data-i18n="DISADVANTAGE"></span>
          </div>
        </div>
        <input class="toggleflag" name="attr_wtype" type="hidden"/>
        <div class="navigation__toggle navigation__toggle--whisperleft">
          <input class="toggle-left" name="attr_whispertoggle" type="radio" value="" checked="checked"/><span data-i18n="public">PUBLIC</span>
        </div>
        <div class="navigation__toggle">
          <input class="toggle-right" name="attr_whispertoggle" type="radio" value="/w gm "/><span data-i18n="WHISPER">WHISPER</span>
        </div>
      </div>
      <div class="navigation__pages">
        <div class="navigation__toggle">
          <input name="attr_tab" type="radio" value="core" checked="checked"/><span data-i18n="CORE"></span>
        </div>
        <div class="navigation__toggle">
          <input name="attr_tab" type="radio" value="spells"/><span data-i18n="SPELLS &amp; MOVES"></span>
        </div>
        <div class="navigation__toggle">
          <input name="attr_tab" type="radio" value="bio"/><span data-i18n="BIO"></span>
        </div>
        <div class="navigation__toggle navigation__toggle--settings">
          <input name="attr_tab" type="radio" value="settings"/><span class="pictos">y</span>
        </div>
      </div>
    </div>
    <input class="page__switch" name="attr_tab" type="hidden" value="core"/>
    <div class="page core">
      <div class="core-body">
        <div class="core-col">
          <div class="shields">
            <div class="ac">
              <input class="ac__value" name="attr_ac" title="@{ac}" type="number"/>
              <div class="ac__label" data-i18n="AC">AC</div>
            </div>
            <div class="speed">
              <input class="speed__value" name="attr_speed" title="@{speed}" type="number"/>
              <div class="speed__label" data-i18n="Speed">Speed</div>
            </div>
          </div>
          <div class="inspprof inspprof--initiative">
            <div class="inspprof__value"><span name="attr_initiative_bonus" title="@{initiative_bonus}"></span></div>
            <div class="inspprof__label">
              <button class="inspprof__button" type="roll" name="roll_initiative" value="@{wtype}&amp;{template:simple} {{rname=^{init-u}}} {{mod=@{initiative_bonus}}} {{r1=[[@{initiative_style}+@{initiative_bonus}@{pbd_safe}[INIT] &amp;{tracker}]]}} {{normal=1}} @{charname_output}" data-i18n="Initiative">initative</button>
            </div>
          </div>
          <div class="personalitytrait">
            <div class="personalitytrait__label" data-i18n="Personality Traits"></div>
            <textarea name="attr_personality_traits"></textarea>
          </div>
          <div class="personalitytrait">
            <div class="personalitytrait__label" data-i18n="Ideals"></div>
            <textarea name="attr_ideals"></textarea>
          </div>
          <div class="personalitytrait">
            <div class="personalitytrait__label" data-i18n="Bonds"></div>
            <textarea name="attr_bonds"></textarea>
          </div>
          <div class="personalitytrait">
            <div class="personalitytrait__label" data-i18n="Flaws"></div>
            <textarea name="attr_flaws"></textarea>
          </div>
          <div class="bounty">
            <div class="bounty__image"></div>
            <div class="bounty__bounty">
              <div class="bounty__label" data-i18n="Bounty"></div>
              <input name="attr_bounty" type="number"/>
            </div>
          </div>
        </div>
        <div class="core-col core-col--middle">
          <div class="vitals">
            <div class="vitals__hp">
              <input type="number" name="attr_hitpoints" value="0"/>
              <input type="number" name="attr_hitpoints_max" value="0"/><span class="vitals__label" data-i18n="Hitpoints"></span>
            </div>
            <div class="vitals__temphp">
              <input type="number" name="attr_temp_hitpoints"/><span class="vitals__label" data-i18n="Temporary HP"></span>
            </div>
            <div class="vitals__hitdice">
              <input type="number" name="attr_hitdice"/><span>/</span>
              <input name="attr_hitdice_max" type="hidden" value="1"/><span name="attr_hitdice_max"></span><span class="vitals__label" data-i18n="Hit Dice"></span>
            </div>
          </div>
          <div class="trackers">
            <div class="exhaustions">
              <input type="hidden" name="attr_exhaustion" value="0"/>
              <div class="exhaustions__checks">
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="0"/><span class="exhaustion__text">0</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="1"/><span class="exhaustion__text">1</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="2"/><span class="exhaustion__text">2</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="3"/><span class="exhaustion__text">3</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="4"/><span class="exhaustion__text">4</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="5"/><span class="exhaustion__text">5</span>
                </div>
                <div class="exhaustion">
                  <input class="exhaustion__radio" type="radio" name="attr_exhaustion" value="6"/><span class="exhaustion__text">6</span>
                </div>
              </div>
              <div class="exhaustions__tracker"> <img class="exhaustions__level exhaustions__level--0" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-0_wulpge.png"/><img class="exhaustions__level exhaustions__level--1" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-1_fzmarb.png"/><img class="exhaustions__level exhaustions__level--2" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-2_prwgr3.png"/><img class="exhaustions__level exhaustions__level--3" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-3_hvsfbn.png"/><img class="exhaustions__level exhaustions__level--4" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-4_bnucar.png"/><img class="exhaustions__level exhaustions__level--5" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-5_ncgzva.png"/><img class="exhaustions__level exhaustions__level--6" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/exhaustion-6_zles7f.png"/>
              </div><span class="exhaustions__label" data-i18n="Exhaustion">Exhaustion</span>
            </div>
            <div class="knocks">
              <input type="hidden" name="attr_knock" value="0"/>
              <div class="knocks__tracker"> <img class="knocks__level knocks__level--0" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/knocks-0_vjhzm1.png"/><img class="knocks__level knocks__level--1" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/knocks-1_jw2f7g.png"/><img class="knocks__level knocks__level--2" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/knocks-2_vjnn6l.png"/><img class="knocks__level knocks__level--3" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/knocks-3_k5vfqe.png"/><img class="knocks__level knocks__level--4" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558383/knocks-4_qgcbum.png"/><img class="knocks__level knocks__level--5" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558384/knocks-5_tdonfo.png"/><img class="knocks__level knocks__level--6" src="https://res.cloudinary.com/dmrhbjudf/image/upload/v1626558384/knocks-6_ta9dgm.png"/>
              </div>
              <div class="knocks__checks">
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="0"/><span class="knock__text">0</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="1"/><span class="knock__text">1</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="2"/><span class="knock__text">2</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="3"/><span class="knock__text">3</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="4"/><span class="knock__text">4</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="5"/><span class="knock__text">5</span>
                </div>
                <div class="knock">
                  <input class="knock__radio" type="radio" name="attr_knock" value="6"/><span class="knock__text">6</span>
                </div>
              </div><span class="knocks__label" data-i18n="Knocks">Knocks</span>
            </div>
          </div>
          <div class="deathsaves">
            <div class="deathsaves">
              <div class="deathsaves__container">
                <div class="deathsaves__label">
                  <button type="roll" name="roll_death_save" value="@{wtype}&amp;{template:simple} {{rname=^{death-save-u}}} {{mod=@{death_save_bonus}}} {{r1=[[@{d20}+@{death_save_bonus}[MOD]@{globalsavingthrowbonus}]]}} {{normal=1}} {{global=@{global_save_mod}}} @{charname_output}" data-i18n="death-saves-u">DEATH SAVES</button>
                </div>
                <div class="deathsaves__successes"><span class="deathsaves__text" data-i18n="successes-u">SUCCESSES</span>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_succ1"/><span></span>
                  </div>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_succ2"/><span></span>
                  </div>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_succ3"/><span></span>
                  </div>
                </div>
                <div class="deathsaves__failures"><span class="deathsaves__text" data-i18n="failures-u">FAILURES</span>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_fail1"/><span></span>
                  </div>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_fail2"/><span></span>
                  </div>
                  <div class="deathsaves__check">
                    <input type="checkbox" name="attr_deathsave_fail3"/><span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="equipment">
            <div class="equipment__header"><span class="equipment__count pictos">*</span><span class="equipment__title" data-i18n="item-name-u">ITEM NAME</span><span class="equipment__weighti"><img src="https://app.roll20.net/images/dndstyling/weight_lbs.png" alt="Weight symbol"/></span></div>
            <fieldset class="repeating_inventory">
              <div class="item">
                <input class="item__optionsflag" type="hidden" name="attr_inventory_options"/>
                <div class="item__titlerow">
                  <input class="item__equipped" type="checkbox" name="attr_equipped" value="1" checked="checked"/>
                  <input class="item__count" type="text" name="attr_itemcount" value="1"/>
                  <input class="item__name" type="text" name="attr_itemname"/>
                  <input class="item__weight" type="text" name="attr_itemweight"/>
                  <div class="item__optionsflag">
                    <input class="item__optionscheck" type="checkbox" name="attr_inventory_options"/><span class="pictos">y</span>
                  </div>
                </div>
                <div class="item__options options">
                  <div class="options__row options__row--checkbox">
                    <input class="equipped" type="checkbox" name="attr_equipped" value="1" checked="checked"/><span class="equippedlabel" data-i18n="equipped-u">EQUIPPED</span>
                  </div>
                  <div class="options__row options__row--checkbox">
                    <input class="equipped" type="checkbox" name="attr_useasresource" value="1"/><span class="equippedlabel" data-i18n="use-as-resource-u">USE AS A RESOURCE</span>
                  </div>
                  <div class="options__row options__row--checkbox">
                    <input class="equipped" type="checkbox" name="attr_hasattack" value="1"/><span class="equippedlabel" data-i18n="has-attack-u">HAS AN ATTACK</span>
                  </div>
                  <div class="options__row"><span data-i18n="prop:-u">PROP:</span>
                    <input type="text" name="attr_itemproperties"/>
                  </div>
                  <div class="options__row"><span data-i18n="mods:-u">MODS:</span>
                    <input type="text" name="attr_itemmodifiers"/>
                  </div>
                  <div class="options__row">
                    <textarea class="subtextarea" name="attr_itemcontent"></textarea>
                  </div>
                </div>
                <input type="hidden" name="attr_itemattackid"/>
                <input type="hidden" name="attr_itemresourceid"/>
              </div>
            </fieldset>
            <div class="equipment__weighttotal"><span class="equipment__encumbrancetitle" data-i18n="total-weight-u">TOTAL WEIGHT</span>
              <input class="equipment__encumbrance" type="number" name="attr_weighttotal" value="0"/>
              <input type="hidden" name="attr_encumbrance"/>
            </div>
            <div class="equipment__label" data-i18n="Equipment">Equipment</div>
          </div>
          <input class="ammoflag" type="hidden" name="attr_ammotracking"/>
          <div class="attacks">
            <div class="attacks__header"><span data-i18n="name-u">NAME</span><span data-i18n="atk-u">ATK</span><span data-i18n="dmg-type-u">DAMAGE/TYPE</span></div>
            <fieldset class="repeating_attack">
              <div class="attack">
                <input class="options__flag" name="attr_options-flag" type="hidden" value="on"/>
                <div class="attack__display">
                  <button class="attack__button" type="roll" name="roll_attack" value="@{rollbase}"><span class="attack__name" name="attr_atkname"></span>
                    <input class="attack__bonus" type="text" name="attr_atkbonus" value=""/>
                    <input class="attack__type" type="text" name="attr_atkdmgtype" value=""/>
                  </button>
                  <div class="options__cog">
                    <input type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                  </div>
                </div>
                <div class="attack__options options">
                  <div class="options__row"><span class="options__label" data-i18n="name:-u">NAME:</span>
                    <input type="text" name="attr_atkname"/>
                  </div>
                  <div class="options__row options__row--noborder">
                    <input type="checkbox" name="attr_atkflag" value="{{attack=1}}" checked="checked"/><span class="options__label" data-i18n="attack:-u">ATTACK:</span>
                    <select name="attr_atkattr_base">
                      <option value="@{strength_mod}" selected="selected" data-i18n="str-u">STR</option>
                      <option value="@{dexterity_mod}" data-i18n="dex-u">DEX</option>
                      <option value="@{constitution_mod}" data-i18n="con-u">CON</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{wisdom_mod}" data-i18n="wis-u">WIS</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="spell" data-i18n="spell-u">SPELL</option>
                      <option value="0">-</option>
                    </select><span>+</span>
                    <input type="text" name="attr_atkmod" placeholder="0"/><span>+</span>
                    <input type="checkbox" name="attr_atkprofflag" value="(@{pb})" checked="checked"/><span data-i18n="proficient-u">PROFICIENT</span>
                  </div>
                  <div class="options__row options__row--noborder"><span class="options__label" data-i18n="range:-u">RANGE:</span>
                    <input type="text" name="attr_atkrange" placeholder="Self (60-foot cone)" data-i18n-placeholder="range-place"/>
                  </div>
                  <div class="options__row"><span class="options__label" data-i18n="magic-bonus:-u">MAGIC BONUS:</span>
                    <input class="options__flex--2" type="text" name="attr_atkmagic" placeholder="0"/><span class="options__label" data-i18n="crit-range-u">CRIT RANGE:</span>
                    <input class="options__flex--2" type="text" name="attr_atkcritrange" value="20" placeholder="20"/>
                  </div>
                  <div class="options__row options__row--noborder">
                    <input type="checkbox" name="attr_dmgflag" value="{{damage=1}} {{dmg1flag=1}}" checked="checked"/><span class="options__label" data-i18n="damage:-u">DAMAGE:</span>
                    <input type="text" name="attr_dmgbase" placeholder="1d6"/><span class="options__label">+</span>
                    <select name="attr_dmgattr">
                      <option value="@{strength_mod}" selected="selected" data-i18n="str-u">STR</option>
                      <option value="@{dexterity_mod}" data-i18n="dex-u">DEX</option>
                      <option value="@{constitution_mod}" data-i18n="con-u">CON</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{wisdom_mod}" data-i18n="wis-u">WIS</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="spell" data-i18n="spell-u">SPELL</option>
                      <option value="0">-</option>
                    </select><span class="options__label">+</span>
                    <input type="text" name="attr_dmgmod" placeholder="0"/>
                  </div>
                  <div class="options__row"><span class="options__label" data-i18n="type:-u">TYPE:</span>
                    <input type="text" name="attr_dmgtype" placeholder="Slashing" data-i18n-placeholder="dmg-type-place"/><span class="options__label" data-i18n="crit:-u">CRIT:</span>
                    <input type="text" name="attr_dmgcustcrit" placeholder="1d6"/>
                  </div>
                  <div class="options__row options__row--noborder">
                    <input type="checkbox" name="attr_dmg2flag" value="{{damage=1}} {{dmg2flag=1}}"/><span class="options__label" data-i18n="damage2:-u">DAMAGE2:</span>
                    <input type="text" name="attr_dmg2base" placeholder="1d6"/><span class="options__label">+</span>
                    <select name="attr_dmg2attr">
                      <option value="@{strength_mod}" data-i18n="str-u">STR</option>
                      <option value="@{dexterity_mod}" data-i18n="dex-u">DEX</option>
                      <option value="@{constitution_mod}" data-i18n="con-u">CON</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{wisdom_mod}" data-i18n="wis-u">WIS</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="spell" data-i18n="spell-u">SPELL</option>
                      <option value="0" selected="selected">-</option>
                    </select><span class="options__label">+</span>
                    <input type="text" name="attr_dmg2mod" placeholder="0"/>
                  </div>
                  <div class="options__row"><span data-i18n="type:-u">TYPE:</span>
                    <input type="text" name="attr_dmg2type" placeholder="Slashing" data-i18n-placeholder="dmg-type-place"/><span data-i18n="crit:-u">CRIT:</span>
                    <input type="text" name="attr_dmg2custcrit" placeholder="1d6"/>
                  </div>
                  <div class="options__row options__row--noborder">
                    <input type="checkbox" name="attr_saveflag" value="{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}"/><span class="options__label" data-i18n="saving-throw:-u">SAVING THROW:</span>
                    <select class="options__flex" name="attr_saveattr">
                      <option value="Strength" selected="selected" data-i18n="str-u">STR</option>
                      <option value="Dexterity" data-i18n="dex-u">DEX</option>
                      <option value="Constitution" data-i18n="con-u">CON</option>
                      <option value="Intelligence" data-i18n="int-u">INT</option>
                      <option value="Wisdom" data-i18n="wis-u">WIS</option>
                      <option value="Charisma" data-i18n="cha-u">CHA</option>
                    </select>
                  </div>
                  <div class="options__row options__row--noborder"><span class="options__label options__flex--4" data-i18n="vs-dc:-u">VS DC:</span>
                    <select class="options__flex" name="attr_savedc">
                      <option value="(@{spell_save_dc})" selected="selected" data-i18n="spell-u">SPELL</option>
                      <option value="(@{strength_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="str-u">STR</option>
                      <option value="(@{dexterity_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="dex-u">DEX</option>
                      <option value="(@{constitution_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="con-u">CON</option>
                      <option value="(@{intelligence_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="int-u">INT</option>
                      <option value="(@{wisdom_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="wis-u">WIS</option>
                      <option value="(@{charisma_mod}+8+@{spell_dc_mod}+@{pb})" data-i18n="cha-u">CHA</option>
                      <option value="(@{saveflat})" data-i18n="flat-u">FLAT</option>
                    </select>
                    <input class="flatflag" type="hidden" name="attr_savedc"/>
                    <input class="flat" type="text" name="attr_saveflat" placeholder="10" value="10"/>
                  </div>
                  <div class="options__row"><span class="options__label options__flex--4" data-i18n="save-effect:-u">SAVE EFFECT:</span>
                    <input type="text" name="attr_saveeffect" placeholder="half damage" data-i18n-placeholder="save-effect-place"/>
                  </div>
                  <div class="options__row"><span class="options__label" data-i18n="ammunition:-u">AMMUNITION:</span>
                    <input type="text" name="attr_ammo" placeholder="Arrows" data-i18n-placeholder="ammunition-place"/>
                  </div>
                  <div class="options__row"><span class="options__label" data-i18n="description:-u">DESCRIPTION:</span>
                    <textarea name="attr_atk_desc" placeholder="Up to 2 creatures within 5 feet" data-i18n-placeholder="description-place"></textarea>
                  </div>
                </div>
              </div>
              <input type="hidden" name="attr_rollbase"/>
              <input type="hidden" name="attr_rollbase_dmg"/>
              <input type="hidden" name="attr_rollbase_crit"/>
              <input type="hidden" name="attr_hldmg"/>
              <input type="hidden" name="attr_spelllevel"/>
              <input type="hidden" name="attr_itemid"/>
              <input type="hidden" name="attr_spellid"/>
              <input type="hidden" name="attr_spell_innate"/>
              <input type="hidden" name="attr_versatile_alt"/>
              <button class="hidden" type="roll" name="roll_attack_dmg" value="@{rollbase_dmg}"></button>
              <button class="hidden" type="roll" name="roll_attack_crit" value="@{rollbase_crit}"></button>
            </fieldset>
            <input class="toggleflag" type="hidden" name="attr_global_attack_mod_flag"/>
            <div class="hidden textbox globalattack"><span data-i18n="global-attack-u">GLOBAL ATTACK MODIFIER</span>
              <fieldset class="repeating_tohitmod">
                <div class="global-mod">
                  <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                  <input class="active-flag" type="checkbox" name="attr_global_attack_active_flag" value="1"/>
                  <div class="options">
                    <div class="row"><span data-i18n="name:-u">NAME:</span>
                      <input type="text" name="attr_global_attack_name" value="" placeholder="Bless"/>
                    </div>
                    <div class="row"><span data-i18n="roll:-u">ROLL:</span>
                      <input type="text" name="attr_global_attack_roll" value="" placeholder="1d4"/>
                    </div>
                  </div>
                  <div class="globaldisplay">
                    <button class="ellipsis" type="roll" name="roll_global_save" value="@{wtype}&amp;{template:simple} {{rname=@{global_attack_name}}} {{r1=[[@{global_attack_roll}]]}} {{normal=1}} @{charname_output}"><span name="attr_global_attack_roll"></span><span name="attr_global_attack_name"></span></button>
                  </div>
                </div>
              </fieldset>
            </div>
            <input class="toggleflag" type="hidden" name="attr_global_damage_mod_flag"/>
            <div class="hidden globalattack global-dmg"><span data-i18n="global-damage-u">GLOBAL DAMAGE MODIFIER</span>
              <fieldset class="repeating_damagemod">
                <div class="global-mod">
                  <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                  <input class="active-flag" type="checkbox" name="attr_global_damage_active_flag" value="1"/>
                  <div class="options">
                    <div class="row"><span data-i18n="name:-u">NAME:</span>
                      <input type="text" name="attr_global_damage_name" value="" placeholder="Sneak Attack"/>
                    </div>
                    <div class="row"><span data-i18n="dmg:-u">DAMAGE:</span>
                      <input type="text" name="attr_global_damage_damage" value="" placeholder="1d6"/>
                    </div>
                    <div class="row"><span data-i18n="critical-dmg:-u">CRITICAL DAMAGE:</span>
                      <input type="text" name="attr_global_damage_critical_damage" value="" placeholder="1d6"/>
                    </div>
                    <div class="row"><span data-i18n="type:-u">TYPE:</span>
                      <input type="text" name="attr_global_damage_type" value="" placeholder="Sneak"/>
                    </div>
                  </div>
                  <div class="display"><span class="title" name="attr_global_damage_name"></span><span class="subheader">
                      <button class="ellipsis" type="roll" name="roll_global_save" value="@{wtype}&amp;{template:simple} {{rname=@{global_damage_type}}} {{r1=[[@{global_damage_damage}]]}} {{normal=1}} @{charname_output}"><span name="attr_global_damage_damage"></span><span name="attr_global_damage_critical_damage"></span><span name="attr_global_damage_type"></span></button></span></div>
                </div>
              </fieldset>
            </div>
            <div class="attacks__label" data-i18n="Attacks &amp; Spellcasting">Attacks & Spellcasting</div>
          </div>
        </div>
        <div class="core-col core-col__split">
          <div class="abilityscores">
            <div class="abilityscore abilityscore--STR ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_strength" value="@{wtype}&amp;{template:simple} {{rname=^{strength-u}}} {{mod=@{strength_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{strength_mod}@{jack_attr}[STR]]]}} @{rtype}+@{strength_mod}@{jack_attr}[STR]]]}} @{charname_output}" data-i18n="strength-u"> </button><span class="abilityscore__value" name="attr_strength_mod" title="@{strength_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_strength_base" title="@{strength}" value="10"/>
                <input type="hidden" name="attr_strength" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_strength_flag" value="0"/><span class="abilityscore__final" name="attr_strength"></span>
              </div>
            </div>
            <div class="abilityscore abilityscore--DEX ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_dexterity" value="@{wtype}&amp;{template:simple} {{rname=^{dexterity-u}}} {{mod=@{dexterity_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{dexterity_mod}@{jack_attr}[DEX]]]}} @{rtype}+@{dexterity_mod}@{jack_attr}[DEX]]]}} @{charname_output}" data-i18n="dexterity-u"> </button><span class="abilityscore__value" name="attr_dexterity_mod" title="@{dexterity_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_dexterity_base" title="@{dexterity}" value="10"/>
                <input type="hidden" name="attr_dexterity" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_dexterity_flag" value="0"/><span class="abilityscore__final" name="attr_dexterity"></span>
              </div>
            </div>
            <div class="abilityscore abilityscore--CON ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_constitution" value="@{wtype}&amp;{template:simple} {{rname=^{constitution-u}}} {{mod=@{constitution_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{constitution_mod}@{jack_attr}[CON]]]}} @{rtype}+@{constitution_mod}@{jack_attr}[CON]]]}} @{charname_output}" data-i18n="constitution-u"> </button><span class="abilityscore__value" name="attr_constitution_mod" title="@{constitution_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_constitution_base" title="@{constitution}" value="10"/>
                <input type="hidden" name="attr_constitution" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_constitution_flag" value="0"/><span class="abilityscore__final" name="attr_constitution"></span>
              </div>
            </div>
            <div class="abilityscore abilityscore--INT ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_intelligence" value="@{wtype}&amp;{template:simple} {{rname=^{intelligence-u}}} {{mod=@{intelligence_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{intelligence_mod}@{jack_attr}[INT]]]}} @{rtype}+@{intelligence_mod}@{jack_attr}[INT]]]}} @{charname_output}" data-i18n="intelligence-u"> </button><span class="abilityscore__value" name="attr_intelligence_mod" title="@{intelligence_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_intelligence_base" title="@{intelligence}" value="10"/>
                <input type="hidden" name="attr_intelligence" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_intelligence_flag" value="0"/><span class="abilityscore__final" name="attr_intelligence"></span>
              </div>
            </div>
            <div class="abilityscore abilityscore--WIS ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_wisdom" value="@{wtype}&amp;{template:simple} {{rname=^{wisdom-u}}} {{mod=@{wisdom_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{wisdom_mod}@{jack_attr}[WIS]]]}} @{rtype}+@{wisdom_mod}@{jack_attr}[WIS]]]}} @{charname_output}" data-i18n="wisdom-u"> </button><span class="abilityscore__value" name="attr_wisdom_mod" title="@{wisdom_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_wisdom_base" title="@{wisdom}" value="10"/>
                <input type="hidden" name="attr_wisdom" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_wisdom_flag" value="0"/><span class="abilityscore__final" name="attr_wisdom"></span>
              </div>
            </div>
            <div class="abilityscore abilityscore--CHA ">
              <button class="abilityscore__rollbutton" type="roll" name="roll_charisma" value="@{wtype}&amp;{template:simple} {{rname=^{charisma-u}}} {{mod=@{charisma_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{charisma_mod}@{jack_attr}[CHA]]]}} @{rtype}+@{charisma_mod}@{jack_attr}[CHA]]]}} @{charname_output}" data-i18n="charisma-u"> </button><span class="abilityscore__value" name="attr_charisma_mod" title="@{charisma_mod}"></span>
              <div class="abilityscore__mod">
                <input class="abilityscore__base" type="text" name="attr_charisma_base" title="@{charisma}" value="10"/>
                <input type="hidden" name="attr_charisma" value="10"/>
                <input class="abilityscore__flag" type="hidden" name="attr_charisma_flag" value="0"/><span class="abilityscore__final" name="attr_charisma"></span>
              </div>
            </div>
          </div>
          <div class="skillwrap">
            <div class="inspprof">
              <div class="inspprof__value"><span name="attr_pb" title="@{pb}"></span>
              </div>
              <div class="inspprof__label"><span data-i18n="Proficiency Bonus"></span></div>
            </div>
            <div class="savingthrows">
              <div class="savingthrow">
                <input type="hidden" name="attr_strength_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_strength_save_prof" title="@{strength_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_strength_save_bonus" title="@{strength_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_strength_save" value="@{strength_save_roll}" data-i18n="strength"></button>
              </div>
              <div class="savingthrow">
                <input type="hidden" name="attr_dexterity_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_dexterity_save_prof" title="@{dexterity_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_dexterity_save_bonus" title="@{dexterity_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_dexterity_save" value="@{dexterity_save_roll}" data-i18n="dexterity"></button>
              </div>
              <div class="savingthrow">
                <input type="hidden" name="attr_constitution_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_constitution_save_prof" title="@{constitution_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_constitution_save_bonus" title="@{constitution_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_constitution_save" value="@{constitution_save_roll}" data-i18n="constitution"></button>
              </div>
              <div class="savingthrow">
                <input type="hidden" name="attr_intelligence_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_intelligence_save_prof" title="@{intelligence_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_intelligence_save_bonus" title="@{intelligence_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_intelligence_save" value="@{intelligence_save_roll}" data-i18n="intelligence"></button>
              </div>
              <div class="savingthrow">
                <input type="hidden" name="attr_wisdom_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_wisdom_save_prof" title="@{wisdom_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_wisdom_save_bonus" title="@{wisdom_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_wisdom_save" value="@{wisdom_save_roll}" data-i18n="wisdom"></button>
              </div>
              <div class="savingthrow">
                <input type="hidden" name="attr_charisma_save_roll"/>
                <div class="savingthrow__checkbox">
                  <input type="checkbox" name="attr_charisma_save_prof" title="@{charisma_save_prof}" value="(@{pb})"/><span></span>
                </div><span class="savingthrow__value" name="attr_charisma_save_bonus" title="@{charisma_save_bonus}"></span>
                <button class="savingthrow__button" type="roll" name="roll_charisma_save" value="@{charisma_save_roll}" data-i18n="charisma"></button>
              </div>
            </div>
            <div class="inspprof inspprof--inspiration">
              <div class="inspprof__value">
                <input type="checkbox" name="attr_inspiration"/><span></span>
              </div>
              <div class="inspprof__label"><span data-i18n="Inspiration"></span></div>
            </div>
            <div class="skills">
              <div data-i18n-list="skills-list">
                <div class="skill" data-i18n-list-item="acrobatics">
                  <input type="hidden" name="attr_acrobatics_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_acrobatics_prof" title="@{acrobatics_prof}" value="(@{pb}*@{acrobatics_type})"/><span></span>
                  </div><span class="skill__value" name="attr_acrobatics_bonus" title="@{acrobatics_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_acrobatics" value="@{acrobatics_roll}" data-i18n="acrobatics-core">Acrobatics<span>DEXTERITY</span></button>
                </div>
                <div class="skill" data-i18n-list-item="animal_handling">
                  <input type="hidden" name="attr_animal_handling_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_animal_handling_prof" title="@{animal_handling_prof}" value="(@{pb}*@{animal_handling_type})"/><span></span>
                  </div><span class="skill__value" name="attr_animal_handling_bonus" title="@{animal_handling_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_animal_handling" value="@{animal_handling_roll}" data-i18n="animal_handling-core">Animal Handling<span>WISDOM</span></button>
                </div>
                <div class="skill" data-i18n-list-item="arcana">
                  <input type="hidden" name="attr_arcana_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_arcana_prof" title="@{arcana_prof}" value="(@{pb}*@{arcana_type})"/><span></span>
                  </div><span class="skill__value" name="attr_arcana_bonus" title="@{arcana_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_arcana" value="@{arcana_roll}" data-i18n="arcana-core">Arcana<span>INTELLIGENCE</span></button>
                </div>
                <div class="skill" data-i18n-list-item="athletics">
                  <input type="hidden" name="attr_athletics_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_athletics_prof" title="@{athletics_prof}" value="(@{pb}*@{athletics_type})"/><span></span>
                  </div><span class="skill__value" name="attr_athletics_bonus" title="@{athletics_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_athletics" value="@{athletics_roll}" data-i18n="athletics-core">Athletics<span>STRENGTH</span></button>
                </div>
                <div class="skill" data-i18n-list-item="deception">
                  <input type="hidden" name="attr_deception_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_deception_prof" title="@{deception_prof}" value="(@{pb}*@{deception_type})"/><span></span>
                  </div><span class="skill__value" name="attr_deception_bonus" title="@{deception_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_deception" value="@{deception_roll}" data-i18n="deception-core">Deception<span>CHARISMA</span></button>
                </div>
                <div class="skill" data-i18n-list-item="history">
                  <input type="hidden" name="attr_history_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_history_prof" title="@{history_prof}" value="(@{pb}*@{history_type})"/><span></span>
                  </div><span class="skill__value" name="attr_history_bonus" title="@{history_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_history" value="@{history_roll}" data-i18n="history-core">History<span>INTELLIGENCE</span></button>
                </div>
                <div class="skill" data-i18n-list-item="insight">
                  <input type="hidden" name="attr_insight_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_insight_prof" title="@{insight_prof}" value="(@{pb}*@{insight_type})"/><span></span>
                  </div><span class="skill__value" name="attr_insight_bonus" title="@{insight_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_insight" value="@{insight_roll}" data-i18n="insight-core">Insight<span>WISDOM</span></button>
                </div>
                <div class="skill" data-i18n-list-item="intimidation">
                  <input type="hidden" name="attr_intimidation_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_intimidation_prof" title="@{intimidation_prof}" value="(@{pb}*@{intimidation_type})"/><span></span>
                  </div><span class="skill__value" name="attr_intimidation_bonus" title="@{intimidation_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_intimidation" value="@{intimidation_roll}" data-i18n="intimidation-core">Intimidation<span>CHARISMA</span></button>
                </div>
                <div class="skill" data-i18n-list-item="investigation">
                  <input type="hidden" name="attr_investigation_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_investigation_prof" title="@{investigation_prof}" value="(@{pb}*@{investigation_type})"/><span></span>
                  </div><span class="skill__value" name="attr_investigation_bonus" title="@{investigation_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_investigation" value="@{investigation_roll}" data-i18n="investigation-core">Investigation<span>INTELLIGENCE</span></button>
                </div>
                <div class="skill" data-i18n-list-item="medicine">
                  <input type="hidden" name="attr_medicine_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_medicine_prof" title="@{medicine_prof}" value="(@{pb}*@{medicine_type})"/><span></span>
                  </div><span class="skill__value" name="attr_medicine_bonus" title="@{medicine_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_medicine" value="@{medicine_roll}" data-i18n="medicine-core">Medicine<span>WISDOM</span></button>
                </div>
                <div class="skill" data-i18n-list-item="nature">
                  <input type="hidden" name="attr_nature_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_nature_prof" title="@{nature_prof}" value="(@{pb}*@{nature_type})"/><span></span>
                  </div><span class="skill__value" name="attr_nature_bonus" title="@{nature_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_nature" value="@{nature_roll}" data-i18n="nature-core">Nature<span>INTELLIGENCE</span></button>
                </div>
                <div class="skill" data-i18n-list-item="perception">
                  <input type="hidden" name="attr_perception_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_perception_prof" title="@{perception_prof}" value="(@{pb}*@{perception_type})"/><span></span>
                  </div><span class="skill__value" name="attr_perception_bonus" title="@{perception_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_perception" value="@{perception_roll}" data-i18n="perception-core">Perception<span>WISDOM</span></button>
                </div>
                <div class="skill" data-i18n-list-item="performance">
                  <input type="hidden" name="attr_performance_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_performance_prof" title="@{performance_prof}" value="(@{pb}*@{performance_type})"/><span></span>
                  </div><span class="skill__value" name="attr_performance_bonus" title="@{performance_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_performance" value="@{performance_roll}" data-i18n="performance-core">Performance<span>CHARISMA</span></button>
                </div>
                <div class="skill" data-i18n-list-item="persuasion">
                  <input type="hidden" name="attr_persuasion_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_persuasion_prof" title="@{persuasion_prof}" value="(@{pb}*@{persuasion_type})"/><span></span>
                  </div><span class="skill__value" name="attr_persuasion_bonus" title="@{persuasion_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_persuasion" value="@{persuasion_roll}" data-i18n="persuasion-core">Persuasion<span>CHARISMA</span></button>
                </div>
                <div class="skill" data-i18n-list-item="religion">
                  <input type="hidden" name="attr_religion_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_religion_prof" title="@{religion_prof}" value="(@{pb}*@{religion_type})"/><span></span>
                  </div><span class="skill__value" name="attr_religion_bonus" title="@{religion_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_religion" value="@{religion_roll}" data-i18n="religion-core">Religion<span>INTELLIGENCE</span></button>
                </div>
                <div class="skill" data-i18n-list-item="sleight_of_hand">
                  <input type="hidden" name="attr_sleight_of_hand_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_sleight_of_hand_prof" title="@{sleight_of_hand_prof}" value="(@{pb}*@{sleight_of_hand_type})"/><span></span>
                  </div><span class="skill__value" name="attr_sleight_of_hand_bonus" title="@{sleight_of_hand_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_sleight_of_hand" value="@{sleight_of_hand_roll}" data-i18n="sleight_of_hand-core">Sleight of Hand<span>DEXTERITY</span></button>
                </div>
                <div class="skill" data-i18n-list-item="stealth">
                  <input type="hidden" name="attr_stealth_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_stealth_prof" title="@{stealth_prof}" value="(@{pb}*@{stealth_type})"/><span></span>
                  </div><span class="skill__value" name="attr_stealth_bonus" title="@{stealth_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_stealth" value="@{stealth_roll}" data-i18n="stealth-core">Stealth<span>DEXTERITY</span></button>
                </div>
                <div class="skill" data-i18n-list-item="survival">
                  <input type="hidden" name="attr_survival_roll"/>
                  <div class="skill__checkbox">
                    <input type="checkbox" name="attr_survival_prof" title="@{survival_prof}" value="(@{pb}*@{survival_type})"/><span></span>
                  </div><span class="skill__value" name="attr_survival_bonus" title="@{survival_bonus}">0</span>
                  <button class="skill__button" type="roll" name="roll_survival" value="@{survival_roll}" data-i18n="survival-core">Survival<span>WISDOM</span></button>
                </div>
              </div>
            </div>
            <div class="inspprof">
              <div class="inspprof__value"><span name="attr_passive_wisdom"></span>
              </div>
              <div class="inspprof__label"><span data-i18n="Passive Perception"></span></div>
            </div>
          </div>
          <div class="coins">
            <div class="money">
              <div class="coin"><span class="coin__label" data-i18n="L"></span>
                <input type="number" name="attr_l" placeholder="0"/>
              </div>
              <div class="coin"><span class="coin__label" data-i18n="P"></span>
                <input type="number" name="attr_p" placeholder="0"/>
              </div>
              <div class="coin"><span class="coin__label" data-i18n="S"></span>
                <input type="number" name="attr_s" placeholder="0"/>
              </div>
              <div class="coin"><span class="coin__label" data-i18n="G"></span>
                <input type="number" name="attr_g" placeholder="0"/>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="page spellmoves">
      <input class="spellicon_flag" type="hidden" name="attr_spellicon_flag" value="all"/>
      <div class="spells-body">
        <div class="spells">
          <div class="spells__features">
            <div class="features">
              <div class="features__label" data-i18n="feats-traits-u">FEATURES &amp; TRAITS</div>
              <fieldset class="repeating_traits">
                <div class="feature">
                  <input class="feature__flag--options" type="hidden" name="attr_options-flag" value="on"/>
                  <div class="feature__display"><span class="feature__title" name="attr_name"></span><span class="feature__subheader"><span name="attr_source"></span><span>: </span><span name="attr_source_type"></span></span></div>
                  <button class="feature__chat-button" type="roll" name="roll_output" value="@{wtype}&amp;{template:traits} @{charname_output} {{name=@{name}}} {{source=@{source}: @{source_type}}} {{description=@{description}}}">w</button>
                  <div class="feature__options-container">
                    <input class="feature__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                  </div>
                  <div class="feature__options options">
                    <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                      <input type="text" name="attr_name"/>
                    </div>
                    <div class="options__row"><span data-i18n="source:-u">SOURCE:</span>
                      <select name="attr_source">
                        <option selected="selected" data-i18n="racial">Racial</option>
                        <option data-i18n="class">Class</option>
                        <option data-i18n="feat">Feat</option>
                        <option data-i18n="background">Background</option>
                        <option data-i18n="other">Other</option>
                      </select>
                    </div>
                    <div class="options__row"><span data-i18n="source-type:-u">SOURCE TYPE:</span>
                      <input type="text" name="attr_source_type" placeholder="Dwarf/Fighter/4th Level"/>
                    </div>
                    <div class="options__row">
                      <textarea name="attr_description"></textarea>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
            <div class="moves">
              <div class="move-label move-label--undefined">
                <div class="move-label__numeral">
                  <div class="move-label__label"><span data-i18n="moves-u">Moves</span></div>
                  <button class="pictos" name="act_move-reset" type="action">1</button>
                  <button class="pictos" name="act_move-use" type="action">}</button>
                </div>
                <div class="move-label__total">
                  <div class="move-label__title" data-i18n="total"></div><span name="attr_moves_total"></span>
                  <input name="attr_moves_total" type="hidden" value="0"/>
                </div>
                <div class="move-label__expended">
                  <div class="move-label__title" data-i18n="current"></div>
                  <input type="number" name="attr_moves_expended" value="0"/>
                </div>
              </div>
              <fieldset class="repeating_moves">
                <div class="move">
                  <input class="move__flag--options" type="hidden" name="attr_options-flag" value="on"/><span class="move__title" name="attr_name"></span>
                  <button class="move__chat-button" type="roll" name="roll_output" value="@{wtype}&amp;{template:traits} @{charname_output} {{name=@{name}}} {{source=@{source}: @{source_type}}} {{description=@{description}}}">w</button>
                  <div class="move__options-container">
                    <input class="move__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                  </div>
                  <div class="move__options options">
                    <div class="options__row"><span data-i18n="name:-u">NAME:</span>
                      <input type="text" name="attr_name"/>
                    </div>
                    <div class="options__row--noborder"><span data-i18n="description:-u">DESCRIPTION:</span></div>
                    <div class="options__row">
                      <textarea name="attr_description"></textarea>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
          <div class="spells__stats">
            <div class="spellstats">
              <div class="spellstats__ability">
                <select name="attr_spellcasting_ability">
                  <option value="0*" data-i18n="None">None</option>
                  <option value="@{strength_mod}+" data-i18n="Strength">Strength</option>
                  <option value="@{dexterity_mod}+" data-i18n="Dexterity">Dexterity</option>
                  <option value="@{constitution_mod}+" data-i18n="Constitution">Constitution</option>
                  <option value="@{intelligence_mod}+" data-i18n="Intelligence">Intelligence</option>
                  <option value="@{wisdom_mod}+" data-i18n="Wisdom">Wisdom</option>
                  <option value="@{charisma_mod}+" data-i18n="Charisma">Charisma</option>
                </select><span class="spellstats__label" data-i18n="Spellcasting Ability">Spellcasting Ability</span>
              </div>
              <div class="spellstats__dc"><span class="spellstats__display" name="attr_spell_save_dc"></span><span class="spellstats__label" data-i18n="Spell Save DC">Spell Save DC</span></div>
              <div class="spellstats__attackbonus"><span class="spellstats__display" name="attr_spell_attack_bonus"></span><span class="spellstats__label" data-i18n="Spell Attack Bonus">Spell Attack Bonus</span></div>
            </div>
          </div>
          <div class="spells__section">
            <div class="spells__container">
              <div class="spell-label spell-label--0">
                <div class="spell-label__numeral">
                  <div class="spell-label__label"><span> Cantrips</span>
                  </div>
                </div>
              </div>
              <fieldset class="repeating_spell-cantrip">
                <div class="spell">
                  <!--input.spell__flag--details(type="hidden" name="attr_details-flag" checked="checked")-->
                  <input class="spell__flag--options" type="hidden" name="attr_options-flag" checked="checked"/>
                  <div class="spell__display">
                    <input type="hidden" name="attr_rollcontent" value="@{wtype}&amp;{template:spell} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{spell_save_dc}}} @{spellconcentration} @{charname_output}"/>
                    <button class="spell__card-button" type="roll" name="roll_spell" value="@{rollcontent}"><span class="spell__name" name="attr_spellname"></span><span class="spell__innate" name="attr_innate"></span></button>
                    <div class="spell__indicators">
                      <input class="spell__flag--innate" type="hidden" name="attr_innate" value=""/>
                      <input class="spell__flag--ritual" type="hidden" name="attr_spellritual" value="0"/>
                      <input class="spell__flag--concentration" type="hidden" name="attr_spellconcentration" value="0"/>
                      <div class="spell__casting-details"><span class="spell__ritual" data-i18n="spell-ritual">R</span><span class="spell__concentration" data-i18n="spell-concentration">C</span></div>
                      <input class="spell__flag--v" type="hidden" name="attr_spellcomp_v" value="{{v=1}}"/>
                      <input class="spell__flag--s" type="hidden" name="attr_spellcomp_s" value="{{s=1}}"/>
                      <input class="spell__flag--m" type="hidden" name="attr_spellcomp_m" value="{{m=1}}"/>
                      <div class="spell__components"><span class="spell__component--v" data-i18n="spell-component-verbal">V</span><span class="spell__component--s" data-i18n="spell-component-somatic">S</span><span class="spell__component--m" data-i18n="spell-component-material">M</span></div>
                    </div>
                    <input class="spell__flag--spellsave" type="hidden" name="attr_roll_output_dc" value="@{spell_save_dc}"/>
                    <button class="spell__chat-button output btn ui-draggable" type="roll" name="roll_output" value="@{wtype}&amp;{template:spelloutput} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{roll_output_dc}}} @{spellconcentration} @{charname_output}">w</button>
                    <!--.spell__details-container
                    input.spell__flag--details(type="checkbox" name="attr_details-flag" checked="checked")
                    span i
                    
                    -->
                    <div class="spell__options-container">
                      <input class="spell__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                    </div>
                  </div>
                  <div class="spell__options options">
                    <div class="options__row"><span class="options__label" data-i18n="name:-u">NAME:</span>
                      <input class="options__flex" type="text" name="attr_spellname"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="school:-u">SCHOOL:</span>
                      <select class="options__flex" name="attr_spellschool">
                        <option value="abjuration" data-i18n="abjuration">Abjuration</option>
                        <option value="conjuration" data-i18n="conjuration">Conjuration</option>
                        <option value="divination" data-i18n="divination">Divination</option>
                        <option value="enchantment" data-i18n="enchantment">Enchantment</option>
                        <option value="evocation" data-i18n="evocation">Evocation</option>
                        <option value="illusion" data-i18n="illusion">Illusion</option>
                        <option value="necromancy" data-i18n="necromancy">Necromancy</option>
                        <option value="transmutation" data-i18n="transmutation">Transmutation</option>
                      </select>
                      <input class="options__flex" type="checkbox" name="attr_spellritual" value="{{ritual=1}}"/><span class="options__label" data-i18n="ritual-u">RITUAL</span>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="casting-time:-u">CASTING TIME:</span>
                      <input class="options__flex" type="text" name="attr_spellcastingtime"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="range:-u">RANGE:</span>
                      <input class="options__flex" type="text" name="attr_spellrange"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="target:-u">TARGET:</span>
                      <input class="options__flex" type="text" name="attr_spelltarget"/>
                    </div>
                    <input type="hidden" name="attr_spellcomp"/>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="components:-u">COMPONENTS:</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_v" value="{{v=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-verbal">V</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_s" value="{{s=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-somatic">S</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_m" value="{{m=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-material">M</span>
                    </div>
                    <div class="options__row">
                      <input class="options__flex" type="text" name="attr_spellcomp_materials" placeholder="ruby dust worth 50gp" data-i18n-placeholder="ruby-dust-place"/>
                    </div>
                    <div class="options__row">
                      <input class="options__flex--1" type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}"/><span class="options__label options__flex--9" data-i18n="concentration-u">CONCENTRATION</span>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="duration:-u">DURATION:</span>
                      <input class="options__flex" type="text" name="attr_spellduration"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="spell-ability-u">SPELLCASTING ABILITY</span>
                      <select class="options__flex" name="attr_spell_ability">
                        <option value="0*" data-i18n="none-u">NONE</option>
                        <option value="spell" data-i18n="spell-u">SPELL</option>
                        <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
                        <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
                        <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
                        <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
                        <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
                        <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
                      </select>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="innate:-u">INNATE:</span>
                      <input class="options__flex" type="text" name="attr_innate" placeholder="1/day" value=""/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="output:-u">OUTPUT:</span>
                      <select class="options__flex" name="attr_spelloutput">
                        <option value="SPELLCARD" data-i18n="spellcard-u">SPELLCARD</option>
                        <option value="ATTACK" data-i18n="attack-u">ATTACK</option>
                      </select>
                    </div>
                    <input class="spell__flag--output" type="hidden" name="attr_spelloutput"/>
                    <div class="spell__options--attack">
                      <div class="options__row--noborder"><span class="options__label" data-i18n="spell-atk:-u">SPELL ATTACK:</span>
                        <select class="options__flex" name="attr_spellattack">
                          <option value="None" data-i18n="none">None</option>
                          <option value="Melee" data-i18n="melee">Melee</option>
                          <option value="Ranged" data-i18n="ranged">Ranged</option>
                        </select>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage:-u">DAMAGE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage2:-u">DAMAGE2:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage2"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype2"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="healing:-u">HEALING:</span>
                        <input type="text" name="attr_spellhealing"/>
                      </div>
                      <div class="options__row">
                        <input class="options__flex--1" type="checkbox" name="attr_spelldmgmod" value="Yes"/><span class="options__label options__flex--9" data-i18n="add-ability-mod-u">ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="cantrip-progression:-u">CANTRIP PROGRESSION</span>
                        <select class="options__flex" name="attr_spell_damage_progression">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="Cantrip Dice" data-i18n="cantrip-dice-u">CANTRIP DICE</option>
                          <option value="Cantrip Beam" data-i18n="cantrip-beam-u">CANTRIP BEAM</option>
                        </select>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="saving-throw:-u">SAVING THROW:</span>
                        <select name="attr_spellsave">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="Strength" data-i18n="str-u">STR</option>
                          <option value="Dexterity" data-i18n="dex-u">DEX</option>
                          <option value="Constitution" data-i18n="con-u">CON</option>
                          <option value="Intelligence" data-i18n="int-u">INT</option>
                          <option value="Wisdom" data-i18n="wis-u">WIS</option>
                          <option value="Charisma" data-i18n="cha-u">CHA</option>
                        </select>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="effect:-u">EFFECT:</span>
                        <input type="text" name="attr_spellsavesuccess" placeholder="Half damage" data-i18n-placeholder="half-dmg-place"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl-dmg:-u">HIGHER LVL CAST DMG:</span></div>
                      <div class="options__row">
                        <input class="options__flex--3" type="text" name="attr_`spellhldie" placeholder="1"/>
                        <select class="options__flex--3" name="attr_spellhldietype">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="d4">d4</option>
                          <option value="d6">d6</option>
                          <option value="d8">d8</option>
                          <option value="d10">d10</option>
                          <option value="d12">d12</option>
                          <option value="d20">d20</option>
                        </select><span class="options__flex--1">+</span>
                        <input class="options__flex--3" type="text" name="attr_spellhlbonus" placeholder="0"/>
                      </div>
                      <div class="options__row"><span class="options__label options__flex--7" data-i18n="include_spell_desc:-u">INCLUDE SPELL DESCRIPTION IN ATTACK:</span>
                        <select class="options__flex--3" name="attr_includedesc">
                          <option value="off" selected="selected" data-i18n="off">Off</option>
                          <option value="partial" data-i18n="partial">Partial</option>
                          <option value="on" data-i18n="on">On</option>
                        </select>
                      </div>
                    </div>
                    <div class="options__row options__row--topborder"><span class="options__label" data-i18n="description:-u">DESCRIPTION:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spelldescription"></textarea>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="class:-u">CLASS:</span>
                      <input type="text" name="attr_spellclass"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="type:-u">TYPE:</span>
                      <input type="text" name="attr_spellsource"/>
                    </div>
                    <input type="hidden" name="attr_spellattackid"/>
                    <input type="hidden" name="attr_spelllevel" value="cantrip"/>
                  </div>
                </div>
              </fieldset>
            </div>
            <div class="spells__container">
              <div class="spell-label spell-label--1">
                <div class="spell-label__numeral">
                  <div class="spell-label__label"><span data-i18n="Level"></span><span> 1</span>
                  </div>
                  <button class="pictos" name="act_spell-reset-1" type="action">1</button>
                  <button class="pictos" name="act_spell-use-1" type="action">}</button>
                </div>
                <div class="spell-label__total">
                  <div class="spell-label__title" data-i18n="total"></div><span name="attr_lvl1_slots_total"></span>
                </div>
                <div class="spell-label__expended">
                  <div class="spell-label__title" data-i18n="current"></div>
                  <input type="number" name="attr_lvl1_slots_expended" value="0"/>
                </div>
              </div>
              <fieldset class="repeating_spell-1">
                <div class="spell">
                  <!--input.spell__flag--details(type="hidden" name="attr_details-flag" checked="checked")-->
                  <input class="spell__flag--options" type="hidden" name="attr_options-flag" checked="checked"/>
                  <div class="spell__display">
                    <input type="hidden" name="attr_rollcontent" value="@{wtype}&amp;{template:spell} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{spell_save_dc}}} @{spellconcentration} @{charname_output}"/>
                    <div class="spell__prepped">
                      <input class="spell__prepped-input" type="checkbox" name="attr_spellprepared" value="1"/><span class="spell__prepped-mark"></span>
                    </div>
                    <button class="spell__card-button" type="roll" name="roll_spell" value="@{rollcontent}"><span class="spell__name" name="attr_spellname"></span><span class="spell__innate" name="attr_innate"></span></button>
                    <div class="spell__indicators">
                      <input class="spell__flag--innate" type="hidden" name="attr_innate" value=""/>
                      <input class="spell__flag--ritual" type="hidden" name="attr_spellritual" value="0"/>
                      <input class="spell__flag--concentration" type="hidden" name="attr_spellconcentration" value="0"/>
                      <div class="spell__casting-details"><span class="spell__ritual" data-i18n="spell-ritual">R</span><span class="spell__concentration" data-i18n="spell-concentration">C</span></div>
                      <input class="spell__flag--v" type="hidden" name="attr_spellcomp_v" value="{{v=1}}"/>
                      <input class="spell__flag--s" type="hidden" name="attr_spellcomp_s" value="{{s=1}}"/>
                      <input class="spell__flag--m" type="hidden" name="attr_spellcomp_m" value="{{m=1}}"/>
                      <div class="spell__components"><span class="spell__component--v" data-i18n="spell-component-verbal">V</span><span class="spell__component--s" data-i18n="spell-component-somatic">S</span><span class="spell__component--m" data-i18n="spell-component-material">M</span></div>
                    </div>
                    <input class="spell__flag--spellsave" type="hidden" name="attr_roll_output_dc" value="@{spell_save_dc}"/>
                    <button class="spell__chat-button output btn ui-draggable" type="roll" name="roll_output" value="@{wtype}&amp;{template:spelloutput} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{roll_output_dc}}} @{spellconcentration} @{charname_output}">w</button>
                    <!--.spell__details-container
                    input.spell__flag--details(type="checkbox" name="attr_details-flag" checked="checked")
                    span i
                    
                    -->
                    <div class="spell__options-container">
                      <input class="spell__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                    </div>
                  </div>
                  <div class="spell__options options">
                    <div class="options__row"><span class="options__label" data-i18n="name:-u">NAME:</span>
                      <input class="options__flex" type="text" name="attr_spellname"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="school:-u">SCHOOL:</span>
                      <select class="options__flex" name="attr_spellschool">
                        <option value="abjuration" data-i18n="abjuration">Abjuration</option>
                        <option value="conjuration" data-i18n="conjuration">Conjuration</option>
                        <option value="divination" data-i18n="divination">Divination</option>
                        <option value="enchantment" data-i18n="enchantment">Enchantment</option>
                        <option value="evocation" data-i18n="evocation">Evocation</option>
                        <option value="illusion" data-i18n="illusion">Illusion</option>
                        <option value="necromancy" data-i18n="necromancy">Necromancy</option>
                        <option value="transmutation" data-i18n="transmutation">Transmutation</option>
                      </select>
                      <input class="options__flex" type="checkbox" name="attr_spellritual" value="{{ritual=1}}"/><span class="options__label" data-i18n="ritual-u">RITUAL</span>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="casting-time:-u">CASTING TIME:</span>
                      <input class="options__flex" type="text" name="attr_spellcastingtime"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="range:-u">RANGE:</span>
                      <input class="options__flex" type="text" name="attr_spellrange"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="target:-u">TARGET:</span>
                      <input class="options__flex" type="text" name="attr_spelltarget"/>
                    </div>
                    <input type="hidden" name="attr_spellcomp"/>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="components:-u">COMPONENTS:</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_v" value="{{v=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-verbal">V</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_s" value="{{s=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-somatic">S</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_m" value="{{m=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-material">M</span>
                    </div>
                    <div class="options__row">
                      <input class="options__flex" type="text" name="attr_spellcomp_materials" placeholder="ruby dust worth 50gp" data-i18n-placeholder="ruby-dust-place"/>
                    </div>
                    <div class="options__row">
                      <input class="options__flex--1" type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}"/><span class="options__label options__flex--9" data-i18n="concentration-u">CONCENTRATION</span>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="duration:-u">DURATION:</span>
                      <input class="options__flex" type="text" name="attr_spellduration"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="spell-ability-u">SPELLCASTING ABILITY</span>
                      <select class="options__flex" name="attr_spell_ability">
                        <option value="0*" data-i18n="none-u">NONE</option>
                        <option value="spell" data-i18n="spell-u">SPELL</option>
                        <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
                        <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
                        <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
                        <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
                        <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
                        <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
                      </select>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="innate:-u">INNATE:</span>
                      <input class="options__flex" type="text" name="attr_innate" placeholder="1/day" value=""/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="output:-u">OUTPUT:</span>
                      <select class="options__flex" name="attr_spelloutput">
                        <option value="SPELLCARD" data-i18n="spellcard-u">SPELLCARD</option>
                        <option value="ATTACK" data-i18n="attack-u">ATTACK</option>
                      </select>
                    </div>
                    <input class="spell__flag--output" type="hidden" name="attr_spelloutput"/>
                    <div class="spell__options--attack">
                      <div class="options__row--noborder"><span class="options__label" data-i18n="spell-atk:-u">SPELL ATTACK:</span>
                        <select class="options__flex" name="attr_spellattack">
                          <option value="None" data-i18n="none">None</option>
                          <option value="Melee" data-i18n="melee">Melee</option>
                          <option value="Ranged" data-i18n="ranged">Ranged</option>
                        </select>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage:-u">DAMAGE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage2:-u">DAMAGE2:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage2"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype2"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="healing:-u">HEALING:</span>
                        <input type="text" name="attr_spellhealing"/>
                      </div>
                      <div class="options__row">
                        <input class="options__flex--1" type="checkbox" name="attr_spelldmgmod" value="Yes"/><span class="options__label options__flex--9" data-i18n="add-ability-mod-u">ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="saving-throw:-u">SAVING THROW:</span>
                        <select name="attr_spellsave">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="Strength" data-i18n="str-u">STR</option>
                          <option value="Dexterity" data-i18n="dex-u">DEX</option>
                          <option value="Constitution" data-i18n="con-u">CON</option>
                          <option value="Intelligence" data-i18n="int-u">INT</option>
                          <option value="Wisdom" data-i18n="wis-u">WIS</option>
                          <option value="Charisma" data-i18n="cha-u">CHA</option>
                        </select>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="effect:-u">EFFECT:</span>
                        <input type="text" name="attr_spellsavesuccess" placeholder="Half damage" data-i18n-placeholder="half-dmg-place"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl-dmg:-u">HIGHER LVL CAST DMG:</span></div>
                      <div class="options__row">
                        <input class="options__flex--3" type="text" name="attr_`spellhldie" placeholder="1"/>
                        <select class="options__flex--3" name="attr_spellhldietype">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="d4">d4</option>
                          <option value="d6">d6</option>
                          <option value="d8">d8</option>
                          <option value="d10">d10</option>
                          <option value="d12">d12</option>
                          <option value="d20">d20</option>
                        </select><span class="options__flex--1">+</span>
                        <input class="options__flex--3" type="text" name="attr_spellhlbonus" placeholder="0"/>
                      </div>
                      <div class="options__row"><span class="options__label options__flex--7" data-i18n="include_spell_desc:-u">INCLUDE SPELL DESCRIPTION IN ATTACK:</span>
                        <select class="options__flex--3" name="attr_includedesc">
                          <option value="off" selected="selected" data-i18n="off">Off</option>
                          <option value="partial" data-i18n="partial">Partial</option>
                          <option value="on" data-i18n="on">On</option>
                        </select>
                      </div>
                    </div>
                    <div class="options__row options__row--topborder"><span class="options__label" data-i18n="description:-u">DESCRIPTION:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spelldescription"></textarea>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl:-u">AT HIGHER LEVELS:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spellathigherlevels"></textarea>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="class:-u">CLASS:</span>
                      <input type="text" name="attr_spellclass"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="type:-u">TYPE:</span>
                      <input type="text" name="attr_spellsource"/>
                    </div>
                    <input type="hidden" name="attr_spellattackid"/>
                    <input type="hidden" name="attr_spelllevel" value="1"/>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
          <div class="spells__section">
            <div class="spells__container">
              <div class="spell-label spell-label--2">
                <div class="spell-label__numeral">
                  <div class="spell-label__label"><span data-i18n="Level"></span><span> 2</span>
                  </div>
                  <button class="pictos" name="act_spell-reset-2" type="action">1</button>
                  <button class="pictos" name="act_spell-use-2" type="action">}</button>
                </div>
                <div class="spell-label__total">
                  <div class="spell-label__title" data-i18n="total"></div><span name="attr_lvl2_slots_total"></span>
                </div>
                <div class="spell-label__expended">
                  <div class="spell-label__title" data-i18n="current"></div>
                  <input type="number" name="attr_lvl2_slots_expended" value="0"/>
                </div>
              </div>
              <fieldset class="repeating_spell-2">
                <div class="spell">
                  <!--input.spell__flag--details(type="hidden" name="attr_details-flag" checked="checked")-->
                  <input class="spell__flag--options" type="hidden" name="attr_options-flag" checked="checked"/>
                  <div class="spell__display">
                    <input type="hidden" name="attr_rollcontent" value="@{wtype}&amp;{template:spell} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{spell_save_dc}}} @{spellconcentration} @{charname_output}"/>
                    <div class="spell__prepped">
                      <input class="spell__prepped-input" type="checkbox" name="attr_spellprepared" value="1"/><span class="spell__prepped-mark"></span>
                    </div>
                    <button class="spell__card-button" type="roll" name="roll_spell" value="@{rollcontent}"><span class="spell__name" name="attr_spellname"></span><span class="spell__innate" name="attr_innate"></span></button>
                    <div class="spell__indicators">
                      <input class="spell__flag--innate" type="hidden" name="attr_innate" value=""/>
                      <input class="spell__flag--ritual" type="hidden" name="attr_spellritual" value="0"/>
                      <input class="spell__flag--concentration" type="hidden" name="attr_spellconcentration" value="0"/>
                      <div class="spell__casting-details"><span class="spell__ritual" data-i18n="spell-ritual">R</span><span class="spell__concentration" data-i18n="spell-concentration">C</span></div>
                      <input class="spell__flag--v" type="hidden" name="attr_spellcomp_v" value="{{v=1}}"/>
                      <input class="spell__flag--s" type="hidden" name="attr_spellcomp_s" value="{{s=1}}"/>
                      <input class="spell__flag--m" type="hidden" name="attr_spellcomp_m" value="{{m=1}}"/>
                      <div class="spell__components"><span class="spell__component--v" data-i18n="spell-component-verbal">V</span><span class="spell__component--s" data-i18n="spell-component-somatic">S</span><span class="spell__component--m" data-i18n="spell-component-material">M</span></div>
                    </div>
                    <input class="spell__flag--spellsave" type="hidden" name="attr_roll_output_dc" value="@{spell_save_dc}"/>
                    <button class="spell__chat-button output btn ui-draggable" type="roll" name="roll_output" value="@{wtype}&amp;{template:spelloutput} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{roll_output_dc}}} @{spellconcentration} @{charname_output}">w</button>
                    <!--.spell__details-container
                    input.spell__flag--details(type="checkbox" name="attr_details-flag" checked="checked")
                    span i
                    
                    -->
                    <div class="spell__options-container">
                      <input class="spell__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                    </div>
                  </div>
                  <div class="spell__options options">
                    <div class="options__row"><span class="options__label" data-i18n="name:-u">NAME:</span>
                      <input class="options__flex" type="text" name="attr_spellname"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="school:-u">SCHOOL:</span>
                      <select class="options__flex" name="attr_spellschool">
                        <option value="abjuration" data-i18n="abjuration">Abjuration</option>
                        <option value="conjuration" data-i18n="conjuration">Conjuration</option>
                        <option value="divination" data-i18n="divination">Divination</option>
                        <option value="enchantment" data-i18n="enchantment">Enchantment</option>
                        <option value="evocation" data-i18n="evocation">Evocation</option>
                        <option value="illusion" data-i18n="illusion">Illusion</option>
                        <option value="necromancy" data-i18n="necromancy">Necromancy</option>
                        <option value="transmutation" data-i18n="transmutation">Transmutation</option>
                      </select>
                      <input class="options__flex" type="checkbox" name="attr_spellritual" value="{{ritual=1}}"/><span class="options__label" data-i18n="ritual-u">RITUAL</span>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="casting-time:-u">CASTING TIME:</span>
                      <input class="options__flex" type="text" name="attr_spellcastingtime"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="range:-u">RANGE:</span>
                      <input class="options__flex" type="text" name="attr_spellrange"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="target:-u">TARGET:</span>
                      <input class="options__flex" type="text" name="attr_spelltarget"/>
                    </div>
                    <input type="hidden" name="attr_spellcomp"/>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="components:-u">COMPONENTS:</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_v" value="{{v=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-verbal">V</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_s" value="{{s=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-somatic">S</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_m" value="{{m=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-material">M</span>
                    </div>
                    <div class="options__row">
                      <input class="options__flex" type="text" name="attr_spellcomp_materials" placeholder="ruby dust worth 50gp" data-i18n-placeholder="ruby-dust-place"/>
                    </div>
                    <div class="options__row">
                      <input class="options__flex--1" type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}"/><span class="options__label options__flex--9" data-i18n="concentration-u">CONCENTRATION</span>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="duration:-u">DURATION:</span>
                      <input class="options__flex" type="text" name="attr_spellduration"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="spell-ability-u">SPELLCASTING ABILITY</span>
                      <select class="options__flex" name="attr_spell_ability">
                        <option value="0*" data-i18n="none-u">NONE</option>
                        <option value="spell" data-i18n="spell-u">SPELL</option>
                        <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
                        <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
                        <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
                        <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
                        <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
                        <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
                      </select>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="innate:-u">INNATE:</span>
                      <input class="options__flex" type="text" name="attr_innate" placeholder="1/day" value=""/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="output:-u">OUTPUT:</span>
                      <select class="options__flex" name="attr_spelloutput">
                        <option value="SPELLCARD" data-i18n="spellcard-u">SPELLCARD</option>
                        <option value="ATTACK" data-i18n="attack-u">ATTACK</option>
                      </select>
                    </div>
                    <input class="spell__flag--output" type="hidden" name="attr_spelloutput"/>
                    <div class="spell__options--attack">
                      <div class="options__row--noborder"><span class="options__label" data-i18n="spell-atk:-u">SPELL ATTACK:</span>
                        <select class="options__flex" name="attr_spellattack">
                          <option value="None" data-i18n="none">None</option>
                          <option value="Melee" data-i18n="melee">Melee</option>
                          <option value="Ranged" data-i18n="ranged">Ranged</option>
                        </select>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage:-u">DAMAGE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage2:-u">DAMAGE2:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage2"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype2"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="healing:-u">HEALING:</span>
                        <input type="text" name="attr_spellhealing"/>
                      </div>
                      <div class="options__row">
                        <input class="options__flex--1" type="checkbox" name="attr_spelldmgmod" value="Yes"/><span class="options__label options__flex--9" data-i18n="add-ability-mod-u">ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="saving-throw:-u">SAVING THROW:</span>
                        <select name="attr_spellsave">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="Strength" data-i18n="str-u">STR</option>
                          <option value="Dexterity" data-i18n="dex-u">DEX</option>
                          <option value="Constitution" data-i18n="con-u">CON</option>
                          <option value="Intelligence" data-i18n="int-u">INT</option>
                          <option value="Wisdom" data-i18n="wis-u">WIS</option>
                          <option value="Charisma" data-i18n="cha-u">CHA</option>
                        </select>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="effect:-u">EFFECT:</span>
                        <input type="text" name="attr_spellsavesuccess" placeholder="Half damage" data-i18n-placeholder="half-dmg-place"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl-dmg:-u">HIGHER LVL CAST DMG:</span></div>
                      <div class="options__row">
                        <input class="options__flex--3" type="text" name="attr_`spellhldie" placeholder="1"/>
                        <select class="options__flex--3" name="attr_spellhldietype">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="d4">d4</option>
                          <option value="d6">d6</option>
                          <option value="d8">d8</option>
                          <option value="d10">d10</option>
                          <option value="d12">d12</option>
                          <option value="d20">d20</option>
                        </select><span class="options__flex--1">+</span>
                        <input class="options__flex--3" type="text" name="attr_spellhlbonus" placeholder="0"/>
                      </div>
                      <div class="options__row"><span class="options__label options__flex--7" data-i18n="include_spell_desc:-u">INCLUDE SPELL DESCRIPTION IN ATTACK:</span>
                        <select class="options__flex--3" name="attr_includedesc">
                          <option value="off" selected="selected" data-i18n="off">Off</option>
                          <option value="partial" data-i18n="partial">Partial</option>
                          <option value="on" data-i18n="on">On</option>
                        </select>
                      </div>
                    </div>
                    <div class="options__row options__row--topborder"><span class="options__label" data-i18n="description:-u">DESCRIPTION:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spelldescription"></textarea>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl:-u">AT HIGHER LEVELS:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spellathigherlevels"></textarea>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="class:-u">CLASS:</span>
                      <input type="text" name="attr_spellclass"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="type:-u">TYPE:</span>
                      <input type="text" name="attr_spellsource"/>
                    </div>
                    <input type="hidden" name="attr_spellattackid"/>
                    <input type="hidden" name="attr_spelllevel" value="2"/>
                  </div>
                </div>
              </fieldset>
            </div>
            <div class="spells__container">
              <div class="spell-label spell-label--3">
                <div class="spell-label__numeral">
                  <div class="spell-label__label"><span data-i18n="Level"></span><span> 3</span>
                  </div>
                  <button class="pictos" name="act_spell-reset-3" type="action">1</button>
                  <button class="pictos" name="act_spell-use-3" type="action">}</button>
                </div>
                <div class="spell-label__total">
                  <div class="spell-label__title" data-i18n="total"></div><span name="attr_lvl3_slots_total"></span>
                </div>
                <div class="spell-label__expended">
                  <div class="spell-label__title" data-i18n="current"></div>
                  <input type="number" name="attr_lvl3_slots_expended" value="0"/>
                </div>
              </div>
              <fieldset class="repeating_spell-3">
                <div class="spell">
                  <!--input.spell__flag--details(type="hidden" name="attr_details-flag" checked="checked")-->
                  <input class="spell__flag--options" type="hidden" name="attr_options-flag" checked="checked"/>
                  <div class="spell__display">
                    <input type="hidden" name="attr_rollcontent" value="@{wtype}&amp;{template:spell} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{spell_save_dc}}} @{spellconcentration} @{charname_output}"/>
                    <div class="spell__prepped">
                      <input class="spell__prepped-input" type="checkbox" name="attr_spellprepared" value="1"/><span class="spell__prepped-mark"></span>
                    </div>
                    <button class="spell__card-button" type="roll" name="roll_spell" value="@{rollcontent}"><span class="spell__name" name="attr_spellname"></span><span class="spell__innate" name="attr_innate"></span></button>
                    <div class="spell__indicators">
                      <input class="spell__flag--innate" type="hidden" name="attr_innate" value=""/>
                      <input class="spell__flag--ritual" type="hidden" name="attr_spellritual" value="0"/>
                      <input class="spell__flag--concentration" type="hidden" name="attr_spellconcentration" value="0"/>
                      <div class="spell__casting-details"><span class="spell__ritual" data-i18n="spell-ritual">R</span><span class="spell__concentration" data-i18n="spell-concentration">C</span></div>
                      <input class="spell__flag--v" type="hidden" name="attr_spellcomp_v" value="{{v=1}}"/>
                      <input class="spell__flag--s" type="hidden" name="attr_spellcomp_s" value="{{s=1}}"/>
                      <input class="spell__flag--m" type="hidden" name="attr_spellcomp_m" value="{{m=1}}"/>
                      <div class="spell__components"><span class="spell__component--v" data-i18n="spell-component-verbal">V</span><span class="spell__component--s" data-i18n="spell-component-somatic">S</span><span class="spell__component--m" data-i18n="spell-component-material">M</span></div>
                    </div>
                    <input class="spell__flag--spellsave" type="hidden" name="attr_roll_output_dc" value="@{spell_save_dc}"/>
                    <button class="spell__chat-button output btn ui-draggable" type="roll" name="roll_output" value="@{wtype}&amp;{template:spelloutput} {{level=@{spellschool} @{spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{roll_output_dc}}} @{spellconcentration} @{charname_output}">w</button>
                    <!--.spell__details-container
                    input.spell__flag--details(type="checkbox" name="attr_details-flag" checked="checked")
                    span i
                    
                    -->
                    <div class="spell__options-container">
                      <input class="spell__flag--options" type="checkbox" name="attr_options-flag" checked="checked"/><span>y</span>
                    </div>
                  </div>
                  <div class="spell__options options">
                    <div class="options__row"><span class="options__label" data-i18n="name:-u">NAME:</span>
                      <input class="options__flex" type="text" name="attr_spellname"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="school:-u">SCHOOL:</span>
                      <select class="options__flex" name="attr_spellschool">
                        <option value="abjuration" data-i18n="abjuration">Abjuration</option>
                        <option value="conjuration" data-i18n="conjuration">Conjuration</option>
                        <option value="divination" data-i18n="divination">Divination</option>
                        <option value="enchantment" data-i18n="enchantment">Enchantment</option>
                        <option value="evocation" data-i18n="evocation">Evocation</option>
                        <option value="illusion" data-i18n="illusion">Illusion</option>
                        <option value="necromancy" data-i18n="necromancy">Necromancy</option>
                        <option value="transmutation" data-i18n="transmutation">Transmutation</option>
                      </select>
                      <input class="options__flex" type="checkbox" name="attr_spellritual" value="{{ritual=1}}"/><span class="options__label" data-i18n="ritual-u">RITUAL</span>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="casting-time:-u">CASTING TIME:</span>
                      <input class="options__flex" type="text" name="attr_spellcastingtime"/>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="range:-u">RANGE:</span>
                      <input class="options__flex" type="text" name="attr_spellrange"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="target:-u">TARGET:</span>
                      <input class="options__flex" type="text" name="attr_spelltarget"/>
                    </div>
                    <input type="hidden" name="attr_spellcomp"/>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="components:-u">COMPONENTS:</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_v" value="{{v=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-verbal">V</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_s" value="{{s=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-somatic">S</span>
                      <input class="options__flex" type="checkbox" name="attr_spellcomp_m" value="{{m=1}}" checked="checked"/><span class="options__label" data-i18n="spell-component-material">M</span>
                    </div>
                    <div class="options__row">
                      <input class="options__flex" type="text" name="attr_spellcomp_materials" placeholder="ruby dust worth 50gp" data-i18n-placeholder="ruby-dust-place"/>
                    </div>
                    <div class="options__row">
                      <input class="options__flex--1" type="checkbox" name="attr_spellconcentration" value="{{concentration=1}}"/><span class="options__label options__flex--9" data-i18n="concentration-u">CONCENTRATION</span>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="duration:-u">DURATION:</span>
                      <input class="options__flex" type="text" name="attr_spellduration"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="spell-ability-u">SPELLCASTING ABILITY</span>
                      <select class="options__flex" name="attr_spell_ability">
                        <option value="0*" data-i18n="none-u">NONE</option>
                        <option value="spell" data-i18n="spell-u">SPELL</option>
                        <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
                        <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
                        <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
                        <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
                        <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
                        <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
                      </select>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="innate:-u">INNATE:</span>
                      <input class="options__flex" type="text" name="attr_innate" placeholder="1/day" value=""/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="output:-u">OUTPUT:</span>
                      <select class="options__flex" name="attr_spelloutput">
                        <option value="SPELLCARD" data-i18n="spellcard-u">SPELLCARD</option>
                        <option value="ATTACK" data-i18n="attack-u">ATTACK</option>
                      </select>
                    </div>
                    <input class="spell__flag--output" type="hidden" name="attr_spelloutput"/>
                    <div class="spell__options--attack">
                      <div class="options__row--noborder"><span class="options__label" data-i18n="spell-atk:-u">SPELL ATTACK:</span>
                        <select class="options__flex" name="attr_spellattack">
                          <option value="None" data-i18n="none">None</option>
                          <option value="Melee" data-i18n="melee">Melee</option>
                          <option value="Ranged" data-i18n="ranged">Ranged</option>
                        </select>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage:-u">DAMAGE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="damage2:-u">DAMAGE2:</span>
                        <input class="options__flex" type="text" name="attr_spelldamage2"/><span class="options__label" data-i18n="type:-u">TYPE:</span>
                        <input class="options__flex" type="text" name="attr_spelldamagetype2"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="healing:-u">HEALING:</span>
                        <input type="text" name="attr_spellhealing"/>
                      </div>
                      <div class="options__row">
                        <input class="options__flex--1" type="checkbox" name="attr_spelldmgmod" value="Yes"/><span class="options__label options__flex--9" data-i18n="add-ability-mod-u">ADD ABILITY MOD TO DAMAGE OR HEALING</span>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="saving-throw:-u">SAVING THROW:</span>
                        <select name="attr_spellsave">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="Strength" data-i18n="str-u">STR</option>
                          <option value="Dexterity" data-i18n="dex-u">DEX</option>
                          <option value="Constitution" data-i18n="con-u">CON</option>
                          <option value="Intelligence" data-i18n="int-u">INT</option>
                          <option value="Wisdom" data-i18n="wis-u">WIS</option>
                          <option value="Charisma" data-i18n="cha-u">CHA</option>
                        </select>
                      </div>
                      <div class="options__row"><span class="options__label" data-i18n="effect:-u">EFFECT:</span>
                        <input type="text" name="attr_spellsavesuccess" placeholder="Half damage" data-i18n-placeholder="half-dmg-place"/>
                      </div>
                      <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl-dmg:-u">HIGHER LVL CAST DMG:</span></div>
                      <div class="options__row">
                        <input class="options__flex--3" type="text" name="attr_`spellhldie" placeholder="1"/>
                        <select class="options__flex--3" name="attr_spellhldietype">
                          <option value="" selected="selected" data-i18n="none-u">NONE</option>
                          <option value="d4">d4</option>
                          <option value="d6">d6</option>
                          <option value="d8">d8</option>
                          <option value="d10">d10</option>
                          <option value="d12">d12</option>
                          <option value="d20">d20</option>
                        </select><span class="options__flex--1">+</span>
                        <input class="options__flex--3" type="text" name="attr_spellhlbonus" placeholder="0"/>
                      </div>
                      <div class="options__row"><span class="options__label options__flex--7" data-i18n="include_spell_desc:-u">INCLUDE SPELL DESCRIPTION IN ATTACK:</span>
                        <select class="options__flex--3" name="attr_includedesc">
                          <option value="off" selected="selected" data-i18n="off">Off</option>
                          <option value="partial" data-i18n="partial">Partial</option>
                          <option value="on" data-i18n="on">On</option>
                        </select>
                      </div>
                    </div>
                    <div class="options__row options__row--topborder"><span class="options__label" data-i18n="description:-u">DESCRIPTION:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spelldescription"></textarea>
                    </div>
                    <div class="options__row options__row--noborder"><span class="options__label" data-i18n="at-higher-lvl:-u">AT HIGHER LEVELS:</span></div>
                    <div class="options__row">
                      <textarea name="attr_spellathigherlevels"></textarea>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="class:-u">CLASS:</span>
                      <input type="text" name="attr_spellclass"/>
                    </div>
                    <div class="options__row"><span class="options__label" data-i18n="type:-u">TYPE:</span>
                      <input type="text" name="attr_spellsource"/>
                    </div>
                    <input type="hidden" name="attr_spellattackid"/>
                    <input type="hidden" name="attr_spelllevel" value="3"/>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="page bio">
      <div class="bio-body">
        <div class="appearance"><span class="appearance__label" data-i18n="Appearance">Appearance</span>
          <div class="appearance__row">
            <div class="appearance__title" data-i18n="Build"></div>
            <input class="appearance__input" name="attr_build" type="text"/>
          </div>
          <div class="appearance__row">
            <div class="appearance__title" data-i18n="Eyes"></div>
            <input class="appearance__input" name="attr_eyes" type="text"/>
          </div>
          <div class="appearance__row">
            <div class="appearance__title" data-i18n="Hair"></div>
            <input class="appearance__input" name="attr_hair" type="text"/>
          </div>
          <div class="appearance__row">
            <div class="appearance__title" data-i18n="Skin"></div>
            <input class="appearance__input" name="attr_skin" type="text"/>
          </div>
        </div>
        <div class="personalitytrait">
          <div class="personalitytrait__label" data-i18n="Misdeeds"></div>
          <textarea name="attr_misdeeds"></textarea>
        </div>
        <div class="personalitytrait">
          <div class="personalitytrait__label" data-i18n="Allies &amp; Organizations"></div>
          <textarea name="attr_allies_organizations"></textarea>
        </div>
        <div class="personalitytrait">
          <div class="personalitytrait__label" data-i18n="Backstory"></div>
          <textarea name="attr_backstory"></textarea>
        </div>
        <div class="personalitytrait">
          <div class="personalitytrait__label" data-i18n="Backpack"></div>
          <textarea name="attr_backpack"></textarea>
        </div>
        <div class="personalitytrait">
          <div class="personalitytrait__label" data-i18n="Notes"></div>
          <textarea name="attr_notes"></textarea>
        </div>
      </div>
    </div>
    <div class="page settings">
      <div class="settings-body">
        <div class="settings__col">
          <div class="options">
            <div class="options__row"><span data-i18n="hit-die:-u">HIT DIE:</span>
              <select name="attr_hitdietype">
                <option value="4">D4</option>
                <option value="6">D6</option>
                <option value="8">D8</option>
                <option value="10">D10</option>
                <option value="12">D12</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="carrying-capacity-mod:-u">CARRYING CAPACITY MODIFIER:</span>
              <input type="text" name="attr_carrying_capacity_mod" placeholder="*2"/>
            </div>
            <div class="options__row"><span data-i18n="glob-atk-mod:-u">GLOBAL MAGIC ATTACK MODIFIER:</span>
              <input type="text" name="attr_globalmagicmod" placeholder="0" value="0"/>
            </div>
            <div class="options__row"><span data-i18n="magic-use-lvl:-u">MAGIC CASTER LEVEL:</span>
              <input type="text" name="attr_caster_level"/>
            </div>
            <div class="options__row"><span data-i18n="spell_dc_mod:-u">SPELL SAVE DC MOD:</span>
              <input type="text" name="attr_spell_dc_mod" placeholder="0" value="0"/>
            </div>
            <div class="options__row--title"><span data-i18n="class-options-u">CLASS OPTIONS </span>( <span name="attr_class"></span>)</div>
          </div>
          <div class="options">
            <input type="hidden" name="attr_custom_class" value="1"/>
            <div class="options__row"><span data-i18n="class-name:-u">CLASS NAME:</span>
              <input type="text" name="attr_cust_classname"/>
            </div>
            <div class="options__row"><span data-i18n="hit-die:-u">HIT DIE:</span>
              <select name="attr_cust_hitdietype">
                <option value="4">D4</option>
                <option value="6">D6</option>
                <option value="8">D8</option>
                <option value="10">D10</option>
                <option value="12">D12</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="spellcasting-ability:-u">SPELLCASTING ABILITY:</span>
              <select name="attr_cust_spellcasting_ability">
                <option value="0*" data-i18n="none-u">NONE</option>
                <option value="@{strength_mod}+" data-i18n="strength-u">STRENGTH</option>
                <option value="@{dexterity_mod}+" data-i18n="dexterity-u">DEXTERITY</option>
                <option value="@{constitution_mod}+" data-i18n="constitution-u">CONSTITUTION</option>
                <option value="@{intelligence_mod}+" data-i18n="intelligence-u">INTELLIGENCE</option>
                <option value="@{wisdom_mod}+" data-i18n="wisdom-u">WISDOM</option>
                <option value="@{charisma_mod}+" data-i18n="charisma-u">CHARISMA</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="spell-slots:-u">SPELL SLOTS:</span>
              <select name="attr_cust_spellslots">
                <option value="none" data-i18n="none-u">NONE</option>
                <option value="full" data-i18n="spell-full-u">FULL (Cleric, Druid, Wizard)</option>
                <option value="half" data-i18n="spell-half-u">HALF (Artificer, Paladin, Ranger)</option>
                <option value="third" data-i18n="spell-third-u">THIRD (Arcane Fighter/Rogue)</option>
              </select>
            </div>
            <div class="options__row--title"><span data-i18n="saves-u">SAVES</span></div>
            <div class="options__row options__row--noborder">
              <input class="options__flex--1" type="checkbox" name="attr_cust_strength_save_prof" value="(@{pb})"/><span data-i18n="strength">Strength</span>
              <input class="options__flex--1" type="checkbox" name="attr_cust_dexterity_save_prof" value="(@{pb})"/><span data-i18n="dexterity">Dexterity</span>
            </div>
            <div class="options__row options__row--noborder">
              <input class="options__flex--1" type="checkbox" name="attr_cust_constitution_save_prof" value="(@{pb})"/><span data-i18n="constitution">Constitution</span>
              <input class="options__flex--1" type="checkbox" name="attr_cust_intelligence_save_prof" value="(@{pb})"/><span data-i18n="intelligence">Intelligence</span>
            </div>
            <div class="options__row">
              <input class="options__flex--1" type="checkbox" name="attr_cust_wisdom_save_prof" value="(@{pb})"/><span data-i18n="wisdom">Wisdom</span>
              <input class="options__flex--1" type="checkbox" name="attr_cust_charisma_save_prof" value="(@{pb})"/><span data-i18n="charisma">Charisma</span>
            </div>
            <div class="options__row--title"><span data-i18n="cust-class-opts">CUSTOM CLASS OPTIONS</span></div>
          </div>
          <div class="options spell_slot_mods">
            <div class="options__row">
              <div class="options__flex--2"><span data-i18n="lvl-u">LEVEL</span><span class="options__flex">1</span></div><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_lvl1_slots_mod" value="0" placeholder="0" title="@{lvl1_slots_mod}"/>
              <div class="options__flex--2"><span data-i18n="lvl-u">LEVEL</span><span class="options__flex">2</span></div><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_lvl2_slots_mod" value="0" placeholder="0" title="@{lvl2_slots_mod}"/>
              <div class="options__flex--2"><span data-i18n="lvl-u">LEVEL</span><span class="options__flex">3</span></div><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_lvl3_slots_mod" value="0" placeholder="0" title="@{lvl3_slots_mod}"/>
            </div>
            <div class="options__row--title"><span data-i18n="spell_slot_modifiers-u">SPELL SLOT MODIFIERS</span></div>
          </div>
        </div>
        <div class="settings__col">
          <div class="options">
            <div class="options__row"><span class="options__flex--3" data-i18n="strength-u">STRENGTH</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_strength_bonus" value="0" placeholder="0" title="@{strength_bonus}"/><span class="options__flex--3" data-i18n="dexterity-u">DEXTERITY</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_dexterity_bonus" value="0" placeholder="0" title="@{dexterity_bonus}"/>
            </div>
            <div class="options__row"><span class="options__flex--3" data-i18n="constitution-u">CONSTITUTION</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_constitution_bonus" value="0" placeholder="0" title="@{constitution_bonus}"/><span class="options__flex--3" data-i18n="intelligence-u">INTELLIGENCE</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_intelligence_bonus" value="0" placeholder="0" title="@{intelligence_bonus}"/>
            </div>
            <div class="options__row"><span class="options__flex--3" data-i18n="wisdom-u">WISDOM</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_wisdom_bonus" value="0" placeholder="0" title="@{wisdom_bonus}"/><span class="options__flex--3" data-i18n="charisma-u">CHARISMA</span><span class="options__flex--1">+</span>
              <input class="options__flex--1" type="text" name="attr_charisma_bonus" value="0" placeholder="0" title="@{charisma_bonus}"/>
            </div>
            <div class="options__row options__row--noborder"><span data-i18n="initiative-mod:-u">INITIATIVE MODIFIER:</span>
              <input type="text" name="attr_initmod" placeholder="0" value="0"/>
            </div>
            <div class="options__row options__row--noborder"><span data-i18n="initiative-style:-u">INITIATIVE STYLE:</span>
              <select name="attr_initiative_style">
                <option value="@{d20}" selected="selected" data-i18n="norm">Normal</option>
                <option value="{@{d20},@{d20}}kh1" data-i18n="adv">Advantage</option>
                <option value="{@{d20},@{d20}}kl1" data-i18n="disadv">Disadvantage</option>
              </select>
            </div>
            <div class="options__row">
              <input type="checkbox" name="attr_init_tiebreaker" value="@{dexterity}/100"/><span data-i18n="add-dex-tiebreaker-u">ADD DEX TIEBREAKER TO INITIATIVE</span>
            </div>
            <div class="options__row--title"><span data-i18n="attribute-opts-u">ATTRIBUTE OPTIONS</span></div>
          </div>
          <div class="options">
            <div class="options__row options__row--noborder"><span class="options__flex--4" data-i18n="strength-save-u">STRENGTH SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_strength_save_mod" value="0" placeholder="0" title="@{strength_save_mod}"/><span class="options__flex--4" data-i18n="dexterity-save-u">DEXTERITY SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_dexterity_save_mod" value="0" placeholder="0" title="@{dexterity_save_mod}"/>
            </div>
            <div class="options__row options__row--noborder"><span class="options__flex--4" data-i18n="constitution-save-u">CONSTITUTION SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_constitution_save_mod" value="0" placeholder="0" title="@{constitution_save_mod}"/><span class="options__flex--4" data-i18n="intelligence-save-u">INTELLIGENCE SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_intelligence_save_mod" value="0" placeholder="0" title="@{intelligence_save_mod}"/>
            </div>
            <div class="options__row"><span class="options__flex--4" data-i18n="wisdom-save-u">WISDOM SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_wisdom_save_mod" value="0" placeholder="0" title="@{wisdom_save_mod}"/><span class="options__flex--4" data-i18n="charisma-save-u">CHARISMA SAVE</span><span class="options__flex">+</span>
              <input class="options__flex--1" type="text" name="attr_charisma_save_mod" value="0" placeholder="0" title="@{charisma_save_mod}"/>
            </div>
            <div class="options__row"><span data-i18n="death-save-mod:-u">DEATH SAVE MODIFIER:</span>
              <input type="text" name="attr_death_save_mod" placeholder="0" value="0"/>
            </div>
            <div class="options__row"><span data-i18n="glob-saving-mod:-u">GLOBAL SAVING THROW MODIFIER:</span>
              <input type="text" name="attr_globalsavemod" placeholder="0" value="0"/>
            </div>
            <div class="options__row--title"><span data-i18n="save-opts-u">SAVE OPTIONS</span></div>
          </div>
          <div class="options">
            <div data-i18n-list="skills-list">
              <div class="options__row" data-i18n-list-item="acrobatics">
                <select class="options__flex--4" name="attr_acrobatics_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="acrobatics-core">Acrobatics <span>(Dex)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_acrobatics_flat" value="0" placeholder="0" title="@{acrobatics_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="animal_handling">
                <select class="options__flex--4" name="attr_animal_handling_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="animal_handling-core">Animal Handling <span>(Wis)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_animal_handling_flat" value="0" placeholder="0" title="@{animal_handling_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="arcana">
                <select class="options__flex--4" name="attr_arcana_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="arcana-core">Arcana <span>(Int)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_arcana_flat" value="0" placeholder="0" title="@{arcana_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="athletics">
                <select class="options__flex--4" name="attr_athletics_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="athletics-core">Athletics <span>(Str)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_athletics_flat" value="0" placeholder="0" title="@{athletics_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="deception">
                <select class="options__flex--4" name="attr_deception_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="deception-core">Deception <span>(Cha)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_deception_flat" value="0" placeholder="0" title="@{deception_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="history">
                <select class="options__flex--4" name="attr_history_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="history-core">History <span>(Int)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_history_flat" value="0" placeholder="0" title="@{history_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="insight">
                <select class="options__flex--4" name="attr_insight_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="insight-core">Insight <span>(Wis)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_insight_flat" value="0" placeholder="0" title="@{insight_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="intimidation">
                <select class="options__flex--4" name="attr_intimidation_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="intimidation-core">Intimidation <span>(Cha)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_intimidation_flat" value="0" placeholder="0" title="@{intimidation_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="investigation">
                <select class="options__flex--4" name="attr_investigation_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="investigation-core">Investigation <span>(Int)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_investigation_flat" value="0" placeholder="0" title="@{investigation_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="medicine">
                <select class="options__flex--4" name="attr_medicine_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="medicine-core">Medicine <span>(Wis)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_medicine_flat" value="0" placeholder="0" title="@{medicine_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="nature">
                <select class="options__flex--4" name="attr_nature_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="nature-core">Nature <span>(Int)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_nature_flat" value="0" placeholder="0" title="@{nature_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="perception">
                <select class="options__flex--4" name="attr_perception_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="perception-core">Perception <span>(Wis)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_perception_flat" value="0" placeholder="0" title="@{perception_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="performance">
                <select class="options__flex--4" name="attr_performance_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="performance-core">Performance <span>(Cha)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_performance_flat" value="0" placeholder="0" title="@{performance_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="persuasion">
                <select class="options__flex--4" name="attr_persuasion_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="persuasion-core">Persuasion <span>(Cha)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_persuasion_flat" value="0" placeholder="0" title="@{persuasion_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="religion">
                <select class="options__flex--4" name="attr_religion_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="religion-core">Religion <span>(Int)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_religion_flat" value="0" placeholder="0" title="@{religion_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="sleight_of_hand">
                <select class="options__flex--4" name="attr_sleight_of_hand_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="sleight_of_hand-core">Sleight of Hand <span>(Dex)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_sleight_of_hand_flat" value="0" placeholder="0" title="@{sleight_of_hand_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="stealth">
                <select class="options__flex--4" name="attr_stealth_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="stealth-core">Stealth <span>(Dex)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_stealth_flat" value="0" placeholder="0" title="@{stealth_flat}"/>
              </div>
              <div class="options__row" data-i18n-list-item="survival">
                <select class="options__flex--4" name="attr_survival_type">
                  <option value="1" selected="selected" data-i18n="normal">Normal</option>
                  <option value="2" data-i18n="expertise">Expertise</option>
                </select><span class="options__flex--5" data-i18n="survival-core">Survival <span>(Wis)</span></span><span class="options__flex">+</span>
                <input class="options__flex--1" type="text" name="attr_survival_flat" value="0" placeholder="0" title="@{survival_flat}"/>
              </div>
            </div>
            <div class="options__row"><span data-i18n="pass-perc-mod:-u">PASSIVE PERCEPTION MODIFIER:</span>
              <input type="text" name="attr_passiveperceptionmod" placeholder="0" value="0"/>
            </div>
            <div class="options__row--title"><span data-i18n="skill-opts-u">SKILL OPTIONS</span></div>
          </div>
        </div>
        <div class="settings__col">
          <div class="options">
            <div class="options__row">
              <input type="checkbox" name="attr_npc" value="1"/><span data-i18n="npc-u">NPC</span>
            </div>
            <div class="options__row"><span data-i18n="roll-queries:-u">ROLL QUERIES:</span>
              <select name="attr_rtype">
                <option value="{{always=1}} {{r2=[[@{d20}" data-i18n="always-roll-adv">Always Roll Advantage</option>
                <option value="@{advantagetoggle}" data-i18n="toggle-roll-adv">Advantage Toggle</option>
                <option value="@{queryadvantage}" data-i18n="query-roll-adv">Query Advantage</option>
                <option value="{{normal=1}} {{r2=[[0d20" data-i18n="never-roll-adv">Never Roll Advantage</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="whisp-rolls-gm:-u">WHISPER ROLLS TO GM:</span>
              <select name="attr_wtype">
                <option value="" data-i18n="never-whisper-roll">Never Whisper Rolls</option>
                <option value="@{whispertoggle}" data-i18n="toggle-roll-whisper">Whisper Toggle</option>
                <option value="?{Whisper?|Public Roll,|Whisper Roll,/w gm }" data-i18n="query-whisper-roll">Query Whisper</option>
                <option value="/w gm " data-i18n="always-whisper-roll">Always Whisper Rolls</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="auto-dmg-roll:-u">AUTO DAMAGE ROLL:</span>
              <select class="dtype" name="attr_dtype">
                <option value="pick" data-i18n="never-roll-dmg">Don&apos;t Auto Roll Damage</option>
                <option value="full" data-i18n="always-roll-dmg">Auto Roll Damage &amp; Crit</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="core-die-roll:-u">CORE DIE ROLL:</span>
              <input type="text" name="attr_core_die" value="1d20" placeholder="1d20" title="@{core_die}"/>
            </div>
            <div class="options__row"><span data-i18n="default-critical-range:-u">CRITICAL RANGE:</span>
              <input type="number" name="attr_default_critical_range" value="20" placeholder="20"/>
            </div>
            <div class="options__row"><span data-i18n="prof-bonus:-u">PROFICIENCY BONUS:</span>
              <select class="dtype" name="attr_pb_type">
                <option value="level" data-i18n="by-level">By Level (Default)</option>
                <option value="die" data-i18n="prof-die">Proficency Die (DMG)</option>
                <option value="custom" data-i18n="custom">Custom</option>
              </select>
              <input type="hidden" name="attr_pb_type"/>
              <input class="pb_custom" type="text" name="attr_pb_custom" placeholder="2d10"/>
            </div>
            <div class="options__row"><span data-i18n="add-char-to-templates:-u">ADD CHARACTER NAME TO TEMPLATES:</span>
              <select class="dtype" name="attr_charname_output">
                <option value="{{charname=@{character_name}}}" data-i18n="on">On</option>
                <option value="charname=@{character_name}" selected="selected" data-i18n="off">Off</option>
              </select>
            </div>
            <div class="options__row"><span data-i18n="level-calculations:-u">LEVEL CALCULATIONS:</span>
              <select class="dtype" name="attr_level_calculations">
                <option value="on" selected="selected" data-i18n="on">On</option>
                <option value="off" data-i18n="off">Off</option>
              </select>
            </div>
            <div class="options__row options__row--noborder"><span data-i18n="encumbrance:-u">ENCUMBRANCE:</span>
              <select name="attr_encumbrance_setting">
                <option value="off" data-i18n="simple">Simple</option>
                <option value="on" data-i18n="variant-phb">Variant (PHB p176)</option>
                <option value="disabled" data-i18n="off">Off</option>
              </select>
            </div>
            <div class="options__row">
              <input type="checkbox" name="attr_ingore_non_equipped_weight" value="1"/><span data-i18n="ingore-non-equipped-weight">IGNORE NON-EQUIPPED ITEMS WEIGHT</span>
            </div>
            <div class="options__row"><span data-i18n="inventory:-u">INVENTORY:</span>
              <select name="attr_simpleinventory">
                <option value="complex" data-i18n="compendium-compatible">Compendium Compatible</option>
                <option value="simple" data-i18n="simple">Simple</option>
              </select>
            </div>
            <div class="options__row--title"><span data-i18n="general-opts-u">GENERAL OPTIONS</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="rolltemplates">
  <rolltemplate class="sheet-rolltemplate-atk">
    <div class="container">
        <div class="result">
            {{#always}}
                <div class="adv">
                    <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                </div>
                <div class="advspacer"></div>
                <div class="adv">
                    <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                </div>
            {{/always}}
            {{#normal}}
                <div class="solo">
                    <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                </div>
            {{/normal}}
            {{#advantage}}
                {{#rollLess() r1 r2}}
                    <div class="adv">
                        <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollGreater() r1 r2}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollLess() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <div class="adv">
                        <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/rollGreater() r1 r2}}
            {{/disadvantage}}
        </div>
        {{#range}}
            <div class="sublabel">
                <span>{{range}}</span>
            </div>
        {{/range}}
        <div class="label">
            {{#normal}}
                {{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}
                {{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}
            {{/normal}}
            {{#always}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/always}}
            {{#advantage}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollLess() r1 r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollLess() r1 r2}}
                {{#rollGreater() r1 r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollGreater() r1 r2}}
            {{/disadvantage}}
        </div>
        {{#charname}}
            <div class="charname">
                <span>{{charname}}</span>
            </div>
        {{/charname}}
        {{#spelldesc_link}}
            <div class="spelldesc-link">
            <span>{{spelldesc_link}}</span>
            </div>
        {{/spelldesc_link}}
    </div>
    {{#desc}}
        <div class="desc info">
            <span>
                <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
            </span>
        </div>
    {{/desc}}
</rolltemplate><rolltemplate class="sheet-rolltemplate-atkdmg">
    {{#attack}}
        <div class="container atk">
            <div class="result">
                {{#always}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/always}}
                {{#normal}}
                    <div class="solo">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/normal}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            {{#range}}
                <div class="sublabel">
                    <span>{{range}}</span>
                </div>
            {{/range}}
            <div class="label">
                <span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}{{#attack}} <span>({{mod}})</span>{{/attack}}</span>
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
            {{#spelldesc_link}}
            <div class="spelldesc-link">
                <span>{{spelldesc_link}}</span>
            </div>
            {{/spelldesc_link}}
        </div>
    {{/attack}}
    {{#save}}
        {{#attack}}
            <div class="container save">
        {{/attack}}
        {{^attack}}
            <div class="container atk save">
        {{/attack}}
            <div class="savedc">
                <span class="rolltemplate-inline" data-i18n="difficulty-class-abv">DC</span><span class="rolltemplate-inline">{{savedc}}</span>
            </div>
            {{#savedesc}}
                <div class="sublabel">
                    <span>{{savedesc}}</span>
                </div>
            {{/savedesc}}
            <div class="label">
                <span class="rolltemplate-inline">{{saveattr}}</span> <span class="rolltemplate-inline" data-i18n="save">Save</span>
            </div>
        </div>
    {{/save}}
    {{#desc}}
        <div class="desc info">
            <span>
                <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
            </span>
        </div>
    {{/desc}}
    {{#globaldamage}}
        {{#^rollTotal() globaldamage 0}}
            <div class="desc">
                <span>
                    {{globaldamage}}
                    {{#normal}}
                        {{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}
                    {{/normal}}
                    {{#always}}
                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{/always}}
                    {{#advantage}}
                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{/advantage}}
                    {{#disadvantage}}
                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{/disadvantage}}
                </span>
                <span class="damagetype">{{globaldamagetype}}</span>
            </div>
        {{/^rollTotal() globaldamage 0}}
        {{#rollTotal() globaldamage 0}}
            {{#^rollTotal() globaldamagecrit 0}}
                {{#rollWasCrit() r1}}
                    <div class="desc">
                        <span>
                            {{#attack}}
                                {{#normal}}
                                    {{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}
                                {{/normal}}
                                {{#always}}
                                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                {{/always}}
                                {{#advantage}}
                                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                {{/advantage}}
                                {{#disadvantage}}
                                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{/disadvantage}}
                            {{/attack}}
                        </span>
                        <span class="damagetype">{{globaldamagetype}}</span>
                    </div>
                {{/rollWasCrit() r1}}
                {{#rollWasCrit() r2}}
                    {{#^rollWasCrit() r1}}
                        <div class="desc">
                            <span>
                                {{#attack}}
                                    {{#normal}}
                                        {{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}
                                    {{/normal}}
                                    {{#always}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/always}}
                                    {{#advantage}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/advantage}}
                                    {{#disadvantage}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{/disadvantage}}
                                {{/attack}}
                            </span>
                            <span class="damagetype">{{globaldamagetype}}</span>
                        </div>
                    {{/^rollWasCrit() r1}}
                {{/rollWasCrit() r2}}
            {{/^rollTotal() globaldamagecrit 0}}
        {{/rollTotal() globaldamage 0}}
    {{/globaldamage}}
    {{#hldmg}}
        {{#^rollTotal() hldmg 0}}
            <div class="hldmg">
                <span>
                    {{hldmg}}
                    <!-- {{#hldmgcrit}} + {{hldmgcrit}}{{/hldmgcrit}} -->
                    {{#attack}}
                        {{#normal}}
                            {{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}
                        {{/normal}}
                        {{#always}}
                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                        {{/always}}
                        {{#advantage}}
                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                        {{/advantage}}
                        {{#disadvantage}}
                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                        {{/disadvantage}}
                    {{/attack}}
                </span>
                <div class="label">
                    <span data-i18n="higher-lvl-cast">Higher Level Cast</span>
                </div>
            </div>
        {{/^rollTotal() hldmg 0}}
    {{/hldmg}}
    {{#damage}}
        <div class="container damagetemplate">
            <div class="result">
                {{#dmg1flag}}
                    {{^dmg2flag}}
                        <div class="solo">
                            <span class="damage">
                                {{dmg1}}
                                {{#attack}}
                                    {{#normal}}
                                        {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                    {{/normal}}
                                    {{#always}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/always}}
                                    {{#advantage}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/advantage}}
                                    {{#disadvantage}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{/disadvantage}}
                                {{/attack}}
                            </span>
                            <span class="damagetype">{{dmg1type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
                {{#dmg2flag}}
                    {{^dmg1flag}}
                        <div class="solo">
                            <span class="damage">
                                {{dmg2}}
                                {{#attack}}
                                    {{#normal}}
                                        {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                    {{/normal}}
                                    {{#always}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/always}}
                                    {{#advantage}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/advantage}}
                                    {{#disadvantage}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{/disadvantage}}
                                {{/attack}}
                            </span>
                            <span class="damagetype">{{dmg2type}}</span>
                        </div>
                    {{/dmg1flag}}
                {{/dmg2flag}}
                {{#dmg1flag}}
                    {{#dmg2flag}}
                        <div class="adv">
                            <span class="damage">
                                {{dmg1}}
                                {{#attack}}
                                    {{#normal}}
                                        {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                    {{/normal}}
                                    {{#always}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/always}}
                                    {{#advantage}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/advantage}}
                                    {{#disadvantage}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{/disadvantage}}
                                {{/attack}}
                            </span>
                            <span class="damagetype">{{dmg1type}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>
                                {{dmg2}}
                                {{#attack}}
                                    {{#normal}}
                                        {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                    {{/normal}}
                                    {{#always}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/always}}
                                    {{#advantage}}
                                        {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                    {{/advantage}}
                                    {{#disadvantage}}
                                        {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                    {{/disadvantage}}
                                {{/attack}}
                            </span>
                            <span class="damagetype">{{dmg2type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
            </div>
            {{^attack}}
                {{#range}}
                    <div class="sublabel">
                        <span>{{range}}</span>
                    </div>
                {{/range}}
                <div class="label">
                    <span>{{rname}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
                </div>
                {{#charname}}
                    <div class="charname">
                        <span>{{charname}}</span>
                    </div>
                {{/charname}}
                {{#spelldesc_link}}
                <div class="spelldesc-link">
                    <span>{{spelldesc_link}}</span>
                </div>
                {{/spelldesc_link}}
            {{/attack}}
        </div>
    {{/damage}}
  </rolltemplate><rolltemplate class="sheet-rolltemplate-dmg">
    {{#save}}
        {{#attack}}
            <div class="save">
        {{/attack}}
        {{^attack}}
            <div class="atk save">
        {{/attack}}
            <div class="savedc">
                <span class="rolltemplate-inline" data-i18n="difficulty-class-abv">DC</span>
                <span class="rolltemplate-inline">{{savedc}}</span>
            </div>
            {{#savedesc}}
                <div class="sublabel">
                    <span>{{savedesc}}</span>
                </div>
            {{/savedesc}}
            <div class="label">
                <span class="rolltemplate-inline">{{saveattr}}</span> 
                <span class="rolltemplate-inline" data-i18n="save">Save</span>
            </div>
        </div>
    {{/save}}
    {{^attack}}
        {{#desc}}
            <div class="desc info">
                <span>
                    <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
                </span>
            </div>
        {{/desc}}
    {{/attack}}
    {{#globaldamage}}
        {{#^rollTotal() globaldamage 0}}
            <div class="desc">
                <span>{{globaldamage}}{{#globaldamagecrit}}{{#^rollTotal() globaldamagecrit 0}}<span class="plus"> + </span>{{globaldamagecrit}}{{/^rollTotal() globaldamagecrit 0}}{{/globaldamagecrit}}</span>
                <span class="damagetype">{{globaldamagetype}}</span>
            </div>
        {{/^rollTotal() globaldamage 0}}
    {{/globaldamage}}
    {{#globaldamage}}
        {{#rollTotal() globaldamage 0}}
            {{#globaldamagecrit}}
                {{#^rollTotal() globaldamagecrit 0}}
                    <div class="desc">
                        <span>{{globaldamagecrit}}</span>
                        <span class="damagetype">{{globaldamagetype}}</span>
                    </div>
                {{/^rollTotal() globaldamagecrit 0}}
            {{/globaldamagecrit}}
        {{/rollTotal() globaldamage 0}}
    {{/globaldamage}}
    {{^globaldamage}}
        {{#globaldamagecrit}}
            {{#^rollTotal() globaldamagecrit 0}}
                <div class="desc">
                    <span>{{globaldamagecrit}}</span>
                    <span class="damagetype">{{globaldamagetype}}</span>
                </div>
            {{/^rollTotal() globaldamagecrit 0}}
        {{/globaldamagecrit}}
    {{/globaldamage}}
    {{#hldmg}}
        {{#^rollTotal() hldmg 0}}
            <div class="desc">
                <span>{{hldmg}}{{#hldmgcrit}}<span class="plus"> + </span>{{hldmgcrit}}{{/hldmgcrit}}</span>
                <span class="damagetype">{{dmg1type}}</span>
                <div class="label">
                    <span data-i18n="higher-lvl-cast">Higher Level Cast</span>
                </div>
            </div>
        {{/^rollTotal() hldmg 0}}
    {{/hldmg}}
    <div class="container damagetemplate">
        <div class="result">
            {{#dmg1flag}}
                {{^dmg2flag}}
                    <div class="solo">
                        <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                        <span class="damagetype">{{dmg1type}}</span>
                    </div>
                {{/dmg2flag}}
            {{/dmg1flag}}
            {{#dmg2flag}}
                {{^dmg1flag}}
                    <div class="solo">
                        <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                        <span class="damagetype">{{dmg2type}}</span>
                    </div>
                {{/dmg1flag}}
            {{/dmg2flag}}
            {{#dmg1flag}}
                {{#dmg2flag}}
                    <div class="adv">
                        <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                        <span class="damagetype">{{dmg1type}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                        <span class="damagetype">{{dmg2type}}</span>
                    </div>
                {{/dmg2flag}}
            {{/dmg1flag}}
        </div>
        {{^attack}}
            {{#range}}
                <div class="sublabel" style="color: black;">
                    <span>{{range}}</span>
                </div>
            {{/range}}
            <div class="label">
                <span>{{rname}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
            {{#spelldesc_link}}
            <div class="spelldesc-link">
                <span>{{spelldesc_link}}</span>
            </div>
            {{/spelldesc_link}}
        {{/attack}}
    </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-desc">
    <div class="desc info">
        <span>
            <span class="top"></span>
            <span class="middle">{{desc}}</span>
            <span class="bottom"></span>
        </span>
    </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-dmgaction">
  <div class="container dmgcontainer damagetemplate">
      <div class="row header">
          <span>{{rname}}</span>
      </div>
      {{#name}}
          <div class="row subheader">
              <span class="italics">{{name}}</span>
          </div>
      {{/name}}
      <div class="arrow-right"></div>
      <span class="italics translated" data-i18n="dmg:-u">Damage: </span>
      <span>
          {{#dmg1flag}}
              {{dmg1}}{{#crit}} + {{crit1}}{{/crit}}{{dmg1type}}
          {{/dmg1flag}}
          {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
          {{#dmg2flag}}
              {{dmg2}}{{#crit}} + {{crit2}}{{/crit}}{{dmg2type}}
          {{/dmg2flag}}
      </span>
  </div>
  {{#description}}
      <div class="row">
          <span class="desc">{{description}}</span>
      </div>
  {{/description}}
</rolltemplate><rolltemplate class="sheet-rolltemplate-npc">
  <div class="row header">
      <span>{{rname}}</span>
  </div>
  {{#name}}
      <div class="row subheader">
          <span class="italics">{{name}}</span>
      </div>
  {{/name}}
  <div class="arrow-right"></div>
  <div class="row">
      {{#normal}}
          <span class="italics">{{type}}: </span><span>{{r1}}</span>
      {{/normal}}
      {{#always}}
          <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
      {{/always}}
      {{#advantage}}
          {{#rollLess() r1 r2}}
              <span class="italics">{{type}}: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}
              <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}
              <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
          {{/rollGreater() r1 r2}}
      {{/advantage}}
      {{#disadvantage}}
          {{#rollLess() r1 r2}}
              <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
          {{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}
              <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}
              <span class="italics">{{type}}: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollGreater() r1 r2}}
      {{/disadvantage}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-npcaction">
  <div class="container">
      <div class="row header">
          <span>{{rname}}</span>
      </div>
      {{#name}}
          <div class="row subheader">
              <span class="italics">{{name}}</span>
          </div>
      {{/name}}
      <div class="arrow-right"></div>
      {{#attack}}
          <div class="row">
              {{#normal}}
                  <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span>
              {{/normal}}
              {{#always}}
                  <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
              {{/always}}
              {{#advantage}}
                  {{#rollLess() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollLess() r1 r2}}
                  {{#rollTotal() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollTotal() r1 r2}}
                  {{#rollGreater() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                  {{/rollGreater() r1 r2}}
              {{/advantage}}
              {{#disadvantage}}
                  {{#rollLess() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                  {{/rollLess() r1 r2}}
                  {{#rollTotal() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollTotal() r1 r2}}
                  {{#rollGreater() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollGreater() r1 r2}}
              {{/disadvantage}}
          </div>
      {{/attack}}
      {{#description}}
          <span class="desc">{{description}}</span>
      {{/description}}
      </div>
      {{#damage}}
          <div class="container dmgcontainer damagetemplate">
              <span class="italics sheet-translated" data-i18n="dmg:-u">Damage: </span>
              <span>
                  {{#dmg1flag}}
                      {{dmg1}}
                      {{#normal}}
                          {{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}
                      {{/normal}}
                      {{#always}}
                          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                      {{/always}}
                      {{#advantage}}
                          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                      {{/advantage}}
                      {{#disadvantage}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{/disadvantage}}
                      {{dmg1type}}
                  {{/dmg1flag}}
                  {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
                  {{#dmg2flag}}
                      {{dmg2}}
                      {{#normal}}
                          {{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}
                      {{/normal}}
                      {{#always}}
                          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                      {{/always}}
                      {{#advantage}}
                          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                      {{/advantage}}
                      {{#disadvantage}}
                          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{/disadvantage}}
                      {{dmg2type}}
                  {{/dmg2flag}}
              </span>
          </div>
      {{/damage}}
</rolltemplate><rolltemplate class="sheet-rolltemplate-npcatk">
  <div class="row header">
      {{#normal}}
          {{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}
          {{#^rollWasCrit() r1}}{{rname}}{{/^rollWasCrit() r1}}
      {{/normal}}
      {{#always}}
          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{rnamec}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
          {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}{{rname}}{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
      {{/always}}
      {{#advantage}}
          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{rnamec}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
          {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}{{rname}}{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
      {{/advantage}}
      {{#disadvantage}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}{{rname}}{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}            
          {{#rollLess() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollLess() r1 r2}}
          {{#rollLess() r1 r2}}{{#^rollWasCrit() r1}}{{rname}}{{/^rollWasCrit() r1}}{{/rollLess() r1 r2}}              
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r2}}{{rnamec}}{{/rollWasCrit() r2}}{{/rollGreater() r1 r2}}
          {{#rollGreater() r1 r2}}{{#^rollWasCrit() r2}}{{rname}}{{/^rollWasCrit() r2}}{{/rollGreater() r1 r2}}
      {{/disadvantage}}
  </div>
  {{#name}}
      <div class="row subheader">
          <span class="italics">{{name}}</span>
      </div>
  {{/name}}
  <div class="arrow-right"></div>
  <div class="row">
      {{#normal}}
          {{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}
          {{#^rollWasCrit() r1}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r1}}
      {{/normal}}
      {{#always}}
          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
          {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
      {{/always}}
      {{#advantage}}
          {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="italics sheet-translated">[{{typec}}: </span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
          {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
      {{/advantage}}
      {{#disadvantage}}
          {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
          {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}            
          {{#rollLess() r1 r2}}{{#rollWasCrit() r1}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollLess() r1 r2}}
          {{#rollLess() r1 r2}}{{#^rollWasCrit() r1}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r1}}{{/rollLess() r1 r2}}              
          {{#rollGreater() r1 r2}}{{#rollWasCrit() r2}}<span class="italics sheet-translated">{{typec}}: </span>{{/rollWasCrit() r2}}{{/rollGreater() r1 r2}}
          {{#rollGreater() r1 r2}}{{#^rollWasCrit() r2}}<span class="italics sheet-translated">{{type}}: </span>{{/^rollWasCrit() r2}}{{/rollGreater() r1 r2}}
      {{/disadvantage}}
      {{#normal}}
          <span>{{r1}}</span>
      {{/normal}}
      {{#always}}
          <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
      {{/always}}
      {{#advantage}}
          {{#rollLess() r1 r2}}
              <span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}
              <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}
              <span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
          {{/rollGreater() r1 r2}}
      {{/advantage}}
      {{#disadvantage}}
          {{#rollLess() r1 r2}}
              <span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
          {{/rollLess() r1 r2}}
          {{#rollTotal() r1 r2}}
              <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollTotal() r1 r2}}
          {{#rollGreater() r1 r2}}
              <span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
          {{/rollGreater() r1 r2}}
      {{/disadvantage}}
  </div>
  {{#description}}
      <div class="row">
          <span class="desc">{{description}}</span>
      </div>
  {{/description}}
</rolltemplate><rolltemplate class="sheet-rolltemplate-npcdmg">
  <div class="container dmgcontainer damagetemplate">
      <span class="italics translated" data-i18n="dmg:-u">Damage: </span>
      <span>
          {{#dmg1flag}}
              {{dmg1}}{{#crit}} + {{crit1}}{{/crit}}{{dmg1type}}
          {{/dmg1flag}}
          {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
          {{#dmg2flag}}
              {{dmg2}}{{#crit}} + {{crit2}}{{/crit}}{{dmg2type}}
          {{/dmg2flag}}
      </span>
  </div>
  {{#description}}
      <div class="row">
          <span class="desc">{{description}}</span>
      </div>
  {{/description}}
</rolltemplate><rolltemplate class="sheet-rolltemplate-npcfullatk">
  <div class="container">
      <div class="row header">
          <span>{{rname}}</span>
      </div>
      {{#name}}
          <div class="row subheader">
              <span class="italics">{{name}}</span>
          </div>
      {{/name}}
      <div class="arrow-right"></div>
      {{#attack}}
          <div class="row">
              {{#normal}}
                  <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span>
              {{/normal}}
              {{#always}}
                  <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
              {{/always}}
              {{#advantage}}
                  {{#rollLess() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollLess() r1 r2}}
                  {{#rollTotal() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollTotal() r1 r2}}
                  {{#rollGreater() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                  {{/rollGreater() r1 r2}}
              {{/advantage}}
              {{#disadvantage}}
                  {{#rollLess() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                  {{/rollLess() r1 r2}}
                  {{#rollTotal() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollTotal() r1 r2}}
                  {{#rollGreater() r1 r2}}
                      <span class="italics sheet-translated" data-i18n="attack:-u">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                  {{/rollGreater() r1 r2}}
              {{/disadvantage}}
          </div>
      {{/attack}}
  </div>
  <div class="container dmgcontainer damagetemplate">
      <span class="italics sheet-translated" data-i18n="dmg:-u">Damage: </span>
      {{#damage}}
          <span>
              {{#dmg1flag}}
                  {{dmg1}}
                  {{#normal}}
                      {{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}
                  {{/normal}}
                  {{#always}}
                      {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                  {{/always}}
                  {{#advantage}}
                      {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                  {{/advantage}}
                  {{#disadvantage}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                  {{/disadvantage}}
                  {{dmg1type}}
              {{/dmg1flag}}
              {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
              {{#dmg2flag}}
                  {{dmg2}}
                  {{#normal}}
                      {{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}
                  {{/normal}}
                  {{#always}}
                      {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                  {{/always}}
                  {{#advantage}}
                      {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                      {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                  {{/advantage}}
                  {{#disadvantage}}
                      {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                  {{/disadvantage}}
                  {{dmg2type}}
              {{/dmg2flag}}
          </span>
      {{/damage}}
      {{#description}}
          <div class="row">
              <span class="desc">{{description}}</span>
          </div>
      {{/description}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-simple">
    <div class="container">
        <div class="result">
            {{#always}}
                <div class="adv">
                    <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                </div>
                <div class="advspacer"></div>
                <div class="adv">
                    <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                </div>
            {{/always}}
            {{#normal}}
                <div class="solo">
                    <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                </div>
            {{/normal}}
            {{#advantage}}
                {{#rollLess() r1 r2}}
                    <div class="adv">
                        <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollGreater() r1 r2}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollLess() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <div class="adv">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <div class="adv">
                        <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/rollGreater() r1 r2}}
                {{#imposed}}
                <div class="label">
                    <span style="color: red">{{imposed}}</span>
                </div>
                {{/imposed}}
            {{/disadvantage}}
        </div>
        <div class="label">
            <span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
        </div>
        {{#charname}}
            <div class="charname">
                <span>{{charname}}</span>
            </div>
        {{/charname}}
    </div>
</rolltemplate>
  <rolltemplate class="sheet-rolltemplate-simple3D">
  <div class="container">
      <div class="result">
          {{#always}}
              <div class="adv">
                  <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
              </div>
              <div class="advspacer"></div>
              <div class="adv">
                  <span>{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
              </div>
          {{/always}}
          {{#normal}}
              <div class="solo">
                  <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
              </div>
          {{/normal}}
          {{#advantage}}
              {{#rollLess() r1 r2}}
                  <div class="adv">
                      <span class="grey">{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span>{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollLess() r1 r2}}
              {{#rollTotal() r1 r2}}
                  <div class="adv">
                      <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span>{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollTotal() r1 r2}}
              {{#rollGreater() r1 r2}}
                  <div class="adv">
                      <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span class="grey">{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollGreater() r1 r2}}
          {{/advantage}}
          {{#disadvantage}}
              {{#rollLess() r1 r2}}
                  <div class="adv">
                      <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span class="grey">{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollLess() r1 r2}}
              {{#rollTotal() r1 r2}}
                  <div class="adv">
                      <span>{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span>{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollTotal() r1 r2}}
              {{#rollGreater() r1 r2}}
                  <div class="adv">
                      <span class="grey">{{r1}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="advspacer"></div>
                  <div class="adv">
                      <span>{{r2}}{{r3}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollGreater() r1 r2}}
              {{#imposed}}
                <div class="label">
                  <span style="color: red">{{imposed}}</span>
                </div>
              {{/imposed}}
          {{/disadvantage}}
      </div>
      <div class="label">
          <span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
      </div>
      {{#charname}}
          <div class="charname">
              <span>{{charname}}</span>
          </div>
      {{/charname}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-skill">
  <div class="container">
      <div class="result">
          {{#always}}
              <div class="roll">
                  <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
              </div>
              <div class="roll">
                  <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
              </div>
              {{#rollGreater() reliablecheck 0}}
                  {{#rollLess() r1 reliableroll}}
                      {{#rollLess() r2 reliableroll}}
                          <div class="roll reliableroll">
                              <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                          </div>
                      {{/rollLess() r2 reliableroll}}
                  {{/rollLess() r1 reliableroll}}
              {{/rollGreater() reliablecheck 0}}
          {{/always}}
          {{#normal}}
              <div class="roll">
                  <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
              </div>
              {{#rollGreater() reliablecheck 0}}
                  {{#rollLess() r1 reliableroll}}
                      <div class="roll reliableroll">
                          <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                      </div>
                  {{/rollLess() r1 reliableroll}}
              {{/rollGreater() reliablecheck 0}}
          {{/normal}}
          {{#advantage}}
              {{#rollLess() r1 r2}}
                  <div class="roll">
                      <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollLess() r1 r2}}
              {{#rollTotal() r1 r2}}
                  <div class="roll">
                      <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollTotal() r1 r2}}
              {{#rollGreater() r1 r2}}
                  <div class="roll">
                      <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
              {{/rollGreater() r1 r2}}
              {{#rollGreater() reliablecheck 0}}
                  {{#rollLess() r1 reliableroll}}
                      {{#rollLess() r2 reliableroll}}
                          <div class="roll reliableroll">
                              <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                          </div>
                      {{/rollLess() r2 reliableroll}}
                  {{/rollLess() r1 reliableroll}}
              {{/rollGreater() reliablecheck 0}}
          {{/advantage}}
          {{#disadvantage}}
              {{#rollLess() r1 r2}}
                  <div class="roll">
                      <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  {{#rollGreater() reliablecheck 0}}
                      {{#rollLess() r1 reliableroll}}
                          <div class="roll reliableroll">
                              <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                          </div>
                      {{/rollLess() r1 reliableroll}}
                  {{/rollGreater() reliablecheck 0}}
              {{/rollLess() r1 r2}}
              {{#rollTotal() r1 r2}}
                  <div class="roll">
                      <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  {{#rollGreater() reliablecheck 0}}
                      {{#rollLess() r1 reliableroll}}
                          <div class="roll reliableroll">
                              <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                          </div>
                      {{/rollLess() r1 reliableroll}}
                  {{/rollGreater() reliablecheck 0}}
              {{/rollTotal() r1 r2}}
              {{#rollGreater() r1 r2}}
                  <div class="roll">
                      <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  <div class="roll">
                      <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                  </div>
                  {{#rollGreater() reliablecheck 0}}
                      {{#rollLess() r2 reliableroll}}
                          <div class="roll reliableroll">
                              <span class=>{{reliableroll}}{{#global}} + {{global}}{{/global}}</span>
                          </div>
                      {{/rollLess() r2 reliableroll}}
                  {{/rollGreater() reliablecheck 0}}
              {{/rollGreater() r1 r2}}
          {{/disadvantage}}
      </div>
      <div class="label">
          <span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
      </div>
      {{#charname}}
          <div class="charname">
              <span>{{charname}}</span>
          </div>
      {{/charname}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-spell">
  <div class="container">
      <div class="title row">
          <span>{{name}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
      </div>
      <div class="italics row">
          {{#level}}<span class="level">{{level}} </span>{{/level}}
          {{#ritual}} (<span data-i18n="ritual-l"></span>){{/ritual}}
      </div>
      <div class="spacer"></div>
      {{#castingtime}}
      <div class="row">
          <span class="bold" data-i18n="casting-time:">Casting Time:</span> <span>{{castingtime}}</span>
      </div>
      {{/castingtime}}
      {{#range}}
      <div class="row">
          <span class="bold" data-i18n="range:">Range:</span> <span>{{range}}</span>
      </div>
      {{/range}}
      {{#target}}
      <div class="row">
          <span class="bold" data-i18n="target:">Target:</span> <span>{{target}}</span>
      </div>
      {{/target}}
      <div class="row">
          <span class="bold" data-i18n="components:">Components:</span>
          <span>
              {{#v}}V{{#s}}, {{/s}}{{^s}}{{#m}}, {{/m}}{{/s}}{{/v}}
              {{#s}}S{{#m}}, {{/m}}{{/s}}
              {{#m}}M {{#material}}({{material}}){{/material}}{{/m}}
          </span>
      </div>
      {{#duration}}
      <div class="row">
          <span class="bold" data-i18n="duration:">Duration:</span> <span>{{#concentration}}<span data-i18n="concentration">Concentration</span> {{/concentration}}{{duration}}</span>
      </div>
      {{/duration}}
      <div class="spacer"></div>
      {{#description}}
      <div class="row">
          <span class="description">{{description}}</span>
      </div>
      {{/description}}
      {{#athigherlevels}}
      <div class="row">
          <span class="bold italics" data-i18n="at-higher-lvl">At Higher Levels</span>. <span class="description">{{athigherlevels}}</span>
      </div>
      {{/athigherlevels}}
      {{#savedc}}
      <div class="row spellsavedc">
          <span class="sheet-label" data-i18n="spell-save-dc-u">SPELL SAVE DC</span><span>: {{savedc}}</span>
      </div>
      {{/savedc}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-spelloutput">
  <div class="container">
      <div class="title desconly row">
          <span data-i18n="desconly">For Description Only</span>
      </div>
      <div class="title row">
          <span>{{name}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
      </div>
      <div class="italics row">
          {{#level}}<span class="level">{{level}} </span>{{/level}}
          {{#ritual}} (<span data-i18n="ritual-l"></span>){{/ritual}}
      </div>
      <div class="spacer"></div>
      {{#castingtime}}
      <div class="row">
          <span class="bold" data-i18n="casting-time:">Casting Time:</span> <span>{{castingtime}}</span>
      </div>
      {{/castingtime}}
      {{#range}}
      <div class="row">
          <span class="bold" data-i18n="range:">Range:</span> <span>{{range}}</span>
      </div>
      {{/range}}
      {{#target}}
      <div class="row">
          <span class="bold" data-i18n="target:">Target:</span> <span>{{target}}</span>
      </div>
      {{/target}}
      <div class="row">
          <span class="bold" data-i18n="components:">Components:</span>
          <span>
              {{#v}}V{{#s}}, {{/s}}{{^s}}{{#m}}, {{/m}}{{/s}}{{/v}}
              {{#s}}S{{#m}}, {{/m}}{{/s}}
              {{#m}}M {{#material}}({{material}}){{/material}}{{/m}}
          </span>
      </div>
      {{#duration}}
      <div class="row">
          <span class="bold" data-i18n="duration:">Duration:</span> <span>{{#concentration}}<span data-i18n="concentration">Concentration</span> {{/concentration}}{{duration}}</span>
      </div>
      {{/duration}}
      <div class="spacer"></div>
      {{#description}}
      <div class="row">
          <span class="description">{{description}}</span>
      </div>
      {{/description}}
      {{#athigherlevels}}
      <div class="row">
          <span class="bold italics" data-i18n="at-higher-lvl">At Higher Levels</span>. <span class="description">{{athigherlevels}}</span>
      </div>
      {{/athigherlevels}}
      {{#savedc}}
      <div class="row spellsavedc">
          <span class="sheet-label" data-i18n="spell-save-dc-u">SPELL SAVE DC</span><span>: {{savedc}}</span>
      </div>
      {{/savedc}}
  </div>
</rolltemplate><rolltemplate class="sheet-rolltemplate-traits">
    <div class="row header">
        <span>{{name}}</span>
    </div>
    {{#source}}
        <div class="row subheader">
            <span class="italics">{{#charname}}{{charname}} {{/charname}}{{source}}</span>
        </div>
    {{/source}}
    {{#description}}
        <div class="row">
            <span class="desc">{{description}}</span>
        </div>
    {{/description}}
</rolltemplate>
</div>
<script type="text/worker">
  class SheetUtils {
    static getUID(value) {
        const regexp = /-.{19}(?=_)|-.{19}$/g;
        const valueAsString = String(value);
        const match = valueAsString.match(regexp);
        return (match) ? match.join() : "";
    }
    static aOrAn(value) {
        if(['a','e','i','o','u'].indexOf(value.toLowerCase()[0]) > -1) return `an ${value}`;
        return `a ${value}`;
    }
    static toLowerCase(value) {
        if(Array.isArray(value)) {
            const lowerCaseArray = value.map(item => { return item.toLowerCase(); });
            return lowerCaseArray;
        }
        return String(value).toLowerCase();
    }
    static toCapitalCase(value) {
        if(Array.isArray(value)) {
            const capitalCaseArray = value.map(item => { return item[0].toUpperCase() + item.toLowerCase().slice(1); });
            return capitalCaseArray;
        }
        return String(value)[0].toUpperCase() + String(value).toLowerCase().slice(1);
    }
    static getSectionOrder(section, callback) {
        const sectionName = `repeating_${section}`;
        const attributeName = `_reporder_${sectionName}`;
        getAttrs([attributeName], attributes => {
            let values = new Array();
            Object.keys(attributes).some(() => {
                let results = SheetUtils.toLowerCase(attributes[attributeName].replace(/ /g, '').split(','));
                values = values.concat(results);
                return true;
            });
            getSectionIDs(sectionName, ids => {
                const filteredOrder = new Set();
                const order = values.concat(SheetUtils.toLowerCase(ids)).filter(entry => { return SheetUtils.toLowerCase(ids).indexOf(entry) > -1; });
                order.forEach(item => {
                    filteredOrder.add(item);
                });
                callback(Array.from(filteredOrder));
            });
        });
    }
    static deepReadAttribute(attr, callback, defaultValue) {
        if(/^(@{).+}$/.test(String(attr)) === true) { 
            const regExp = /@\{([^@\{\}]+)\}/;
            const reference = regExp.exec(attr)[1];
            var self = this;
            getAttrs([reference], function(v) {
                if(!v[reference]) { 
                    callback(defaultValue);
                } else {
                    self.deepReadAttribute(v[reference], callback, defaultValue);
                }
            });
        }
        else {
            callback(attr); 
        }
    }
    static sanitizeXP(value) {
        const trimmedValue = value.trim();
        if(!trimmedValue) return [];
        const valueWithDecimalsRemoved = trimmedValue.replace(/,|\.| +/g, '');
        const regex = /[0-9]+/g;
        let xp = valueWithDecimalsRemoved.match(regex);
        if(Array.isArray(xp)) xp = xp.map(entry => { return parseInt(entry) });
        return xp;
    }
    static checkPath(obj, path, returnFalseOnEmpty = false) {
        const sanitizedPath = path.replace(/\]\[|[\[,\]]/g, '.').replace(/\.+/g, '.').replace(/[",',]|\.$|^\./g, '');
        const properties = sanitizedPath.split('.');
        let level = obj;
        for(let property = 0; property < properties.length; property++) {
            if((returnFalseOnEmpty && !level[properties[property]]) || (!returnFalseOnEmpty && !(properties[property] in level))) return false;
            level = level[properties[property]];
        }
        return true;
    }
}class RefereceSet extends Set {
  constructor(...args) {
    super(...args);
  }
  toggle(value) {
    const toggleLookup = {
      true: 'delete',
      false: 'add'
    };
    const hasValue = this.has(value);
    return this[toggleLookup[hasValue]](value);
  }
}
class FlagManager {
  constructor(reference) {
    this._reference = reference;
    this._delimiter = ' ';
    this._delimiterSafe = '_';
  }
  async getFlags() {
    const entries = await this._getReferenceSet();
    return entries;
  }
  async hasFlag(flag) {
    const entries = await this._getReferenceSet();
    return entries.has(flag);
  }
  async addFlag(flag) {
    const updatedReference = await this._updateReference(flag, 'add');
    return updatedReference;
  }
  async deleteFlag(flag) {
    const updatedReference = await this._updateReference(flag, 'delete');
    return updatedReference;
  }
  async toggleFlag(flag) {
    const updatedReference = await this._updateReference(flag, 'toggle');
    return updatedReference;
  }
  async _updateReference(flag, method) {
    const sanitizedFlag = this._sanitizeFlag(flag);
    const updatedReference = await this._setReference(sanitizedFlag, method);
    return updatedReference;
  }
  async syncFlagsWithRepeatingSection(section) {
    const flags = await this._syncFlagsWithRepeatingSection(section);
    return flags;
  }
  _syncFlagsWithRepeatingSection(section) {
    return new Promise(resolve => {
      SheetUtils.getSectionOrder(section, order => {
        getAttrs([this._reference], attributes => {
          let values = "";
          Object.keys(attributes).some(() => {
            values += attributes[this._reference];
            return true;
          });
          const flags = (values) ? values.split(' ') : [];
          const sectionName = `repeating_${section}`;
          const filteredArray = Array.from(flags).filter(flag => flag.includes(sectionName)).filter(flag => order.includes(SheetUtils.getUID(flag).toLowerCase()));
          filteredArray.forEach((flag, index) => {
            const newIndex = order.indexOf(SheetUtils.getUID(flag).toLowerCase());
            filteredArray[index] = flag.replace(this._getFlagIndex(flag), `_${newIndex}_`);
          });
          const updatedSet = Array.from(flags).filter(flag => !flag.includes(sectionName)).concat(filteredArray);
          let update = {};
          update[this._reference] = updatedSet.join(' ');
          setAttrs(update, () => {
            return resolve(new Set(updatedSet));
          });
        });
      });
    });
  }
  _getFlagIndex(flag) {
    const regexp = /_[0-9]+_/g;
    const valueAsString = String(flag);
    const match = valueAsString.match(regexp);
    return (match) ? match.join() : "";
  }
  _getReferenceSet() {
    return new Promise(resolve => {
      getAttrs([this._reference], attributes => {
        let values = "";
        Object.keys(attributes).some(() => {
          values += attributes[this._reference];
          return true;
        });
        const flags = values.split(this._delimiter).filter(e => {return e});
        return resolve(new RefereceSet(flags));
      });
    });
  }
  _setReference(sanitizedFlag, method) {
    return new Promise(resolve => {
      getAttrs([this._reference], attributes => {
        let values = "";
        Object.keys(attributes).some(() => {
          values += attributes[this._reference];
          return true;
        });
        const flags = new RefereceSet(values.split(this._delimiter).filter(e => {return e}));
        flags[method](sanitizedFlag);
        const flagAsString = Array.from(flags).join(this._delimiter);
        let update = {};
        update[this._reference] = flagAsString;
        setAttrs(update, () => {
          return resolve(flags);
        });
      });
    });
  }
  _sanitizeFlag(flag) {
    const regex = new RegExp(`${this._delimiter}`, 'g');
    const sanitizedFlag = flag.replace(regex, this._delimiterSafe);
    return sanitizedFlag;
  }
}
  
const errorMessage = (name, error) => console.error(`%c ${name}: ${error}`, "color: orange; font-weight:14px;");
const warningMessage = (name, error) => console.warn(`%c ${name}: ${error}`, "color: gold; font-weight:14px;");

const checkSourceForSheetworker = eventinfo => eventinfo.sourceType && eventinfo.sourceType != "sheetworker" ? true : false

// Example: -m2jzgfth07mvwp3hhng
const getReprowid = sourceAttribute => sourceAttribute.split('_')[2]

// Example: repeating_tool_-m2jzgfth07mvwp3hhng
const getRepeatingSectionPrefix = sourceAttribute => {
    const split = sourceAttribute.split('_');
    return `${split[0]}_${split[1]}_${split[2]}`
}

// Example: repeating_tool_-m2jzgfth07mvwp3hhng_attkflag returns attkflag
const getAttrNameAtEndRepeating = sourceAttribute => {
	const repeatingSplit = sourceAttribute.split('_')
	const repeatingSplice = repeatingSplit.splice(3)
	const repeatingAttrName = repeatingSplice.length > 1 ? repeatingSplice.join('_') : repeatingSplice[0]
	return repeatingAttrName
}

  // Create a collective list of attributs to reduce redundancy
var abilityList = [
  "Strength",
  "Dexterity",
  "Constitution",
  "Intelligence",
  "Wisdom",
  "Charisma",
];
var abilityListEnabledOptionals = [];
const globalAttributesByCategory = {
  abilities: [
    "strength",
    "dexterity",
    "constitution",
    "intelligence",
    "wisdom",
    "charisma",
  ],
  abilitiesWithAllOptionals: [
    "strength",
    "dexterity",
    "constitution",
    "intelligence",
    "wisdom",
    "charisma",
    "honor",
    "sanity",
  ],
  classes: [
    "artificer",
    "barbarian",
    "bard",
    "cleric",
    "druid",
    "fighter",
    "monk",
    "paladin",
    "ranger",
    "rogue",
    "sorcerer",
    "warlock",
    "wizard",
  ],
  hitDieTypes: ["d4", "d6", "d8", "d10", "d12"],
  spellLevels: ["cantrip", "1", "2", "3"],
  traitsTypes: ["Background", "Feats", "Racial", "Class", "Other"],
  proficiencyTypes: ["LANGUAGE", "ARMOR", "WEAPON", "OTHER"],
  skills: {
    strength: ["athletics"],
    constitution: [],
    dexterity: ["acrobatics", "sleight_of_hand", "stealth"],
    intelligence: ["arcana", "history", "investigation", "nature", "religion"],
    wisdom: [
      "animal_handling",
      "insight",
      "medicine",
      "perception",
      "survival",
    ],
    charisma: ["deception", "intimidation", "performance", "persuasion"],
    honor: [],
    sanity: [],
    all: () => {
      return [
        ...globalAttributesByCategory.skills.strength,
        ...globalAttributesByCategory.skills.dexterity,
        ...globalAttributesByCategory.skills.intelligence,
        ...globalAttributesByCategory.skills.wisdom,
        ...globalAttributesByCategory.skills.charisma,
      ];
    },
    getParentAbility: (skill) => {
      let parent = "";
      globalAttributesByCategory["abilities"].forEach((ability) => {
        if (globalAttributesByCategory.skills[ability].indexOf(skill) > -1) {
          parent = ability;
          return;
        }
      });
      return parent;
    },
  },
};

//Overwrites default defaultGetCharmancerData
var defaultGetCharmancerData = getCharmancerData;
var getCharmancerData = function () {
  const data = defaultGetCharmancerData();
  includeLPFeatsInCharmancerData(data);
  return data;
};
var includeLPFeatsInCharmancerData = function (data) {
  if (SheetUtils.checkPath(data, "['lp-asi']['values']")) {
    var feats = {};
    Object.keys(data["lp-asi"]["values"]).forEach((value) => {
      if (
        value.indexOf("asi-row_switch") &&
        data["lp-asi"]["values"][value] === "feat"
      ) {
        const rowID = SheetUtils.getUID(value);
        const rowName = `repeating_${rowID}_asi-row_feat`;
        if (
          SheetUtils.checkPath(data, `['lp-asi']['values']['${rowName}_data']`)
        ) {
          const featData = JSON.parse(
            data["lp-asi"]["values"][`${rowName}_data`]
          );
          //delete data['lp-asi']['values'][`${rowName}_data`];
          data["lp-asi"]["data"][rowName] = featData;
        }
      }
    });
  }
};

//Start of Compendium Drops
on("sheet:compendium-drop", function () {
  getAttrs(
    [
      "hp_max",
      "npc_senses",
      "token_size",
      "cd_bar1_v",
      "cd_bar1_m",
      "cd_bar1_l",
      "cd_bar2_v",
      "cd_bar2_m",
      "cd_bar2_l",
      "cd_bar3_v",
      "cd_bar3_m",
      "cd_bar3_l",
    ],
    function (v) {
      var default_attr = {};
      default_attr["width"] = 70;
      default_attr["height"] = 70;
      if (
        v["npc_senses"]
          .toLowerCase()
          .match(/(darkvision|blindsight|tremorsense|truesight)/)
      ) {
        const nightVisionRange = Math.max.apply(
          Math,
          v["npc_senses"].match(/\d+/g)
        );
        //LDL
        default_attr["light_radius"] = nightVisionRange;
        //UDL
        default_attr["has_bright_light_vision"] = "on"; //Toggles Vision On
        default_attr["has_low_light_vision"] = "on"; //Toggles Vision On
        default_attr["has_night_vision"] = "on"; //Toggles Night Vision On
        default_attr["night_vision_distance"] = nightVisionRange; //Set Night Vision Range
      }
      if (v["token_size"]) {
        var squarelength = 70;
        if (v["token_size"].toString().indexOf(",") > -1) {
          var setwidth = !isNaN(v["token_size"].split(",")[0])
            ? v["token_size"].split(",")[0]
            : 1;
          var setheight = !isNaN(v["token_size"].split(",")[1])
            ? v["token_size"].split(",")[1]
            : 1;
          default_attr["width"] = setwidth * squarelength;
          default_attr["height"] = setheight * squarelength;
        } else {
          default_attr["width"] = squarelength * v["token_size"];
          default_attr["height"] = squarelength * v["token_size"];
        }
      }

      var getList = {};
      for (x = 1; x <= 3; x++) {
        _.each(["v", "m"], function (letter) {
          var keyname = "cd_bar" + x + "_" + letter;
          if (v[keyname] != undefined && isNaN(v[keyname])) {
            getList[keyname] = v[keyname];
          }
        });
      }

      getAttrs(_.values(getList), function (values) {
        _.each(_.keys(getList), function (keyname) {
          v[keyname] =
            values[getList[keyname]] == undefined
              ? ""
              : values[getList[keyname]];
        });

        if (v["cd_bar1_l"]) {
          default_attr["bar1_link"] = v["cd_bar1_l"];
        } else if (v["cd_bar1_v"] || v["cd_bar1_m"]) {
          if (v["cd_bar1_v"]) {
            default_attr["bar1_value"] = v["cd_bar1_v"];
          }
          if (v["cd_bar1_m"]) {
            default_attr["bar1_max"] = v["cd_bar1_m"];
          }
        } else {
          default_attr["bar1_value"] = v["hp_max"];
          default_attr["bar1_max"] = v["hp_max"];
        }

        if (v["cd_bar2_l"]) {
          default_attr["bar2_link"] = v["cd_bar2_l"];
        } else if (v["cd_bar2_v"] || v["cd_bar2_m"]) {
          if (v["cd_bar2_v"]) {
            default_attr["bar2_value"] = v["cd_bar2_v"];
          }
          if (v["cd_bar2_m"]) {
            default_attr["bar2_max"] = v["cd_bar2_m"];
          }
        } else {
          default_attr["bar2_link"] = "npc_ac";
        }

        if (v["cd_bar3_l"]) {
          default_attr["bar3_link"] = v["cd_bar3_l"];
        } else if (v["cd_bar3_v"] || v["cd_bar3_m"]) {
          if (v["cd_bar3_v"]) {
            default_attr["bar3_value"] = v["cd_bar3_v"];
          }
          if (v["cd_bar3_m"]) {
            default_attr["bar3_max"] = v["cd_bar3_m"];
          }
        }

        setDefaultToken(default_attr);
      });
    }
  );
});

globalAttributesByCategory.abilitiesWithAllOptionals.forEach((attr) => {
  on(`change:${attr}_base change:${attr}_bonus`, function () {
    update_attr(`${attr}`);
  });
});

globalAttributesByCategory.abilitiesWithAllOptionals.forEach((attr) => {
  on(`change:${attr}`, function () {
    update_mod(`${attr}`);

    const cap = attr.charAt(0).toUpperCase() + attr.slice(1);
    check_customac(cap);

    attr === "strength" ? update_weight() : false;
    attr === "dexterity" ? update_initiative() : false;
  });
});

globalAttributesByCategory.abilitiesWithAllOptionals.forEach((attr) => {
  on(`change:${attr}_mod`, function () {
    update_save(`${attr}`);
    update_attacks(`${attr}`);
    update_tool(`${attr}`);
    update_spell_info(`${attr}`);

    switch (`${attr}`) {
      case "strength":
        update_skills(["athletics"]);
        break;
      case "dexterity":
        update_skills(["acrobatics", "sleight_of_hand", "stealth"]);
        update_ac();
        update_initiative();
        break;
      case "intelligence":
        update_skills([
          "arcana",
          "history",
          "investigation",
          "nature",
          "religion",
        ]);
        break;
      case "wisdom":
        update_skills([
          "animal_handling",
          "insight",
          "medicine",
          "perception",
          "survival",
        ]);
        break;
      case "charisma":
        update_skills([
          "deception",
          "intimidation",
          "performance",
          "persuasion",
        ]);
        break;
      default:
        false;
    }
  });
});

globalAttributesByCategory.abilitiesWithAllOptionals.forEach((attr) => {
  on(`change:${attr}_save_prof change:${attr}_save_mod`, function (eventinfo) {
    checkSourceForSheetworker(eventinfo) ? update_save(`${attr}`) : false;
  });
});

on("change:globalsavemod", function (eventinfo) {
  checkSourceForSheetworker(eventinfo) ? update_all_saves() : false;
});

on("change:death_save_mod", function (eventinfo) {
  checkSourceForSheetworker(eventinfo) ? update_save("death") : false;
});

globalAttributesByCategory.skills.all().forEach((attr) => {
  on(
    `change:${attr}_prof change:${attr}_type change:${attr}_flat`,
    function (eventinfo) {
      checkSourceForSheetworker(eventinfo) ? update_skills([`${attr}`]) : false;
    }
  );
});

on(
  "change:repeating_tool:toolname change:repeating_tool:toolbonus_base change:repeating_tool:toolattr_base change:repeating_tool:tool_mod",
  function (eventinfo) {
    const repeatingRowID = getReprowid(eventinfo.sourceAttribute);
    checkSourceForSheetworker(eventinfo) ? update_tool(repeatingRowID) : false;
  }
);

on(
  "change:repeating_attack:atkname change:repeating_attack:atkflag change:repeating_attack:atkattr_base change:repeating_attack:atkmod change:repeating_attack:atkmagic change:repeating_attack:atkcritrange change:repeating_attack:atkprofflag change:repeating_attack:dmgflag change:repeating_attack:dmgbase change:repeating_attack:dmgattr change:repeating_attack:dmgmod change:repeating_attack:dmgtype change:repeating_attack:dmg2flag change:repeating_attack:dmg2base change:repeating_attack:dmg2attr change:repeating_attack:dmg2mod change:repeating_attack:dmg2type change:repeating_attack:saveflag change:repeating_attack:savedc change:repeating_attack:saveflat change:repeating_attack:dmgcustcrit change:repeating_attack:dmg2custcrit change:repeating_attack:ammo change:repeating_attack:saveattr change:repeating_attack:atkrange",
  function (eventinfo) {
    if (checkSourceForSheetworker(eventinfo)) {
      var source = getAttrNameAtEndRepeating(eventinfo.sourceAttribute);
      var attackid = getReprowid(eventinfo.sourceAttribute);

      if (source == "atkattr_base" || source == "savedc") {
        getAttrs(
          ["repeating_attack_spellid", "repeating_attack_spelllevel"],
          function (v) {
            set = {};
            if (
              v.repeating_attack_spellid &&
              v.repeating_attack_spellid != "" &&
              v.repeating_attack_spelllevel &&
              v.repeating_attack_spelllevel != ""
            ) {
              var newVal =
                eventinfo.newValue == "spell"
                  ? "spell"
                  : _.last(eventinfo.newValue.split("_")[0].split("{"));
              set["repeating_attack_atkattr_base"] =
                newVal == "spell" ? "spell" : "@{" + newVal + "_mod}";
              set["repeating_attack_savedc"] =
                newVal == "spell" ? "spell" : "(@{" + newVal + "_mod}+8+@{pb})";
              set[
                "repeating_spell-" +
                  v.repeating_attack_spelllevel +
                  "_" +
                  v.repeating_attack_spellid +
                  "_spell_ability"
              ] = newVal == "spell" ? "spell" : "@{" + newVal + "_mod}+";
            }
            setAttrs(set, function () {
              update_attacks(attackid);
            });
          }
        );
      } else {
        update_attacks(attackid);
      }
    }
  }
);

on("change:default_critical_range", function (eventinfo) {
  if (checkSourceForSheetworker(eventinfo)) {
    update_attacks("all");
  }
});

on(
  "change:repeating_damagemod remove:repeating_damagemod",
  function (eventinfo) {
    update_globaldamage();
  }
);

on("change:global_damage_mod_flag", function (eventinfo) {
  getSectionIDs("damagemod", function (ids) {
    var update = {};
    if (eventinfo.newValue === "1") {
      if (!ids || ids.length === 0) {
        var rowid = generateRowID();
        update[`repeating_damagemod_${rowid}_global_damage_active_flag`] = "1";
      }
    } else {
      _.each(ids, function (rowid) {
        update[`repeating_damagemod_${rowid}_global_damage_active_flag`] = "0";
      });
    }
    setAttrs(update);
  });
});

on("change:exhaustion_toggle", function (eventinfo) {
  if (eventinfo.newValue !== "0") {
    getAttrs(["exhaustion_level"], function (attrs) {
      if (!attrs.exhaustion_level || attrs.exhaustion_level === "") {
        var update = {};
        update.exhaustion_level = "0";
        setAttrs(update);
      }
    });
  }
});

on("change:exhaustion_level", function (eventinfo) {
  const newValue = parseInt(eventinfo.newValue) || 0,
    previousValue = parseInt(eventinfo.previousValue) || 0;
  let update = {};

  if (newValue === 0) {
    //If exhaustion is 0 the reset exhaustion_1 to "No Effect" and blank the other spans
    for (let i = 2; i <= 6; i++) {
      update[`exhaustion_${i}`] = "";
    }
    update[`exhaustion_1`] = "• " + getTranslationByKey(`exhaustion-0`);
  } else if (newValue > previousValue) {
    //If exhaustion increase then add text to the spans
    for (let i = previousValue; i <= newValue; i++) {
      update[`exhaustion_${i}`] = "• " + getTranslationByKey(`exhaustion-${i}`);
    }
  } else {
    //If exhaustion decrease remove text from spans
    for (let i = newValue + 1; i <= previousValue; i++) {
      update[`exhaustion_${i}`] = "";
    }
  }

  setAttrs(update, { silent: true });
});

on("change:race change:subrace", function (eventinfo) {
  update_race_display();
});

on(`change:repeating_inventory:hasattack`, function (eventinfo) {
  if (checkSourceForSheetworker(eventinfo)) {
    const itemid = getReprowid(eventinfo.sourceAttribute);
    getAttrs([`repeating_inventory_${itemid}_itemattackid`], function (v) {
      const hasattack = eventinfo.newValue,
        itemattackid = v[`repeating_inventory_${itemid}_itemattackid`];
      hasattack == 1
        ? create_attack_from_item(itemid)
        : remove_attack(itemattackid);
    });
  }
});

on(`change:repeating_inventory:useasresource`, function (eventinfo) {
  if (checkSourceForSheetworker(eventinfo)) {
    const itemid = getReprowid(eventinfo.sourceAttribute);
    getAttrs([`repeating_inventory_${itemid}_itemresourceid`], function (v) {
      const useasresource = eventinfo.newValue,
        itemresourceid = v[`repeating_inventory_${itemid}_itemresourceid`];
      useasresource == 1
        ? create_resource_from_item(itemid)
        : remove_resource(itemresourceid);
    });
  }
});

on(
  "change:repeating_inventory:itemname change:repeating_inventory:itemproperties change:repeating_inventory:itemmodifiers change:repeating_inventory:itemcount",
  function (eventinfo) {
    if (checkSourceForSheetworker(eventinfo)) {
      var itemid = getReprowid(eventinfo.sourceAttribute);
      getAttrs(
        [
          "repeating_inventory_" + itemid + "_itemattackid",
          "repeating_inventory_" + itemid + "_itemresourceid",
        ],
        function (v) {
          var attackid = v["repeating_inventory_" + itemid + "_itemattackid"];
          var resourceid =
            v["repeating_inventory_" + itemid + "_itemresourceid"];
          if (attackid) {
            update_attack_from_item(itemid, attackid);
          }
          if (resourceid) {
            update_resource_from_item(itemid, resourceid);
          }
        }
      );
    }
  }
);

[
  "other_resource",
  "repeating_resource:resource_left",
  "repeating_resource:resource_right",
].forEach((attr) => {
  on(`change:${attr} change:${attr}_name`, (eventinfo) => {
    if (checkSourceForSheetworker(eventinfo)) {
      const resourceid = eventinfo.sourceAttribute.includes("_name")
        ? eventinfo.sourceAttribute.slice(0, -5)
        : eventinfo.sourceAttribute;
      getAttrs([`${resourceid}_itemid`], (v) => {
        const value = eventinfo.newValue;
        //Update repeating_inventory if an itemid is associated with a resource
        if (v[`${resourceid}_itemid`] && v[`${resourceid}_itemid`] != "") {
          const itemid = v[`${resourceid}_itemid`];
          let update = {};
          if (eventinfo.sourceAttribute.includes("_name")) {
            update[`repeating_inventory_${itemid}_itemname`] =
              eventinfo.newValue;
          } else {
            update[`repeating_inventory_${itemid}_itemcount`] =
              eventinfo.newValue;
          }
          setAttrs(update, { silent: true }, () => {
            update_weight();
          });
        }
      });
    }
  });
});

on(
  "change:repeating_inventory:itemweight change:repeating_inventory:itemcount change:repeating_inventory:equipped change:cp change:sp change:ep change:gp change:pp change:encumbrance_setting change:size change:carrying_capacity_mod change:ingore_non_equipped_weight",
  function () {
    update_weight();
  }
);

on(
  "change:repeating_inventory:itemmodifiers change:repeating_inventory:equipped",
  function (eventinfo) {
    if (checkSourceForSheetworker(eventinfo)) {
      var itemid = getReprowid(eventinfo.sourceAttribute);
      getAttrs(
        ["repeating_inventory_" + itemid + "_itemmodifiers"],
        function (v) {
          if (v["repeating_inventory_" + itemid + "_itemmodifiers"]) {
            check_itemmodifiers(
              v["repeating_inventory_" + itemid + "_itemmodifiers"],
              eventinfo.previousValue
            );
          }
        }
      );
    }
  }
);

on(
  "change:custom_ac_flag change:custom_ac_base change:custom_ac_part1 change:custom_ac_part2 change:custom_ac_shield",
  function (eventinfo) {
    checkSourceForSheetworker(eventinfo) ? update_ac() : false;
  }
);

[
  "spell-cantrip",
  "spell-1",
  "spell-2",
  "spell-3",
].forEach((attr) => {
  on(
    `change:repeating_${attr}:includedesc change:repeating_${attr}:innate change:repeating_${attr}:spell_ability change:repeating_${attr}:spell_updateflag change:repeating_${attr}:spellathigherlevels change:repeating_${attr}:spellattack change:repeating_${attr}:spelldamage change:repeating_${attr}:spelldamage2 change:repeating_${attr}:spelldamagetype change:repeating_${attr}:spelldamagetype2 change:repeating_${attr}:spelldescription change:repeating_${attr}:spelldmgmod change:repeating_${attr}:spellhealing change:repeating_${attr}:spellhlbonus change:repeating_${attr}:spellhldie change:repeating_${attr}:spellhldietype change:repeating_${attr}:spellname change:repeating_${attr}:spellprepared change:repeating_${attr}:spellrange change:repeating_${attr}:spellsave change:repeating_${attr}:spellsavesuccess change:repeating_${attr}:spelltarget change:repeating_${attr}:spell_damage_progression`,
    (eventinfo) => {
      if (checkSourceForSheetworker(eventinfo)) {
        const spellid = eventinfo.sourceAttribute.split("_")[2],
          repeating_source = `repeating_${attr}_${spellid}`;
        getAttrs([`${repeating_source}_spellattackid`, "character_id"], (v) => {
          var attackid = v[`${repeating_source}_spellattackid`];
          var lvl = attr.split("spell-")[1];
          if (attackid && lvl && spellid) {
            update_attack_from_spell(
              lvl,
              spellid,
              attackid,
              false,
              v["character_id"]
            );
          }
        });
      }
    }
  );
});

[
  "spell-cantrip",
  "spell-1",
  "spell-2",
  "spell-3",
].forEach((attr) => {
  on(`change:repeating_${attr}:spelloutput`, (eventinfo) => {
    if (checkSourceForSheetworker(eventinfo)) {
      const spellid = eventinfo.sourceAttribute.split("_")[2],
        repeating_source = `repeating_${attr}_${spellid}`;
      getAttrs(
        [
          `${repeating_source}_spellattackid`,
          `${repeating_source}_spelllevel`,
          `${repeating_source}_spellathigherlevels`,
          "character_id",
        ],
        function (v) {
          const attackid = v[repeating_source + "_spellattackid"];
          const higherlevels = v[repeating_source + "_spellathigherlevels"];
          const spelloutput = eventinfo.newValue;
          let lvl = v[repeating_source + "_spelllevel"];

          if (spelloutput && spelloutput === "ATTACK") {
            create_attack_from_spell(lvl, spellid, v["character_id"]);
          } else if (
            spelloutput &&
            spelloutput === "SPELLCARD" &&
            attackid &&
            attackid != ""
          ) {
            let lvl = parseInt(v[repeating_source + "_spelllevel"], 10);
            remove_attack(attackid);
            update_spelloutput(
              higherlevels,
              lvl,
              repeating_source,
              spelloutput
            );
          }
        }
      );
    }
  });
});

[
  "spell-cantrip",
  "spell-1",
  "spell-2",
  "spell-3",
].forEach((attr) => {
  on(`change:repeating_${attr}:spellathigherlevels`, (eventinfo) => {
    if (checkSourceForSheetworker(eventinfo)) {
      const spellid = eventinfo.sourceAttribute.split("_")[2],
        repeating_source = `repeating_${attr}_${spellid}`;
      getAttrs(
        [`${repeating_source}_spelllevel`, `${repeating_source}_spelloutput`],
        function (v) {
          const higherlevels = eventinfo.newValue;
          const lvl = parseInt(v[repeating_source + "_spelllevel"], 10);
          const spelloutput = v[repeating_source + "_spelloutput"];

          if (spelloutput && spelloutput === "SPELLCARD") {
            update_spelloutput(
              higherlevels,
              lvl,
              repeating_source,
              spelloutput
            );
          }
        }
      );
    }
  });
});

const update_spelloutput = (
  higherlevels,
  lvl,
  repeating_source,
  spelloutput
) => {
  let spelllevel = "@{spelllevel}";
  let update = {};

  if (higherlevels) {
    for (i = 0; i < 3 - lvl; i++) {
      let tot = parseInt(i, 3) + parseInt(lvl, 3);
      spelllevel = spelllevel + "|Level " + tot + "," + tot;
    }
    spelllevel = `?{Cast at what level? ${spelllevel}}`;
  }
  update[
    repeating_source + "_rollcontent"
  ] = `@{wtype}&{template:spell} {{level=@{spellschool} ${spelllevel}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} {{savedc=@{spell_save_dc}}} @{spellconcentration} @{charname_output}`;
  setAttrs(update, { silent: true });
};

on(
  "change:class change:custom_class change:cust_classname change:cust_hitdietype change:cust_spellcasting_ability change:cust_spellslots change:cust_strength_save_prof change:cust_dexterity_save_prof change:cust_constitution_save_prof change:cust_intelligence_save_prof change:cust_wisdom_save_prof change:cust_charisma_save_prof change:subclass change:multiclass1 change:multiclass1_subclass change:multiclass2 change:multiclass2_subclass change:multiclass3 change:multiclass3_subclass",
  function (eventinfo) {
    checkSourceForSheetworker(eventinfo) ? update_class() : false;
  }
);

on(
  "change:level change:arcane_fighter change:arcane_rogue",
  function (eventinfo) {
    checkSourceForSheetworker(eventinfo) ? set_level() : false;
  }
);

on(
  "sheet:open change:level_calculations change:level change:lvl1_slots_mod change:lvl2_slots_mod change:lvl3_slots_mod", (eventInfo) => {
    update_spell_slots();
  }
);

on("change:caster_level", function (eventinfo) {
  getAttrs(["caster_level", "npc"], function (v) {
    var casterlvl =
      v["caster_level"] && !isNaN(parseInt(v["caster_level"], 10))
        ? parseInt(v["caster_level"], 10)
        : 0;
    if (v["npc"] && v["npc"] == 1 && casterlvl > 0) {
      setAttrs({ level: casterlvl });
    }
  });
});

on("change:pb_type change:pb_custom", function (eventinfo) {
  checkSourceForSheetworker(eventinfo) ? update_pb() : false;
});

on("change:dtype", function (eventinfo) {
  if (checkSourceForSheetworker(eventinfo)) {
    update_attacks("all");
    update_npc_action("all");
  }
});

on("change:jack_of_all_trades", function (eventinfo) {
  if (checkSourceForSheetworker(eventinfo)) {
    update_jack_attr();
    update_all_ability_checks();
  }
});

on("change:initmod change:init_tiebreaker", function (eventinfo) {
  checkSourceForSheetworker(eventinfo) ? update_initiative() : false;
});

on(
  "change:spellcasting_ability change:spell_dc_mod change:globalmagicmod",
  function (eventinfo) {
    checkSourceForSheetworker(eventinfo) ? update_spell_info() : false;
  }
);

on("change:npc_challenge", function () {
  update_challenge();
});

on(
  "change:npc_str_save_base change:npc_dex_save_base change:npc_con_save_base change:npc_int_save_base change:npc_wis_save_base change:npc_cha_save_base",
  function (eventinfo) {
    update_npc_saves();
  }
);

on(
  "change:npc_acrobatics_base change:npc_animal_handling_base change:npc_arcana_base change:npc_athletics_base change:npc_deception_base change:npc_history_base change:npc_insight_base change:npc_intimidation_base change:npc_investigation_base change:npc_medicine_base change:npc_nature_base change:npc_perception_base change:npc_performance_base change:npc_persuasion_base change:npc_religion_base change:npc_sleight_of_hand_base change:npc_stealth_base change:npc_survival_base",
  function (eventinfo) {
    update_npc_skills();
  }
);

["npcaction", "npcbonusaction", "npcaction-l", "npcaction-m"].forEach(
  (fieldset) => {
    [
      "attack_flag",
      "attack_type",
      "attack_range",
      "attack_target",
      "attack_tohit",
      "attack_damage",
      "attack_damagetype",
      "attack_damage2",
      "attack_damagetype2",
      "show_desc",
      "description",
    ].forEach((property) => {
      on(`change:repeating_${fieldset}:${property}`, (eventInfo) => {
        const actionid = eventInfo.sourceAttribute.split("_")[2];
        update_npc_action(actionid, fieldset);
      });
    });
  }
);

on("change:core_die change:halflingluck_flag", function () {
  getAttrs(["core_die", "halflingluck_flag"], function (v) {
    core = v.core_die && v.core_die != "" ? v.core_die : "1d20";
    luck = v.halflingluck_flag && v.halflingluck_flag === "1" ? "ro<1" : "";
    update = {};
    update["d20"] = core + luck;
    if (!v.core_die || v.core_die === "") {
      update["core_die"] = "1d20";
    }
    setAttrs(update);
  });
});

on("change:powerful_build", function () {
  update_weight();
});

[`ac`, `attack`, "save", "skill"].forEach((attr) => {
  on(`change:global_${attr}_mod_flag`, (eventinfo) => {
    const mod = attr === "attack" ? "tohitmod" : `${attr}mod`;
    if (eventinfo.newValue === "1") {
      const firstAttr = attr === "ac" ? "val" : "roll";
      const firstAttrValue = attr === "ac" ? 1 : "1d4";
      const secondAttrValue =
        attr === "ac" ? "Defense" : attr === "skill" ? "GUIDANCE" : "BLESS";

      getSectionIDs(mod, (ids) => {
        if (!ids || ids.length === 0) {
          var update = {};
          var rowid = generateRowID();
          update[
            `repeating_${mod}_${rowid}_global_${attr}_${firstAttr}`
          ] = `${firstAttrValue}`;
          update[
            `repeating_${mod}_${rowid}_global_${attr}_name`
          ] = `${secondAttrValue}`;
          update[`repeating_${mod}_${rowid}_global_${attr}_active_flag`] = "1";
          setAttrs(update);
        }
      });
    } else {
      getSectionIDs(mod, function (ids) {
        var update = {};
        var rowid = generateRowID();
        _.each(ids, function (rowid) {
          update[`repeating_${mod}_${rowid}_global_${attr}_active_flag`] = "0";
        });
        setAttrs(update);
      });
    }
  });
});

on("change:repeating_skillmod remove:repeating_skillmod", function (eventinfo) {
  update_globalskills();
});

on("change:repeating_savemod remove:repeating_savemod", function (eventinfo) {
  update_globalsaves();
});

on("change:repeating_tohitmod remove:repeating_tohitmod", function (eventinfo) {
  update_globalattack();
});

on("change:repeating_acmod remove:repeating_acmod", function (eventinfo) {
  update_ac();
});

on("clicked:confirm_npc", eventInfo => {
  setAttrs({ monster_confirm_flag: "" });
  getAttrs(["drop_category"], function (v) {
    if (v["drop_category"]) {
      handle_drop(v["drop_category"]);
    }
  });
});

on("clicked:reject_npc", function (eventinfo) {
  setAttrs({ monster_confirm_flag: "" });
  var update = {};
  update["drop_category"] = "";
  update["drop_name"] = "";
  update["drop_data"] = "";
  update["drop_content"] = "";
  setAttrs(update, { silent: true });
});

on("change:mancer_confirm", function (eventinfo) {
  setAttrs(
    { mancer_confirm_flag: "", charactermancer_step: "l1-welcome" },
    function () {
      check_l1_mancer();
    }
  );
});

on("change:mancer_cancel", function (eventinfo) {
  setAttrs(
    { mancer_confirm_flag: "", l1mancer_status: "completed" },
    function () {
      check_l1_mancer();
    }
  );
});

on("change:mancer_npc", function (eventinfo) {
  setAttrs(
    { mancer_confirm_flag: "", l1mancer_status: "completed", npc: "1" },
    function () {
      check_l1_mancer();
    }
  );
});

on("change:passiveperceptionmod", function (eventinfo) {
  update_passive_perception();
});

on("remove:repeating_inventory", function (eventinfo) {
  var itemid = getReprowid(eventinfo.sourceAttribute);
  var attackids =
    eventinfo.removedInfo &&
    eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemattackid"]
      ? eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemattackid"]
      : undefined;
  var resourceid =
    eventinfo.removedInfo &&
    eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemresourceid"]
      ? eventinfo.removedInfo[
          "repeating_inventory_" + itemid + "_itemresourceid"
        ]
      : undefined;

  if (attackids) {
    _.each(attackids.split(","), function (value) {
      remove_attack(value);
    });
  }
  if (resourceid) {
    remove_resource(resourceid);
  }

  if (
    eventinfo.removedInfo &&
    eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemmodifiers"]
  ) {
    check_itemmodifiers(
      eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemmodifiers"]
    );
  }

  update_weight();
});

on("remove:repeating_attack", function (eventinfo) {
  var attackid = getReprowid(eventinfo.sourceAttribute);
  var itemid =
    eventinfo.removedInfo["repeating_attack_" + attackid + "_itemid"];
  var spellid =
    eventinfo.removedInfo["repeating_attack_" + attackid + "_spellid"];
  var spelllvl =
    eventinfo.removedInfo["repeating_attack_" + attackid + "_spelllevel"];
  if (itemid) {
    getAttrs(["repeating_inventory_" + itemid + "_hasattack"], function (v) {
      if (
        v["repeating_inventory_" + itemid + "_hasattack"] &&
        v["repeating_inventory_" + itemid + "_hasattack"] == 1
      ) {
        var update = {};
        update["repeating_inventory_" + itemid + "_itemattackid"] = "";
        update["repeating_inventory_" + itemid + "_hasattack"] = 0;
        setAttrs(update, { silent: true });
      }
    });
  }
  if (spellid && spelllvl) {
    getAttrs(
      ["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"],
      function (v) {
        if (
          v["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"] &&
          v["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"] ==
            "ATTACK"
        ) {
          var update = {};
          update[
            "repeating_spell-" + spelllvl + "_" + spellid + "_spellattackid"
          ] = "";
          update[
            "repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"
          ] = "SPELLCARD";
          setAttrs(update, { silent: true });
        }
      }
    );
  }
});

on("remove:repeating_resource", function (eventinfo) {
  const resourceid = getReprowid(eventinfo.sourceAttribute);
  let update = {};

  _.each(["left", "right"], (side) => {
    const itemid =
      eventinfo.removedInfo[
        `repeating_resource_${resourceid}_resource_${side}_itemid`
      ];
    if (itemid) {
      update[`repeating_inventory_${itemid}_useasresource`] = 0;
      update[`repeating_inventory_${itemid}_itemresourceid`] = "";
    }
  });

  setAttrs(update, { silent: true });
});

on(
  "remove:repeating_spell-cantrip remove:repeating_spell-1 remove:repeating_spell-2 remove:repeating_spell-3 remove:repeating_spell-4 remove:repeating_spell-5 remove:repeating_spell-6 remove:repeating_spell-7 remove:repeating_spell-8 remove:repeating_spell-9",
  function (eventinfo) {
    var attackid =
      eventinfo.removedInfo[eventinfo.sourceAttribute + "_spellattackid"];
    if (attackid) {
      remove_attack(attackid);
    }
  }
);

on("clicked:relaunch_lvl1mancer", function (eventinfo) {
  getAttrs(["l1mancer_status"], function (v) {
    if (v["l1mancer_status"] === "completed") {
      setAttrs({ l1mancer_status: "relaunch" });
    }
    check_l1_mancer();
  });
});

on("clicked:launch_lvl+mancer", function (eventinfo) {
  getAttrs(
    [
      "class",
      "level",
      "hp_max",
      "custom_class",
      "multiclass1_flag",
      "multiclass2_flag",
      "multiclass3_flag",
      "multiclass1",
      "multiclass2",
      "multiclass3",
    ],
    function (v) {
      var throw_warning = false;
      var class_array = [v["class"]];
      if (
        !v["class"] ||
        !v["hp_max"] ||
        isNaN(parseInt(v["hp_max"], 10)) ||
        !v["level"] ||
        isNaN(parseInt(v["level"], 10)) ||
        parseInt(v["level"], 10) < 1 ||
        (v["multiclass2_flag"] == 1 && v["multiclass1_flag"] == 0) ||
        (v["multiclass3_flag"] == 1 && v["multiclass2_flag"] == 0)
      ) {
        throw_warning = true;
      }

      if (v["multiclass1_flag"] == 1) {
        class_array.push(v["multiclass1"]);
      }
      if (v["multiclass2_flag"] == 1) {
        class_array.push(v["multiclass2"]);
      }
      if (v["multiclass3_flag"] == 1) {
        class_array.push(v["multiclass3"]);
      }
      // Check to see if there are any duplicate multiclasses
      if (new Set(class_array).size !== class_array.length) {
        throw_warning = true;
      }

      if (throw_warning === true) {
        setAttrs({ leveler_warningflag: "show" });
        return;
      }

      setAttrs({ lpmancer_status: "active" }, function () {
        startCharactermancer("lp-welcome");
      });
    }
  );
});

on("change:experience", function (eventinfo) {
  update_leveler_display();
});

var update_attr = function (attr) {
  var update = {};
  var attr_fields = [attr + "_base", attr + "_bonus"];
  getSectionIDs("repeating_inventory", function (idarray) {
    _.each(idarray, function (currentID, i) {
      attr_fields.push("repeating_inventory_" + currentID + "_equipped");
      attr_fields.push("repeating_inventory_" + currentID + "_itemmodifiers");
    });
    getAttrs(attr_fields, function (v) {
      var base =
        v[attr + "_base"] && !isNaN(parseInt(v[attr + "_base"], 10))
          ? parseInt(v[attr + "_base"], 10)
          : 10;
      var bonus =
        v[attr + "_bonus"] && !isNaN(parseInt(v[attr + "_bonus"], 10))
          ? parseInt(v[attr + "_bonus"], 10)
          : 0;
      var item_base = 0;
      var item_bonus = 0;
      _.each(idarray, function (currentID) {
        if (
          (!v["repeating_inventory_" + currentID + "_equipped"] ||
            v["repeating_inventory_" + currentID + "_equipped"] === "1") &&
          v["repeating_inventory_" + currentID + "_itemmodifiers"] &&
          v["repeating_inventory_" + currentID + "_itemmodifiers"]
            .toLowerCase()
            .indexOf(attr > -1)
        ) {
          var mods = v["repeating_inventory_" + currentID + "_itemmodifiers"]
            .toLowerCase()
            .split(",");
          _.each(mods, function (mod) {
            if (mod.indexOf(attr) > -1 && mod.indexOf("save") === -1) {
              if (mod.indexOf(":") > -1) {
                var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                  ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                  : false;
                item_base =
                  new_base && new_base > item_base ? new_base : item_base;
              } else if (mod.indexOf("-") > -1) {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                  ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                  : false;
                item_bonus = new_mod ? item_bonus - new_mod : item_bonus;
              } else {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                  ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                  : false;
                item_bonus = new_mod ? item_bonus + new_mod : item_bonus;
              }
            }
          });
        }
      });

      update[attr + "_flag"] =
        bonus > 0 || item_bonus > 0 || item_base > base ? 1 : 0;
      base = base > item_base ? base : item_base;
      update[attr] = base + bonus + item_bonus;
      setAttrs(update);
    });
  });
};

var update_mod = function (attr) {
  getAttrs([attr], function (v) {
    var attr_abr = attr.substring(0, 3);
    var finalattr =
      v[attr] && isNaN(v[attr]) === false
        ? Math.floor((parseInt(v[attr], 10) - 10) / 2)
        : 0;
    var update = {};
    update[attr + "_mod"] = finalattr;
    update["npc_" + attr_abr + "_negative"] =
      v[attr] && !isNaN(v[attr]) && parseInt(v[attr], 10) < 10 ? 1 : 0;
    setAttrs(update);
  });
};

var update_save = function (attr) {
  var save_attrs = [
    attr + "_mod",
    attr + "_save_prof",
    attr + "_save_mod",
    "pb",
    "globalsavemod",
    "pb_type",
  ];
  getSectionIDs("repeating_inventory", function (idarray) {
    _.each(idarray, function (currentID, i) {
      save_attrs.push("repeating_inventory_" + currentID + "_equipped");
      save_attrs.push("repeating_inventory_" + currentID + "_itemmodifiers");
    });

    getAttrs(save_attrs, function (v) {
      var attr_mod = v[attr + "_mod"] ? parseInt(v[attr + "_mod"], 10) : 0;
      var prof =
        v[attr + "_save_prof"] && v[attr + "_save_prof"] != 0 && !isNaN(v["pb"])
          ? parseInt(v["pb"], 10)
          : 0;
      var save_mod =
        v[attr + "_save_mod"] && !isNaN(parseInt(v[attr + "_save_mod"], 10))
          ? parseInt(v[attr + "_save_mod"], 10)
          : 0;
      var global =
        v["globalsavemod"] && !isNaN(v["globalsavemod"])
          ? parseInt(v["globalsavemod"], 10)
          : 0;
      var items = 0;
      _.each(idarray, function (currentID) {
        if (
          v["repeating_inventory_" + currentID + "_equipped"] &&
          v["repeating_inventory_" + currentID + "_equipped"] === "1" &&
          v["repeating_inventory_" + currentID + "_itemmodifiers"] &&
          (v["repeating_inventory_" + currentID + "_itemmodifiers"]
            .toLowerCase()
            .indexOf("saving throws") > -1 ||
            v["repeating_inventory_" + currentID + "_itemmodifiers"]
              .toLowerCase()
              .indexOf(attr + " save") > -1)
        ) {
          var mods = v["repeating_inventory_" + currentID + "_itemmodifiers"]
            .toLowerCase()
            .split(",");
          _.each(mods, function (mod) {
            if (mod.indexOf(attr + " save") > -1) {
              var substr = mod.slice(
                mod.lastIndexOf(attr + " save") + attr.length + " save".length
              );
              var bonus =
                substr && substr.length > 0 && !isNaN(parseInt(substr, 10))
                  ? parseInt(substr, 10)
                  : 0;
            } else if (mod.indexOf("saving throws") > -1) {
              var substr = mod.slice(
                mod.lastIndexOf("saving throws") + "saving throws".length
              );
              var bonus =
                substr && substr.length > 0 && !isNaN(parseInt(substr, 10))
                  ? parseInt(substr, 10)
                  : 0;
            }
            if (bonus && bonus != 0) {
              items = items + bonus;
            }
          });
        }
      });
      var total = attr_mod + prof + save_mod + global + items;
      if (
        v["pb_type"] &&
        v["pb_type"] === "die" &&
        v[attr + "_save_prof"] != 0 &&
        attr != "death"
      ) {
        total = total + "+" + v["pb"];
      }
      var update = {};
      update[attr + "_save_bonus"] = total;
      setAttrs(update, { silent: true }, () => {
        updateSavingRoll(attr);
      });
    });
  });
};

var update_all_saves = function () {
  update_save("strength");
  update_save("dexterity");
  update_save("constitution");
  update_save("intelligence");
  update_save("wisdom");
  update_save("charisma");
  update_save("honor");
  update_save("sanity");
  update_save("death");
};

var update_all_ability_checks = function () {
  update_initiative();
  update_skills([
    "athletics",
    "acrobatics",
    "sleight_of_hand",
    "stealth",
    "arcana",
    "history",
    "investigation",
    "nature",
    "religion",
    "animal_handling",
    "insight",
    "medicine",
    "perception",
    "survival",
    "deception",
    "intimidation",
    "performance",
    "persuasion",
  ]);
};

var update_skills = function (skills_array) {
  var skill_parent = {
    athletics: "strength",
    acrobatics: "dexterity",
    sleight_of_hand: "dexterity",
    stealth: "dexterity",
    arcana: "intelligence",
    history: "intelligence",
    investigation: "intelligence",
    nature: "intelligence",
    religion: "intelligence",
    animal_handling: "wisdom",
    insight: "wisdom",
    medicine: "wisdom",
    perception: "wisdom",
    survival: "wisdom",
    deception: "charisma",
    intimidation: "charisma",
    performance: "charisma",
    persuasion: "charisma",
  };
  var attrs_to_get = ["pb", "pb_type", "jack_of_all_trades", "jack"];
  var update = {};
  var callbacks = [];

  if (skills_array.indexOf("perception") > -1) {
    callbacks.push(function () {
      update_passive_perception();
    });
  }

  _.each(skills_array, function (s) {
    if (skill_parent[s] && attrs_to_get.indexOf(skill_parent[s]) === -1) {
      attrs_to_get.push(skill_parent[s] + "_mod");
    }
    attrs_to_get.push(s + "_prof");
    attrs_to_get.push(s + "_type");
    attrs_to_get.push(s + "_flat");
  });

  getSectionIDs("repeating_inventory", function (idarray) {
    _.each(idarray, function (currentID, i) {
      attrs_to_get.push("repeating_inventory_" + currentID + "_equipped");
      attrs_to_get.push("repeating_inventory_" + currentID + "_itemmodifiers");
    });

    getAttrs(attrs_to_get, function (v) {
      _.each(skills_array, function (s) {
        var attr_mod = v[skill_parent[s] + "_mod"]
          ? parseInt(v[skill_parent[s] + "_mod"], 10)
          : 0;
        var prof =
          v[s + "_prof"] != 0 && !isNaN(v["pb"]) ? parseInt(v["pb"], 10) : 0;
        var flat =
          v[s + "_flat"] && !isNaN(parseInt(v[s + "_flat"], 10))
            ? parseInt(v[s + "_flat"], 10)
            : 0;
        var type =
          v[s + "_type"] && !isNaN(parseInt(v[s + "_type"], 10))
            ? parseInt(v[s + "_type"], 10)
            : 1;
        var jack =
          v["jack_of_all_trades"] && v["jack_of_all_trades"] != 0 && v["jack"]
            ? v["jack"]
            : 0;
        var item_bonus = 0;

        _.each(idarray, function (currentID) {
          if (
            v["repeating_inventory_" + currentID + "_equipped"] &&
            v["repeating_inventory_" + currentID + "_equipped"] === "1" &&
            v["repeating_inventory_" + currentID + "_itemmodifiers"] &&
            (v["repeating_inventory_" + currentID + "_itemmodifiers"]
              .toLowerCase()
              .replace(/ /g, "_")
              .indexOf(s) > -1 ||
              v["repeating_inventory_" + currentID + "_itemmodifiers"]
                .toLowerCase()
                .indexOf("ability checks") > -1)
          ) {
            var mods = v["repeating_inventory_" + currentID + "_itemmodifiers"]
              .toLowerCase()
              .split(",");
            _.each(mods, function (mod) {
              if (
                mod.replace(/ /g, "_").indexOf(s) > -1 ||
                mod.indexOf("ability checks") > -1
              ) {
                if (mod.indexOf("-") > -1) {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                    ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                    : false;
                  item_bonus = new_mod ? item_bonus - new_mod : item_bonus;
                } else {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                    ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                    : false;
                  item_bonus = new_mod ? item_bonus + new_mod : item_bonus;
                }
              }
            });
          }
        });

        var total = attr_mod + flat + item_bonus;

        if (v["pb_type"] && v["pb_type"] === "die") {
          if (v[s + "_prof"] != 0) {
            type === 1 ? "" : "2";
            total = total + "+" + type + v["pb"];
          } else if (v[s + "_prof"] == 0 && jack != 0) {
            total = total + "+" + jack;
          }
        } else {
          if (v[s + "_prof"] != 0) {
            total = total + prof * type;
          } else if (v[s + "_prof"] == 0 && jack != 0) {
            total = total + parseInt(jack, 10);
          }
        }
        update[s + "_bonus"] = total;
      });

      setAttrs(update, { silent: true }, function () {
        callbacks.forEach(function (callback) {
          callback();
        });
        updateSkillRolls(skills_array);
      });
    });
  });
};

var update_tool = function (tool_id) {
  //D&D 5e Mancer: Land Vehicles proficiency does not drop with Marine background (UC748)
  //Added a test to check for an undefined tool_id so to prevent similar errors.
  //By Miguel Peres
  if (typeof tool_id == "undefined") return;

  if (tool_id.substring(0, 1) === "-" && tool_id.length === 20) {
    do_update_tool([tool_id]);
  } else if (tool_id === "all") {
    getSectionIDs("repeating_tool", function (idarray) {
      do_update_tool(idarray);
    });
  } else {
    getSectionIDs("repeating_tool", function (idarray) {
      var tool_attribs = [];
      _.each(idarray, function (id) {
        tool_attribs.push("repeating_tool_" + id + "_toolattr_base");
      });
      getAttrs(tool_attribs, function (v) {
        var attr_tool_ids = [];
        _.each(idarray, function (id) {
          if (
            v["repeating_tool_" + id + "_toolattr_base"] &&
            v["repeating_tool_" + id + "_toolattr_base"].indexOf(tool_id) > -1
          ) {
            attr_tool_ids.push(id);
          }
        });
        if (attr_tool_ids.length > 0) {
          do_update_tool(attr_tool_ids);
        }
      });
    });
  }
};

var do_update_tool = function (tool_array) {
  var tool_attribs = [
    "pb",
    "pb_type",
    "jack",
    "strength_mod",
    "dexterity_mod",
    "constitution_mod",
    "intelligence_mod",
    "wisdom_mod",
    "charisma_mod",
  ];
  var update = {};
  _.each(tool_array, function (tool_id) {
    tool_attribs.push("repeating_tool_" + tool_id + "_toolbonus_base");
    tool_attribs.push("repeating_tool_" + tool_id + "_tool_mod");
    tool_attribs.push("repeating_tool_" + tool_id + "_toolattr_base");
  });

  getAttrs(tool_attribs, function (v) {
    _.each(tool_array, function (tool_id) {
      var query = false;
      if (
        v["repeating_tool_" + tool_id + "_toolattr_base"] &&
        v["repeating_tool_" + tool_id + "_toolattr_base"].substring(0, 2) ===
          "?{"
      ) {
        update["repeating_tool_" + tool_id + "_toolattr"] = "QUERY";
        var mod =
          "?{Attribute?|Strength,@{strength_mod}|Dexterity,@{dexterity_mod}|Constitution,@{constitution_mod}|Intelligence,@{intelligence_mod}|Wisdom,@{wisdom_mod}|Charisma,@{charisma_mod}}";
        if (v["repeating_tool_" + tool_id + "_tool_mod"]) {
          mod = mod + "+" + v["repeating_tool_" + tool_id + "_tool_mod"];
        }
        query = true;
      } else {
        var attr = v["repeating_tool_" + tool_id + "_toolattr_base"]
          .substring(
            0,
            v["repeating_tool_" + tool_id + "_toolattr_base"].length - 5
          )
          .substr(2);
        var attr_mod = v[attr + "_mod"] ? parseInt(v[attr + "_mod"], 10) : 0;
        var tool_mod =
          v["repeating_tool_" + tool_id + "_tool_mod"] &&
          !isNaN(parseInt(v["repeating_tool_" + tool_id + "_tool_mod"], 10))
            ? parseInt(v["repeating_tool_" + tool_id + "_tool_mod"], 10)
            : 0;
        var mod = attr_mod + tool_mod;
        update["repeating_tool_" + tool_id + "_toolattr"] = attr.toUpperCase();
        if (
          v["repeating_tool_" + tool_id + "_tool_mod"] &&
          v["repeating_tool_" + tool_id + "_tool_mod"].indexOf("@{") > -1
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            update["repeating_tool_" + tool_id + "_toolbonus"] +
            "+" +
            v["repeating_tool_" + tool_id + "_tool_mod"];
        }
        if (!v["repeating_tool_" + tool_id + "_tool_mod"]) {
          update["repeating_tool_" + tool_id + "_tool_mod"] = 0;
        }
      }

      if (v["pb_type"] && v["pb_type"] === "die") {
        if (v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {
          update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + v.pb;
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + "+2" + v.pb;
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] ===
          "(floor(@{pb}/2))"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + "+" + v.jack;
        }
      } else if (
        v["repeating_tool_" + tool_id + "_toolattr_base"] &&
        v["repeating_tool_" + tool_id + "_toolattr_base"].substring(0, 2) ===
          "?{"
      ) {
        if (v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + "+" + parseInt(v.pb, 10);
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + "+" + parseInt(v.pb, 10) * 2;
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] ===
          "(floor(@{pb}/2))"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + "+" + parseInt(v.jack, 10);
        }
      } else {
        if (v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + parseInt(v.pb, 10);
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + parseInt(v.pb, 10) * 2;
        } else if (
          v["repeating_tool_" + tool_id + "_toolbonus_base"] ===
          "(floor(@{pb}/2))"
        ) {
          update["repeating_tool_" + tool_id + "_toolbonus"] =
            mod + parseInt(v.jack, 10);
        }
      }

      if (query) {
        update["repeating_tool_" + tool_id + "_toolbonus_display"] = "?";
      } else {
        update["repeating_tool_" + tool_id + "_toolbonus_display"] =
          update["repeating_tool_" + tool_id + "_toolbonus"];
      }
    });

    setAttrs(update, { silent: true }, () => {
      updateToolRolls(tool_array);
    });
  });
};

var get_repeating_data = function (callback) {
  var getallrepeating = function (getobj, thiscallback, attrlist) {
    attrlist = attrlist || [];
    var thisget = getobj.pop();
    getSectionIDs(thisget.name, function (ids) {
      _.each(ids, function (sectionId) {
        _.each(thisget.list, function (attr) {
          attrlist.push(
            "repeating_" + thisget.name + "_" + sectionId + "_" + attr
          );
        });
      });
      if (getobj.length > 0) {
        getallrepeating(getobj, thiscallback, attrlist);
      } else {
        getAttrs(attrlist, function (vals) {
          thiscallback(vals);
        });
      }
    });
  };
  var getList = [
    { name: "proficiencies", list: ["name"] },
    { name: "tool", list: ["toolname", "toolattr_base"] },
    { name: "traits", list: ["name", "source", "source_type"] },
    { name: "resource", list: ["resource_left_name", "resource_right_name"] },
    {
      name: "spell-cantrip",
      list: [
        "spellname",
        "spellattackid",
        "spellsource",
        "innate",
        "spellattackid",
      ],
    },
    { name: "savemod", list: ["global_save_name"] },
    { name: "tohitmod", list: ["global_attack_name"] },
    { name: "damagemod", list: ["global_damage_name"] },
    { name: "acmod", list: ["global_ac_name"] },
    { name: "skillmod", list: ["global_skill_name"] },
    { name: "attack", list: ["atkname", "spellid"] },
    { name: "hpmod", list: ["levels", "source", "mod"] },
  ];
  for (var x = 1; x <= 9; x++) {
    getList.push({
      name: "spell-" + x,
      list: [
        "spellname",
        "spellattackid",
        "spellsource",
        "innate",
        "spellattackid",
      ],
    });
  }
  var repeating = { prof_names: [], traits: [] };
  _.each(getList, function (section) {
    if (!["proficiencies", "traits"].includes(section.name)) {
      repeating[section.name] = {};
    }
  });
  getallrepeating(getList, function (vals) {
    var traitstemp = {};
    _.each(vals, function (value, name) {
      if (name.split("_")[1] == "proficiencies") {
        repeating.prof_names.push(value.toLowerCase());
      } else if (name.split("_")[1] == "tool") {
        repeating.tool[name.split("_")[2]] =
          repeating.tool[name.split("_")[2]] || {};
        let attr = _.last(name.split("_"));
        repeating.tool[name.split("_")[2]][attr] = value.toLowerCase();
        if (attr == "toolname") repeating.prof_names.push(value.toLowerCase());
      } else if (name.split("_")[1] == "traits") {
        traitstemp[name.split("_")[2]] = traitstemp[name.split("_")[2]]
          ? traitstemp[name.split("_")[2]]
          : {};
        traitstemp[name.split("_")[2]][_.last(name.split("_"))] = value;
      } else if (name.split("_")[1] == "resource") {
        repeating.resource[name.split("_")[2]] =
          repeating.resource[name.split("_")[2]] || {};
        repeating.resource[name.split("_")[2]][name.split("_")[4]] = value;
      } else if (name.split("_")[1] == "hpmod") {
        repeating.hpmod[name.split("_")[2]] =
          repeating.hpmod[name.split("_")[2]] || {};
        repeating.hpmod[name.split("_")[2]][name.split("_")[3]] = value;
      } else if (name.split("_")[1].split("-")[0] == "spell") {
        repeating[name.split("_")[1]][name.split("_")[2]] =
          repeating[name.split("_")[1]][name.split("_")[2]] || {};
        repeating[name.split("_")[1]][name.split("_")[2]][name.split("_")[3]] =
          value;
      } else if (name.split("_")[1] == "attack") {
        repeating[name.split("_")[1]][name.split("_")[2]] =
          repeating[name.split("_")[1]][name.split("_")[2]] || {};
        repeating[name.split("_")[1]][name.split("_")[2]][name.split("_")[3]] =
          value;
      } else {
        repeating[name.split("_")[1]][name.split("_")[2]] = value;
      }
    });
    _.each(traitstemp, function (v, k) {
      var trait = _.clone(v);
      trait.id = k;
      repeating.traits.push(trait);
    });
    callback(repeating);
  });
};

var check_itemmodifiers = function (modifiers, previousValue) {
  var mods = modifiers.toLowerCase().split(",");
  if (previousValue) {
    prevmods = previousValue.toLowerCase().split(",");
    mods = _.union(mods, prevmods);
  }
  _.each(mods, function (mod) {
    if (
      mod.indexOf("ac:") > -1 ||
      mod.indexOf("ac +") > -1 ||
      mod.indexOf("ac -") > -1
    ) {
      update_ac();
    }
    if (mod.indexOf("spell") > -1) {
      update_spell_info();
    }
    if (mod.indexOf("saving throws") > -1) {
      update_all_saves();
    }
    if (mod.indexOf("strength save") > -1) {
      update_save("strength");
    } else if (mod.indexOf("strength") > -1) {
      update_attr("strength");
    }
    if (mod.indexOf("dexterity save") > -1) {
      update_save("dexterity");
    } else if (mod.indexOf("dexterity") > -1) {
      update_attr("dexterity");
    }
    if (mod.indexOf("constitution save") > -1) {
      update_save("constitution");
    } else if (mod.indexOf("constitution") > -1) {
      update_attr("constitution");
    }
    if (mod.indexOf("intelligence save") > -1) {
      update_save("intelligence");
    } else if (mod.indexOf("intelligence") > -1) {
      update_attr("intelligence");
    }
    if (mod.indexOf("wisdom save") > -1) {
      update_save("wisdom");
    } else if (mod.indexOf("wisdom") > -1) {
      update_attr("wisdom");
    }
    if (mod.indexOf("charisma save") > -1) {
      update_save("charisma");
    } else if (mod.indexOf("charisma") > -1) {
      update_attr("charisma");
    }
    if (mod.indexOf("honor save") > -1) {
      update_save("honor");
    } else if (mod.indexOf("honor") > -1) {
      update_attr("honor");
    }
    if (mod.indexOf("sanity save") > -1) {
      update_save("sanity");
    } else if (mod.indexOf("sanity") > -1) {
      update_attr("sanity");
    }
    if (mod.indexOf("ability checks") > -1) {
      update_all_ability_checks();
    }
    if (mod.indexOf("acrobatics") > -1) {
      update_skills(["acrobatics"]);
    }
    if (mod.indexOf("animal handling") > -1) {
      update_skills(["animal_handling"]);
    }
    if (mod.indexOf("arcana") > -1) {
      update_skills(["arcana"]);
    }
    if (mod.indexOf("athletics") > -1) {
      update_skills(["athletics"]);
    }
    if (mod.indexOf("deception") > -1) {
      update_skills(["deception"]);
    }
    if (mod.indexOf("history") > -1) {
      update_skills(["history"]);
    }
    if (mod.indexOf("insight") > -1) {
      update_skills(["insight"]);
    }
    if (mod.indexOf("intimidation") > -1) {
      update_skills(["intimidation"]);
    }
    if (mod.indexOf("investigation") > -1) {
      update_skills(["investigation"]);
    }
    if (mod.indexOf("medicine") > -1) {
      update_skills(["medicine"]);
    }
    if (mod.indexOf("nature") > -1) {
      update_skills(["nature"]);
    }
    if (mod.indexOf("perception") > -1) {
      update_skills(["perception"]);
    }
    if (mod.indexOf("performance") > -1) {
      update_skills(["performance"]);
    }
    if (mod.indexOf("persuasion") > -1) {
      update_skills(["persuasion"]);
    }
    if (mod.indexOf("religion") > -1) {
      update_skills(["religion"]);
    }
    if (mod.indexOf("sleight of hand") > -1) {
      update_skills(["sleight_of_hand"]);
    }
    if (mod.indexOf("stealth") > -1) {
      update_skills(["stealth"]);
    }
    if (mod.indexOf("survival") > -1) {
      update_skills(["survival"]);
    }
  });
};

var create_attack_from_item = function (itemid, options) {
  var update = {};
  var newrowid = generateRowID();
  update["repeating_inventory_" + itemid + "_itemattackid"] = newrowid;
  if (options && options.versatile) {
    var newrowid2 = generateRowID();
    update["repeating_inventory_" + itemid + "_itemattackid"] +=
      "," + newrowid2;
    setAttrs(update, {}, function () {
      update_attack_from_item(itemid, newrowid, {
        newattack: true,
        versatile: "primary",
      });
      update_attack_from_item(itemid, newrowid2, {
        newattack: true,
        versatile: "secondary",
      });
    });
  } else {
    setAttrs(
      update,
      {},
      update_attack_from_item(itemid, newrowid, { newattack: true })
    );
  }
};

var update_attack_from_item = function (itemid, attackid, options) {
  getAttrs(
    [
      "repeating_inventory_" + itemid + "_itemname",
      "repeating_inventory_" + itemid + "_itemproperties",
      "repeating_inventory_" + itemid + "_itemmodifiers",
      "strength",
      "dexterity",
      "class",
      "multiclass1",
      "multiclass2",
      "multiclass3",
    ],
    function (v) {
      var update = {};
      var itemtype;
      var damage;
      var damagetype;
      var damage2;
      var damagetype2;
      var attackmod;
      var damagemod;
      var range;
      var atkcritrange;
      var alt = {};

      if (options && options.newattack) {
        update["repeating_attack_" + attackid + "_options-flag"] = "0";
        update["repeating_attack_" + attackid + "_itemid"] = itemid;
      }

      const isMonk = () => {
        let monk = false;
        ["class", "multiclass1", "multiclass2", "multiclass3"].forEach(
          (entry) => {
            if (v[entry] && v[entry] === "Monk") monk = true;
          }
        );
        return monk;
      };

      const isMonkWeapon = (weapon) => {
        const monkWeapons = [
          "club",
          "dagger",
          "dart",
          "dorata",
          "greatclub",
          "handaxe",
          "javelin",
          "light crossbow",
          "light hammer",
          "mace",
          "quarterstaff",
          "shortbow",
          "sickle",
          "sling",
          "spear",
          "shortsword",
        ];
        return monkWeapons.indexOf(weapon.toLowerCase().trim()) > -1;
      };

      if (
        v["repeating_inventory_" + itemid + "_itemmodifiers"] &&
        v["repeating_inventory_" + itemid + "_itemmodifiers"] != ""
      ) {
        var mods =
          v["repeating_inventory_" + itemid + "_itemmodifiers"].split(",");
        _.each(mods, function (mod) {
          if (mod.indexOf("Item Type:") > -1) {
            itemtype = mod.split(":")[1].trim();
          } else if (mod.indexOf("Alternate Secondary Damage Type:") > -1) {
            alt.damagetype2 = mod.split(":")[1].trim();
          } else if (mod.indexOf("Alternate Secondary Damage:") > -1) {
            alt.damage2 = mod.split(":")[1].trim();
          } else if (mod.indexOf("Alternate Damage Type:") > -1) {
            alt.damagetype = mod.split(":")[1].trim();
          } else if (mod.indexOf("Alternate Damage:") > -1) {
            alt.damage = mod.split(":")[1].trim();
          } else if (mod.indexOf("Secondary Damage Type:") > -1) {
            damagetype2 = mod.split(":")[1].trim();
          } else if (mod.indexOf("Secondary Damage:") > -1) {
            damage2 = mod.split(":")[1].trim();
          } else if (mod.indexOf("Damage Type:") > -1) {
            damagetype = mod.split(":")[1].trim();
          } else if (mod.indexOf("Damage:") > -1) {
            damage = mod.split(":")[1].trim();
          } else if (mod.indexOf("Critical Range:") > -1) {
            atkcritrange = mod.split(":")[1].trim();
          } else if (mod.indexOf("Range:") > -1) {
            range = mod.split(":")[1].trim();
          } else if (mod.indexOf(" Attacks ") > -1) {
            attackmod = mod.split(" Attacks ")[1].trim();
          } else if (mod.indexOf(" Damage ") > -1) {
            damagemod = mod.split(" Damage ")[1].trim();
          }
        });
      }

      if (
        v["repeating_inventory_" + itemid + "_itemname"] &&
        v["repeating_inventory_" + itemid + "_itemname"] != ""
      ) {
        update["repeating_attack_" + attackid + "_atkname"] =
          v["repeating_inventory_" + itemid + "_itemname"];
        if (options && options.versatile === "primary") {
          update["repeating_attack_" + attackid + "_atkname"] +=
            " (One-Handed)";
        } else if (options && options.versatile === "secondary") {
          update["repeating_attack_" + attackid + "_atkname"] +=
            " (Two-Handed)";
        }
      }
      if (options && options.versatile === "secondary") {
        if (alt.damage) {
          update["repeating_attack_" + attackid + "_dmgbase"] = alt.damage;
        }
        if (alt.damagetype) {
          update["repeating_attack_" + attackid + "_dmgtype"] = alt.damagetype;
        }
        if (alt.damage2) {
          update["repeating_attack_" + attackid + "_dmg2base"] = alt.damage2;
          update["repeating_attack_" + attackid + "_dmg2attr"] = 0;
          update["repeating_attack_" + attackid + "_dmg2flag"] =
            "{{damage=1}} {{dmg2flag=1}}";
        }
        if (alt.damagetype2) {
          update["repeating_attack_" + attackid + "_dmg2type"] =
            alt.damagetype2;
        }
        update["repeating_attack_" + attackid + "_versatile_alt"] = "1";
      } else {
        if (damage) {
          update["repeating_attack_" + attackid + "_dmgbase"] = damage;
        }
        if (damagetype) {
          update["repeating_attack_" + attackid + "_dmgtype"] = damagetype;
        }
        if (damage2) {
          update["repeating_attack_" + attackid + "_dmg2base"] = damage2;
          update["repeating_attack_" + attackid + "_dmg2attr"] = 0;
          update["repeating_attack_" + attackid + "_dmg2flag"] =
            "{{damage=1}} {{dmg2flag=1}}";
        }
        if (damagetype2) {
          update["repeating_attack_" + attackid + "_dmg2type"] = damagetype2;
        }
      }
      if (atkcritrange) {
        update["repeating_attack_" + attackid + "_atkcritrange"] = atkcritrange;
      }
      if (range) {
        update["repeating_attack_" + attackid + "_atkrange"] = range;
      }
      const monkWeapon =
        isMonk() &&
        isMonkWeapon(v["repeating_inventory_" + itemid + "_itemname"]);
      var finesse =
        v["repeating_inventory_" + itemid + "_itemproperties"] &&
        /finesse/i.test(v["repeating_inventory_" + itemid + "_itemproperties"]);
      if (
        (itemtype && itemtype.indexOf("Ranged") > -1) ||
        ((finesse || monkWeapon) && +v.dexterity > +v.strength)
      ) {
        update["repeating_attack_" + attackid + "_atkattr_base"] =
          "@{dexterity_mod}";
        update["repeating_attack_" + attackid + "_dmgattr"] =
          "@{dexterity_mod}";
      } else {
        update["repeating_attack_" + attackid + "_atkattr_base"] =
          "@{strength_mod}";
        update["repeating_attack_" + attackid + "_dmgattr"] = "@{strength_mod}";
      }
      if (attackmod && damagemod && attackmod == damagemod) {
        update["repeating_attack_" + attackid + "_atkmagic"] = parseInt(
          attackmod,
          10
        );
        update["repeating_attack_" + attackid + "_atkmod"] = "";
        update["repeating_attack_" + attackid + "_dmgmod"] = "";
      } else {
        if (attackmod) {
          update["repeating_attack_" + attackid + "_atkmod"] = parseInt(
            attackmod,
            10
          );
        }
        if (damagemod) {
          update["repeating_attack_" + attackid + "_dmgmod"] = parseInt(
            damagemod,
            10
          );
        }
        update["repeating_attack_" + attackid + "_atkmagic"] = "";
      }
      var callback = function () {
        update_attacks(attackid, "item");
      };
      setAttrs(update, { silent: true }, callback);
    }
  );
};

const create_resource_from_item = (itemid) => {
  const newrowid = generateRowID();
  let update = {};

  getAttrs(["other_resource_name"], (v) => {
    //Use other_resource if it is empty
    if (!v.other_resource_name || v.other_resource_name == "") {
      update[`repeating_inventory_${itemid}_itemresourceid`] = "other_resource";
      setAttrs(
        update,
        {},
        update_resource_from_item(itemid, "other_resource", true)
      );
      //If other_resource is populated look through the repeating sections for an empty spot
    } else {
      getSectionIDs(`repeating_resource`, (idarray) => {
        if (idarray.length == 0) {
          update[
            `repeating_inventory_${itemid}_itemresourceid`
          ] = `${newrowid}_resource_left`;
          setAttrs(
            update,
            {},
            update_resource_from_item(itemid, `${newrowid}_resource_left`, true)
          );
        } else {
          let array = [];
          _.each(idarray, (currentID, i) => {
            ["left", "right"].forEach((side) => {
              array.push(`repeating_resource_${currentID}_resource_${side}`);
              array.push(
                `repeating_resource_${currentID}_resource_${side}_name`
              );
              array.push(
                `repeating_resource_${currentID}_resource_${side}_max`
              );
            });
          });
          getAttrs(array, (y) => {
            let existing = false;
            _.each(idarray, (currentID, i) => {
              ["left", "right"].forEach((side) => {
                const Name =
                  y[`repeating_resource_${currentID}_resource_${side}_name`] ||
                  false;
                const Value =
                  y[`repeating_resource_${currentID}_resource_${side}`] ||
                  false;
                const Max =
                  y[`repeating_resource_${currentID}_resource_${side}_max`] ||
                  false;

                //If Name, Value, & Max are empty and existing === false then populate a resource there
                if (!Name && !Value && !Max && existing === false) {
                  update[
                    `repeating_inventory_${itemid}_itemresourceid`
                  ] = `${currentID}_resource_${side}`;
                  setAttrs(
                    update,
                    {},
                    update_resource_from_item(
                      itemid,
                      `${currentID}_resource_${side}`,
                      true
                    )
                  );
                  existing = true;
                }
              });
            });
            //If nothing is empty then generatae a new row
            if (!existing) {
              update[
                `repeating_inventory_${itemid}_itemresourceid`
              ] = `${newrowid}_resource_left`;
              setAttrs(
                update,
                {},
                update_resource_from_item(
                  itemid,
                  `${newrowid}_resource_left`,
                  true
                )
              );
            }
          });
        }
      });
    }
  });
};

var update_resource_from_item = function (itemid, resourceid, newresource) {
  getAttrs(
    [
      "repeating_inventory_" + itemid + "_itemname",
      "repeating_inventory_" + itemid + "_itemcount",
    ],
    function (v) {
      var update = {};
      var id;

      if (resourceid && resourceid == "other_resource") {
        id = resourceid;
      } else {
        id = "repeating_resource_" + resourceid;
      }

      if (newresource) {
        update[id + "_itemid"] = itemid;
      }

      if (!v["repeating_inventory_" + itemid + "_itemname"]) {
        update["repeating_inventory_" + itemid + "_useasresource"] = 0;
        update["repeating_inventory_" + itemid + "_itemresourceid"] = "";
        remove_resource(resourceid);
      }
      if (
        v["repeating_inventory_" + itemid + "_itemname"] &&
        v["repeating_inventory_" + itemid + "_itemname"] != ""
      ) {
        update[id + "_name"] = v["repeating_inventory_" + itemid + "_itemname"];
      }
      if (
        v["repeating_inventory_" + itemid + "_itemcount"] &&
        v["repeating_inventory_" + itemid + "_itemcount"] != ""
      ) {
        update[id] = v["repeating_inventory_" + itemid + "_itemcount"];
      }

      setAttrs(update, { silent: true });
    }
  );
};

const create_attack_from_spell = function (
  lvl,
  spellid,
  character_id,
  existing_id
) {
  let update = {};
  const newrowid = existing_id ? existing_id : generateRowID();
  update[`repeating_spell-${lvl}_${spellid}_spellattackid`] = newrowid;
  update[
    `repeating_spell-${lvl}_${spellid}_rollcontent`
  ] = `%{${character_id}|repeating_attack_${newrowid}_attack}`;
  setAttrs(
    update,
    {},
    update_attack_from_spell(lvl, spellid, newrowid, true, character_id)
  );
};

const update_attack_from_spell = (
  lvl,
  spellid,
  attackid,
  newattack,
  character_id
) => {
  const repeating_spell = `repeating_spell-${lvl}_${spellid}`;
  const repeating_attack = `repeating_attack_${attackid}`;
  getAttrs(
    [
      `${repeating_spell}_spellname`,
      `${repeating_spell}_spellrange`,
      `${repeating_spell}_spelltarget`,
      `${repeating_spell}_spellattack`,
      `${repeating_spell}_spelldamage`,
      `${repeating_spell}_spelldamage2`,
      `${repeating_spell}_spelldamagetype`,
      `${repeating_spell}_spelldamagetype2`,
      `${repeating_spell}_spellhealing`,
      `${repeating_spell}_spelldmgmod`,
      `${repeating_spell}_spellsave`,
      `${repeating_spell}_spellsavesuccess`,
      `${repeating_spell}_spellhldie`,
      `${repeating_spell}_spellhldietype`,
      `${repeating_spell}_spellhlbonus`,
      `${repeating_spell}_spelllevel`,
      `${repeating_spell}_includedesc`,
      `${repeating_spell}_spelldescription`,
      `${repeating_spell}_spellathigherlevels`,
      `${repeating_spell}_spell_damage_progression`,
      `${repeating_spell}_innate`,
      `${repeating_spell}_spell_ability`,
      "spellcasting_ability",
    ],
    (v) => {
      let update = {};
      let description = "";
      const spellAbility =
        v[`${repeating_spell}_spell_ability`] != "spell"
          ? v[`${repeating_spell}_spell_ability`].slice(0, -1)
          : "spell";
      update[`${repeating_attack}_atkattr_base`] = spellAbility;

      if (newattack) {
        update[`${repeating_attack}_options-flag`] = "0";
        update[`${repeating_attack}_spellid`] = spellid;
        update[`${repeating_attack}_spelllevel`] = lvl;
      }

      if (v[`${repeating_spell}_spell_ability`] == "spell") {
        update[`${repeating_attack}_savedc`] = "(@{spell_save_dc})";
      } else if (v[`${repeating_spell}_spell_ability`]) {
        update[
          `${repeating_attack}_savedc`
        ] = `(${spellAbility}+8+@{spell_dc_mod}+@{pb})`;
      }

      if (
        v[`${repeating_spell}_spellname`] &&
        v[`${repeating_spell}_spellname`] != ""
      ) {
        update[`${repeating_attack}_atkname`] =
          v[`${repeating_spell}_spellname`];
      }

      update[`${repeating_attack}_atkflag`] =
        !v[`${repeating_spell}_spellattack`] ||
        v[`${repeating_spell}_spellattack`] === "None"
          ? "0"
          : "{{attack=1}}";

      if (
        v[`${repeating_spell}_spellattack`] ||
        !v[`${repeating_spell}_spellattack`] === "None"
      ) {
        description =
          description + v[`${repeating_spell}_spellattack`] + " Spell Attack. ";
      }

      if (
        v[`${repeating_spell}_spelldamage`] &&
        v[`${repeating_spell}_spelldamage`] != ""
      ) {
        update[`${repeating_attack}_dmgbase`] =
          v[`${repeating_spell}_spell_damage_progression`] &&
          v[`${repeating_spell}_spell_damage_progression`] === "Cantrip Dice"
            ? "[[round((@{level} + 1) / 6 + 0.5)]]" +
              v[`${repeating_spell}_spelldamage`].substring(1)
            : v[`${repeating_spell}_spelldamage`];
      }

      update[`${repeating_attack}_dmgflag`] =
        v[`${repeating_spell}_spelldamage`] &&
        v[`${repeating_spell}_spelldamage`] != ""
          ? "{{damage=1}} {{dmg1flag=1}}"
          : "0";
      update[`${repeating_attack}_dmgattr`] =
        v[`${repeating_spell}_spelldmgmod`] &&
        v[`${repeating_spell}_spelldmgmod`] === "Yes"
          ? spellAbility
          : "0";
      update[`${repeating_attack}_dmgtype`] = v[
        `${repeating_spell}_spelldamagetype`
      ]
        ? v[`${repeating_spell}_spelldamagetype`]
        : "";
      update[`${repeating_attack}_dmg2base`] = v[
        `${repeating_spell}_spelldamage2`
      ]
        ? v[`${repeating_spell}_spelldamage2`]
        : "";
      update[`${repeating_attack}_dmg2attr`] = "0";
      update[`${repeating_attack}_dmg2flag`] = v[
        `${repeating_spell}_spelldamage2`
      ]
        ? "{{damage=1}} {{dmg2flag=1}}"
        : 0;
      update[`${repeating_attack}_dmg2type`] = v[
        `${repeating_spell}_spelldamagetype2`
      ]
        ? v[`${repeating_spell}_spelldamagetype2`]
        : "";
      update[`${repeating_attack}_atkrange`] = v[
        `${repeating_spell}_spellrange`
      ]
        ? v[`${repeating_spell}_spellrange`]
        : "";
      update[`${repeating_attack}_saveflag`] = v[`${repeating_spell}_spellsave`]
        ? "{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}"
        : "0";
      update[`${repeating_attack}_saveeffect`] = v[
        `${repeating_spell}_spellsavesuccess`
      ]
        ? v[`${repeating_spell}_spellsavesuccess`]
        : "";

      if (v[`${repeating_spell}_spellsave`]) {
        update[`${repeating_attack}_saveattr`] =
          v[`${repeating_spell}_spellsave`];
      }

      if (
        v[`${repeating_spell}_spellhldie`] &&
        v[`${repeating_spell}_spellhldie`] != "" &&
        v[`${repeating_spell}_spellhldietype`] &&
        v[`${repeating_spell}_spellhldietype`] != ""
      ) {
        let bonus = "";
        const spelllevel = v[`${repeating_spell}_spelllevel`];
        let query = "?{Cast at what level?";
        for (i = 0; i < 10 - spelllevel; i++) {
          query =
            query +
            "|Level " +
            (parseInt(i, 10) + parseInt(spelllevel, 10)) +
            "," +
            i;
        }
        query = query + "}";
        if (
          v[`${repeating_spell}_spellhlbonus`] &&
          v[`${repeating_spell}_spellhlbonus`] != ""
        ) {
          bonus =
            "+(" + v[`${repeating_spell}_spellhlbonus`] + "*" + query + ")";
        }
        update[`${repeating_attack}_hldmg`] = `{{hldmg=[[(${
          v[`${repeating_spell}_spellhldie`]
        }*${query})${v[`${repeating_spell}_spellhldietype`]}${bonus}]]}}`;
      } else {
        update[`${repeating_attack}_hldmg`] = "";
      }

      if (
        v[`${repeating_spell}_spellhealing`] &&
        v[`${repeating_spell}_spellhealing`] != ""
      ) {
        if (
          !v[`${repeating_spell}_spelldamage`] ||
          v[`${repeating_spell}_spelldamage`] === ""
        ) {
          update[`${repeating_attack}_dmgbase`] =
            v[`${repeating_spell}_spellhealing`];
          update[`${repeating_attack}_dmgflag`] = "{{damage=1}} {{dmg1flag=1}}";
          update[`${repeating_attack}_dmgtype`] = "Healing";
        } else if (
          !v[`${repeating_spell}_spelldamage2`] ||
          v[`${repeating_spell}_spelldamage2`] === ""
        ) {
          update[`${repeating_attack}_dmg2base`] =
            v[`${repeating_spell}_spellhealing`];
          update[`${repeating_attack}_dmg2flag`] =
            "{{damage=1}} {{dmg2flag=1}}";
          update[`${repeating_attack}_dmg2type`] = "Healing";
        }
      }

      update[`${repeating_attack}_spell_innate`] = v[
        `${repeating_spell}_innate`
      ]
        ? v[`${repeating_spell}_innate`]
        : "";

      if (v[`${repeating_spell}_spelltarget`]) {
        description = description + v[`${repeating_spell}_spelltarget`] + ". ";
      }
      if (
        v[`${repeating_spell}_includedesc`] &&
        v[`${repeating_spell}_includedesc`] === "on"
      ) {
        description = v[`${repeating_spell}_spelldescription`];
        if (
          v[`${repeating_spell}_spellathigherlevels`] &&
          v[`${repeating_spell}_spellathigherlevels`] != ""
        ) {
          description =
            description +
            "\n\nAt Higher Levels: " +
            v[`${repeating_spell}_spellathigherlevels`];
        }
      } else if (
        v[`${repeating_spell}_includedesc`] &&
        v[`${repeating_spell}_includedesc`] === "off"
      ) {
        description = "";
      }
      update[`${repeating_attack}_atk_desc`] = description;

      update[
        `${repeating_attack}_spelldesc_link`
      ] = `%{${character_id}|${repeating_spell}_output}`;

      var callback = () => {
        update_attacks(attackid, "spell");
      };
      setAttrs(update, { silent: true }, callback);
    }
  );
};

const update_attacks = (update_id, source) => {
  if (update_id.substring(0, 1) === "-" && update_id.length === 20) {
    do_update_attack([update_id], source);
  } else if (
    [
      "strength",
      "dexterity",
      "constitution",
      "intelligence",
      "wisdom",
      "charisma",
      "spells",
      "all",
    ].indexOf(update_id) > -1
  ) {
    getSectionIDs("repeating_attack", (idarray) => {
      if (update_id === "all") {
        do_update_attack(idarray);
      } else if (update_id === "spells") {
        let attack_attribs = [];
        _.each(idarray, (id) => {
          attack_attribs.push(
            `repeating_attack_${id}_spellid`,
            `repeating_attack_${id}_spelllevel`
          );
        });
        getAttrs([...attack_attribs, "character_id"], (v) => {
          const filteredIds = _.filter(idarray, (id) => {
            return (
              v[`repeating_attack_${id}_spellid`] &&
              v[`repeating_attack_${id}_spellid`] != ""
            );
          });
          let spell_attacks = {};
          _.each(filteredIds, (attack_id) => {
            spell_attacks[attack_id] = {
              spell_id: v[`repeating_attack_${attack_id}_spellid`],
              spell_lvl: v[`repeating_attack_${attack_id}_spelllevel`],
            };
          });
          _.each(spell_attacks, (data, attack_id) => {
            update_attack_from_spell(
              data.spell_lvl,
              data.spell_id,
              attack_id,
              false,
              v["character_id"]
            );
          });
        });
      } else {
        let attack_attribs = ["spellcasting_ability"];
        _.each(idarray, (id) => {
          attack_attribs.push(`repeating_attack_${id}_atkattr_base`);
          attack_attribs.push(`repeating_attack_${id}_dmgattr`);
          attack_attribs.push(`repeating_attack_${id}_dmg2attr`);
          attack_attribs.push(`repeating_attack_${id}_savedc`);
        });
        getAttrs(attack_attribs, (v) => {
          let attr_attack_ids = [];
          _.each(idarray, (id) => {
            if (
              (v[`repeating_attack_${id}_atkattr_base`] &&
                v[`repeating_attack_${id}_atkattr_base`].indexOf(update_id) >
                  -1) ||
              (v[`repeating_attack_${id}_dmgattr`] &&
                v[`repeating_attack_${id}_dmgattr`].indexOf(update_id) > -1) ||
              (v[`repeating_attack_${id}_dmg2attr`] &&
                v[`repeating_attack_${id}_dmg2attr`].indexOf(update_id) > -1) ||
              (v[`repeating_attack_${id}_savedc`] &&
                v[`repeating_attack_${id}_savedc`].indexOf(update_id) > -1) ||
              (v[`repeating_attack_${id}_savedc`] &&
                v[`repeating_attack_${id}_savedc`] === "(@{spell_save_dc})" &&
                v["spellcasting_ability"] &&
                v["spellcasting_ability"].indexOf(update_id) > -1)
            ) {
              attr_attack_ids.push(id);
            }
          });
          if (attr_attack_ids.length > 0) {
            do_update_attack(attr_attack_ids);
          }
        });
      }
    });
  }
};

const do_update_attack = (attack_array, source) => {
  let attack_attribs = [
    "level",
    "d20",
    "pb",
    "pb_type",
    "pbd_safe",
    "dtype",
    "globalmagicmod",
    "strength_mod",
    "dexterity_mod",
    "constitution_mod",
    "intelligence_mod",
    "wisdom_mod",
    "charisma_mod",
    "spellcasting_ability",
    "spell_save_dc",
    "spell_attack_mod",
    "spell_dc_mod",
    "global_damage_mod_roll",
    "global_damage_mod_crit",
    "default_critical_range",
  ];
  _.each(attack_array, (attackid) => {
    [
      "atkflag",
      "atkname",
      "atkattr_base",
      "atkmod",
      "atkprofflag",
      "atkmagic",
      "atkcritrange",
      "dmgflag",
      "dmgbase",
      "dmgattr",
      "dmgmod",
      "dmgtype",
      "dmg2flag",
      "dmg2base",
      "dmg2attr",
      "dmg2mod",
      "dmg2type",
      "dmgcustcrit",
      "dmg2custcrit",
      "saveflag",
      "savedc",
      "saveeffect",
      "saveflat",
      "hldmg",
      "spellid",
      "spelllevel",
      "atkrange",
      "itemid",
      "ammo",
      "spelldesc_link",
    ].forEach((attr) => {
      attack_attribs.push(`repeating_attack_${attackid}_${attr}`);
    });
  });

  getAttrs(attack_attribs, (v) => {
    _.each(attack_array, (attackid) => {
      const repeating_attack = `repeating_attack_${attackid}`;
      let callbacks = [];
      let update = {};
      let hbonus = "";
      let hdmg1 = "";
      let hdmg2 = "";
      let dmg = "";
      let dmg2 = "";
      let rollbase = "";
      let spellattack = false;
      let magicattackmod = 0;
      let magicsavemod = 0;
      let atkattr_abrev = "";
      let dmgattr_abrev = "";
      let dmg2attr_abrev = "";
      //PROFICIENCY BONUS select in Settings.
      const pbd_safe = v["pbd_safe"] || "";

      //HIGHER LVL CAST DMG found in Spells for spells like Fireball
      const hldmgcrit =
        v[`${repeating_attack}_hldmg`] && v[`${repeating_attack}_hldmg`] != ""
          ? v[`${repeating_attack}_hldmg`].slice(0, 7) +
            "crit" +
            v[`${repeating_attack}_hldmg`].slice(7)
          : "";

      if (
        v[`${repeating_attack}_spellid`] &&
        v[`${repeating_attack}_spellid`] != ""
      ) {
        spellattack = true;
        //GLOBAL MAGIC ATTACK MODIFIER in Settings
        magicattackmod = parseInt(v["spell_attack_mod"], 10) || 0;
        //SPELL SAVE DC MOD in Settings
        magicsavemod = parseInt(v["spell_dc_mod"], 10) || 0;
      }

      //ATTACK select inside settings for the repeating attack
      if (
        !v[`${repeating_attack}_atkattr_base`] ||
        v[`${repeating_attack}_atkattr_base`] === "0"
      ) {
        atkattr_base = 0;
      } else if (
        v[`${repeating_attack}_atkattr_base`] &&
        v[`${repeating_attack}_atkattr_base`] === "spell"
      ) {
        atkattr_base = parseInt(
          v[
            v["spellcasting_ability"].substring(
              2,
              v["spellcasting_ability"].length - 2
            )
          ],
          10
        );
        atkattr_abrev = v["spellcasting_ability"].substring(2, 5).toUpperCase();
      } else {
        atkattr_base = parseInt(
          v[
            v[`${repeating_attack}_atkattr_base`].substring(
              2,
              v[`${repeating_attack}_atkattr_base`].length - 1
            )
          ],
          10
        );
        atkattr_abrev = v[`${repeating_attack}_atkattr_base`]
          .substring(2, 5)
          .toUpperCase();
      }

      //DAMAGE 1 ability select inside settings for the repeating attack
      if (
        !v[`${repeating_attack}_dmgattr`] ||
        v[`${repeating_attack}_dmgattr`] === "0"
      ) {
        dmgattr = 0;
      } else if (
        v[`${repeating_attack}_dmgattr`] &&
        v[`${repeating_attack}_dmgattr`] === "spell"
      ) {
        dmgattr = parseInt(
          v[
            v["spellcasting_ability"].substring(
              2,
              v["spellcasting_ability"].length - 2
            )
          ],
          10
        );
        dmgattr_abrev = v["spellcasting_ability"].substring(2, 5).toUpperCase();
      } else {
        dmgattr = parseInt(
          v[
            v[`${repeating_attack}_dmgattr`].substring(
              2,
              v[`${repeating_attack}_dmgattr`].length - 1
            )
          ],
          10
        );
        dmgattr_abrev = v[`${repeating_attack}_dmgattr`]
          .substring(2, 5)
          .toUpperCase();
      }

      //DAMAGE 2 ability select inside settings for the repeating attack
      if (
        !v[`${repeating_attack}_dmg2attr`] ||
        v[`${repeating_attack}_dmg2attr`] === "0"
      ) {
        dmg2attr = 0;
      } else if (
        v[`${repeating_attack}_dmg2attr`] &&
        v[`${repeating_attack}_dmg2attr`] === "spell"
      ) {
        dmg2attr = parseInt(
          v[
            v["spellcasting_ability"].substring(
              2,
              v["spellcasting_ability"].length - 2
            )
          ],
          10
        );
        dmg2attr_abrev = v["spellcasting_ability"]
          .substring(2, 5)
          .toUpperCase();
      } else {
        dmg2attr = parseInt(
          v[
            v[`${repeating_attack}_dmg2attr`].substring(
              2,
              v[`${repeating_attack}_dmg2attr`].length - 1
            )
          ],
          10
        );
        dmg2attr_abrev = v[`${repeating_attack}_dmg2attr`]
          .substring(2, 5)
          .toUpperCase();
      }

      //DAMAGE first input inside settings for the repeating attack
      const dmgbase = v[`${repeating_attack}_dmgbase`] || 0;
      const dmg2base = v[`${repeating_attack}_dmg2base`] || 0;
      //DAMAGE 1 second input inside settings for the repeating attack
      const dmgmod = parseInt(v[`${repeating_attack}_dmgmod`], 10) || 0;
      //DAMAGE 2 second input inside settings for the repeating attack
      const dmg2mod = parseInt(v[`${repeating_attack}_dmg2mod`], 10) || 0;
      //DAMAGE 1 TYPE input inside settings for the repeating attack
      const dmgtype = v[`${repeating_attack}_dmgtype`] || "";
      //DAMAGE 2 TYPE input inside settings for the repeating attack
      const dmg2type = v[`${repeating_attack}_dmg2type`] || "";

      //PROFICIENT flag inside settings for the repeating attack && PROFICIENCY BONUS from Settings
      const atkprofflag = v[`${repeating_attack}_atkprofflag`] || 0;
      const pb = atkprofflag != 0 && v.pb ? v.pb : 0;

      //ATTACK input inside settings for the repeating attack
      const atkmod = parseInt(v[`${repeating_attack}_atkmod`], 10) || 0;
      //MAGIC BONUS input inside settings for the repeating attack
      const atkmag = parseInt(v[`${repeating_attack}_atkmagic`], 10) || 0;

      //used in _atkdmgtype display
      const dmgmag =
        isNaN(atkmag) === false &&
        atkmag != 0 &&
        ((v[`${repeating_attack}_dmgflag`] &&
          v[`${repeating_attack}_dmgflag`] != 0) ||
          (v[`${repeating_attack}_dmg2flag`] &&
            v[`${repeating_attack}_dmg2flag`] != 0))
          ? `+ ${atkmag} Magic Bonus`
          : "";

      //Spell description link
      const spelldesc_link = v[`${repeating_attack}_spelldesc_link`]
        ? `{{spelldesc_link=[Show Spell Description](~repeating_attack_spelldesc_link)}} `
        : "";

      //ATTACK checkbox inside settings for the repeating attack
      const atkflag = v[`${repeating_attack}_atkflag`] || 0;
      if (atkflag != 0) {
        bonus_mod = atkattr_base + atkmod + atkmag + magicattackmod;
        plus_minus = bonus_mod > -1 ? "+" : "";
        //pb_type is PROFICIENCY BONUS select in Settings
        if (v["pb_type"] && v["pb_type"] === "die") {
          bonus = `${bonus_mod}+${pb}`;
        } else {
          bonus_mod = bonus_mod + parseInt(pb, 10);
          bonus = plus_minus + bonus_mod;
        }
        //SAVING THROW checkbox inside settings for the repeating attack
      } else if (
        v[`${repeating_attack}_saveflag`] &&
        v[`${repeating_attack}_saveflag`] != 0
      ) {
        const saveDC = v[`${repeating_attack}_savedc`] || "";
        //SAVING THROW VS DC select "Spell" inside settings for the repeating attack
        if (!saveDC || saveDC === "(@{spell_save_dc})") {
          const tempdc = v["spell_save_dc"];
          bonus = "DC" + tempdc;
          //SAVING THROW VS DC select "FLAT" inside settings for the repeating attack
        } else if (saveDC === "(@{saveflat})") {
          const tempdc = parseInt(v[`${repeating_attack}_saveflat`]) || 0;
          bonus = "DC" + tempdc;
          //SAVING THROW VS DC select ability score inside settings for the repeating attack
        } else {
          const savedcattr = v[`${repeating_attack}_savedc`]
            .split("_mod")[0]
            .slice(3);
          const safe_pb =
            v["pb_type"] && v["pb_type"] === "die"
              ? parseInt(pb.substring(1), 10) / 2
              : parseInt(pb, 10);
          const safe_attr = v[`${savedcattr}_mod`]
            ? parseInt(v[`${savedcattr}_mod`], 10)
            : 0;
          const tempdc = 8 + safe_attr + safe_pb + magicsavemod;
          bonus = "DC" + tempdc;
        }
      } else {
        bonus = "-";
      }

      //DAMAGE checkbox inside settings for the repeating attack
      const dmgflag1 = v[`${repeating_attack}_dmgflag`] || 0;
      const dmgflag2 = v[`${repeating_attack}_dmg2flag`] || 0;
      if (dmgflag1 != 0) {
        if (
          spellattack === true &&
          dmgbase.indexOf("[[round((@{level} + 1) / 6 + 0.5)]]") > -1
        ) {
          // SPECIAL CANTRIP DAMAGE
          dmgdiestring = Math.round(
            (parseInt(v["level"], 10) + 1) / 6 + 0.5
          ).toString();
          dmg = dmgdiestring + dmgbase.substring(dmgbase.lastIndexOf("d"));
          //select & input to the right of damage
          if (dmgattr + dmgmod != 0) {
            dmg += `+${dmgattr + dmgmod}`;
          }
          dmg += ` ${dmgtype}`;
        } else {
          if (dmgbase === 0 && dmgattr + dmgmod === 0) {
            dmg = 0;
          }
          if (dmgbase != 0) {
            dmg = dmgbase;
          }
          if (dmgbase != 0 && dmgattr + dmgmod != 0) {
            dmg = dmgattr + dmgmod > 0 ? dmg + "+" : dmg;
          }
          if (dmgattr + dmgmod != 0) {
            dmg = dmg + (dmgattr + dmgmod);
          }
          dmg = dmg + " " + dmgtype;
        }
      }
      if (dmgflag2 != 0) {
        if (dmg2base === 0 && dmg2attr + dmg2mod === 0) {
          dmg2 = 0;
        }
        if (dmg2base != 0) {
          dmg2 = dmg2base;
        }
        if (dmg2base != 0 && dmg2attr + dmg2mod != 0) {
          dmg2 = dmg2attr + dmg2mod > 0 ? dmg2 + "+" : dmg2;
        }
        if (dmg2attr + dmg2mod != 0) {
          dmg2 = dmg2 + (dmg2attr + dmg2mod);
        }
        dmg2 = dmg2 + " " + dmg2type;
      }
      update[`${repeating_attack}_atkdmgtype`] =
        dmgflag1 != 0 && dmgflag2 != 0
          ? `${dmg} + ${dmg2}${dmgmag} `
          : `${dmg}${dmg2}${dmgmag} `;

      //Build ROLL TEMPLATE with below variables
      //ATTACK checkbox inside settings for the repeating attack
      if (atkflag != 0) {
        if (atkattr_base != 0) {
          hbonus += ` + ${atkattr_base}[${atkattr_abrev}]`;
        }
        if (atkmod != 0) {
          hbonus += ` + ${atkmod}[MOD]`;
        }
        if (pb != 0) {
          hbonus += ` + ${pb}${pbd_safe}[PROF]`;
        }
        if (atkmag != 0) {
          hbonus += ` + ${atkmag}[MAGIC]`;
        }
        if (magicattackmod != 0) {
          hbonus += ` + ${magicattackmod}[SPELLATK]`;
        }
      }
      //DAMAGE 1 checkbox inside settings for the repeating attack
      if (dmgflag1 != 0) {
        hdmg1 += dmgbase;
        if (dmgattr != 0) {
          hdmg1 += ` + ${dmgattr}[${dmgattr_abrev}]`;
        }
        if (dmgmod != 0) {
          hdmg1 += ` + ${dmgmod}[MOD]`;
        }
        if (atkmag != 0) {
          hdmg1 += ` + ${atkmag}[MAGIC]`;
        }
      } else {
        hdmg1 += "0";
      }
      //DAMAGE 2 checkbox inside settings for the repeating attack
      if (dmgflag2 != 0) {
        hdmg2 += dmg2base;
        if (dmg2attr != 0) {
          hdmg2 += ` + ${dmg2attr}[${dmg2attr_abrev}]`;
        }
        if (dmg2mod != 0) {
          hdmg2 += ` + ${dmg2mod}[MOD]`;
        }
      } else {
        hdmg2 += "0";
      }
      //CRIT input inside settings for the repeating attack
      let crit1 = v[`${repeating_attack}_dmgcustcrit`] || 0;
      let crit2 = v[`${repeating_attack}_dmg2custcrit`] || 0;
      crit1 = crit1 != 0 ? v[`${repeating_attack}_dmgcustcrit`] : dmgbase;
      crit2 = crit2 != 0 ? v[`${repeating_attack}_dmg2custcrit`] : dmg2base;
      r1 = atkflag != 0 ? "@{d20}" : "0d20";
      r2 = atkflag != 0 ? "@{rtype}" : "{{r2=[[0d20";
      //set in the GLOBAL DAMAGE MODIFIER section
      let globaldamage = `[[${v.global_damage_mod_roll || 0}]]`;
      let globaldamagecrit = `[[${v.global_damage_mod_crit || 0}]]`;

      //Assamble Roll Templates
      const criticalrange =
        v[`${repeating_attack}_atkcritrange`] &&
        v["default_critical_range"] &&
        parseInt(v["default_critical_range"]) <
          parseInt(v[`${repeating_attack}_atkcritrange`])
          ? "@{default_critical_range}"
          : "@{atkcritrange}";
      if (v.dtype === "full") {
        rollbase = `@{wtype}&{template:atkdmg} {{mod=@{atkbonus}}} {{rname=@{atkname}}} {{r1=[[${r1}cs>${criticalrange}${hbonus}]]}} ${r2}cs>${criticalrange}${hbonus}]]}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[${hdmg1}]]}} {{dmg1type=${dmgtype}}} @{dmg2flag} {{dmg2=[[${hdmg2}]]}} {{dmg2type=${dmg2type}}} {{crit1=[[${crit1}[CRIT]]]}} {{crit2=[[${crit2}[CRIT]]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} ${hldmgcrit} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globalattack=@{global_attack_mod}}} {{globaldamage=${globaldamage}}} {{globaldamagecrit=${globaldamagecrit}}} {{globaldamagetype=@{global_damage_mod_type}}} ammo=@{ammo} ${spelldesc_link}@{charname_output}`;
      } else if (atkflag != 0) {
        rollbase = `@{wtype}&{template:atk} {{mod=@{atkbonus}}} {{rname=[@{atkname}](~repeating_attack_attack_dmg)}} {{rnamec=[@{atkname}](~repeating_attack_attack_crit)}} {{r1=[[${r1}cs>${criticalrange}${hbonus}]]}} ${r2}cs>${criticalrange}${hbonus}]]}} {{range=@{atkrange}}} {{desc=@{atk_desc}}} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globalattack=@{global_attack_mod}}} ammo=@{ammo} ${spelldesc_link}@{charname_output}`;
      } else if (dmgflag1 != 0) {
        rollbase = `@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[${hdmg1}]]}} {{dmg1type=${dmgtype}}} @{dmg2flag} {{dmg2=[[${hdmg2}]]}} {{dmg2type=${dmg2type}}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=${globaldamage}}} {{globaldamagetype=@{global_damage_mod_type}}} ammo=@{ammo} ${spelldesc_link}@{charname_output}`;
      } else {
        rollbase = `@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{saveflag} {{desc=@{atk_desc}}} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} ammo=@{ammo} ${spelldesc_link}@{charname_output}`;
      }

      update[
        `${repeating_attack}_rollbase_dmg`
      ] = `@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[${hdmg1}]]}} {{dmg1type=${dmgtype}}} @{dmg2flag} {{dmg2=[[${hdmg2}]]}} {{dmg2type=${dmg2type}}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=${globaldamage}}} {{globaldamagetype=@{global_damage_mod_type}}} ${spelldesc_link}@{charname_output}`;
      update[
        `${repeating_attack}_rollbase_crit`
      ] = `@{wtype}&{template:dmg} {{crit=1}} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[${hdmg1}]]}} {{dmg1type=${dmgtype}}} @{dmg2flag} {{dmg2=[[${hdmg2}]]}} {{dmg2type=${dmg2type}}} {{crit1=[[${crit1}]]}} {{crit2=[[${crit2}]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} ${hldmgcrit} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=${globaldamage}}} {{globaldamagecrit=${globaldamagecrit}}} {{globaldamagetype=@{global_damage_mod_type}}} ${spelldesc_link}@{charname_output}`;
      update[`${repeating_attack}_atkbonus`] = bonus;
      update[`${repeating_attack}_rollbase`] = rollbase;

      if (
        v[`${repeating_attack}_spellid`] &&
        v[`${repeating_attack}_spellid`] != "" &&
        (!source || (source && source != "spell")) &&
        v[`${repeating_attack}_spellid`].length == 20
      ) {
        const spellid = v[`${repeating_attack}_spellid`];
        const lvl = v[`${repeating_attack}_spelllevel`];
        callbacks.push(() => {
          update_spell_from_attack(lvl, spellid, attackid);
        });
      }
      if (
        v[`${repeating_attack}_itemid`] &&
        v[`${repeating_attack}_itemid`] != "" &&
        (!source || (source && source != "item"))
      ) {
        const itemid = v[`${repeating_attack}_itemid`];
        callbacks.push(() => {
          update_item_from_attack(itemid, attackid);
        });
      }
      setAttrs(update, { silent: true }, () => {
        callbacks.forEach((callback) => {
          callback();
        });
      });
    });
  });
};

//Update spells in the attack section
const update_spell_from_attack = (lvl, spellid, attackid) => {
  const repeating_attack = `repeating_attack_${attackid}`;
  const repeating_spell = `repeating_spell-${lvl}_${spellid}`;
  let update = {};
  getAttrs(
    [
      `${repeating_attack}_atkname`,
      `${repeating_attack}_atkrange`,
      `${repeating_attack}_atkflag`,
      `${repeating_attack}_atkattr_base`,
      `${repeating_attack}_dmgbase`,
      `${repeating_attack}_dmgtype`,
      `${repeating_attack}_dmg2base`,
      `${repeating_attack}_dmg2type`,
      `${repeating_attack}_saveflag`,
      `${repeating_attack}_saveattr`,
      `${repeating_attack}_saveeffect`,
    ],
    (v) => {
      update[`${repeating_spell}_spellname`] = v[`${repeating_attack}_atkname`];
      update[`${repeating_spell}_spellrange`] =
        v[`${repeating_attack}_atkrange`] || "";
      update[`${repeating_spell}_spellsavesuccess`] =
        v[`${repeating_attack}_saveeffect`] || "";

      if (
        v[`${repeating_attack}_dmgtype`] &&
        v[`${repeating_attack}_dmgtype`].toLowerCase() == "healing"
      ) {
        if (
          v[`${repeating_attack}_dmgbase`] &&
          v[`${repeating_attack}_dmgbase`] != ""
        ) {
          update[`${repeating_spell}_spellhealing`] =
            v[`${repeating_attack}_dmgbase`];
        }
      } else {
        if (
          v[`${repeating_attack}_dmgbase`] &&
          v[`${repeating_attack}_dmgbase`] != "" &&
          v[`${repeating_attack}_dmgbase`].indexOf(
            "[[round((@{level} + 1) / 6 + 0.5)]]"
          ) === -1
        ) {
          update[`${repeating_spell}_spelldamage`] =
            v[`${repeating_attack}_dmgbase`];
        } else if (
          !v[`${repeating_attack}_dmgbase`] ||
          v[`${repeating_attack}_dmgbase`] === ""
        ) {
          update[`${repeating_spell}_spelldamage`] = "";
        }

        update[`${repeating_spell}_spelldamagetype`] =
          v[`${repeating_attack}_dmgtype`] || "";
      }
      if (
        v[`${repeating_attack}_dmg2type`] &&
        v[`${repeating_attack}_dmg2type`].toLowerCase() === "healing"
      ) {
        if (
          v[`${repeating_attack}_dmgbase`] &&
          v[`${repeating_attack}_dmgbase`] != ""
        ) {
          update[`${repeating_spell}_spellhealing`] =
            v[`${repeating_attack}_dmgbase`];
        }
      } else {
        update[`${repeating_spell}_spelldamage2`] =
          v[`${repeating_attack}_dmg2base`] || "";
        update[`${repeating_spell}_spelldamagetype2`] =
          v[`${repeating_attack}_dmg2type`] || "";
      }

      //SAVING THROW checkbox inside settings for the repeating attack
      update[`${repeating_spell}_spellsave`] =
        v[`${repeating_attack}_saveflag`] &&
        v[`${repeating_attack}_saveflag`] != "0"
          ? v[`${repeating_attack}_saveattr`]
          : "";
      setAttrs(update, { silent: true });
    }
  );
};

var update_item_from_attack = function (itemid, attackid) {
  getAttrs(
    [
      "repeating_attack_" + attackid + "_atkname",
      "repeating_attack_" + attackid + "_dmgbase",
      "repeating_attack_" + attackid + "_dmg2base",
      "repeating_attack_" + attackid + "_dmgtype",
      "repeating_attack_" + attackid + "_dmg2type",
      "repeating_attack_" + attackid + "_atkrange",
      "repeating_attack_" + attackid + "_atkmod",
      "repeating_attack_" + attackid + "_dmgmod",
      "repeating_inventory_" + itemid + "_itemmodifiers",
      "repeating_attack_" + attackid + "_versatile_alt",
      "repeating_inventory_" + itemid + "_itemproperties",
      "repeating_attack_" + attackid + "_atkmagic",
    ],
    function (v) {
      var update = {};
      var mods = v["repeating_inventory_" + itemid + "_itemmodifiers"];
      var damage = v["repeating_attack_" + attackid + "_dmgbase"]
        ? v["repeating_attack_" + attackid + "_dmgbase"]
        : 0;
      var damage2 = v["repeating_attack_" + attackid + "_dmg2base"]
        ? v["repeating_attack_" + attackid + "_dmg2base"]
        : 0;
      var damagetype = v["repeating_attack_" + attackid + "_dmgtype"]
        ? v["repeating_attack_" + attackid + "_dmgtype"]
        : 0;
      var damagetype2 = v["repeating_attack_" + attackid + "_dmg2type"]
        ? v["repeating_attack_" + attackid + "_dmg2type"]
        : 0;
      var atkcritrange = v["repeating_attack_" + attackid + "_atkcritrange"]
        ? v["repeating_attack_" + attackid + "_atkcritrange"]
        : 20;
      var range = v["repeating_attack_" + attackid + "_atkrange"]
        ? v["repeating_attack_" + attackid + "_atkrange"]
        : 0;
      var attackmod = v["repeating_attack_" + attackid + "_atkmod"]
        ? v["repeating_attack_" + attackid + "_atkmod"]
        : 0;
      var damagemod = v["repeating_attack_" + attackid + "_dmgmod"]
        ? v["repeating_attack_" + attackid + "_dmgmod"]
        : 0;
      var magicmod = v["repeating_attack_" + attackid + "_atkmagic"]
        ? v["repeating_attack_" + attackid + "_atkmagic"]
        : 0;
      var atktype = "";
      var altprefix =
        v["repeating_attack_" + attackid + "_versatile_alt"] === "1"
          ? "Alternate "
          : "";

      if (
        /Alternate Damage:/i.test(
          v["repeating_inventory_" + itemid + "_itemmodifiers"]
        )
      ) {
        update["repeating_inventory_" + itemid + "_itemname"] = v[
          "repeating_attack_" + attackid + "_atkname"
        ].replace(/\s*(?:\(One-Handed\)|\(Two-Handed\))/, "");
      } else {
        update["repeating_inventory_" + itemid + "_itemname"] =
          v["repeating_attack_" + attackid + "_atkname"];
      }

      var attack_type_regex =
        /(?:^|,)\s*Item Type: (Melee|Ranged) Weapon(?:,|$)/i;
      var attack_type_results = attack_type_regex.exec(
        v["repeating_inventory_" + itemid + "_itemmodifiers"]
      );
      atktype = attack_type_results ? attack_type_results[1] : "";
      if (mods) {
        mods = mods.split(",");
      } else {
        mods = [];
      }

      var damage_regex = new RegExp(
        "^\\s*" + altprefix + "Damage:\\s*(.+)$",
        "i"
      );
      var damage_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((damage_found = damage_regex.exec(mods[i]))) {
          if (damage !== 0) {
            mods[i] = mods[i].replace(damage_found[1], damage);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!damage_found && damage !== 0) {
        mods.push(altprefix + "Damage: " + damage);
      }

      var damage2_regex = new RegExp(
        "^\\s*" + altprefix + "Secondary Damage:\\s*(.+)$",
        "i"
      );
      var damage2_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((damage2_found = damage2_regex.exec(mods[i]))) {
          if (damage2 !== 0) {
            mods[i] = mods[i].replace(damage2_found[1], damage2);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!damage2_found && damage2 !== 0) {
        mods.push(altprefix + "Secondary Damage: " + damage2);
      }

      var dmgtype_regex = new RegExp(
        "^\\s*" + altprefix + "Damage Type:\\s*(.+)$",
        "i"
      );
      var dmgtype_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((dmgtype_found = dmgtype_regex.exec(mods[i]))) {
          if (damagetype !== 0) {
            mods[i] = mods[i].replace(dmgtype_found[1], damagetype);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!dmgtype_found && damagetype !== 0) {
        mods.push(altprefix + "Damage Type: " + damagetype);
      }

      var dmgtype2_regex = new RegExp(
        "^\\s*" + altprefix + "Secondary Damage Type:\\s*(.+)$",
        "i"
      );
      var dmgtype2_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((dmgtype2_found = dmgtype2_regex.exec(mods[i]))) {
          if (damagetype2 !== 0) {
            mods[i] = mods[i].replace(dmgtype_found[1], damagetype);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!dmgtype2_found && damagetype2 !== 0) {
        mods.push(altprefix + "Secondary Damage Type: " + damagetype2);
      }

      var atkcritrange_found = false;
      for (var i = 0; i < mods.length; i++) {
        if (
          (atkcritrange_found = /^\s*Critical Range:\s*(.+)$/i.exec(mods[i]))
        ) {
          if (atkcritrange !== 0) {
            mods[i] = mods[i].replace(atkcritrange_found[1], atkcritrange);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!range_found && range !== 0) {
        mods.push("Critical Range: " + atkcritrange);
      }

      var range_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((range_found = /^\s*Range:\s*(.+)$/i.exec(mods[i]))) {
          if (range !== 0) {
            mods[i] = mods[i].replace(range_found[1], range);
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!range_found && range !== 0) {
        mods.push("Range: " + range);
      }

      var attackmod_regex = new RegExp(
        "^\\s*(?:" +
          (atktype !== "" ? atktype + "|" : "") +
          "Weapon) Attacks \\+?(.+)$",
        "i"
      );
      var attackmod_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((attackmod_found = attackmod_regex.exec(mods[i]))) {
          if (magicmod !== 0 || attackmod !== 0) {
            mods[i] = mods[i].replace(
              attackmod_found[1],
              magicmod !== 0 ? magicmod : attackmod
            );
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!attackmod_found && (magicmod !== 0 || attackmod !== 0)) {
        var properties = v["repeating_inventory_" + itemid + "_itemproperties"];
        if (properties && /Thrown/i.test(properties)) {
          mods.push(
            "Weapon Attacks: " + (magicmod !== 0 ? magicmod : attackmod)
          );
        } else {
          mods.push(
            atktype + " Attacks: " + (magicmod !== 0 ? magicmod : attackmod)
          );
        }
      }

      var damagemod_regex = new RegExp(
        "^\\s*(?:" +
          (atktype !== "" ? atktype + "|" : "") +
          "Weapon) Damage \\+?(.+)$",
        "i"
      );
      var damagemod_found = false;
      for (var i = 0; i < mods.length; i++) {
        if ((damagemod_found = damagemod_regex.exec(mods[i]))) {
          if (magicmod !== 0 || damagemod !== 0) {
            mods[i] = mods[i].replace(
              damagemod_found[1],
              magicmod !== 0 ? magicmod : attackmod
            );
          } else {
            mods.splice(i, 1);
          }
          break;
        }
      }
      if (!damagemod_found && (magicmod !== 0 || damagemod !== 0)) {
        var properties = v["repeating_inventory_" + itemid + "_itemproperties"];
        if (properties && /Thrown/i.test(properties)) {
          mods.push(
            "Weapon Damage: " + (magicmod !== 0 ? magicmod : damagemod)
          );
        } else {
          mods.push(
            atktype + " Damage: " + (magicmod !== 0 ? magicmod : damagemod)
          );
        }
      }

      update["repeating_inventory_" + itemid + "_itemmodifiers"] =
        mods.join(",");

      setAttrs(update, { silent: true });
    }
  );
};

var remove_attack = function (attackid) {
  removeRepeatingRow("repeating_attack_" + attackid);
};

const createResource = (name, max, current) => {
  const updateResource = (name, max, current, side, id) => {
    const newrowid = id || generateRowID();
    let update = {};
    update[`repeating_resource_${newrowid}_resource_${side}_name`] = name;
    update[`repeating_resource_${newrowid}_resource_${side}_max`] = max;
    update[`repeating_resource_${newrowid}_resource_${side}`] = current;
    setAttrs(update);
  };

  getAttrs(["other_resource_name"], (v) => {
    //Use other_resource if it is empty or same name:
    if (
      !v.other_resource_name ||
      v.other_resource_name == "" ||
      v.other_resource_name == name
    ) {
      let update = {};
      update[`other_resource_name`] = name;
      update[`other_resource_max`] = max;
      update[`other_resource`] = current;
      setAttrs(update);
      //If other_resource is populated look through the repeating sections:
    } else {
      getSectionIDs(`repeating_resource`, (idarray) => {
        //No resources founds, create one:
        if (idarray.length == 0) {
          updateResource(name, max, current);
        } else {
          const namesAttributes = idarray
            .map((id) => {
              return `repeating_resource_${id}_resource_left_name`;
            })
            .concat(
              idarray.map((id) => {
                return `repeating_resource_${id}_resource_right_name`;
              })
            );
          getAttrs(namesAttributes, (v) => {
            let existingID = false;
            let side = "left";
            for (const [key, value] of Object.entries(v)) {
              if (value == name || value == "") {
                existingID = SheetUtils.getUID(key);
                if (key.includes("_right_")) side = "right";
                break;
              }
            }
            //Existing resource found, updated it:
            if (existingID) {
              updateResource(name, max, current, side, existingID);
              //No matching resource found, create one:
            } else {
              updateResource(name, max, current, side);
            }
          });
        }
      });
    }
  });
};

const deleteResource = (name) => {
  const updateResource = (name, max, current, side, id) => {
    const newrowid = id || generateRowID();
    let update = {};
    update[`repeating_resource_${newrowid}_resource_${side}_name`] = name;
    update[`repeating_resource_${newrowid}_resource_${side}_max`] = max;
    update[`repeating_resource_${newrowid}_resource_${side}`] = current;
    setAttrs(update);
  };
  getAttrs(["other_resource_name"], (v) => {
    if (v.other_resource_name && v.other_resource_name == name) {
      let update = {};
      update[`other_resource_name`] = "";
      update[`other_resource_max`] = "";
      update[`other_resource`] = "";
      setAttrs(update);
      //If other_resource is populated look through the repeating sections:
    } else {
      getSectionIDs(`repeating_resource`, (idarray) => {
        //No resources founds, create one:
        if (idarray.length > 0) {
          const namesAttributes = idarray
            .map((id) => {
              return `repeating_resource_${id}_resource_left_name`;
            })
            .concat(
              idarray.map((id) => {
                return `repeating_resource_${id}_resource_right_name`;
              })
            );
          getAttrs(namesAttributes, (v) => {
            let existingID = false;
            let side = "left";
            for (const [key, value] of Object.entries(v)) {
              if (value == name) existingID = SheetUtils.getUID(key);
              if (key.includes("_right_")) side = "right";
              break;
            }
            if (existingID) {
              if (
                side == "right" &&
                !v[`repeating_resource_${existingID}_resource_left_name`]
              ) {
                removeRepeatingRow(`repeating_resource_${existingID}`);
              } else if (
                side == "left" &&
                !v[`repeating_resource_${existingID}_resource_right_name`]
              ) {
                removeRepeatingRow(`repeating_resource_${existingID}`);
              } else {
                let update = {};
                update[
                  `repeating_resource_${existingID}_resource_${side}_name`
                ] = "";
                update[
                  `repeating_resource_${existingID}_resource_${side}_max`
                ] = "";
                update[`repeating_resource_${existingID}_resource_${side}`] =
                  "";
                update[
                  `repeating_resource_${existingID}_resource_${side}_itemid`
                ] = "";
                setAttrs(update);
              }
            }
          });
        }
      });
    }
  });
};

const remove_resource = (id) => {
  const attr = id === "other_resource" ? id : `repeating_resource_${id}_itemid`;
  let update = {};
  getAttrs([`${attr}`], (v) => {
    const itemid = v[`${attr}`];
    if (id == "other_resource") {
      update["other_resource"] = "";
      update["other_resource_name"] = "";
      update["other_resource_itemid"] = "";
      setAttrs(update, { silent: true });
    } else {
      const currentID = id.replace("repeating_resource_", "").substring(0, 20);
      const side = id.includes("left") ? `right` : `left`;
      //Get the inputs for the opposite side to see if they are empty.
      //If they are empty delete the entire row. Otherwise set the side that was the source of this event to empty strings
      getAttrs(
        [
          `repeating_resource_${currentID}_resource_${side}`,
          `repeating_resource_${currentID}_resource_${side}_name`,
          `repeating_resource_${currentID}_resource_${side}_max`,
        ],
        (v) => {
          const Name =
            v[`repeating_resource_${currentID}_resource_${side}_name`] || false;
          const Value =
            v[`repeating_resource_${currentID}_resource_${side}`] || false;
          const Max =
            v[`repeating_resource_${currentID}_resource_${side}_max`] || false;
          if (!Name && !Value && !Max) {
            if (currentID)
              removeRepeatingRow(`repeating_resource_${currentID}`);
          } else {
            update[`repeating_resource_${id}`] = "";
            update[`repeating_resource_${id}_name`] = "";
            update[`repeating_resource_${id}_max`] = "";
            update[`repeating_resource_${id}_itemid`] = "";
          }
          setAttrs(update, { silent: true });
        }
      );
    }
  });
};

const update_weight = function () {
  let update = {};
  let wtotal = 0;
  let weight_attrs = [
    "cp",
    "sp",
    "ep",
    "gp",
    "pp",
    "encumbrance_setting",
    "strength",
    "size",
    "carrying_capacity_mod",
    "powerful_build",
    "ingore_non_equipped_weight",
  ];
  getSectionIDs("repeating_inventory", (idarray) => {
    _.each(idarray, (currentID, i) => {
      weight_attrs.push(`repeating_inventory_${currentID}_itemweight`);
      weight_attrs.push(`repeating_inventory_${currentID}_itemcount`);
      weight_attrs.push(`repeating_inventory_${currentID}_equipped`);
    });
    getAttrs(weight_attrs, (v) => {
      let coinWeight = 0;
      ["cp", "sp", "ep", "gp", "pp"].forEach((type) => {
        coinWeight +=
          isNaN(parseInt(v[`${type}`], 10)) === false
            ? parseInt(v[`${type}`], 10)
            : 0;
      });
      wtotal = wtotal + coinWeight / 50;

      _.each(idarray, (currentID, i) => {
        if (
          v["ingore_non_equipped_weight"] &&
          v["ingore_non_equipped_weight"] == 1 &&
          (!v[`repeating_inventory_${currentID}_equipped`] ||
            v[`repeating_inventory_${currentID}_equipped`] != 1)
        )
          return;
        if (
          v[`repeating_inventory_${currentID}_itemweight`] &&
          isNaN(
            parseInt(v[`repeating_inventory_${currentID}_itemweight`], 10)
          ) === false
        ) {
          count =
            v[`repeating_inventory_${currentID}_itemcount`] &&
            isNaN(
              parseFloat(v[`repeating_inventory_${currentID}_itemcount`])
            ) === false
              ? parseFloat(v[`repeating_inventory_${currentID}_itemcount`])
              : 1;
          wtotal =
            wtotal +
            parseFloat(v[`repeating_inventory_${currentID}_itemweight`]) *
              count;
        }
      });

      update["weighttotal"] =
        wtotal % 1 === 0 ? wtotal : parseFloat(wtotal.toFixed(2));

      const str_base = parseInt(v.strength, 10);
      let size_multiplier = 1;
      if (v["size"]) {
        const size = v["size"].toLowerCase().trim();
        const sizeLookup = {
          tiny: 0.5,
          medium: 1,
          large: 2,
          huge: 4,
          gargantuan: 8,
        };
        const sizeIndex = Object.keys(sizeLookup).indexOf(size);
        size_multiplier = sizeIndex > -1 ? sizeLookup[size] : size_multiplier;
        if (v["powerful_build"] && v["powerful_build"] == 1 && sizeIndex > -1) {
          size_multiplier *= 2;
        }
      }
      let str = str_base * size_multiplier;
      // Parse the carrying capacitiy modificator if any
      if (v.carrying_capacity_mod) {
        const operator = v.carrying_capacity_mod.substring(0, 1);
        const value = v.carrying_capacity_mod.substring(1);
        if (
          ["*", "x", "+", "-"].indexOf(operator) > -1 &&
          isNaN(parseFloat(value, 10)) === false
        ) {
          str =
            operator === "*" || operator == "x"
              ? str * parseFloat(value, 10)
              : operator === "+"
              ? str + parseFloat(value, 10)
              : operator === "-"
              ? str - parseFloat(value, 10)
              : str;
        }
      }

      if (!v.encumbrance_setting || v.encumbrance_setting === "off") {
        update["encumbrance"] =
          wtotal > str * 15 ? "OVER CARRYING CAPACITY" : " ";
      } else if (v.encumbrance_setting === "on") {
        update["encumbrance"] =
          wtotal > str * 15
            ? "IMMOBILE"
            : wtotal > str * 10
            ? "HEAVILY ENCUMBERED"
            : wtotal > str * 5
            ? "ENCUMBERED"
            : " ";
      } else {
        update["encumbrance"] = " ";
      }

      setAttrs(update, { silent: true });
    });
  });
};

var update_ac = function () {
  getAttrs(["custom_ac_flag"], function (v) {
    if (v.custom_ac_flag === "2") {
      return;
    } else {
      var update = {};
      var ac_attrs = [
        "simpleinventory",
        "custom_ac_base",
        "custom_ac_part1",
        "custom_ac_part2",
        "strength_mod",
        "dexterity_mod",
        "constitution_mod",
        "intelligence_mod",
        "wisdom_mod",
        "charisma_mod",
        "custom_ac_shield",
      ];
      getSectionIDs("repeating_acmod", function (acidarray) {
        _.each(acidarray, function (currentID, i) {
          ac_attrs.push("repeating_acmod_" + currentID + "_global_ac_val");
          ac_attrs.push(
            "repeating_acmod_" + currentID + "_global_ac_active_flag"
          );
        });
        getSectionIDs("repeating_inventory", function (idarray) {
          _.each(idarray, function (currentID, i) {
            ac_attrs.push("repeating_inventory_" + currentID + "_equipped");
            ac_attrs.push(
              "repeating_inventory_" + currentID + "_itemmodifiers"
            );
          });
          getAttrs(ac_attrs, function (b) {
            var custom_total = 0;
            if (v.custom_ac_flag === "1") {
              var base =
                isNaN(parseInt(b.custom_ac_base, 10)) === false
                  ? parseInt(b.custom_ac_base, 10)
                  : 10;
              var part1attr = b.custom_ac_part1.toLowerCase();
              var part2attr = b.custom_ac_part2.toLowerCase();
              var part1 =
                part1attr === "none" ? 0 : parseInt(b[part1attr + "_mod"], 10);
              var part2 =
                part2attr === "none" ? 0 : parseInt(b[part2attr + "_mod"], 10);
              custom_total = base + part1 + part2;
            }
            var globalacmod = 0;
            _.each(acidarray, function (currentID, i) {
              if (
                b["repeating_acmod_" + currentID + "_global_ac_active_flag"] ==
                "1"
              ) {
                globalacmod += parseInt(
                  b["repeating_acmod_" + currentID + "_global_ac_val"],
                  10
                );
              }
            });
            var dexmod = +b["dexterity_mod"];
            var total = 10 + dexmod;
            var armorcount = 0;
            var shieldcount = 0;
            var armoritems = [];
            if (b.simpleinventory === "complex") {
              _.each(idarray, function (currentID, i) {
                if (
                  b["repeating_inventory_" + currentID + "_equipped"] &&
                  b["repeating_inventory_" + currentID + "_equipped"] === "1" &&
                  b["repeating_inventory_" + currentID + "_itemmodifiers"] &&
                  b["repeating_inventory_" + currentID + "_itemmodifiers"]
                    .toLowerCase()
                    .indexOf("ac") > -1
                ) {
                  var mods =
                    b[
                      "repeating_inventory_" + currentID + "_itemmodifiers"
                    ].split(",");
                  var ac = 0;
                  var type = "mod";
                  _.each(mods, function (mod) {
                    if (mod.substring(0, 10) === "Item Type:") {
                      type = mod.substring(11, mod.length).trim().toLowerCase();
                    }
                    if (
                      mod.toLowerCase().indexOf("ac:") > -1 ||
                      mod.toLowerCase().indexOf("ac +") > -1 ||
                      mod.toLowerCase().indexOf("ac+") > -1
                    ) {
                      var regex = mod.replace(/[^0-9]/g, "");
                      var bonus =
                        regex &&
                        regex.length > 0 &&
                        isNaN(parseInt(regex, 10)) === false
                          ? parseInt(regex, 10)
                          : 0;
                      ac = ac + bonus;
                    }
                    if (
                      mod.toLowerCase().indexOf("ac -") > -1 ||
                      mod.toLowerCase().indexOf("ac-") > -1
                    ) {
                      var regex = mod.replace(/[^0-9]/g, "");
                      var bonus =
                        regex &&
                        regex.length > 0 &&
                        isNaN(parseInt(regex, 10)) === false
                          ? parseInt(regex, 10)
                          : 0;
                      ac = ac - bonus;
                    }
                  });
                  armoritems.push({ type: type, ac: ac });
                }
              });
              armorcount = armoritems.filter(function (item) {
                return item["type"].indexOf("armor") > -1;
              }).length;
              shieldcount = armoritems.filter(function (item) {
                return item["type"].indexOf("shield") > -1;
              }).length;
              var base = dexmod;
              var armorac = 10;
              var shieldac = 0;
              var modac = 0;

              _.each(armoritems, function (item) {
                if (item["type"].indexOf("light armor") > -1) {
                  armorac = item["ac"];
                  base = dexmod;
                } else if (item["type"].indexOf("medium armor") > -1) {
                  armorac = item["ac"];
                  base = Math.min(dexmod, 2);
                } else if (item["type"].indexOf("heavy armor") > -1) {
                  armorac = item["ac"];
                  base = 0;
                } else if (item["type"].indexOf("shield") > -1) {
                  shieldac = item["ac"];
                } else {
                  modac = modac + item["ac"];
                }
              });

              total = base + armorac + shieldac + modac;
            }
            update["armorwarningflag"] = "hide";
            update["customacwarningflag"] = "hide";
            if (armorcount > 1 || shieldcount > 1) {
              update["armorwarningflag"] = "show";
            }
            update["ac"] = total + globalacmod;
            if (custom_total > 0) {
              if (
                armorcount > 0 ||
                (shieldcount > 0 && b.custom_ac_shield != "yes")
              ) {
                update["customacwarningflag"] = "show";
              } else {
                update["ac"] =
                  b.custom_ac_shield == "yes"
                    ? custom_total + shieldac + globalacmod + modac
                    : custom_total + globalacmod + modac;
              }
            }
            setAttrs(update, { silent: true });
          });
        });
      });
    }
  });
};

var check_customac = function (attr) {
  getAttrs(
    ["custom_ac_flag", "custom_ac_part1", "custom_ac_part2"],
    function (v) {
      if (
        v["custom_ac_flag"] &&
        v["custom_ac_flag"] === "1" &&
        ((v["custom_ac_part1"] && v["custom_ac_part1"] === attr) ||
          (v["custom_ac_part2"] && v["custom_ac_part2"] === attr))
      ) {
        update_ac();
      }
    }
  );
};

const update_initiative = () => {
  const attrs_to_get = [
    "dexterity",
    "dexterity_mod",
    "initmod",
    "jack_of_all_trades",
    "jack",
    "init_tiebreaker",
    "pb_type",
  ];
  getSectionIDs("repeating_inventory", (idarray) => {
    _.each(idarray, (currentID) => {
      attrs_to_get.push(`repeating_inventory_${currentID}_equipped`);
      attrs_to_get.push(`repeating_inventory_${currentID}_itemmodifiers`);
    });
    getAttrs(attrs_to_get, (v) => {
      let update = {};
      let final_init = parseInt(v["dexterity_mod"], 10);
      if (v["initmod"] && !isNaN(parseInt(v["initmod"], 10))) {
        final_init = final_init + parseInt(v["initmod"], 10);
      }
      if (v["init_tiebreaker"] && v["init_tiebreaker"] != 0) {
        final_init = final_init + parseInt(v["dexterity"], 10) / 100;
      }
      if (v["jack_of_all_trades"] && v["jack_of_all_trades"] != 0) {
        if (v["pb_type"] && v["pb_type"] === "die" && v["jack"]) {
          final_init = final_init + "+" + v["jack"];
        } else if (v["jack"] && !isNaN(parseInt(v["jack"], 10))) {
          final_init = final_init + parseInt(v["jack"], 10);
        }
      }
      _.each(idarray, (currentID) => {
        if (
          v[`repeating_inventory_${currentID}_equipped`] &&
          v[`repeating_inventory_${currentID}_equipped`] === "1" &&
          v[`repeating_inventory_${currentID}_itemmodifiers`] &&
          v[`repeating_inventory_${currentID}_itemmodifiers`]
            .toLowerCase()
            .indexOf("ability checks") > -1
        ) {
          const mods = v[`repeating_inventory_${currentID}_itemmodifiers`]
            .toLowerCase()
            .split(",");
          _.each(mods, (mod) => {
            if (mod.indexOf("ability checks") > -1) {
              const new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10))
                ? parseInt(mod.replace(/[^0-9]/g, ""), 10)
                : false;
              final_init =
                mod.indexOf("-") > -1 && new_mod
                  ? final_init - new_mod
                  : new_mod
                  ? final_init + new_mod
                  : final_init;
            }
          });
        }
      });
      if (final_init % 1 != 0) {
        final_init = parseFloat(final_init.toPrecision(12)); // ROUNDING ERROR BUGFIX
      }
      update["initiative_bonus"] = final_init;
      setAttrs(update, { silent: true });
    });
  });
};

const update_class = () => {
  getAttrs(
    [
      "class",
      "base_level",
      "custom_class",
      "cust_hitdietype",
      "cust_spellcasting_ability",
      "cust_strength_save_prof",
      "cust_dexterity_save_prof",
      "cust_constitution_save_prof",
      "cust_intelligence_save_prof",
      "cust_wisdom_save_prof",
      "cust_charisma_save_prof",
      "npc",
    ],
    (v) => {
      if (v.npc && v.npc == "1") {
        return;
      }
      const abilites = [
        "Strength",
        "Dexterity",
        "Constitution",
        "Intelligence",
        "Wisdom",
        "Charisma",
      ];
      //Custom Classes
      if (v.custom_class && v.custom_class != "0") {
        update = {};
        update["hitdietype"] = v.cust_hitdietype;
        update["hitdieroll"] = v.cust_hitdietype;
        update["spellcasting_ability"] = v.cust_spellcasting_ability;
        abilites.forEach((save) => {
          const ability = save.toLowerCase();
          update[`${ability}_save_prof`] = v[`cust_${ability}_save_prof`];
        });
        setAttrs(update, { silent: true });
        //If "Choose" has been selected in the select
      } else if (v.class === "") {
        update = {};
        update["hitdietype"] = 4;
        update["hitdieroll"] = 4;
        update["spellcasting_ability"] = "0*";
        abilites.forEach((save) => {
          const ability = save.toLowerCase();
          update[`${ability}_save_prof`] = 0;
        });
        setAttrs(update, { silent: true });
        //Standard classes can pull their data from the Comependium
      } else {
        getCompendiumPage(v.class, (pages) => {
          pages = removeDuplicatedPageData(pages);
          update = {};
          const classPages = Array.isArray(pages) ? pages : [pages];
          classPages.forEach((classData) => {
            if (
              classData.data &&
              "Category" in classData.data &&
              classData.data[`Category`] === "Classes"
            ) {
              update["hitdietype"] = classData.data["Hit Die"].slice(1);
              update["hitdieroll"] = classData.data["Hit Die"].slice(1);
              update["spellcasting_ability"] = classData.data[
                "Spellcasting Ability"
              ]
                ? `@{${classData.data[
                    "Spellcasting Ability"
                  ].toLowerCase()}_mod}+`
                : "0*";
              abilites.forEach((save) => {
                const ability = save.toLowerCase();
                update[`${ability}_save_prof`] =
                  classData.data["data-Saving Throws"].indexOf(`${save}`) > -1
                    ? "(@{pb})"
                    : 0;
                update_save(ability);
              });
            }

            setAttrs(update, { silent: true });
            //Update Spell info to change or remove casting attributes in Spells
            update_spell_info();
          });
        });
      }
    }
  );
  set_level();
};

const update_hds = (source) => {
  var newPool = {};
  Object.keys(source).forEach((dieType) => {
    newPool[`d${dieType}`] = {
      size: source[dieType],
    };
  });
  getHitDicePool((allPool) => {
    let hd = 0;
    let hdMax = 0;
    const existingPool = Object.keys(allPool).filter((die) => {
      return Object.keys(newPool).indexOf(die) > -1;
    });
    Object.keys(newPool).forEach((die) => {
      if (existingPool.indexOf(die) > -1) {
        const pool = allPool[die];
        const poolUpdate = newPool[die];
        const previousValue = pool.size;
        const newValue = poolUpdate.size;
        const gained =
          poolUpdate.size < pool.available
            ? poolUpdate.size - pool.available
            : Math.max(newValue - previousValue, 0);
        const available = pool.available + gained;
        newPool[die]["available"] = available;
      } else {
        newPool[die]["available"] = newPool[die]["size"];
      }
      hd += newPool[die]["available"];
      hdMax += newPool[die]["size"];
    });
    setAttrs({ hit_dice: hd, hit_dice_max: hdMax }, { silent: true }, () => {
      updateHitDicePool(newPool, true);
    });
  });
};

const set_level = function () {
  getAttrs(
    [
      "level",
      "class",
      "arcane_fighter",
      "arcane_rogue",
      "cust_classname",
      "level_calculations",
      "class",
      "subclass",
      "hitdietype",
      "use_per_class_hit_dice",
    ],
    (v) => {
      let update = {};
      let callbacks = [];
      const finalclass = v["class"];
      let finallevel = v["level"];
      const charclass = v[`class`];
      let hitdie_final = "@{hitdietype}";
      const subclass = v[`subclass`] ? v[`subclass`] + " " : "";
      const casterlevel = finallevel;
      let hitDicePool = {};
      hitDicePool[v["hitdietype"]] = finallevel;

      // This nested array is used to determine the overall spellcasting level for the character.
      var classes = [[finalclass.toLowerCase(), v[`level`]]];

      update["hitdice"] = finallevel;
      update["caster_level"] = casterlevel;
      update["hitdice_max"] = finallevel;

      callbacks.push(() => {
        update_spell_slots();
      });
      callbacks.push(() => {
        update_pb();
      });
      // callbacks.push(() => {
      //   update_leveler_display();
      // });

      setAttrs(update, { silent: true }, () => {
        callbacks.forEach((callback) => {
          callback();
        });
      });
    }
  );
};

var isMultiCaster = function (classes, arcane_fighter, arcane_rogue) {
  var singlecaster = false;
  var multicaster = false;
  _.each(classes, function (multiclass) {
    var caster =
      getCasterType(
        multiclass[0],
        multiclass[1],
        arcane_fighter,
        arcane_rogue
      ) > 0;
    if (caster && singlecaster) {
      multicaster = true;
    } else if (caster) {
      singlecaster = true;
    }
  });
  return multicaster;
};

var getCasterType = function (
  class_string,
  levels,
  arcane_fighter,
  arcane_rogue
) {
  var full = ["bard", "cleric", "druid", "sorcerer", "wizard", "full"];
  var half = ["artificer", "paladin", "ranger", "half"];
  class_string = class_string.toLowerCase();
  if (full.indexOf(class_string) != -1) {
    return 1;
  } else if (half.indexOf(class_string) != -1) {
    if (class_string === "artificer" && levels == 1) return 1;
    return levels == 1 ? 0 : 1 / 2;
  } else if (
    class_string === "third" ||
    (class_string === "fighter" && arcane_fighter == 1) ||
    (class_string === "rogue" && arcane_rogue == 1)
  ) {
    return levels == 1 || levels == 2 ? 0 : 1 / 3;
  } else {
    return 0;
  }
};

var checkCasterLevel = function (classes, arcane_fighter, arcane_rogue) {
  var multicaster = isMultiCaster(classes, arcane_fighter, arcane_rogue);
  var totalcasterlevel = 0;
  _.each(classes, function (multiclass) {
    var casterlevel =
      parseInt(multiclass[1], 10) *
      getCasterType(multiclass[0], multiclass[1], arcane_fighter, arcane_rogue);
    // Characters with multiple spellcasting classes round down the casting level for that class
    // Character with a single spellcasting class round up the casting level
    totalcasterlevel =
      totalcasterlevel +
      (multicaster ? Math.floor(casterlevel) : Math.ceil(casterlevel));
  });
  return totalcasterlevel;
};

var checkHitDie = function (class_string) {
  var d10class = ["fighter", "paladin", "ranger"];
  var d8class = [
    "artificer",
    "bard",
    "cleric",
    "druid",
    "monk",
    "rogue",
    "warlock",
  ];
  var d6class = ["sorcerer", "wizard"];
  class_string = class_string.toLowerCase();
  if (class_string === "barbarian") {
    return "12";
  } else if (d10class.indexOf(class_string) != -1) {
    return "10";
  } else if (d8class.indexOf(class_string) != -1) {
    return "8";
  } else if (d6class.indexOf(class_string) != -1) {
    return "6";
  } else {
    return "0";
  }
};

var update_leveler_display = function () {
  getAttrs(["experience", "level"], function (v) {
    let lvl = 0;
    let exp = 0;
    let update = {};
    const xpLookup = [
      0, 300, 900, 2700, 6500, 14000, 23000, 34000, 48000, 64000, 85000, 100000,
      120000, 140000, 165000, 195000, 225000, 265000, 305000, 355000,
    ];
    update["showleveler"] = 0;
    update["invalidXP"] = 0;
    if (
      v["level"] &&
      !isNaN(parseInt(v["level"], 10)) &&
      parseInt(v["level"], 10) > 0
    ) {
      lvl = parseInt(v["level"], 10);
    }
    if (v["experience"]) {
      let sanitizedXP = SheetUtils.sanitizeXP(v["experience"]);
      if (!sanitizedXP) {
        update["invalidXP"] = 1;
      } else if (Array.isArray(sanitizedXP) && sanitizedXP.length > 0) {
        exp = sanitizedXP[0];
      }
    }
    if (lvl > 0 && lvl < xpLookup.length && exp > 0) {
      if (exp >= xpLookup[lvl]) update["showleveler"] = 1;
    }
    setAttrs(update, { silent: true });
  });
};

const get_spells_slots = (casterLvl, pactMagicLvl) => {
  const casterSlots = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0],
    [2, 0, 0, 0, 0, 0, 0, 0, 0],
    [3, 0, 0, 0, 0, 0, 0, 0, 0],
    [4, 2, 0, 0, 0, 0, 0, 0, 0],
    [4, 3, 0, 0, 0, 0, 0, 0, 0],
    [4, 3, 2, 0, 0, 0, 0, 0, 0],
    [4, 3, 3, 0, 0, 0, 0, 0, 0],
    [4, 3, 3, 1, 0, 0, 0, 0, 0],
    [4, 3, 3, 2, 0, 0, 0, 0, 0],
    [4, 3, 3, 3, 1, 0, 0, 0, 0],
    [4, 3, 3, 3, 2, 0, 0, 0, 0],
    [4, 3, 3, 3, 2, 1, 0, 0, 0],
    [4, 3, 3, 3, 2, 1, 0, 0, 0],
    [4, 3, 3, 3, 2, 1, 1, 0, 0],
    [4, 3, 3, 3, 2, 1, 1, 0, 0],
    [4, 3, 3, 3, 2, 1, 1, 1, 0],
    [4, 3, 3, 3, 2, 1, 1, 1, 0],
    [4, 3, 3, 3, 2, 1, 1, 1, 1],
    [4, 3, 3, 3, 3, 1, 1, 1, 1],
    [4, 3, 3, 3, 3, 2, 1, 1, 1],
    [4, 3, 3, 3, 3, 2, 2, 1, 1],
  ];
  const pactMagicSlots = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 0, 0, 0, 0, 0, 0, 0, 0],
    [2, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 2, 0, 0, 0, 0, 0, 0, 0],
    [0, 2, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 2, 0, 0, 0, 0, 0, 0],
    [0, 0, 2, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 2, 0, 0, 0, 0, 0],
    [0, 0, 0, 2, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 2, 0, 0, 0, 0],
    [0, 0, 0, 0, 2, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 3, 0, 0, 0, 0],
    [0, 0, 0, 0, 4, 0, 0, 0, 0],
    [0, 0, 0, 0, 4, 0, 0, 0, 0],
    [0, 0, 0, 0, 4, 0, 0, 0, 0],
    [0, 0, 0, 0, 4, 0, 0, 0, 0],
  ];
  const slots = casterSlots[casterLvl].map((slots, level) => {
    return slots + pactMagicSlots[pactMagicLvl][level];
  });
  return slots
};
const update_spell_slots = () => {
  const request = [
    "level",
    "lvl1_slots_mod",
    "lvl2_slots_mod",
    "lvl3_slots_mod",
    "caster_level",
    "class"
  ];
  getAttrs(request, (response) => {
    const level = response.level;
    const moveslots = (level == 1) ? 2 :
      (level == 2) ? 2 :
      (level == 3) ? 3 :
      (level == 4) ? 3 :
      (level == 5) ? 4 :
      (level == 6) ? 4 :
      0;
    const totalSlots = get_spells_slots(+response.caster_level, 0);
    const update = {};
    update["moves_total"] = moveslots;
    if (response.caster_level == 0) {
      for (let i = 1; i <= 3; i++) {
        update[`lvl${i}_slots_total`] = 0;
      }
    } else {
      for (let i = 1; i <= 3; i++) {
        update[`lvl${i}_slots_total`] = totalSlots[i - 1];
      }
    }
    setAttrs(update, {silent:true})
  })
};

var update_pb = function () {
  callbacks = [];
  getAttrs(["level", "pb_type", "pb_custom"], function (v) {
    var update = {};
    var pb = 2;
    var lvl = parseInt(v["level"], 10);
    if (lvl < 5) {
      pb = "2";
    } else if (lvl < 9) {
      pb = "3";
    } else if (lvl < 13) {
      pb = "4";
    } else if (lvl < 17) {
      pb = "5";
    } else {
      pb = "6";
    }
    var jack = Math.floor(pb / 2);
    if (v["pb_type"] === "die") {
      update["jack"] = "d" + pb;
      update["pb"] = "d" + pb * 2;
      update["pbd_safe"] = "cs0cf0";
    } else if (
      v["pb_type"] === "custom" &&
      v["pb_custom"] &&
      v["pb_custom"] != ""
    ) {
      update["pb"] = v["pb_custom"];
      update["jack"] = !isNaN(parseInt(v["pb_custom"], 10))
        ? Math.floor(parseInt(v["pb_custom"], 10) / 2)
        : jack;
      update["pbd_safe"] = "";
    } else {
      update["pb"] = pb;
      update["jack"] = jack;
      update["pbd_safe"] = "";
    }
    callbacks.push(function () {
      update_attacks("all");
    });
    callbacks.push(function () {
      update_spell_info();
    });
    callbacks.push(function () {
      update_jack_attr();
    });
    callbacks.push(function () {
      update_initiative();
    });
    callbacks.push(function () {
      update_tool("all");
    });
    callbacks.push(function () {
      update_all_saves();
    });
    callbacks.push(function () {
      update_skills([
        "athletics",
        "acrobatics",
        "sleight_of_hand",
        "stealth",
        "arcana",
        "history",
        "investigation",
        "nature",
        "religion",
        "animal_handling",
        "insight",
        "medicine",
        "perception",
        "survival",
        "deception",
        "intimidation",
        "performance",
        "persuasion",
      ]);
    });

    setAttrs(update, { silent: true }, function () {
      callbacks.forEach(function (callback) {
        callback();
      });
    });
  });
};

var update_jack_attr = function () {
  var update = {};
  getAttrs(["jack_of_all_trades", "jack"], function (v) {
    if (v["jack_of_all_trades"] && v["jack_of_all_trades"] != 0) {
      update["jack_bonus"] = "+" + v["jack"];
      update["jack_attr"] = "+" + v["jack"] + "@{pbd_safe}";
    } else {
      update["jack_bonus"] = "";
      update["jack_attr"] = "";
    }
    setAttrs(update, { silent: true });
  });
};

var update_spell_info = function (attr) {
  var update = {};
  getAttrs(
    [
      "spellcasting_ability",
      "spell_dc_mod",
      "globalmagicmod",
      "strength_mod",
      "dexterity_mod",
      "constitution_mod",
      "intelligence_mod",
      "wisdom_mod",
      "charisma_mod",
    ],
    function (v) {
      if (
        attr &&
        v["spellcasting_ability"] &&
        v["spellcasting_ability"].indexOf(attr) === -1
      ) {
        return;
      }
      if (
        !v["spellcasting_ability"] ||
        (v["spellcasting_ability"] && v["spellcasting_ability"] === "0*")
      ) {
        update["spell_attack_bonus"] = "0";
        update["spell_save_dc"] = "0";
        var callback = function () {
          update_attacks("spells");
        };
        setAttrs(update, { silent: true }, callback);
        return;
      }
      var attr = attr ? attr : "";

      var ability = parseInt(
        v[
          v["spellcasting_ability"].substring(
            2,
            v["spellcasting_ability"].length - 2
          )
        ],
        10
      );
      var spell_mod =
        v["globalmagicmod"] && !isNaN(parseInt(v["globalmagicmod"], 10))
          ? parseInt(v["globalmagicmod"], 10)
          : 0;
      var atk =
        v["globalmagicmod"] && !isNaN(parseInt(v["globalmagicmod"], 10))
          ? ability + parseInt(v["globalmagicmod"], 10)
          : ability;
      var dc =
        v["spell_dc_mod"] && !isNaN(parseInt(v["spell_dc_mod"], 10))
          ? 8 + ability + parseInt(v["spell_dc_mod"], 10)
          : 8 + ability;
      var itemfields = ["pb_type", "pb"];

      getSectionIDs("repeating_inventory", function (idarray) {
        _.each(idarray, function (currentID, i) {
          itemfields.push("repeating_inventory_" + currentID + "_equipped");
          itemfields.push(
            "repeating_inventory_" + currentID + "_itemmodifiers"
          );
        });
        getAttrs(itemfields, function (v) {
          _.each(idarray, function (currentID) {
            if (
              (!v["repeating_inventory_" + currentID + "_equipped"] ||
                v["repeating_inventory_" + currentID + "_equipped"] === "1") &&
              v["repeating_inventory_" + currentID + "_itemmodifiers"] &&
              v["repeating_inventory_" + currentID + "_itemmodifiers"]
                .toLowerCase()
                .indexOf("spell" > -1)
            ) {
              var mods = v[
                "repeating_inventory_" + currentID + "_itemmodifiers"
              ]
                .toLowerCase()
                .split(",");
              _.each(mods, function (mod) {
                if (mod.indexOf("spell attack") > -1) {
                  var substr = mod.slice(
                    mod.lastIndexOf("spell attack") + "spell attack".length
                  );
                  atk =
                    substr && substr.length > 0 && !isNaN(parseInt(substr, 10))
                      ? atk + parseInt(substr, 10)
                      : atk;
                  spell_mod =
                    substr && substr.length > 0 && !isNaN(parseInt(substr, 10))
                      ? spell_mod + parseInt(substr, 10)
                      : spell_mod;
                }
                if (mod.indexOf("spell dc") > -1) {
                  var substr = mod.slice(
                    mod.lastIndexOf("spell dc") + "spell dc".length
                  );
                  dc =
                    substr && substr.length > 0 && !isNaN(parseInt(substr, 10))
                      ? dc + parseInt(substr, 10)
                      : dc;
                }
              });
            }
          });

          if (v["pb_type"] && v["pb_type"] === "die") {
            atk = atk + "+" + v["pb"];
            //Fixing Spell DC when using type Die
            //By Miguel
            //Used to be equals to: dc + parseInt(v["pb"].substring(1), 10) / 2
            dc = dc + "+" + v["pb"];
          } else {
            atk = parseInt(atk, 10) + parseInt(v["pb"], 10);
            dc = parseInt(dc, 10) + parseInt(v["pb"], 10);
          }
          update["spell_attack_mod"] = spell_mod;
          update["spell_attack_bonus"] = atk;
          update["spell_save_dc"] = dc;
          var callback = function () {
            update_attacks("spells");
          };
          setAttrs(update, { silent: true }, callback);
        });
      });
    }
  );
};

var update_passive_perception = function () {
  getAttrs(
    ["pb_type", "passiveperceptionmod", "perception_bonus"],
    function (v) {
      var passive_perception = 10;
      var mod = !isNaN(parseInt(v["passiveperceptionmod"], 10))
        ? parseInt(v["passiveperceptionmod"], 10)
        : 0;
      var bonus = !isNaN(parseInt(v["perception_bonus"], 10))
        ? parseInt(v["perception_bonus"], 10)
        : 0;
      if (
        v["pb_type"] &&
        v["pb_type"] === "die" &&
        v["perception_bonus"] &&
        isNaN(v["perception_bonus"]) &&
        v["perception_bonus"].indexOf("+") > -1
      ) {
        var pieces = v["perception_bonus"].split(/\+|d/);
        var base = !isNaN(parseInt(pieces[0], 10))
          ? parseInt(pieces[0], 10)
          : 0;
        var num_dice = !isNaN(parseInt(pieces[1], 10))
          ? parseInt(pieces[1], 10)
          : 1;
        var half_pb_die = !isNaN(parseInt(pieces[2], 10))
          ? parseInt(pieces[2], 10) / 2
          : 2;
        bonus = base + num_dice * half_pb_die;
      }
      passive_perception = passive_perception + bonus + mod;
      setAttrs({ passive_wisdom: passive_perception });
    }
  );
};

var update_race_display = function () {
  getAttrs(["race", "subrace"], function (v) {
    var final_race = "";
    final_race = v.subrace ? v.subrace : v.race;
    if (v.race.toLowerCase() === "dragonborn") {
      final_race = v.race;
    }
    setAttrs({ race_display: final_race });
  });
};

var organize_section_proficiencies = function () {
  getSectionIDs("proficiencies", function (ids) {
    var attribs = ["_reporder_repeating_proficiencies"];
    _.each(ids, function (id) {
      attribs.push("repeating_proficiencies_" + id + "_prof_type");
      attribs.push("repeating_proficiencies_" + id + "_name");
    });

    getAttrs(attribs, function (v) {
      var final_array = _(ids)
        .chain()
        .sortBy(function (id) {
          return v["repeating_proficiencies_" + id + "_name"];
        })
        .sortBy(function (id) {
          return v["repeating_proficiencies_" + id + "_prof_type"];
        })
        .value();
      _.each(final_array, function (id) {});
      if (final_array && final_array.length > 0) {
        setSectionOrder("proficiencies", final_array);
      }
    });
  });
};

const update_challenge = () => {
  getAttrs(["npc_challenge"], (v) => {
    let update = {};
    const challengeRatingsXP = {
      0: "10",
      "1/8": "25",
      "1/4": "50",
      "1/2": "100",
      1: "200",
      2: "450",
      3: "700",
      4: "1100",
      5: "1800",
      6: "2300",
      7: "2900",
      8: "3900",
      9: "5000",
      10: "5900",
      11: "7200",
      12: "8400",
      13: "10000",
      14: "11500",
      15: "13000",
      16: "15000",
      17: "18000",
      18: "20000",
      19: "22000",
      20: "25000",
      21: "33000",
      22: "41000",
      23: "50000",
      24: "62000",
      25: "75000",
      26: "90000",
      27: "105000",
      28: "120000",
      29: "135000",
      30: "155000",
    };

    const xp = parseInt(challengeRatingsXP[v.npc_challenge]) || 0;
    const pb =
      xp <= 1100
        ? 2
        : xp <= 3900
        ? 3
        : xp <= 8400
        ? 4
        : xp <= 15000
        ? 5
        : xp <= 25000
        ? 6
        : xp <= 62000
        ? 7
        : xp <= 120000
        ? 8
        : xp <= 155000
        ? 9
        : 0;

    update["npc_xp"] = xp;
    update["pb_custom"] = pb;
    update["pb_type"] = "custom";
    setAttrs(update, { silent: true }, function () {
      update_pb();
    });
  });
};

const update_npc_saves = () => {
  const list = [
    "npc_str_save_base",
    "npc_dex_save_base",
    "npc_con_save_base",
    "npc_int_save_base",
    "npc_wis_save_base",
    "npc_cha_save_base",
  ];
  const type = "save";
  update_npc_lists(list, type);
};

const update_npc_skills = () => {
  const list = [
    "npc_acrobatics_base",
    "npc_animal_handling_base",
    "npc_arcana_base",
    "npc_athletics_base",
    "npc_deception_base",
    "npc_history_base",
    "npc_insight_base",
    "npc_intimidation_base",
    "npc_investigation_base",
    "npc_medicine_base",
    "npc_nature_base",
    "npc_perception_base",
    "npc_performance_base",
    "npc_persuasion_base",
    "npc_religion_base",
    "npc_sleight_of_hand_base",
    "npc_stealth_base",
    "npc_survival_base",
  ];
  const type = "skills";
  update_npc_lists(list, type);
};

const update_npc_lists = (list, type) => {
  getAttrs(list, function (v) {
    let update = {};
    let last_save = 0;
    let npc_flag = 0;

    _.each(list.reverse(), (base) => {
      const attr = base.slice(4, -5); //Remove npc_ and _base
      let item = parseInt(v[`${base}`], 10);

      // CSS will add comma :after 2 & 4 and +/- :before
      // 1 = Positive Number, 2 = Last Number, 3 = Negative Number, 4 = Last Negative Number
      if ((v[`${base}`] && !isNaN(item)) || v[`${base}`] === 0) {
        if (last_save === 0) {
          last_save = 1;
          item_flag = item < 0 ? 4 : 2;
        } else {
          item_flag = item < 0 ? 3 : 1;
        }
      } else {
        item_flag = 0;
        item = "";
      }

      update[`npc_${attr}_flag`] = item_flag;
      update[`npc_${attr}`] = item;

      npc_flag += item_flag;
    });

    const flagAttr = type === "save" ? "saving" : type;
    update[`npc_${flagAttr}_flag`] = npc_flag === 0 ? "" : npc_flag;

    setAttrs(update, { silent: true });
  });
};

var update_npc_action = function (update_id, fieldset) {
  if (update_id.substring(0, 1) === "-" && update_id.length === 20) {
    do_update_npc_action([update_id], fieldset);
  } else if (update_id === "all") {
    var mythic_array = [];
    var legendary_array = [];
    var bonus_array = [];
    var actions_array = [];
    getSectionIDs("repeating_npcaction-l", function (idarray) {
      legendary_array = idarray;
      if (legendary_array.length > 0) {
        do_update_npc_action(legendary_array, "npcaction-l");
      }
      getSectionIDs("repeating_npcaction-m", function (idarray) {
        mythic_array = idarray;
        if (mythic_array.length > 0) {
          do_update_npc_action(mythic_array, "npcaction-m");
        }
        getSectionIDs("repeating_npcbonusaction", function (idarray) {
          bonus_array = idarray;
          if (bonus_array.length > 0) {
            do_update_npc_action(actions_array, "npcaction");
          }
          getSectionIDs("repeating_npcaction", function (idarray) {
            actions_array = idarray.filter(function (i) {
              return (
                legendary_array.indexOf(i) < 0 &&
                mythic_array.indexOf(i) < 0 &&
                bonus_array.indexOf(i) < 0
              );
            });
            if (actions_array.length > 0) {
              do_update_npc_action(actions_array, "npcaction");
            }
          });
        });
      });
    });
  }
};

var do_update_npc_action = function (action_array, fieldset) {
  var repvar = `repeating_${fieldset}_`;
  var action_attribs = ["dtype"];
  _.each(action_array, function (actionid) {
    action_attribs.push(repvar + actionid + "_attack_flag");
    action_attribs.push(repvar + actionid + "_attack_type");
    action_attribs.push(repvar + actionid + "_attack_range");
    action_attribs.push(repvar + actionid + "_attack_target");
    action_attribs.push(repvar + actionid + "_attack_tohit");
    action_attribs.push(repvar + actionid + "_attack_damage");
    action_attribs.push(repvar + actionid + "_attack_damagetype");
    action_attribs.push(repvar + actionid + "_attack_damage2");
    action_attribs.push(repvar + actionid + "_attack_damagetype2");
  });

  getAttrs(action_attribs, function (v) {
    _.each(action_array, function (actionid) {
      var callbacks = [];
      var update = {};
      var onhit = "";
      var damage_flag = "";
      var range = "";
      var attack_flag =
        v[repvar + actionid + "_attack_flag"] &&
        v[repvar + actionid + "_attack_flag"] != "0"
          ? "{{attack=1}}"
          : "";
      var tohit =
        v[repvar + actionid + "_attack_tohit"] &&
        isNaN(parseInt(v[repvar + actionid + "_attack_tohit"], 10)) === false
          ? parseInt(v[repvar + actionid + "_attack_tohit"], 10)
          : 0;
      if (
        v[repvar + actionid + "_attack_type"] &&
        v[repvar + actionid + "_attack_range"]
      ) {
        if (v[repvar + actionid + "_attack_type"] === "Melee") {
          var rangetype = "Reach";
        } else {
          var rangetype = "Range";
        }
        range = ", " + rangetype + " " + v[repvar + actionid + "_attack_range"];
      }
      var target =
        v[repvar + actionid + "_attack_target"] &&
        v[repvar + actionid + "_attack_target"] != ""
          ? ", " + v[repvar + actionid + "_attack_target"]
          : "";
      var attack_tohitrange = "+" + tohit + range + target;
      var dmg1 =
        v[repvar + actionid + "_attack_damage"] &&
        v[repvar + actionid + "_attack_damage"] != ""
          ? v[repvar + actionid + "_attack_damage"]
          : "";
      var dmg1type =
        v[repvar + actionid + "_attack_damagetype"] &&
        v[repvar + actionid + "_attack_damagetype"] != ""
          ? " " + v[repvar + actionid + "_attack_damagetype"]
          : "";
      var dmg2 =
        v[repvar + actionid + "_attack_damage2"] &&
        v[repvar + actionid + "_attack_damage2"] != ""
          ? v[repvar + actionid + "_attack_damage2"]
          : "";
      var dmg2type =
        v[repvar + actionid + "_attack_damagetype2"] &&
        v[repvar + actionid + "_attack_damagetype2"] != ""
          ? " " + v[repvar + actionid + "_attack_damagetype2"]
          : "";
      var dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";

      var parsed_dmg1 = parse_roll_string(dmg1);
      var parsed_dmg2 = parse_roll_string(dmg2);

      if (dmg1 != "") {
        onhit =
          onhit + parsed_dmg1.avg + " (" + dmg1 + ")" + dmg1type + " damage";
      }
      dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";
      onhit = onhit + dmgspacer;
      if (dmg2 != "") {
        onhit =
          onhit + parsed_dmg2.avg + " (" + dmg2 + ")" + dmg2type + " damage";
      }
      if (dmg1 != "" || dmg2 != "") {
        damage_flag = damage_flag + "{{damage=1}} ";
      }
      if (dmg1 != "") {
        damage_flag = damage_flag + "{{dmg1flag=1}} ";
      }
      if (dmg2 != "") {
        damage_flag = damage_flag + "{{dmg2flag=1}} ";
      }

      var crit1 = "";
      if (parsed_dmg1.rolls.length > 0) {
        parsed_dmg1.rolls.forEach(function (value) {
          crit1 += parsed_dmg1.array[value] + "+";
        });
        crit1 = crit1.substring(0, crit1.length - 1);
      }

      var crit2 = "";
      if (parsed_dmg2.rolls.length > 0) {
        parsed_dmg2.rolls.forEach(function (value) {
          crit2 += parsed_dmg2.array[value] + "+";
        });
        crit2 = crit2.substring(0, crit2.length - 1);
      }

      var rollbase = "";
      if (v.dtype === "full") {
        if (attack_flag) {
          rollbase =
            "@{wtype}&{template:npcfullatk} " +
            attack_flag +
            " @{damage_flag} @{npc_name_flag} {{rname=@{name}}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}} @{charname_output}";
        } else {
          if (dmg1) {
            rollbase =
              "@{wtype}&{template:dmgaction} @{damage_flag} @{npc_name_flag} {{rname=@{name}}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}} @{charname_output}";
          } else {
            rollbase =
              "@{wtype}&{template:npcaction} @{npc_name_flag} {{rname=@{name}}} {{description=@{show_desc}}} @{charname_output}";
          }
        }
      } else if (
        v[repvar + actionid + "_attack_flag"] &&
        v[repvar + actionid + "_attack_flag"] != "0"
      ) {
        rollbase = `@{wtype}&{template:npcatk} ${attack_flag} @{damage_flag} @{npc_name_flag} {{rname=[@{name}](~repeating_${fieldset}_npc_dmg)}} {{rnamec=[@{name}](~repeating_${fieldset}_npc_crit)}} {{type=[^{attack-u}](~repeating_${fieldset}_npc_dmg)}} {{typec=[^{attack-u}](~repeating_${fieldset}_npc_crit)}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} @{charname_output}`;
      } else if (dmg1 || dmg2) {
        if (attack_flag) {
          rollbase =
            "@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}} @{charname_output}";
        } else {
          rollbase =
            "@{wtype}&{template:dmgaction} @{damage_flag} @{npc_name_flag} {{rname=@{name}}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}} @{charname_output}";
        }
      } else {
        rollbase =
          "@{wtype}&{template:npcaction} @{npc_name_flag} {{rname=@{name}}} {{description=@{show_desc}}} @{charname_output}";
      }

      update[repvar + actionid + "_attack_tohitrange"] = attack_tohitrange;
      update[repvar + actionid + "_attack_onhit"] = onhit;
      update[repvar + actionid + "_damage_flag"] = damage_flag;
      update[repvar + actionid + "_attack_crit"] = crit1;
      update[repvar + actionid + "_attack_crit2"] = crit2;
      update[repvar + actionid + "_rollbase"] = rollbase;
      setAttrs(update, { silent: true });
    });
  });
};

var parse_roll_string = function (rollstring) {
  var out = { array: [], avg: 0, rolls: [] };

  if (!rollstring || rollstring === "") {
    return out;
  }

  var rs_regex_initial = /(\-?\d+(?:d\d+)?)/gi;
  var rs_regex_repeating = /([\+\-])(\-?\d+(?:d\d+)?)/gi;
  var rs_nospace = rollstring.replace(/\s/g, "");
  var rs_initial = rs_regex_initial.exec(rs_nospace);

  if (rs_initial) {
    out.array.push(rs_initial[1]);
    rs_regex_repeating.lastIndex = rs_regex_initial.lastIndex;
    var rs_repeating;
    while ((rs_repeating = rs_regex_repeating.exec(rs_nospace))) {
      out.array.push(rs_repeating[1], rs_repeating[2]);
    }
  }

  var add = true;
  var dice_regex = /(\d+)d(\d+)/i;
  var dice;

  out.array.forEach(function (value, index, array) {
    if (value === "+") {
      add = true;
    } else if (value === "-") {
      add = false;
    } else if ((dice = dice_regex.exec(value))) {
      // this value is a die roll
      var dice_avg = Math.floor(+dice[1] * (+dice[2] / 2 + 0.5));
      out.avg += add ? dice_avg : -dice_avg;
      out.rolls.push(index);
    } else {
      // this value is a number
      out.avg += add ? +value : -+value;
    }
  });

  return out;
};

var get_class_level = function (class_name, callback) {
  getAttrs(
    [
      "class",
      "base_level",
      "multiclass1_flag",
      "multiclass1",
      "multiclass1_lvl",
      "multiclass2_flag",
      "multiclass2",
      "multiclass2_lvl",
      "multiclass3_flag",
      "multiclass3",
      "multiclass3_lvl",
    ],
    function (attrs) {
      var regex = new RegExp(class_name, "i");
      if (regex.test(attrs["class"])) {
        callback(attrs.base_level);
      } else if (
        attrs.multiclass1_flag &&
        attrs.multiclass1_flag !== "0" &&
        regex.test(attrs.multiclass1)
      ) {
        callback(attrs.multiclass1_lvl);
      } else if (
        attrs.multiclass2_flag &&
        attrs.multiclass2_flag !== "0" &&
        regex.test(attrs.multiclass2)
      ) {
        callback(attrs.multiclass2_lvl);
      } else if (
        attrs.multiclass3_flag &&
        attrs.multiclass3_flag !== "0" &&
        regex.test(attrs.multiclass3)
      ) {
        callback(attrs.multiclass3_lvl);
      } else {
        callback("0");
      }
    }
  );
};

var update_globaldamage = function (callback) {
  getSectionIDs("damagemod", function (ids) {
    if (ids) {
      var fields = {};
      var attr_name_list = [];
      ids.forEach(function (id) {
        fields[id] = {};
        attr_name_list.push(
          `repeating_damagemod_${id}_global_damage_active_flag`,
          `repeating_damagemod_${id}_global_damage_name`,
          `repeating_damagemod_${id}_global_damage_damage`,
          `repeating_damagemod_${id}_global_damage_critical_damage`,
          `repeating_damagemod_${id}_global_damage_type`
        );
      });

      getAttrs(attr_name_list, function (attrs) {
        var regex =
          /^repeating_damagemod_(.+)_global_damage_(active_flag|name|critical_damage|damage|type)$/;
        _.each(attrs, function (obj, name) {
          var r = regex.exec(name);
          if (r) {
            fields[r[1]][r[2]] = obj;
          }
        });

        var update = {
          global_damage_mod_roll: "",
          global_damage_mod_crit: "",
          global_damage_mod_type: "",
        };
        const simpleDamageRegex = new RegExp(
          /([0-9]*d[0-9]+)|(\[.+?\])|\+|\-|\/|\*| /gi
        );
        _.each(fields, function (element) {
          if (element.active_flag != "0") {
            if (element.name && element.damage) {
              update["global_damage_mod_roll"] +=
                element.damage + "[" + element.name + "]" + "+";
            }
            if (element.name && element.critical_damage) {
              const criticalDamage = element.critical_damage;
              const criticalSource = element.name;
              update["global_damage_mod_crit"] = update[
                "global_damage_mod_crit"
              ]
                ? `${update["global_damage_mod_crit"]} + ${criticalDamage}[${criticalSource}]`
                : `${criticalDamage}[${criticalSource}]`;
              update["global_damage_mod_crit"] = update[
                "global_damage_mod_crit"
              ]
                .replace(/\+$/gi, "")
                .trim();
            } else if (element.name && element.damage) {
              const criticalDamage = element.damage;
              const criticalSource = element.name;
              const simpleDamage =
                element.damage.replace(simpleDamageRegex, "").length == 0;
              if (simpleDamage) {
                update["global_damage_mod_crit"] = update[
                  "global_damage_mod_crit"
                ]
                  ? `${update["global_damage_mod_crit"]} + ${criticalDamage}[${criticalSource}]`
                  : `${criticalDamage}[${criticalSource}]`;
                update["global_damage_mod_crit"] = update[
                  "global_damage_mod_crit"
                ]
                  .replace(/\+$/gi, "")
                  .trim();
              }
              //removing this regex
              // Remove any non-roll damage modifiers from the global damage modifier for the crit rolls
              // Will also remove any labels attached to these non-roll damage modifiers
              //.replace(/(?:[+\-*\/%]|\*\*|^)\s*\d+(?:\[.*?])?(?!\d?d\d+)/gi, '')
              // If what was just replace removed the first damage modifier, remove any now precending plus signs
              //.replace(/(?:^\+)/i, '');
            }
            if (element.type) {
              update["global_damage_mod_type"] += element.type + "/";
            }
          }
        });

        update["global_damage_mod_roll"] = update[
          "global_damage_mod_roll"
        ].replace(/\+(?=$)/, "");
        update["global_damage_mod_type"] = update[
          "global_damage_mod_type"
        ].replace(/\/(?=$)/, "");

        setAttrs(update, { silent: true }, function () {
          update_attacks("all");
          if (typeof callback == "function") callback();
        });
      });
    }
  });
};

var update_globalattack = function (callback) {
  getSectionIDs("tohitmod", function (ids) {
    if (ids) {
      var fields = {};
      var attr_name_list = [];
      ids.forEach(function (id) {
        fields[id] = {};
        attr_name_list.push(
          `repeating_tohitmod_${id}_global_attack_active_flag`,
          `repeating_tohitmod_${id}_global_attack_roll`,
          `repeating_tohitmod_${id}_global_attack_name`
        );
      });
      getAttrs(attr_name_list, function (attrs) {
        var regex =
          /^repeating_tohitmod_(.+)_global_attack_(active_flag|roll|name)$/;
        _.each(attrs, function (obj, name) {
          var r = regex.exec(name);
          if (r) {
            fields[r[1]][r[2]] = obj;
          }
        });

        var update = { global_attack_mod: "" };
        _.each(fields, function (element) {
          if (element.active_flag != "0") {
            if (element.roll && element.roll !== "") {
              update["global_attack_mod"] +=
                element.roll + "[" + element.name + "]" + "+";
            }
          }
        });
        if (update["global_attack_mod"] !== "") {
          update["global_attack_mod"] =
            "[[" + update["global_attack_mod"].replace(/\+(?=$)/, "") + "]]";
        }
        setAttrs(update, { silent: true }, function () {
          if (typeof callback == "function") callback();
        });
      });
    }
  });
};

var update_globalsaves = function (callback) {
  getSectionIDs("savemod", function (ids) {
    if (ids) {
      var fields = {};
      var attr_name_list = [];
      ids.forEach(function (id) {
        fields[id] = {};
        attr_name_list.push(
          `repeating_savemod_${id}_global_save_active_flag`,
          `repeating_savemod_${id}_global_save_roll`,
          `repeating_savemod_${id}_global_save_name`
        );
      });
      getAttrs(attr_name_list, function (attrs) {
        var regex =
          /^repeating_savemod_(.+)_global_save_(active_flag|roll|name)$/;
        _.each(attrs, function (obj, name) {
          var r = regex.exec(name);
          if (r) {
            fields[r[1]][r[2]] = obj;
          }
        });

        var update = { global_save_mod: "" };
        _.each(fields, function (element) {
          if (element.active_flag != "0") {
            if (element.roll && element.roll !== "") {
              update["global_save_mod"] +=
                element.roll + "[" + element.name + "]" + "+";
            }
          }
        });
        if (update["global_save_mod"] !== "") {
          update["global_save_mod"] =
            "[[" + update["global_save_mod"].replace(/\+(?=$)/, "") + "]]";
        }
        setAttrs(update, { silent: true }, function () {
          if (typeof callback == "function") callback();
        });
      });
    }
  });
};

var update_globalskills = function (callback) {
  getSectionIDs("skillmod", function (ids) {
    if (ids) {
      var fields = {};
      var attr_name_list = [];
      ids.forEach(function (id) {
        fields[id] = {};
        attr_name_list.push(
          `repeating_skillmod_${id}_global_skill_active_flag`,
          `repeating_skillmod_${id}_global_skill_roll`,
          `repeating_skillmod_${id}_global_skill_name`
        );
      });
      getAttrs(attr_name_list, function (attrs) {
        var regex =
          /^repeating_skillmod_(.+)_global_skill_(active_flag|roll|name)$/;
        _.each(attrs, function (obj, name) {
          var r = regex.exec(name);
          if (r) {
            fields[r[1]][r[2]] = obj;
          }
        });

        var update = { global_skill_mod: "" };
        _.each(fields, function (element) {
          if (element.active_flag != "0") {
            if (element.roll && element.roll !== "") {
              update["global_skill_mod"] +=
                element.roll + "[" + element.name + "]" + "+";
            }
          }
        });
        if (update["global_skill_mod"] !== "") {
          update["global_skill_mod"] =
            "[[" + update["global_skill_mod"].replace(/\+(?=$)/, "") + "]]";
        }
        setAttrs(update, { silent: true }, function () {
          if (typeof callback == "function") callback();
        });
      });
    }
  });
};

var check_l1_mancer = function () {
  getAttrs(
    [
      "class",
      "base_level",
      "strength_base",
      "dexterity_base",
      "constitution_base",
      "intelligence_base",
      "wisdom_base",
      "charisma_base",
      "l1mancer_status",
      "version",
      "charactermancer_step",
    ],
    function (v) {
      if (!v["version"] || parseFloat(v["version"]) < 2.2) {
        return;
      }
      if (v["l1mancer_status"] && v["l1mancer_status"] === "completed") {
        return;
      }

      if (
        v["charactermancer_step"] &&
        v["charactermancer_step"].split("-")[0] == "l1"
      ) {
        startCharactermancer(v["charactermancer_step"]);
      } else {
        if (v["l1mancer_status"] && v["l1mancer_status"] === "relaunch") {
          startCharactermancer("l1-welcome");
        } else {
          setAttrs({ mancer_confirm_flag: 1 });
        }
      }
    }
  );
};

var check_lp_mancer = function () {
  getAttrs(
    [
      "class",
      "base_level",
      "strength_base",
      "dexterity_base",
      "constitution_base",
      "intelligence_base",
      "wisdom_base",
      "charisma_base",
      "l1mancer_status",
      "lpmancer_status",
      "version",
      "charactermancer_step",
    ],
    function (v) {
      if (
        v["lpmancer_status"] === "active" &&
        v["charactermancer_step"] &&
        v["charactermancer_step"].split("-")[0] == "lp"
      ) {
        startCharactermancer(v["charactermancer_step"]);
      }
    }
  );
};

on("mancer:cancel", function (eventinfo) {
  if (!eventinfo["value"]) {
    return;
  }
  var update = {};

  if (
    eventinfo["value"] === "l1-welcome" ||
    eventinfo["value"] === "l1-cancel"
  ) {
    update["l1mancer_status"] = "completed";
    update["charactermancer_step"] = "l1-welcome";
    deleteCharmancerData([
      "l1-welcome",
      "l1-race",
      "l1-class",
      "l1-abilities",
      "l1-background",
      "l1-equipment",
      "l1-spells",
      "l1-summary",
    ]);
  } else if (eventinfo["value"].substring(0, 3) === "l1-") {
    update["l1mancer_status"] = eventinfo["value"];
  } else if (
    eventinfo["value"] === "lp-welcome" ||
    eventinfo["value"] === "lp-cancel"
  ) {
    update["lpmancer_status"] = "";
    update["charactermancer_step"] = "";
    deleteCharmancerData([
      "lp-welcome",
      "lp-levels",
      "lp-choices",
      "lp-asi",
      "lp-spells",
      "lp-summary",
    ]);
  } else if (eventinfo["value"].substring(0, 3) === "lp-") {
    update["charactermancer_step"] = "";
    update["lpmancer_status"] = "";
  }
  setAttrs(update);
});

on("change:hitdie_final", function (eventinfo) {
  setHitdieroll();
});

on("sheet:opened", function (eventinfo) {
  setHitdieroll();
  update_leveler_display();
});

var setHitdieroll = function () {
  getAttrs(["npc", "hitdietype"], function (v) {
    if ((v["npc"] && v["npc"] == 1) || !v["hitdietype"]) return;
    v["hitdietype"] =
      globalAttributesByCategory.hitDieTypes.indexOf(`d${v["hitdietype"]}`) > -1
        ? v["hitdietype"]
        : "4";
    setAttrs({ hitdieroll: v["hitdietype"] });
  });
};

var flagManager = new FlagManager("ui_flags");
[
  { section: "npcaction", button: "edit" },
  { section: "npcbonusaction", button: "edit" },
  { section: "npctrait", button: "edit" },
  { section: "npcreaction", button: "edit" },
  { section: "npcaction-l", button: "edit" },
  { section: "npcaction-m", button: "edit" },
].forEach((flag) => {
  on(`clicked:repeating_${flag.section}:${flag.button}`, function (eventInfo) {
    SheetUtils.getSectionOrder(flag.section, (ids) => {
      const uid = SheetUtils.getUID(eventInfo.sourceAttribute).toLowerCase();
      const index = ids.indexOf(uid);
      const flagName = `repeating_${flag.section}_${flag.button}_${index}_${uid}`;
      flagManager.toggleFlag(flagName);
    });
  });
  on(`remove:repeating_${flag.section}`, function (eventInfo) {
    flagManager.syncFlagsWithRepeatingSection(flag.section);
  });
  on(`change:_reporder:${flag.section}`, function (eventInfo) {
    flagManager.syncFlagsWithRepeatingSection(flag.section);
  });
  on(`change:repeating_${flag.section}`, function (eventInfo) {
    if (
      !eventInfo.sourceType ||
      eventInfo.sourceType !== "player" ||
      (eventInfo.sourceAttribute &&
        eventInfo.sourceAttribute.indexOf("_rollbase") > -1)
    )
      return;
    SheetUtils.getSectionOrder(flag.section, (ids) => {
      const uid = SheetUtils.getUID(eventInfo.sourceAttribute.toLowerCase());
      const index = ids.indexOf(uid);
      if (index === ids.length - 1) {
        const flagName = `repeating_${flag.section}_${flag.button}_${index}_${uid}`;
        flagManager.addFlag(flagName);
      }
    });
  });
});

var showOptionalAttributeFields = function () {
  const optionalAttributesClasses = SheetUtils.toLowerCase(
    abilityListEnabledOptionals
  ).map((key) => `sheet-${key}_toggle`);
  optionalAttributesClasses.forEach((attribute) => {
    showChoices([attribute]);
  });
};

var getAllSpellsIDS = function (callback) {
  const levels = ["cantrip", "1", "2", "3", "4", "5", "6", "6", "8", "9"];
  let currentLevel = 0;
  let spells = [];
  getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
    ids.forEach((id) => {
      spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
    });
    currentLevel = 1;
    getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
      ids.forEach((id) => {
        spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
      });
      currentLevel = 2;
      getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
        ids.forEach((id) => {
          spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
        });
        currentLevel = 3;
        getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
          ids.forEach((id) => {
            spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
          });
          currentLevel = 4;
          getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
            ids.forEach((id) => {
              spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
            });
            currentLevel = 5;
            getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
              ids.forEach((id) => {
                spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
              });
              currentLevel = 6;
              getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
                ids.forEach((id) => {
                  spells.push(`repeating_spell-${levels[currentLevel]}_${id}`);
                });
                currentLevel = 7;
                getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
                  ids.forEach((id) => {
                    spells.push(
                      `repeating_spell-${levels[currentLevel]}_${id}`
                    );
                  });
                  currentLevel = 8;
                  getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
                    ids.forEach((id) => {
                      spells.push(
                        `repeating_spell-${levels[currentLevel]}_${id}`
                      );
                    });
                    currentLevel = 9;
                    getSectionIDs(`spell-${levels[currentLevel]}`, (ids) => {
                      ids.forEach((id) => {
                        spells.push(
                          `repeating_spell-${levels[currentLevel]}_${id}`
                        );
                      });
                      callback(spells);
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });
};

on("sheet:opened change:honor_toggle change:sanity_toggle", (eventInfo) => {
  getAttrs(["honor_toggle", "sanity_toggle"], (values) => {
    abilityListEnabledOptionals = SheetUtils.toCapitalCase(
      Object.keys(values)
        .filter((key) => {
          return values[key] === "1";
        })
        .map((key) => key.replace("_toggle", ""))
    );
    abilityList = SheetUtils.toCapitalCase(
      globalAttributesByCategory.abilities
    ).concat(abilityListEnabledOptionals);
  });
});

globalAttributesByCategory.skills.all().forEach((skill) => {
  on(`change:${skill}_bonus`, () => {
    updateSkillRoll(skill);
  });
});

globalAttributesByCategory.abilitiesWithAllOptionals.forEach((ability) => {
  on(`change:${ability}_save_bonus`, () => {
    updateSavingRoll(ability);
  });
});

on("change:rtype change:reliable_talent change:pb", (eventInfo) => {
  getSectionIDs("repeating_tool", (idarray) => {
    updateSavingRolls(globalAttributesByCategory.abilitiesWithAllOptionals);
    updateSkillRolls(globalAttributesByCategory.skills.all());
    do_update_tool(idarray);
  });
});

var updateSkillRoll = function (skill, callback) {
  updateSkillRolls([skill], callback);
};

var updateSavingRoll = function (saving, callback) {
  updateSavingRolls([saving], callback);
};

const checkProficiency = function (values, prof) {
  return values[prof] && values[prof].indexOf("@{pb}") > -1;
};

var updateSavingRolls = function (savings, callback) {
  const attrs_prof = savings.map((saving) => {
    return `${saving}_save_prof`;
  });
  const attrs_bonus = savings.map((saving) => {
    return `${saving}_save_bonus`;
  });
  getAttrs(
    [
      ...attrs_prof,
      ...attrs_bonus,
      "reliable_talent",
      "rtype",
      "advantagetoggle",
      "queryadvantage",
      "pb",
    ],
    (values) => {
      const usingProficiencyDie =
        values.pb && String(values.pb).includes("d") ? true : false;
      let rtype = values["rtype"].includes("@{advantagetoggle}")
        ? values["advantagetoggle"]
        : values["rtype"];
      rtype = values["rtype"].includes("@{queryadvantage}")
        ? values["queryadvantage"]
        : values["rtype"];
      let update = {};
      savings.forEach((saving) => {
        let roll;
        const isProficient = checkProficiency(values, `${saving}_save_prof`);
        if (usingProficiencyDie && isProficient) {
          const proficiencyDie = values.pb.match(/^[0-9]/)
            ? values.pb
            : `${values.pb}`;
          const savingBonus = String(values[`${saving}_save_bonus`])
            .replace(proficiencyDie, "")
            .replace(/\+{2,}|-{2,}|^[\+-]|[\+-]$/, "");
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+${savingBonus}]]}} `;
          const r3 = ` + [[${proficiencyDie}@{pbd_safe}[Proficiency]]]`;
          roll = `@{wtype}&{template:simple3D} {{rname=^{${saving}-save-u}}} {{mod=${
            values[`${saving}_save_bonus`]
          }}} {{r1=[[@{d20}+${savingBonus}]]}} {{r3=${r3}}} ${rtypeString}{{global=@{global_save_mod}}} @{charname_output}`;
        } else {
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+@{${saving}_save_bonus}@{pbd_safe}]]}} `;
          roll = `@{wtype}&{template:simple} {{rname=^{${saving}-save-u}}} {{mod=@{${saving}_save_bonus}}} {{r1=[[@{d20}+@{${saving}_save_bonus}@{pbd_safe}]]}} ${rtypeString}{{global=@{global_save_mod}}} @{charname_output}`;
        }
        update[`${saving}_save_roll`] = roll;
      });
      setAttrs(update, () => {
        if (callback) callback();
      });
    }
  );
};

var updateSkillRolls = function (skills, callback) {
  const attrs_prof = skills.map((skill) => {
    return `${skill}_prof`;
  });
  const attrs_bonus = skills.map((skill) => {
    return `${skill}_bonus`;
  });
  const attrs_type = skills.map((skill) => {
    return `${skill}_type`;
  });
  const ability_mods = globalAttributesByCategory.abilities.map((ability) => {
    return `${ability}_mod`;
  });
  getAttrs(
    [
      ...attrs_prof,
      ...attrs_bonus,
      ...attrs_type,
      ...ability_mods,
      "reliable_talent",
      "jack_of_all_trades",
      "jack",
      "rtype",
      "advantagetoggle",
      "queryadvantage",
      "pb",
    ],
    (values) => {
      const usingProficiencyDie =
        values.pb && String(values.pb).includes("d") ? true : false;
      let rtype = values["rtype"].includes("@{advantagetoggle}")
        ? values["advantagetoggle"]
        : values["rtype"];
      rtype = values["rtype"].includes("@{queryadvantage}")
        ? values["queryadvantage"]
        : values["rtype"];
      const query = rtype.indexOf("queryadvantage") > -1;
      const isJack =
        values["jack_of_all_trades"] &&
        values["jack_of_all_trades"] == "@{jack}";
      let update = {};
      skills.forEach((skill) => {
        let roll;
        const isProficient = checkProficiency(values, `${skill}_prof`);
        if (
          (usingProficiencyDie && isProficient) ||
          (usingProficiencyDie && isJack)
        ) {
          const die =
            !isProficient && isJack
              ? `${values["jack"]}`
              : `${values[`${skill}_type`]}${values.pb}`;
          const proficiencyDie = die;
          const jackSafeDie =
            !isProficient && isJack ? `round(${values.pb}/2)` : proficiencyDie;
          const skillBonus = String(values[`${skill}_bonus`])
            .replace(proficiencyDie, "")
            .replace(/\+{2,}|-{2,}|^[\+-]|[\+-]$/, "");
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+${skillBonus}]]}} `;
          const r3 = ` + [[${jackSafeDie}@{pbd_safe}[Proficiency]]]`;
          roll = `@{wtype}&{template:simple3D} {{rname=^{${skill}-u}}} {{mod=${
            values[`${skill}_bonus`]
          }}} {{r1=[[@{d20}+${skillBonus}[Mods]]]}} {{r3=${r3}}} ${rtypeString}{{global=@{global_skill_mod}}} @{charname_output}`;
        } else {
          let profBonus =
            values["pb"] && isProficient ? parseInt(values["pb"]) : 0;
          profBonus =
            !isProficient && isJack && values["pb"]
              ? Math.round(parseInt(values["pb"]) / 2)
              : profBonus;
          let rollBonuses = `@{${skill}_bonus}[Mods]`;
          if (
            values[`${skill}_bonus`] &&
            values[`${skill}_bonus`].toString().toLowerCase().indexOf("d") ===
              -1
          ) {
            const parentAbility =
              globalAttributesByCategory.skills.getParentAbility(skill);
            const parentMod = parseInt(values[`${parentAbility}_mod`]);
            const otherBonuses = parseInt(values[`${skill}_bonus`]) - profBonus;
            const label = otherBonuses > parentMod ? "Mods" : parentAbility;
            if (profBonus != 0 && otherBonuses != 0) {
              rollBonuses =
                `${profBonus}[Proficiency]+${otherBonuses}[${label}]`.replace(
                  /\+-/g,
                  "-"
                );
            } else if (profBonus == 0 && otherBonuses != 0) {
              rollBonuses = `${otherBonuses}[${label}]`.replace(/\+-/g, "-");
            } else if (profBonus != 0 && otherBonuses == 0) {
              rollBonuses = `${profBonus}[Proficiency]`.replace(/\+-/g, "-");
            } else {
              let rollBonuses = `@{${skill}_bonus}[Mods]`;
            }
          }
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+${rollBonuses}@{pbd_safe}]]}} `;
          roll = `@{wtype}&{template:simple} {{rname=^{${skill}-u}}} {{mod=@{${skill}_bonus}}} {{r1=[[@{d20}+${rollBonuses}@{pbd_safe}]]}} ${rtypeString}{{global=@{global_skill_mod}}} @{charname_output}`;
        }
        if (
          values["reliable_talent"] &&
          values["reliable_talent"] == 10 &&
          values[`${skill}_prof`] &&
          values[`${skill}_prof`] != 0
        ) {
          if (query) {
            const queryReplace = "r2=[[{1d20,0d20+10}k1"
              .replace("{", "&#123;")
              .replace("}", "&#125;")
              .replace(",", "&#44;");
            roll = roll.replace(/r2=\[\[@{d20}/g, queryReplace);
            roll = roll.replace(/@{d20}/g, "{@{d20},0d20+10}k1");
          } else {
            roll = roll.replace(/@{d20}/g, "{@{d20},0d20+10}k1");
          }
        }
        update[`${skill}_roll`] = roll;
      });
      setAttrs(update, () => {
        if (callback) callback();
      });
    }
  );
};

var updateToolRolls = function (toolsIDs, callback) {
  const attrs_prof = toolsIDs.map((id) => {
    return `repeating_tool_${id}_toolbonus_base`;
  });
  const attrs_bonus = toolsIDs.map((id) => {
    return `repeating_tool_${id}_toolbonus`;
  });
  const attrs_bonus_base = toolsIDs.map((id) => {
    return `repeating_tool_${id}_toolbonus_base`;
  });
  getAttrs(
    [
      ...attrs_prof,
      ...attrs_bonus,
      ...attrs_bonus_base,
      "reliable_talent",
      "jack_of_all_trades",
      "jack",
      "rtype",
      "advantagetoggle",
      "queryadvantage",
      "pb",
    ],
    (values) => {
      const usingProficiencyDie =
        values.pb && String(values.pb).includes("d") ? true : false;
      let rtype = values["rtype"].includes("@{advantagetoggle}")
        ? values["advantagetoggle"]
        : values["rtype"];
      rtype = values["rtype"].includes("@{queryadvantage}")
        ? values["queryadvantage"]
        : values["rtype"];
      const query = rtype.indexOf("queryadvantage") > -1;
      let update = {};
      const isJack =
        values["jack_of_all_trades"] &&
        values["jack_of_all_trades"] == "@{jack}";
      toolsIDs.forEach((id) => {
        let roll;
        if (usingProficiencyDie) {
          const isProficient =
            values[`repeating_tool_${id}_toolbonus_base`] !==
            "(floor(@{pb}/2))";
          const proficiencyType =
            values[`repeating_tool_${id}_toolbonus_base`] &&
            values[`repeating_tool_${id}_toolbonus_base`] === "(@{pb}*2)"
              ? "2"
              : "";
          const die =
            isJack && !isProficient
              ? `${proficiencyType}${values["jack"]}`
              : `${proficiencyType}${values.pb}`;
          const proficiencyDie = die;
          const jackSafeDie =
            !isProficient && isJack ? `round(${values.pb}/2)` : proficiencyDie;
          const skillBonus = String(values[`repeating_tool_${id}_toolbonus`])
            .replace(proficiencyDie, "")
            .replace(/\+{2,}|-{2,}|^[\+-]|[\+-]$/, "")
            .replace(/\+0|-0/, "");
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+${skillBonus}]]}} `;
          const r3 = ` + [[${jackSafeDie}@{pbd_safe}[Proficiency]]]`;
          roll = `@{wtype}&{template:simple3D} {{rname=@{toolname}}} {{mod=${
            values[`repeating_tool_${id}_toolbonus`]
          }}} {{r1=[[@{d20}+${skillBonus}[Mods]]]}} {{r3=${r3}}} ${rtypeString}{{global=@{global_skill_mod}}} @{charname_output}`;
        } else {
          const rtypeString = rtype.includes("{{normal=1}}")
            ? "{{normal=1}} "
            : `${rtype}+@{toolbonus}[Mods]@{pbd_safe}]]}} `;
          roll = `@{wtype}&{template:simple} {{rname=@{toolname}}} {{mod=@{toolbonus}}} {{r1=[[@{d20}+@{toolbonus}[Mods]@{pbd_safe}]]}} ${rtypeString}{{global=@{global_skill_mod}}} @{charname_output}`;
        }
        if (
          values["reliable_talent"] &&
          values["reliable_talent"] == 10 &&
          values[`repeating_tool_${id}_toolbonus_base`] &&
          values[`repeating_tool_${id}_toolbonus_base`] != "(floor(@{pb}/2))"
        ) {
          if (query) {
            const queryReplace = "r2=[[{1d20,0d20+10}k1"
              .replace("{", "&#123;")
              .replace("}", "&#125;")
              .replace(",", "&#44;");
            roll = roll.replace(/r2=\[\[@{d20}/g, queryReplace);
            roll = roll.replace(/@{d20}/g, "{@{d20},0d20+10}k1");
          } else {
            roll = roll.replace(/@{d20}/g, "{@{d20},0d20+10}k1");
          }
        }
        update[`repeating_tool_${id}_toolroll`] = roll;
      });
      setAttrs(update, () => {
        if (callback) callback();
      });
    }
  );
};

var updateCharnameOutput = function (npcCallback, pcCallback) {
  getAttrs(["npc", "npc_name", "npc_name_flag"], (values) => {
    if (
      values["npc"] &&
      values["npc"] == "1" &&
      values["npc_name"] &&
      values["npc_name_flag"]
    ) {
      const charname = values["npc_name_flag"].replace("name", "charname");
      setAttrs({ charname_output: charname }, () => {
        if (npcCallback) npcCallback();
      });
    } else {
      if (pcCallback) pcCallback();
      else if (npcCallback) npcCallback();
    }
  });
};

on("change:npc_name change:npc_name_flag", (eventInfo) => {
  updateCharnameOutput();
});

var getHitDiceAttributeSet = function (id) {
  let attributes = [];
  attributes.push(`repeating_hd_${id}_type`);
  attributes.push(`repeating_hd_${id}_size`);
  attributes.push(`repeating_hd_${id}_available`);
  return attributes;
};
var getHitDicePool = function (callback, single) {
  getSectionIDs("repeating_hd", (ids) => {
    if (single) ids = [single];
    let attributes = [];
    ids.forEach((id) => {
      attributes = attributes.concat(getHitDiceAttributeSet(id));
    });
    getAttrs(attributes, (values) => {
      let pool = {};
      if (single) {
        (pool["id"] = ids[0]),
          (pool["size"] = parseInt(values[`repeating_hd_${ids[0]}_size`] || 0)),
          (pool["available"] =
            parseInt(values[`repeating_hd_${ids[0]}_available`]) || 0);
        pool["type"] = parseInt(values[`repeating_hd_${ids[0]}_type`]) || 0;
      } else {
        ids.forEach((id) => {
          pool[`d${values[`repeating_hd_${id}_type`]}`] = {
            id: id,
            size: parseInt(values[`repeating_hd_${id}_size`] || 0),
            available: parseInt(values[`repeating_hd_${id}_available`]) || 0,
          };
        });
      }
      if (typeof callback === "function") callback(pool);
    });
  });
};
var isValidEvent = function (eventInfo, blockWorker) {
  if (
    blockWorker &&
    (!eventInfo.sourceType || eventInfo.sourceType != "player")
  )
    return false;
  if (
    eventInfo.newValue &&
    eventInfo.previousValue &&
    eventInfo.newValue != eventInfo.previousValue
  )
    return true;
  if (eventInfo.newValue && !eventInfo.previousValue) return true;
  return false;
};
var updateHitDicePool = function (newPool, silent) {
  if (Object.keys(newPool).length === 0) return;
  silent = silent || false;
  getHitDicePool((availablePool) => {
    let update = {};
    Object.keys(newPool).forEach((die) => {
      if (availablePool[die]) {
        const id = availablePool[die].id;
        Object.keys(newPool[die]).forEach((property) => {
          update[`repeating_hd_${id}_${property}`] = newPool[die][property];
        });
      } else {
        const id = generateRowID();
        update[`repeating_hd_${id}_type`] = die.replace(/[^0-9]/g, "");
        Object.keys(newPool[die]).forEach((property) => {
          update[`repeating_hd_${id}_${property}`] = newPool[die][property];
        });
      }
    });
    if (silent) {
      setAttrs(update, { silent: true });
    } else {
      setAttrs(update);
    }
  });
};
on("change:repeating_hd:size", (eventInfo) => {
  if (isValidEvent(eventInfo, true)) {
    const id = SheetUtils.getUID(eventInfo.sourceAttribute);
    const newValue = eventInfo.newValue || 0;
    const previousValue = eventInfo.previousValue || 0;
    let hitDiceMax = 0;
    getHitDicePool((allPool) => {
      const selectedPoolKey = Object.keys(allPool).filter((die) => {
        return allPool[die]["id"] == id;
      });
      const pool = allPool[selectedPoolKey];
      const gained =
        pool.size < pool.available
          ? pool.size - pool.available
          : Math.max(newValue - previousValue, 0);
      const available = pool.available + gained;
      const update = {
        [`repeating_hd_${pool.id}_available`]: available,
      };
      Object.keys(allPool).forEach((die) => {
        hitDiceMax += allPool[die]["size"];
      });
      setAttrs(update, () => {
        setAttrs({ hit_dice_max: hitDiceMax }, { silent: true });
      });
    });
  }
});
on("change:repeating_hd:available", (eventInfo) => {
  if (isValidEvent(eventInfo, true)) {
    getHitDicePool((pool) => {
      let dicePoolSize = 0;
      Object.keys(pool).forEach((die) => {
        dicePoolSize += pool[die]["available"];
      });
      let update = { hit_dice: dicePoolSize };
      setAttrs(update, { silent: true });
    });
  }
});
on("change:repeating_hd:consumed", (eventInfo) => {
  const id = SheetUtils.getUID(eventInfo.sourceAttribute);
  const poolAttribute = `repeating_hd_${id}_available`;
  getAttrs([poolAttribute], (values) => {
    const update = {
      [poolAttribute]: Math.max(parseInt(values[poolAttribute]) - 1, 0),
    };
    setAttrs(update, { silent: true }, () => {
      getHitDicePool((pool) => {
        let dicePoolSize = 0;
        Object.keys(pool).forEach((die) => {
          dicePoolSize += pool[die]["available"];
        });
        let update = { hit_dice: dicePoolSize };
        setAttrs(update, { silent: true });
      });
    });
  });
});
on("change:use_per_class_hit_dice", (eventInfo) => {
  set_level();
});
on("change:hit_dice", (eventInfo) => {
  //For compatibility with rest script
  getAttrs(["use_per_class_hit_dice", "hit_dice"], (values) => {
    if (
      values["use_per_class_hit_dice"] &&
      values["use_per_class_hit_dice"] == 1
    ) {
      let increaseLeft = 0;
      let updatePool = {};
      getHitDicePool((pool) => {
        let dicePoolSize = 0;
        Object.keys(pool).forEach((die) => {
          dicePoolSize += pool[die]["available"];
        });
        increaseLeft = parseInt(values["hit_dice"]) - dicePoolSize;
        ["d12", "d10", "d8", "d6", "d4"].forEach((die) => {
          if (pool[die] && pool[die]["available"] < pool[die]["size"]) {
            const diff = Math.min(
              pool[die]["size"] - pool[die]["available"],
              increaseLeft
            );
            updatePool[die] = { available: pool[die]["available"] + diff };
            increaseLeft -= diff;
            return;
          }
        });
        updateHitDicePool(updatePool, true);
      });
    }
  });
});
on("clicked:show_hit_dice", (eventInfo) => {
  getSectionIDs("repeating_hd", (ids) => {
    let attributes = [];
    ids.forEach((id) => {
      attributes.push(`repeating_hd_${id}_type`);
      attributes.push(`repeating_hd_${id}_size`);
      attributes.push(`repeating_hd_${id}_available`);
    });
    getAttrs(attributes, (values) => {
      const types = Object.keys(values).filter((entry) => {
        return entry.indexOf("_type") > -1;
      });
      let dice = [];
      let update = {
        current_d4: 0,
        current_d6: 0,
        current_d8: 0,
        current_d10: 0,
        current_d12: 0,
        current_d4_max: 0,
        current_d6_max: 0,
        current_d8_max: 0,
        current_d10_max: 0,
        current_d12_max: 0,
        show_hit_dice_roll: "[[0]]",
      };
      types.forEach((type) => {
        dice.push(values[type]);
        const id = SheetUtils.getUID(type);
        update[`current_d${values[type]}_max`] =
          values[`repeating_hd_${id}_available`];
      });
      update["show_hit_dice"] = dice.join(" ");
      setAttrs(update);
    });
  });
});
on(
  "change:current_d4 change:current_d6 change:current_d4 change:current_d8 change:current_d10 change:current_d12",
  (eventInfo) => {
    if (eventInfo.newValue || eventInfo.previousValue) {
      getAttrs(
        [
          "current_d4",
          "current_d6",
          "current_d8",
          "current_d10",
          "current_d12",
          "constitution_mod",
        ],
        (values) => {
          let query = [];
          let totalDice = 0;
          Object.keys(values)
            .filter((entry) => {
              return entry.includes("current_");
            })
            .forEach((entry) => {
              if (parseInt(values[entry]) > 0) {
                const splited = entry.split("_");
                const dice = splited[splited.length - 1];
                query.push(`${values[entry]}${dice}`);
                totalDice += parseInt(values[entry]);
              }
            });
          if (
            totalDice > 0 &&
            values["constitution_mod"] &&
            values["constitution_mod"] != 0
          )
            query.push(parseInt(values["constitution_mod"]) * totalDice);
          setAttrs({ show_hit_dice_roll: query.join(" + ") });
        }
      );
    }
  }
);
on("change:hit_dice_rolled", (eventInfo) => {
  getSectionIDs("repeating_hd", (ids) => {
    let attributes = [];
    ids.forEach((id) => {
      attributes.push(`repeating_hd_${id}_type`);
      attributes.push(`repeating_hd_${id}_size`);
      attributes.push(`repeating_hd_${id}_available`);
    });

    getAttrs(
      [
        ...attributes,
        "current_d4",
        "current_d6",
        "current_d8",
        "current_d10",
        "current_d12",
      ],
      (values) => {
        const types = Object.keys(values).filter((entry) => {
          return entry.indexOf("_type") > -1;
        });
        let update = {
          current_d4: 0,
          current_d6: 0,
          current_d8: 0,
          current_d10: 0,
          current_d12: 0,
          current_d4_max: 0,
          current_d6_max: 0,
          current_d8_max: 0,
          current_d10_max: 0,
          current_d12_max: 0,
          show_hit_dice: "",
          show_hit_dice_roll: "[[0]]",
        };
        types.forEach((type) => {
          const die = values[type];
          if (
            values[`current_d${die}`] &&
            parseInt(values[`current_d${die}`]) > 0
          ) {
            const id = SheetUtils.getUID(type);
            const result = parseInt(
              values[`repeating_hd_${id}_available`] - values[`current_d${die}`]
            );
            update[`repeating_hd_${id}_available`] = Math.max(result, 0);
          }
        });
        setAttrs(update);
      }
    );
  });
});
on("clicked:hide_hit_dice", (eventInfo) => {
  let update = {
    current_d4: 0,
    current_d6: 0,
    current_d8: 0,
    current_d10: 0,
    current_d12: 0,
    current_d4_max: 0,
    current_d6_max: 0,
    current_d8_max: 0,
    current_d10_max: 0,
    current_d12_max: 0,
    show_hit_dice: "",
    show_hit_dice_roll: "[[0]]",
  };
  setAttrs(update);
});
on("change:consumed_hero_points", (eventInfo) => {
  getAttrs(["hero_points"], (values) => {
    const hero_points = values["hero_points"]
      ? parseInt(values["hero_points"])
      : 0;
    const update = { hero_points: Math.max(hero_points - 1, 0) };
    setAttrs(update, { silent: true }, () => {});
  });
});
on("change:hero_points", (eventInfo) => {
  const hero_points = eventInfo.newValue ? Math.max(eventInfo.newValue, 0) : 0;
  const update = { hero_points: hero_points };
  setAttrs(update, { silent: true }, () => {});
});
on("change:level", (eventInfo) => {
  updateHeroPoints(eventInfo.newValue);
});
on("change:use_hero_points", (eventInfo) => {
  if (eventInfo.newValue && eventInfo.newValue == 1) updateHeroPoints();
});
var updateHeroPoints = function (level) {
  if (level) {
    const hero_points = level ? Math.floor(parseInt(level) / 2) + 5 : 0;
    const update = { hero_points: hero_points };
    setAttrs(update, { silent: true }, () => {});
  } else {
    getAttrs(["level"], (values) => {
      const level = values.level ? values.level : 0;
      updateHeroPoints(level);
    });
  }
};

const classRelatedAttrs = [
  "class",
  "subclass",
  "base_level",
  "multiclass1_flag",
  "multiclass1",
  "multiclass1_subclass",
  "multiclass1_lvl",
  "multiclass2_flag",
  "multiclass2",
  "multiclass2_subclass",
  "multiclass2_lvl",
  "multiclass3_flag",
  "multiclass3",
  "multiclass3_subclass",
  "multiclass3_lvl",
];
const getSpellPoints = (callback) => {
  getAttrs(classRelatedAttrs, (values) => {
    let level = 0;
    let characterClassAttributes = {
      mainclass: {
        class: "class",
        subclass: "subclass",
        level: "base_level",
      },
    };
    for (let i = 1; i <= 3; i++) {
      characterClassAttributes[`multiclass_${i}`] = {
        enabled: `multiclass${i}_flag`,
        class: `multiclass${i}`,
        subclass: `multiclass${i}_subclass`,
        level: `multiclass${i}_lvl`,
      };
    }
    const pointsPerLevel = [
      "",
      4,
      6,
      14,
      17,
      27,
      32,
      38,
      44,
      57,
      64,
      73,
      78,
      83,
      88,
      94,
      100,
      107,
      114,
      123,
      133,
    ];
    const getLevelInfo = (charClass, values) => {
      let charLevel = 0;
      if (!characterClassAttributes[charClass]) return charLevel;
      if (
        !characterClassAttributes[charClass]["enabled"] ||
        (values[characterClassAttributes[charClass]["enabled"]] &&
          values[characterClassAttributes[charClass]["enabled"]] == 1)
      ) {
        const subclass =
          values[characterClassAttributes[charClass]["subclass"]] || "";
        const level = values[characterClassAttributes[charClass]["level"]]
          ? parseInt(values[characterClassAttributes[charClass]["level"]])
          : 0;
        charClass =
          subclass.toLowerCase().includes("arcane trickster") ||
          subclass.toLowerCase().includes("eldritch knight")
            ? "third"
            : values[characterClassAttributes[charClass]["class"]];
        const casterType = getCasterType(charClass.toLowerCase());
        if (casterType > 0) {
          charLevel = Math.floor(level * casterType);
        }
      }
      return charLevel;
    };
    Object.keys(characterClassAttributes).forEach((charClass) => {
      const levelInfo = getLevelInfo(charClass, values);
      level += levelInfo;
    });
    callback(pointsPerLevel[level]);
  });
};

const setSpellPoints = () => {
  getSpellPoints((spellPoints) => {
    if (spellPoints > 0)
      createResource("Spell Points", spellPoints, spellPoints);
  });
};

classRelatedAttrs.forEach((attr) => {
  on(`change:${attr}`, (evenInfo) => {
    getAttrs(["use_spell_points"], (v) => {
      if (v["use_spell_points"] && v["use_spell_points"] == 1) {
        setSpellPoints();
      }
    });
  });
});

on("change:use_spell_points", (eventInfo) => {
  if (eventInfo.newValue && eventInfo.newValue == 1) {
    setSpellPoints();
  } else {
    deleteResource("Spell Points");
  }
  update_spell_slots();
});

var updateSpellOutputDC = function (eventinfo) {
  if (!eventinfo.newValue) return;
  getAttrs(
    [
      "strength_mod",
      "dexterity_mod",
      "constitution_mod",
      "intelligence_mod",
      "wisdom_mod",
      "charisma_mod",
      "spell_save_dc",
      "pb",
    ],
    (values) => {
      let dc = 0;
      const spellLevel = eventinfo.sourceAttribute
        .split("_")[1]
        .replace("spell-", "");
      const pb = values.pb ? parseInt(values.pb) : 0;
      if (eventinfo.newValue === "spell") {
        const spellSaveDc = values["spell_save_dc"]
          ? parseInt(values["spell_save_dc"])
          : 8 + pb;
        dc = spellSaveDc;
      } else if (eventinfo.newValue === "0*") {
        dc = 0;
      } else {
        const attr = eventinfo.newValue.replace(/@{|}\+/g, "");
        const mod = values[attr] ? 8 + pb + parseInt(values[attr]) : 8 + pb;
        dc = mod;
      }
      const id = SheetUtils.getUID(eventinfo.sourceAttribute);
      const update = {};
      update[`repeating_spell-${spellLevel}_${id}_roll_output_dc`] = dc;
      setAttrs(update);
    }
  );
};
globalAttributesByCategory.spellLevels.forEach((level) => {
  on(`change:repeating_spell-${level}:spell_ability`, (eventinfo) => {
    updateSpellOutputDC(eventinfo);
  });
});


on(`change:level`, (eventInfo) => {
  const level = +eventInfo.newValue;
  const profBonus = Math.floor(2 + (level - 1) / 4 );
  setAttrs({ pb: profBonus });
});


on("clicked:move-reset", () => {
  getAttrs(["moves_total"], v => {
    setAttrs({moves_expended: v.moves_total || 0})
  });
});

on("clicked:move-use", () => {
  getAttrs(["moves_expended"], v => {
    setAttrs({moves_expended: parseInt(v.moves_expended) - 1 || 0})
  });
});

[1,2,3].forEach(level => {
  on(`clicked:spell-reset-${level}`, () => {
    getAttrs([`lvl${level}_slots_total`], v => setAttrs({[`lvl${level}_slots_expended`]: v[`lvl${level}_slots_total`] || 0}));
  })
  on(`clicked:spell-use-${level}`, () => {
    getAttrs([`lvl${level}_slots_expended`], v => setAttrs({[`lvl${level}_slots_expended`]: parseInt(v[`lvl${level}_slots_expended`]) - 1|| 0}));
  })
})
  class RepeatingFieldset {
  constructor(groupname, id) {
    this.groupname = groupname;
    this.reprowid = id || generateRowID();
  }

  buildRowName() {
    return `repeating_${this.groupname}_${this.reprowid}`
  }

  addAttribute(attributesibuteName) {
    return `${this.buildRowName()}_${attributesibuteName}`
  }
}

class Attack extends RepeatingFieldset {
  constructor(name, id) {
    super('attack', id)
    this.attributes = {
      atkname: name,
      atkbonus: '', //Part of button display
      atkdmgtype: '', //Part of button display
      atkflag: '{{attack=1}}',
      atkattr_base: '@{strength_mod}',
      atkrange: '',
      atkmagic: '',
      atkcritrange: 20,
      dmgflag: '{{damage=1}} {{dmg1flag=1}}',
      dmgbase: '',
      dmgattr: '@{strength_mod}',
      dmgmod: '',
      dmgtype: '',
      dmgcustcrit: '',
      dmg2flag: 0,
      dmg2base: '',
      dmg2attr: 0,
      dmg2mod: '',
      dmg2type: '',
      dmg2custcrit: '',
      saveflag: 0,
      saveattr: 'Strength',
      savedc: '(@{spell_save_dc})',
      saveflat: '',
      saveeffect: '',
      atk_desc: '',
      "options-flag": 0,
    }
  }

  addSaveFlag() {
    this.attributes.saveflag = '{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}'
  }

  checkFinesse(strenght, dexterity) {
    const strengthGreaterThanDex = strenght > dexterity;
    this.attributes.dmgattr = strengthGreaterThanDex ? '@{strength_mod}' : '@{dexterity_mod}'
    this.attributes.atkattr_base = strengthGreaterThanDex ? '@{strength_mod}' : '@{dexterity_mod}'
  }
}

class GlobalACMod extends RepeatingFieldset {
  constructor(name, id) {
    super('acmod', id)
    name,
    this.attributes = {
      global_ac_name: name,
      global_ac_val: '',
      global_ac_active_flag: 0,
      "options-flag": 0,
    }
  }
}

class GlobalDamage extends RepeatingFieldset {
  constructor(name, id) {
    super('damagemod', id)
    name,
    this.attributes = {
      global_damage_name: name,
      global_damage_damage: '',
      global_damage_type: '',
      global_damage_active_flag: 0,
      "options-flag": 0
    }
  }
}

class GlobalSave extends RepeatingFieldset {
  constructor(name, id) {
    super('savemod', id)
    name,
    this.attributes = {
      global_save_name: name,
      global_save_roll: '',
      global_save_active_flag: 0,
      "options-flag": 0
    }
  }
}

class GlobalAttack extends RepeatingFieldset {
  constructor(name, id) {
    super('tohitmod', id)
    name,
    this.attributes = {
      global_attack_name: name,
      global_attack_roll: '',
      global_attack_rollstring: '',
      global_attack_active_flag: 0,
      "options-flag": 0
    }
  }

  addRoll(roll) {
     this.attributes.global_attack_roll = roll;
  }
}

class HPMod extends RepeatingFieldset {
  constructor(name, id) {
    super('hpmod', id)
    name,
    this.attributes = {
      mod: '',
      source: '',
      levels: 'total'
    }
  }
}

class Item extends RepeatingFieldset  {
  constructor(name, id) {
    super('inventory', id);
    name,
    this.attributes = {
      itemname: name,
      itemcount: 1,
      itemproperties: '',
      itemweight: 0,
      itemcontent: '',
      itemmodifiers: '',
      hasattack: 0,
      useasresource: 0
    }
  }
}

class Proficiency extends RepeatingFieldset {
  constructor(name, id) {
    super('proficiencies', id);
    this.attributes = {
        name,
        prof_type: 'OTHER',
        'options-flag': 0
    }
  }
}

class Resource extends RepeatingFieldset {
  constructor(name, id, side) {
    super('resource', id);
    this.side = side || 'left',
    this.attributes = {
      [`resource_${this.side}`]: '',
      [`resource_${this.side}_name`]: name,
      [`resource_${this.side}_max`]: '',
    }
  }
}

class Spell extends RepeatingFieldset {
  constructor(name, section, id) {
    super(section, id);
    this.attributes = {
      'details-flag': 0,
      'options-flag': 0,
      rollcontent: '',
      spell_ability: 'spell',
      innate: '',
      spell_damage_progression: '',
      spellathigherlevels: '',
      spellattack: '',
      spellcastingtime: '',
      spellclass: '',
      spellcomp_m: 0,
      spellcomp_materials: '',
      spellcomp_s: 0,
      spellcomp_v: 0,
      spellconcentration: '',
      spelldamage2: '',
      spelldamage: '',
      spelldamagetype2: '',
      spelldamagetype: '',
      spelldescription: '',
      spelldmgmod: '',
      spellduration: '',
      spellhealing: '',
      spellhlbonus: '',
      spellhldie: '',
      spellhldietype: '',
      spelllevel: 'cantrip',
      spellname: name,
      spelloutput: 'SPELLCARD',
      spellrange: '',
      spellritual: '',
      spellsave: '',
      spellsavesuccess: '',
      spellschool: 'abjuration',
      spellsource: '',
      spelltarget: ''
    }
  }
}

class Trait extends RepeatingFieldset {
  constructor(name, id) {
    super('traits', id);
    this.attributes = {
      name,
      description: '',
      source_type: '',
      source: '',
      edit: "0",
      display_flag: 'on'
    };
  }

  determineSource(category) {
    switch (category) {
        case "Backgrounds":
        case "Feats":
          return category.slice(0, -1)
          break;
        case "Races":
        case "Subraces":
          return "Racial"
          break;
        case "Classes":
        case "Subclasses":
          return "Class"
          break;
        default:
          return "Other"
    } 
  }
}

class ToolProficiency extends RepeatingFieldset {
  constructor(name, id) {
    super('tool', id);
    this.attributes = {
      toolname: name,
      toolbonus_base: '(@{pb})',
      toolattr_base: '?{Attribute?|Strength,@{strength_mod}|Dexterity,@{dexterity_mod}|Constitution,@{constitution_mod}|Intelligence,@{intelligence_mod}|Wisdom,@{wisdom_mod}|Charisma,@{charisma_mod}}',
      'options-flag': 0
    }
  }
}

//========== Non-Repeating

class Class {
  constructor(name) {
    name,
    this.attributes = {
        class: this.validateClassName(name) ? name : '',
        base_level: 1,
        hit_dice_max: 1,
        hit_dice: 1,
        hitdietype: 4,
        spellcasting_ability: '0*'
    }
  }

  validateClassName(name) {
    return globalAttributesByCategory.classes.includes(name.toLowerCase()) ? true : false;
  }

  buildSpellcastingAbility(attributeName) {
    return `@{${attributeName}_mod}+`
  }
}

class CustomAC {
  constructor(name) {
    name,
    this.attributes = {
      custom_ac_flag: 1,
      custom_ac_base: 10,
      custom_ac_part1: 'none',
      custom_ac_part2: 'none',
      custom_ac_shield: 'yes'
    }
  }
}

class Race {
  constructor(name) {
    name,
    this.attributes = {
      race: name,
      speed: 30,
      size: 'Medium',
      halflingluck_flag: this.checkHalfling(name) ? 1 : 0 
    }
  }

  checkHalfling(name) {
    return name === 'Halfling' ? true : false
  }
}

class Subrace {
  constructor(name) {
    name,
    this.attributes = {
      subrace: name
    }
  }
}

class SavingThrow {
  constructor(name) {
    name,
    this.attributes = {
        [`${this.attributesName(name)}_save_prof`]: `(@{pb})`
    }
  }

  attributesName(name) {
    return name.toLowerCase()
  }
}

class Skill {
  constructor(name) {
    name,
    this.attributes = {
        [`${this.attributesName(name)}_prof`]: `(@{pb}*@{${this.attributesName(name)}_type})`
    }
  }

  attributesName(name) {
    return name.toLowerCase().replace(/ /g, '_')
  }
}

class Subclass {
  constructor(name) {
    name,
    this.attributes = {
      subclass: name,
      arcane_fighter: 0,
      arcane_rogue: 0
    }
  }

  checkArcane(className) {
    return className === 'fighter' || className === 'rogue' ? true : false
  }

  buildSpellcastingAbility(attributeName) {
    return `@{${attributeName}_mod}+`
  }
}

//========== NPC AKA MONSTERS

class Npc  {
  constructor(name) {
    name,
    this.attributes = {
        npc_name: name,
        strength_base: 10,
        dexterity_base: 10,
        constitution_base: 10,
        intelligence_base: 10,
        wisdom_base: 10,
        charisma_base: 10,
        npc_condition_immunities: '',
        npc_immunities: '',
        npc_resistances: '',
        npc_languages: '',
        npc_speed: '',
        token_size: 1,
        npc_vulnerabilities: '',
        npc_challenge: '',
        npc_senses: '',
        npc_type: '',
        npc_ac: '',
        npc_actype: '',
        hp_max: '',
        npc_hpformula: '',
        npc_xp: '',
        npc_legendary_actions: 0,
        npc_legendary_actions_desc: '',
        npc_mythic_actions: 0,
        npc_mythic_actions_desc: '',
        npc: 1,
        'npc_options-flag': 0,
        npcreactionsflag: 0,
        npcspellcastingflag: 0,
        spellcasting_ability: '0*',
        globalmagicmod: 0,
        caster_level: 0,
        spell_dc_mod: 0
    }
  }

  addSkills(list) {
    list.forEach(value => this.attributes[`npc_${value.replace(/ /g, '_')}_base`] = "")
  }

  addSaves(list) {
    list.forEach(value => this.attributes[`npc_${value.slice(0, 3)}_save_base`] = "")
  }

  addSpellcaster(ability, casterLevels) {
    const spellcastrAttributes = {
      npcspellcastingflag: 1,
      base_level: casterLevels || 1,
      caster_level: casterLevels || 1,
      class: 'Wizard',
      level: casterLevels || 1,
      spellcasting_ability: ability
    }

    Object.assign(this.attributes, spellcastrAttributes);
  }

  addInnateCaster() {
    this.attributes.npcspellcastingflag = 1
  }
}

class NpcAction extends RepeatingFieldset {
  constructor(name, section, id) {
    super(section, id);
    name,
    this.attributes = {
      name,
      description: '',
      edit: "0",
    }
  }

  addAttack() {
    const attackAttributes = {
      attack_flag: 'on',
      attack_display_flag: '{{attack=1}}',
      attack_options: '{{attack=1}}',
      attack_type: '',
      attack_target: 'one target',
      attack_range: '5 ft',
      attack_tohit: '',
      attack_damage: '',
      attack_damagetype: '',
      attack_damage2: '',
      attack_damagetype2: ''
    }

    Object.assign(this.attributes, attackAttributes);
  }
}

class NpcReaction extends RepeatingFieldset {
  constructor(name, id) {
    super('npcreaction', id)
    name,
    this.attributes = {
      name,
      edit: "0",
      description: ''
    }
  }
}

class NpcTraits extends RepeatingFieldset {
  constructor(name, id) {
    super('npctrait', id)
    name,
    this.attributes = {
      name,
      edit_trait: "0",
      description: ''
    }
  }
}
  const dropFunctions = {
    validateCantripScaling: scaling => scaling === 'dice' || scaling === 'beam' ? true : false,
    buildCantripScaling: scaling => `Cantrip ${scaling.charAt(0).toUpperCase()}${scaling.slice(1)}`,
    
    buildDamage: (page, currentData, alternateDamage) => {
        try {
            const modifiers = dropFunctions.inferAbilityModifier(page.data["Item Type"], page.data["Properties"], currentData)
            let damage = alternateDamage ? alternateDamage : page.data[`Damage`];
            damage += modifiers && modifiers != 0 ? `+${modifiers}` : ""
            damage += page.data["Modifiers"] ? dropFunctions.inferModifier(page.data["Modifiers"], 'damage') : ""
    
            return damage
        } catch (error) {
            console.error(error)
            return ''
        }
    },

    buildItemModString: page => {
        try {
            let mods = `Item Type: ${page.data["Item Type"] || page.data["Category"]}`;

            //Items with ac or attack related bonuses
            ["AC", "Damage", "Damage Type", "Secondary Damage", "Secondary Damage Type", "Alternate Damage", "Alternate Damage Type", "Alternate Secondary Damage", "Alternate Secondary Damage Type", "Critical Range", "Range"].forEach(attr => {
                mods += page.data[`${attr}`] && page.data[`${attr}`] != "" ? `, ${attr}: ${page.data[`${attr}`]}` : "";
                });

            //Items with modifiers such as Cloak of Protection
                mods += page.data["Modifiers"] && page.data["Modifiers"] != "" ? `, ${page.data["Modifiers"]}` : "";

            return mods   
        } catch (error) {
            console.error(error)
            return ''
        }
    },

    buildSpellQuery: spellLevel => {
        try {
            let spellQuery = ""
            for(i = 0; i < 10-spellLevel; i++) {
                const sum = (parseInt(i, 10) + parseInt(spellLevel, 10))
                spellQuery += `|Level ${sum},${sum}`
            };
    
            return `@{wtype}&{template:spell} {{level=@{spellschool} ?{Cast at what level?${spellQuery}}}} {{name=@{spellname}}} {{castingtime=@{spellcastingtime}}} {{range=@{spellrange}}} {{target=@{spelltarget}}} @{spellcomp_v} @{spellcomp_s} @{spellcomp_m} {{material=@{spellcomp_materials}}} {{duration=@{spellduration}}} {{description=@{spelldescription}}} {{athigherlevels=@{spellathigherlevels}}} @{spellritual} {{innate=@{innate}}} @{spellconcentration} @{charname_output}`
        } catch (error) {
            console.error(error)
        }
    },

    buildToHit: (page, currentData) => {
        try {
            let hit = dropFunctions.inferAbilityModifier(page.data["Item Type"], page.data["Properties"], currentData);
            hit += page.data["Modifiers"] ? dropFunctions.inferModifier(page.data["Modifiers"], 'attacks') : "";
            return hit
        } catch (error) {
            console.error(error)
            return ''
        }
    },

    buildSenses: (senses, passivePerception) => {
        try {
            return senses ? `${senses}, passive Perception ${passivePerception}` : `passive Perception ${passivePerception}`;
        } catch (error) {
            console.log(error)
            return ''
        }
    },

    buildSpellList: spells => {
        try {
            let spellList = []
            //Create an array of spells to get from the Comepndium
            const spellTypes = ["spells", "innate"]
            spellTypes.forEach(type => {
                const spellObject = dropFunctions.jsonParse(spells)[type]
                if (spellObject) {
                    for (let [key, value] of Object.entries(spellObject)) {
                        value.forEach(spell => spellList.push(spell))
                    }
                }
            })
            return spellList
        } catch (error) {
            console.log(error)
        }
    },

    buildType: (size, type, aligment) => {
        let string = size || "";
        type ? string += ` ${type}` : false;
        aligment ? string += `, ${aligment}`: false;
        return string
    },

    confirmFinesse: properties => properties.toLowerCase().includes("finesse") ? true : false,
    confirmRanged: itemType => itemType.toLowerCase().includes("ranged") ? true : false,
    confirmDexGreaterThanStr: (dex, str) => dex > str ? true : false,

    convertAbbreviationToAttribute: threeLetterString => {
        switch(threeLetterString.toLowerCase()) {
            case "str":
                return "@{strength_mod}";
                break;
            case "dex":
                return "@{dexterity_mod}";
                break;
            case "con":
                return "@{constitution_mod}";
                break;
            case "wis":
                return "@{wisdom_mod}";
                break;
            case "int":
                return "@{intelligence_mod}";
                break;
            case "cha":
                return "@{charisma_mod}";
                break;
            default:
                errorMessage("convertAbbreviationToAttribute", `${threeLetterString} did not match one of the expected types str, dex, con, wis, int, cha`)
                return false
        }           
    },

    determineComponent: (componentList, component) => componentList.toLowerCase().includes(component) ? `{{${component}=1}}` : false,

    inferAbilityModifier: (type, properties, currentData) => {
        try {
            const ranged = type ? dropFunctions.confirmRanged(type) : false;
            const finesse = properties ? dropFunctions.confirmFinesse(properties) : false;
            const dexGreaterThanStr = dropFunctions.confirmDexGreaterThanStr(currentData.dexterity_mod, currentData.strength_mod);
    
            return ranged || (finesse && dexGreaterThanStr) ? currentData.dexterity_mod : currentData.strength_mod
        } catch (error) {
            console.log(error)
        }
    },

    inferBaseAttribute: attribute => attribute.includes('(') ? attribute.split(" (")[0] : attribute,

    inferCasterLevel: description => parseInt(description.substring(description.indexOf("-level")-4, description.indexOf("-level")-2).trim(), 10) || 1,

    inferFormulaAttribute: attribute => attribute.includes('(') ? attribute.split(" (")[1].slice(0, -1) : "",

    inferModifier: (modifiers, type) => {
        try {
            let modifier = "";
            modifiers = modifiers.split(',');
            modifiers.forEach(value => {
                modifier += value.toLowerCase().includes(type) ? value.split(' ').pop() : ""
            });
            return modifier
        } catch (error) {
            console.log(error)
            return ''
        }
    },

    inferSpellcastingAbility: description => {
        let ability = description.match(/casting ability is (.*?) /);
        ability = ability && ability.length > 1 ? ability[1] : false;
        ability = ability ? `@{${ability.toLowerCase()}_mod}+` : "0*";
        return ability
    },

    inferSavingThrows: saves => {
        try {
            let object = {};
            if (saves) {
            saves = saves.includes(', ') ? saves.split(", ") : [saves]
            saves.forEach(saveValue => {
                    const split = saveValue.includes(' ') ? saveValue.split(' ') : errorMessage(`inferSavingThrows`, `${saveValue} does no include a space`)
                    const abbreviation = split[0].toLowerCase();
                    object[`npc_${abbreviation}_save_base`] = split.pop();
            });
            }
            return object
        } catch (error) {
            errorMessage('inferSavingThrows', error)
        }
    },

    inferSkills: skills => {
        try {
            let object = {};
            if (skills) {
               skills = skills.includes(', ') ? skills.split(", ") : [skills]
               skills.forEach(skillValue => {
                    const split = skillValue.includes(' ') ? skillValue.split(' ') : errorMessage(`inferSkills`, `${skillValue} does no include a space`)
                    const value = split.pop();
                    const name = split.length > 2 ? split.join("_").toLowerCase() : split.shift().toLowerCase();
                    object[`npc_${name}_base`] = value;
               });
            }
            return object
        } catch (error) {
            errorMessage('inferSkills', error)
        }
    },

    jsonParse: (data, defaultValue) => { 
        let result = null;
        try {
            result = JSON.parse(data);
        } catch (error) {
            switch(typeof defaultValue) {
                case 'boolean':
                case 'number':
                case 'string':
                case 'function':
                    result = (typeof data === typeof defaultValue) ? data : defaultValue;
                    break;
                case 'object':
                    result = (typeof data === typeof defaultValue && data.constructor.name === defaultValue.constructor.name) ? data : defaultValue;
                    break;
                default:
                    errorMessage('Invalid JSON', error);
            }
        }
        return result;
    },

    updateSheetAttributes: newObjectForSheet => {
        try {
            let update = {};

            for (let [key, value] of Object.entries(newObjectForSheet.attributes)) {
                //If repeating section, update key needs the repeating information
                const updateKey = newObjectForSheet.reprowid ? newObjectForSheet.addAttribute(key) : key;

                //This 'update' will be handed to a setAttrs function
                update[updateKey] = newObjectForSheet.attributes[key];
            }

            return update
        } catch (error) {
            errorMessage(`updateSheetAttributes`, error);
        }
    }
}

//These functions handle 'repeating' parameter of processDrop
const dropHelpers = {
    findToolId: (repeatingTools, toolName) => {
        let id = false
        for(let [key, value] of Object.entries(repeatingTools)) {
            value.toolname === toolName.toLowerCase() ? id = key : false;
        }
        return id
    },
    updateRepeatingTools: (newTool, existingTool) => {
        existingTool.id  = newTool.reprowid
        existingTool.toolname = newTool.attributes.toolname.toLowerCase()
        existingTool.base = newTool.attributes.toolbonus_base
        return existingTool
    },
    updateRepeatingTraits: (newTrait, existingTrait) => {
        existingTrait.id     = newTrait.reprowid;
        existingTrait.name   = newTrait.attributes.name;
        existingTrait.source = newTrait.attributes.source;
        existingTrait.type   = newTrait.attributes.source_type;

        return existingTrait
    }
}
  const filterBlobs = function(blobs, filters) {
    var remove = filters.multiclass ? "no" : "yes";
    var results = {};
    delete filters.multiclass;
    delete filters.slide;
    _.each(blobs, function(blob, name) {
        var match = true;
        if(blob.Group && !filters.Group && !filters.name) match = false;
        _.each(filters, function(v, k) {
            if(k == "name") {
                if(name != v) match = false;
            } else if(v[0] === "<" && !isNaN(parseInt(v.substring(1)))) {
                let blobval = isNaN(parseInt(blob[k])) ? 0 : parseInt(blob[k]);
                if(blobval > parseInt(v.substring(1))) match = false;
            } else {
                if(blob[k] != v) match = false;
            }
        });
        if(match && name.split("(")[0].toLowerCase() != "spell slots") results[name] = blob;
    });
    _.each(results, function(blob, name) {
        if(blob.Multiclass == remove) {
            delete results[name];
        }
    });
    return results;
};

on("change:drop_name", function(eventinfo) {
    if(eventinfo.newValue === "Monsters") {
        getAttrs(["class","race","speed","hp"], function(v) {
            if(v["class"] != "" || v["race"] != "" || v["speed"] != "" || v["hp"] != "") {
                setAttrs({monster_confirm_flag: 1});
            }
            else {
                handle_drop(eventinfo.newValue);
            }
        });
    }
    else {
        handle_drop(eventinfo.newValue);
    }
});

var handle_drop = function(category, eventinfo) {
    getAttrs(["speed", "hp_max", "hp", "drop_name", "drop_data", "drop_content", "character_id", "npc_legendary_actions", "strength_mod", "dexterity_mod", "npc", "base_level", "strength_base", "dexterity_base", "constitution_base", "wisdom_base", "intelligence_base", "charisma_base", "class_resource_name", "other_resource_name", "multiclass1_lvl", "multiclass2_lvl", "multiclass3_lvl"], function(v) {
        var pagedata = {};
        try {
            pagedata = JSON.parse(v.drop_data);
        } catch(e) {
            pagedata = v.drop_data;
        }
        var page = {
            name: v.drop_name,
            data: pagedata,
            content: v.drop_content
        };
        var category = page.data["Category"];
        get_repeating_data(function(repeating) {
            var results = processDrop(page, v, repeating);
            setAttrs(results.update, {silent: true}, function() {results.callbacks.forEach(function(callback) {callback(); })} );
        });

    });

};

var processDrop = function(page, currentData, repeating, looped) {
    var numUses = function(uses_string) {
        uses_string = parseValues(uses_string);

        var terms = uses_string.split("+");
        var total = 0;
        _.each(terms, function(term) {
            total += parseInt(term);
        });
        return uses_string === "" || uses_string === "-" ? uses_string : total;
    };
    var parseValues = function(uses_string) {
        var attribs = ["strength", "dexterity", "constitution", "wisdom", "intelligence", "charisma"];
        uses_string = uses_string ? uses_string.toLowerCase() : "";
        _.each(attribs, function(attrib) {
            var attribMod = Math.floor((parseInt(currentData[attrib + "_base"]) - 10) / 2);
            if (attribMod < 0 || isNaN(attribMod)) attribMod = 0;
            uses_string = uses_string.replace(attrib, attribMod);
        });
        uses_string = uses_string.replace(/half_level/g, Math.floor(classlevel/2));
        return uses_string.replace(/level/g, classlevel);
    };
    const category = page.data["Category"];
    let callbacks = [];
    let update = {};
    let blobs = {};
    let classlevel = currentData.base_level ? parseInt(currentData.base_level) : 1;
    repeating.traits = repeating.traits ? repeating.traits : [];
    ["drop_category", "drop_name", "drop_data", "drop_content"].forEach(attr => update[attr] = "");

    const coreDrops = ['Classes', 'Backgrounds', 'Feats', 'Items', 'Proficiencies', 'Races', 'Subraces', 'Other Options and Features'];
    if (coreDrops.includes(category)) {
        update["tab"] = "core";
    }

    const assignUpdate = newData => Object.assign(update, newData);

    const processItems = () => {
        try {
            const itemType = page.data["Item Type"] ? page.data["Item Type"] : category;
            const npc = currentData.npc === "0" ? false : true;

            if (!npc) {
                let newObject = new Item(page.name)

                page.data["itemcount"] ? newObject.attributes.itemcount = page.data["itemcount"] : false;

                ["Properties", "Weight"].forEach(attribute => {
                    const attributeLowercase = attribute.toLowerCase();
                    page.data[`${attribute}`] ? newObject.attributes[`item${attributeLowercase}`] = page.data[`${attribute}`] : false
                });

                page.content ? newObject.attributes.itemcontent = page.content : false;

                newObject.attributes.itemmodifiers = dropFunctions.buildItemModString(page)

                //ATTACK items such as Weapons
                itemType.toLowerCase().includes('weapon') ? newObject.attributes.hasattack = 1 : false;

                if (page.data.AC && !looped) {
                    callbacks.push(() => update_ac() );
                }

                if (page.data.Modifiers && page.data.Modifiers != "") { 
                    callbacks.push(() => { 
                        check_itemmodifiers(page.data.Modifiers); 
                    });
                };

                //Create attacks for weapons. Create two attacks for versatile weapons such as Longsword.
                if (newObject.attributes.hasattack === 1) {
                    callbacks.push(() => {
                        page.data["Alternate Damage"] && page.data["Alternate Damage"] !== "" ? create_attack_from_item(newObject.reprowid, {versatile: true}) : create_attack_from_item(newObject.reprowid);
                    });
                }

                if (itemType.toLowerCase() === "ammunition") {
                    newObject.attributes.useasresource = 1
                    callbacks.push(() => { 
                        create_resource_from_item(newObject.reprowid); 
                    });
                }

                if (!looped) {
                    callbacks.push(() => { 
                        update_weight(); 
                    });
                }

                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            } else if (npc && itemType.toLowerCase().includes("weapon")) {
                const properties = page.data["Properties"] ? page.data["Properties"].toLowerCase() : "none";
                let newObject = new NpcAction(page.name, 'npcaction')
                newObject.addAttack()

                page.data['Item Type'] ? newObject.attributes.attack_type = page.data['Item Type'] : false;
                page.content ? newObject.attributes.description = page.content :  false;

                newObject.attributes.attack_tohit = dropFunctions.buildToHit(page, currentData)

                const damageModifiers = dropFunctions.inferAbilityModifier(page.data["Item Type"], page.data["Properties"], currentData)
                newObject.attributes.attack_damage = dropFunctions.buildDamage(page, damageModifiers)
                page.data["Damage Type"] ? newObject.attributes.attack_damagetype = page.data["Damage Type"] : false;
                page.data["Secondary Damage"] && !page.name.includes('+') ? newObject.attributes.attack_damage2 = page.data["Secondary Damage"] : false;
                page.data["Secondary Damage Type"] && !page.name.includes('+') ? newObject.attributes.attack_damagetype2 = page.data["Secondary Damage Type"] : false;

                properties.includes("versatile") ? newObject.attributes.name = `${newObject.attributes.name} (One-Handed)` : false

                assignUpdate(dropFunctions.updateSheetAttributes(newObject));

                //Versatile creates two attacks
                if (properties.includes("versatile") && (page.data["Alternate Damage"] || page.data["Secondary Damage"])) {
                    let alternateAttack = new NpcAction(`${page.name} (Two-Handed)`, 'npcaction');
                    alternateAttack.addAttack()
                    alternateAttack.attributes.attack_type = newObject.attributes.attack_type;
                    alternateAttack.attributes.description = newObject.attributes.description;

                    if (page.data["Alternate Damage"]) {
                        alternateAttack.attributes.attack_damage = dropFunctions.buildDamage(page, damageModifiers, page.data["Alternate Damage"])
                        page.data["Alternate Damage Type"] ? alternateAttack.attributes.attack_damagetype = page.data["Alternate Damage Type"] : false;
                        page.data["Alternate Secondary Damage"] ? alternateAttack.attributes.attack_damage2 = page.data["Alternate Secondary Damage"] : false;
                        page.data["Alternate Secondary Damage Type"] ? alternateAttack.attributes.attack_damagetype2 = page.data["Alternate Secondary Damage Type"] : false;
                    } else {
                         alternateAttack.attributes.attack_damage = dropFunctions.buildDamage(page, damageModifiers, page.data["Secondary Damage"])
                    }
                
                    assignUpdate(dropFunctions.updateSheetAttributes(alternateAttack));
                }

                if (properties.includes("thrown")) { 
                    let thrownAttack = new NpcAction(`${page.name} (Thrown)`, 'npcaction');
                    thrownAttack.addAttack()
                    page.data["Range"] ? thrownAttack.attributes.attack_range = page.data["Range"] : false;
                    thrownAttack.attributes.attack_type = "Range Weapon";

                    ['description', 'attack_tohit', 'attack_damage', 'attack_damagetype', 'attack_damage2', 'attack_damagetype2'].forEach(attr => {
                        thrownAttack.attributes[`${attr}`] = newObject.attributes[`${attr}`]
                    })

                    assignUpdate(dropFunctions.updateSheetAttributes(thrownAttack));
                }

                if (page.data.Modifiers) {
                    callbacks.push(() => { check_itemmodifiers(page.data.Modifiers);  }, () => { update_npc_action("all"); });
                } else {
                    callbacks.push(() => { update_npc_action("all"); });
                };
            } else {
                warningMessage('processItems', `Only weapon drops are supported for npcs. For npcs, "Item Type" in the Compendium must include the word "weapon".`);
            }
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processSpells = () => {
        try {
            if(page.name) {
                const spellLevel = page.data["Level"] && page.data["Level"] > 0 ? page.data["Level"] : "cantrip";
                const section = `spell-${spellLevel}`
                let existing = {id: false}; 

                for (let [key, value] of Object.entries(repeating[`${section}`])) {
                    value.spellname === page.name ? existing.spellattackid = value.spellattackid : false;
                    value.spellname === page.name ? existing.id = key: false;
                    if(value.spellname === page.name) {
                        ['spellsource', 'innate'].forEach(attributeToKeep => {
                            if(repeating[`${section}`][key][attributeToKeep]) existing[attributeToKeep] = repeating[`${section}`][key][attributeToKeep];
                        });
                    }
                }
    
    
                let newObject = new Spell(page.name, section, existing.id);
                newObject.attributes.spelllevel = spellLevel;
    
                const dropSheetAssocitation = {
                    spelldescription: page.data['data-description'],
                    spellschool: page.data['School'].toLowerCase(),
                    spellclass: page.data['spellclass'],
                    spellsource: (existing.spellsource) ? existing.spellsource : page.data['spellsource'],
                    spellritual: page.data['Ritual'],
                    spelldmgmod: page.data['Add Casting Modifier'],
                    spellcomp_materials: page.data['Material'],
                    spelldamage2: page.data['Secondary Damage'],
                    spellcastingtime: page.data['Casting Time'],
                    spelldamagetype: page.data['Damage Type'],
                    spelldamage: page.data['Damage'],
                    spellduration: page.data['Duration'],
                    spellhealing: page.data['Healing'],
                    spellrange: page.data['Range'],
                    spellsave: page.data['Save'],
                    spellsavesuccess: page.data['Save Success'],
                    spelldamagetype2: page.data['Secondary Damage Type'],
                    spelltarget: page.data['Target'],
                    spellhlbonus: page.data['Higher Spell Slot Bonus'],
                    spellathigherlevels: page.data['Higher Spell Slot Desc'],
                    spellhldie: page.data['Higher Spell Slot Dice'],
                    spellhldietype: page.data['Higher Spell Slot Die'],
                    spellattack: page.data['Spell Attack']
                }
    
                for (let [key, value] of Object.entries(dropSheetAssocitation)) {
                    value ? newObject.attributes[`${key}`] = value : false;
                }
    
                page.data['Spellcasting Ability'] ? newObject.attributes.spell_ability = `@{${page.data['Spellcasting Ability'].toLowerCase()}_mod}+` : false;
                page.data['Concentration'] ? newObject.attributes.spellconcentration  = '{{concentration=1}}' : false;
                if(existing.innate) {
                    newObject.attributes.innate  = existing.innate;
                } else {
                    page.data['Innate'] ? newObject.attributes.innate  = page.data['Innate'] : false;
                }
    
                if (page.data['Components']) {
                    ['v', 's', 'm'].forEach(component => {
                        const componentCheck = dropFunctions.determineComponent(page.data['Components'], component)
                        newObject.attributes[`spellcomp_${component}`] = componentCheck ? componentCheck : 0;
                    })
                }
    
                if (page.data['Damage'] || page.data['Healing']) {
                    newObject.attributes.spelloutput = 'ATTACK'
    
                    callbacks.push(() => {
                        create_attack_from_spell(spellLevel, newObject.reprowid, currentData.character_id, existing.spellattackid);
                    });
                }
    
    
                if (newObject.attributes.spelloutput != 'ATTACK' && page.data['Higher Spell Slot Desc']) {
                    newObject.attributes.rollcontent = dropFunctions.buildSpellQuery(page.data['Level']);
                }
    
                //Character sheet accepts 'dice', 'beam', or none
                if (page.data['data-Cantrip Scaling']) {
                    const validateCantripScaling = dropFunctions.validateCantripScaling(page.data['data-Cantrip Scaling'])
                    if (validateCantripScaling) {
                        newObject.attributes.spell_damage_progression = dropFunctions.buildCantripScaling(page.data['data-Cantrip Scaling'])
                    } else {
                        newObject.attributes.spell_damage_progression = ''
                    }
                }
                const assignedRowID = (newObject.reprowid) ? newObject.reprowid : generateRowID();
                repeating[`${section}`][assignedRowID] = { spellname: page.name };
                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            }
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processMonsters = () => {
        try {
            let newObject = new Npc(page.name);
            newObject.addSkills(globalAttributesByCategory.skills.all())
            newObject.addSaves(globalAttributesByCategory.abilities)

            globalAttributesByCategory.abilities.forEach(ability => {
                const abbreviation = ability.slice(0, 3).toUpperCase();
                page.data[`${abbreviation}`] ? newObject.attributes[`${ability}_base`] = page.data[`${abbreviation}`] : false;
                callbacks.push(() => {
                    update_attr(`${ability}`);
                });
            });

            const dropSheetAssocitation = {
                token_size: page.data["Token Size"],
                npc_condition_immunities: page.data["Condition Immunities"],
                npc_immunities: page.data["Immunities"],
                npc_languages: page.data["Languages"],
                npc_vulnerabilities: page.data["Vulnerabilities"],
                npc_resistances: page.data["Resistances"],
                npc_speed: page.data["Speed"],
                npc_challenge: page.data["Challenge Rating"],
            }

            for (let [key, value] of Object.entries(dropSheetAssocitation)) {
                value ? newObject.attributes[`${key}`] = value : false;
            }

            page.data["data-XP"] ? newObject.attributes.npc_xp = page.data["data-XP"].toString().replace(",","") : false

            Object.assign(newObject.attributes, dropFunctions.inferSavingThrows(page.data['Saving Throws']))
            Object.assign(newObject.attributes, dropFunctions.inferSkills(page.data['Skills']))            

            newObject.attributes.npc_type = dropFunctions.buildType(page.data["Size"], page.data["Type"], page.data["Alignment"])

            newObject.attributes.npc_senses = dropFunctions.buildSenses(page.data['Senses'], page.data['Passive Perception'])

            page.data['AC'] ? newObject.attributes.npc_ac = dropFunctions.inferBaseAttribute(page.data['AC']) : false;
            page.data['AC'] ? newObject.attributes.npc_actype = dropFunctions.inferFormulaAttribute(page.data['AC']) : false;

            page.data['HP'] ? newObject.attributes.hp_max = dropFunctions.inferBaseAttribute(page.data['HP']) : false;
            page.data['HP'] ? newObject.attributes.npc_hpformula = dropFunctions.inferFormulaAttribute(page.data['HP']) : false;

            const npcRepeating = ['npcaction-l', 'npcreaction', 'npcaction', 'npctrait'];
            _.each(npcRepeating, section => {
                getSectionIDs(`repeating_${section}`, idarray => {
                    _.each(idarray, (currentID, i) => {
                        removeRepeatingRow(`repeating_${section}_${currentID}`);
                    });
                });
            });

            if (page.data["data-Legendary Actions"]) {
                const actionCount = page.data["data-LANum"] ? page.data["data-LANum"] : 3;
                newObject.attributes.npc_legendary_actions = actionCount

                if (page.data["Legendary Actions Desc"]) {
                     newObject.attributes.npc_legendary_actions_desc = page.data["Legendary Actions Desc"];
                } else {
                    newObject.attributes.npc_legendary_actions_desc = `The ${page.name} can take ${actionCount}, choosing from the options below. Only one legendary option can be used at a time and only at the end of another creature's turn. The ${page.name} regains spent legendary actions at the start of its turn.`
                }
            }

            if (page.data["data-Mythic Actions"]) {
                newObject.attributes.npc_mythic_actions = 1

                if (page.data["data-MAdesc"]) {
                     newObject.attributes.npc_mythic_actions_desc = page.data["data-MAdesc"];
                } else {
                    //TODO UC1098
                    newObject.attributes.npc_legendary_actions_desc = ``;
                }
            }

            ["Actions", "Legendary Actions", "Mythic Actions"].forEach(attr => {
                if (page.data[`data-${attr}`]) {
                    const fieldsetLookup = {
                        "Actions": "npcaction",
                        "Legendary Actions": "npcaction-l",
                        "Mythic Actions": "npcaction-m"
                    }
                    const repeatingFieldset = fieldsetLookup[attr];
                    const actions = dropFunctions.jsonParse(page.data[`data-${attr}`])
                    actions.forEach(action => {
                        let newAction = new NpcAction(action['Name'], repeatingFieldset);

                        action["Desc"] ? newAction.attributes.description = action["Desc"] : false;

                        if (action["Type Attack"]) {
                            newAction.addAttack()
                            const dropSheetAttackAssocitation = {
                                attack_damagetype: action['Damage Type'],
                                attack_damage: action['Damage'],
                                attack_tohit: action['Hit Bonus'],
                                attack_range: action['Reach'],
                                attack_target: action['Target'],
                                attack_type: action['Type'],
                                attack_damage2: action['Damage 2'],
                                attack_damagetype2: action['Damage 2 Type']
                            }

                            for (let [key, value] of Object.entries(dropSheetAttackAssocitation)) {
                                value ? newAction.attributes[`${key}`] = value : false;
                            }
                        }

                        assignUpdate(dropFunctions.updateSheetAttributes(newAction));
                    });
                }
            });


            if (page.data["data-Reactions"]) {
                newObject.attributes.npcreactionsflag = 1
                const reactions = dropFunctions.jsonParse(page.data[`data-Reactions`])
                reactions.forEach(reaction => {
                    let newReaction = new NpcReaction(reaction['Name']);
                    reaction["Desc"] ? newReaction.attributes.description = reaction["Desc"] : false;
                    assignUpdate(dropFunctions.updateSheetAttributes(newReaction));
                })
            }

            if (page.data["data-Traits"]) {
                 const traits = dropFunctions.jsonParse(page.data[`data-Traits`])

                 traits.forEach(trait => {
                    let newTrait = new NpcTraits(trait['Name']);
                    trait["Desc"] ? newTrait.attributes.description = trait["Desc"] : false;

                    if (trait.Name.match(/(?!innate )(?:^.{0,6}|.{7})(spellcasting)/i)) {
                        let spellCastingAbility = page.data["Spellcasting Ability"];

                        if (spellCastingAbility) {
                            spellCastingAbility = `@{${spellCastingAbility.toLowerCase()}_mod}+`
                        } else {
                            spellCastingAbility = dropFunctions.inferSpellcastingAbility(newTrait.attributes.description)
                        }

                        const casterLevels = dropFunctions.inferCasterLevel(trait['Desc']);
                        newObject.addSpellcaster(spellCastingAbility, casterLevels)

                        callbacks.push(() => update_pb());
                        callbacks.push(() => update_spell_slots());
                    } else if (trait.Name.match(/innate spellcasting/i)) {
                        let spellCastingAbility = page.data["Spellcasting Ability"];
                        newObject.addInnateCaster()

                        spellCastingAbility ? newObject.attributes.spellcasting_ability = `@{${spellCastingAbility.toLowerCase()}_mod}+` : false;
                    }

                    assignUpdate(dropFunctions.updateSheetAttributes(newTrait));
                 })
            }

            if (page.data["data-Spells"]) {
                const spellList = dropFunctions.buildSpellList(page.data["data-Spells"]);
                getCompendiumPage(spellList, compendiumPages => {
                    compendiumPages = removeDuplicatedPageData(compendiumPages);
                    compendiumPages = Array.isArray(compendiumPages) ? compendiumPages : [compendiumPages];
                    const innateSpellLists = dropFunctions.jsonParse(page.data["data-Spells"])[`innate`] || false;
                    let spellUpdate = {}, spellCallbacks = [];

                    compendiumPages.forEach(spellPage => {
                       const processedSpell = processDrop(spellPage, currentData, repeating);
                       Object.assign(spellUpdate, processedSpell.update);
                       processedSpell.callbacks.forEach(callback => spellCallbacks.push(callback));
                    });

                    if (innateSpellLists) {
                        //Search each keys in INNATE to see if spell name === one of the Values
                        for (let [innateKey, innateValue] of Object.entries(innateSpellLists)) {
                            innateValue.forEach(spellName => {
                                for (let [key, value] of Object.entries(spellUpdate)) {
                                    if (key.includes('_spellname') && (value === spellName || value.toLowerCase() === spellName)) {
                                        const repeatingRow = key.split('_spellname')[0];
                                        spellUpdate[`${repeatingRow}_innate`] = innateKey
                                    }
                                }
                            });
                        };
                    };

                    setAttrs(spellUpdate, {silent: true}, () => {
                        spellCallbacks.forEach(callback => {
                            callback();
                        });
                    });
                });
            }

            //Call backs
            if (page.data["Saving Throws"]) {
                callbacks.push(() => update_npc_saves() );
            };

            if (page.data["Skills"]) {
                callbacks.push(() => update_npc_skills() );
            };

            if (page.data[`data-Actions`]) {
                callbacks.push(() =>  update_npc_action("all"))
            }

            if (update["npc_challenge"]) {
                callbacks.push(() => update_challenge() );
            };

            globalAttributesByCategory.abilities.forEach(ability => {
                callbacks.push(() => update_attr(`${ability}`) );
            });

            assignUpdate(dropFunctions.updateSheetAttributes(newObject));
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processFeats = () => {
        try {
            const match = {name: page.name};
            let existing = _.findWhere(repeating.traits, match);
            existing = existing ? existing : {}; 

            let newObject = new Trait(page.name, existing.id || false);
            newObject.attributes.description = page.data['data-Description'] || page.content
            newObject.attributes.source = newObject.determineSource(category)
            newObject.attributes.source_type = page.data["Properties"] || ""
            assignUpdate(dropFunctions.updateSheetAttributes(newObject));

            existing = dropHelpers.updateRepeatingTraits(newObject, existing)
            existing ? false : repeating.traits.push(existing);
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processProficiencies = () => {
        try {
            const proficiencies = globalAttributesByCategory.proficiencyTypes;
            const tools = ["tool", "skillcustom"];
            let type = page.data["Type"] || "";
            type = proficiencies.includes(type.toUpperCase()) ? 'proficiencies' : tools.includes(type.toLowerCase()) ? 'tool' : type.toLowerCase() === 'skill' ? 'skill' : false;

            if (type === 'proficiencies') {
                if (repeating.prof_names.indexOf(page.name.toLowerCase()) == -1) {
                    let newObject = new Proficiency(page.name)
                    proficiencies.includes(page.data["Type"].toUpperCase()) ? newObject.attributes.prof_type = page.data["Type"].toUpperCase() : false;
                    repeating.prof_names.push(page.name.toLowerCase());
                    assignUpdate(dropFunctions.updateSheetAttributes(newObject));
                }
            } else if (type === 'tool') {
                let existing = {id: false};
                existing.id = dropHelpers.findToolId(repeating.tool, page.name)

                let newObject = new ToolProficiency(page.name, existing.id)
                page.data["toolbonus_base"] ? newObject.attributes.toolbonus_base = "(@{pb}*2)" : false;
                assignUpdate(dropFunctions.updateSheetAttributes(newObject));

                existing = dropHelpers.updateRepeatingTools(newObject, existing)
                repeating.tool[newObject.reprowid] = existing
                repeating.prof_names.push(page.name.toLowerCase());

                //Updates the displays for the tool...
                callbacks.push(() => {
                    update_tool(newObject.reprowid);
                });
            } else if (type === 'skill') {
                let newObject = new Skill(page.name)
                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            } else {
                warningMessage(`${page.data["Type"]}`, `No an approved type. Accepted types are skill, ${proficiencies.concat(tools).join(' ,')}. Update compendium "Type".`);
            }
        } catch (error) {
            errorMessage(page.name, error);
        }      
    }

    const processClass = () => {
        try {
            if (page.data.multiclass) {
                if(page.name && page.name !== "") { update[page.data.multiclass] = page.name; }
                update[page.data.multiclass + "_flag"] = "1";
                classlevel = parseInt(currentData[page.data.multiclass + "_lvl"]);
            } else {
                let newObject = new Class(page.name);
     
                if (page.data["Hit Die"] && page.data["Hit Die"] !== "") {
                    currentData.base_level ? newObject.attributes.base_level = currentData.base_level : false;
                    newObject.attributes.hit_dice_max = newObject.attributes.base_level + page.data["Hit Die"];
                    newObject.attributes.hitdietype = page.data["Hit Die"].replace(/[^0-9]/g, '');
                    newObject.attributes.hit_dice = newObject.attributes.base_level;
                }

                const spellcastingAbility = page.data["Spellcasting Ability"] ? page.data["Spellcasting Ability"].toLowerCase() : false;
                if (spellcastingAbility && globalAttributesByCategory.abilities.includes(spellcastingAbility)) {
                    newObject.attributes.spellcasting_ability = newObject.buildSpellcastingAbility(spellcastingAbility);
                }

                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            }

            if (page.data["data-Saving Throws"] && !page.data.multiclass) {
                const saves = dropFunctions.jsonParse(page.data["data-Saving Throws"]);
                saves.forEach(value => {
                    const save = new SavingThrow(value);
                    assignUpdate(dropFunctions.updateSheetAttributes(save));
                });
            }

            if(!looped) {
                callbacks.push(update_class);
            }
        } catch (error) {
            errorMessage(page.name, error);
        }    
    }

    const processSubclasses = () => {
        try {
            const lowercaseClass = page.data.Class.toLowerCase();
            if (page.data.multiclass) {
                update[`${page.data.multiclass}_subclass`] = page.name;
                classlevel = parseInt(currentData[`${page.data.multiclass}_lvl`]);
                if (page.data["Spellcasting Ability"] && (lowercaseClass === 'fighter' || lowercaseClass === 'rogue')) {
                    update[`"arcane_${lowercaseClass}`] = "1";
                }
            } else {
                let newObject = new Subclass(page.name);
                const spellcastingAbility = page.data["Spellcasting Ability"] ? page.data["Spellcasting Ability"].toLowerCase() : false;
                if (spellcastingAbility && globalAttributesByCategory.abilities.includes(spellcastingAbility)) {
                    newObject.attributes.spellcasting_ability = newObject.buildSpellcastingAbility(spellcastingAbility);
                    if(newObject.checkArcane(lowercaseClass)) newObject.attributes[`arcane_${lowercaseClass}`] = 1;
                }

                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            }

            if (!looped) {
                callbacks.push(update_class);
            };
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processRaces = () => {
        try {
            let newObject = new Race(page.name)

            page.data['Size'] && page.data['Size'] != 'Medium' ? newObject.attributes.size = page.data['Size'] : false
            page.data['Speed'] && page.data['Speed'] != 30 ? newObject.attributes.speed = page.data['Speed'] : false
            assignUpdate(dropFunctions.updateSheetAttributes(newObject));

            if (!looped) {
                callbacks.push(update_race_display);
            }
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processSubraces = () => {
        try {
            let newObject = new Subrace(page.name) 
            page.data['Size'] && page.data['Size'] ? newObject.attributes.size = page.data['Size'] : false
            page.data['Speed'] && page.data['Speed'] ? newObject.attributes.speed = page.data['Speed'] : false
            assignUpdate(dropFunctions.updateSheetAttributes(newObject));

            if (!looped) {
                callbacks.push(update_race_display);
            }
        } catch (error) {
            errorMessage(page.name, error);
        }
    }

    const processOtherOptionsAndFeatures = () => {
        //Do nothing...
    }

    const processBackgrounds = () => {
        try {
            update["background"] = page.name;
        } catch (errorMessage) {
            errorMessage(page.name, error);
        }
    }

    console.log(category)

    switch(category) {
        case "Backgrounds":
            processBackgrounds();
            break;
        case "Classes":
            processClass();
            break;
        case "Feats":
            processFeats();
            break;
        case "Items":
            processItems();
            break;
        case "Monsters":
            processMonsters();
            break;
        case "Proficiencies":
            processProficiencies();
            break;
        case "Spells":
            processSpells();
            break;
        case "Subclasses":
            processSubclasses();
            break;
        case "Races":
            processRaces();
            break
        case "Subraces":
            processSubraces();
            break;
        case "Other Options and Features":
            processOtherOptionsAndFeatures();
            break;
        default:
            errorMessage(category, `category does not match one of the drop functions conditions.`);
    }

    if (page.data.theseblobs) {
        _.each(page.data.theseblobs, function(blobname) {
            if(page.data.blobs[blobname]) blobs[blobname] = page.data.blobs[blobname];
        });
    } else {
        if(category === "Other Options and Features") {
            blobs = page.data.blobs;
        } else {
            blobs = filterBlobs(page.data.blobs, {"Level": "1"});
        }        
    }

    for (let [blobName, blob] of Object.entries(blobs)) {
        if (blob["Traits"]) {
            try {
                const traitArray = dropFunctions.jsonParse(blob["Traits"]);
                if (traitArray && traitArray.length) {
                    traitArray.forEach(trait => {
                        if (!trait.Input) {
                            let match = {name: trait["Name"], type: page.name};
                            if (trait["Replace"]) {
                                match = {name: trait["Replace"]};
                            }
                            let existing = _.findWhere(repeating.traits, match);
                            existing = existing ? existing : {};

                            let newObject = new Trait(trait["Name"].replace(/{{Input}}/g, ""), existing.id || false);
                            newObject.attributes.source = newObject.determineSource(category)
                            trait["Desc"] ? newObject.attributes.description = trait["Desc"].replace(/{{Input}}/g, "") : false
                            page.name ? newObject.attributes.source_type = removeExpansionInfo(page.name) : false
                            assignUpdate(dropFunctions.updateSheetAttributes(newObject));
                            
                            existing = dropHelpers.updateRepeatingTraits(newObject, existing)
                            existing ? false : repeating.traits.push(existing);

                            if (trait["Name"] === "Reliable Talent") {
                                update["reliable_talent"] = "10";
                            }

                            else if (trait["Name"] === "Powerful Build") {
                                update["powerful_build"] = "1";
                            };
                        }
                    });
                };
            } catch (error) {
                errorMessage(trait.Name, error)
            }
        }

        ["Language Proficiency", "Weapon Proficiency", "Armor Proficiency"].forEach(proficiencyType => {
            try {
                const proficiencyArray = blob[`${proficiencyType}`] ? dropFunctions.jsonParse(blob[`${proficiencyType}`]) : false
                if (proficiencyArray && proficiencyArray["Proficiencies"]) {
                    proficiencyArray["Proficiencies"].forEach(proficiency => {
                        if (repeating.prof_names.indexOf(proficiency.toLowerCase()) == -1) {
                            let newObject = new Proficiency(proficiency)
                            newObject.attributes.prof_type = proficiencyType.split(" Proficiency")[0].toUpperCase()
                            repeating.prof_names.push(proficiency.toLowerCase());
                            assignUpdate(dropFunctions.updateSheetAttributes(newObject));
                        }
                    })
                }
            } catch (error) {
                errorMessage(proficiencyType, error)
            }
        })

        if (blob["Tool Proficiency"]) {
            try {
                const toolArray = dropFunctions.jsonParse(blob["Tool Proficiency"]);
                if(toolArray["Proficiencies"] && toolArray["Proficiencies"].length) {
                    toolArray["Proficiencies"].forEach(proficiency => {
                        let existing = {id: false}
                        existing.id = dropHelpers.findToolId(repeating.tool, proficiency)

                        let newObject = new ToolProficiency(proficiency, existing.id)
                        assignUpdate(dropFunctions.updateSheetAttributes(newObject));

                        existing = dropHelpers.updateRepeatingTools(newObject, existing)
                        repeating.tool[newObject.reprowid] = existing
                        repeating.prof_names.push(page.name.toLowerCase());

                        //Updates the displays for the tool...
                        callbacks.push(() => {
                            update_tool(newObject.reprowid);
                        });
                    })
                }
            } catch (error) {
                errorMessage("Tool Proficiency", error)
            }
        }

        if (blob["Skill Proficiency"]) {
            try {
                const skillArray = dropFunctions.jsonParse(blob["Skill Proficiency"]);
                if (skillArray["Proficiencies"] && skillArray["Proficiencies"].length) {
                    skillArray["Proficiencies"].forEach(proficiency => {
                        let newObject = new Skill(proficiency);
                        assignUpdate(dropFunctions.updateSheetAttributes(newObject));
                    });
                    callbacks.push(() => { 
                        update_skills(["athletics", "acrobatics", "sleight_of_hand", "stealth", "arcana", "history", "investigation", "nature", "religion", "animal_handling", "insight", "medicine", "perception", "survival","deception", "intimidation", "performance", "persuasion"]);
                    });
                };
            } catch (error) {
                errorMessage("Skill Proficiency", error)
            }
        }
        
        if (blob["Global Damage"]) {
            try {
                const dmgmod = dropFunctions.jsonParse(blob["Global Damage"])
                let existing = {}

                for (let [key, value] of Object.entries(repeating.damagemod)) {
                    value.toLowerCase() === dmgmod["Name"].toLowerCase() ? existing.id = key : false
                }

                let newObject = new GlobalDamage(dmgmod["Name"], existing.id || false)
                newObject.attributes.global_damage_damage = `${parseValues(dmgmod["Damage"])}`
                dmgmod["Active"] == "true" ? newObject.attributes.global_damage_active_flag = 1 : false
                newObject.attributes.global_damage_type = dmgmod["Type"] ? dmgmod["Type"] : dmgmod["Name"];
                assignUpdate(dropFunctions.updateSheetAttributes(newObject));

                update["global_damage_mod_flag"] = "1";

                repeating.damagemod[newObject.reprowid] = dmgmod["Name"];
            } catch (error) {
                errorMessage("Global Damage", error)
            }
        }

        if (blob["Actions"]) {
            try {
                let actionsObject = {}
                dropFunctions.jsonParse(blob["Actions"]).forEach(value => actionsObject[value.Name] = value)

                for (let [actionName, action] of Object.entries(actionsObject)) {
                    let existing = {}

                    for (let [key, value] of Object.entries(repeating.attack)) {
                        value.atkname === actionName ? existing.id = key : false
                    }

                    let newObject = new Attack(actionName, existing.id || false)
                    action["Desc"] ? newObject.attributes.atk_desc = action["Desc"] : false

                    if (action["Type Attack"]) {
                        if (action["Type"] === "Spell") {
                            newObject.attributes.atkflag = 0
                            newObject.addSaveFlag()
                        }

                        action["Reach"] ? newObject.attributes.atkrange = action["Reach"] : false
                        action["Damage"] ? newObject.attributes.dmgbase = action["Damage"] : false
                        !action["Damage"] ? newObject.attributes.dmgflag = 0 : false;
                        action["Damage Type"] ? newObject.attributes.dmgtype = action["Damage Type"] : false

                        if (action["Modifier"]) {
                            if (action["Modifier"] === "FIN") {
                                 newObject.checkFinesse(parseInt(currentData.strength_base), parseInt(currentData.dexterity_base))
                            } else {
                                const actionModifier = dropFunctions.convertAbbreviationToAttribute(action["Modifier"])
                                actionModifier && actionModifier != newObject.attributes.dmgattr ? newObject.attributes.dmgattr = actionModifier : false
                                actionModifier && actionModifier != newObject.attributes.atkattr_base ? newObject.attributes.atkattr_base = actionModifier : false
                            }
                        } else {
                            newObject.attributes.dmgattr = 0;
                        }

                        action["Save"] ? newObject.attributes.saveattr = action["Save"] : false
                        action["Save Effect"] ? newObject.attributes.saveeffect = action["Save Effect"] : false

                        if (action["Save DC"]) {
                            const saveDCModifier = dropFunctions.convertAbbreviationToAttribute(action["Save DC"])
                            newObject.attributes.savedc = `(@{saveflat})`;
                            newObject.attributes.saveflat = `(8+@{pb}+${saveDCModifier})`;
                        }

                        if (action["Damage 2"] && action["Damage 2 Type"]) {
                            newObject.attributes.dmg2flag = '{{damage=1}} {{dmg2flag=1}}'
                            newObject.attributes.atk_dmg2base = action["Damage 2"]
                            newObject.attributes.attack_damagetype2 = action["Damage 2 Type"]

                            if (action["Modifier 2"]) {
                                newObject.attributes.dmg2attr = dropFunctions.convertAbbreviationToAttribute(action["Modifier 2"])
                            } else {
                                newObject.attributes.dmgattr = 0
                            }
                        }
                    }

                    assignUpdate(dropFunctions.updateSheetAttributes(newObject));

                    repeating.attack[`${newObject.reprowid}`] = {atkname: newObject.attributes.atkname}

                    callbacks.push(() => { 
                        do_update_attack([`${newObject.reprowid}`]); 
                    });
                }
            } catch (error) {
                errorMessage("Actions", error)
            }
        }

        if (blob["Resources"]) {
            try {
                const resourcesArray = dropFunctions.jsonParse(blob["Resources"])
                resourcesArray.forEach(resource => {
                    let section = undefined;

                    const findCurrentResource = resourceName => {
                        if (currentData["class_resource_name"] === resourceName) {
                            return "class_resource"
                        } else if (currentData["other_resource_name"] === resourceName) {
                            return "other_resource"
                        } else {
                             for (let [repeatingIDKey, repeatingValue] of Object.entries(repeating.resource)) {
                                return Object.values(repeatingValue).includes(resourceName) ? repeatingIDKey : false
                            }
                        }
                    }

                    //Testing this funtion to find an empty resource
                    const findEmptyResource = () => {
                        if (currentData["class_resource_name"].length === 0) {
                            return "class_resource"
                        } else if (currentData["other_resource_name"].length === 0) {
                            return "other_resource"
                        } else {
                            let foundEmptyString = false
                            for (let [repeatingIDKey, repeatingValue] of Object.entries(repeating.resource)) {
                                if (repeatingValue.left.length === 0) {
                                    return `repeating_resource_${repeatingIDKey}_resource_left`
                                } else if (repeatingValue.right.length === 0) {
                                    return `repeating_resource_${repeatingIDKey}_resource_right`
                                } else {
                                    foundEmptyString = false
                                }
                            }

                            return foundEmptyString
                        }
                    }

                    let matchResource = findCurrentResource(resource.Name)

                    if (matchResource) {
                        if (matchResource === "class_resource" || matchResource === "other_resource") {
                            section = matchResource
                        } else {
                            const repeatingSide = repeating.resource[matchResource].left === resource.Name ? "left" : "right"
                            section = `repeating_resource_${matchResource}_resource_${repeatingSide}`
                        }
                    } else {
                        section = findEmptyResource()
                    }

                    //Section will be true if a repeating entry matches resource.Name or is has an empty side ||
                    //class/other_resource match the resource.Name or are empty
                    if (section) {
                        update[`${section}_name`] = resource.Name
                        if (resource.Uses) update[section] = numUses(resource.Uses)
                        update[`${section}_max`] = resource.Max ? numUses(resource.Max) : numUses(resource.Uses)

                        if (section === "class_resource" || section === "other_resource") {
                            currentData[`${section}_name`] = resource.Name
                        } else {
                            const sectionRepeatingId = section.split('_resource_')[1]
                            const sectionSide = section.includes('left') ? 'left' : 'right'
                            repeating.resource[`${sectionRepeatingId}`][sectionSide] = resource.Name
                        }
                    } else {
                        const newResource = new Resource(resource.Name)
                        newResource.attributes.resource_left = resource.Uses ? numUses(resource.Uses) : 0
                        newResource.attributes.resource_left_max = resource.Max ? numUses(resource.Max) : newResource.attributes.resource_left
                        assignUpdate(dropFunctions.updateSheetAttributes(newResource))

                        const addRepeating = {
                            [`${newResource.reprowid}`]: {
                                left: resource.Name, 
                                right: ''
                            }
                        }
                        Object.assign(repeating.resource, addRepeating)
                    }
                })
            } catch (error) {
                errorMessage("Resources", error)
            }
        }

        if (blob["Custom AC"]) {
            try {
                const parsedKey = dropFunctions.jsonParse(blob["Custom AC"]);
                update["custom_ac_flag"] = "1";
                update["custom_ac_base"] = parsedKey.Base;
                update["custom_ac_part1"] = parsedKey["Attribute 1"];
                update["custom_ac_part2"] = parsedKey["Attribute 2"] ? parsedKey["Attribute 2"] : "";
                update["custom_ac_shield"] = parsedKey.Shields;
                if(!looped) {
                    callbacks.push( function() {update_ac();} )
                }
            } catch (error) {
                errorMessage("Custom AC", error)
            }
        }

        if (blob["Hit Points Per Level"]) {
            try {
                const parsedKey = dropFunctions.jsonParse(blob["Hit Points Per Level"])
                let existing = {}
                for (let [key, value] of Object.entries(repeating.hpmod)) {
                    value.source === blobName ? existing.id = key : false
                }

                let newObject = new HPMod(blobName, existing.id || false)
                newObject.attributes.mod = blob["Hit Points Per Level"]
                newObject.attributes.source = blobName
                newObject.attributes.levels = category === "Races" || category === "Subraces" ? 'total' : 'base'
                assignUpdate(dropFunctions.updateSheetAttributes(newObject));
            } catch (error) {
                errorMessage("Hit Points Per Level", error)
            }
        }

        if (blob["Hit Points Bonus"]) {
            let prevHp = update["hp"] || currentData["hp"];
            let prevHpMax = update["hp_max"] || currentData["hp_max"];
            prevHp = prevHp && !isNaN(parseInt(prevHp)) ? parseInt(prevHp) : 0;
            prevHpMax = prevHpMax && !isNaN(parseInt(prevHpMax)) ? parseInt(prevHpMax) : 0;
            update["hp"] = prevHp + parseInt(blob["Hit Points Bonus"]);
            update["hp_max"] = prevHpMax + parseInt(blob["Hit Points Bonus"]);
        }

        ["Global AC Mod", "Global Save", "Global Attack"].forEach(globalType => {
            try {
                if (blob[globalType]) {
                    const globalShortName = globalType.includes("Attack") ? "attack" : globalType.includes("Save") ? "save" : "ac";
                    const repeatingKey = globalShortName === "attack" ? "tohitmod" : globalShortName === "save" ? "savemod" : "acmod";

                    const parsedKey = dropFunctions.jsonParse(blob[`${globalType}`]);
                    let existing = {id: false}
                    for (let [key, value] of Object.entries(repeating[`${repeatingKey}`])) {
                       value.includes(blobName) ? existing.id = key : false
                    }

                    let newObject = {};
                    if (globalType === "Global AC Mod") {
                        newObject = new GlobalACMod(parsedKey.Name, existing.id)
                        newObject.attributes.global_ac_val = parsedKey.Bonus
                    } else if (globalType === "Global Save") {
                        newObject = new GlobalSave(parsedKey.Name, existing.id)
                        newObject.attributes.global_save_roll = parsedKey.Bonus
                    } else {
                        newObject = new GlobalAttack(parsedKey.Name, existing.id)
                        newObject.addRoll(parsedKey.Bonus)
                    }

                    parsedKey.Active !== "false" ? newObject.attributes[`global_${globalShortName}_active_flag`] = 1 : false
                    assignUpdate(dropFunctions.updateSheetAttributes(newObject))

                    update[`global_${globalShortName}_mod_flag`] = "1"
                }
            } catch (error) {
                errorMessage(`${globalType}`, error)
            }
        })

        if (blob["Initiative"]) {
            if (blob["Initiative"].toLowerCase() === "advantage") {
                update["initiative_style"] = "{@{d20},@{d20}}kh1";
            } else if (blob["Initiative"].toLowerCase() === "disadvantage") {
                update["initiative_style"] = "{@{d20},@{d20}}kl1";
            } else {
                update.initmod = numUses(blob["Initiative"]);
            }         
        }

        if (blob["Carry Multiplier"]) {
            update["carrying_capacity_mod"] = `*${blob["Carry Multiplier"]}`
        }

        if (blob["Speed"]) {
            try {
                if (blob["Speed"][0] === "+") {
                    let prevspeed = update["speed"] || currentData["speed"];
                    prevspeed = prevspeed && !isNaN(parseInt(prevspeed)) ? parseInt(prevspeed) : 0;
                    update["speed"] = prevspeed + parseInt(blob["Speed"]);
                } else {
                    update["speed"] = parseInt(blob["Speed"]);
                }
            } catch (error) {
                errorMessage("Speed", error)
            }
        }

        if (blob["Jack of All Trades"]) {
            update["jack_of_all_trades"] = "@{jack}";
        }

        if (blob["Global Save Mod"]) {
            update["globalsavemod"] = numUses(blob["Global Save Mod"]);
        }

        if (blob["Saving Throws"]) {
            try {
                const parsedArray = dropFunctions.jsonParse(blob["Saving Throws"])
                parsedArray.forEach(value => {
                    const save = new SavingThrow(value);
                    assignUpdate(dropFunctions.updateSheetAttributes(save));
                })
            } catch (error) {
                errorMessage("Saving Throws", error)
            }
        }

        if (blob["Proficiency Bonus"]) {
            try {
                const parsedBonus = dropFunctions.jsonParse(blob["Proficiency Bonus"])
                for (let [key, value] of Object.entries(parsedBonus)) {
                    update[`${key.replace(/ /g, "_").toLowerCase()}_flat`] = numUses(value);
                }
                update_skills(["athletics", "acrobatics", "sleight_of_hand", "stealth", "arcana", "history", "investigation", "nature", "religion", "animal_handling", "insight", "medicine", "perception", "survival","deception", "intimidation", "performance", "persuasion"]);
            } catch (error) {
                errorMessage("Proficiency Bonus", error)
            }
        }
        
        if (blob["Spells"]) {
            try {
                let spells = dropFunctions.jsonParse(blob["Spells"]);
                let spellUpdate = {}, spellCallbacks = [];
                let spellPages = [];
                spells.forEach(spell => {
                    if(spell.Name) spellPages.push(spell.Name);
                    if(spell.Known) spellPages = spellPages.concat(spell.Known);
                });
                spellPages = Array.from(new Set(spellPages));

                getCompendiumPage(spellPages, spellData => {
                    var inSpellBook = function(name) {
                      let found = false;
                      const spellRepeating = ["cantrip", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
                      spellRepeating.forEach(spellLevel => {
                        if(found) return;
                        if(repeating[`spell-${spellLevel}`]) {
                            Object.keys(repeating[`spell-${spellLevel}`]).forEach(entry => {
                                if(repeating[`spell-${spellLevel}`][entry]['spellname'] === name) {
                                    found = true;
                                    return;
                                }
                            });
                        }
                      });
                      return found;
                    };
                    spellData = removeDuplicatedPageData(spellData);
                    spells.forEach(spellInformation => {
                        if(spellInformation.Known) {
                            spellInformation.Known.forEach(s => {
                                if(!inSpellBook(s)) {
                                    const mockPage = {
                                      name: s,
                                      data: {
                                          "Category": "Spells"
                                      }
                                  }
                                  const pageData = (Array.isArray(spellData)) ? spellData.filter(entry => { return entry['name'] === s})[0] : spellData;
                                  if(pageData) {
                                    Object.assign(mockPage.data, pageData.data);
                                    Object.assign(mockPage.data, spellInformation);
                                    const processedSpell = processDrop(mockPage, currentData, repeating);
                                    Object.assign(spellUpdate, processedSpell.update);
                                    processedSpell.callbacks.forEach(callback => spellCallbacks.push(callback));
                                  }
                                }
                            });
                        } else {
                            if(!inSpellBook(spellInformation.Name)) {
                                const mockPage = {
                                  name: spellInformation.Name,
                                  data: {
                                      "Category": "Spells"
                                  }
                              }
                              const pageData = (Array.isArray(spellData))? spellData.filter(entry => { return entry['name'] === spellInformation.Name})[0] : spellData;
                              Object.assign(mockPage.data, pageData.data);
                              Object.assign(mockPage.data, spellInformation);
                              const processedSpell = processDrop(mockPage, currentData, repeating);
                              Object.assign(spellUpdate, processedSpell.update);
                              processedSpell.callbacks.forEach(callback => spellCallbacks.push(callback));
                            }
                        }
                    });
                    if(Object.keys(spellUpdate).length > 0) {
                        setAttrs(spellUpdate, {silent: true}, () => {
                            spellCallbacks.forEach(callback => {
                                callback();
                            });
                        });
                    }
                });
            } catch (error) {
                errorMessage("Spells", error)
            }
        }
        
        if (blob["Custom Spells"]) {
            try {
                let customSpells = dropFunctions.jsonParse(blob["Custom Spells"]);
                let spellUpdate = {}, spellCallbacks = [];
                customSpells.forEach(spellInformation => {
                    const mockPage = {
                        name: spellInformation.Name,
                        data: {
                            "Category": "Spells"
                        }
                    }
                    Object.assign(mockPage.data, spellInformation);
                    const processedSpell = processDrop(mockPage, currentData, repeating);
                    Object.assign(spellUpdate, processedSpell.update);
                    processedSpell.callbacks.forEach(callback => spellCallbacks.push(callback));
                });

                setAttrs(spellUpdate, {silent: true}, () => {
                    spellCallbacks.forEach(callback => {
                        callback();
                    });
                });
            } catch (error) {
                errorMessage("Custom Spells", error)
            }
        }
    }

    return {
        update: update,
        repeating: repeating,
        callbacks: callbacks
    };
};



</script>