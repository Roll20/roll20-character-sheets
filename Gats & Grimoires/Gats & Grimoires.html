<div class="sheet-goon">
  <!-- Active Tab State -->
  <input type="hidden" name="attr_active_tab" value="bio" />

  <!-- Tabs -->
  <div class="sheet-tab-bar">
    <button type="action" name="act_tab_bio" class="sheet-tab-button sheet-tab-button-bio">Bio / Info</button>
    <button type="action" name="act_tab_traits" class="sheet-tab-button sheet-tab-button-traits">Traits &amp; Talents</button>
    <button type="action" name="act_tab_inventory" class="sheet-tab-button sheet-tab-button-inventory">Inventory</button>
    <button type="action" name="act_tab_combat" class="sheet-tab-button sheet-tab-button-combat">Combat</button>
    <button type="action" name="act_tab_npc" class="sheet-tab-button sheet-tab-button-npc">NPC</button>
    <button type="action" name="act_tab_crew" class="sheet-tab-button sheet-tab-button-crew">Crew</button>
  </div>

  <!-- BIO / INFO TAB -->
  <div class="sheet-tab-content sheet-tab-bio">
    <div class="sheet-header-row">
      <div class="sheet-card">
        <div class="sheet-card-title">Identity</div>
        <div class="sheet-field">
          <label>Character Name</label>
          <input type="text" name="attr_character_name" />
        </div>
        <div class="sheet-field">
          <label>Player</label>
          <input type="text" name="attr_player_name" />
        </div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Level</label>
              <input type="number" name="attr_level" value="1" />
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Race</label>
              <input type="text" name="attr_race" />
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Family</label>
              <input type="text" name="attr_family" />
            </div>
          </div>
        </div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Size</label>
              <input type="text" name="attr_size" />
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Renown</label>
              <input type="text" name="attr_renown" />
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Speed (squares)</label>
              <input type="number" name="attr_speed" />
            </div>
          </div>
        </div>
        <div class="sheet-field">
          <label>Senses</label>
          <input type="text" name="attr_senses" />
        </div>
        <div class="sheet-field">
          <label>Tells</label>
          <textarea name="attr_tells"></textarea>
        </div>
      </div>

      <div class="sheet-card">
        <div class="sheet-card-title">Core Stats</div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Body</label>
              <div class="sheet-field-inline">
                <input type="number" name="attr_body" />
                <button type="roll" name="roll_body" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Body Check}} {{roll=[[1d20 + @{body}]]}}">
                  Roll
                </button>
              </div>
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Reflex</label>
              <div class="sheet-field-inline">
                <input type="number" name="attr_reflex" />
                <button type="roll" name="roll_reflex" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Reflex Check}} {{roll=[[1d20 + @{reflex}]]}}">
                  Roll
                </button>
              </div>
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Mind</label>
              <div class="sheet-field-inline">
                <input type="number" name="attr_mind" />
                <button type="roll" name="roll_mind" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Mind Check}} {{roll=[[1d20 + @{mind}]]}}">
                  Roll
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Moxie</label>
              <div class="sheet-field-inline">
                <input type="number" name="attr_moxie" />
                <button type="roll" name="roll_moxie" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Moxie Check}} {{roll=[[1d20 + @{moxie}]]}}">
                  Roll
                </button>
              </div>
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Lip</label>
              <div class="sheet-field-inline">
                <input type="number" name="attr_lip" />
                <button type="roll" name="roll_lip" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Lip Check}} {{roll=[[1d20 + @{lip}]]}}">
                  Roll
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="sheet-card-title" style="margin-top:6px;">Vitality &amp; Defense</div>
        <div class="sheet-field-inline">
          <label>HP</label>
          <input type="number" name="attr_hp" style="flex:0 0 50px;" />
          <span>/</span>
          <input type="number" name="attr_hp_max" style="flex:0 0 50px;" readonly />
        </div>
        <div class="sheet-field">
          <label>Race HP / Level</label>
          <input type="number" name="attr_race_hp_per_level" />
        </div>
        <div class="sheet-field-inline">
          <label>Defense</label>
          <input type="number" name="attr_defense" style="flex:0 0 60px;" readonly />
        </div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Defense Gear</label>
              <input type="number" name="attr_defense_gear" />
            </div>
          </div>
          <div class="sheet-col">
            <div class="sheet-field">
              <label>Defense Misc</label>
              <input type="number" name="attr_defense_misc" />
            </div>
          </div>
        </div>
      </div>

      <div class="sheet-card">
        <div class="sheet-card-title">Resource Pools</div>
        <div class="sheet-field-inline">
          <label>Mana</label>
          <input type="number" name="attr_mana" style="flex:0 0 50px;" />
          <span>/</span>
          <input type="number" name="attr_mana_max" style="flex:0 0 50px;" readonly />
        </div>
        <div class="sheet-field">
          <label>Mana / Level</label>
          <input type="number" name="attr_mana_per_level" />
        </div>
        <div class="sheet-row">
          <div class="sheet-col">
            <div class="sheet-field-inline">
              <label>Runes</label>
              <input type="number" name="attr_runes" style="flex:0 0 40px;" />
              <span>/</span>
              <input type="number" name="attr_runes_max" style="flex:0 0 40px;" />
            </div>
          </div>
        </div>
        <div class="sheet-card-title" style="margin-top:6px;">Pool 2</div>
        <div class="sheet-field">
          <label>Pool 2 Name</label>
          <input type="text" name="attr_pool2_name" />
        </div>
        <div class="sheet-field-inline">
          <label>Pool 2</label>
          <input type="number" name="attr_pool2" style="flex:0 0 50px;" />
          <span>/</span>
          <input type="number" name="attr_pool2_max" style="flex:0 0 50px;" />
        </div>

        <div class="sheet-card-title" style="margin-top:6px;">Extra Pools</div>
        <div class="sheet-crew-rep-header">
          <div>Name</div>
          <div>Current</div>
          <div>Max</div>
        </div>
        <fieldset class="repeating_pools">
          <div class="sheet-crew-rep-row">
            <input type="text" name="attr_pool_name" />
            <input type="number" name="attr_pool_current" />
            <input type="number" name="attr_pool_max" />
          </div>
        </fieldset>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Background Notes</div>
      <textarea name="attr_bio_extra"></textarea>
    </div>
  </div>

  <!-- TRAITS & TALENTS TAB -->
  <div class="sheet-tab-content sheet-tab-traits">
    <div class="sheet-card">
      <div class="sheet-card-title">Traits</div>
      <div class="sheet-rep-header">
        <div>Name</div>
        <div>Tag</div>
        <div>Uses</div>
      </div>
      <fieldset class="repeating_traits">
        <div class="sheet-rep-row">
          <input type="text" name="attr_trait_name" placeholder="Trait name" />
          <div class="sheet-chip-input">
            <input type="text" name="attr_trait_tag" placeholder="Tag" />
          </div>
          <input type="text" name="attr_trait_uses" placeholder="Uses" />
          <textarea name="attr_trait_desc" placeholder="Describe what this trait does."></textarea>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Talents</div>
      <div class="sheet-rep-header">
        <div>Name</div>
        <div>Tag</div>
        <div>Uses</div>
      </div>
      <fieldset class="repeating_talents">
        <div class="sheet-rep-row">
          <input type="text" name="attr_talent_name" placeholder="Talent name" />
          <div class="sheet-chip-input">
            <input type="text" name="attr_talent_tag" placeholder="Tag" />
          </div>
          <input type="text" name="attr_talent_uses" placeholder="Uses" />
          <textarea name="attr_talent_desc" placeholder="Describe what this talent does."></textarea>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Flaws</div>
      <div class="sheet-rep-header">
        <div>Name</div>
        <div>Severity</div>
        <div>Description</div>
      </div>
      <fieldset class="repeating_flaws">
        <div class="sheet-rep-row">
          <input type="text" name="attr_flaw_name" placeholder="Flaw name" />
          <input type="text" name="attr_flaw_severity" placeholder="Severity" />
          <textarea name="attr_flaw_desc" placeholder="How does this flaw complicate things?"></textarea>
        </div>
      </fieldset>
    </div>
  </div>

  <!-- INVENTORY TAB -->
  <div class="sheet-tab-content sheet-tab-inventory">
    <div class="sheet-card">
      <div class="sheet-card-title">Wealth &amp; Bulk</div>
      <div class="sheet-row">
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Cash</label>
            <input type="text" name="attr_cash" />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Lifestyle</label>
            <input type="text" name="attr_lifestyle" />
          </div>
        </div>
      </div>
      <div class="sheet-row">
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Bulk Capacity</label>
            <input type="number" name="attr_bulk_capacity" />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Bulk Total</label>
            <input type="number" name="attr_bulk_total" readonly />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Bulk Over</label>
            <input type="number" name="attr_bulk_over" readonly />
          </div>
        </div>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Inventory</div>
      <div class="sheet-inventory-header">
        <div>Item</div>
        <div>Qty</div>
        <div>Bulk ea</div>
        <div>Light (L)</div>
        <div>Bulk total</div>
        <div>Notes</div>
      </div>
      <fieldset class="repeating_inventory">
        <div class="sheet-inventory-row">
          <input type="text" name="attr_item_name" />
          <input type="number" name="attr_item_qty" value="1" />
          <input type="number" name="attr_item_bulk" value="0" />
          <input type="number" name="attr_item_light" value="0" />
          <input type="number" name="attr_item_bulktotal" readonly />
          <textarea name="attr_item_notes" class="sheet-note-large"></textarea>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Magic Items</div>
      <div class="sheet-crew-rep-header">
        <div>Name</div>
        <div>Slot</div>
        <div>Effect</div>
      </div>
      <fieldset class="repeating_magicitems">
        <div class="sheet-crew-rep-row">
          <input type="text" name="attr_magic_name" />
          <input type="text" name="attr_magic_slot" />
          <textarea name="attr_magic_effect" class="sheet-note-large"></textarea>
        </div>
      </fieldset>
    </div>
  </div>

  <!-- COMBAT TAB -->
  <div class="sheet-tab-content sheet-tab-combat">
    <div class="sheet-card">
      <div class="sheet-card-title">Initiative</div>
      <button type="roll" name="roll_initiative" value="&{template:goon} {{title=@{character_name}}} {{subtitle=Initiative}} {{roll=[[1d20 + @{reflex}]]}} &{tracker}">
        Roll Initiative
      </button>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Attacks</div>
      <div class="sheet-attack-header">
        <div>Name</div>
        <div>Type</div>
        <div>Stat</div>
        <div>Damage</div>
        <div>Range (squares)</div>
        <div>Mod</div>
        <div>Roll</div>
      </div>
      <fieldset class="repeating_attacks">
        <div class="sheet-attack-row">
          <input type="text" name="attr_atk_name" />
          <select name="attr_atk_type">
            <option value="Melee">Melee</option>
            <option value="Ranged">Ranged</option>
            <option value="Spell">Spell</option>
          </select>
          <select name="attr_atk_stat">
            <option value="body">Body</option>
            <option value="reflex">Reflex</option>
            <option value="mind">Mind</option>
            <option value="moxie">Moxie</option>
            <option value="lip">Lip</option>
          </select>
          <input type="hidden" name="attr_atk_stat_value" value="0" />
          <input type="text" name="attr_atk_damage" placeholder="e.g. 1d8+2" />
          <input type="text" name="attr_atk_range" placeholder="e.g. 5" />
          <input type="number" name="attr_atk_mod" value="0" />
          <button type="roll" name="roll_attack" value="&{template:goon} {{title=@{character_name}}} {{subtitle=@{atk_name}}} {{type=@{atk_type}}} {{attack=[[1d20 + @{atk_stat_value} + @{atk_mod}]]}} {{damage=[[@{atk_damage}]]}} {{range=@{atk_range} squares}}">
            Roll
          </button>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Conditions</div>
      <div class="sheet-conditions">
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_dazed" />
          <span>Dazed</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_stunned" />
          <span>Stunned</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_fear" />
          <span>Fear</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_smoldering" />
          <span>Smoldering</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_bleeding" />
          <span>Bleeding</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_ringing" />
          <span>Ringing</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_poisoned" />
          <span>Poisoned</span>
        </label>
        <label class="sheet-condition">
          <input type="checkbox" name="attr_cond_grappled" />
          <span>Grappled</span>
        </label>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Spell Helper</div>
      <div class="sheet-row">
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Spell Name</label>
            <input type="text" name="attr_spell_name" />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Mana Spent</label>
            <input type="number" name="attr_spell_mana" />
          </div>
        </div>
      </div>
      <div class="sheet-field">
        <label>Notes / Extra Roll</label>
        <input type="text" name="attr_spell_roll" placeholder="Range, area, notes, etc." />
      </div>
      <button type="roll" name="roll_spell" value="&{template:goon} {{title=@{character_name}}} {{subtitle=@{spell_name}}} {{mana=@{spell_mana}}} {{mindroll=[[1d20 + @{mind}]]}} {{notes=@{spell_roll}}}">
        Cast / Mind Roll
      </button>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Spells / Powers</div>
      <div class="sheet-npc-spell-header">
        <div>Name</div>
        <div>Cost</div>
        <div>Effect / Description</div>
        <div>Roll</div>
      </div>
      <fieldset class="repeating_spells">
        <div class="sheet-npc-spell-row">
          <input type="text" name="attr_spell_power_name" />
          <input type="text" name="attr_spell_power_cost" placeholder="e.g. 2 Mana" />
          <textarea name="attr_spell_power_desc" class="sheet-note-large" placeholder="What the spell or power does."></textarea>
          <div>
            <input type="text" name="attr_spell_power_roll" placeholder="e.g. 1d20+3" />
            <button type="roll" name="roll_spell_power" value="&{template:goon} {{title=@{character_name}}} {{subtitle=@{spell_power_name}}} {{roll=[[ @{spell_power_roll} ]]}} {{notes=@{spell_power_desc}}}">
              Roll
            </button>
          </div>
        </div>
      </fieldset>
    </div>
  </div>

  <!-- NPC TAB -->
  <div class="sheet-tab-content sheet-tab-npc">
    <div class="sheet-card">
      <div class="sheet-card-title">NPC Identity</div>
      <div class="sheet-row">
        <div class="sheet-col">
          <div class="sheet-field">
            <label>NPC Name</label>
            <input type="text" name="attr_npc_name" />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Affiliation / Family</label>
            <input type="text" name="attr_npc_family" />
          </div>
        </div>
        <div class="sheet-col">
          <div class="sheet-field">
            <label>Size</label>
            <input type="text" name="attr_npc_size" />
          </div>
        </div>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">NPC Basics</div>
      <div class="sheet-field-inline">
        <label>Minion</label>
        <input type="checkbox" name="attr_npc_minion" />
      </div>
      <div class="sheet-npc-grid">
        <div>
          <div class="sheet-field">
            <label>NPC Body</label>
            <div class="sheet-field-inline">
              <input type="number" name="attr_npc_body" />
              <button type="roll" name="roll_npc_body" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Body Check}} {{roll=[[1d20 + @{npc_body}]]}}">
                Roll
              </button>
            </div>
          </div>
          <div class="sheet-field">
            <label>NPC Reflex</label>
            <div class="sheet-field-inline">
              <input type="number" name="attr_npc_reflex" />
              <button type="roll" name="roll_npc_reflex" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Reflex Check}} {{roll=[[1d20 + @{npc_reflex}]]}}">
                Roll
              </button>
            </div>
          </div>
        </div>
        <div>
          <div class="sheet-field">
            <label>NPC Mind</label>
            <div class="sheet-field-inline">
              <input type="number" name="attr_npc_mind" />
              <button type="roll" name="roll_npc_mind" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Mind Check}} {{roll=[[1d20 + @{npc_mind}]]}}">
                Roll
              </button>
            </div>
          </div>
          <div class="sheet-field">
            <label>NPC Moxie</label>
            <div class="sheet-field-inline">
              <input type="number" name="attr_npc_moxie" />
              <button type="roll" name="roll_npc_moxie" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Moxie Check}} {{roll=[[1d20 + @{npc_moxie}]]}}">
                Roll
              </button>
            </div>
                      <div class="sheet-field">
            <label>NPC Lip</label>
            <div class="sheet-field-inline">
              <input type="number" name="attr_npc_lip" />
              <button type="roll" name="roll_npc_lip" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Lip Check}} {{roll=[[1d20 + @{npc_lip}]]}}">
                Roll
              </button>
            </div>
          </div>
          </div>
        </div>
        <div>
          <div class="sheet-field">
            <label>HP</label>
            <input type="number" name="attr_npc_hp" />
          </div>
          <div class="sheet-field">
            <label>Defense</label>
            <input type="number" name="attr_npc_defense" />
          </div>
          <div class="sheet-field">
            <label>Speed (squares)</label>
            <input type="number" name="attr_npc_speed" />
          </div>
        </div>
      </div>
      <div class="sheet-field-inline">
        <label>Initiative Mod</label>
        <input type="number" name="attr_npc_init_mod" value="0" style="flex:0 0 60px;" />
        <button type="roll" name="roll_npc_initiative" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=Initiative}} {{roll=[[1d20 + @{npc_init_mod}]]}} &{tracker}">
          Init
        </button>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">NPC Actions</div>
      <div class="sheet-npc-actions-header">
        <div>Name</div>
        <div>Damage</div>
        <div>Mod</div>
        <div>Roll</div>
      </div>
      <fieldset class="repeating_npcactions">
        <div class="sheet-npc-actions-row">
          <input type="text" name="attr_npc_act_name" />
          <input type="text" name="attr_npc_act_damage" placeholder="e.g. 1d6+2" />
          <input type="number" name="attr_npc_act_mod" value="0" />
          <button type="roll" name="roll_npc_action" value="&{template:goon} {{title=@{npc_name}}} {{subtitle=@{npc_act_name}}} {{attack=[[1d20 + @{npc_act_mod}]]}} {{damage=[[@{npc_act_damage}]]}}">
            Roll
          </button>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">NPC Text</div>
      <textarea name="attr_npc_text" placeholder="Description, tactics, voice notes, etc."></textarea>
    </div>
  </div>

  <!-- CREW TAB -->
  <div class="sheet-tab-content sheet-tab-crew">
    <div class="sheet-card">
      <div class="sheet-card-title">Crew</div>
      <div class="sheet-crew-grid">
        <div class="sheet-field">
          <label>Crew Name</label>
          <input type="text" name="attr_crew_name" />
        </div>
        <div class="sheet-field">
          <label>Crew Family</label>
          <input type="text" name="attr_crew_family" />
        </div>
        <div class="sheet-field">
          <label>Tier</label>
          <input type="number" name="attr_crew_tier" />
        </div>
        <div class="sheet-field">
          <label>Rep</label>
          <input type="number" name="attr_crew_rep" />
        </div>
        <div class="sheet-field">
          <label>Heat</label>
          <input type="number" name="attr_crew_heat" />
        </div>
        <div class="sheet-field">
          <label>Wanted</label>
          <input type="number" name="attr_crew_wanted" />
        </div>
        <div class="sheet-field">
          <label>Bank</label>
          <input type="number" name="attr_crew_bank" />
        </div>
        <div class="sheet-field">
          <label>Stash</label>
          <input type="number" name="attr_crew_stash" />
        </div>
      </div>
      <div class="sheet-crew-rolls">
        <button type="roll" name="roll_entanglements" value="&{template:goon} {{title=Entanglements}} {{heat=@{crew_heat}}} {{roll=[[2d6 + @{crew_heat}]]}}">
          Entanglements
        </button>
        <button type="roll" name="roll_engagement" value="&{template:goon} {{title=Engagement}} {{roll=[[1d6]]}}">
          Engagement
        </button>
      </div>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Contacts</div>
      <div class="sheet-crew-rep-header">
        <div>Name</div>
        <div>Role</div>
        <div>Trusted</div>
      </div>
      <fieldset class="repeating_contacts">
        <div class="sheet-crew-rep-row">
          <input type="text" name="attr_contact_name" />
          <input type="text" name="attr_contact_role" />
          <div class="sheet-checkbox-center">
            <input type="checkbox" name="attr_contact_trusted" />
          </div>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Claims</div>
      <div class="sheet-crew-rep-header">
        <div>Claim</div>
        <div>Effect</div>
        <div></div>
      </div>
      <fieldset class="repeating_claims">
        <div class="sheet-crew-rep-row">
          <input type="text" name="attr_claim_name" />
          <input type="text" name="attr_claim_effect" />
          <div></div>
        </div>
      </fieldset>
    </div>

    <div class="sheet-card">
      <div class="sheet-card-title">Rivals</div>
      <div class="sheet-crew-rep-header">
        <div>Name</div>
        <div>Status</div>
        <div>Clock</div>
      </div>
      <fieldset class="repeating_rivals">
        <div class="sheet-crew-rep-row">
          <input type="text" name="attr_rival_name" />
          <input type="text" name="attr_rival_status" />
          <input type="text" name="attr_rival_clock" />
        </div>
      </fieldset>
    </div>
  </div>
</div>

<!-- ROLLTEMPLATE: GOON -->
<rolltemplate class="sheet-rolltemplate-goon">
  <div class="sheet-rt-container">
    <div class="sheet-rt-header">{{title}}</div>
    {{#subtitle}}
    <div class="sheet-rt-subheader">{{subtitle}}</div>
    {{/subtitle}}

    {{#type}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Type</span>
      <span class="sheet-rt-value">{{type}}</span>
    </div>
    {{/type}}

    {{#attack}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Attack</span>
      <span class="sheet-rt-value">{{attack}}</span>
    </div>
    {{/attack}}

    {{#damage}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Damage</span>
      <span class="sheet-rt-value">{{damage}}</span>
    </div>
    {{/damage}}

    {{#range}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Range</span>
      <span class="sheet-rt-value">{{range}}</span>
    </div>
    {{/range}}

    {{#mana}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Mana</span>
      <span class="sheet-rt-value">{{mana}}</span>
    </div>
    {{/mana}}

    {{#mindroll}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Mind Roll</span>
      <span class="sheet-rt-value">{{mindroll}}</span>
    </div>
    {{/mindroll}}

    {{#heat}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Heat</span>
      <span class="sheet-rt-value">{{heat}}</span>
    </div>
    {{/heat}}

    {{#roll}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Roll</span>
      <span class="sheet-rt-value">{{roll}}</span>
    </div>
    {{/roll}}

    {{#notes}}
    <div class="sheet-rt-row">
      <span class="sheet-rt-label">Notes</span>
      <span class="sheet-rt-value">{{notes}}</span>
    </div>
    {{/notes}}
  </div>
</rolltemplate>

<!-- SHEET WORKERS -->
<script type="text/worker">
  var toInt = function (value) {
    var n = parseInt(value, 10);
    return isNaN(n) ? 0 : n;
  };

  var toFloat = function (value) {
    var n = parseFloat(value);
    return isNaN(n) ? 0 : n;
  };

  var recalcHP = function () {
    getAttrs(["race_hp_per_level", "level", "body"], function (v) {
      var hppl = toInt(v.race_hp_per_level);
      var lvl = toInt(v.level);
      var body = toInt(v.body);
      var hp_max = hppl * lvl + body;
      setAttrs({ hp_max: hp_max }, { silent: true });
    });
  };

  var recalcDefense = function () {
    getAttrs(["reflex", "defense_gear", "defense_misc"], function (v) {
      var def = 5 + toInt(v.reflex) + toInt(v.defense_gear) + toInt(v.defense_misc);
      setAttrs({ defense: def }, { silent: true });
    });
  };

  var recalcMana = function () {
    getAttrs(["mana_per_level", "level"], function (v) {
      var mpl = toInt(v.mana_per_level);
      var lvl = toInt(v.level);
      var mana_max = mpl * lvl;
      setAttrs({ mana_max: mana_max }, { silent: true });
    });
  };

  var recalcBulk = function () {
    getSectionIDs("repeating_inventory", function (ids) {
      var attrs = ["bulk_capacity"];
      ids.forEach(function (id) {
        attrs.push("repeating_inventory_" + id + "_item_qty");
        attrs.push("repeating_inventory_" + id + "_item_bulk");
        attrs.push("repeating_inventory_" + id + "_item_light");
      });

      getAttrs(attrs, function (v) {
        var setObj = {};
        var total = 0;

        ids.forEach(function (id) {
          var qty = toFloat(v["repeating_inventory_" + id + "_item_qty"]);
          var bulk = toFloat(v["repeating_inventory_" + id + "_item_bulk"]);
          var light = toFloat(v["repeating_inventory_" + id + "_item_light"]);
          var rowTotal = qty * bulk + (qty * light) / 10;
          setObj["repeating_inventory_" + id + "_item_bulktotal"] = Number(rowTotal.toFixed(1));
          total += rowTotal;
        });

        var capacity = toFloat(v.bulk_capacity);
        var over = total - capacity;
        if (over < 0) over = 0;

        setObj.bulk_total = Number(total.toFixed(1));
        setObj.bulk_over = Number(over.toFixed(1));

        setAttrs(setObj, { silent: true });
      });
    });
  };

  var recalcAttacks = function () {
    getSectionIDs("repeating_attacks", function (ids) {
      var attrs = ["body", "reflex", "mind", "moxie", "lip"];
      ids.forEach(function (id) {
        attrs.push("repeating_attacks_" + id + "_atk_stat");
      });

      getAttrs(attrs, function (v) {
        var stats = {
          body: toInt(v.body),
          reflex: toInt(v.reflex),
          mind: toInt(v.mind),
          moxie: toInt(v.moxie),
          lip: toInt(v.lip)
        };

        var setObj = {};
        ids.forEach(function (id) {
          var key = v["repeating_attacks_" + id + "_atk_stat"];
          var val = stats[key] || 0;
          setObj["repeating_attacks_" + id + "_atk_stat_value"] = val;
        });

        setAttrs(setObj, { silent: true });
      });
    });
  };

  var initTab = function () {
    getAttrs(["active_tab"], function (v) {
      if (!v.active_tab) {
        setAttrs({ active_tab: "bio" }, { silent: true });
      }
    });
  };

  on("sheet:opened change:race_hp_per_level change:level change:body", recalcHP);
  on("sheet:opened change:reflex change:defense_gear change:defense_misc", recalcDefense);
  on("sheet:opened change:mana_per_level change:level", recalcMana);

  on("sheet:opened change:repeating_inventory:item_qty change:repeating_inventory:item_bulk change:repeating_inventory:item_light change:bulk_capacity remove:repeating_inventory", recalcBulk);

  on("sheet:opened change:body change:reflex change:mind change:moxie change:lip change:repeating_attacks:atk_stat remove:repeating_attacks", recalcAttacks);

  on("sheet:opened", initTab);

  on("clicked:tab_bio", function () {
    setAttrs({ active_tab: "bio" }, { silent: true });
  });
  on("clicked:tab_traits", function () {
    setAttrs({ active_tab: "traits" }, { silent: true });
  });
  on("clicked:tab_inventory", function () {
    setAttrs({ active_tab: "inventory" }, { silent: true });
  });
  on("clicked:tab_combat", function () {
    setAttrs({ active_tab: "combat" }, { silent: true });
  });
  on("clicked:tab_npc", function () {
    setAttrs({ active_tab: "npc" }, { silent: true });
  });
  on("clicked:tab_crew", function () {
    setAttrs({ active_tab: "crew" }, { silent: true });
  });
</script>
