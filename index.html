<div class="fade-background"></div>
<div class="main">
<h1>Daggerheart</h1>
<div class="name-grid">
<div class="section essentials-grid">
  <label for="character_name">Name:</label>
  <input type="text" name="attr_character_name" id="attr_character_name" /><br />

  <label for="player_name">Player:</label>
  <input type="text" name="attr_player_name" id="attr_player_name" /><br />

  <label for="Ancestry">Ancestry:</label>
  <input type="text" name="attr_Ancestry" id="attr_Ancestry" /><br />

  <label for="Community">Community:</label>
  <input type="text" name="attr_Community" id="attr_Community" /><br />

  <label for="class">Class:</label>
  <input type="text" name="attr_class" id="attr_class" /><br />

  <label for="subclass">Subclass:</label>
  <input type="text" name="attr_subclass" id="attr_subclass" /><br />

  <label for="level">Level:</label>
  <input type="number" name="attr_level" id="attr_level" min="1" max="20" /><br />
</div>

<div class="resource-toggle-wrapper">
  <input type="checkbox" id="toggle-resource-menu" class="toggle-resource-menu" name="attr_show_resource_menu" />
  <label class="resource-menu-button" for="toggle-resource-menu">Short Rest</label>

  <div class="resource-menu">
    <button type="roll" value="&{template:default} {{name=Replenish HP}} {{Result=[[1d4]]}}">Tend To Wounds</button>
    <button type="roll" value="&{template:default} {{name=Replenish Resolve}} {{Result=[[1d4]]}}">Clear Stress</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{Result=[[1d4]]}}">Repair Armor</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{Gain 1 Hope, or 2 if you prepare with others}}">Prepare</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{You do Something Else}}">Other</button>
  </div>
</div>

<div></div>

<div class="resource-toggle-wrapper-2">
  <input type="checkbox" id="toggle-resource-menu-2" class="toggle-resource-menu-2" name="attr_show_resource_menu-2" />
  <label class="resource-menu-button-2" for="toggle-resource-menu-2">Long Rest</label>

  <div class="resource-menu-2">
    <button type="roll" value="&{template:default} {{name=Replenish HP}} {{You Regenerate All Wounds}}">Tend To All Wounds</button>
    <button type="roll" value="&{template:default} {{name=Replenish Resolve}} {{You Clear All Stress}}">Clear All Stress</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{Repair All Armor}}">Repair All Armor</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{Gain 1 Hope, or 2 if you prepare with others}}">Prepare</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{You Make Progress In Your Project}}">Work On A Project</button>
    <button type="roll" value="&{template:default} {{name=Replenish Spirit}} {{You do Something Else}}">Other</button>
  </div>
</div>

</div>

<div>
<input type="checkbox" id="vulnerable" class="vulnerable" name="attr_vulnerable" /><label for="vulnerable">Vulnerable</label>
<input type="checkbox" id="state_hidden" class="state_hidden" name="state_hidden" /><label for="hidden">Hidden</label>
<input type="checkbox" id="restrained" class="restrained" name="attr_restrained" /><label for="restrained">Restrained</label>
</div>

<div class="section">
  <h2>Attributes</h2>
  <table>
    <thead>
      <tr>
        <th>Attribute</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
<tr>
  <td>Agility</td>
  <td>
  <input type="number" name="attr_agility_base"value="0" />
  <input type="hidden" name="attr_agility_total" value="0" readonly />
<button type="roll"
  value="&{template:default} {{name=Agility Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{agility_total}]]}}">
</button>
  </td>
</tr>

<tr>
  <td>Strength</td>
  <td>
  <input type="number" name="attr_strength_base"value="0" />
  <input type="hidden" name="attr_strength_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Strength Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{strength_total}]]}}">
</button>
  </td>
</tr>

<tr>
  <td>Finesse</td>
  <td>
  <input type="number" name="attr_finesse_base"value="0" />
  <input type="hidden" name="attr_finesse_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Finesse Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{finesse_total}]]}}">
</button>
  </td>
</tr>

<tr>
  <td>Instinct</td>
  <td>
  <input type="number" name="attr_instinct_base"value="0" />
  <input type="hidden" name="attr_instinct_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Instinct Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{instinct_total}]]}}">
</button>
  </td>
</tr>

<tr>
  <td>Presence</td>
  <td>
  <input type="number" name="attr_presence_base"value="0" />
  <input type="hidden" name="attr_presence_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Presence Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{presence_total}]]}}">
</button>
  </td>
</tr>

<tr>
  <td>Knowledge</td>
  <td>
  <input type="number" name="attr_knowledge_base"value="0" />
  <input type="hidden" name="attr_knowledge_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Knowledge Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{knowledge_total}]]}}">
</button>
  </td>
</tr>
<tr>
  <td>Attack Bonus</td>
  <td>
  <input type="number" name="attr_attack_base"value="0" />
  <input type="hidden" name="attr_attack_total" value="0" readonly />
        <button type="roll"
  value="&{template:default} {{name=Attack Roll}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Modifier=[[@{attack_total}]]}}">
</button>
  </td>
</tr>
    </tbody>
  </table>
</div>

<h2>Combat Stats</h2>
<div class="combat_stats">
  
<div>
  
  <h2>Damage Thresholds</h2>
  <label>Major Damage Threshold</label>
  <input type="text" name="attr_major_threshold" readonly />
  <label>Severe Damage Threshold</label>
  <input type="text" name="attr_severe_threshold" readonly />
  <div class="armor-score-boxes">
    <label>Evasion:
  <input type="number" name="attr_evasion" />
</label>
<label>Score:
  <input type="number" name="attr_armor_score" />
</label>
<input type="hidden" name="attr_armor_score" class="sheet-armor_score" />

<div class="sheet-score-checks">
  <input type="checkbox" name="attr_armor_score_1" class="sheet-score-1" />
  <input type="checkbox" name="attr_armor_score_2" class="sheet-score-2" />
  <input type="checkbox" name="attr_armor_score_3" class="sheet-score-3" />
  <input type="checkbox" name="attr_armor_score_4" class="sheet-score-4" />
  <input type="checkbox" name="attr_armor_score_5" class="sheet-score-5" />
  <input type="checkbox" name="attr_armor_score_6" class="sheet-score-6" />
  <input type="checkbox" name="attr_armor_score_7" class="sheet-score-7" />
  <input type="checkbox" name="attr_armor_score_8" class="sheet-score-8" />
  <input type="checkbox" name="attr_armor_score_9" class="sheet-score-9" />
  <input type="checkbox" name="attr_armor_score_10" class="sheet-score-10" />
</div>

</div>


  <div>
    <h2>HP</h2>
    <!-- Controls -->
    <div class="container">
      <div class="radio-slots">
        <label for="slot_count">Number of Slots:</label>
        <label
          ><input
            type="radio"
            name="attr_slots_enabled"
            value="6"
            id="slots6"
            checked
          />
          6 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_slots_enabled"
            value="7"
            id="slots7"
          />
          7 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_slots_enabled"
            value="8"
            id="slots8"
          />
          8 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_slots_enabled"
            value="9"
            id="slots9"
          />
          9 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_slots_enabled"
            value="10"
            id="slots10"
          />
          10 Slots</label
        >
      </div>
      <!-- Mirror value for CSS to read -->
      <input
        type="hidden"
        name="attr_slots_enabled"
        id="attr_slots_enabled"
        value="1"
      />

      <div class="slots">
        <input type="checkbox" name="attr_slot_1" class="slot slot-1" />
        <input type="checkbox" name="attr_slot_2" class="slot slot-2" />
        <input type="checkbox" name="attr_slot_3" class="slot slot-3" />
        <input type="checkbox" name="attr_slot_4" class="slot slot-4" />
        <input type="checkbox" name="attr_slot_5" class="slot slot-5" />
        <input type="checkbox" name="attr_slot_6" class="slot slot-6" />
        <input type="checkbox" name="attr_slot_7" class="slot slot-7" />
        <input type="checkbox" name="attr_slot_8" class="slot slot-8" />
        <input type="checkbox" name="attr_slot_9" class="slot slot-9" />
        <input type="checkbox" name="attr_slot_10" class="slot slot-10" />
      </div>
    </div>

    <h2>Stress</h2>

    <!-- Controls -->
    <div class="container">
      <div class="radio-slots">
        <label for="slot_count">Number of Slots:</label>
        <label
          ><input
            type="radio"
            name="attr_stress_slots_enabled"
            value="6"
            id="slots6"
            checked
          />
          6 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_stress_slots_enabled"
            value="7"
            id="slots7"
          />
          7 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_stress_slots_enabled"
            value="8"
            id="slots8"
          />
          8 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_stress_slots_enabled"
            value="9"
            id="slots9"
          />
          9 Slots</label
        >
        <label
          ><input
            type="radio"
            name="attr_stress_slots_enabled"
            value="10"
            id="slots10"
          />
          10 Slots</label
        >
      </div>
      <!-- Mirror value for CSS to read -->
      <input
        type="hidden"
        name="attr_stress_slots_enabled"
        id="attr_stress_slots_enabled"
        value="1"
      />

      <div class="slots">
        <input
          type="checkbox"
          name="attr_stress_slot_1"
          class="slot stress-slot-1"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_2"
          class="slot stress-slot-2"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_3"
          class="slot stress-slot-3"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_4"
          class="slot stress-slot-4"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_5"
          class="slot stress-slot-5"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_6"
          class="slot stress-slot-6"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_7"
          class="slot stress-slot-7"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_8"
          class="slot stress-slot-8"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_9"
          class="slot stress-slot-9"
        />
        <input
          type="checkbox"
          name="attr_stress_slot_10"
          class="slot stress-slot-10"
        />
      </div>
    </div>
  </div>
</div>

<div class="weapons-box">
<fieldset class="repeating_weapons">
  <div class="weapon-entry">
    <div class="weapon-header">
      <input type="text" name="attr_weapon_name" placeholder="Weapon Name" />
      
<button type="roll"
  name="roll_attack_damage"
  value="&{template:default} {{name=@{weapon_name}}} {{Hope=[[1d12]]}} {{Fear=[[1d12]]}} {{Attack Bonus=[[@{attack_total}]]}} {{Damage=[[@{damage_die_size} + @{additional_damage}]]}}">
  Roll Attack
</button>

<input type="hidden" name="attr_attack_trait_value" value="0" />

    </div>

    <!-- Hidden checkbox to toggle details -->
    <input type="checkbox" class="details-toggle" name="attr_show_details" />

    <!-- Label for toggling -->
    <label class="details-toggle-label"><input type="checkbox" class="details-toggle" name="attr_show_details" />Show Details ▼</label>

    <!-- Weapon details to show/hide -->
    <div class="weapon-details">
      <label>Attack Trait:
        <select name="attr_attack_trait">
          <option value="Agility">Agility</option>
          <option value="Strength">Strength</option>
          <option value="Finesse">Finesse</option>
          <option value="Instinct">Instinct</option>
          <option value="Presence">Presence</option>
          <option value="Knowledge">Knowledge</option>
        </select>
      </label>

      <label>Additional Damage:
        <input type="text" name="attr_additional_damage" placeholder="e.g. 1d10+3" />
      </label>

      <label>Damage Die Size:
        <select name="attr_damage_die_size">
          <option value="d4">d4</option>
          <option value="d6">d6</option>
          <option value="d8">d8</option>
          <option value="d10">d10</option>
          <option value="d12">d12</option>
        </select>
      </label>

      <label>Base Damage Type:
        <select name="attr_base_damage_type">
          <option value="Physical">Physical</option>
          <option value="Magical">Magical</option>
          <option value="Any">Any</option>
        </select>
      </label>

      <label>Range:
        <select name="attr_range">
          <option value="Melee">Melee</option>
          <option value="Very Close">Very Close</option>
          <option value="Close">Close</option>
          <option value="Far">Far</option>
          <option value="Very Far">Very Far</option>
        </select>
      </label>

      <label>Burden:
        <select name="attr_burden">
          <option value="One Handed">One Handed</option>
          <option value="Two Handed">Two Handed</option>
        </select>
      </label>

      <label>Weapon Type:
        <select name="attr_weapon_type">
          <option value="Primary">Primary</option>
          <option value="Secondary">Secondary</option>
        </select>
      </label>
    </div>
  </div>
</fieldset>
</div>

<div>
<div class="hope-tracker">
<h2 class="hope-name">Hope Tracker</h2>
        <input
          type="checkbox"
          name="attr_hope-slot 1"
          class="hope-slot 1"
        />
                <input
          type="checkbox"
          name="attr_hope-slot 2"
          class="hope-slot 2"
        />
                <input
          type="checkbox"
          name="attr_hope-slot 3"
          class="hope-slot 3"
        />
                <input
          type="checkbox"
          name="attr_hope-slot 4"
          class="hope-slot 4"
        />
                <input
          type="checkbox"
          name="attr_hope-slot 5"
          class="hope-slot 5"
        />
                <input
          type="checkbox"
          name="attr_hope-slot 6"
          class="hope-slot 6"
        />
</div>
<div class="experiences-box">
  <h1 class="experiences-label" style="color: white; background-color: black">Experiences:</h1>
  <fieldset class="repeating_experiences-box">
    <div class="repeating_experiences">
      <div class="attr_grid_item">
        <label for="attr_experiences_experience_field">Experience:</label>
        <input
          type="text"
          class="attr_experiences_experience_input"
          id="attr_experiences_experience_field"
          name="attr_experiences_experience_field"
        ></input>
      </div>
      <div class="attr_grid_item">
        <label for="attr_experiences_bonus_field">Bonus:</label>
        <input
          type="number"
          class="attr_experiences_bonus_input"
          id="attr_experiences_bonus_field"
          name="attr_experiences_bonus_field"
        ></input>
      </div>
      </div>
    </div>
  </fieldset>
</div>
</div>

<div class="tab-section">
  <!-- Radio inputs (tab selectors) -->
  <input type="radio" name="sheet-tab" id="tab-effects" class="tab-toggle" checked>
  <input type="radio" name="sheet-tab" id="tab-equipment" class="tab-toggle">
  <input type="radio" name="sheet-tab" id="tab-details" class="tab-toggle">
  <input type="radio" name="sheet-tab" id="tab-journal" class="tab-toggle">

  <!-- Tab labels -->
  <div class="tabs">
    <label for="tab-effects">Effects & Features</label>
    <label for="tab-equipment">Equipment</label>
    <label for="tab-details">Details</label>
    <label for="tab-journal">Journal</label>
  </div>

<!-- Effects Tab -->
<div class="tab-content tab-effects">
  <div class="effects-features-tab">
  
    <!-- Domain Effects -->
    <div class="domain-effects">
      <h2>Domain Effects:</h2>
      <fieldset class="repeating_bonuses">
        <div class="domain-effect-item">
          <label>Name:</label>
          <input type="text" name="attr_domain_effect_name" />

<!-- Checkbox toggle -->
<input type="checkbox" class="details-toggle" name="attr_show_details" id="toggle-details-1" />

<!-- Clickable label for toggle -->
<label class="details-toggle-label" for="toggle-details-1">Show Details ▼</label>

    <div class="domain-details">

          <label>Domain:</label>
          <input type="text" name="attr_domain_effect_domain" />

          <label>Type:</label>
          <input type="text" name="attr_domain_effect_type" />

          <label>Description:</label>
          <textarea name="attr_domain_effect_description" class="overflow"></textarea>

          <label>Active?</label>
          <input type="checkbox" name="attr_domain_effect_bonus_active" />

          <label>Bonus:</label>
          <input type="number" name="attr_domain_effect_bonus_score" value="0" />

          <label>
            Modify Stat:
            <select name="attr_domain_effect_mod_target">
              <option value="strength">Strength</option>
              <option value="agility">Agility</option>
              <option value="finesse">Finesse</option>
              <option value="instinct">Instinct</option>
              <option value="presence">Presence</option>
              <option value="knowledge">Knowledge</option>
              <option value="attack">Attack Bonus</option>
            </select>
          </label>

          <label>Roll 1:</label>
          <button type="roll" name="roll_domain_effect_roll_1" value="&{template:default} {{name=Domain Effect Roll 1}} {{Roll=[[@{domain_effect_roll_1}]]}}">Roll 1</button>
          <input type="text" name="attr_domain_effect_roll_1" />

          <label>Roll 2:</label>
          <button type="roll" name="roll_domain_effect_roll_2" value="&{template:default} {{name=Domain Effect Roll 2}} {{Roll=[[@{domain_effect_roll_2}]]}}">Roll 2</button>
          <input type="text" name="attr_domain_effect_roll_2" />

          <label>Cost:</label>
          <input type="text" name="attr_domain_effect_cost" />

          <label>How Many Uses:</label>
          <input type="number" name="attr_domain_effect_uses_per_rest" />
          </div>
      </fieldset>
    </div>

<!-- Features Section -->
<div class="features">
  <h2>Features:</h2>

  <fieldset class="repeating_bonuses_2">
    <div class="feature-effect-item">

      <label>Name:</label>
      <input type="text" name="feature_effect_name" />

<!-- Checkbox toggle -->
<input type="checkbox" class="details-toggle" name="attr_show_details" id="toggle-details-2" />

<!-- Clickable label for toggle -->
<label class="details-toggle-label" for="toggle-details-2">Show Details ▼</label>


      <!-- Hidden details section -->
      <div class="domain-details">
        <label>Source:</label>
        <input type="text" name="feature_effect_source" />

        <label>Description:</label>
        <textarea name="feature_effect_description" class="overflow"></textarea>

        <label>Active?</label>
        <input type="checkbox" name="attr_feature_effect_bonus_active" />

        <label>Bonus:</label>
        <input type="number" name="attr_feature_effect_bonus_score" value="0" />

        <label>Modify Stat:</label>
        <select name="attr_feature_effect_mod_target">
          <option value="strength">Strength</option>
          <option value="agility">Agility</option>
          <option value="finesse">Finesse</option>
          <option value="instinct">Instinct</option>
          <option value="presence">Presence</option>
          <option value="knowledge">Knowledge</option>
          <option value="attack">Attack Bonus</option>
        </select>

        <label>Roll 1:</label>
        <button type="roll" name="roll_feature_effect_roll_1" value="&{template:default} {{name=Feature Roll 1}} {{Roll=[[@{feature_effect_roll_1}]]}}">Roll 1</button>
        <input type="text" name="feature_effect_roll_1" />

        <label>Roll 2:</label>
        <button type="roll" name="roll_feature_effect_roll_2" value="&{template:default} {{name=Feature Roll 2}} {{Roll=[[@{feature_effect_roll_2}]]}}">Roll 2</button>
        <input type="text" name="feature_effect_roll_2" />

        <label>Cost:</label>
        <input type="text" name="feature_effect_cost" />

        <label>How Many Uses:</label>
        <input type="number" name="feature_effect_uses_per_rest" />
      </div>

    </div>
  </fieldset>
</div>

  </div>
</div>

  <!-- Equipment Tab (fixed here) -->
  <div class="tab-content tab-equipment">
    <div class="gold">
    <h2>Gold:</h2>
    <label>Handfulls:</label>
      <input type="number" name="attr_gold_handfulls" />
    <label>Bags:</label>
      <input type="number" name="attr_gold_bags" />
    <label>Chest:</label>
      <input type="number" name="attr_gold_chest" />
    </div>
    <h1 style="color: white; background-color: black">Equipment:</h1>
<fieldset class="repeating_armor">
  <div class="armor-item">
    <label>
      <input type="checkbox" name="attr_armor_active" /> Equipped
    </label>

    <label>Name:
      <input type="text" name="attr_armor_name" />
    </label>

    <label>Description:
      <textarea name="attr_armor_description" class="overflow"></textarea>
    </label>

    <label>Major Threshold:
      <input type="number" name="attr_armor_major_threshold" />
    </label>

    <label>Severe Threshold:
      <input type="number" name="attr_armor_severe_threshold" />
    </label>

    <label>Score:
      <input type="number" name="attr_armor_score" />
    </label>
  </div>
</fieldset>
  </div>

  <!-- Details Tab -->
  <div class="tab-content tab-details">
    <h2>Details</h2>
<fieldset class="repeating_armor">
    <label>Question:
      <input type="text" name="attr_details_question" />
    </label>

      <label>Answer:
      <textarea name="attr_details_description" class="overflow"></textarea>
    </label>
    </fieldset>
  </div>

  <!-- Journal Tab -->
  <div class="tab-content tab-journal">
    <h2>Journal</h2>
<fieldset class="repeating_armor">
    <label>Title:
      <input type="text" name="attr_details_question" />
    </label>

      <label>Entry:
      <textarea name="attr_details_description" class="overflow"></textarea>
    </label>
    </fieldset>
  </div>
</div>

<script type="text/worker">
  on("change:level change:armor_major_threshold change:armor_severe_threshold", function () {
    getAttrs(["level", "armor_major_threshold", "armor_severe_threshold"], function (values) {
      const level = parseInt(values.level, 10) || 0;
      const armorMajor = parseInt(values.armor_major_threshold, 10) || 0;
      const armorSevere = parseInt(values.armor_severe_threshold, 10) || 0;

      const majorThreshold = level + armorMajor;
      const severeThreshold = level + armorSevere;
      const summary = `Level ${level}: Major ${majorThreshold} / Severe ${severeThreshold}`;

      setAttrs({
        major_threshold: majorThreshold,
        severe_threshold: severeThreshold,
        armor_summary: summary
      });
    });
  });
</script>

<script type="text/worker">
  on("change:level change:repeating_armor change:repeating_armor:armor_active change:repeating_armor:armor_major_threshold change:repeating_armor:armor_severe_threshold", function () {
    getSectionIDs("repeating_armor", function (ids) {
      getAttrs(["level"], function (base) {
        const level = parseInt(base.level) || 0;

        // Fetch all repeating armor attributes
        const fieldNames = [];
        ids.forEach(id => {
          fieldNames.push(
            `repeating_armor_${id}_armor_active`,
            `repeating_armor_${id}_armor_major_threshold`,
            `repeating_armor_${id}_armor_severe_threshold`
          );
        });

        getAttrs(fieldNames, function (fields) {
          let major = 0;
          let severe = 0;

          // Use first checked armor
          for (let id of ids) {
            if (fields[`repeating_armor_${id}_armor_active`] === "on") {
              major = parseInt(fields[`repeating_armor_${id}_armor_major_threshold`]) || 0;
              severe = parseInt(fields[`repeating_armor_${id}_armor_severe_threshold`]) || 0;
              break;
            }
          }

          const majorThreshold = level + major;
          const severeThreshold = level + severe;
          const summary = `Level ${level}: Major ${majorThreshold} / Severe ${severeThreshold}`;

          setAttrs({
            major_threshold: majorThreshold,
            severe_threshold: severeThreshold,
            armor_summary: summary
          });
        });
      });
    });
  });
</script>

<script type="text/worker">
  on("change:repeating_armor:armor_score", function (eventInfo) {
    const id = eventInfo.sourceAttribute.split("_")[2];
    const baseName = `repeating_armor_${id}`;

    getAttrs([`${baseName}_armor_score`], function (values) {
      const score = parseInt(values[`${baseName}_armor_score`]) || 0;

      const updates = {};
      for (let i = 1; i <= 10; i++) {
        updates[`${baseName}_armor_score_${i}_disabled`] = i <= score ? "0" : "1";
      }

      setAttrs(updates);
    });
  });
</script>

<script type="text/worker">
on("change:repeating_weapons:attack_trait", function(eventInfo) {
  getAttrs([
    "repeating_weapons_" + eventInfo.sourceAttribute.split("_")[2] + "_attack_trait",
    "agility", "strength", "finesse", "instinct", "presence", "knowledge"
  ], function(values) {
    const trait = (values[`repeating_weapons_${eventInfo.sourceAttribute.split("_")[2]}_attack_trait`] || "").toLowerCase();
    const traitValue = parseInt(values[trait]) || 0;
    const setting = {};
    setting[`repeating_weapons_${eventInfo.sourceAttribute.split("_")[2]}_attack_trait_value`] = traitValue;
    setAttrs(setting);
  });
});
</script>

<script type="text/worker">
on("change:mod_active change:mod_value change:mod_target change:strength change:agility change:finesse change:instinct change:presence change:knowledge", function() {
  getAttrs([
    "mod_active", "mod_value", "mod_target",
    "strength", "agility", "finesse", "instinct", "presence", "knowledge"
  ], function(values) {
    const modActive = values.mod_active === "on";
    const modValue = parseInt(values.mod_value) || 0;
    const target = values.mod_target;
    
    const stats = ["strength", "agility", "finesse", "instinct", "presence", "knowledge"];
    let updates = {};

    stats.forEach(stat => {
      const base = parseInt(values[stat]) || 0;
      updates[`mod_${stat}`] = base + (stat === target && modActive ? modValue : 0);
    });

    setAttrs(updates);
  });
});
</script>

<script type="text/worker">
const stats = ["strength", "agility", "finesse", "instinct", "presence", "knowledge", "attack"];

const calculateStatTotal = (stat) => {
  getAttrs([`${stat}_base`], (baseValues) => {
    const base = parseInt(baseValues[`${stat}_base`], 10) || 0;

    const getBonusSum = (section, prefix, callback) => {
      getSectionIDs(section, (ids) => {
        if (!ids.length) return callback(0);

        const fields = ids.flatMap(id => [
          `${section}_${id}_${prefix}bonus_active`,
          `${section}_${id}_${prefix}bonus_score`,
          `${section}_${id}_${prefix}mod_target`,
        ]);

        getAttrs(fields, (values) => {
          let sum = 0;
          ids.forEach(id => {
            const active = values[`${section}_${id}_${prefix}bonus_active`] === "on";
            const score = parseInt(values[`${section}_${id}_${prefix}bonus_score`], 10) || 0;
            const target = values[`${section}_${id}_${prefix}mod_target`] || "";

            if (active && target === stat) {
              sum += score;
            }
          });
          callback(sum);
        });
      });
    };

    getBonusSum("repeating_bonuses", "domain_effect_", (domainSum) => {
      getBonusSum("repeating_bonuses_2", "feature_effect_", (featureSum) => {
        const total = base + domainSum + featureSum;
        setAttrs({ [`${stat}_total`]: total });
      });
    });
  });
};

// Watch for changes
stats.forEach(stat => {
  on(`change:${stat}_base`, () => calculateStatTotal(stat));
});

// Watch for bonus section changes
["repeating_bonuses", "repeating_bonuses_2"].forEach(section => {
  const prefix = section === "repeating_bonuses" ? "domain_effect_" : "feature_effect_";
  on(`change:${section} remove:${section}`, () => stats.forEach(stat => calculateStatTotal(stat)));
  on(`change:${section}:${prefix}bonus_active change:${section}:${prefix}bonus_score change:${section}:${prefix}mod_target`, () =>
    stats.forEach(stat => calculateStatTotal(stat))
  );
});
</script>


</div>